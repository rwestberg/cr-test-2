<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New src/hotspot/share/runtime/thread.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
  <body>
    <pre>
   1 /*
   2  * Copyright (c) 1997, 2020, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
  23  */
  24 
  25 #include &quot;precompiled.hpp&quot;
  26 #include &quot;jvm.h&quot;
  27 #include &quot;aot/aotLoader.hpp&quot;
  28 #include &quot;classfile/classLoader.hpp&quot;
  29 #include &quot;classfile/javaClasses.hpp&quot;
  30 #include &quot;classfile/moduleEntry.hpp&quot;
  31 #include &quot;classfile/systemDictionary.hpp&quot;
  32 #include &quot;classfile/vmSymbols.hpp&quot;
  33 #include &quot;code/codeCache.hpp&quot;
  34 #include &quot;code/scopeDesc.hpp&quot;
  35 #include &quot;compiler/compileBroker.hpp&quot;
  36 #include &quot;compiler/compileTask.hpp&quot;
  37 #include &quot;gc/shared/barrierSet.hpp&quot;
  38 #include &quot;gc/shared/barrierSetNMethod.hpp&quot;
  39 #include &quot;gc/shared/gcId.hpp&quot;
  40 #include &quot;gc/shared/gcLocker.inline.hpp&quot;
  41 #include &quot;gc/shared/workgroup.hpp&quot;
  42 #include &quot;interpreter/interpreter.hpp&quot;
  43 #include &quot;interpreter/linkResolver.hpp&quot;
  44 #include &quot;interpreter/oopMapCache.hpp&quot;
  45 #include &quot;jfr/jfrEvents.hpp&quot;
  46 #include &quot;jvmtifiles/jvmtiEnv.hpp&quot;
  47 #include &quot;logging/log.hpp&quot;
  48 #include &quot;logging/logConfiguration.hpp&quot;
  49 #include &quot;logging/logStream.hpp&quot;
  50 #include &quot;memory/allocation.inline.hpp&quot;
  51 #include &quot;memory/iterator.hpp&quot;
  52 #include &quot;memory/metaspaceShared.hpp&quot;
  53 #include &quot;memory/oopFactory.hpp&quot;
  54 #include &quot;memory/resourceArea.hpp&quot;
  55 #include &quot;memory/universe.hpp&quot;
  56 #include &quot;oops/access.inline.hpp&quot;
  57 #include &quot;oops/instanceKlass.hpp&quot;
  58 #include &quot;oops/objArrayOop.hpp&quot;
  59 #include &quot;oops/oop.inline.hpp&quot;
  60 #include &quot;oops/symbol.hpp&quot;
  61 #include &quot;oops/typeArrayOop.inline.hpp&quot;
  62 #include &quot;oops/verifyOopClosure.hpp&quot;
  63 #include &quot;prims/jvm_misc.hpp&quot;
  64 #include &quot;prims/jvmtiExport.hpp&quot;
  65 #include &quot;prims/jvmtiThreadState.hpp&quot;
  66 #include &quot;runtime/arguments.hpp&quot;
  67 #include &quot;runtime/atomic.hpp&quot;
  68 #include &quot;runtime/biasedLocking.hpp&quot;
  69 #include &quot;runtime/fieldDescriptor.inline.hpp&quot;
  70 #include &quot;runtime/flags/jvmFlagConstraintList.hpp&quot;
  71 #include &quot;runtime/flags/jvmFlagRangeList.hpp&quot;
  72 #include &quot;runtime/deoptimization.hpp&quot;
  73 #include &quot;runtime/frame.inline.hpp&quot;
  74 #include &quot;runtime/handles.inline.hpp&quot;
  75 #include &quot;runtime/handshake.hpp&quot;
  76 #include &quot;runtime/init.hpp&quot;
  77 #include &quot;runtime/interfaceSupport.inline.hpp&quot;
  78 #include &quot;runtime/java.hpp&quot;
  79 #include &quot;runtime/javaCalls.hpp&quot;
  80 #include &quot;runtime/jniHandles.inline.hpp&quot;
  81 #include &quot;runtime/jniPeriodicChecker.hpp&quot;
  82 #include &quot;runtime/memprofiler.hpp&quot;
  83 #include &quot;runtime/mutexLocker.hpp&quot;
  84 #include &quot;runtime/objectMonitor.hpp&quot;
  85 #include &quot;runtime/orderAccess.hpp&quot;
  86 #include &quot;runtime/osThread.hpp&quot;
  87 #include &quot;runtime/prefetch.inline.hpp&quot;
  88 #include &quot;runtime/safepoint.hpp&quot;
  89 #include &quot;runtime/safepointMechanism.inline.hpp&quot;
  90 #include &quot;runtime/safepointVerifiers.hpp&quot;
  91 #include &quot;runtime/serviceThread.hpp&quot;
  92 #include &quot;runtime/sharedRuntime.hpp&quot;
  93 #include &quot;runtime/statSampler.hpp&quot;
  94 #include &quot;runtime/stubRoutines.hpp&quot;
  95 #include &quot;runtime/sweeper.hpp&quot;
  96 #include &quot;runtime/task.hpp&quot;
  97 #include &quot;runtime/thread.inline.hpp&quot;
  98 #include &quot;runtime/threadCritical.hpp&quot;
  99 #include &quot;runtime/threadSMR.inline.hpp&quot;
 100 #include &quot;runtime/threadStatisticalInfo.hpp&quot;
 101 #include &quot;runtime/timer.hpp&quot;
 102 #include &quot;runtime/timerTrace.hpp&quot;
 103 #include &quot;runtime/vframe.inline.hpp&quot;
 104 #include &quot;runtime/vframeArray.hpp&quot;
 105 #include &quot;runtime/vframe_hp.hpp&quot;
 106 #include &quot;runtime/vmThread.hpp&quot;
 107 #include &quot;runtime/vmOperations.hpp&quot;
 108 #include &quot;runtime/vm_version.hpp&quot;
 109 #include &quot;services/attachListener.hpp&quot;
 110 #include &quot;services/management.hpp&quot;
 111 #include &quot;services/memTracker.hpp&quot;
 112 #include &quot;services/threadService.hpp&quot;
 113 #include &quot;utilities/align.hpp&quot;
 114 #include &quot;utilities/copy.hpp&quot;
 115 #include &quot;utilities/defaultStream.hpp&quot;
 116 #include &quot;utilities/dtrace.hpp&quot;
 117 #include &quot;utilities/events.hpp&quot;
 118 #include &quot;utilities/macros.hpp&quot;
 119 #include &quot;utilities/preserveException.hpp&quot;
 120 #include &quot;utilities/singleWriterSynchronizer.hpp&quot;
 121 #include &quot;utilities/vmError.hpp&quot;
 122 #if INCLUDE_JVMCI
 123 #include &quot;jvmci/jvmci.hpp&quot;
 124 #include &quot;jvmci/jvmciEnv.hpp&quot;
 125 #endif
 126 #ifdef COMPILER1
 127 #include &quot;c1/c1_Compiler.hpp&quot;
 128 #endif
 129 #ifdef COMPILER2
 130 #include &quot;opto/c2compiler.hpp&quot;
 131 #include &quot;opto/idealGraphPrinter.hpp&quot;
 132 #endif
 133 #if INCLUDE_RTM_OPT
 134 #include &quot;runtime/rtmLocking.hpp&quot;
 135 #endif
 136 #if INCLUDE_JFR
 137 #include &quot;jfr/jfr.hpp&quot;
 138 #endif
 139 
 140 // Initialization after module runtime initialization
 141 void universe_post_module_init();  // must happen after call_initPhase2
 142 
 143 #ifdef DTRACE_ENABLED
 144 
 145 // Only bother with this argument setup if dtrace is available
 146 
 147   #define HOTSPOT_THREAD_PROBE_start HOTSPOT_THREAD_START
 148   #define HOTSPOT_THREAD_PROBE_stop HOTSPOT_THREAD_STOP
 149 
 150   #define DTRACE_THREAD_PROBE(probe, javathread)                           \
 151     {                                                                      \
 152       ResourceMark rm(this);                                               \
 153       int len = 0;                                                         \
 154       const char* name = (javathread)-&gt;get_thread_name();                  \
 155       len = strlen(name);                                                  \
 156       HOTSPOT_THREAD_PROBE_##probe(/* probe = start, stop */               \
 157         (char *) name, len,                                                \
 158         java_lang_Thread::thread_id((javathread)-&gt;threadObj()),            \
 159         (uintptr_t) (javathread)-&gt;osthread()-&gt;thread_id(),                 \
 160         java_lang_Thread::is_daemon((javathread)-&gt;threadObj()));           \
 161     }
 162 
 163 #else //  ndef DTRACE_ENABLED
 164 
 165   #define DTRACE_THREAD_PROBE(probe, javathread)
 166 
 167 #endif // ndef DTRACE_ENABLED
 168 
 169 #ifndef USE_LIBRARY_BASED_TLS_ONLY
 170 // Current thread is maintained as a thread-local variable
 171 THREAD_LOCAL Thread* Thread::_thr_current = NULL;
 172 #endif
 173 
 174 // ======= Thread ========
 175 // Support for forcing alignment of thread objects for biased locking
 176 void* Thread::allocate(size_t size, bool throw_excpt, MEMFLAGS flags) {
 177   if (UseBiasedLocking) {
 178     const size_t alignment = markWord::biased_lock_alignment;
 179     size_t aligned_size = size + (alignment - sizeof(intptr_t));
 180     void* real_malloc_addr = throw_excpt? AllocateHeap(aligned_size, flags, CURRENT_PC)
 181                                           : AllocateHeap(aligned_size, flags, CURRENT_PC,
 182                                                          AllocFailStrategy::RETURN_NULL);
 183     void* aligned_addr     = align_up(real_malloc_addr, alignment);
 184     assert(((uintptr_t) aligned_addr + (uintptr_t) size) &lt;=
 185            ((uintptr_t) real_malloc_addr + (uintptr_t) aligned_size),
 186            &quot;JavaThread alignment code overflowed allocated storage&quot;);
 187     if (aligned_addr != real_malloc_addr) {
 188       log_info(biasedlocking)(&quot;Aligned thread &quot; INTPTR_FORMAT &quot; to &quot; INTPTR_FORMAT,
 189                               p2i(real_malloc_addr),
 190                               p2i(aligned_addr));
 191     }
 192     ((Thread*) aligned_addr)-&gt;_real_malloc_address = real_malloc_addr;
 193     return aligned_addr;
 194   } else {
 195     return throw_excpt? AllocateHeap(size, flags, CURRENT_PC)
 196                        : AllocateHeap(size, flags, CURRENT_PC, AllocFailStrategy::RETURN_NULL);
 197   }
 198 }
 199 
 200 void Thread::operator delete(void* p) {
 201   if (UseBiasedLocking) {
 202     FreeHeap(((Thread*) p)-&gt;_real_malloc_address);
 203   } else {
 204     FreeHeap(p);
 205   }
 206 }
 207 
 208 void JavaThread::smr_delete() {
 209   if (_on_thread_list) {
 210     ThreadsSMRSupport::smr_delete(this);
 211   } else {
 212     delete this;
 213   }
 214 }
 215 
 216 // Base class for all threads: VMThread, WatcherThread, ConcurrentMarkSweepThread,
 217 // JavaThread
 218 
 219 DEBUG_ONLY(Thread* Thread::_starting_thread = NULL;)
 220 
 221 Thread::Thread() {
 222 
 223   DEBUG_ONLY(_run_state = PRE_CALL_RUN;)
 224 
 225   // stack and get_thread
 226   set_stack_base(NULL);
 227   set_stack_size(0);
 228   set_lgrp_id(-1);
 229   DEBUG_ONLY(clear_suspendible_thread();)
 230 
 231   // allocated data structures
 232   set_osthread(NULL);
 233   set_resource_area(new (mtThread)ResourceArea());
 234   DEBUG_ONLY(_current_resource_mark = NULL;)
 235   set_handle_area(new (mtThread) HandleArea(NULL));
 236   set_metadata_handles(new (ResourceObj::C_HEAP, mtClass) GrowableArray&lt;Metadata*&gt;(30, true));
 237   set_active_handles(NULL);
 238   set_free_handle_block(NULL);
 239   set_last_handle_mark(NULL);
 240   DEBUG_ONLY(_missed_ic_stub_refill_verifier = NULL);
 241 
 242   // Initial value of zero ==&gt; never claimed.
 243   _threads_do_token = 0;
 244   _threads_hazard_ptr = NULL;
 245   _threads_list_ptr = NULL;
 246   _nested_threads_hazard_ptr_cnt = 0;
 247   _rcu_counter = 0;
 248 
 249   // the handle mark links itself to last_handle_mark
 250   new HandleMark(this);
 251 
 252   // plain initialization
 253   debug_only(_owned_locks = NULL;)
 254   NOT_PRODUCT(_no_safepoint_count = 0;)
 255   NOT_PRODUCT(_skip_gcalot = false;)
 256   _jvmti_env_iteration_count = 0;
 257   set_allocated_bytes(0);
 258   _vm_operation_started_count = 0;
 259   _vm_operation_completed_count = 0;
 260   _current_pending_monitor = NULL;
 261   _current_pending_monitor_is_from_java = true;
 262   _current_waiting_monitor = NULL;
 263   _current_pending_raw_monitor = NULL;
 264   _num_nested_signal = 0;
 265   om_free_list = NULL;
 266   om_free_count = 0;
 267   om_free_provision = 32;
 268   om_in_use_list = NULL;
 269   om_in_use_count = 0;
 270 
 271 #ifdef ASSERT
 272   _visited_for_critical_count = false;
 273 #endif
 274 
 275   _SR_lock = new Monitor(Mutex::suspend_resume, &quot;SR_lock&quot;, true,
 276                          Monitor::_safepoint_check_sometimes);
 277   _suspend_flags = 0;
 278 
 279   // thread-specific hashCode stream generator state - Marsaglia shift-xor form
 280   _hashStateX = os::random();
 281   _hashStateY = 842502087;
 282   _hashStateZ = 0x8767;    // (int)(3579807591LL &amp; 0xffff) ;
 283   _hashStateW = 273326509;
 284 
 285   _OnTrap   = 0;
 286   _Stalled  = 0;
 287   _TypeTag  = 0x2BAD;
 288 
 289   // Many of the following fields are effectively final - immutable
 290   // Note that nascent threads can&#39;t use the Native Monitor-Mutex
 291   // construct until the _MutexEvent is initialized ...
 292   // CONSIDER: instead of using a fixed set of purpose-dedicated ParkEvents
 293   // we might instead use a stack of ParkEvents that we could provision on-demand.
 294   // The stack would act as a cache to avoid calls to ParkEvent::Allocate()
 295   // and ::Release()
 296   _ParkEvent   = ParkEvent::Allocate(this);
 297   _MuxEvent    = ParkEvent::Allocate(this);
 298 
 299 #ifdef CHECK_UNHANDLED_OOPS
 300   if (CheckUnhandledOops) {
 301     _unhandled_oops = new UnhandledOops(this);
 302   }
 303 #endif // CHECK_UNHANDLED_OOPS
 304 #ifdef ASSERT
 305   if (UseBiasedLocking) {
 306     assert(is_aligned(this, markWord::biased_lock_alignment), &quot;forced alignment of thread object failed&quot;);
 307     assert(this == _real_malloc_address ||
 308            this == align_up(_real_malloc_address, markWord::biased_lock_alignment),
 309            &quot;bug in forced alignment of thread objects&quot;);
 310   }
 311 #endif // ASSERT
 312 
 313   // Notify the barrier set that a thread is being created. The initial
 314   // thread is created before the barrier set is available.  The call to
 315   // BarrierSet::on_thread_create() for this thread is therefore deferred
 316   // to BarrierSet::set_barrier_set().
 317   BarrierSet* const barrier_set = BarrierSet::barrier_set();
 318   if (barrier_set != NULL) {
 319     barrier_set-&gt;on_thread_create(this);
 320     BarrierSetNMethod* bs_nm = barrier_set-&gt;barrier_set_nmethod();
 321     _nmethod_disarm_value = bs_nm-&gt;disarmed_value();
 322   } else {
 323     // Only the main thread should be created before the barrier set
 324     // and that happens just before Thread::current is set. No other thread
 325     // can attach as the VM is not created yet, so they can&#39;t execute this code.
 326     // If the main thread creates other threads before the barrier set that is an error.
 327     assert(Thread::current_or_null() == NULL, &quot;creating thread before barrier set&quot;);
 328   }
 329 }
 330 
 331 void Thread::initialize_thread_current() {
 332 #ifndef USE_LIBRARY_BASED_TLS_ONLY
 333   assert(_thr_current == NULL, &quot;Thread::current already initialized&quot;);
 334   _thr_current = this;
 335 #endif
 336   assert(ThreadLocalStorage::thread() == NULL, &quot;ThreadLocalStorage::thread already initialized&quot;);
 337   ThreadLocalStorage::set_thread(this);
 338   assert(Thread::current() == ThreadLocalStorage::thread(), &quot;TLS mismatch!&quot;);
 339 }
 340 
 341 void Thread::clear_thread_current() {
 342   assert(Thread::current() == ThreadLocalStorage::thread(), &quot;TLS mismatch!&quot;);
 343 #ifndef USE_LIBRARY_BASED_TLS_ONLY
 344   _thr_current = NULL;
 345 #endif
 346   ThreadLocalStorage::set_thread(NULL);
 347 }
 348 
 349 void Thread::record_stack_base_and_size() {
 350   // Note: at this point, Thread object is not yet initialized. Do not rely on
 351   // any members being initialized. Do not rely on Thread::current() being set.
 352   // If possible, refrain from doing anything which may crash or assert since
 353   // quite probably those crash dumps will be useless.
 354   set_stack_base(os::current_stack_base());
 355   set_stack_size(os::current_stack_size());
 356 
 357 #ifdef SOLARIS
 358   if (os::is_primordial_thread()) {
 359     os::Solaris::correct_stack_boundaries_for_primordial_thread(this);
 360   }
 361 #endif
 362 
 363   // Set stack limits after thread is initialized.
 364   if (is_Java_thread()) {
 365     ((JavaThread*) this)-&gt;set_stack_overflow_limit();
 366     ((JavaThread*) this)-&gt;set_reserved_stack_activation(stack_base());
 367   }
 368 }
 369 
 370 #if INCLUDE_NMT
 371 void Thread::register_thread_stack_with_NMT() {
 372   MemTracker::record_thread_stack(stack_end(), stack_size());
 373 }
 374 #endif // INCLUDE_NMT
 375 
 376 void Thread::call_run() {
 377   DEBUG_ONLY(_run_state = CALL_RUN;)
 378 
 379   // At this point, Thread object should be fully initialized and
 380   // Thread::current() should be set.
 381 
 382   assert(Thread::current_or_null() != NULL, &quot;current thread is unset&quot;);
 383   assert(Thread::current_or_null() == this, &quot;current thread is wrong&quot;);
 384 
 385   // Perform common initialization actions
 386 
 387   register_thread_stack_with_NMT();
 388 
 389   JFR_ONLY(Jfr::on_thread_start(this);)
 390 
 391   log_debug(os, thread)(&quot;Thread &quot; UINTX_FORMAT &quot; stack dimensions: &quot;
 392     PTR_FORMAT &quot;-&quot; PTR_FORMAT &quot; (&quot; SIZE_FORMAT &quot;k).&quot;,
 393     os::current_thread_id(), p2i(stack_base() - stack_size()),
 394     p2i(stack_base()), stack_size()/1024);
 395 
 396   // Perform &lt;ChildClass&gt; initialization actions
 397   DEBUG_ONLY(_run_state = PRE_RUN;)
 398   this-&gt;pre_run();
 399 
 400   // Invoke &lt;ChildClass&gt;::run()
 401   DEBUG_ONLY(_run_state = RUN;)
 402   this-&gt;run();
 403   // Returned from &lt;ChildClass&gt;::run(). Thread finished.
 404 
 405   // Perform common tear-down actions
 406 
 407   assert(Thread::current_or_null() != NULL, &quot;current thread is unset&quot;);
 408   assert(Thread::current_or_null() == this, &quot;current thread is wrong&quot;);
 409 
 410   // Perform &lt;ChildClass&gt; tear-down actions
 411   DEBUG_ONLY(_run_state = POST_RUN;)
 412   this-&gt;post_run();
 413 
 414   // Note: at this point the thread object may already have deleted itself,
 415   // so from here on do not dereference *this*. Not all thread types currently
 416   // delete themselves when they terminate. But no thread should ever be deleted
 417   // asynchronously with respect to its termination - that is what _run_state can
 418   // be used to check.
 419 
 420   assert(Thread::current_or_null() == NULL, &quot;current thread still present&quot;);
 421 }
 422 
 423 Thread::~Thread() {
 424 
 425   // Attached threads will remain in PRE_CALL_RUN, as will threads that don&#39;t actually
 426   // get started due to errors etc. Any active thread should at least reach post_run
 427   // before it is deleted (usually in post_run()).
 428   assert(_run_state == PRE_CALL_RUN ||
 429          _run_state == POST_RUN, &quot;Active Thread deleted before post_run(): &quot;
 430          &quot;_run_state=%d&quot;, (int)_run_state);
 431 
 432   // Notify the barrier set that a thread is being destroyed. Note that a barrier
 433   // set might not be available if we encountered errors during bootstrapping.
 434   BarrierSet* const barrier_set = BarrierSet::barrier_set();
 435   if (barrier_set != NULL) {
 436     barrier_set-&gt;on_thread_destroy(this);
 437   }
 438 
 439   // stack_base can be NULL if the thread is never started or exited before
 440   // record_stack_base_and_size called. Although, we would like to ensure
 441   // that all started threads do call record_stack_base_and_size(), there is
 442   // not proper way to enforce that.
 443 #if INCLUDE_NMT
 444   if (_stack_base != NULL) {
 445     MemTracker::release_thread_stack(stack_end(), stack_size());
 446 #ifdef ASSERT
 447     set_stack_base(NULL);
 448 #endif
 449   }
 450 #endif // INCLUDE_NMT
 451 
 452   // deallocate data structures
 453   delete resource_area();
 454   // since the handle marks are using the handle area, we have to deallocated the root
 455   // handle mark before deallocating the thread&#39;s handle area,
 456   assert(last_handle_mark() != NULL, &quot;check we have an element&quot;);
 457   delete last_handle_mark();
 458   assert(last_handle_mark() == NULL, &quot;check we have reached the end&quot;);
 459 
 460   // It&#39;s possible we can encounter a null _ParkEvent, etc., in stillborn threads.
 461   // We NULL out the fields for good hygiene.
 462   ParkEvent::Release(_ParkEvent); _ParkEvent   = NULL;
 463   ParkEvent::Release(_MuxEvent); _MuxEvent    = NULL;
 464 
 465   delete handle_area();
 466   delete metadata_handles();
 467 
 468   // SR_handler uses this as a termination indicator -
 469   // needs to happen before os::free_thread()
 470   delete _SR_lock;
 471   _SR_lock = NULL;
 472 
 473   // osthread() can be NULL, if creation of thread failed.
 474   if (osthread() != NULL) os::free_thread(osthread());
 475 
 476   // Clear Thread::current if thread is deleting itself and it has not
 477   // already been done. This must be done before the memory is deallocated.
 478   // Needed to ensure JNI correctly detects non-attached threads.
 479   if (this == Thread::current_or_null()) {
 480     Thread::clear_thread_current();
 481   }
 482 
 483   CHECK_UNHANDLED_OOPS_ONLY(if (CheckUnhandledOops) delete unhandled_oops();)
 484 }
 485 
 486 #ifdef ASSERT
 487 // A JavaThread is considered &quot;dangling&quot; if it is not the current
 488 // thread, has been added the Threads list, the system is not at a
 489 // safepoint and the Thread is not &quot;protected&quot;.
 490 //
 491 void Thread::check_for_dangling_thread_pointer(Thread *thread) {
 492   assert(!thread-&gt;is_Java_thread() || Thread::current() == thread ||
 493          !((JavaThread *) thread)-&gt;on_thread_list() ||
 494          SafepointSynchronize::is_at_safepoint() ||
 495          ThreadsSMRSupport::is_a_protected_JavaThread_with_lock((JavaThread *) thread),
 496          &quot;possibility of dangling Thread pointer&quot;);
 497 }
 498 #endif
 499 
 500 ThreadPriority Thread::get_priority(const Thread* const thread) {
 501   ThreadPriority priority;
 502   // Can return an error!
 503   (void)os::get_priority(thread, priority);
 504   assert(MinPriority &lt;= priority &amp;&amp; priority &lt;= MaxPriority, &quot;non-Java priority found&quot;);
 505   return priority;
 506 }
 507 
 508 void Thread::set_priority(Thread* thread, ThreadPriority priority) {
 509   debug_only(check_for_dangling_thread_pointer(thread);)
 510   // Can return an error!
 511   (void)os::set_priority(thread, priority);
 512 }
 513 
 514 
 515 void Thread::start(Thread* thread) {
 516   // Start is different from resume in that its safety is guaranteed by context or
 517   // being called from a Java method synchronized on the Thread object.
 518   if (!DisableStartThread) {
 519     if (thread-&gt;is_Java_thread()) {
 520       // Initialize the thread state to RUNNABLE before starting this thread.
 521       // Can not set it after the thread started because we do not know the
 522       // exact thread state at that time. It could be in MONITOR_WAIT or
 523       // in SLEEPING or some other state.
 524       java_lang_Thread::set_thread_status(((JavaThread*)thread)-&gt;threadObj(),
 525                                           java_lang_Thread::RUNNABLE);
 526     }
 527     os::start_thread(thread);
 528   }
 529 }
 530 
 531 class InstallAsyncExceptionClosure : public HandshakeClosure {
 532   Handle _throwable; // The Throwable thrown at the target Thread
 533 public:
 534   InstallAsyncExceptionClosure(Handle throwable) : HandshakeClosure(&quot;InstallAsyncException&quot;), _throwable(throwable) {}
 535 
 536   void do_thread(Thread* thr) {
 537     JavaThread* target = (JavaThread*)thr;
 538     // Note that this now allows multiple ThreadDeath exceptions to be
 539     // thrown at a thread.
 540     // The target thread has run and has not exited yet.
 541     target-&gt;send_thread_stop(_throwable());
 542   }
 543 };
 544 
 545 void Thread::send_async_exception(oop java_thread, oop java_throwable) {
 546   Handle throwable(Thread::current(), java_throwable);
 547   JavaThread* target = java_lang_Thread::thread(java_thread);
 548   InstallAsyncExceptionClosure vm_stop(throwable);
 549   Handshake::execute(&amp;vm_stop, target);
 550 }
 551 
 552 
 553 // Check if an external suspend request has completed (or has been
 554 // cancelled). Returns true if the thread is externally suspended and
 555 // false otherwise.
 556 //
 557 // The bits parameter returns information about the code path through
 558 // the routine. Useful for debugging:
 559 //
 560 // set in is_ext_suspend_completed():
 561 // 0x00000001 - routine was entered
 562 // 0x00000010 - routine return false at end
 563 // 0x00000100 - thread exited (return false)
 564 // 0x00000200 - suspend request cancelled (return false)
 565 // 0x00000400 - thread suspended (return true)
 566 // 0x00001000 - thread is in a suspend equivalent state (return true)
 567 // 0x00002000 - thread is native and walkable (return true)
 568 // 0x00004000 - thread is native_trans and walkable (needed retry)
 569 //
 570 // set in wait_for_ext_suspend_completion():
 571 // 0x00010000 - routine was entered
 572 // 0x00020000 - suspend request cancelled before loop (return false)
 573 // 0x00040000 - thread suspended before loop (return true)
 574 // 0x00080000 - suspend request cancelled in loop (return false)
 575 // 0x00100000 - thread suspended in loop (return true)
 576 // 0x00200000 - suspend not completed during retry loop (return false)
 577 
 578 // Helper class for tracing suspend wait debug bits.
 579 //
 580 // 0x00000100 indicates that the target thread exited before it could
 581 // self-suspend which is not a wait failure. 0x00000200, 0x00020000 and
 582 // 0x00080000 each indicate a cancelled suspend request so they don&#39;t
 583 // count as wait failures either.
 584 #define DEBUG_FALSE_BITS (0x00000010 | 0x00200000)
 585 
 586 class TraceSuspendDebugBits : public StackObj {
 587  private:
 588   JavaThread * jt;
 589   bool         is_wait;
 590   bool         called_by_wait;  // meaningful when !is_wait
 591   uint32_t *   bits;
 592 
 593  public:
 594   TraceSuspendDebugBits(JavaThread *_jt, bool _is_wait, bool _called_by_wait,
 595                         uint32_t *_bits) {
 596     jt             = _jt;
 597     is_wait        = _is_wait;
 598     called_by_wait = _called_by_wait;
 599     bits           = _bits;
 600   }
 601 
 602   ~TraceSuspendDebugBits() {
 603     if (!is_wait) {
 604 #if 1
 605       // By default, don&#39;t trace bits for is_ext_suspend_completed() calls.
 606       // That trace is very chatty.
 607       return;
 608 #else
 609       if (!called_by_wait) {
 610         // If tracing for is_ext_suspend_completed() is enabled, then only
 611         // trace calls to it from wait_for_ext_suspend_completion()
 612         return;
 613       }
 614 #endif
 615     }
 616 
 617     if (AssertOnSuspendWaitFailure || TraceSuspendWaitFailures) {
 618       if (bits != NULL &amp;&amp; (*bits &amp; DEBUG_FALSE_BITS) != 0) {
 619         MutexLocker ml(Threads_lock);  // needed for get_thread_name()
 620         ResourceMark rm;
 621 
 622         tty-&gt;print_cr(
 623                       &quot;Failed wait_for_ext_suspend_completion(thread=%s, debug_bits=%x)&quot;,
 624                       jt-&gt;get_thread_name(), *bits);
 625 
 626         guarantee(!AssertOnSuspendWaitFailure, &quot;external suspend wait failed&quot;);
 627       }
 628     }
 629   }
 630 };
 631 #undef DEBUG_FALSE_BITS
 632 
 633 
 634 bool JavaThread::is_ext_suspend_completed(bool called_by_wait, int delay,
 635                                           uint32_t *bits) {
 636   TraceSuspendDebugBits tsdb(this, false /* !is_wait */, called_by_wait, bits);
 637 
 638   bool did_trans_retry = false;  // only do thread_in_native_trans retry once
 639   bool do_trans_retry;           // flag to force the retry
 640 
 641   *bits |= 0x00000001;
 642 
 643   do {
 644     do_trans_retry = false;
 645 
 646     if (is_exiting()) {
 647       // Thread is in the process of exiting. This is always checked
 648       // first to reduce the risk of dereferencing a freed JavaThread.
 649       *bits |= 0x00000100;
 650       return false;
 651     }
 652 
 653     if (!is_external_suspend()) {
 654       // Suspend request is cancelled. This is always checked before
 655       // is_ext_suspended() to reduce the risk of a rogue resume
 656       // confusing the thread that made the suspend request.
 657       *bits |= 0x00000200;
 658       return false;
 659     }
 660 
 661     if (is_ext_suspended()) {
 662       // thread is suspended
 663       *bits |= 0x00000400;
 664       return true;
 665     }
 666 
 667     // Now that we no longer do hard suspends of threads running
 668     // native code, the target thread can be changing thread state
 669     // while we are in this routine:
 670     //
 671     //   _thread_in_native -&gt; _thread_in_native_trans -&gt; _thread_blocked
 672     //
 673     // We save a copy of the thread state as observed at this moment
 674     // and make our decision about suspend completeness based on the
 675     // copy. This closes the race where the thread state is seen as
 676     // _thread_in_native_trans in the if-thread_blocked check, but is
 677     // seen as _thread_blocked in if-thread_in_native_trans check.
 678     JavaThreadState save_state = thread_state();
 679 
 680     if (save_state == _thread_blocked &amp;&amp; is_suspend_equivalent()) {
 681       // If the thread&#39;s state is _thread_blocked and this blocking
 682       // condition is known to be equivalent to a suspend, then we can
 683       // consider the thread to be externally suspended. This means that
 684       // the code that sets _thread_blocked has been modified to do
 685       // self-suspension if the blocking condition releases. We also
 686       // used to check for CONDVAR_WAIT here, but that is now covered by
 687       // the _thread_blocked with self-suspension check.
 688       //
 689       // Return true since we wouldn&#39;t be here unless there was still an
 690       // external suspend request.
 691       *bits |= 0x00001000;
 692       return true;
 693     } else if (save_state == _thread_in_native &amp;&amp; frame_anchor()-&gt;walkable()) {
 694       // Threads running native code will self-suspend on native==&gt;VM/Java
 695       // transitions. If its stack is walkable (should always be the case
 696       // unless this function is called before the actual java_suspend()
 697       // call), then the wait is done.
 698       *bits |= 0x00002000;
 699       return true;
 700     } else if (!called_by_wait &amp;&amp; !did_trans_retry &amp;&amp;
 701                save_state == _thread_in_native_trans &amp;&amp;
 702                frame_anchor()-&gt;walkable()) {
 703       // The thread is transitioning from thread_in_native to another
 704       // thread state. check_safepoint_and_suspend_for_native_trans()
 705       // will force the thread to self-suspend. If it hasn&#39;t gotten
 706       // there yet we may have caught the thread in-between the native
 707       // code check above and the self-suspend. Lucky us. If we were
 708       // called by wait_for_ext_suspend_completion(), then it
 709       // will be doing the retries so we don&#39;t have to.
 710       //
 711       // Since we use the saved thread state in the if-statement above,
 712       // there is a chance that the thread has already transitioned to
 713       // _thread_blocked by the time we get here. In that case, we will
 714       // make a single unnecessary pass through the logic below. This
 715       // doesn&#39;t hurt anything since we still do the trans retry.
 716 
 717       *bits |= 0x00004000;
 718 
 719       // Once the thread leaves thread_in_native_trans for another
 720       // thread state, we break out of this retry loop. We shouldn&#39;t
 721       // need this flag to prevent us from getting back here, but
 722       // sometimes paranoia is good.
 723       did_trans_retry = true;
 724 
 725       // We wait for the thread to transition to a more usable state.
 726       for (int i = 1; i &lt;= SuspendRetryCount; i++) {
 727         // We used to do an &quot;os::yield_all(i)&quot; call here with the intention
 728         // that yielding would increase on each retry. However, the parameter
 729         // is ignored on Linux which means the yield didn&#39;t scale up. Waiting
 730         // on the SR_lock below provides a much more predictable scale up for
 731         // the delay. It also provides a simple/direct point to check for any
 732         // safepoint requests from the VMThread
 733 
 734         // temporarily drops SR_lock while doing wait with safepoint check
 735         // (if we&#39;re a JavaThread - the WatcherThread can also call this)
 736         // and increase delay with each retry
 737         if (Thread::current()-&gt;is_Java_thread()) {
 738           SR_lock()-&gt;wait(i * delay);
 739         } else {
 740           SR_lock()-&gt;wait_without_safepoint_check(i * delay);
 741         }
 742 
 743         // check the actual thread state instead of what we saved above
 744         if (thread_state() != _thread_in_native_trans) {
 745           // the thread has transitioned to another thread state so
 746           // try all the checks (except this one) one more time.
 747           do_trans_retry = true;
 748           break;
 749         }
 750       } // end retry loop
 751 
 752 
 753     }
 754   } while (do_trans_retry);
 755 
 756   *bits |= 0x00000010;
 757   return false;
 758 }
 759 
 760 // Wait for an external suspend request to complete (or be cancelled).
 761 // Returns true if the thread is externally suspended and false otherwise.
 762 //
 763 bool JavaThread::wait_for_ext_suspend_completion(int retries, int delay,
 764                                                  uint32_t *bits) {
 765   TraceSuspendDebugBits tsdb(this, true /* is_wait */,
 766                              false /* !called_by_wait */, bits);
 767 
 768   // local flag copies to minimize SR_lock hold time
 769   bool is_suspended;
 770   bool pending;
 771   uint32_t reset_bits;
 772 
 773   // set a marker so is_ext_suspend_completed() knows we are the caller
 774   *bits |= 0x00010000;
 775 
 776   // We use reset_bits to reinitialize the bits value at the top of
 777   // each retry loop. This allows the caller to make use of any
 778   // unused bits for their own marking purposes.
 779   reset_bits = *bits;
 780 
 781   {
 782     MutexLocker ml(SR_lock(), Mutex::_no_safepoint_check_flag);
 783     is_suspended = is_ext_suspend_completed(true /* called_by_wait */,
 784                                             delay, bits);
 785     pending = is_external_suspend();
 786   }
 787   // must release SR_lock to allow suspension to complete
 788 
 789   if (!pending) {
 790     // A cancelled suspend request is the only false return from
 791     // is_ext_suspend_completed() that keeps us from entering the
 792     // retry loop.
 793     *bits |= 0x00020000;
 794     return false;
 795   }
 796 
 797   if (is_suspended) {
 798     *bits |= 0x00040000;
 799     return true;
 800   }
 801 
 802   for (int i = 1; i &lt;= retries; i++) {
 803     *bits = reset_bits;  // reinit to only track last retry
 804 
 805     // We used to do an &quot;os::yield_all(i)&quot; call here with the intention
 806     // that yielding would increase on each retry. However, the parameter
 807     // is ignored on Linux which means the yield didn&#39;t scale up. Waiting
 808     // on the SR_lock below provides a much more predictable scale up for
 809     // the delay. It also provides a simple/direct point to check for any
 810     // safepoint requests from the VMThread
 811 
 812     {
 813       Thread* t = Thread::current();
 814       MonitorLocker ml(SR_lock(),
 815                        t-&gt;is_Java_thread() ? Mutex::_safepoint_check_flag : Mutex::_no_safepoint_check_flag);
 816       // wait with safepoint check (if we&#39;re a JavaThread - the WatcherThread
 817       // can also call this)  and increase delay with each retry
 818       ml.wait(i * delay);
 819 
 820       is_suspended = is_ext_suspend_completed(true /* called_by_wait */,
 821                                               delay, bits);
 822 
 823       // It is possible for the external suspend request to be cancelled
 824       // (by a resume) before the actual suspend operation is completed.
 825       // Refresh our local copy to see if we still need to wait.
 826       pending = is_external_suspend();
 827     }
 828 
 829     if (!pending) {
 830       // A cancelled suspend request is the only false return from
 831       // is_ext_suspend_completed() that keeps us from staying in the
 832       // retry loop.
 833       *bits |= 0x00080000;
 834       return false;
 835     }
 836 
 837     if (is_suspended) {
 838       *bits |= 0x00100000;
 839       return true;
 840     }
 841   } // end retry loop
 842 
 843   // thread did not suspend after all our retries
 844   *bits |= 0x00200000;
 845   return false;
 846 }
 847 
 848 // Called from API entry points which perform stack walking. If the
 849 // associated JavaThread is the current thread, then wait_for_suspend
 850 // is not used. Otherwise, it determines if we should wait for the
 851 // &quot;other&quot; thread to complete external suspension. (NOTE: in future
 852 // releases the suspension mechanism should be reimplemented so this
 853 // is not necessary.)
 854 //
 855 bool
 856 JavaThread::is_thread_fully_suspended(bool wait_for_suspend, uint32_t *bits) {
 857   if (this != JavaThread::current()) {
 858     // &quot;other&quot; threads require special handling.
 859     if (wait_for_suspend) {
 860       // We are allowed to wait for the external suspend to complete
 861       // so give the other thread a chance to get suspended.
 862       if (!wait_for_ext_suspend_completion(SuspendRetryCount,
 863                                            SuspendRetryDelay, bits)) {
 864         // Didn&#39;t make it so let the caller know.
 865         return false;
 866       }
 867     }
 868     // We aren&#39;t allowed to wait for the external suspend to complete
 869     // so if the other thread isn&#39;t externally suspended we need to
 870     // let the caller know.
 871     else if (!is_ext_suspend_completed_with_lock(bits)) {
 872       return false;
 873     }
 874   }
 875 
 876   return true;
 877 }
 878 
 879 // GC Support
 880 bool Thread::claim_par_threads_do(uintx claim_token) {
 881   uintx token = _threads_do_token;
 882   if (token != claim_token) {
 883     uintx res = Atomic::cmpxchg(&amp;_threads_do_token, token, claim_token);
 884     if (res == token) {
 885       return true;
 886     }
 887     guarantee(res == claim_token, &quot;invariant&quot;);
 888   }
 889   return false;
 890 }
 891 
 892 void Thread::oops_do(OopClosure* f, CodeBlobClosure* cf) {
 893   active_handles()-&gt;oops_do(f);
 894   // Do oop for ThreadShadow
 895   f-&gt;do_oop((oop*)&amp;_pending_exception);
 896   handle_area()-&gt;oops_do(f);
 897 
 898   // We scan thread local monitor lists here, and the remaining global
 899   // monitors in ObjectSynchronizer::oops_do().
 900   ObjectSynchronizer::thread_local_used_oops_do(this, f);
 901 }
 902 
 903 void Thread::metadata_handles_do(void f(Metadata*)) {
 904   // Only walk the Handles in Thread.
 905   if (metadata_handles() != NULL) {
 906     for (int i = 0; i&lt; metadata_handles()-&gt;length(); i++) {
 907       f(metadata_handles()-&gt;at(i));
 908     }
 909   }
 910 }
 911 
 912 void Thread::print_on(outputStream* st, bool print_extended_info) const {
 913   // get_priority assumes osthread initialized
 914   if (osthread() != NULL) {
 915     int os_prio;
 916     if (os::get_native_priority(this, &amp;os_prio) == OS_OK) {
 917       st-&gt;print(&quot;os_prio=%d &quot;, os_prio);
 918     }
 919 
 920     st-&gt;print(&quot;cpu=%.2fms &quot;,
 921               os::thread_cpu_time(const_cast&lt;Thread*&gt;(this), true) / 1000000.0
 922               );
 923     st-&gt;print(&quot;elapsed=%.2fs &quot;,
 924               _statistical_info.getElapsedTime() / 1000.0
 925               );
 926     if (is_Java_thread() &amp;&amp; (PrintExtendedThreadInfo || print_extended_info)) {
 927       size_t allocated_bytes = (size_t) const_cast&lt;Thread*&gt;(this)-&gt;cooked_allocated_bytes();
 928       st-&gt;print(&quot;allocated=&quot; SIZE_FORMAT &quot;%s &quot;,
 929                 byte_size_in_proper_unit(allocated_bytes),
 930                 proper_unit_for_byte_size(allocated_bytes)
 931                 );
 932       st-&gt;print(&quot;defined_classes=&quot; INT64_FORMAT &quot; &quot;, _statistical_info.getDefineClassCount());
 933     }
 934 
 935     st-&gt;print(&quot;tid=&quot; INTPTR_FORMAT &quot; &quot;, p2i(this));
 936     osthread()-&gt;print_on(st);
 937   }
 938   ThreadsSMRSupport::print_info_on(this, st);
 939   st-&gt;print(&quot; &quot;);
 940   debug_only(if (WizardMode) print_owned_locks_on(st);)
 941 }
 942 
 943 void Thread::print() const { print_on(tty); }
 944 
 945 // Thread::print_on_error() is called by fatal error handler. Don&#39;t use
 946 // any lock or allocate memory.
 947 void Thread::print_on_error(outputStream* st, char* buf, int buflen) const {
 948   assert(!(is_Compiler_thread() || is_Java_thread()), &quot;Can&#39;t call name() here if it allocates&quot;);
 949 
 950   if (is_VM_thread())                 { st-&gt;print(&quot;VMThread&quot;); }
 951   else if (is_GC_task_thread())       { st-&gt;print(&quot;GCTaskThread&quot;); }
 952   else if (is_Watcher_thread())       { st-&gt;print(&quot;WatcherThread&quot;); }
 953   else if (is_ConcurrentGC_thread())  { st-&gt;print(&quot;ConcurrentGCThread&quot;); }
 954   else                                { st-&gt;print(&quot;Thread&quot;); }
 955 
 956   if (is_Named_thread()) {
 957     st-&gt;print(&quot; \&quot;%s\&quot;&quot;, name());
 958   }
 959 
 960   st-&gt;print(&quot; [stack: &quot; PTR_FORMAT &quot;,&quot; PTR_FORMAT &quot;]&quot;,
 961             p2i(stack_end()), p2i(stack_base()));
 962 
 963   if (osthread()) {
 964     st-&gt;print(&quot; [id=%d]&quot;, osthread()-&gt;thread_id());
 965   }
 966 
 967   ThreadsSMRSupport::print_info_on(this, st);
 968 }
 969 
 970 void Thread::print_value_on(outputStream* st) const {
 971   if (is_Named_thread()) {
 972     st-&gt;print(&quot; \&quot;%s\&quot; &quot;, name());
 973   }
 974   st-&gt;print(INTPTR_FORMAT, p2i(this));   // print address
 975 }
 976 
 977 #ifdef ASSERT
 978 void Thread::print_owned_locks_on(outputStream* st) const {
 979   Mutex* cur = _owned_locks;
 980   if (cur == NULL) {
 981     st-&gt;print(&quot; (no locks) &quot;);
 982   } else {
 983     st-&gt;print_cr(&quot; Locks owned:&quot;);
 984     while (cur) {
 985       cur-&gt;print_on(st);
 986       cur = cur-&gt;next();
 987     }
 988   }
 989 }
 990 
 991 // Checks safepoint allowed and clears unhandled oops at potential safepoints.
 992 void Thread::check_possible_safepoint() {
 993   if (!is_Java_thread()) return;
 994 
 995   if (_no_safepoint_count &gt; 0) {
 996     print_owned_locks();
 997     fatal(&quot;Possible safepoint reached by thread that does not allow it&quot;);
 998   }
 999 #ifdef CHECK_UNHANDLED_OOPS
1000   // Clear unhandled oops in JavaThreads so we get a crash right away.
1001   clear_unhandled_oops();
1002 #endif // CHECK_UNHANDLED_OOPS
1003 }
1004 
1005 void Thread::check_for_valid_safepoint_state() {
1006   if (!is_Java_thread()) return;
1007 
1008   // Check NoSafepointVerifier, which is implied by locks taken that can be
1009   // shared with the VM thread.  This makes sure that no locks with allow_vm_block
1010   // are held.
1011   check_possible_safepoint();
1012 
1013   if (((JavaThread*)this)-&gt;thread_state() != _thread_in_vm) {
1014     fatal(&quot;LEAF method calling lock?&quot;);
1015   }
1016 
1017   if (GCALotAtAllSafepoints) {
1018     // We could enter a safepoint here and thus have a gc
1019     InterfaceSupport::check_gc_alot();
1020   }
1021 }
1022 #endif // ASSERT
1023 
1024 bool Thread::is_in_stack(address adr) const {
1025   assert(Thread::current() == this, &quot;is_in_stack can only be called from current thread&quot;);
1026   address end = os::current_stack_pointer();
1027   // Allow non Java threads to call this without stack_base
1028   if (_stack_base == NULL) return true;
1029   if (stack_base() &gt; adr &amp;&amp; adr &gt;= end) return true;
1030 
1031   return false;
1032 }
1033 
1034 bool Thread::is_in_usable_stack(address adr) const {
1035   size_t stack_guard_size = os::uses_stack_guard_pages() ? JavaThread::stack_guard_zone_size() : 0;
1036   size_t usable_stack_size = _stack_size - stack_guard_size;
1037 
1038   return ((adr &lt; stack_base()) &amp;&amp; (adr &gt;= stack_base() - usable_stack_size));
1039 }
1040 
1041 
1042 // We had to move these methods here, because vm threads get into ObjectSynchronizer::enter
1043 // However, there is a note in JavaThread::is_lock_owned() about the VM threads not being
1044 // used for compilation in the future. If that change is made, the need for these methods
1045 // should be revisited, and they should be removed if possible.
1046 
1047 bool Thread::is_lock_owned(address adr) const {
1048   return on_local_stack(adr);
1049 }
1050 
1051 bool Thread::set_as_starting_thread() {
1052   assert(_starting_thread == NULL, &quot;already initialized: &quot;
1053          &quot;_starting_thread=&quot; INTPTR_FORMAT, p2i(_starting_thread));
1054   // NOTE: this must be called inside the main thread.
1055   DEBUG_ONLY(_starting_thread = this;)
1056   return os::create_main_thread((JavaThread*)this);
1057 }
1058 
1059 static void initialize_class(Symbol* class_name, TRAPS) {
1060   Klass* klass = SystemDictionary::resolve_or_fail(class_name, true, CHECK);
1061   InstanceKlass::cast(klass)-&gt;initialize(CHECK);
1062 }
1063 
1064 
1065 // Creates the initial ThreadGroup
1066 static Handle create_initial_thread_group(TRAPS) {
1067   Handle system_instance = JavaCalls::construct_new_instance(
1068                             SystemDictionary::ThreadGroup_klass(),
1069                             vmSymbols::void_method_signature(),
1070                             CHECK_NH);
1071   Universe::set_system_thread_group(system_instance());
1072 
1073   Handle string = java_lang_String::create_from_str(&quot;main&quot;, CHECK_NH);
1074   Handle main_instance = JavaCalls::construct_new_instance(
1075                             SystemDictionary::ThreadGroup_klass(),
1076                             vmSymbols::threadgroup_string_void_signature(),
1077                             system_instance,
1078                             string,
1079                             CHECK_NH);
1080   return main_instance;
1081 }
1082 
1083 // Creates the initial Thread
1084 static oop create_initial_thread(Handle thread_group, JavaThread* thread,
1085                                  TRAPS) {
1086   InstanceKlass* ik = SystemDictionary::Thread_klass();
1087   assert(ik-&gt;is_initialized(), &quot;must be&quot;);
1088   instanceHandle thread_oop = ik-&gt;allocate_instance_handle(CHECK_NULL);
1089 
1090   // Cannot use JavaCalls::construct_new_instance because the java.lang.Thread
1091   // constructor calls Thread.current(), which must be set here for the
1092   // initial thread.
1093   java_lang_Thread::set_thread(thread_oop(), thread);
1094   thread-&gt;set_threadObj(thread_oop());
1095 
1096   Handle string = java_lang_String::create_from_str(&quot;main&quot;, CHECK_NULL);
1097 
1098   JavaValue result(T_VOID);
1099   JavaCalls::call_special(&amp;result, thread_oop,
1100                           ik,
1101                           vmSymbols::object_initializer_name(),
1102                           vmSymbols::threadgroup_string_void_signature(),
1103                           thread_group,
1104                           string,
1105                           CHECK_NULL);
1106   // initial thread is Thread.NORM_PRIORITY
1107   os::set_priority(thread, NormPriority);
1108   return thread_oop();
1109 }
1110 
1111 char java_runtime_name[128] = &quot;&quot;;
1112 char java_runtime_version[128] = &quot;&quot;;
1113 char java_runtime_vendor_version[128] = &quot;&quot;;
1114 char java_runtime_vendor_vm_bug_url[128] = &quot;&quot;;
1115 
1116 // extract the JRE name from java.lang.VersionProps.java_runtime_name
1117 static const char* get_java_runtime_name(TRAPS) {
1118   Klass* k = SystemDictionary::find(vmSymbols::java_lang_VersionProps(),
1119                                     Handle(), Handle(), CHECK_AND_CLEAR_NULL);
1120   fieldDescriptor fd;
1121   bool found = k != NULL &amp;&amp;
1122                InstanceKlass::cast(k)-&gt;find_local_field(vmSymbols::java_runtime_name_name(),
1123                                                         vmSymbols::string_signature(), &amp;fd);
1124   if (found) {
1125     oop name_oop = k-&gt;java_mirror()-&gt;obj_field(fd.offset());
1126     if (name_oop == NULL) {
1127       return NULL;
1128     }
1129     const char* name = java_lang_String::as_utf8_string(name_oop,
1130                                                         java_runtime_name,
1131                                                         sizeof(java_runtime_name));
1132     return name;
1133   } else {
1134     return NULL;
1135   }
1136 }
1137 
1138 // extract the JRE version from java.lang.VersionProps.java_runtime_version
1139 static const char* get_java_runtime_version(TRAPS) {
1140   Klass* k = SystemDictionary::find(vmSymbols::java_lang_VersionProps(),
1141                                     Handle(), Handle(), CHECK_AND_CLEAR_NULL);
1142   fieldDescriptor fd;
1143   bool found = k != NULL &amp;&amp;
1144                InstanceKlass::cast(k)-&gt;find_local_field(vmSymbols::java_runtime_version_name(),
1145                                                         vmSymbols::string_signature(), &amp;fd);
1146   if (found) {
1147     oop name_oop = k-&gt;java_mirror()-&gt;obj_field(fd.offset());
1148     if (name_oop == NULL) {
1149       return NULL;
1150     }
1151     const char* name = java_lang_String::as_utf8_string(name_oop,
1152                                                         java_runtime_version,
1153                                                         sizeof(java_runtime_version));
1154     return name;
1155   } else {
1156     return NULL;
1157   }
1158 }
1159 
1160 // extract the JRE vendor version from java.lang.VersionProps.VENDOR_VERSION
1161 static const char* get_java_runtime_vendor_version(TRAPS) {
1162   Klass* k = SystemDictionary::find(vmSymbols::java_lang_VersionProps(),
1163                                     Handle(), Handle(), CHECK_AND_CLEAR_NULL);
1164   fieldDescriptor fd;
1165   bool found = k != NULL &amp;&amp;
1166                InstanceKlass::cast(k)-&gt;find_local_field(vmSymbols::java_runtime_vendor_version_name(),
1167                                                         vmSymbols::string_signature(), &amp;fd);
1168   if (found) {
1169     oop name_oop = k-&gt;java_mirror()-&gt;obj_field(fd.offset());
1170     if (name_oop == NULL) {
1171       return NULL;
1172     }
1173     const char* name = java_lang_String::as_utf8_string(name_oop,
1174                                                         java_runtime_vendor_version,
1175                                                         sizeof(java_runtime_vendor_version));
1176     return name;
1177   } else {
1178     return NULL;
1179   }
1180 }
1181 
1182 // extract the JRE vendor VM bug URL from java.lang.VersionProps.VENDOR_URL_VM_BUG
1183 static const char* get_java_runtime_vendor_vm_bug_url(TRAPS) {
1184   Klass* k = SystemDictionary::find(vmSymbols::java_lang_VersionProps(),
1185                                     Handle(), Handle(), CHECK_AND_CLEAR_NULL);
1186   fieldDescriptor fd;
1187   bool found = k != NULL &amp;&amp;
1188                InstanceKlass::cast(k)-&gt;find_local_field(vmSymbols::java_runtime_vendor_vm_bug_url_name(),
1189                                                         vmSymbols::string_signature(), &amp;fd);
1190   if (found) {
1191     oop name_oop = k-&gt;java_mirror()-&gt;obj_field(fd.offset());
1192     if (name_oop == NULL) {
1193       return NULL;
1194     }
1195     const char* name = java_lang_String::as_utf8_string(name_oop,
1196                                                         java_runtime_vendor_vm_bug_url,
1197                                                         sizeof(java_runtime_vendor_vm_bug_url));
1198     return name;
1199   } else {
1200     return NULL;
1201   }
1202 }
1203 
1204 // General purpose hook into Java code, run once when the VM is initialized.
1205 // The Java library method itself may be changed independently from the VM.
1206 static void call_postVMInitHook(TRAPS) {
1207   Klass* klass = SystemDictionary::resolve_or_null(vmSymbols::jdk_internal_vm_PostVMInitHook(), THREAD);
1208   if (klass != NULL) {
1209     JavaValue result(T_VOID);
1210     JavaCalls::call_static(&amp;result, klass, vmSymbols::run_method_name(),
1211                            vmSymbols::void_method_signature(),
1212                            CHECK);
1213   }
1214 }
1215 
1216 void JavaThread::allocate_threadObj(Handle thread_group, const char* thread_name,
1217                                     bool daemon, TRAPS) {
1218   assert(thread_group.not_null(), &quot;thread group should be specified&quot;);
1219   assert(threadObj() == NULL, &quot;should only create Java thread object once&quot;);
1220 
1221   InstanceKlass* ik = SystemDictionary::Thread_klass();
1222   assert(ik-&gt;is_initialized(), &quot;must be&quot;);
1223   instanceHandle thread_oop = ik-&gt;allocate_instance_handle(CHECK);
1224 
1225   // We are called from jni_AttachCurrentThread/jni_AttachCurrentThreadAsDaemon.
1226   // We cannot use JavaCalls::construct_new_instance because the java.lang.Thread
1227   // constructor calls Thread.current(), which must be set here.
1228   java_lang_Thread::set_thread(thread_oop(), this);
1229   set_threadObj(thread_oop());
1230 
1231   JavaValue result(T_VOID);
1232   if (thread_name != NULL) {
1233     Handle name = java_lang_String::create_from_str(thread_name, CHECK);
1234     // Thread gets assigned specified name and null target
1235     JavaCalls::call_special(&amp;result,
1236                             thread_oop,
1237                             ik,
1238                             vmSymbols::object_initializer_name(),
1239                             vmSymbols::threadgroup_string_void_signature(),
1240                             thread_group,
1241                             name,
1242                             THREAD);
1243   } else {
1244     // Thread gets assigned name &quot;Thread-nnn&quot; and null target
1245     // (java.lang.Thread doesn&#39;t have a constructor taking only a ThreadGroup argument)
1246     JavaCalls::call_special(&amp;result,
1247                             thread_oop,
1248                             ik,
1249                             vmSymbols::object_initializer_name(),
1250                             vmSymbols::threadgroup_runnable_void_signature(),
1251                             thread_group,
1252                             Handle(),
1253                             THREAD);
1254   }
1255   os::set_priority(this, NormPriority);
1256 
1257   if (daemon) {
1258     java_lang_Thread::set_daemon(thread_oop());
1259   }
1260 
1261   if (HAS_PENDING_EXCEPTION) {
1262     return;
1263   }
1264 
1265   Klass* group =  SystemDictionary::ThreadGroup_klass();
1266   Handle threadObj(THREAD, this-&gt;threadObj());
1267 
1268   JavaCalls::call_special(&amp;result,
1269                           thread_group,
1270                           group,
1271                           vmSymbols::add_method_name(),
1272                           vmSymbols::thread_void_signature(),
1273                           threadObj,          // Arg 1
1274                           THREAD);
1275 }
1276 
1277 // List of all NonJavaThreads and safe iteration over that list.
1278 
1279 class NonJavaThread::List {
1280 public:
1281   NonJavaThread* volatile _head;
1282   SingleWriterSynchronizer _protect;
1283 
1284   List() : _head(NULL), _protect() {}
1285 };
1286 
1287 NonJavaThread::List NonJavaThread::_the_list;
1288 
1289 NonJavaThread::Iterator::Iterator() :
1290   _protect_enter(_the_list._protect.enter()),
1291   _current(Atomic::load_acquire(&amp;_the_list._head))
1292 {}
1293 
1294 NonJavaThread::Iterator::~Iterator() {
1295   _the_list._protect.exit(_protect_enter);
1296 }
1297 
1298 void NonJavaThread::Iterator::step() {
1299   assert(!end(), &quot;precondition&quot;);
1300   _current = Atomic::load_acquire(&amp;_current-&gt;_next);
1301 }
1302 
1303 NonJavaThread::NonJavaThread() : Thread(), _next(NULL) {
1304   assert(BarrierSet::barrier_set() != NULL, &quot;NonJavaThread created too soon!&quot;);
1305 }
1306 
1307 NonJavaThread::~NonJavaThread() { }
1308 
1309 void NonJavaThread::add_to_the_list() {
1310   MutexLocker ml(NonJavaThreadsList_lock, Mutex::_no_safepoint_check_flag);
1311   // Initialize BarrierSet-related data before adding to list.
1312   BarrierSet::barrier_set()-&gt;on_thread_attach(this);
1313   Atomic::release_store(&amp;_next, _the_list._head);
1314   Atomic::release_store(&amp;_the_list._head, this);
1315 }
1316 
1317 void NonJavaThread::remove_from_the_list() {
1318   {
1319     MutexLocker ml(NonJavaThreadsList_lock, Mutex::_no_safepoint_check_flag);
1320     // Cleanup BarrierSet-related data before removing from list.
1321     BarrierSet::barrier_set()-&gt;on_thread_detach(this);
1322     NonJavaThread* volatile* p = &amp;_the_list._head;
1323     for (NonJavaThread* t = *p; t != NULL; p = &amp;t-&gt;_next, t = *p) {
1324       if (t == this) {
1325         *p = _next;
1326         break;
1327       }
1328     }
1329   }
1330   // Wait for any in-progress iterators.  Concurrent synchronize is not
1331   // allowed, so do it while holding a dedicated lock.  Outside and distinct
1332   // from NJTList_lock in case an iteration attempts to lock it.
1333   MutexLocker ml(NonJavaThreadsListSync_lock, Mutex::_no_safepoint_check_flag);
1334   _the_list._protect.synchronize();
1335   _next = NULL;                 // Safe to drop the link now.
1336 }
1337 
1338 void NonJavaThread::pre_run() {
1339   add_to_the_list();
1340 
1341   // This is slightly odd in that NamedThread is a subclass, but
1342   // in fact name() is defined in Thread
1343   assert(this-&gt;name() != NULL, &quot;thread name was not set before it was started&quot;);
1344   this-&gt;set_native_thread_name(this-&gt;name());
1345 }
1346 
1347 void NonJavaThread::post_run() {
1348   JFR_ONLY(Jfr::on_thread_exit(this);)
1349   remove_from_the_list();
1350   // Ensure thread-local-storage is cleared before termination.
1351   Thread::clear_thread_current();
1352 }
1353 
1354 // NamedThread --  non-JavaThread subclasses with multiple
1355 // uniquely named instances should derive from this.
1356 NamedThread::NamedThread() :
1357   NonJavaThread(),
1358   _name(NULL),
1359   _processed_thread(NULL),
1360   _gc_id(GCId::undefined())
1361 {}
1362 
1363 NamedThread::~NamedThread() {
1364   FREE_C_HEAP_ARRAY(char, _name);
1365 }
1366 
1367 void NamedThread::set_name(const char* format, ...) {
1368   guarantee(_name == NULL, &quot;Only get to set name once.&quot;);
1369   _name = NEW_C_HEAP_ARRAY(char, max_name_len, mtThread);
1370   va_list ap;
1371   va_start(ap, format);
1372   jio_vsnprintf(_name, max_name_len, format, ap);
1373   va_end(ap);
1374 }
1375 
1376 void NamedThread::print_on(outputStream* st) const {
1377   st-&gt;print(&quot;\&quot;%s\&quot; &quot;, name());
1378   Thread::print_on(st);
1379   st-&gt;cr();
1380 }
1381 
1382 
1383 // ======= WatcherThread ========
1384 
1385 // The watcher thread exists to simulate timer interrupts.  It should
1386 // be replaced by an abstraction over whatever native support for
1387 // timer interrupts exists on the platform.
1388 
1389 WatcherThread* WatcherThread::_watcher_thread   = NULL;
1390 bool WatcherThread::_startable = false;
1391 volatile bool  WatcherThread::_should_terminate = false;
1392 
1393 WatcherThread::WatcherThread() : NonJavaThread() {
1394   assert(watcher_thread() == NULL, &quot;we can only allocate one WatcherThread&quot;);
1395   if (os::create_thread(this, os::watcher_thread)) {
1396     _watcher_thread = this;
1397 
1398     // Set the watcher thread to the highest OS priority which should not be
1399     // used, unless a Java thread with priority java.lang.Thread.MAX_PRIORITY
1400     // is created. The only normal thread using this priority is the reference
1401     // handler thread, which runs for very short intervals only.
1402     // If the VMThread&#39;s priority is not lower than the WatcherThread profiling
1403     // will be inaccurate.
1404     os::set_priority(this, MaxPriority);
1405     if (!DisableStartThread) {
1406       os::start_thread(this);
1407     }
1408   }
1409 }
1410 
1411 int WatcherThread::sleep() const {
1412   // The WatcherThread does not participate in the safepoint protocol
1413   // for the PeriodicTask_lock because it is not a JavaThread.
1414   MonitorLocker ml(PeriodicTask_lock, Mutex::_no_safepoint_check_flag);
1415 
1416   if (_should_terminate) {
1417     // check for termination before we do any housekeeping or wait
1418     return 0;  // we did not sleep.
1419   }
1420 
1421   // remaining will be zero if there are no tasks,
1422   // causing the WatcherThread to sleep until a task is
1423   // enrolled
1424   int remaining = PeriodicTask::time_to_wait();
1425   int time_slept = 0;
1426 
1427   // we expect this to timeout - we only ever get unparked when
1428   // we should terminate or when a new task has been enrolled
1429   OSThreadWaitState osts(this-&gt;osthread(), false /* not Object.wait() */);
1430 
1431   jlong time_before_loop = os::javaTimeNanos();
1432 
1433   while (true) {
1434     bool timedout = ml.wait(remaining);
1435     jlong now = os::javaTimeNanos();
1436 
1437     if (remaining == 0) {
1438       // if we didn&#39;t have any tasks we could have waited for a long time
1439       // consider the time_slept zero and reset time_before_loop
1440       time_slept = 0;
1441       time_before_loop = now;
1442     } else {
1443       // need to recalculate since we might have new tasks in _tasks
1444       time_slept = (int) ((now - time_before_loop) / 1000000);
1445     }
1446 
1447     // Change to task list or spurious wakeup of some kind
1448     if (timedout || _should_terminate) {
1449       break;
1450     }
1451 
1452     remaining = PeriodicTask::time_to_wait();
1453     if (remaining == 0) {
1454       // Last task was just disenrolled so loop around and wait until
1455       // another task gets enrolled
1456       continue;
1457     }
1458 
1459     remaining -= time_slept;
1460     if (remaining &lt;= 0) {
1461       break;
1462     }
1463   }
1464 
1465   return time_slept;
1466 }
1467 
1468 void WatcherThread::run() {
1469   assert(this == watcher_thread(), &quot;just checking&quot;);
1470 
1471   this-&gt;set_active_handles(JNIHandleBlock::allocate_block());
1472   while (true) {
1473     assert(watcher_thread() == Thread::current(), &quot;thread consistency check&quot;);
1474     assert(watcher_thread() == this, &quot;thread consistency check&quot;);
1475 
1476     // Calculate how long it&#39;ll be until the next PeriodicTask work
1477     // should be done, and sleep that amount of time.
1478     int time_waited = sleep();
1479 
1480     if (VMError::is_error_reported()) {
1481       // A fatal error has happened, the error handler(VMError::report_and_die)
1482       // should abort JVM after creating an error log file. However in some
1483       // rare cases, the error handler itself might deadlock. Here periodically
1484       // check for error reporting timeouts, and if it happens, just proceed to
1485       // abort the VM.
1486 
1487       // This code is in WatcherThread because WatcherThread wakes up
1488       // periodically so the fatal error handler doesn&#39;t need to do anything;
1489       // also because the WatcherThread is less likely to crash than other
1490       // threads.
1491 
1492       for (;;) {
1493         // Note: we use naked sleep in this loop because we want to avoid using
1494         // any kind of VM infrastructure which may be broken at this point.
1495         if (VMError::check_timeout()) {
1496           // We hit error reporting timeout. Error reporting was interrupted and
1497           // will be wrapping things up now (closing files etc). Give it some more
1498           // time, then quit the VM.
1499           os::naked_short_sleep(200);
1500           // Print a message to stderr.
1501           fdStream err(defaultStream::output_fd());
1502           err.print_raw_cr(&quot;# [ timer expired, abort... ]&quot;);
1503           // skip atexit/vm_exit/vm_abort hooks
1504           os::die();
1505         }
1506 
1507         // Wait a second, then recheck for timeout.
1508         os::naked_short_sleep(999);
1509       }
1510     }
1511 
1512     if (_should_terminate) {
1513       // check for termination before posting the next tick
1514       break;
1515     }
1516 
1517     PeriodicTask::real_time_tick(time_waited);
1518   }
1519 
1520   // Signal that it is terminated
1521   {
1522     MutexLocker mu(Terminator_lock, Mutex::_no_safepoint_check_flag);
1523     _watcher_thread = NULL;
1524     Terminator_lock-&gt;notify_all();
1525   }
1526 }
1527 
1528 void WatcherThread::start() {
1529   assert(PeriodicTask_lock-&gt;owned_by_self(), &quot;PeriodicTask_lock required&quot;);
1530 
1531   if (watcher_thread() == NULL &amp;&amp; _startable) {
1532     _should_terminate = false;
1533     // Create the single instance of WatcherThread
1534     new WatcherThread();
1535   }
1536 }
1537 
1538 void WatcherThread::make_startable() {
1539   assert(PeriodicTask_lock-&gt;owned_by_self(), &quot;PeriodicTask_lock required&quot;);
1540   _startable = true;
1541 }
1542 
1543 void WatcherThread::stop() {
1544   {
1545     // Follow normal safepoint aware lock enter protocol since the
1546     // WatcherThread is stopped by another JavaThread.
1547     MutexLocker ml(PeriodicTask_lock);
1548     _should_terminate = true;
1549 
1550     WatcherThread* watcher = watcher_thread();
1551     if (watcher != NULL) {
1552       // unpark the WatcherThread so it can see that it should terminate
1553       watcher-&gt;unpark();
1554     }
1555   }
1556 
1557   MonitorLocker mu(Terminator_lock);
1558 
1559   while (watcher_thread() != NULL) {
1560     // This wait should make safepoint checks, wait without a timeout,
1561     // and wait as a suspend-equivalent condition.
1562     mu.wait(0, Mutex::_as_suspend_equivalent_flag);
1563   }
1564 }
1565 
1566 void WatcherThread::unpark() {
1567   assert(PeriodicTask_lock-&gt;owned_by_self(), &quot;PeriodicTask_lock required&quot;);
1568   PeriodicTask_lock-&gt;notify();
1569 }
1570 
1571 void WatcherThread::print_on(outputStream* st) const {
1572   st-&gt;print(&quot;\&quot;%s\&quot; &quot;, name());
1573   Thread::print_on(st);
1574   st-&gt;cr();
1575 }
1576 
1577 // ======= JavaThread ========
1578 
1579 #if INCLUDE_JVMCI
1580 
1581 jlong* JavaThread::_jvmci_old_thread_counters;
1582 
1583 bool jvmci_counters_include(JavaThread* thread) {
1584   return !JVMCICountersExcludeCompiler || !thread-&gt;is_Compiler_thread();
1585 }
1586 
1587 void JavaThread::collect_counters(jlong* array, int length) {
1588   assert(length == JVMCICounterSize, &quot;wrong value&quot;);
1589   for (int i = 0; i &lt; length; i++) {
1590     array[i] = _jvmci_old_thread_counters[i];
1591   }
1592   for (JavaThreadIteratorWithHandle jtiwh; JavaThread *tp = jtiwh.next(); ) {
1593     if (jvmci_counters_include(tp)) {
1594       for (int i = 0; i &lt; length; i++) {
1595         array[i] += tp-&gt;_jvmci_counters[i];
1596       }
1597     }
1598   }
1599 }
1600 
1601 // Attempt to enlarge the array for per thread counters.
1602 jlong* resize_counters_array(jlong* old_counters, int current_size, int new_size) {
1603   jlong* new_counters = NEW_C_HEAP_ARRAY(jlong, new_size, mtJVMCI);
1604   if (old_counters == NULL) {
1605     old_counters = new_counters;
1606     memset(old_counters, 0, sizeof(jlong) * new_size);
1607   } else {
1608     for (int i = 0; i &lt; MIN2((int) current_size, new_size); i++) {
1609       new_counters[i] = old_counters[i];
1610     }
1611     if (new_size &gt; current_size) {
1612       memset(new_counters + current_size, 0, sizeof(jlong) * (new_size - current_size));
1613     }
1614     FREE_C_HEAP_ARRAY(jlong, old_counters);
1615   }
1616   return new_counters;
1617 }
1618 
1619 // Attempt to enlarge the array for per thread counters.
1620 void JavaThread::resize_counters(int current_size, int new_size) {
1621   _jvmci_counters = resize_counters_array(_jvmci_counters, current_size, new_size);
1622 }
1623 
1624 class VM_JVMCIResizeCounters : public VM_Operation {
1625  private:
1626   int _new_size;
1627 
1628  public:
1629   VM_JVMCIResizeCounters(int new_size) : _new_size(new_size) { }
1630   VMOp_Type type()                  const        { return VMOp_JVMCIResizeCounters; }
1631   bool allow_nested_vm_operations() const        { return true; }
1632   void doit() {
1633     // Resize the old thread counters array
1634     jlong* new_counters = resize_counters_array(JavaThread::_jvmci_old_thread_counters, JVMCICounterSize, _new_size);
1635     JavaThread::_jvmci_old_thread_counters = new_counters;
1636 
1637     // Now resize each threads array
1638     for (JavaThreadIteratorWithHandle jtiwh; JavaThread *tp = jtiwh.next(); ) {
1639       tp-&gt;resize_counters(JVMCICounterSize, _new_size);
1640     }
1641     JVMCICounterSize = _new_size;
1642   }
1643 };
1644 
1645 void JavaThread::resize_all_jvmci_counters(int new_size) {
1646   VM_JVMCIResizeCounters op(new_size);
1647   VMThread::execute(&amp;op);
1648 }
1649 
1650 #endif // INCLUDE_JVMCI
1651 
1652 // A JavaThread is a normal Java thread
1653 
1654 void JavaThread::initialize() {
1655   // Initialize fields
1656 
1657   set_saved_exception_pc(NULL);
1658   set_threadObj(NULL);
1659   _anchor.clear();
1660   set_entry_point(NULL);
1661   set_jni_functions(jni_functions());
1662   set_callee_target(NULL);
1663   set_vm_result(NULL);
1664   set_vm_result_2(NULL);
1665   set_vframe_array_head(NULL);
1666   set_vframe_array_last(NULL);
1667   set_deferred_locals(NULL);
1668   set_keepalive_cleanup(new (ResourceObj::C_HEAP, mtInternal) GrowableArray&lt;WeakHandle&lt;vm_nmethod_keepalive_data&gt; &gt;(16, true));
1669   set_deopt_mark(NULL);
1670   set_deopt_compiled_method(NULL);
1671   set_monitor_chunks(NULL);
1672   _on_thread_list = false;
1673   _thread_state = _thread_new;
1674   _terminated = _not_terminated;
1675   _array_for_gc = NULL;
1676   _suspend_equivalent = false;
1677   _in_deopt_handler = 0;
1678   _doing_unsafe_access = false;
1679   _stack_guard_state = stack_guard_unused;
1680   DEBUG_ONLY(_continuation = NULL;)
1681 #if INCLUDE_JVMCI
1682   _pending_monitorenter = false;
1683   _pending_deoptimization = -1;
1684   _pending_failed_speculation = 0;
1685   _pending_transfer_to_interpreter = false;
1686   _in_retryable_allocation = false;
1687   _jvmci._alternate_call_target = NULL;
1688   assert(_jvmci._implicit_exception_pc == NULL, &quot;must be&quot;);
1689   _jvmci_counters = NULL;
1690   if (JVMCICounterSize &gt; 0) {
1691     resize_counters(0, (int) JVMCICounterSize);
1692   }
1693 #endif // INCLUDE_JVMCI
1694   _reserved_stack_activation = NULL;  // stack base not known yet
1695   (void)const_cast&lt;oop&amp;&gt;(_exception_oop = oop(NULL));
1696   _exception_pc  = 0;
1697   _exception_handler_pc = 0;
1698   _is_method_handle_return = 0;
1699   _jvmti_thread_state= NULL;
1700   _should_post_on_exceptions_flag = JNI_FALSE;
1701   _interp_only_mode    = 0;
1702   _special_runtime_exit_condition = _no_async_condition;
1703   _pending_async_exception = NULL;
1704   _thread_stat = NULL;
1705   _thread_stat = new ThreadStatistics();
1706   _jni_active_critical = 0;
1707   _pending_jni_exception_check_fn = NULL;
1708   _do_not_unlock_if_synchronized = false;
1709   _cached_monitor_info = NULL;
1710   _parker = Parker::Allocate(this);
1711   _SleepEvent = ParkEvent::Allocate(this);
1712     
1713   _cont_yield = false;
1714   _cont_preempt = false;
1715   _cont_fastpath = 0;
1716   memset(&amp;_cont_frame, 0, sizeof(FrameInfo));
1717   _held_monitor_count = 0;
1718     
1719   // Setup safepoint state info for this thread
1720   ThreadSafepointState::create(this);
1721 
1722   debug_only(_java_call_counter = 0);
1723 
1724   // JVMTI PopFrame support
1725   _popframe_condition = popframe_inactive;
1726   _popframe_preserved_args = NULL;
1727   _popframe_preserved_args_size = 0;
1728   _frames_to_pop_failed_realloc = 0;
1729 
1730   if (SafepointMechanism::uses_thread_local_poll()) {
1731     SafepointMechanism::initialize_header(this);
1732   }
1733 
1734   _class_to_be_initialized = NULL;
1735 
1736   _scopedCache = NULL;
1737 
1738   pd_initialize();
1739 }
1740 
1741 JavaThread::JavaThread(bool is_attaching_via_jni) :
1742                        Thread() {
1743   initialize();
1744   if (is_attaching_via_jni) {
1745     _jni_attach_state = _attaching_via_jni;
1746   } else {
1747     _jni_attach_state = _not_attaching_via_jni;
1748   }
1749   assert(deferred_card_mark().is_empty(), &quot;Default MemRegion ctor&quot;);
1750 }
1751 
1752 
1753 // interrupt support
1754 
1755 void JavaThread::interrupt() {
1756   debug_only(check_for_dangling_thread_pointer(this);)
1757 
1758   // For Windows _interrupt_event
1759   osthread()-&gt;set_interrupted(true);
1760 
1761   // For Thread.sleep
1762   _SleepEvent-&gt;unpark();
1763 
1764   // For JSR166 LockSupport.park
1765   parker()-&gt;unpark();
1766 
1767   // For ObjectMonitor and JvmtiRawMonitor
1768   _ParkEvent-&gt;unpark();
1769 }
1770 
1771 
1772 bool JavaThread::is_interrupted(bool clear_interrupted) {
1773   debug_only(check_for_dangling_thread_pointer(this);)
1774 
1775   if (threadObj() == NULL) {
1776     // If there is no j.l.Thread then it is impossible to have
1777     // been interrupted. We can find NULL during VM initialization
1778     // or when a JNI thread is still in the process of attaching.
1779     // In such cases this must be the current thread.
1780     assert(this == Thread::current(), &quot;invariant&quot;);
1781     return false;
1782   }
1783 
1784   bool interrupted = java_lang_Thread::interrupted(threadObj());
1785 
1786   // NOTE that since there is no &quot;lock&quot; around the interrupt and
1787   // is_interrupted operations, there is the possibility that the
1788   // interrupted flag will be &quot;false&quot; but that the
1789   // low-level events will be in the signaled state. This is
1790   // intentional. The effect of this is that Object.wait() and
1791   // LockSupport.park() will appear to have a spurious wakeup, which
1792   // is allowed and not harmful, and the possibility is so rare that
1793   // it is not worth the added complexity to add yet another lock.
1794   // For the sleep event an explicit reset is performed on entry
1795   // to JavaThread::sleep, so there is no early return. It has also been
1796   // recommended not to put the interrupted flag into the &quot;event&quot;
1797   // structure because it hides the issue.
1798   // Also, because there is no lock, we must only clear the interrupt
1799   // state if we are going to report that we were interrupted; otherwise
1800   // an interrupt that happens just after we read the field would be lost.
1801   if (interrupted &amp;&amp; clear_interrupted) {
1802     assert(this == Thread::current(), &quot;only the current thread can clear&quot;);
1803     java_lang_Thread::set_interrupted(threadObj(), false);
1804     osthread()-&gt;set_interrupted(false);
1805   }
1806 
1807   return interrupted;
1808 }
1809 
1810 bool JavaThread::reguard_stack(address cur_sp) {
1811   if (_stack_guard_state != stack_guard_yellow_reserved_disabled
1812       &amp;&amp; _stack_guard_state != stack_guard_reserved_disabled) {
1813     return true; // Stack already guarded or guard pages not needed.
1814   }
1815 
1816   if (register_stack_overflow()) {
1817     // For those architectures which have separate register and
1818     // memory stacks, we must check the register stack to see if
1819     // it has overflowed.
1820     return false;
1821   }
1822 
1823   // Java code never executes within the yellow zone: the latter is only
1824   // there to provoke an exception during stack banging.  If java code
1825   // is executing there, either StackShadowPages should be larger, or
1826   // some exception code in c1, c2 or the interpreter isn&#39;t unwinding
1827   // when it should.
1828   guarantee(cur_sp &gt; stack_reserved_zone_base(),
1829             &quot;not enough space to reguard - increase StackShadowPages&quot;);
1830   if (_stack_guard_state == stack_guard_yellow_reserved_disabled) {
1831     enable_stack_yellow_reserved_zone();
1832     if (reserved_stack_activation() != stack_base()) {
1833       set_reserved_stack_activation(stack_base());
1834     }
1835   } else if (_stack_guard_state == stack_guard_reserved_disabled) {
1836     set_reserved_stack_activation(stack_base());
1837     enable_stack_reserved_zone();
1838   }
1839   return true;
1840 }
1841 
1842 bool JavaThread::reguard_stack(void) {
1843   return reguard_stack(os::current_stack_pointer());
1844 }
1845 
1846 
1847 void JavaThread::block_if_vm_exited() {
1848   if (_terminated == _vm_exited) {
1849     // _vm_exited is set at safepoint, and Threads_lock is never released
1850     // we will block here forever.
1851     // Here we can be doing a jump from a safe state to an unsafe state without
1852     // proper transition, but it happens after the final safepoint has begun.
1853     set_thread_state(_thread_in_vm);
1854     Threads_lock-&gt;lock();
1855     ShouldNotReachHere();
1856   }
1857 }
1858 
1859 
1860 // Remove this ifdef when C1 is ported to the compiler interface.
1861 static void compiler_thread_entry(JavaThread* thread, TRAPS);
1862 static void sweeper_thread_entry(JavaThread* thread, TRAPS);
1863 
1864 JavaThread::JavaThread(ThreadFunction entry_point, size_t stack_sz) :
1865                        Thread() {
1866   initialize();
1867   _jni_attach_state = _not_attaching_via_jni;
1868   set_entry_point(entry_point);
1869   // Create the native thread itself.
1870   // %note runtime_23
1871   os::ThreadType thr_type = os::java_thread;
1872   thr_type = entry_point == &amp;compiler_thread_entry ? os::compiler_thread :
1873                                                      os::java_thread;
1874   os::create_thread(this, thr_type, stack_sz);
1875   // The _osthread may be NULL here because we ran out of memory (too many threads active).
1876   // We need to throw and OutOfMemoryError - however we cannot do this here because the caller
1877   // may hold a lock and all locks must be unlocked before throwing the exception (throwing
1878   // the exception consists of creating the exception object &amp; initializing it, initialization
1879   // will leave the VM via a JavaCall and then all locks must be unlocked).
1880   //
1881   // The thread is still suspended when we reach here. Thread must be explicit started
1882   // by creator! Furthermore, the thread must also explicitly be added to the Threads list
1883   // by calling Threads:add. The reason why this is not done here, is because the thread
1884   // object must be fully initialized (take a look at JVM_Start)
1885 }
1886 
1887 JavaThread::~JavaThread() {
1888 
1889   // JSR166 -- return the parker to the free list
1890   Parker::Release(_parker);
1891   _parker = NULL;
1892 
1893   // Return the sleep event to the free list
1894   ParkEvent::Release(_SleepEvent);
1895   _SleepEvent = NULL;
1896 
1897   // Free any remaining  previous UnrollBlock
1898   vframeArray* old_array = vframe_array_last();
1899 
1900   if (old_array != NULL) {
1901     Deoptimization::UnrollBlock* old_info = old_array-&gt;unroll_block();
1902     old_array-&gt;set_unroll_block(NULL);
1903     delete old_info;
1904     delete old_array;
1905   }
1906 
1907   GrowableArray&lt;jvmtiDeferredLocalVariableSet*&gt;* deferred = deferred_locals();
1908   if (deferred != NULL) {
1909     // This can only happen if thread is destroyed before deoptimization occurs.
1910     assert(deferred-&gt;length() != 0, &quot;empty array!&quot;);
1911     do {
1912       jvmtiDeferredLocalVariableSet* dlv = deferred-&gt;at(0);
1913       deferred-&gt;remove_at(0);
1914       // individual jvmtiDeferredLocalVariableSet are CHeapObj&#39;s
1915       delete dlv;
1916     } while (deferred-&gt;length() != 0);
1917     delete deferred;
1918   }
1919 
1920   // All Java related clean up happens in exit
1921   ThreadSafepointState::destroy(this);
1922   if (_thread_stat != NULL) delete _thread_stat;
1923 
1924 #if INCLUDE_JVMCI
1925   if (JVMCICounterSize &gt; 0) {
1926     if (jvmci_counters_include(this)) {
1927       for (int i = 0; i &lt; JVMCICounterSize; i++) {
1928         _jvmci_old_thread_counters[i] += _jvmci_counters[i];
1929       }
1930     }
1931     FREE_C_HEAP_ARRAY(jlong, _jvmci_counters);
1932   }
1933 #endif // INCLUDE_JVMCI
1934 }
1935 
1936 
1937 // First JavaThread specific code executed by a new Java thread.
1938 void JavaThread::pre_run() {
1939   // empty - see comments in run()
1940 }
1941 
1942 // The main routine called by a new Java thread. This isn&#39;t overridden
1943 // by subclasses, instead different subclasses define a different &quot;entry_point&quot;
1944 // which defines the actual logic for that kind of thread.
1945 void JavaThread::run() {
1946   // initialize thread-local alloc buffer related fields
1947   this-&gt;initialize_tlab();
1948 
1949   // Used to test validity of stack trace backs.
1950   // This can&#39;t be moved into pre_run() else we invalidate
1951   // the requirement that thread_main_inner is lower on
1952   // the stack. Consequently all the initialization logic
1953   // stays here in run() rather than pre_run().
1954   this-&gt;record_base_of_stack_pointer();
1955 
1956   this-&gt;create_stack_guard_pages();
1957 
1958   this-&gt;cache_global_variables();
1959 
1960   // Thread is now sufficiently initialized to be handled by the safepoint code as being
1961   // in the VM. Change thread state from _thread_new to _thread_in_vm
1962   ThreadStateTransition::transition(this, _thread_new, _thread_in_vm);
1963   // Before a thread is on the threads list it is always safe, so after leaving the
1964   // _thread_new we should emit a instruction barrier. The distance to modified code
1965   // from here is probably far enough, but this is consistent and safe.
1966   OrderAccess::cross_modify_fence();
1967 
1968   assert(JavaThread::current() == this, &quot;sanity check&quot;);
1969   assert(!Thread::current()-&gt;owns_locks(), &quot;sanity check&quot;);
1970 
1971   DTRACE_THREAD_PROBE(start, this);
1972 
1973   // This operation might block. We call that after all safepoint checks for a new thread has
1974   // been completed.
1975   this-&gt;set_active_handles(JNIHandleBlock::allocate_block());
1976 
1977   if (JvmtiExport::should_post_thread_life()) {
1978     JvmtiExport::post_thread_start(this);
1979 
1980   }
1981 
1982   // We call another function to do the rest so we are sure that the stack addresses used
1983   // from there will be lower than the stack base just computed.
1984   thread_main_inner();
1985 }
1986 
1987 void JavaThread::thread_main_inner() {
1988   assert(JavaThread::current() == this, &quot;sanity check&quot;);
1989   assert(this-&gt;threadObj() != NULL, &quot;just checking&quot;);
1990 
1991   // Execute thread entry point unless this thread has a pending exception
1992   // or has been stopped before starting.
1993   // Note: Due to JVM_StopThread we can have pending exceptions already!
1994   if (!this-&gt;has_pending_exception() &amp;&amp;
1995       !java_lang_Thread::is_stillborn(this-&gt;threadObj())) {
1996     {
1997       ResourceMark rm(this);
1998       this-&gt;set_native_thread_name(this-&gt;get_thread_name());
1999     }
2000     HandleMark hm(this);
2001     this-&gt;entry_point()(this, this);
2002   }
2003 
2004   DTRACE_THREAD_PROBE(stop, this);
2005 
2006   // Cleanup is handled in post_run()
2007 }
2008 
2009 // Shared teardown for all JavaThreads
2010 void JavaThread::post_run() {
2011   this-&gt;exit(false);
2012   // Defer deletion to here to ensure &#39;this&#39; is still referenceable in call_run
2013   // for any shared tear-down.
2014   this-&gt;smr_delete();
2015 }
2016 
2017 static void ensure_join(JavaThread* thread) {
2018   // We do not need to grab the Threads_lock, since we are operating on ourself.
2019   Handle threadObj(thread, thread-&gt;threadObj());
2020   assert(threadObj.not_null(), &quot;java thread object must exist&quot;);
2021   ObjectLocker lock(threadObj, thread);
2022   // Ignore pending exception (ThreadDeath), since we are exiting anyway
2023   thread-&gt;clear_pending_exception();
2024   // Thread is exiting. So set thread_status field in  java.lang.Thread class to TERMINATED.
2025   java_lang_Thread::set_thread_status(threadObj(), java_lang_Thread::TERMINATED);
2026   // Clear the native thread instance - this makes isAlive return false and allows the join()
2027   // to complete once we&#39;ve done the notify_all below
2028   java_lang_Thread::set_thread(threadObj(), NULL);
2029   lock.notify_all(thread);
2030   // Ignore pending exception (ThreadDeath), since we are exiting anyway
2031   thread-&gt;clear_pending_exception();
2032 }
2033 
2034 static bool is_daemon(oop threadObj) {
2035   return (threadObj != NULL &amp;&amp; java_lang_Thread::is_daemon(threadObj));
2036 }
2037 
2038 // For any new cleanup additions, please check to see if they need to be applied to
2039 // cleanup_failed_attach_current_thread as well.
2040 void JavaThread::exit(bool destroy_vm, ExitType exit_type) {
2041   assert(this == JavaThread::current(), &quot;thread consistency check&quot;);
2042 
2043   elapsedTimer _timer_exit_phase1;
2044   elapsedTimer _timer_exit_phase2;
2045   elapsedTimer _timer_exit_phase3;
2046   elapsedTimer _timer_exit_phase4;
2047 
2048   if (log_is_enabled(Debug, os, thread, timer)) {
2049     _timer_exit_phase1.start();
2050   }
2051 
2052   HandleMark hm(this);
2053   Handle uncaught_exception(this, this-&gt;pending_exception());
2054   this-&gt;clear_pending_exception();
2055   Handle threadObj(this, this-&gt;threadObj());
2056   assert(threadObj.not_null(), &quot;Java thread object should be created&quot;);
2057 
2058   // FIXIT: This code should be moved into else part, when reliable 1.2/1.3 check is in place
2059   {
2060     EXCEPTION_MARK;
2061 
2062     CLEAR_PENDING_EXCEPTION;
2063   }
2064   if (!destroy_vm) {
2065     if (uncaught_exception.not_null()) {
2066       EXCEPTION_MARK;
2067       // Call method Thread.dispatchUncaughtException().
2068       Klass* thread_klass = SystemDictionary::Thread_klass();
2069       JavaValue result(T_VOID);
2070       JavaCalls::call_virtual(&amp;result,
2071                               threadObj, thread_klass,
2072                               vmSymbols::dispatchUncaughtException_name(),
2073                               vmSymbols::throwable_void_signature(),
2074                               uncaught_exception,
2075                               THREAD);
2076       if (HAS_PENDING_EXCEPTION) {
2077         ResourceMark rm(this);
2078         jio_fprintf(defaultStream::error_stream(),
2079                     &quot;\nException: %s thrown from the UncaughtExceptionHandler&quot;
2080                     &quot; in thread \&quot;%s\&quot;\n&quot;,
2081                     pending_exception()-&gt;klass()-&gt;external_name(),
2082                     get_thread_name());
2083         CLEAR_PENDING_EXCEPTION;
2084       }
2085     }
2086     JFR_ONLY(Jfr::on_java_thread_dismantle(this);)
2087 
2088     // Call Thread.exit(). We try 3 times in case we got another Thread.stop during
2089     // the execution of the method. If that is not enough, then we don&#39;t really care. Thread.stop
2090     // is deprecated anyhow.
2091     if (!is_Compiler_thread()) {
2092       int count = 3;
2093       while (java_lang_Thread::threadGroup(threadObj()) != NULL &amp;&amp; (count-- &gt; 0)) {
2094         EXCEPTION_MARK;
2095         JavaValue result(T_VOID);
2096         Klass* thread_klass = SystemDictionary::Thread_klass();
2097         JavaCalls::call_virtual(&amp;result,
2098                                 threadObj, thread_klass,
2099                                 vmSymbols::exit_method_name(),
2100                                 vmSymbols::void_method_signature(),
2101                                 THREAD);
2102         CLEAR_PENDING_EXCEPTION;
2103       }
2104     }
2105     // notify JVMTI
2106     if (JvmtiExport::should_post_thread_life()) {
2107       JvmtiExport::post_thread_end(this);
2108     }
2109 
2110     // We have notified the agents that we are exiting, before we go on,
2111     // we must check for a pending external suspend request and honor it
2112     // in order to not surprise the thread that made the suspend request.
2113     while (true) {
2114       {
2115         MutexLocker ml(SR_lock(), Mutex::_no_safepoint_check_flag);
2116         if (!is_external_suspend()) {
2117           set_terminated(_thread_exiting);
2118           ThreadService::current_thread_exiting(this, is_daemon(threadObj()));
2119           break;
2120         }
2121         // Implied else:
2122         // Things get a little tricky here. We have a pending external
2123         // suspend request, but we are holding the SR_lock so we
2124         // can&#39;t just self-suspend. So we temporarily drop the lock
2125         // and then self-suspend.
2126       }
2127 
2128       ThreadBlockInVM tbivm(this);
2129       java_suspend_self();
2130 
2131       // We&#39;re done with this suspend request, but we have to loop around
2132       // and check again. Eventually we will get SR_lock without a pending
2133       // external suspend request and will be able to mark ourselves as
2134       // exiting.
2135     }
2136     // no more external suspends are allowed at this point
2137   } else {
2138     assert(!is_terminated() &amp;&amp; !is_exiting(), &quot;must not be exiting&quot;);
2139     // before_exit() has already posted JVMTI THREAD_END events
2140   }
2141 
2142   if (log_is_enabled(Debug, os, thread, timer)) {
2143     _timer_exit_phase1.stop();
2144     _timer_exit_phase2.start();
2145   }
2146 
2147   // Capture daemon status before the thread is marked as terminated.
2148   bool daemon = is_daemon(threadObj());
2149 
2150   // Notify waiters on thread object. This has to be done after exit() is called
2151   // on the thread (if the thread is the last thread in a daemon ThreadGroup the
2152   // group should have the destroyed bit set before waiters are notified).
2153   ensure_join(this);
2154   assert(!this-&gt;has_pending_exception(), &quot;ensure_join should have cleared&quot;);
2155 
2156   if (log_is_enabled(Debug, os, thread, timer)) {
2157     _timer_exit_phase2.stop();
2158     _timer_exit_phase3.start();
2159   }
2160   // 6282335 JNI DetachCurrentThread spec states that all Java monitors
2161   // held by this thread must be released. The spec does not distinguish
2162   // between JNI-acquired and regular Java monitors. We can only see
2163   // regular Java monitors here if monitor enter-exit matching is broken.
2164   //
2165   // ensure_join() ignores IllegalThreadStateExceptions, and so does
2166   // ObjectSynchronizer::release_monitors_owned_by_thread().
2167   if (exit_type == jni_detach) {
2168     // Sanity check even though JNI DetachCurrentThread() would have
2169     // returned JNI_ERR if there was a Java frame. JavaThread exit
2170     // should be done executing Java code by the time we get here.
2171     assert(!this-&gt;has_last_Java_frame(),
2172            &quot;should not have a Java frame when detaching or exiting&quot;);
2173     ObjectSynchronizer::release_monitors_owned_by_thread(this);
2174     assert(!this-&gt;has_pending_exception(), &quot;release_monitors should have cleared&quot;);
2175   }
2176 
2177   // These things needs to be done while we are still a Java Thread. Make sure that thread
2178   // is in a consistent state, in case GC happens
2179   JFR_ONLY(Jfr::on_thread_exit(this);)
2180 
2181   if (active_handles() != NULL) {
2182     JNIHandleBlock* block = active_handles();
2183     set_active_handles(NULL);
2184     JNIHandleBlock::release_block(block);
2185   }
2186 
2187   if (free_handle_block() != NULL) {
2188     JNIHandleBlock* block = free_handle_block();
2189     set_free_handle_block(NULL);
2190     JNIHandleBlock::release_block(block);
2191   }
2192 
2193   // These have to be removed while this is still a valid thread.
2194   remove_stack_guard_pages();
2195 
2196   if (UseTLAB) {
2197     tlab().retire();
2198   }
2199 
2200   if (JvmtiEnv::environments_might_exist()) {
2201     JvmtiExport::cleanup_thread(this);
2202   }
2203 
2204   // We must flush any deferred card marks and other various GC barrier
2205   // related buffers (e.g. G1 SATB buffer and G1 dirty card queue buffer)
2206   // before removing a thread from the list of active threads.
2207   BarrierSet::barrier_set()-&gt;on_thread_detach(this);
2208 
2209   log_info(os, thread)(&quot;JavaThread %s (tid: &quot; UINTX_FORMAT &quot;).&quot;,
2210     exit_type == JavaThread::normal_exit ? &quot;exiting&quot; : &quot;detaching&quot;,
2211     os::current_thread_id());
2212 
2213   if (log_is_enabled(Debug, os, thread, timer)) {
2214     _timer_exit_phase3.stop();
2215     _timer_exit_phase4.start();
2216   }
2217   // Remove from list of active threads list, and notify VM thread if we are the last non-daemon thread
2218   Threads::remove(this, daemon);
2219 
2220   if (log_is_enabled(Debug, os, thread, timer)) {
2221     _timer_exit_phase4.stop();
2222     ResourceMark rm(this);
2223     log_debug(os, thread, timer)(&quot;name=&#39;%s&#39;&quot;
2224                                  &quot;, exit-phase1=&quot; JLONG_FORMAT
2225                                  &quot;, exit-phase2=&quot; JLONG_FORMAT
2226                                  &quot;, exit-phase3=&quot; JLONG_FORMAT
2227                                  &quot;, exit-phase4=&quot; JLONG_FORMAT,
2228                                  get_thread_name(),
2229                                  _timer_exit_phase1.milliseconds(),
2230                                  _timer_exit_phase2.milliseconds(),
2231                                  _timer_exit_phase3.milliseconds(),
2232                                  _timer_exit_phase4.milliseconds());
2233   }
2234 }
2235 
2236 void JavaThread::cleanup_failed_attach_current_thread(bool is_daemon) {
2237   if (active_handles() != NULL) {
2238     JNIHandleBlock* block = active_handles();
2239     set_active_handles(NULL);
2240     JNIHandleBlock::release_block(block);
2241   }
2242 
2243   if (free_handle_block() != NULL) {
2244     JNIHandleBlock* block = free_handle_block();
2245     set_free_handle_block(NULL);
2246     JNIHandleBlock::release_block(block);
2247   }
2248 
2249   // These have to be removed while this is still a valid thread.
2250   remove_stack_guard_pages();
2251 
2252   if (UseTLAB) {
2253     tlab().retire();
2254   }
2255 
2256   BarrierSet::barrier_set()-&gt;on_thread_detach(this);
2257 
2258   Threads::remove(this, is_daemon);
2259   this-&gt;smr_delete();
2260 }
2261 
2262 JavaThread* JavaThread::active() {
2263   Thread* thread = Thread::current();
2264   if (thread-&gt;is_Java_thread()) {
2265     return (JavaThread*) thread;
2266   } else {
2267     assert(thread-&gt;is_VM_thread(), &quot;this must be a vm thread&quot;);
2268     VM_Operation* op = ((VMThread*) thread)-&gt;vm_operation();
2269     JavaThread *ret=op == NULL ? NULL : (JavaThread *)op-&gt;calling_thread();
2270     assert(ret-&gt;is_Java_thread(), &quot;must be a Java thread&quot;);
2271     return ret;
2272   }
2273 }
2274 
2275 bool JavaThread::is_lock_owned(address adr) const {
2276   if (Thread::is_lock_owned(adr)) return true;
2277 
2278   for (MonitorChunk* chunk = monitor_chunks(); chunk != NULL; chunk = chunk-&gt;next()) {
2279     if (chunk-&gt;contains(adr)) return true;
2280   }
2281 
2282   return false;
2283 }
2284 
2285 
2286 void JavaThread::add_monitor_chunk(MonitorChunk* chunk) {
2287   chunk-&gt;set_next(monitor_chunks());
2288   set_monitor_chunks(chunk);
2289 }
2290 
2291 void JavaThread::remove_monitor_chunk(MonitorChunk* chunk) {
2292   guarantee(monitor_chunks() != NULL, &quot;must be non empty&quot;);
2293   if (monitor_chunks() == chunk) {
2294     set_monitor_chunks(chunk-&gt;next());
2295   } else {
2296     MonitorChunk* prev = monitor_chunks();
2297     while (prev-&gt;next() != chunk) prev = prev-&gt;next();
2298     prev-&gt;set_next(chunk-&gt;next());
2299   }
2300 }
2301 
2302 // JVM support.
2303 
2304 // Note: this function shouldn&#39;t block if it&#39;s called in
2305 // _thread_in_native_trans state (such as from
2306 // check_special_condition_for_native_trans()).
2307 void JavaThread::check_and_handle_async_exceptions(bool check_unsafe_error) {
2308 
2309   if (has_last_Java_frame() &amp;&amp; has_async_condition()) {
2310     // If we are at a polling page safepoint (not a poll return)
2311     // then we must defer async exception because live registers
2312     // will be clobbered by the exception path. Poll return is
2313     // ok because the call we a returning from already collides
2314     // with exception handling registers and so there is no issue.
2315     // (The exception handling path kills call result registers but
2316     //  this is ok since the exception kills the result anyway).
2317 
2318     if (is_at_poll_safepoint()) {
2319       // if the code we are returning to has deoptimized we must defer
2320       // the exception otherwise live registers get clobbered on the
2321       // exception path before deoptimization is able to retrieve them.
2322       //
2323       RegisterMap map(this, false);
2324       frame caller_fr = last_frame().sender(&amp;map);
2325       assert(caller_fr.is_compiled_frame(), &quot;what?&quot;);
2326       if (caller_fr.is_deoptimized_frame()) {
2327         log_info(exceptions)(&quot;deferred async exception at compiled safepoint&quot;);
2328         return;
2329       }
2330     }
2331   }
2332 
2333   JavaThread::AsyncRequests condition = clear_special_runtime_exit_condition();
2334   if (condition == _no_async_condition) {
2335     // Conditions have changed since has_special_runtime_exit_condition()
2336     // was called:
2337     // - if we were here only because of an external suspend request,
2338     //   then that was taken care of above (or cancelled) so we are done
2339     // - if we were here because of another async request, then it has
2340     //   been cleared between the has_special_runtime_exit_condition()
2341     //   and now so again we are done
2342     return;
2343   }
2344 
2345   // Check for pending async. exception
2346   if (_pending_async_exception != NULL) {
2347     // Only overwrite an already pending exception, if it is not a threadDeath.
2348     if (!has_pending_exception() || !pending_exception()-&gt;is_a(SystemDictionary::ThreadDeath_klass())) {
2349 
2350       // We cannot call Exceptions::_throw(...) here because we cannot block
2351       set_pending_exception(_pending_async_exception, __FILE__, __LINE__);
2352 
2353       LogTarget(Info, exceptions) lt;
2354       if (lt.is_enabled()) {
2355         ResourceMark rm;
2356         LogStream ls(lt);
2357         ls.print(&quot;Async. exception installed at runtime exit (&quot; INTPTR_FORMAT &quot;)&quot;, p2i(this));
2358           if (has_last_Java_frame()) {
2359             frame f = last_frame();
2360            ls.print(&quot; (pc: &quot; INTPTR_FORMAT &quot; sp: &quot; INTPTR_FORMAT &quot; )&quot;, p2i(f.pc()), p2i(f.sp()));
2361           }
2362         ls.print_cr(&quot; of type: %s&quot;, _pending_async_exception-&gt;klass()-&gt;external_name());
2363       }
2364       _pending_async_exception = NULL;
2365       clear_has_async_exception();
2366     }
2367   }
2368 
2369   if (check_unsafe_error &amp;&amp;
2370       condition == _async_unsafe_access_error &amp;&amp; !has_pending_exception()) {
2371     condition = _no_async_condition;  // done
2372     switch (thread_state()) {
2373     case _thread_in_vm: {
2374       JavaThread* THREAD = this;
2375       THROW_MSG(vmSymbols::java_lang_InternalError(), &quot;a fault occurred in an unsafe memory access operation&quot;);
2376     }
2377     case _thread_in_native: {
2378       ThreadInVMfromNative tiv(this);
2379       JavaThread* THREAD = this;
2380       THROW_MSG(vmSymbols::java_lang_InternalError(), &quot;a fault occurred in an unsafe memory access operation&quot;);
2381     }
2382     case _thread_in_Java: {
2383       ThreadInVMfromJava tiv(this);
2384       JavaThread* THREAD = this;
2385       THROW_MSG(vmSymbols::java_lang_InternalError(), &quot;a fault occurred in a recent unsafe memory access operation in compiled Java code&quot;);
2386     }
2387     default:
2388       ShouldNotReachHere();
2389     }
2390   }
2391 
2392   assert(condition == _no_async_condition || has_pending_exception() ||
2393          (!check_unsafe_error &amp;&amp; condition == _async_unsafe_access_error),
2394          &quot;must have handled the async condition, if no exception&quot;);
2395 }
2396 
2397 void JavaThread::handle_special_runtime_exit_condition(bool check_asyncs) {
2398 
2399   // Check for pending external suspend.
2400   if (is_external_suspend_with_lock()) {
2401     frame_anchor()-&gt;make_walkable(this);
2402     java_suspend_self_with_safepoint_check();
2403   }
2404 
2405   // We might be here for reasons in addition to the self-suspend request
2406   // so check for other async requests.
2407   if (check_asyncs) {
2408     check_and_handle_async_exceptions();
2409   }
2410 
2411   if (is_cont_force_yield()) {
2412     log_develop_trace(jvmcont)(&quot;handle_special_runtime_exit_condition is_cont_force_yield: %d check_asyncs: %d&quot;, is_cont_force_yield(), check_asyncs);
2413     if (check_asyncs) { // TODO: we should probably be even more selective than that
2414       // we need this only for interpreted frames -- for compiled frames we install a return barrier on the safepoint stub in Continuation::try_force_yield
2415       StubRoutines::cont_jump_from_sp_C()();
2416     }
2417   }
2418 
2419   JFR_ONLY(SUSPEND_THREAD_CONDITIONAL(this);)
2420 }
2421 
2422 void JavaThread::send_thread_stop(oop java_throwable)  {
2423   ResourceMark rm;
2424   assert(Thread::current()-&gt;is_VM_thread() || Thread::current() == this, &quot;should be in the vm thread&quot;);
2425 
2426   // Do not throw asynchronous exceptions against the compiler thread
2427   // (the compiler thread should not be a Java thread -- fix in 1.4.2)
2428   if (!can_call_java()) return;
2429 
2430   {
2431     // Actually throw the Throwable against the target Thread - however
2432     // only if there is no thread death exception installed already.
2433     if (_pending_async_exception == NULL || !_pending_async_exception-&gt;is_a(SystemDictionary::ThreadDeath_klass())) {
2434       // If the topmost frame is a runtime stub, then we are calling into
2435       // OptoRuntime from compiled code. Some runtime stubs (new, monitor_exit..)
2436       // must deoptimize the caller before continuing, as the compiled  exception handler table
2437       // may not be valid
2438       if (has_last_Java_frame()) {
2439         frame f = last_frame();
2440         if (f.is_runtime_frame() || f.is_safepoint_blob_frame()) {
2441           // BiasedLocking needs an updated RegisterMap for the revoke monitors pass
2442           RegisterMap reg_map(this, UseBiasedLocking);
2443           frame compiled_frame = f.sender(&amp;reg_map);
2444           if (!StressCompiledExceptionHandlers &amp;&amp; compiled_frame.can_be_deoptimized()) {
2445             Deoptimization::deoptimize(this, compiled_frame, &amp;reg_map);
2446           }
2447         }
2448       }
2449 
2450       // Set async. pending exception in thread.
2451       set_pending_async_exception(java_throwable);
2452 
2453       if (log_is_enabled(Info, exceptions)) {
2454          ResourceMark rm;
2455         log_info(exceptions)(&quot;Pending Async. exception installed of type: %s&quot;,
2456                              InstanceKlass::cast(_pending_async_exception-&gt;klass())-&gt;external_name());
2457       }
2458       // for AbortVMOnException flag
2459       Exceptions::debug_check_abort(_pending_async_exception-&gt;klass()-&gt;external_name());
2460     }
2461   }
2462 
2463 
2464   // Interrupt thread so it will wake up from a potential wait()/sleep()/park()
2465   java_lang_Thread::set_interrupted(threadObj(), true);
2466   this-&gt;interrupt();
2467 }
2468 
2469 // External suspension mechanism.
2470 //
2471 // Tell the VM to suspend a thread when ever it knows that it does not hold on
2472 // to any VM_locks and it is at a transition
2473 // Self-suspension will happen on the transition out of the vm.
2474 // Catch &quot;this&quot; coming in from JNIEnv pointers when the thread has been freed
2475 //
2476 // Guarantees on return:
2477 //   + Target thread will not execute any new bytecode (that&#39;s why we need to
2478 //     force a safepoint)
2479 //   + Target thread will not enter any new monitors
2480 //
2481 void JavaThread::java_suspend() {
2482   ThreadsListHandle tlh;
2483   if (!tlh.includes(this) || threadObj() == NULL || is_exiting()) {
2484     return;
2485   }
2486 
2487   { MutexLocker ml(SR_lock(), Mutex::_no_safepoint_check_flag);
2488     if (!is_external_suspend()) {
2489       // a racing resume has cancelled us; bail out now
2490       return;
2491     }
2492 
2493     // suspend is done
2494     uint32_t debug_bits = 0;
2495     // Warning: is_ext_suspend_completed() may temporarily drop the
2496     // SR_lock to allow the thread to reach a stable thread state if
2497     // it is currently in a transient thread state.
2498     if (is_ext_suspend_completed(false /* !called_by_wait */,
2499                                  SuspendRetryDelay, &amp;debug_bits)) {
2500       return;
2501     }
2502   }
2503 
2504   if (Thread::current() == this) {
2505     // Safely self-suspend.
2506     // If we don&#39;t do this explicitly it will implicitly happen
2507     // before we transition back to Java, and on some other thread-state
2508     // transition paths, but not as we exit a JVM TI SuspendThread call.
2509     // As SuspendThread(current) must not return (until resumed) we must
2510     // self-suspend here.
2511     ThreadBlockInVM tbivm(this);
2512     java_suspend_self();
2513   } else {
2514     VM_ThreadSuspend vm_suspend;
2515     VMThread::execute(&amp;vm_suspend);
2516   }
2517 }
2518 
2519 // Part II of external suspension.
2520 // A JavaThread self suspends when it detects a pending external suspend
2521 // request. This is usually on transitions. It is also done in places
2522 // where continuing to the next transition would surprise the caller,
2523 // e.g., monitor entry.
2524 //
2525 // Returns the number of times that the thread self-suspended.
2526 //
2527 // Note: DO NOT call java_suspend_self() when you just want to block current
2528 //       thread. java_suspend_self() is the second stage of cooperative
2529 //       suspension for external suspend requests and should only be used
2530 //       to complete an external suspend request.
2531 //
2532 int JavaThread::java_suspend_self() {
2533   assert(thread_state() == _thread_blocked, &quot;wrong state for java_suspend_self()&quot;);
2534   int ret = 0;
2535 
2536   // we are in the process of exiting so don&#39;t suspend
2537   if (is_exiting()) {
2538     clear_external_suspend();
2539     return ret;
2540   }
2541 
2542   assert(_anchor.walkable() ||
2543          (is_Java_thread() &amp;&amp; !((JavaThread*)this)-&gt;has_last_Java_frame()),
2544          &quot;must have walkable stack&quot;);
2545 
2546   MonitorLocker ml(SR_lock(), Mutex::_no_safepoint_check_flag);
2547 
2548   assert(!this-&gt;is_ext_suspended(),
2549          &quot;a thread trying to self-suspend should not already be suspended&quot;);
2550 
2551   if (this-&gt;is_suspend_equivalent()) {
2552     // If we are self-suspending as a result of the lifting of a
2553     // suspend equivalent condition, then the suspend_equivalent
2554     // flag is not cleared until we set the ext_suspended flag so
2555     // that wait_for_ext_suspend_completion() returns consistent
2556     // results.
2557     this-&gt;clear_suspend_equivalent();
2558   }
2559 
2560   // A racing resume may have cancelled us before we grabbed SR_lock
2561   // above. Or another external suspend request could be waiting for us
2562   // by the time we return from SR_lock()-&gt;wait(). The thread
2563   // that requested the suspension may already be trying to walk our
2564   // stack and if we return now, we can change the stack out from under
2565   // it. This would be a &quot;bad thing (TM)&quot; and cause the stack walker
2566   // to crash. We stay self-suspended until there are no more pending
2567   // external suspend requests.
2568   while (is_external_suspend()) {
2569     ret++;
2570     this-&gt;set_ext_suspended();
2571 
2572     // _ext_suspended flag is cleared by java_resume()
2573     while (is_ext_suspended()) {
2574       ml.wait();
2575     }
2576   }
2577   return ret;
2578 }
2579 
2580 // Helper routine to set up the correct thread state before calling java_suspend_self.
2581 // This is called when regular thread-state transition helpers can&#39;t be used because
2582 // we can be in various states, in particular _thread_in_native_trans.
2583 // Because this thread is external suspended the safepoint code will count it as at
2584 // a safepoint, regardless of what its actual current thread-state is. But
2585 // is_ext_suspend_completed() may be waiting to see a thread transition from
2586 // _thread_in_native_trans to _thread_blocked. So we set the thread state directly
2587 // to _thread_blocked. The problem with setting thread state directly is that a
2588 // safepoint could happen just after java_suspend_self() returns after being resumed,
2589 // and the VM thread will see the _thread_blocked state. So we must check for a safepoint
2590 // after restoring the state to make sure we won&#39;t leave while a safepoint is in progress.
2591 // However, not all initial-states are allowed when performing a safepoint check, as we
2592 // should never be blocking at a safepoint whilst in those states. Of these &#39;bad&#39; states
2593 // only _thread_in_native is possible when executing this code (based on our two callers).
2594 // A thread that is _thread_in_native is already safepoint-safe and so it doesn&#39;t matter
2595 // whether the VMThread sees the _thread_blocked state, or the _thread_in_native state,
2596 // and so we don&#39;t need the explicit safepoint check.
2597 
2598 void JavaThread::java_suspend_self_with_safepoint_check() {
2599   assert(this == Thread::current(), &quot;invariant&quot;);
2600   JavaThreadState state = thread_state();
2601   set_thread_state(_thread_blocked);
2602   java_suspend_self();
2603   set_thread_state_fence(state);
2604   // Since we are not using a regular thread-state transition helper here,
2605   // we must manually emit the instruction barrier after leaving a safe state.
2606   OrderAccess::cross_modify_fence();
2607   if (state != _thread_in_native) {
2608     SafepointMechanism::block_if_requested(this);
2609   }
2610 }
2611 
2612 #ifdef ASSERT
2613 // Verify the JavaThread has not yet been published in the Threads::list, and
2614 // hence doesn&#39;t need protection from concurrent access at this stage.
2615 void JavaThread::verify_not_published() {
2616   // Cannot create a ThreadsListHandle here and check !tlh.includes(this)
2617   // since an unpublished JavaThread doesn&#39;t participate in the
2618   // Thread-SMR protocol for keeping a ThreadsList alive.
2619   assert(!on_thread_list(), &quot;JavaThread shouldn&#39;t have been published yet!&quot;);
2620 }
2621 #endif
2622 
2623 // Slow path when the native==&gt;VM/Java barriers detect a safepoint is in
2624 // progress or when _suspend_flags is non-zero.
2625 // Current thread needs to self-suspend if there is a suspend request and/or
2626 // block if a safepoint is in progress.
2627 // Async exception ISN&#39;T checked.
2628 // Note only the ThreadInVMfromNative transition can call this function
2629 // directly and when thread state is _thread_in_native_trans
2630 void JavaThread::check_safepoint_and_suspend_for_native_trans(JavaThread *thread) {
2631   assert(thread-&gt;thread_state() == _thread_in_native_trans, &quot;wrong state&quot;);
2632 
2633   assert(!thread-&gt;has_last_Java_frame() || thread-&gt;frame_anchor()-&gt;walkable(), &quot;Unwalkable stack in native-&gt;vm transition&quot;);
2634 
2635   if (thread-&gt;is_external_suspend()) {
2636     thread-&gt;java_suspend_self_with_safepoint_check();
2637   } else {
2638     SafepointMechanism::block_if_requested(thread);
2639   }
2640 
2641   JFR_ONLY(SUSPEND_THREAD_CONDITIONAL(thread);)
2642 }
2643 
2644 // Slow path when the native==&gt;VM/Java barriers detect a safepoint is in
2645 // progress or when _suspend_flags is non-zero.
2646 // Current thread needs to self-suspend if there is a suspend request and/or
2647 // block if a safepoint is in progress.
2648 // Also check for pending async exception (not including unsafe access error).
2649 // Note only the native==&gt;VM/Java barriers can call this function and when
2650 // thread state is _thread_in_native_trans.
2651 void JavaThread::check_special_condition_for_native_trans(JavaThread *thread) {
2652   check_safepoint_and_suspend_for_native_trans(thread);
2653 
2654   if (thread-&gt;has_async_exception()) {
2655     // We are in _thread_in_native_trans state, don&#39;t handle unsafe
2656     // access error since that may block.
2657     thread-&gt;check_and_handle_async_exceptions(false);
2658   }
2659 }
2660 
2661 // This is a variant of the normal
2662 // check_special_condition_for_native_trans with slightly different
2663 // semantics for use by critical native wrappers.  It does all the
2664 // normal checks but also performs the transition back into
2665 // thread_in_Java state.  This is required so that critical natives
2666 // can potentially block and perform a GC if they are the last thread
2667 // exiting the GCLocker.
2668 void JavaThread::check_special_condition_for_native_trans_and_transition(JavaThread *thread) {
2669   check_special_condition_for_native_trans(thread);
2670 
2671   // Finish the transition
2672   thread-&gt;set_thread_state(_thread_in_Java);
2673 
2674   if (thread-&gt;do_critical_native_unlock()) {
2675     ThreadInVMfromJavaNoAsyncException tiv(thread);
2676     GCLocker::unlock_critical(thread);
2677     thread-&gt;clear_critical_native_unlock();
2678   }
2679 }
2680 
2681 // We need to guarantee the Threads_lock here, since resumes are not
2682 // allowed during safepoint synchronization
2683 // Can only resume from an external suspension
2684 void JavaThread::java_resume() {
2685   assert_locked_or_safepoint(Threads_lock);
2686 
2687   // Sanity check: thread is gone, has started exiting or the thread
2688   // was not externally suspended.
2689   ThreadsListHandle tlh;
2690   if (!tlh.includes(this) || is_exiting() || !is_external_suspend()) {
2691     return;
2692   }
2693 
2694   MutexLocker ml(SR_lock(), Mutex::_no_safepoint_check_flag);
2695 
2696   clear_external_suspend();
2697 
2698   if (is_ext_suspended()) {
2699     clear_ext_suspended();
2700     SR_lock()-&gt;notify_all();
2701   }
2702 }
2703 
2704 size_t JavaThread::_stack_red_zone_size = 0;
2705 size_t JavaThread::_stack_yellow_zone_size = 0;
2706 size_t JavaThread::_stack_reserved_zone_size = 0;
2707 size_t JavaThread::_stack_shadow_zone_size = 0;
2708 
2709 void JavaThread::create_stack_guard_pages() {
2710   if (!os::uses_stack_guard_pages() ||
2711       _stack_guard_state != stack_guard_unused ||
2712       (DisablePrimordialThreadGuardPages &amp;&amp; os::is_primordial_thread())) {
2713       log_info(os, thread)(&quot;Stack guard page creation for thread &quot;
2714                            UINTX_FORMAT &quot; disabled&quot;, os::current_thread_id());
2715     return;
2716   }
2717   address low_addr = stack_end();
2718   size_t len = stack_guard_zone_size();
2719 
2720   assert(is_aligned(low_addr, os::vm_page_size()), &quot;Stack base should be the start of a page&quot;);
2721   assert(is_aligned(len, os::vm_page_size()), &quot;Stack size should be a multiple of page size&quot;);
2722 
2723   int must_commit = os::must_commit_stack_guard_pages();
2724   // warning(&quot;Guarding at &quot; PTR_FORMAT &quot; for len &quot; SIZE_FORMAT &quot;\n&quot;, low_addr, len);
2725 
2726   if (must_commit &amp;&amp; !os::create_stack_guard_pages((char *) low_addr, len)) {
2727     log_warning(os, thread)(&quot;Attempt to allocate stack guard pages failed.&quot;);
2728     return;
2729   }
2730 
2731   if (os::guard_memory((char *) low_addr, len)) {
2732     _stack_guard_state = stack_guard_enabled;
2733   } else {
2734     log_warning(os, thread)(&quot;Attempt to protect stack guard pages failed (&quot;
2735       PTR_FORMAT &quot;-&quot; PTR_FORMAT &quot;).&quot;, p2i(low_addr), p2i(low_addr + len));
2736     if (os::uncommit_memory((char *) low_addr, len)) {
2737       log_warning(os, thread)(&quot;Attempt to deallocate stack guard pages failed.&quot;);
2738     }
2739     return;
2740   }
2741 
2742   log_debug(os, thread)(&quot;Thread &quot; UINTX_FORMAT &quot; stack guard pages activated: &quot;
2743     PTR_FORMAT &quot;-&quot; PTR_FORMAT &quot;.&quot;,
2744     os::current_thread_id(), p2i(low_addr), p2i(low_addr + len));
2745 }
2746 
2747 void JavaThread::remove_stack_guard_pages() {
2748   assert(Thread::current() == this, &quot;from different thread&quot;);
2749   if (_stack_guard_state == stack_guard_unused) return;
2750   address low_addr = stack_end();
2751   size_t len = stack_guard_zone_size();
2752 
2753   if (os::must_commit_stack_guard_pages()) {
2754     if (os::remove_stack_guard_pages((char *) low_addr, len)) {
2755       _stack_guard_state = stack_guard_unused;
2756     } else {
2757       log_warning(os, thread)(&quot;Attempt to deallocate stack guard pages failed (&quot;
2758         PTR_FORMAT &quot;-&quot; PTR_FORMAT &quot;).&quot;, p2i(low_addr), p2i(low_addr + len));
2759       return;
2760     }
2761   } else {
2762     if (_stack_guard_state == stack_guard_unused) return;
2763     if (os::unguard_memory((char *) low_addr, len)) {
2764       _stack_guard_state = stack_guard_unused;
2765     } else {
2766       log_warning(os, thread)(&quot;Attempt to unprotect stack guard pages failed (&quot;
2767         PTR_FORMAT &quot;-&quot; PTR_FORMAT &quot;).&quot;, p2i(low_addr), p2i(low_addr + len));
2768       return;
2769     }
2770   }
2771 
2772   log_debug(os, thread)(&quot;Thread &quot; UINTX_FORMAT &quot; stack guard pages removed: &quot;
2773     PTR_FORMAT &quot;-&quot; PTR_FORMAT &quot;.&quot;,
2774     os::current_thread_id(), p2i(low_addr), p2i(low_addr + len));
2775 }
2776 
2777 void JavaThread::enable_stack_reserved_zone() {
2778   assert(_stack_guard_state == stack_guard_reserved_disabled, &quot;inconsistent state&quot;);
2779 
2780   // The base notation is from the stack&#39;s point of view, growing downward.
2781   // We need to adjust it to work correctly with guard_memory()
2782   address base = stack_reserved_zone_base() - stack_reserved_zone_size();
2783 
2784   guarantee(base &lt; stack_base(),&quot;Error calculating stack reserved zone&quot;);
2785   guarantee(base &lt; os::current_stack_pointer(),&quot;Error calculating stack reserved zone&quot;);
2786 
2787   if (os::guard_memory((char *) base, stack_reserved_zone_size())) {
2788     _stack_guard_state = stack_guard_enabled;
2789   } else {
2790     warning(&quot;Attempt to guard stack reserved zone failed.&quot;);
2791   }
2792   enable_register_stack_guard();
2793 }
2794 
2795 void JavaThread::disable_stack_reserved_zone() {
2796   assert(_stack_guard_state == stack_guard_enabled, &quot;inconsistent state&quot;);
2797 
2798   // Simply return if called for a thread that does not use guard pages.
2799   if (_stack_guard_state != stack_guard_enabled) return;
2800 
2801   // The base notation is from the stack&#39;s point of view, growing downward.
2802   // We need to adjust it to work correctly with guard_memory()
2803   address base = stack_reserved_zone_base() - stack_reserved_zone_size();
2804 
2805   if (os::unguard_memory((char *)base, stack_reserved_zone_size())) {
2806     _stack_guard_state = stack_guard_reserved_disabled;
2807   } else {
2808     warning(&quot;Attempt to unguard stack reserved zone failed.&quot;);
2809   }
2810   disable_register_stack_guard();
2811 }
2812 
2813 void JavaThread::enable_stack_yellow_reserved_zone() {
2814   assert(_stack_guard_state != stack_guard_unused, &quot;must be using guard pages.&quot;);
2815   assert(_stack_guard_state != stack_guard_enabled, &quot;already enabled&quot;);
2816 
2817   // The base notation is from the stacks point of view, growing downward.
2818   // We need to adjust it to work correctly with guard_memory()
2819   address base = stack_red_zone_base();
2820 
2821   guarantee(base &lt; stack_base(), &quot;Error calculating stack yellow zone&quot;);
2822   guarantee(base &lt; os::current_stack_pointer(), &quot;Error calculating stack yellow zone&quot;);
2823 
2824   if (os::guard_memory((char *) base, stack_yellow_reserved_zone_size())) {
2825     _stack_guard_state = stack_guard_enabled;
2826   } else {
2827     warning(&quot;Attempt to guard stack yellow zone failed.&quot;);
2828   }
2829   enable_register_stack_guard();
2830 }
2831 
2832 void JavaThread::disable_stack_yellow_reserved_zone() {
2833   assert(_stack_guard_state != stack_guard_unused, &quot;must be using guard pages.&quot;);
2834   assert(_stack_guard_state != stack_guard_yellow_reserved_disabled, &quot;already disabled&quot;);
2835 
2836   // Simply return if called for a thread that does not use guard pages.
2837   if (_stack_guard_state == stack_guard_unused) return;
2838 
2839   // The base notation is from the stacks point of view, growing downward.
2840   // We need to adjust it to work correctly with guard_memory()
2841   address base = stack_red_zone_base();
2842 
2843   if (os::unguard_memory((char *)base, stack_yellow_reserved_zone_size())) {
2844     _stack_guard_state = stack_guard_yellow_reserved_disabled;
2845   } else {
2846     warning(&quot;Attempt to unguard stack yellow zone failed.&quot;);
2847   }
2848   disable_register_stack_guard();
2849 }
2850 
2851 void JavaThread::enable_stack_red_zone() {
2852   // The base notation is from the stacks point of view, growing downward.
2853   // We need to adjust it to work correctly with guard_memory()
2854   assert(_stack_guard_state != stack_guard_unused, &quot;must be using guard pages.&quot;);
2855   address base = stack_red_zone_base() - stack_red_zone_size();
2856 
2857   guarantee(base &lt; stack_base(), &quot;Error calculating stack red zone&quot;);
2858   guarantee(base &lt; os::current_stack_pointer(), &quot;Error calculating stack red zone&quot;);
2859 
2860   if (!os::guard_memory((char *) base, stack_red_zone_size())) {
2861     warning(&quot;Attempt to guard stack red zone failed.&quot;);
2862   }
2863 }
2864 
2865 void JavaThread::disable_stack_red_zone() {
2866   // The base notation is from the stacks point of view, growing downward.
2867   // We need to adjust it to work correctly with guard_memory()
2868   assert(_stack_guard_state != stack_guard_unused, &quot;must be using guard pages.&quot;);
2869   address base = stack_red_zone_base() - stack_red_zone_size();
2870   if (!os::unguard_memory((char *)base, stack_red_zone_size())) {
2871     warning(&quot;Attempt to unguard stack red zone failed.&quot;);
2872   }
2873 }
2874 
2875 void JavaThread::frames_do(void f(frame*, const RegisterMap* map)) {
2876   // ignore is there is no stack
2877   if (!has_last_Java_frame()) return;
2878   // traverse the stack frames. Starts from top frame.
2879   for (StackFrameStream fst(this); !fst.is_done(); fst.next()) {
2880     frame* fr = fst.current();
2881     f(fr, fst.register_map());
2882   }
2883 }
2884 
2885 
2886 #ifndef PRODUCT
2887 // Deoptimization
2888 // Function for testing deoptimization
2889 void JavaThread::deoptimize() {
2890   // BiasedLocking needs an updated RegisterMap for the revoke monitors pass
2891   StackFrameStream fst(this, UseBiasedLocking);
2892   bool deopt = false;           // Dump stack only if a deopt actually happens.
2893   bool only_at = strlen(DeoptimizeOnlyAt) &gt; 0;
2894   // Iterate over all frames in the thread and deoptimize
2895   for (; !fst.is_done(); fst.next()) {
2896     if (fst.current()-&gt;can_be_deoptimized()) {
2897 
2898       if (only_at) {
2899         // Deoptimize only at particular bcis.  DeoptimizeOnlyAt
2900         // consists of comma or carriage return separated numbers so
2901         // search for the current bci in that string.
2902         address pc = fst.current()-&gt;pc();
2903         nmethod* nm =  (nmethod*) fst.current()-&gt;cb();
2904         ScopeDesc* sd = nm-&gt;scope_desc_at(pc);
2905         char buffer[8];
2906         jio_snprintf(buffer, sizeof(buffer), &quot;%d&quot;, sd-&gt;bci());
2907         size_t len = strlen(buffer);
2908         const char * found = strstr(DeoptimizeOnlyAt, buffer);
2909         while (found != NULL) {
2910           if ((found[len] == &#39;,&#39; || found[len] == &#39;\n&#39; || found[len] == &#39;\0&#39;) &amp;&amp;
2911               (found == DeoptimizeOnlyAt || found[-1] == &#39;,&#39; || found[-1] == &#39;\n&#39;)) {
2912             // Check that the bci found is bracketed by terminators.
2913             break;
2914           }
2915           found = strstr(found + 1, buffer);
2916         }
2917         if (!found) {
2918           continue;
2919         }
2920       }
2921 
2922       if (DebugDeoptimization &amp;&amp; !deopt) {
2923         deopt = true; // One-time only print before deopt
2924         tty-&gt;print_cr(&quot;[BEFORE Deoptimization]&quot;);
2925         trace_frames();
2926         trace_stack();
2927       }
2928       Deoptimization::deoptimize(this, *fst.current(), fst.register_map());
2929     }
2930   }
2931 
2932   if (DebugDeoptimization &amp;&amp; deopt) {
2933     tty-&gt;print_cr(&quot;[AFTER Deoptimization]&quot;);
2934     trace_frames();
2935   }
2936 }
2937 
2938 
2939 // Make zombies
2940 void JavaThread::make_zombies() {
2941   for (StackFrameStream fst(this); !fst.is_done(); fst.next()) {
2942     if (fst.current()-&gt;can_be_deoptimized()) {
2943       // it is a Java nmethod
2944       nmethod* nm = CodeCache::find_nmethod(fst.current()-&gt;pc());
2945       nm-&gt;make_not_entrant();
2946     }
2947   }
2948 }
2949 #endif // PRODUCT
2950 
2951 
2952 void JavaThread::deoptimize_marked_methods() {
2953   if (!has_last_Java_frame()) return;
2954   // BiasedLocking needs an updated RegisterMap for the revoke monitors pass
2955   StackFrameStream fst(this, UseBiasedLocking);
2956   for (; !fst.is_done(); fst.next()) {
2957     if (fst.current()-&gt;should_be_deoptimized()) {
2958       Deoptimization::deoptimize(this, *fst.current(), fst.register_map());
2959     }
2960   }
2961 }
2962 
2963 // If the caller is a NamedThread, then remember, in the current scope,
2964 // the given JavaThread in its _processed_thread field.
2965 class RememberProcessedThread: public StackObj {
2966   NamedThread* _cur_thr;
2967  public:
2968   RememberProcessedThread(JavaThread* jthr) {
2969     Thread* thread = Thread::current();
2970     if (thread-&gt;is_Named_thread()) {
2971       _cur_thr = (NamedThread *)thread;
2972       _cur_thr-&gt;set_processed_thread(jthr);
2973     } else {
2974       _cur_thr = NULL;
2975     }
2976   }
2977 
2978   ~RememberProcessedThread() {
2979     if (_cur_thr) {
2980       _cur_thr-&gt;set_processed_thread(NULL);
2981     }
2982   }
2983 };
2984 
2985 void JavaThread::oops_do(OopClosure* f, CodeBlobClosure* cf) {
2986   // Verify that the deferred card marks have been flushed.
2987   assert(deferred_card_mark().is_empty(), &quot;Should be empty during GC&quot;);
2988 
2989   // Traverse the GCHandles
2990   Thread::oops_do(f, cf);
2991 
2992   assert((!has_last_Java_frame() &amp;&amp; java_call_counter() == 0) ||
2993          (has_last_Java_frame() &amp;&amp; java_call_counter() &gt; 0), &quot;wrong java_sp info!&quot;);
2994 
2995   if (has_last_Java_frame()) {
2996     // Record JavaThread to GC thread
2997     RememberProcessedThread rpt(this);
2998 
2999     // traverse the registered growable array
3000     if (_array_for_gc != NULL) {
3001       for (int index = 0; index &lt; _array_for_gc-&gt;length(); index++) {
3002         f-&gt;do_oop(_array_for_gc-&gt;adr_at(index));
3003       }
3004     }
3005 
3006     // Traverse the monitor chunks
3007     for (MonitorChunk* chunk = monitor_chunks(); chunk != NULL; chunk = chunk-&gt;next()) {
3008       chunk-&gt;oops_do(f);
3009     }
3010 
3011     // Traverse the execution stack
3012     for (StackFrameStream fst(this); !fst.is_done(); fst.next()) {
3013       fst.current()-&gt;oops_do(f, cf, fst.register_map());
3014     }
3015   }
3016 
3017   assert(vframe_array_head() == NULL, &quot;deopt in progress at a safepoint!&quot;);
3018   // If we have deferred set_locals there might be oops waiting to be
3019   // written
3020   GrowableArray&lt;jvmtiDeferredLocalVariableSet*&gt;* list = deferred_locals();
3021   if (list != NULL) {
3022     for (int i = 0; i &lt; list-&gt;length(); i++) {
3023       list-&gt;at(i)-&gt;oops_do(f);
3024     }
3025   }
3026 
3027   // Traverse instance variables at the end since the GC may be moving things
3028   // around using this function
3029   f-&gt;do_oop((oop*) &amp;_threadObj);
3030   f-&gt;do_oop((oop*) &amp;_vm_result);
3031   f-&gt;do_oop((oop*) &amp;_exception_oop);
3032   f-&gt;do_oop((oop*) &amp;_pending_async_exception);
3033 
3034   if (jvmti_thread_state() != NULL) {
3035     jvmti_thread_state()-&gt;oops_do(f, cf);
3036   }
3037 
3038   f-&gt;do_oop(&amp;_scopedCache);
3039 }
3040 
3041 #ifdef ASSERT
3042 void JavaThread::verify_states_for_handshake() {
3043   // This checks that the thread has a correct frame state during a handshake.
3044   assert((!has_last_Java_frame() &amp;&amp; java_call_counter() == 0) ||
3045          (has_last_Java_frame() &amp;&amp; java_call_counter() &gt; 0),
3046          &quot;unexpected frame info: has_last_frame=%d, java_call_counter=%d&quot;,
3047          has_last_Java_frame(), java_call_counter());
3048 }
3049 #endif
3050 
3051 void JavaThread::nmethods_do(CodeBlobClosure* cf) {
3052   assert((!has_last_Java_frame() &amp;&amp; java_call_counter() == 0) ||
3053          (has_last_Java_frame() &amp;&amp; java_call_counter() &gt; 0),
3054          &quot;unexpected frame info: has_last_frame=%d, java_call_counter=%d&quot;,
3055          has_last_Java_frame(), java_call_counter());
3056 
3057   if (has_last_Java_frame()) {
3058     // Traverse the execution stack
3059     for (StackFrameStream fst(this); !fst.is_done(); fst.next()) {
3060       fst.current()-&gt;nmethods_do(cf);
3061     }
3062   }
3063 
3064   if (jvmti_thread_state() != NULL) {
3065     jvmti_thread_state()-&gt;nmethods_do(cf);
3066   }
3067 }
3068 
3069 void JavaThread::metadata_do(MetadataClosure* f) {
3070   if (has_last_Java_frame()) {
3071     // Traverse the execution stack to call f() on the methods in the stack
3072     for (StackFrameStream fst(this); !fst.is_done(); fst.next()) {
3073       fst.current()-&gt;metadata_do(f);
3074     }
3075   } else if (is_Compiler_thread()) {
3076     // need to walk ciMetadata in current compile tasks to keep alive.
3077     CompilerThread* ct = (CompilerThread*)this;
3078     if (ct-&gt;env() != NULL) {
3079       ct-&gt;env()-&gt;metadata_do(f);
3080     }
3081     CompileTask* task = ct-&gt;task();
3082     if (task != NULL) {
3083       task-&gt;metadata_do(f);
3084     }
3085   }
3086 }
3087 
3088 // Printing
3089 const char* _get_thread_state_name(JavaThreadState _thread_state) {
3090   switch (_thread_state) {
3091   case _thread_uninitialized:     return &quot;_thread_uninitialized&quot;;
3092   case _thread_new:               return &quot;_thread_new&quot;;
3093   case _thread_new_trans:         return &quot;_thread_new_trans&quot;;
3094   case _thread_in_native:         return &quot;_thread_in_native&quot;;
3095   case _thread_in_native_trans:   return &quot;_thread_in_native_trans&quot;;
3096   case _thread_in_vm:             return &quot;_thread_in_vm&quot;;
3097   case _thread_in_vm_trans:       return &quot;_thread_in_vm_trans&quot;;
3098   case _thread_in_Java:           return &quot;_thread_in_Java&quot;;
3099   case _thread_in_Java_trans:     return &quot;_thread_in_Java_trans&quot;;
3100   case _thread_blocked:           return &quot;_thread_blocked&quot;;
3101   case _thread_blocked_trans:     return &quot;_thread_blocked_trans&quot;;
3102   default:                        return &quot;unknown thread state&quot;;
3103   }
3104 }
3105 
3106 #ifndef PRODUCT
3107 void JavaThread::print_thread_state_on(outputStream *st) const {
3108   st-&gt;print_cr(&quot;   JavaThread state: %s&quot;, _get_thread_state_name(_thread_state));
3109 };
3110 const char* JavaThread::thread_state_name() const {
3111   return _get_thread_state_name(_thread_state);
3112 }
3113 #endif // PRODUCT
3114 
3115 // Called by Threads::print() for VM_PrintThreads operation
3116 void JavaThread::print_on(outputStream *st, bool print_extended_info) const {
3117   st-&gt;print_raw(&quot;\&quot;&quot;);
3118   st-&gt;print_raw(get_thread_name());
3119   st-&gt;print_raw(&quot;\&quot; &quot;);
3120   oop thread_oop = threadObj();
3121   if (thread_oop != NULL) {
3122     st-&gt;print(&quot;#&quot; INT64_FORMAT &quot; [%ld] &quot;, (int64_t)java_lang_Thread::thread_id(thread_oop), (long) osthread()-&gt;thread_id());
3123     if (java_lang_Thread::is_daemon(thread_oop))  st-&gt;print(&quot;daemon &quot;);
3124     st-&gt;print(&quot;prio=%d &quot;, java_lang_Thread::priority(thread_oop));
3125   }
3126   Thread::print_on(st, print_extended_info);
3127   // print guess for valid stack memory region (assume 4K pages); helps lock debugging
3128   st-&gt;print_cr(&quot;[&quot; INTPTR_FORMAT &quot;]&quot;, (intptr_t)last_Java_sp() &amp; ~right_n_bits(12));
3129   if (thread_oop != NULL) {
3130     st-&gt;print_cr(&quot;   java.lang.Thread.State: %s&quot;, java_lang_Thread::thread_status_name(thread_oop));
3131   }
3132 #ifndef PRODUCT
3133   _safepoint_state-&gt;print_on(st);
3134 #endif // PRODUCT
3135   if (is_Compiler_thread()) {
3136     CompileTask *task = ((CompilerThread*)this)-&gt;task();
3137     if (task != NULL) {
3138       st-&gt;print(&quot;   Compiling: &quot;);
3139       task-&gt;print(st, NULL, true, false);
3140     } else {
3141       st-&gt;print(&quot;   No compile task&quot;);
3142     }
3143     st-&gt;cr();
3144   }
3145 }
3146 
3147 void JavaThread::print() const { print_on(tty); }
3148 
3149 void JavaThread::print_name_on_error(outputStream* st, char *buf, int buflen) const {
3150   st-&gt;print(&quot;%s&quot;, get_thread_name_string(buf, buflen));
3151 }
3152 
3153 // Called by fatal error handler. The difference between this and
3154 // JavaThread::print() is that we can&#39;t grab lock or allocate memory.
3155 void JavaThread::print_on_error(outputStream* st, char *buf, int buflen) const {
3156   st-&gt;print(&quot;JavaThread \&quot;%s\&quot;&quot;, get_thread_name_string(buf, buflen));
3157   oop thread_obj = threadObj();
3158   if (thread_obj != NULL) {
3159     if (java_lang_Thread::is_daemon(thread_obj)) st-&gt;print(&quot; daemon&quot;);
3160   }
3161   st-&gt;print(&quot; [&quot;);
3162   st-&gt;print(&quot;%s&quot;, _get_thread_state_name(_thread_state));
3163   if (osthread()) {
3164     st-&gt;print(&quot;, id=%d&quot;, osthread()-&gt;thread_id());
3165   }
3166   st-&gt;print(&quot;, stack(&quot; PTR_FORMAT &quot;,&quot; PTR_FORMAT &quot;)&quot;,
3167             p2i(stack_end()), p2i(stack_base()));
3168   st-&gt;print(&quot;]&quot;);
3169 
3170   ThreadsSMRSupport::print_info_on(this, st);
3171   return;
3172 }
3173 
3174 // Verification
3175 
3176 static void frame_verify(frame* f, const RegisterMap *map) { f-&gt;verify(map); }
3177 
3178 void JavaThread::verify() {
3179   // Verify oops in the thread.
3180   oops_do(&amp;VerifyOopClosure::verify_oop, NULL);
3181 
3182   // Verify the stack frames.
3183   frames_do(frame_verify);
3184 }
3185 
3186 // CR 6300358 (sub-CR 2137150)
3187 // Most callers of this method assume that it can&#39;t return NULL but a
3188 // thread may not have a name whilst it is in the process of attaching to
3189 // the VM - see CR 6412693, and there are places where a JavaThread can be
3190 // seen prior to having it&#39;s threadObj set (eg JNI attaching threads and
3191 // if vm exit occurs during initialization). These cases can all be accounted
3192 // for such that this method never returns NULL.
3193 const char* JavaThread::get_thread_name() const {
3194 #ifdef ASSERT
3195   // early safepoints can hit while current thread does not yet have TLS
3196   if (!SafepointSynchronize::is_at_safepoint()) {
3197     Thread *cur = Thread::current();
3198     if (!(cur-&gt;is_Java_thread() &amp;&amp; cur == this)) {
3199       // Current JavaThreads are allowed to get their own name without
3200       // the Threads_lock.
3201       assert_locked_or_safepoint_or_handshake(Threads_lock, this);
3202     }
3203   }
3204 #endif // ASSERT
3205   return get_thread_name_string();
3206 }
3207 
3208 // Returns a non-NULL representation of this thread&#39;s name, or a suitable
3209 // descriptive string if there is no set name
3210 const char* JavaThread::get_thread_name_string(char* buf, int buflen) const {
3211   const char* name_str;
3212   oop thread_obj = threadObj();
3213   if (thread_obj != NULL) {
3214     oop name = java_lang_Thread::name(thread_obj);
3215     if (name != NULL) {
3216       if (buf == NULL) {
3217         name_str = java_lang_String::as_utf8_string(name);
3218       } else {
3219         name_str = java_lang_String::as_utf8_string(name, buf, buflen);
3220       }
3221     } else if (is_attaching_via_jni()) { // workaround for 6412693 - see 6404306
3222       name_str = &quot;&lt;no-name - thread is attaching&gt;&quot;;
3223     } else {
3224       name_str = Thread::name();
3225     }
3226   } else {
3227     name_str = Thread::name();
3228   }
3229   assert(name_str != NULL, &quot;unexpected NULL thread name&quot;);
3230   return name_str;
3231 }
3232 
3233 void JavaThread::prepare(jobject jni_thread, ThreadPriority prio) {
3234 
3235   assert(Threads_lock-&gt;owner() == Thread::current(), &quot;must have threads lock&quot;);
3236   assert(NoPriority &lt;= prio &amp;&amp; prio &lt;= MaxPriority, &quot;sanity check&quot;);
3237   // Link Java Thread object &lt;-&gt; C++ Thread
3238 
3239   // Get the C++ thread object (an oop) from the JNI handle (a jthread)
3240   // and put it into a new Handle.  The Handle &quot;thread_oop&quot; can then
3241   // be used to pass the C++ thread object to other methods.
3242 
3243   // Set the Java level thread object (jthread) field of the
3244   // new thread (a JavaThread *) to C++ thread object using the
3245   // &quot;thread_oop&quot; handle.
3246 
3247   // Set the thread field (a JavaThread *) of the
3248   // oop representing the java_lang_Thread to the new thread (a JavaThread *).
3249 
3250   Handle thread_oop(Thread::current(),
3251                     JNIHandles::resolve_non_null(jni_thread));
3252   assert(InstanceKlass::cast(thread_oop-&gt;klass())-&gt;is_linked(),
3253          &quot;must be initialized&quot;);
3254   set_threadObj(thread_oop());
3255   java_lang_Thread::set_thread(thread_oop(), this);
3256 
3257   if (prio == NoPriority) {
3258     prio = java_lang_Thread::priority(thread_oop());
3259     assert(prio != NoPriority, &quot;A valid priority should be present&quot;);
3260   }
3261 
3262   // Push the Java priority down to the native thread; needs Threads_lock
3263   Thread::set_priority(this, prio);
3264 
3265   // Add the new thread to the Threads list and set it in motion.
3266   // We must have threads lock in order to call Threads::add.
3267   // It is crucial that we do not block before the thread is
3268   // added to the Threads list for if a GC happens, then the java_thread oop
3269   // will not be visited by GC.
3270   Threads::add(this);
3271 }
3272 
3273 oop JavaThread::current_park_blocker() {
3274   // Support for JSR-166 locks
3275   oop thread_oop = threadObj();
3276   if (thread_oop != NULL) {
3277     return java_lang_Thread::park_blocker(thread_oop);
3278   }
3279   return NULL;
3280 }
3281 
3282 
3283 void JavaThread::print_stack_on(outputStream* st) {
3284   if (!has_last_Java_frame()) return;
3285   ResourceMark rm;
3286   HandleMark   hm;
3287 
3288   RegisterMap reg_map(this);
3289   vframe* start_vf = last_java_vframe(&amp;reg_map);
3290   int count = 0;
3291   for (vframe* f = start_vf; f != NULL; f = f-&gt;sender()) {
3292     if (f-&gt;is_java_frame()) {
3293       javaVFrame* jvf = javaVFrame::cast(f);
3294       java_lang_Throwable::print_stack_element(st, jvf-&gt;method(), jvf-&gt;bci());
3295 
3296       // Print out lock information
3297       if (JavaMonitorsInStackTrace) {
3298         jvf-&gt;print_lock_info_on(st, count);
3299       }
3300     } else {
3301       // Ignore non-Java frames
3302     }
3303 
3304     // Bail-out case for too deep stacks if MaxJavaStackTraceDepth &gt; 0
3305     count++;
3306     if (MaxJavaStackTraceDepth &gt; 0 &amp;&amp; MaxJavaStackTraceDepth == count) return;
3307   }
3308 }
3309 
3310 
3311 // JVMTI PopFrame support
3312 void JavaThread::popframe_preserve_args(ByteSize size_in_bytes, void* start) {
3313   assert(_popframe_preserved_args == NULL, &quot;should not wipe out old PopFrame preserved arguments&quot;);
3314   if (in_bytes(size_in_bytes) != 0) {
3315     _popframe_preserved_args = NEW_C_HEAP_ARRAY(char, in_bytes(size_in_bytes), mtThread);
3316     _popframe_preserved_args_size = in_bytes(size_in_bytes);
3317     Copy::conjoint_jbytes(start, _popframe_preserved_args, _popframe_preserved_args_size);
3318   }
3319 }
3320 
3321 void* JavaThread::popframe_preserved_args() {
3322   return _popframe_preserved_args;
3323 }
3324 
3325 ByteSize JavaThread::popframe_preserved_args_size() {
3326   return in_ByteSize(_popframe_preserved_args_size);
3327 }
3328 
3329 WordSize JavaThread::popframe_preserved_args_size_in_words() {
3330   int sz = in_bytes(popframe_preserved_args_size());
3331   assert(sz % wordSize == 0, &quot;argument size must be multiple of wordSize&quot;);
3332   return in_WordSize(sz / wordSize);
3333 }
3334 
3335 void JavaThread::popframe_free_preserved_args() {
3336   assert(_popframe_preserved_args != NULL, &quot;should not free PopFrame preserved arguments twice&quot;);
3337   FREE_C_HEAP_ARRAY(char, (char*)_popframe_preserved_args);
3338   _popframe_preserved_args = NULL;
3339   _popframe_preserved_args_size = 0;
3340 }
3341 
3342 #ifndef PRODUCT
3343 
3344 void JavaThread::trace_frames() {
3345   tty-&gt;print_cr(&quot;[Describe stack]&quot;);
3346   int frame_no = 1;
3347   for (StackFrameStream fst(this); !fst.is_done(); fst.next()) {
3348     tty-&gt;print(&quot;  %d. &quot;, frame_no++);
3349     fst.current()-&gt;print_value_on(tty, this);
3350     tty-&gt;cr();
3351   }
3352 }
3353 
3354 class PrintAndVerifyOopClosure: public OopClosure {
3355  protected:
3356   template &lt;class T&gt; inline void do_oop_work(T* p) {
3357     oop obj = RawAccess&lt;&gt;::oop_load(p);
3358     if (obj == NULL) return;
3359     tty-&gt;print(INTPTR_FORMAT &quot;: &quot;, p2i(p));
3360     if (oopDesc::is_oop_or_null(obj)) {
3361       if (obj-&gt;is_objArray()) {
3362         tty-&gt;print_cr(&quot;valid objArray: &quot; INTPTR_FORMAT, p2i(obj));
3363       } else {
3364         obj-&gt;print();
3365       }
3366     } else {
3367       tty-&gt;print_cr(&quot;invalid oop: &quot; INTPTR_FORMAT, p2i(obj));
3368     }
3369     tty-&gt;cr();
3370   }
3371  public:
3372   virtual void do_oop(oop* p) { do_oop_work(p); }
3373   virtual void do_oop(narrowOop* p)  { do_oop_work(p); }
3374 };
3375 
3376 #ifdef ASSERT
3377 // Print or validate the layout of stack frames
3378 void JavaThread::print_frame_layout(int depth, bool validate_only) {
3379   ResourceMark rm;
3380   PRESERVE_EXCEPTION_MARK;
3381   FrameValues values;
3382   int frame_no = 0;
3383   for (StackFrameStream fst(this, true, true); !fst.is_done(); fst.next()) {
3384     fst.current()-&gt;describe(values, ++frame_no, fst.register_map());
3385     if (depth == frame_no) break;
3386   }
3387   Continuation::describe(values);
3388   if (validate_only) {
3389     values.validate();
3390   } else {
3391     tty-&gt;print_cr(&quot;[Describe stack layout]&quot;);
3392     values.print(this);
3393   }
3394 }
3395 #endif
3396 
3397 void JavaThread::trace_stack_from(vframe* start_vf) {
3398   ResourceMark rm;
3399   int vframe_no = 1;
3400   for (vframe* f = start_vf; f; f = f-&gt;sender()) {
3401     if (f-&gt;is_java_frame()) {
3402       javaVFrame::cast(f)-&gt;print_activation(vframe_no++);
3403     } else {
3404       f-&gt;print();
3405     }
3406     if (vframe_no &gt; StackPrintLimit) {
3407       tty-&gt;print_cr(&quot;...&lt;more frames&gt;...&quot;);
3408       return;
3409     }
3410   }
3411 }
3412 
3413 
3414 void JavaThread::trace_stack() {
3415   if (!has_last_Java_frame()) return;
3416   ResourceMark rm;
3417   HandleMark   hm;
3418   RegisterMap reg_map(this, true, true);
3419   trace_stack_from(last_java_vframe(&amp;reg_map));
3420 }
3421 
3422 
3423 #endif // PRODUCT
3424 
3425 
3426 javaVFrame* JavaThread::last_java_vframe(RegisterMap *reg_map) {
3427   assert(reg_map != NULL, &quot;a map must be given&quot;);
3428   frame f = last_frame();
3429   for (vframe* vf = vframe::new_vframe(&amp;f, reg_map, this); vf; vf = vf-&gt;sender()) {
3430     if (vf-&gt;is_java_frame()) return javaVFrame::cast(vf);
3431   }
3432   return NULL;
3433 }
3434 
3435 oop JavaThread::last_continuation() {
3436   if (threadObj() == (oop)NULL) return (oop)NULL; // happens during initialization
3437   
3438   return java_lang_Thread::continuation(threadObj());
3439 }
3440 
3441 Klass* JavaThread::security_get_caller_class(int depth) {
3442   vframeStream vfst(this);
3443   vfst.security_get_caller_frame(depth);
3444   if (!vfst.at_end()) {
3445     return vfst.method()-&gt;method_holder();
3446   }
3447   return NULL;
3448 }
3449 
3450 // java.lang.Thread.sleep support
3451 // Returns true if sleep time elapsed as expected, and false
3452 // if the thread was interrupted.
3453 bool JavaThread::sleep(jlong millis) {
3454   assert(this == Thread::current(),  &quot;thread consistency check&quot;);
3455 
3456   ParkEvent * const slp = this-&gt;_SleepEvent;
3457   // Because there can be races with thread interruption sending an unpark()
3458   // to the event, we explicitly reset it here to avoid an immediate return.
3459   // The actual interrupt state will be checked before we park().
3460   slp-&gt;reset();
3461   // Thread interruption establishes a happens-before ordering in the
3462   // Java Memory Model, so we need to ensure we synchronize with the
3463   // interrupt state.
3464   OrderAccess::fence();
3465 
3466   jlong prevtime = os::javaTimeNanos();
3467 
3468   for (;;) {
3469     // interruption has precedence over timing out
3470     if (this-&gt;is_interrupted(true)) {
3471       return false;
3472     }
3473 
3474     if (millis &lt;= 0) {
3475       return true;
3476     }
3477 
3478     {
3479       ThreadBlockInVM tbivm(this);
3480       OSThreadWaitState osts(this-&gt;osthread(), false /* not Object.wait() */);
3481 
3482       this-&gt;set_suspend_equivalent();
3483       // cleared by handle_special_suspend_equivalent_condition() or
3484       // java_suspend_self() via check_and_wait_while_suspended()
3485 
3486       slp-&gt;park(millis);
3487 
3488       // were we externally suspended while we were waiting?
3489       this-&gt;check_and_wait_while_suspended();
3490     }
3491 
3492     // Update elapsed time tracking
3493     jlong newtime = os::javaTimeNanos();
3494     if (newtime - prevtime &lt; 0) {
3495       // time moving backwards, should only happen if no monotonic clock
3496       // not a guarantee() because JVM should not abort on kernel/glibc bugs
3497       assert(!os::supports_monotonic_clock(),
3498              &quot;unexpected time moving backwards detected in JavaThread::sleep()&quot;);
3499     } else {
3500       millis -= (newtime - prevtime) / NANOSECS_PER_MILLISEC;
3501     }
3502     prevtime = newtime;
3503   }
3504 }
3505 
3506 static void compiler_thread_entry(JavaThread* thread, TRAPS) {
3507   assert(thread-&gt;is_Compiler_thread(), &quot;must be compiler thread&quot;);
3508   CompileBroker::compiler_thread_loop();
3509 }
3510 
3511 static void sweeper_thread_entry(JavaThread* thread, TRAPS) {
3512   NMethodSweeper::sweeper_loop();
3513 }
3514 
3515 // Create a CompilerThread
3516 CompilerThread::CompilerThread(CompileQueue* queue,
3517                                CompilerCounters* counters)
3518                                : JavaThread(&amp;compiler_thread_entry) {
3519   _env   = NULL;
3520   _log   = NULL;
3521   _task  = NULL;
3522   _queue = queue;
3523   _counters = counters;
3524   _buffer_blob = NULL;
3525   _compiler = NULL;
3526 
3527   // Compiler uses resource area for compilation, let&#39;s bias it to mtCompiler
3528   resource_area()-&gt;bias_to(mtCompiler);
3529 
3530 #ifndef PRODUCT
3531   _ideal_graph_printer = NULL;
3532 #endif
3533 }
3534 
3535 CompilerThread::~CompilerThread() {
3536   // Delete objects which were allocated on heap.
3537   delete _counters;
3538 }
3539 
3540 bool CompilerThread::can_call_java() const {
3541   return _compiler != NULL &amp;&amp; _compiler-&gt;is_jvmci();
3542 }
3543 
3544 // Create sweeper thread
3545 CodeCacheSweeperThread::CodeCacheSweeperThread()
3546 : JavaThread(&amp;sweeper_thread_entry) {
3547   _scanned_compiled_method = NULL;
3548 }
3549 
3550 void CodeCacheSweeperThread::oops_do(OopClosure* f, CodeBlobClosure* cf) {
3551   JavaThread::oops_do(f, cf);
3552   if (_scanned_compiled_method != NULL &amp;&amp; cf != NULL) {
3553     // Safepoints can occur when the sweeper is scanning an nmethod so
3554     // process it here to make sure it isn&#39;t unloaded in the middle of
3555     // a scan.
3556     cf-&gt;do_code_blob(_scanned_compiled_method);
3557   }
3558 }
3559 
3560 void CodeCacheSweeperThread::nmethods_do(CodeBlobClosure* cf) {
3561   JavaThread::nmethods_do(cf);
3562   if (_scanned_compiled_method != NULL &amp;&amp; cf != NULL) {
3563     // Safepoints can occur when the sweeper is scanning an nmethod so
3564     // process it here to make sure it isn&#39;t unloaded in the middle of
3565     // a scan.
3566     cf-&gt;do_code_blob(_scanned_compiled_method);
3567   }
3568 }
3569 
3570 
3571 // ======= Threads ========
3572 
3573 // The Threads class links together all active threads, and provides
3574 // operations over all threads. It is protected by the Threads_lock,
3575 // which is also used in other global contexts like safepointing.
3576 // ThreadsListHandles are used to safely perform operations on one
3577 // or more threads without the risk of the thread exiting during the
3578 // operation.
3579 //
3580 // Note: The Threads_lock is currently more widely used than we
3581 // would like. We are actively migrating Threads_lock uses to other
3582 // mechanisms in order to reduce Threads_lock contention.
3583 
3584 int         Threads::_number_of_threads = 0;
3585 int         Threads::_number_of_non_daemon_threads = 0;
3586 int         Threads::_return_code = 0;
3587 uintx       Threads::_thread_claim_token = 1; // Never zero.
3588 size_t      JavaThread::_stack_size_at_create = 0;
3589 
3590 #ifdef ASSERT
3591 bool        Threads::_vm_complete = false;
3592 #endif
3593 
3594 static inline void *prefetch_and_load_ptr(void **addr, intx prefetch_interval) {
3595   Prefetch::read((void*)addr, prefetch_interval);
3596   return *addr;
3597 }
3598 
3599 // Possibly the ugliest for loop the world has seen. C++ does not allow
3600 // multiple types in the declaration section of the for loop. In this case
3601 // we are only dealing with pointers and hence can cast them. It looks ugly
3602 // but macros are ugly and therefore it&#39;s fine to make things absurdly ugly.
3603 #define DO_JAVA_THREADS(LIST, X)                                                                                          \
3604     for (JavaThread *MACRO_scan_interval = (JavaThread*)(uintptr_t)PrefetchScanIntervalInBytes,                           \
3605              *MACRO_list = (JavaThread*)(LIST),                                                                           \
3606              **MACRO_end = ((JavaThread**)((ThreadsList*)MACRO_list)-&gt;threads()) + ((ThreadsList*)MACRO_list)-&gt;length(),  \
3607              **MACRO_current_p = (JavaThread**)((ThreadsList*)MACRO_list)-&gt;threads(),                                     \
3608              *X = (JavaThread*)prefetch_and_load_ptr((void**)MACRO_current_p, (intx)MACRO_scan_interval);                 \
3609          MACRO_current_p != MACRO_end;                                                                                    \
3610          MACRO_current_p++,                                                                                               \
3611              X = (JavaThread*)prefetch_and_load_ptr((void**)MACRO_current_p, (intx)MACRO_scan_interval))
3612 
3613 // All JavaThreads
3614 #define ALL_JAVA_THREADS(X) DO_JAVA_THREADS(ThreadsSMRSupport::get_java_thread_list(), X)
3615 
3616 // All NonJavaThreads (i.e., every non-JavaThread in the system).
3617 void Threads::non_java_threads_do(ThreadClosure* tc) {
3618   NoSafepointVerifier nsv;
3619   for (NonJavaThread::Iterator njti; !njti.end(); njti.step()) {
3620     tc-&gt;do_thread(njti.current());
3621   }
3622 }
3623 
3624 // All JavaThreads
3625 void Threads::java_threads_do(ThreadClosure* tc) {
3626   assert_locked_or_safepoint(Threads_lock);
3627   // ALL_JAVA_THREADS iterates through all JavaThreads.
3628   ALL_JAVA_THREADS(p) {
3629     tc-&gt;do_thread(p);
3630   }
3631 }
3632 
3633 void Threads::java_threads_and_vm_thread_do(ThreadClosure* tc) {
3634   assert_locked_or_safepoint(Threads_lock);
3635   java_threads_do(tc);
3636   tc-&gt;do_thread(VMThread::vm_thread());
3637 }
3638 
3639 // All JavaThreads + all non-JavaThreads (i.e., every thread in the system).
3640 void Threads::threads_do(ThreadClosure* tc) {
3641   assert_locked_or_safepoint(Threads_lock);
3642   java_threads_do(tc);
3643   non_java_threads_do(tc);
3644 }
3645 
3646 void Threads::possibly_parallel_threads_do(bool is_par, ThreadClosure* tc) {
3647   uintx claim_token = Threads::thread_claim_token();
3648   ALL_JAVA_THREADS(p) {
3649     if (p-&gt;claim_threads_do(is_par, claim_token)) {
3650       tc-&gt;do_thread(p);
3651     }
3652   }
3653   VMThread* vmt = VMThread::vm_thread();
3654   if (vmt-&gt;claim_threads_do(is_par, claim_token)) {
3655     tc-&gt;do_thread(vmt);
3656   }
3657 }
3658 
3659 // The system initialization in the library has three phases.
3660 //
3661 // Phase 1: java.lang.System class initialization
3662 //     java.lang.System is a primordial class loaded and initialized
3663 //     by the VM early during startup.  java.lang.System.&lt;clinit&gt;
3664 //     only does registerNatives and keeps the rest of the class
3665 //     initialization work later until thread initialization completes.
3666 //
3667 //     System.initPhase1 initializes the system properties, the static
3668 //     fields in, out, and err. Set up java signal handlers, OS-specific
3669 //     system settings, and thread group of the main thread.
3670 static void call_initPhase1(TRAPS) {
3671   Klass* klass =  SystemDictionary::resolve_or_fail(vmSymbols::java_lang_System(), true, CHECK);
3672   JavaValue result(T_VOID);
3673   JavaCalls::call_static(&amp;result, klass, vmSymbols::initPhase1_name(),
3674                                          vmSymbols::void_method_signature(), CHECK);
3675 }
3676 
3677 // Phase 2. Module system initialization
3678 //     This will initialize the module system.  Only java.base classes
3679 //     can be loaded until phase 2 completes.
3680 //
3681 //     Call System.initPhase2 after the compiler initialization and jsr292
3682 //     classes get initialized because module initialization runs a lot of java
3683 //     code, that for performance reasons, should be compiled.  Also, this will
3684 //     enable the startup code to use lambda and other language features in this
3685 //     phase and onward.
3686 //
3687 //     After phase 2, The VM will begin search classes from -Xbootclasspath/a.
3688 static void call_initPhase2(TRAPS) {
3689   TraceTime timer(&quot;Initialize module system&quot;, TRACETIME_LOG(Info, startuptime));
3690 
3691   Klass* klass = SystemDictionary::resolve_or_fail(vmSymbols::java_lang_System(), true, CHECK);
3692 
3693   JavaValue result(T_INT);
3694   JavaCallArguments args;
3695   args.push_int(DisplayVMOutputToStderr);
3696   args.push_int(log_is_enabled(Debug, init)); // print stack trace if exception thrown
3697   JavaCalls::call_static(&amp;result, klass, vmSymbols::initPhase2_name(),
3698                                          vmSymbols::boolean_boolean_int_signature(), &amp;args, CHECK);
3699   if (result.get_jint() != JNI_OK) {
3700     vm_exit_during_initialization(); // no message or exception
3701   }
3702 
3703   universe_post_module_init();
3704 }
3705 
3706 // Phase 3. final setup - set security manager, system class loader and TCCL
3707 //
3708 //     This will instantiate and set the security manager, set the system class
3709 //     loader as well as the thread context class loader.  The security manager
3710 //     and system class loader may be a custom class loaded from -Xbootclasspath/a,
3711 //     other modules or the application&#39;s classpath.
3712 static void call_initPhase3(TRAPS) {
3713   Klass* klass = SystemDictionary::resolve_or_fail(vmSymbols::java_lang_System(), true, CHECK);
3714   JavaValue result(T_VOID);
3715   JavaCalls::call_static(&amp;result, klass, vmSymbols::initPhase3_name(),
3716                                          vmSymbols::void_method_signature(), CHECK);
3717 }
3718 
3719 void Threads::initialize_java_lang_classes(JavaThread* main_thread, TRAPS) {
3720   TraceTime timer(&quot;Initialize java.lang classes&quot;, TRACETIME_LOG(Info, startuptime));
3721 
3722   if (EagerXrunInit &amp;&amp; Arguments::init_libraries_at_startup()) {
3723     create_vm_init_libraries();
3724   }
3725 
3726   initialize_class(vmSymbols::java_lang_String(), CHECK);
3727 
3728   // Inject CompactStrings value after the static initializers for String ran.
3729   java_lang_String::set_compact_strings(CompactStrings);
3730 
3731   // Initialize java_lang.System (needed before creating the thread)
3732   initialize_class(vmSymbols::java_lang_System(), CHECK);
3733   // The VM creates &amp; returns objects of this class. Make sure it&#39;s initialized.
3734   initialize_class(vmSymbols::java_lang_Class(), CHECK);
3735   initialize_class(vmSymbols::java_lang_ThreadGroup(), CHECK);
3736   Handle thread_group = create_initial_thread_group(CHECK);
3737   Universe::set_main_thread_group(thread_group());
3738   initialize_class(vmSymbols::java_lang_Thread(), CHECK);
3739   oop thread_object = create_initial_thread(thread_group, main_thread, CHECK);
3740   main_thread-&gt;set_threadObj(thread_object);
3741 
3742   // Set thread status to running since main thread has
3743   // been started and running.
3744   java_lang_Thread::set_thread_status(thread_object,
3745                                       java_lang_Thread::RUNNABLE);
3746 
3747   // The VM creates objects of this class.
3748   initialize_class(vmSymbols::java_lang_Module(), CHECK);
3749 
3750 #ifdef ASSERT
3751   InstanceKlass *k = SystemDictionary::UnsafeConstants_klass();
3752   assert(k-&gt;is_not_initialized(), &quot;UnsafeConstants should not already be initialized&quot;);
3753 #endif
3754 
3755   // initialize the hardware-specific constants needed by Unsafe
3756   initialize_class(vmSymbols::jdk_internal_misc_UnsafeConstants(), CHECK);
3757   jdk_internal_misc_UnsafeConstants::set_unsafe_constants();
3758 
3759   // The VM preresolves methods to these classes. Make sure that they get initialized
3760   initialize_class(vmSymbols::java_lang_reflect_Method(), CHECK);
3761   initialize_class(vmSymbols::java_lang_ref_Finalizer(), CHECK);
3762 
3763   // Phase 1 of the system initialization in the library, java.lang.System class initialization
3764   call_initPhase1(CHECK);
3765 
3766   // get the Java runtime name, version, and vendor info after java.lang.System is initialized
3767   JDK_Version::set_runtime_name(get_java_runtime_name(THREAD));
3768   JDK_Version::set_runtime_version(get_java_runtime_version(THREAD));
3769   JDK_Version::set_runtime_vendor_version(get_java_runtime_vendor_version(THREAD));
3770   JDK_Version::set_runtime_vendor_vm_bug_url(get_java_runtime_vendor_vm_bug_url(THREAD));
3771 
3772   // an instance of OutOfMemory exception has been allocated earlier
3773   initialize_class(vmSymbols::java_lang_OutOfMemoryError(), CHECK);
3774   initialize_class(vmSymbols::java_lang_NullPointerException(), CHECK);
3775   initialize_class(vmSymbols::java_lang_ClassCastException(), CHECK);
3776   initialize_class(vmSymbols::java_lang_ArrayStoreException(), CHECK);
3777   initialize_class(vmSymbols::java_lang_ArithmeticException(), CHECK);
3778   initialize_class(vmSymbols::java_lang_StackOverflowError(), CHECK);
3779   initialize_class(vmSymbols::java_lang_IllegalMonitorStateException(), CHECK);
3780   initialize_class(vmSymbols::java_lang_IllegalArgumentException(), CHECK);
3781 
3782   // Eager box cache initialization only if AOT is on and any library is loaded.
3783   AOTLoader::initialize_box_caches(CHECK);
3784 }
3785 
3786 void Threads::initialize_jsr292_core_classes(TRAPS) {
3787   TraceTime timer(&quot;Initialize java.lang.invoke classes&quot;, TRACETIME_LOG(Info, startuptime));
3788 
3789   initialize_class(vmSymbols::java_lang_invoke_MethodHandle(), CHECK);
3790   initialize_class(vmSymbols::java_lang_invoke_ResolvedMethodName(), CHECK);
3791   initialize_class(vmSymbols::java_lang_invoke_MemberName(), CHECK);
3792   initialize_class(vmSymbols::java_lang_invoke_MethodHandleNatives(), CHECK);
3793 }
3794 
3795 jint Threads::create_vm(JavaVMInitArgs* args, bool* canTryAgain) {
3796   extern void JDK_Version_init();
3797 
3798   // Preinitialize version info.
3799   VM_Version::early_initialize();
3800 
3801   // Check version
3802   if (!is_supported_jni_version(args-&gt;version)) return JNI_EVERSION;
3803 
3804   // Initialize library-based TLS
3805   ThreadLocalStorage::init();
3806 
3807   // Initialize the output stream module
3808   ostream_init();
3809 
3810   // Process java launcher properties.
3811   Arguments::process_sun_java_launcher_properties(args);
3812 
3813   // Initialize the os module
3814   os::init();
3815 
3816   // Record VM creation timing statistics
3817   TraceVmCreationTime create_vm_timer;
3818   create_vm_timer.start();
3819 
3820   // Initialize system properties.
3821   Arguments::init_system_properties();
3822 
3823   // So that JDK version can be used as a discriminator when parsing arguments
3824   JDK_Version_init();
3825 
3826   // Update/Initialize System properties after JDK version number is known
3827   Arguments::init_version_specific_system_properties();
3828 
3829   // Make sure to initialize log configuration *before* parsing arguments
3830   LogConfiguration::initialize(create_vm_timer.begin_time());
3831 
3832   // Parse arguments
3833   // Note: this internally calls os::init_container_support()
3834   jint parse_result = Arguments::parse(args);
3835   if (parse_result != JNI_OK) return parse_result;
3836 
3837   os::init_before_ergo();
3838 
3839   jint ergo_result = Arguments::apply_ergo();
3840   if (ergo_result != JNI_OK) return ergo_result;
3841 
3842   // Final check of all ranges after ergonomics which may change values.
3843   if (!JVMFlagRangeList::check_ranges()) {
3844     return JNI_EINVAL;
3845   }
3846 
3847   // Final check of all &#39;AfterErgo&#39; constraints after ergonomics which may change values.
3848   bool constraint_result = JVMFlagConstraintList::check_constraints(JVMFlagConstraint::AfterErgo);
3849   if (!constraint_result) {
3850     return JNI_EINVAL;
3851   }
3852 
3853   if (PauseAtStartup) {
3854     os::pause();
3855   }
3856 
3857   HOTSPOT_VM_INIT_BEGIN();
3858 
3859   // Timing (must come after argument parsing)
3860   TraceTime timer(&quot;Create VM&quot;, TRACETIME_LOG(Info, startuptime));
3861 
3862   // Initialize the os module after parsing the args
3863   jint os_init_2_result = os::init_2();
3864   if (os_init_2_result != JNI_OK) return os_init_2_result;
3865 
3866 #ifdef CAN_SHOW_REGISTERS_ON_ASSERT
3867   // Initialize assert poison page mechanism.
3868   if (ShowRegistersOnAssert) {
3869     initialize_assert_poison();
3870   }
3871 #endif // CAN_SHOW_REGISTERS_ON_ASSERT
3872 
3873   SafepointMechanism::initialize();
3874 
3875   jint adjust_after_os_result = Arguments::adjust_after_os();
3876   if (adjust_after_os_result != JNI_OK) return adjust_after_os_result;
3877 
3878   // Initialize output stream logging
3879   ostream_init_log();
3880 
3881   // Convert -Xrun to -agentlib: if there is no JVM_OnLoad
3882   // Must be before create_vm_init_agents()
3883   if (Arguments::init_libraries_at_startup()) {
3884     convert_vm_init_libraries_to_agents();
3885   }
3886 
3887   // Launch -agentlib/-agentpath and converted -Xrun agents
3888   if (Arguments::init_agents_at_startup()) {
3889     create_vm_init_agents();
3890   }
3891 
3892   // Initialize Threads state
3893   _number_of_threads = 0;
3894   _number_of_non_daemon_threads = 0;
3895 
3896   // Initialize global data structures and create system classes in heap
3897   vm_init_globals();
3898 
3899 #if INCLUDE_JVMCI
3900   if (JVMCICounterSize &gt; 0) {
3901     JavaThread::_jvmci_old_thread_counters = NEW_C_HEAP_ARRAY(jlong, JVMCICounterSize, mtJVMCI);
3902     memset(JavaThread::_jvmci_old_thread_counters, 0, sizeof(jlong) * JVMCICounterSize);
3903   } else {
3904     JavaThread::_jvmci_old_thread_counters = NULL;
3905   }
3906 #endif // INCLUDE_JVMCI
3907 
3908   // Attach the main thread to this os thread
3909   JavaThread* main_thread = new JavaThread();
3910   main_thread-&gt;set_thread_state(_thread_in_vm);
3911   main_thread-&gt;initialize_thread_current();
3912   // must do this before set_active_handles
3913   main_thread-&gt;record_stack_base_and_size();
3914   main_thread-&gt;register_thread_stack_with_NMT();
3915   main_thread-&gt;set_active_handles(JNIHandleBlock::allocate_block());
3916 
3917   if (!main_thread-&gt;set_as_starting_thread()) {
3918     vm_shutdown_during_initialization(
3919                                       &quot;Failed necessary internal allocation. Out of swap space&quot;);
3920     main_thread-&gt;smr_delete();
3921     *canTryAgain = false; // don&#39;t let caller call JNI_CreateJavaVM again
3922     return JNI_ENOMEM;
3923   }
3924 
3925   // Enable guard page *after* os::create_main_thread(), otherwise it would
3926   // crash Linux VM, see notes in os_linux.cpp.
3927   main_thread-&gt;create_stack_guard_pages();
3928 
3929   // Initialize Java-Level synchronization subsystem
3930   ObjectMonitor::Initialize();
3931 
3932   // Initialize global modules
3933   jint status = init_globals();
3934   if (status != JNI_OK) {
3935     main_thread-&gt;smr_delete();
3936     *canTryAgain = false; // don&#39;t let caller call JNI_CreateJavaVM again
3937     return status;
3938   }
3939 
3940   JFR_ONLY(Jfr::on_create_vm_1();)
3941 
3942   // Should be done after the heap is fully created
3943   main_thread-&gt;cache_global_variables();
3944 
3945   HandleMark hm;
3946 
3947   { MutexLocker mu(Threads_lock);
3948     Threads::add(main_thread);
3949   }
3950 
3951   // Any JVMTI raw monitors entered in onload will transition into
3952   // real raw monitor. VM is setup enough here for raw monitor enter.
3953   JvmtiExport::transition_pending_onload_raw_monitors();
3954 
3955   // Create the VMThread
3956   { TraceTime timer(&quot;Start VMThread&quot;, TRACETIME_LOG(Info, startuptime));
3957 
3958     VMThread::create();
3959     Thread* vmthread = VMThread::vm_thread();
3960 
3961     if (!os::create_thread(vmthread, os::vm_thread)) {
3962       vm_exit_during_initialization(&quot;Cannot create VM thread. &quot;
3963                                     &quot;Out of system resources.&quot;);
3964     }
3965 
3966     // Wait for the VM thread to become ready, and VMThread::run to initialize
3967     // Monitors can have spurious returns, must always check another state flag
3968     {
3969       MonitorLocker ml(Notify_lock);
3970       os::start_thread(vmthread);
3971       while (vmthread-&gt;active_handles() == NULL) {
3972         ml.wait();
3973       }
3974     }
3975   }
3976 
3977   assert(Universe::is_fully_initialized(), &quot;not initialized&quot;);
3978   if (VerifyDuringStartup) {
3979     // Make sure we&#39;re starting with a clean slate.
3980     VM_Verify verify_op;
3981     VMThread::execute(&amp;verify_op);
3982   }
3983 
3984   // We need this to update the java.vm.info property in case any flags used
3985   // to initially define it have been changed. This is needed for both CDS and
3986   // AOT, since UseSharedSpaces and UseAOT may be changed after java.vm.info
3987   // is initially computed. See Abstract_VM_Version::vm_info_string().
3988   // This update must happen before we initialize the java classes, but
3989   // after any initialization logic that might modify the flags.
3990   Arguments::update_vm_info_property(VM_Version::vm_info_string());
3991 
3992   Thread* THREAD = Thread::current();
3993 
3994   // Always call even when there are not JVMTI environments yet, since environments
3995   // may be attached late and JVMTI must track phases of VM execution
3996   JvmtiExport::enter_early_start_phase();
3997 
3998   // Notify JVMTI agents that VM has started (JNI is up) - nop if no agents.
3999   JvmtiExport::post_early_vm_start();
4000 
4001   initialize_java_lang_classes(main_thread, CHECK_JNI_ERR);
4002 
4003   quicken_jni_functions();
4004 
4005   // No more stub generation allowed after that point.
4006   StubCodeDesc::freeze();
4007 
4008   // Set flag that basic initialization has completed. Used by exceptions and various
4009   // debug stuff, that does not work until all basic classes have been initialized.
4010   set_init_completed();
4011 
4012   LogConfiguration::post_initialize();
4013   Metaspace::post_initialize();
4014 
4015   HOTSPOT_VM_INIT_END();
4016 
4017   // record VM initialization completion time
4018 #if INCLUDE_MANAGEMENT
4019   Management::record_vm_init_completed();
4020 #endif // INCLUDE_MANAGEMENT
4021 
4022   // Signal Dispatcher needs to be started before VMInit event is posted
4023   os::initialize_jdk_signal_support(CHECK_JNI_ERR);
4024 
4025   // Start Attach Listener if +StartAttachListener or it can&#39;t be started lazily
4026   if (!DisableAttachMechanism) {
4027     AttachListener::vm_start();
4028     if (StartAttachListener || AttachListener::init_at_startup()) {
4029       AttachListener::init();
4030     }
4031   }
4032 
4033   // Launch -Xrun agents
4034   // Must be done in the JVMTI live phase so that for backward compatibility the JDWP
4035   // back-end can launch with -Xdebug -Xrunjdwp.
4036   if (!EagerXrunInit &amp;&amp; Arguments::init_libraries_at_startup()) {
4037     create_vm_init_libraries();
4038   }
4039 
4040   if (CleanChunkPoolAsync) {
4041     Chunk::start_chunk_pool_cleaner_task();
4042   }
4043 
4044   // Start the service thread
4045   // The service thread enqueues JVMTI deferred events and does various hashtable
4046   // and other cleanups.  Needs to start before the compilers start posting events.
4047   ServiceThread::initialize();
4048 
4049   // initialize compiler(s)
4050 #if defined(COMPILER1) || COMPILER2_OR_JVMCI
4051 #if INCLUDE_JVMCI
4052   bool force_JVMCI_intialization = false;
4053   if (EnableJVMCI) {
4054     // Initialize JVMCI eagerly when it is explicitly requested.
4055     // Or when JVMCILibDumpJNIConfig or JVMCIPrintProperties is enabled.
4056     force_JVMCI_intialization = EagerJVMCI || JVMCIPrintProperties || JVMCILibDumpJNIConfig;
4057 
4058     if (!force_JVMCI_intialization) {
4059       // 8145270: Force initialization of JVMCI runtime otherwise requests for blocking
4060       // compilations via JVMCI will not actually block until JVMCI is initialized.
4061       force_JVMCI_intialization = UseJVMCICompiler &amp;&amp; (!UseInterpreter || !BackgroundCompilation);
4062     }
4063   }
4064 #endif
4065   CompileBroker::compilation_init_phase1(CHECK_JNI_ERR);
4066   // Postpone completion of compiler initialization to after JVMCI
4067   // is initialized to avoid timeouts of blocking compilations.
4068   if (JVMCI_ONLY(!force_JVMCI_intialization) NOT_JVMCI(true)) {
4069     CompileBroker::compilation_init_phase2();
4070   }
4071 #endif
4072 
4073   // Pre-initialize some JSR292 core classes to avoid deadlock during class loading.
4074   // It is done after compilers are initialized, because otherwise compilations of
4075   // signature polymorphic MH intrinsics can be missed
4076   // (see SystemDictionary::find_method_handle_intrinsic).
4077   initialize_jsr292_core_classes(CHECK_JNI_ERR);
4078 
4079   // This will initialize the module system.  Only java.base classes can be
4080   // loaded until phase 2 completes
4081   call_initPhase2(CHECK_JNI_ERR);
4082 
4083   JFR_ONLY(Jfr::on_create_vm_2();)
4084 
4085   // Always call even when there are not JVMTI environments yet, since environments
4086   // may be attached late and JVMTI must track phases of VM execution
4087   JvmtiExport::enter_start_phase();
4088 
4089   // Notify JVMTI agents that VM has started (JNI is up) - nop if no agents.
4090   JvmtiExport::post_vm_start();
4091 
4092   // Final system initialization including security manager and system class loader
4093   call_initPhase3(CHECK_JNI_ERR);
4094 
4095   // cache the system and platform class loaders
4096   SystemDictionary::compute_java_loaders(CHECK_JNI_ERR);
4097 
4098 #if INCLUDE_CDS
4099   // capture the module path info from the ModuleEntryTable
4100   ClassLoader::initialize_module_path(THREAD);
4101 #endif
4102 
4103 #if INCLUDE_JVMCI
4104   if (force_JVMCI_intialization) {
4105     JVMCI::initialize_compiler(CHECK_JNI_ERR);
4106     CompileBroker::compilation_init_phase2();
4107   }
4108 #endif
4109 
4110   // Always call even when there are not JVMTI environments yet, since environments
4111   // may be attached late and JVMTI must track phases of VM execution
4112   JvmtiExport::enter_live_phase();
4113 
4114   // Make perfmemory accessible
4115   PerfMemory::set_accessible(true);
4116 
4117   // Notify JVMTI agents that VM initialization is complete - nop if no agents.
4118   JvmtiExport::post_vm_initialized();
4119 
4120   JFR_ONLY(Jfr::on_create_vm_3();)
4121 
4122 #if INCLUDE_MANAGEMENT
4123   Management::initialize(THREAD);
4124 
4125   if (HAS_PENDING_EXCEPTION) {
4126     // management agent fails to start possibly due to
4127     // configuration problem and is responsible for printing
4128     // stack trace if appropriate. Simply exit VM.
4129     vm_exit(1);
4130   }
4131 #endif // INCLUDE_MANAGEMENT
4132 
4133   if (MemProfiling)                   MemProfiler::engage();
4134   StatSampler::engage();
4135   if (CheckJNICalls)                  JniPeriodicChecker::engage();
4136 
4137   BiasedLocking::init();
4138 
4139 #if INCLUDE_RTM_OPT
4140   RTMLockingCounters::init();
4141 #endif
4142 
4143   call_postVMInitHook(THREAD);
4144   // The Java side of PostVMInitHook.run must deal with all
4145   // exceptions and provide means of diagnosis.
4146   if (HAS_PENDING_EXCEPTION) {
4147     CLEAR_PENDING_EXCEPTION;
4148   }
4149 
4150   {
4151     MutexLocker ml(PeriodicTask_lock);
4152     // Make sure the WatcherThread can be started by WatcherThread::start()
4153     // or by dynamic enrollment.
4154     WatcherThread::make_startable();
4155     // Start up the WatcherThread if there are any periodic tasks
4156     // NOTE:  All PeriodicTasks should be registered by now. If they
4157     //   aren&#39;t, late joiners might appear to start slowly (we might
4158     //   take a while to process their first tick).
4159     if (PeriodicTask::num_tasks() &gt; 0) {
4160       WatcherThread::start();
4161     }
4162   }
4163 
4164   create_vm_timer.end();
4165 #ifdef ASSERT
4166   _vm_complete = true;
4167 #endif
4168 
4169   if (DumpSharedSpaces) {
4170     MetaspaceShared::preload_and_dump(CHECK_JNI_ERR);
4171     ShouldNotReachHere();
4172   }
4173 
4174   return JNI_OK;
4175 }
4176 
4177 // type for the Agent_OnLoad and JVM_OnLoad entry points
4178 extern &quot;C&quot; {
4179   typedef jint (JNICALL *OnLoadEntry_t)(JavaVM *, char *, void *);
4180 }
4181 // Find a command line agent library and return its entry point for
4182 //         -agentlib:  -agentpath:   -Xrun
4183 // num_symbol_entries must be passed-in since only the caller knows the number of symbols in the array.
4184 static OnLoadEntry_t lookup_on_load(AgentLibrary* agent,
4185                                     const char *on_load_symbols[],
4186                                     size_t num_symbol_entries) {
4187   OnLoadEntry_t on_load_entry = NULL;
4188   void *library = NULL;
4189 
4190   if (!agent-&gt;valid()) {
4191     char buffer[JVM_MAXPATHLEN];
4192     char ebuf[1024] = &quot;&quot;;
4193     const char *name = agent-&gt;name();
4194     const char *msg = &quot;Could not find agent library &quot;;
4195 
4196     // First check to see if agent is statically linked into executable
4197     if (os::find_builtin_agent(agent, on_load_symbols, num_symbol_entries)) {
4198       library = agent-&gt;os_lib();
4199     } else if (agent-&gt;is_absolute_path()) {
4200       library = os::dll_load(name, ebuf, sizeof ebuf);
4201       if (library == NULL) {
4202         const char *sub_msg = &quot; in absolute path, with error: &quot;;
4203         size_t len = strlen(msg) + strlen(name) + strlen(sub_msg) + strlen(ebuf) + 1;
4204         char *buf = NEW_C_HEAP_ARRAY(char, len, mtThread);
4205         jio_snprintf(buf, len, &quot;%s%s%s%s&quot;, msg, name, sub_msg, ebuf);
4206         // If we can&#39;t find the agent, exit.
4207         vm_exit_during_initialization(buf, NULL);
4208         FREE_C_HEAP_ARRAY(char, buf);
4209       }
4210     } else {
4211       // Try to load the agent from the standard dll directory
4212       if (os::dll_locate_lib(buffer, sizeof(buffer), Arguments::get_dll_dir(),
4213                              name)) {
4214         library = os::dll_load(buffer, ebuf, sizeof ebuf);
4215       }
4216       if (library == NULL) { // Try the library path directory.
4217         if (os::dll_build_name(buffer, sizeof(buffer), name)) {
4218           library = os::dll_load(buffer, ebuf, sizeof ebuf);
4219         }
4220         if (library == NULL) {
4221           const char *sub_msg = &quot; on the library path, with error: &quot;;
4222           const char *sub_msg2 = &quot;\nModule java.instrument may be missing from runtime image.&quot;;
4223 
4224           size_t len = strlen(msg) + strlen(name) + strlen(sub_msg) +
4225                        strlen(ebuf) + strlen(sub_msg2) + 1;
4226           char *buf = NEW_C_HEAP_ARRAY(char, len, mtThread);
4227           if (!agent-&gt;is_instrument_lib()) {
4228             jio_snprintf(buf, len, &quot;%s%s%s%s&quot;, msg, name, sub_msg, ebuf);
4229           } else {
4230             jio_snprintf(buf, len, &quot;%s%s%s%s%s&quot;, msg, name, sub_msg, ebuf, sub_msg2);
4231           }
4232           // If we can&#39;t find the agent, exit.
4233           vm_exit_during_initialization(buf, NULL);
4234           FREE_C_HEAP_ARRAY(char, buf);
4235         }
4236       }
4237     }
4238     agent-&gt;set_os_lib(library);
4239     agent-&gt;set_valid();
4240   }
4241 
4242   // Find the OnLoad function.
4243   on_load_entry =
4244     CAST_TO_FN_PTR(OnLoadEntry_t, os::find_agent_function(agent,
4245                                                           false,
4246                                                           on_load_symbols,
4247                                                           num_symbol_entries));
4248   return on_load_entry;
4249 }
4250 
4251 // Find the JVM_OnLoad entry point
4252 static OnLoadEntry_t lookup_jvm_on_load(AgentLibrary* agent) {
4253   const char *on_load_symbols[] = JVM_ONLOAD_SYMBOLS;
4254   return lookup_on_load(agent, on_load_symbols, sizeof(on_load_symbols) / sizeof(char*));
4255 }
4256 
4257 // Find the Agent_OnLoad entry point
4258 static OnLoadEntry_t lookup_agent_on_load(AgentLibrary* agent) {
4259   const char *on_load_symbols[] = AGENT_ONLOAD_SYMBOLS;
4260   return lookup_on_load(agent, on_load_symbols, sizeof(on_load_symbols) / sizeof(char*));
4261 }
4262 
4263 // For backwards compatibility with -Xrun
4264 // Convert libraries with no JVM_OnLoad, but which have Agent_OnLoad to be
4265 // treated like -agentpath:
4266 // Must be called before agent libraries are created
4267 void Threads::convert_vm_init_libraries_to_agents() {
4268   AgentLibrary* agent;
4269   AgentLibrary* next;
4270 
4271   for (agent = Arguments::libraries(); agent != NULL; agent = next) {
4272     next = agent-&gt;next();  // cache the next agent now as this agent may get moved off this list
4273     OnLoadEntry_t on_load_entry = lookup_jvm_on_load(agent);
4274 
4275     // If there is an JVM_OnLoad function it will get called later,
4276     // otherwise see if there is an Agent_OnLoad
4277     if (on_load_entry == NULL) {
4278       on_load_entry = lookup_agent_on_load(agent);
4279       if (on_load_entry != NULL) {
4280         // switch it to the agent list -- so that Agent_OnLoad will be called,
4281         // JVM_OnLoad won&#39;t be attempted and Agent_OnUnload will
4282         Arguments::convert_library_to_agent(agent);
4283       } else {
4284         vm_exit_during_initialization(&quot;Could not find JVM_OnLoad or Agent_OnLoad function in the library&quot;, agent-&gt;name());
4285       }
4286     }
4287   }
4288 }
4289 
4290 // Create agents for -agentlib:  -agentpath:  and converted -Xrun
4291 // Invokes Agent_OnLoad
4292 // Called very early -- before JavaThreads exist
4293 void Threads::create_vm_init_agents() {
4294   extern struct JavaVM_ main_vm;
4295   AgentLibrary* agent;
4296 
4297   JvmtiExport::enter_onload_phase();
4298 
4299   for (agent = Arguments::agents(); agent != NULL; agent = agent-&gt;next()) {
4300     // CDS dumping does not support native JVMTI agent.
4301     // CDS dumping supports Java agent if the AllowArchivingWithJavaAgent diagnostic option is specified.
4302     if (Arguments::is_dumping_archive()) {
4303       if(!agent-&gt;is_instrument_lib()) {
4304         vm_exit_during_cds_dumping(&quot;CDS dumping does not support native JVMTI agent, name&quot;, agent-&gt;name());
4305       } else if (!AllowArchivingWithJavaAgent) {
4306         vm_exit_during_cds_dumping(
4307           &quot;Must enable AllowArchivingWithJavaAgent in order to run Java agent during CDS dumping&quot;);
4308       }
4309     }
4310 
4311     OnLoadEntry_t  on_load_entry = lookup_agent_on_load(agent);
4312 
4313     if (on_load_entry != NULL) {
4314       // Invoke the Agent_OnLoad function
4315       jint err = (*on_load_entry)(&amp;main_vm, agent-&gt;options(), NULL);
4316       if (err != JNI_OK) {
4317         vm_exit_during_initialization(&quot;agent library failed to init&quot;, agent-&gt;name());
4318       }
4319     } else {
4320       vm_exit_during_initialization(&quot;Could not find Agent_OnLoad function in the agent library&quot;, agent-&gt;name());
4321     }
4322   }
4323 
4324   JvmtiExport::enter_primordial_phase();
4325 }
4326 
4327 extern &quot;C&quot; {
4328   typedef void (JNICALL *Agent_OnUnload_t)(JavaVM *);
4329 }
4330 
4331 void Threads::shutdown_vm_agents() {
4332   // Send any Agent_OnUnload notifications
4333   const char *on_unload_symbols[] = AGENT_ONUNLOAD_SYMBOLS;
4334   size_t num_symbol_entries = ARRAY_SIZE(on_unload_symbols);
4335   extern struct JavaVM_ main_vm;
4336   for (AgentLibrary* agent = Arguments::agents(); agent != NULL; agent = agent-&gt;next()) {
4337 
4338     // Find the Agent_OnUnload function.
4339     Agent_OnUnload_t unload_entry = CAST_TO_FN_PTR(Agent_OnUnload_t,
4340                                                    os::find_agent_function(agent,
4341                                                    false,
4342                                                    on_unload_symbols,
4343                                                    num_symbol_entries));
4344 
4345     // Invoke the Agent_OnUnload function
4346     if (unload_entry != NULL) {
4347       JavaThread* thread = JavaThread::current();
4348       ThreadToNativeFromVM ttn(thread);
4349       HandleMark hm(thread);
4350       (*unload_entry)(&amp;main_vm);
4351     }
4352   }
4353 }
4354 
4355 // Called for after the VM is initialized for -Xrun libraries which have not been converted to agent libraries
4356 // Invokes JVM_OnLoad
4357 void Threads::create_vm_init_libraries() {
4358   extern struct JavaVM_ main_vm;
4359   AgentLibrary* agent;
4360 
4361   for (agent = Arguments::libraries(); agent != NULL; agent = agent-&gt;next()) {
4362     OnLoadEntry_t on_load_entry = lookup_jvm_on_load(agent);
4363 
4364     if (on_load_entry != NULL) {
4365       // Invoke the JVM_OnLoad function
4366       JavaThread* thread = JavaThread::current();
4367       ThreadToNativeFromVM ttn(thread);
4368       HandleMark hm(thread);
4369       jint err = (*on_load_entry)(&amp;main_vm, agent-&gt;options(), NULL);
4370       if (err != JNI_OK) {
4371         vm_exit_during_initialization(&quot;-Xrun library failed to init&quot;, agent-&gt;name());
4372       }
4373     } else {
4374       vm_exit_during_initialization(&quot;Could not find JVM_OnLoad function in -Xrun library&quot;, agent-&gt;name());
4375     }
4376   }
4377 }
4378 
4379 
4380 // Last thread running calls java.lang.Shutdown.shutdown()
4381 void JavaThread::invoke_shutdown_hooks() {
4382   HandleMark hm(this);
4383 
4384   // We could get here with a pending exception, if so clear it now.
4385   if (this-&gt;has_pending_exception()) {
4386     this-&gt;clear_pending_exception();
4387   }
4388 
4389   EXCEPTION_MARK;
4390   Klass* shutdown_klass =
4391     SystemDictionary::resolve_or_null(vmSymbols::java_lang_Shutdown(),
4392                                       THREAD);
4393   if (shutdown_klass != NULL) {
4394     // SystemDictionary::resolve_or_null will return null if there was
4395     // an exception.  If we cannot load the Shutdown class, just don&#39;t
4396     // call Shutdown.shutdown() at all.  This will mean the shutdown hooks
4397     // won&#39;t be run.  Note that if a shutdown hook was registered,
4398     // the Shutdown class would have already been loaded
4399     // (Runtime.addShutdownHook will load it).
4400     JavaValue result(T_VOID);
4401     JavaCalls::call_static(&amp;result,
4402                            shutdown_klass,
4403                            vmSymbols::shutdown_name(),
4404                            vmSymbols::void_method_signature(),
4405                            THREAD);
4406   }
4407   CLEAR_PENDING_EXCEPTION;
4408 }
4409 
4410 // Threads::destroy_vm() is normally called from jni_DestroyJavaVM() when
4411 // the program falls off the end of main(). Another VM exit path is through
4412 // vm_exit() when the program calls System.exit() to return a value or when
4413 // there is a serious error in VM. The two shutdown paths are not exactly
4414 // the same, but they share Shutdown.shutdown() at Java level and before_exit()
4415 // and VM_Exit op at VM level.
4416 //
4417 // Shutdown sequence:
4418 //   + Shutdown native memory tracking if it is on
4419 //   + Wait until we are the last non-daemon thread to execute
4420 //     &lt;-- every thing is still working at this moment --&gt;
4421 //   + Call java.lang.Shutdown.shutdown(), which will invoke Java level
4422 //        shutdown hooks
4423 //   + Call before_exit(), prepare for VM exit
4424 //      &gt; run VM level shutdown hooks (they are registered through JVM_OnExit(),
4425 //        currently the only user of this mechanism is File.deleteOnExit())
4426 //      &gt; stop StatSampler, watcher thread,
4427 //        post thread end and vm death events to JVMTI,
4428 //        stop signal thread
4429 //   + Call JavaThread::exit(), it will:
4430 //      &gt; release JNI handle blocks, remove stack guard pages
4431 //      &gt; remove this thread from Threads list
4432 //     &lt;-- no more Java code from this thread after this point --&gt;
4433 //   + Stop VM thread, it will bring the remaining VM to a safepoint and stop
4434 //     the compiler threads at safepoint
4435 //     &lt;-- do not use anything that could get blocked by Safepoint --&gt;
4436 //   + Disable tracing at JNI/JVM barriers
4437 //   + Set _vm_exited flag for threads that are still running native code
4438 //   + Call exit_globals()
4439 //      &gt; deletes tty
4440 //      &gt; deletes PerfMemory resources
4441 //   + Delete this thread
4442 //   + Return to caller
4443 
4444 bool Threads::destroy_vm() {
4445   JavaThread* thread = JavaThread::current();
4446 
4447 #ifdef ASSERT
4448   _vm_complete = false;
4449 #endif
4450   // Wait until we are the last non-daemon thread to execute
4451   { MonitorLocker nu(Threads_lock);
4452     while (Threads::number_of_non_daemon_threads() &gt; 1)
4453       // This wait should make safepoint checks, wait without a timeout,
4454       // and wait as a suspend-equivalent condition.
4455       nu.wait(0, Mutex::_as_suspend_equivalent_flag);
4456   }
4457 
4458   EventShutdown e;
4459   if (e.should_commit()) {
4460     e.set_reason(&quot;No remaining non-daemon Java threads&quot;);
4461     e.commit();
4462   }
4463 
4464   // Hang forever on exit if we are reporting an error.
4465   if (ShowMessageBoxOnError &amp;&amp; VMError::is_error_reported()) {
4466     os::infinite_sleep();
4467   }
4468   os::wait_for_keypress_at_exit();
4469 
4470   // run Java level shutdown hooks
4471   thread-&gt;invoke_shutdown_hooks();
4472 
4473   before_exit(thread);
4474 
4475   thread-&gt;exit(true);
4476 
4477   // Stop VM thread.
4478   {
4479     // 4945125 The vm thread comes to a safepoint during exit.
4480     // GC vm_operations can get caught at the safepoint, and the
4481     // heap is unparseable if they are caught. Grab the Heap_lock
4482     // to prevent this. The GC vm_operations will not be able to
4483     // queue until after the vm thread is dead. After this point,
4484     // we&#39;ll never emerge out of the safepoint before the VM exits.
4485 
4486     MutexLocker ml(Heap_lock, Mutex::_no_safepoint_check_flag);
4487 
4488     VMThread::wait_for_vm_thread_exit();
4489     assert(SafepointSynchronize::is_at_safepoint(), &quot;VM thread should exit at Safepoint&quot;);
4490     VMThread::destroy();
4491   }
4492 
4493   // Now, all Java threads are gone except daemon threads. Daemon threads
4494   // running Java code or in VM are stopped by the Safepoint. However,
4495   // daemon threads executing native code are still running.  But they
4496   // will be stopped at native=&gt;Java/VM barriers. Note that we can&#39;t
4497   // simply kill or suspend them, as it is inherently deadlock-prone.
4498 
4499   VM_Exit::set_vm_exited();
4500 
4501   // Clean up ideal graph printers after the VMThread has started
4502   // the final safepoint which will block all the Compiler threads.
4503   // Note that this Thread has already logically exited so the
4504   // clean_up() function&#39;s use of a JavaThreadIteratorWithHandle
4505   // would be a problem except set_vm_exited() has remembered the
4506   // shutdown thread which is granted a policy exception.
4507 #if defined(COMPILER2) &amp;&amp; !defined(PRODUCT)
4508   IdealGraphPrinter::clean_up();
4509 #endif
4510 
4511   notify_vm_shutdown();
4512 
4513   // exit_globals() will delete tty
4514   exit_globals();
4515 
4516   // We are after VM_Exit::set_vm_exited() so we can&#39;t call
4517   // thread-&gt;smr_delete() or we will block on the Threads_lock.
4518   // Deleting the shutdown thread here is safe because another
4519   // JavaThread cannot have an active ThreadsListHandle for
4520   // this JavaThread.
4521   delete thread;
4522 
4523 #if INCLUDE_JVMCI
4524   if (JVMCICounterSize &gt; 0) {
4525     FREE_C_HEAP_ARRAY(jlong, JavaThread::_jvmci_old_thread_counters);
4526   }
4527 #endif
4528 
4529   LogConfiguration::finalize();
4530 
4531   return true;
4532 }
4533 
4534 
4535 jboolean Threads::is_supported_jni_version_including_1_1(jint version) {
4536   if (version == JNI_VERSION_1_1) return JNI_TRUE;
4537   return is_supported_jni_version(version);
4538 }
4539 
4540 
4541 jboolean Threads::is_supported_jni_version(jint version) {
4542   if (version == JNI_VERSION_1_2) return JNI_TRUE;
4543   if (version == JNI_VERSION_1_4) return JNI_TRUE;
4544   if (version == JNI_VERSION_1_6) return JNI_TRUE;
4545   if (version == JNI_VERSION_1_8) return JNI_TRUE;
4546   if (version == JNI_VERSION_9) return JNI_TRUE;
4547   if (version == JNI_VERSION_10) return JNI_TRUE;
4548   return JNI_FALSE;
4549 }
4550 
4551 
4552 void Threads::add(JavaThread* p, bool force_daemon) {
4553   // The threads lock must be owned at this point
4554   assert(Threads_lock-&gt;owned_by_self(), &quot;must have threads lock&quot;);
4555 
4556   BarrierSet::barrier_set()-&gt;on_thread_attach(p);
4557 
4558   // Once a JavaThread is added to the Threads list, smr_delete() has
4559   // to be used to delete it. Otherwise we can just delete it directly.
4560   p-&gt;set_on_thread_list();
4561 
4562   _number_of_threads++;
4563   oop threadObj = p-&gt;threadObj();
4564   bool daemon = true;
4565   // Bootstrapping problem: threadObj can be null for initial
4566   // JavaThread (or for threads attached via JNI)
4567   if ((!force_daemon) &amp;&amp; !is_daemon((threadObj))) {
4568     _number_of_non_daemon_threads++;
4569     daemon = false;
4570   }
4571 
4572   ThreadService::add_thread(p, daemon);
4573 
4574   // Maintain fast thread list
4575   ThreadsSMRSupport::add_thread(p);
4576 
4577   // Possible GC point.
4578   Events::log(p, &quot;Thread added: &quot; INTPTR_FORMAT, p2i(p));
4579 }
4580 
4581 void Threads::remove(JavaThread* p, bool is_daemon) {
4582 
4583   // Reclaim the ObjectMonitors from the om_in_use_list and om_free_list of the moribund thread.
4584   ObjectSynchronizer::om_flush(p);
4585 
4586   // Extra scope needed for Thread_lock, so we can check
4587   // that we do not remove thread without safepoint code notice
4588   { MonitorLocker ml(Threads_lock);
4589 
4590     assert(ThreadsSMRSupport::get_java_thread_list()-&gt;includes(p), &quot;p must be present&quot;);
4591 
4592     // Maintain fast thread list
4593     ThreadsSMRSupport::remove_thread(p);
4594 
4595     _number_of_threads--;
4596     if (!is_daemon) {
4597       _number_of_non_daemon_threads--;
4598 
4599       // Only one thread left, do a notify on the Threads_lock so a thread waiting
4600       // on destroy_vm will wake up.
4601       if (number_of_non_daemon_threads() == 1) {
4602         ml.notify_all();
4603       }
4604     }
4605     ThreadService::remove_thread(p, is_daemon);
4606 
4607     // Make sure that safepoint code disregard this thread. This is needed since
4608     // the thread might mess around with locks after this point. This can cause it
4609     // to do callbacks into the safepoint code. However, the safepoint code is not aware
4610     // of this thread since it is removed from the queue.
4611     p-&gt;set_terminated_value();
4612   } // unlock Threads_lock
4613 
4614   // Since Events::log uses a lock, we grab it outside the Threads_lock
4615   Events::log(p, &quot;Thread exited: &quot; INTPTR_FORMAT, p2i(p));
4616 }
4617 
4618 // Operations on the Threads list for GC.  These are not explicitly locked,
4619 // but the garbage collector must provide a safe context for them to run.
4620 // In particular, these things should never be called when the Threads_lock
4621 // is held by some other thread. (Note: the Safepoint abstraction also
4622 // uses the Threads_lock to guarantee this property. It also makes sure that
4623 // all threads gets blocked when exiting or starting).
4624 
4625 void Threads::oops_do(OopClosure* f, CodeBlobClosure* cf) {
4626   ALL_JAVA_THREADS(p) {
4627     p-&gt;oops_do(f, cf);
4628   }
4629   VMThread::vm_thread()-&gt;oops_do(f, cf);
4630 }
4631 
4632 void Threads::change_thread_claim_token() {
4633   if (++_thread_claim_token == 0) {
4634     // On overflow of the token counter, there is a risk of future
4635     // collisions between a new global token value and a stale token
4636     // for a thread, because not all iterations visit all threads.
4637     // (Though it&#39;s pretty much a theoretical concern for non-trivial
4638     // token counter sizes.)  To deal with the possibility, reset all
4639     // the thread tokens to zero on global token overflow.
4640     struct ResetClaims : public ThreadClosure {
4641       virtual void do_thread(Thread* t) {
4642         t-&gt;claim_threads_do(false, 0);
4643       }
4644     } reset_claims;
4645     Threads::threads_do(&amp;reset_claims);
4646     // On overflow, update the global token to non-zero, to
4647     // avoid the special &quot;never claimed&quot; initial thread value.
4648     _thread_claim_token = 1;
4649   }
4650 }
4651 
4652 #ifdef ASSERT
4653 void assert_thread_claimed(const char* kind, Thread* t, uintx expected) {
4654   const uintx token = t-&gt;threads_do_token();
4655   assert(token == expected,
4656          &quot;%s &quot; PTR_FORMAT &quot; has incorrect value &quot; UINTX_FORMAT &quot; != &quot;
4657          UINTX_FORMAT, kind, p2i(t), token, expected);
4658 }
4659 
4660 void Threads::assert_all_threads_claimed() {
4661   ALL_JAVA_THREADS(p) {
4662     assert_thread_claimed(&quot;Thread&quot;, p, _thread_claim_token);
4663   }
4664   assert_thread_claimed(&quot;VMThread&quot;, VMThread::vm_thread(), _thread_claim_token);
4665 }
4666 #endif // ASSERT
4667 
4668 class ParallelOopsDoThreadClosure : public ThreadClosure {
4669 private:
4670   OopClosure* _f;
4671   CodeBlobClosure* _cf;
4672 public:
4673   ParallelOopsDoThreadClosure(OopClosure* f, CodeBlobClosure* cf) : _f(f), _cf(cf) {}
4674   void do_thread(Thread* t) {
4675     t-&gt;oops_do(_f, _cf);
4676   }
4677 };
4678 
4679 void Threads::possibly_parallel_oops_do(bool is_par, OopClosure* f, CodeBlobClosure* cf) {
4680   ParallelOopsDoThreadClosure tc(f, cf);
4681   possibly_parallel_threads_do(is_par, &amp;tc);
4682 }
4683 
4684 void Threads::nmethods_do(CodeBlobClosure* cf) {
4685   ALL_JAVA_THREADS(p) {
4686     // This is used by the code cache sweeper to mark nmethods that are active
4687     // on the stack of a Java thread. Ignore the sweeper thread itself to avoid
4688     // marking CodeCacheSweeperThread::_scanned_compiled_method as active.
4689     if(!p-&gt;is_Code_cache_sweeper_thread()) {
4690       p-&gt;nmethods_do(cf);
4691     }
4692   }
4693 }
4694 
4695 void Threads::metadata_do(MetadataClosure* f) {
4696   ALL_JAVA_THREADS(p) {
4697     p-&gt;metadata_do(f);
4698   }
4699 }
4700 
4701 class ThreadHandlesClosure : public ThreadClosure {
4702   void (*_f)(Metadata*);
4703  public:
4704   ThreadHandlesClosure(void f(Metadata*)) : _f(f) {}
4705   virtual void do_thread(Thread* thread) {
4706     thread-&gt;metadata_handles_do(_f);
4707   }
4708 };
4709 
4710 void Threads::metadata_handles_do(void f(Metadata*)) {
4711   // Only walk the Handles in Thread.
4712   ThreadHandlesClosure handles_closure(f);
4713   threads_do(&amp;handles_closure);
4714 }
4715 
4716 // Get count Java threads that are waiting to enter the specified monitor.
4717 GrowableArray&lt;JavaThread*&gt;* Threads::get_pending_threads(ThreadsList * t_list,
4718                                                          int count,
4719                                                          address monitor) {
4720   GrowableArray&lt;JavaThread*&gt;* result = new GrowableArray&lt;JavaThread*&gt;(count);
4721 
4722   int i = 0;
4723   DO_JAVA_THREADS(t_list, p) {
4724     if (!p-&gt;can_call_java()) continue;
4725 
4726     address pending = (address)p-&gt;current_pending_monitor();
4727     if (pending == monitor) {             // found a match
4728       if (i &lt; count) result-&gt;append(p);   // save the first count matches
4729       i++;
4730     }
4731   }
4732 
4733   return result;
4734 }
4735 
4736 
4737 JavaThread *Threads::owning_thread_from_monitor_owner(ThreadsList * t_list,
4738                                                       address owner) {
4739   // NULL owner means not locked so we can skip the search
4740   if (owner == NULL) return NULL;
4741 
4742   DO_JAVA_THREADS(t_list, p) {
4743     // first, see if owner is the address of a Java thread
4744     if (owner == (address)p) return p;
4745   }
4746 
4747   // Cannot assert on lack of success here since this function may be
4748   // used by code that is trying to report useful problem information
4749   // like deadlock detection.
4750   if (UseHeavyMonitors) return NULL;
4751 
4752   // If we didn&#39;t find a matching Java thread and we didn&#39;t force use of
4753   // heavyweight monitors, then the owner is the stack address of the
4754   // Lock Word in the owning Java thread&#39;s stack.
4755   //
4756   JavaThread* the_owner = NULL;
4757   DO_JAVA_THREADS(t_list, q) {
4758     if (q-&gt;is_lock_owned(owner)) {
4759       the_owner = q;
4760       break;
4761     }
4762   }
4763 
4764   // cannot assert on lack of success here; see above comment
4765   return the_owner;
4766 }
4767 
4768 // Threads::print_on() is called at safepoint by VM_PrintThreads operation.
4769 void Threads::print_on(outputStream* st, bool print_stacks,
4770                        bool internal_format, bool print_concurrent_locks,
4771                        bool print_extended_info) {
4772   char buf[32];
4773   st-&gt;print_raw_cr(os::local_time_string(buf, sizeof(buf)));
4774 
4775   st-&gt;print_cr(&quot;Full thread dump %s (%s %s):&quot;,
4776                VM_Version::vm_name(),
4777                VM_Version::vm_release(),
4778                VM_Version::vm_info_string());
4779   st-&gt;cr();
4780 
4781 #if INCLUDE_SERVICES
4782   // Dump concurrent locks
4783   ConcurrentLocksDump concurrent_locks;
4784   if (print_concurrent_locks) {
4785     concurrent_locks.dump_at_safepoint();
4786   }
4787 #endif // INCLUDE_SERVICES
4788 
4789   ThreadsSMRSupport::print_info_on(st);
4790   st-&gt;cr();
4791 
4792   ALL_JAVA_THREADS(p) {
4793     ResourceMark rm;
4794     p-&gt;print_on(st, print_extended_info);
4795     if (print_stacks) {
4796       if (internal_format) {
4797         p-&gt;trace_stack();
4798       } else {
4799         p-&gt;print_stack_on(st);
4800       }
4801     }
4802     st-&gt;cr();
4803 #if INCLUDE_SERVICES
4804     if (print_concurrent_locks) {
4805       concurrent_locks.print_locks_on(p, st);
4806     }
4807 #endif // INCLUDE_SERVICES
4808   }
4809 
4810   VMThread::vm_thread()-&gt;print_on(st);
4811   st-&gt;cr();
4812   Universe::heap()-&gt;print_gc_threads_on(st);
4813   WatcherThread* wt = WatcherThread::watcher_thread();
4814   if (wt != NULL) {
4815     wt-&gt;print_on(st);
4816     st-&gt;cr();
4817   }
4818 
4819   st-&gt;flush();
4820 }
4821 
4822 void Threads::print_on_error(Thread* this_thread, outputStream* st, Thread* current, char* buf,
4823                              int buflen, bool* found_current) {
4824   if (this_thread != NULL) {
4825     bool is_current = (current == this_thread);
4826     *found_current = *found_current || is_current;
4827     st-&gt;print(&quot;%s&quot;, is_current ? &quot;=&gt;&quot; : &quot;  &quot;);
4828 
4829     st-&gt;print(PTR_FORMAT, p2i(this_thread));
4830     st-&gt;print(&quot; &quot;);
4831     this_thread-&gt;print_on_error(st, buf, buflen);
4832     st-&gt;cr();
4833   }
4834 }
4835 
4836 class PrintOnErrorClosure : public ThreadClosure {
4837   outputStream* _st;
4838   Thread* _current;
4839   char* _buf;
4840   int _buflen;
4841   bool* _found_current;
4842  public:
4843   PrintOnErrorClosure(outputStream* st, Thread* current, char* buf,
4844                       int buflen, bool* found_current) :
4845    _st(st), _current(current), _buf(buf), _buflen(buflen), _found_current(found_current) {}
4846 
4847   virtual void do_thread(Thread* thread) {
4848     Threads::print_on_error(thread, _st, _current, _buf, _buflen, _found_current);
4849   }
4850 };
4851 
4852 // Threads::print_on_error() is called by fatal error handler. It&#39;s possible
4853 // that VM is not at safepoint and/or current thread is inside signal handler.
4854 // Don&#39;t print stack trace, as the stack may not be walkable. Don&#39;t allocate
4855 // memory (even in resource area), it might deadlock the error handler.
4856 void Threads::print_on_error(outputStream* st, Thread* current, char* buf,
4857                              int buflen) {
4858   ThreadsSMRSupport::print_info_on(st);
4859   st-&gt;cr();
4860 
4861   bool found_current = false;
4862   st-&gt;print_cr(&quot;Java Threads: ( =&gt; current thread )&quot;);
4863   ALL_JAVA_THREADS(thread) {
4864     print_on_error(thread, st, current, buf, buflen, &amp;found_current);
4865   }
4866   st-&gt;cr();
4867 
4868   st-&gt;print_cr(&quot;Other Threads:&quot;);
4869   print_on_error(VMThread::vm_thread(), st, current, buf, buflen, &amp;found_current);
4870   print_on_error(WatcherThread::watcher_thread(), st, current, buf, buflen, &amp;found_current);
4871 
4872   PrintOnErrorClosure print_closure(st, current, buf, buflen, &amp;found_current);
4873   Universe::heap()-&gt;gc_threads_do(&amp;print_closure);
4874 
4875   if (!found_current) {
4876     st-&gt;cr();
4877     st-&gt;print(&quot;=&gt;&quot; PTR_FORMAT &quot; (exited) &quot;, p2i(current));
4878     current-&gt;print_on_error(st, buf, buflen);
4879     st-&gt;cr();
4880   }
4881   st-&gt;cr();
4882 
4883   st-&gt;print_cr(&quot;Threads with active compile tasks:&quot;);
4884   print_threads_compiling(st, buf, buflen);
4885 }
4886 
4887 void Threads::print_threads_compiling(outputStream* st, char* buf, int buflen, bool short_form) {
4888   ALL_JAVA_THREADS(thread) {
4889     if (thread-&gt;is_Compiler_thread()) {
4890       CompilerThread* ct = (CompilerThread*) thread;
4891 
4892       // Keep task in local variable for NULL check.
4893       // ct-&gt;_task might be set to NULL by concurring compiler thread
4894       // because it completed the compilation. The task is never freed,
4895       // though, just returned to a free list.
4896       CompileTask* task = ct-&gt;task();
4897       if (task != NULL) {
4898         thread-&gt;print_name_on_error(st, buf, buflen);
4899         st-&gt;print(&quot;  &quot;);
4900         task-&gt;print(st, NULL, short_form, true);
4901       }
4902     }
4903   }
4904 }
4905 
4906 
4907 // Internal SpinLock and Mutex
4908 // Based on ParkEvent
4909 
4910 // Ad-hoc mutual exclusion primitives: SpinLock and Mux
4911 //
4912 // We employ SpinLocks _only for low-contention, fixed-length
4913 // short-duration critical sections where we&#39;re concerned
4914 // about native mutex_t or HotSpot Mutex:: latency.
4915 // The mux construct provides a spin-then-block mutual exclusion
4916 // mechanism.
4917 //
4918 // Testing has shown that contention on the ListLock guarding gFreeList
4919 // is common.  If we implement ListLock as a simple SpinLock it&#39;s common
4920 // for the JVM to devolve to yielding with little progress.  This is true
4921 // despite the fact that the critical sections protected by ListLock are
4922 // extremely short.
4923 //
4924 // TODO-FIXME: ListLock should be of type SpinLock.
4925 // We should make this a 1st-class type, integrated into the lock
4926 // hierarchy as leaf-locks.  Critically, the SpinLock structure
4927 // should have sufficient padding to avoid false-sharing and excessive
4928 // cache-coherency traffic.
4929 
4930 
4931 typedef volatile int SpinLockT;
4932 
4933 void Thread::SpinAcquire(volatile int * adr, const char * LockName) {
4934   if (Atomic::cmpxchg(adr, 0, 1) == 0) {
4935     return;   // normal fast-path return
4936   }
4937 
4938   // Slow-path : We&#39;ve encountered contention -- Spin/Yield/Block strategy.
4939   int ctr = 0;
4940   int Yields = 0;
4941   for (;;) {
4942     while (*adr != 0) {
4943       ++ctr;
4944       if ((ctr &amp; 0xFFF) == 0 || !os::is_MP()) {
4945         if (Yields &gt; 5) {
4946           os::naked_short_sleep(1);
4947         } else {
4948           os::naked_yield();
4949           ++Yields;
4950         }
4951       } else {
4952         SpinPause();
4953       }
4954     }
4955     if (Atomic::cmpxchg(adr, 0, 1) == 0) return;
4956   }
4957 }
4958 
4959 void Thread::SpinRelease(volatile int * adr) {
4960   assert(*adr != 0, &quot;invariant&quot;);
4961   OrderAccess::fence();      // guarantee at least release consistency.
4962   // Roach-motel semantics.
4963   // It&#39;s safe if subsequent LDs and STs float &quot;up&quot; into the critical section,
4964   // but prior LDs and STs within the critical section can&#39;t be allowed
4965   // to reorder or float past the ST that releases the lock.
4966   // Loads and stores in the critical section - which appear in program
4967   // order before the store that releases the lock - must also appear
4968   // before the store that releases the lock in memory visibility order.
4969   // Conceptually we need a #loadstore|#storestore &quot;release&quot; MEMBAR before
4970   // the ST of 0 into the lock-word which releases the lock, so fence
4971   // more than covers this on all platforms.
4972   *adr = 0;
4973 }
4974 
4975 // muxAcquire and muxRelease:
4976 //
4977 // *  muxAcquire and muxRelease support a single-word lock-word construct.
4978 //    The LSB of the word is set IFF the lock is held.
4979 //    The remainder of the word points to the head of a singly-linked list
4980 //    of threads blocked on the lock.
4981 //
4982 // *  The current implementation of muxAcquire-muxRelease uses its own
4983 //    dedicated Thread._MuxEvent instance.  If we&#39;re interested in
4984 //    minimizing the peak number of extant ParkEvent instances then
4985 //    we could eliminate _MuxEvent and &quot;borrow&quot; _ParkEvent as long
4986 //    as certain invariants were satisfied.  Specifically, care would need
4987 //    to be taken with regards to consuming unpark() &quot;permits&quot;.
4988 //    A safe rule of thumb is that a thread would never call muxAcquire()
4989 //    if it&#39;s enqueued (cxq, EntryList, WaitList, etc) and will subsequently
4990 //    park().  Otherwise the _ParkEvent park() operation in muxAcquire() could
4991 //    consume an unpark() permit intended for monitorenter, for instance.
4992 //    One way around this would be to widen the restricted-range semaphore
4993 //    implemented in park().  Another alternative would be to provide
4994 //    multiple instances of the PlatformEvent() for each thread.  One
4995 //    instance would be dedicated to muxAcquire-muxRelease, for instance.
4996 //
4997 // *  Usage:
4998 //    -- Only as leaf locks
4999 //    -- for short-term locking only as muxAcquire does not perform
5000 //       thread state transitions.
5001 //
5002 // Alternatives:
5003 // *  We could implement muxAcquire and muxRelease with MCS or CLH locks
5004 //    but with parking or spin-then-park instead of pure spinning.
5005 // *  Use Taura-Oyama-Yonenzawa locks.
5006 // *  It&#39;s possible to construct a 1-0 lock if we encode the lockword as
5007 //    (List,LockByte).  Acquire will CAS the full lockword while Release
5008 //    will STB 0 into the LockByte.  The 1-0 scheme admits stranding, so
5009 //    acquiring threads use timers (ParkTimed) to detect and recover from
5010 //    the stranding window.  Thread/Node structures must be aligned on 256-byte
5011 //    boundaries by using placement-new.
5012 // *  Augment MCS with advisory back-link fields maintained with CAS().
5013 //    Pictorially:  LockWord -&gt; T1 &lt;-&gt; T2 &lt;-&gt; T3 &lt;-&gt; ... &lt;-&gt; Tn &lt;-&gt; Owner.
5014 //    The validity of the backlinks must be ratified before we trust the value.
5015 //    If the backlinks are invalid the exiting thread must back-track through the
5016 //    the forward links, which are always trustworthy.
5017 // *  Add a successor indication.  The LockWord is currently encoded as
5018 //    (List, LOCKBIT:1).  We could also add a SUCCBIT or an explicit _succ variable
5019 //    to provide the usual futile-wakeup optimization.
5020 //    See RTStt for details.
5021 //
5022 
5023 
5024 const intptr_t LOCKBIT = 1;
5025 
5026 void Thread::muxAcquire(volatile intptr_t * Lock, const char * LockName) {
5027   intptr_t w = Atomic::cmpxchg(Lock, (intptr_t)0, LOCKBIT);
5028   if (w == 0) return;
5029   if ((w &amp; LOCKBIT) == 0 &amp;&amp; Atomic::cmpxchg(Lock, w, w|LOCKBIT) == w) {
5030     return;
5031   }
5032 
5033   ParkEvent * const Self = Thread::current()-&gt;_MuxEvent;
5034   assert((intptr_t(Self) &amp; LOCKBIT) == 0, &quot;invariant&quot;);
5035   for (;;) {
5036     int its = (os::is_MP() ? 100 : 0) + 1;
5037 
5038     // Optional spin phase: spin-then-park strategy
5039     while (--its &gt;= 0) {
5040       w = *Lock;
5041       if ((w &amp; LOCKBIT) == 0 &amp;&amp; Atomic::cmpxchg(Lock, w, w|LOCKBIT) == w) {
5042         return;
5043       }
5044     }
5045 
5046     Self-&gt;reset();
5047     Self-&gt;OnList = intptr_t(Lock);
5048     // The following fence() isn&#39;t _strictly necessary as the subsequent
5049     // CAS() both serializes execution and ratifies the fetched *Lock value.
5050     OrderAccess::fence();
5051     for (;;) {
5052       w = *Lock;
5053       if ((w &amp; LOCKBIT) == 0) {
5054         if (Atomic::cmpxchg(Lock, w, w|LOCKBIT) == w) {
5055           Self-&gt;OnList = 0;   // hygiene - allows stronger asserts
5056           return;
5057         }
5058         continue;      // Interference -- *Lock changed -- Just retry
5059       }
5060       assert(w &amp; LOCKBIT, &quot;invariant&quot;);
5061       Self-&gt;ListNext = (ParkEvent *) (w &amp; ~LOCKBIT);
5062       if (Atomic::cmpxchg(Lock, w, intptr_t(Self)|LOCKBIT) == w) break;
5063     }
5064 
5065     while (Self-&gt;OnList != 0) {
5066       Self-&gt;park();
5067     }
5068   }
5069 }
5070 
5071 // Release() must extract a successor from the list and then wake that thread.
5072 // It can &quot;pop&quot; the front of the list or use a detach-modify-reattach (DMR) scheme
5073 // similar to that used by ParkEvent::Allocate() and ::Release().  DMR-based
5074 // Release() would :
5075 // (A) CAS() or swap() null to *Lock, releasing the lock and detaching the list.
5076 // (B) Extract a successor from the private list &quot;in-hand&quot;
5077 // (C) attempt to CAS() the residual back into *Lock over null.
5078 //     If there were any newly arrived threads and the CAS() would fail.
5079 //     In that case Release() would detach the RATs, re-merge the list in-hand
5080 //     with the RATs and repeat as needed.  Alternately, Release() might
5081 //     detach and extract a successor, but then pass the residual list to the wakee.
5082 //     The wakee would be responsible for reattaching and remerging before it
5083 //     competed for the lock.
5084 //
5085 // Both &quot;pop&quot; and DMR are immune from ABA corruption -- there can be
5086 // multiple concurrent pushers, but only one popper or detacher.
5087 // This implementation pops from the head of the list.  This is unfair,
5088 // but tends to provide excellent throughput as hot threads remain hot.
5089 // (We wake recently run threads first).
5090 //
5091 // All paths through muxRelease() will execute a CAS.
5092 // Release consistency -- We depend on the CAS in muxRelease() to provide full
5093 // bidirectional fence/MEMBAR semantics, ensuring that all prior memory operations
5094 // executed within the critical section are complete and globally visible before the
5095 // store (CAS) to the lock-word that releases the lock becomes globally visible.
5096 void Thread::muxRelease(volatile intptr_t * Lock)  {
5097   for (;;) {
5098     const intptr_t w = Atomic::cmpxchg(Lock, LOCKBIT, (intptr_t)0);
5099     assert(w &amp; LOCKBIT, &quot;invariant&quot;);
5100     if (w == LOCKBIT) return;
5101     ParkEvent * const List = (ParkEvent *) (w &amp; ~LOCKBIT);
5102     assert(List != NULL, &quot;invariant&quot;);
5103     assert(List-&gt;OnList == intptr_t(Lock), &quot;invariant&quot;);
5104     ParkEvent * const nxt = List-&gt;ListNext;
5105     guarantee((intptr_t(nxt) &amp; LOCKBIT) == 0, &quot;invariant&quot;);
5106 
5107     // The following CAS() releases the lock and pops the head element.
5108     // The CAS() also ratifies the previously fetched lock-word value.
5109     if (Atomic::cmpxchg(Lock, w, intptr_t(nxt)) != w) {
5110       continue;
5111     }
5112     List-&gt;OnList = 0;
5113     OrderAccess::fence();
5114     List-&gt;unpark();
5115     return;
5116   }
5117 }
5118 
5119 
5120 void Threads::verify() {
5121   ALL_JAVA_THREADS(p) {
5122     p-&gt;verify();
5123   }
5124   VMThread* thread = VMThread::vm_thread();
5125   if (thread != NULL) thread-&gt;verify();
5126 }
5127 
5128 void JavaThread::allocate_scoped_hash_table(int count) {
5129   if (count &gt; 0) {
5130     _scopedCache = oopFactory::new_objectArray(count, this);
5131   }
5132 }
    </pre>
  </body>
</html>