<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames src/hotspot/share/runtime/thread.hpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
    <script type="text/javascript" src="../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>   1 /*
   2  * Copyright (c) 1997, 2019, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
  23  */
  24 
  25 #ifndef SHARE_RUNTIME_THREAD_HPP
  26 #define SHARE_RUNTIME_THREAD_HPP
  27 
  28 #include &quot;jni.h&quot;
  29 #include &quot;code/compiledMethod.hpp&quot;
  30 #include &quot;gc/shared/gcThreadLocalData.hpp&quot;
  31 #include &quot;gc/shared/threadLocalAllocBuffer.hpp&quot;
  32 #include &quot;memory/allocation.hpp&quot;
  33 #include &quot;oops/oop.hpp&quot;
  34 #include &quot;prims/jvmtiExport.hpp&quot;
  35 #include &quot;runtime/continuation.hpp&quot;
  36 #include &quot;runtime/frame.hpp&quot;
  37 #include &quot;runtime/globals.hpp&quot;
  38 #include &quot;runtime/handshake.hpp&quot;
  39 #include &quot;runtime/javaFrameAnchor.hpp&quot;
  40 #include &quot;runtime/jniHandles.hpp&quot;
  41 #include &quot;runtime/mutexLocker.hpp&quot;
  42 #include &quot;runtime/os.hpp&quot;
  43 #include &quot;runtime/osThread.hpp&quot;
  44 #include &quot;runtime/park.hpp&quot;
  45 #include &quot;runtime/stubRoutines.hpp&quot;
  46 #include &quot;runtime/threadHeapSampler.hpp&quot;
  47 #include &quot;runtime/threadLocalStorage.hpp&quot;
  48 #include &quot;runtime/threadStatisticalInfo.hpp&quot;
  49 #include &quot;runtime/unhandledOops.hpp&quot;
  50 #include &quot;utilities/align.hpp&quot;
  51 #include &quot;utilities/exceptions.hpp&quot;
  52 #include &quot;utilities/globalDefinitions.hpp&quot;
  53 #include &quot;utilities/macros.hpp&quot;
  54 #ifdef ZERO
  55 # include &quot;stack_zero.hpp&quot;
  56 #endif
  57 #if INCLUDE_JFR
  58 #include &quot;jfr/support/jfrThreadExtension.hpp&quot;
  59 #endif
  60 
  61 
  62 class SafeThreadsListPtr;
  63 class ThreadSafepointState;
  64 class ThreadsList;
  65 class ThreadsSMRSupport;
  66 
  67 class JvmtiRawMonitor;
  68 class JvmtiThreadState;
  69 class ThreadStatistics;
  70 class ConcurrentLocksDump;
  71 class ParkEvent;
  72 class Parker;
  73 class MonitorInfo;
  74 
  75 class ciEnv;
  76 class CompileThread;
  77 class CompileLog;
  78 class CompileTask;
  79 class CompileQueue;
  80 class CompilerCounters;
  81 
  82 class vframeArray;
  83 class vframe;
  84 class javaVFrame;
  85 
  86 class DeoptResourceMark;
  87 class jvmtiDeferredLocalVariableSet;
  88 
  89 class ThreadClosure;
  90 class ICRefillVerifier;
  91 class IdealGraphPrinter;
  92 
  93 class JVMCIEnv;
  94 class JVMCIPrimitiveArray;
  95 
  96 class Metadata;
  97 class ResourceArea;
  98 
  99 DEBUG_ONLY(class ResourceMark;)
 100 
 101 class WorkerThread;
 102 
 103 // Class hierarchy
 104 // - Thread
 105 //   - JavaThread
 106 //     - various subclasses eg CompilerThread, ServiceThread
 107 //   - NonJavaThread
 108 //     - NamedThread
 109 //       - VMThread
 110 //       - ConcurrentGCThread
 111 //       - WorkerThread
 112 //         - GangWorker
 113 //     - WatcherThread
 114 //     - JfrThreadSampler
 115 //
 116 // All Thread subclasses must be either JavaThread or NonJavaThread.
 117 // This means !t-&gt;is_Java_thread() iff t is a NonJavaThread, or t is
 118 // a partially constructed/destroyed Thread.
 119 
 120 // Thread execution sequence and actions:
 121 // All threads:
 122 //  - thread_native_entry  // per-OS native entry point
 123 //    - stack initialization
 124 //    - other OS-level initialization (signal masks etc)
 125 //    - handshake with creating thread (if not started suspended)
 126 //    - this-&gt;call_run()  // common shared entry point
 127 //      - shared common initialization
 128 //      - this-&gt;pre_run()  // virtual per-thread-type initialization
 129 //      - this-&gt;run()      // virtual per-thread-type &quot;main&quot; logic
 130 //      - shared common tear-down
 131 //      - this-&gt;post_run()  // virtual per-thread-type tear-down
 132 //      - // &#39;this&#39; no longer referenceable
 133 //    - OS-level tear-down (minimal)
 134 //    - final logging
 135 //
 136 // For JavaThread:
 137 //   - this-&gt;run()  // virtual but not normally overridden
 138 //     - this-&gt;thread_main_inner()  // extra call level to ensure correct stack calculations
 139 //       - this-&gt;entry_point()  // set differently for each kind of JavaThread
 140 
 141 class Thread: public ThreadShadow {
 142   friend class VMStructs;
 143   friend class JVMCIVMStructs;
 144  private:
 145 
 146 #ifndef USE_LIBRARY_BASED_TLS_ONLY
 147   // Current thread is maintained as a thread-local variable
 148   static THREAD_LOCAL Thread* _thr_current;
 149 #endif
 150 
 151   int _nmethod_disarm_value;
 152 
 153  public:
 154   int nmethod_disarm_value() {
 155     return _nmethod_disarm_value;
 156   }
 157 
 158   void set_nmethod_disarm_value(int value) {
 159     _nmethod_disarm_value = value;
 160   }
 161 
 162   static ByteSize nmethod_disarmed_offset() {
 163     return byte_offset_of(Thread, _nmethod_disarm_value);
 164   }
 165 
 166  private:
 167   // Thread local data area available to the GC. The internal
 168   // structure and contents of this data area is GC-specific.
 169   // Only GC and GC barrier code should access this data area.
 170   GCThreadLocalData _gc_data;
 171 
 172  public:
 173   static ByteSize gc_data_offset() {
 174     return byte_offset_of(Thread, _gc_data);
 175   }
 176 
 177   template &lt;typename T&gt; T* gc_data() {
 178     STATIC_ASSERT(sizeof(T) &lt;= sizeof(_gc_data));
 179     return reinterpret_cast&lt;T*&gt;(&amp;_gc_data);
 180   }
 181 
 182   // Exception handling
 183   // (Note: _pending_exception and friends are in ThreadShadow)
 184   //oop       _pending_exception;                // pending exception for current thread
 185   // const char* _exception_file;                   // file information for exception (debugging only)
 186   // int         _exception_line;                   // line information for exception (debugging only)
 187  protected:
 188 
 189   DEBUG_ONLY(static Thread* _starting_thread;)
 190 
 191   // Support for forcing alignment of thread objects for biased locking
 192   void*       _real_malloc_address;
 193 
 194   // JavaThread lifecycle support:
 195   friend class SafeThreadsListPtr;  // for _threads_list_ptr, cmpxchg_threads_hazard_ptr(), {dec_,inc_,}nested_threads_hazard_ptr_cnt(), {g,s}et_threads_hazard_ptr(), inc_nested_handle_cnt(), tag_hazard_ptr() access
 196   friend class ScanHazardPtrGatherProtectedThreadsClosure;  // for cmpxchg_threads_hazard_ptr(), get_threads_hazard_ptr(), is_hazard_ptr_tagged() access
 197   friend class ScanHazardPtrGatherThreadsListClosure;  // for get_threads_hazard_ptr(), untag_hazard_ptr() access
 198   friend class ScanHazardPtrPrintMatchingThreadsClosure;  // for get_threads_hazard_ptr(), is_hazard_ptr_tagged() access
 199   friend class ThreadsSMRSupport;  // for _nested_threads_hazard_ptr_cnt, _threads_hazard_ptr, _threads_list_ptr access
 200 
 201   ThreadsList* volatile _threads_hazard_ptr;
 202   SafeThreadsListPtr*   _threads_list_ptr;
 203   ThreadsList*          cmpxchg_threads_hazard_ptr(ThreadsList* exchange_value, ThreadsList* compare_value);
 204   ThreadsList*          get_threads_hazard_ptr();
 205   void                  set_threads_hazard_ptr(ThreadsList* new_list);
 206   static bool           is_hazard_ptr_tagged(ThreadsList* list) {
 207     return (intptr_t(list) &amp; intptr_t(1)) == intptr_t(1);
 208   }
 209   static ThreadsList*   tag_hazard_ptr(ThreadsList* list) {
 210     return (ThreadsList*)(intptr_t(list) | intptr_t(1));
 211   }
 212   static ThreadsList*   untag_hazard_ptr(ThreadsList* list) {
 213     return (ThreadsList*)(intptr_t(list) &amp; ~intptr_t(1));
 214   }
 215   // This field is enabled via -XX:+EnableThreadSMRStatistics:
 216   uint _nested_threads_hazard_ptr_cnt;
 217   void dec_nested_threads_hazard_ptr_cnt() {
 218     assert(_nested_threads_hazard_ptr_cnt != 0, &quot;mismatched {dec,inc}_nested_threads_hazard_ptr_cnt()&quot;);
 219     _nested_threads_hazard_ptr_cnt--;
 220   }
 221   void inc_nested_threads_hazard_ptr_cnt() {
 222     _nested_threads_hazard_ptr_cnt++;
 223   }
 224   uint nested_threads_hazard_ptr_cnt() {
 225     return _nested_threads_hazard_ptr_cnt;
 226   }
 227 
 228  public:
 229   void* operator new(size_t size) throw() { return allocate(size, true); }
 230   void* operator new(size_t size, const std::nothrow_t&amp; nothrow_constant) throw() {
 231     return allocate(size, false); }
 232   void  operator delete(void* p);
 233 
 234  protected:
 235   static void* allocate(size_t size, bool throw_excpt, MEMFLAGS flags = mtThread);
 236  private:
 237 
 238   // ***************************************************************
 239   // Suspend and resume support
 240   // ***************************************************************
 241   //
 242   // VM suspend/resume no longer exists - it was once used for various
 243   // things including safepoints but was deprecated and finally removed
 244   // in Java 7. Because VM suspension was considered &quot;internal&quot; Java-level
 245   // suspension was considered &quot;external&quot;, and this legacy naming scheme
 246   // remains.
 247   //
 248   // External suspend/resume requests come from JVM_SuspendThread,
 249   // JVM_ResumeThread, JVMTI SuspendThread, and finally JVMTI
 250   // ResumeThread. External
 251   // suspend requests cause _external_suspend to be set and external
 252   // resume requests cause _external_suspend to be cleared.
 253   // External suspend requests do not nest on top of other external
 254   // suspend requests. The higher level APIs reject suspend requests
 255   // for already suspended threads.
 256   //
 257   // The external_suspend
 258   // flag is checked by has_special_runtime_exit_condition() and java thread
 259   // will self-suspend when handle_special_runtime_exit_condition() is
 260   // called. Most uses of the _thread_blocked state in JavaThreads are
 261   // considered the same as being externally suspended; if the blocking
 262   // condition lifts, the JavaThread will self-suspend. Other places
 263   // where VM checks for external_suspend include:
 264   //   + mutex granting (do not enter monitors when thread is suspended)
 265   //   + state transitions from _thread_in_native
 266   //
 267   // In general, java_suspend() does not wait for an external suspend
 268   // request to complete. When it returns, the only guarantee is that
 269   // the _external_suspend field is true.
 270   //
 271   // wait_for_ext_suspend_completion() is used to wait for an external
 272   // suspend request to complete. External suspend requests are usually
 273   // followed by some other interface call that requires the thread to
 274   // be quiescent, e.g., GetCallTrace(). By moving the &quot;wait time&quot; into
 275   // the interface that requires quiescence, we give the JavaThread a
 276   // chance to self-suspend before we need it to be quiescent. This
 277   // improves overall suspend/query performance.
 278   //
 279   // _suspend_flags controls the behavior of java_ suspend/resume.
 280   // It must be set under the protection of SR_lock. Read from the flag is
 281   // OK without SR_lock as long as the value is only used as a hint.
 282   // (e.g., check _external_suspend first without lock and then recheck
 283   // inside SR_lock and finish the suspension)
 284   //
 285   // _suspend_flags is also overloaded for other &quot;special conditions&quot; so
 286   // that a single check indicates whether any special action is needed
 287   // eg. for async exceptions.
 288   // -------------------------------------------------------------------
 289   // Notes:
 290   // 1. The suspend/resume logic no longer uses ThreadState in OSThread
 291   // but we still update its value to keep other part of the system (mainly
 292   // JVMTI) happy. ThreadState is legacy code (see notes in
 293   // osThread.hpp).
 294   //
 295   // 2. It would be more natural if set_external_suspend() is private and
 296   // part of java_suspend(), but that probably would affect the suspend/query
 297   // performance. Need more investigation on this.
 298 
 299   // suspend/resume lock: used for self-suspend
 300   Monitor* _SR_lock;
 301 
 302  protected:
 303   enum SuspendFlags {
 304     // NOTE: avoid using the sign-bit as cc generates different test code
 305     //       when the sign-bit is used, and sometimes incorrectly - see CR 6398077
 306 
 307     _external_suspend       = 0x20000000U, // thread is asked to self suspend
 308     _ext_suspended          = 0x40000000U, // thread has self-suspended
 309 
 310     _has_async_exception    = 0x00000001U, // there is a pending async exception
 311     _critical_native_unlock = 0x00000002U, // Must call back to unlock JNI critical lock
 312 
 313     _trace_flag             = 0x00000004U  // call tracing backend
 314   };
 315 
 316   // various suspension related flags - atomically updated
 317   // overloaded for async exception checking in check_special_condition_for_native_trans.
 318   volatile uint32_t _suspend_flags;
 319 
 320  private:
 321   int _num_nested_signal;
 322 
 323   DEBUG_ONLY(bool _suspendible_thread;)
 324 
 325  public:
 326   void enter_signal_handler() { _num_nested_signal++; }
 327   void leave_signal_handler() { _num_nested_signal--; }
 328   bool is_inside_signal_handler() const { return _num_nested_signal &gt; 0; }
 329 
 330   // Determines if a heap allocation failure will be retried
 331   // (e.g., by deoptimizing and re-executing in the interpreter).
 332   // In this case, the failed allocation must raise
 333   // Universe::out_of_memory_error_retry() and omit side effects
 334   // such as JVMTI events and handling -XX:+HeapDumpOnOutOfMemoryError
 335   // and -XX:OnOutOfMemoryError.
 336   virtual bool in_retryable_allocation() const { return false; }
 337 
 338 #ifdef ASSERT
 339   void set_suspendible_thread() {
 340     _suspendible_thread = true;
 341   }
 342 
 343   void clear_suspendible_thread() {
 344     _suspendible_thread = false;
 345   }
 346 
 347   bool is_suspendible_thread() { return _suspendible_thread; }
 348 #endif
 349 
 350  private:
 351   // Active_handles points to a block of handles
 352   JNIHandleBlock* _active_handles;
 353 
 354   // One-element thread local free list
 355   JNIHandleBlock* _free_handle_block;
 356 
 357   // Point to the last handle mark
 358   HandleMark* _last_handle_mark;
 359 
 360   // Claim value for parallel iteration over threads.
 361   uintx _threads_do_token;
 362 
 363   // Support for GlobalCounter
 364  private:
 365   volatile uintx _rcu_counter;
 366  public:
 367   volatile uintx* get_rcu_counter() {
 368     return &amp;_rcu_counter;
 369   }
 370 
 371  public:
 372   void set_last_handle_mark(HandleMark* mark)   { _last_handle_mark = mark; }
 373   HandleMark* last_handle_mark() const          { return _last_handle_mark; }
 374  private:
 375 
 376 #ifdef ASSERT
 377   ICRefillVerifier* _missed_ic_stub_refill_verifier;
 378 
 379  public:
 380   ICRefillVerifier* missed_ic_stub_refill_verifier() {
 381     return _missed_ic_stub_refill_verifier;
 382   }
 383 
 384   void set_missed_ic_stub_refill_verifier(ICRefillVerifier* verifier) {
 385     _missed_ic_stub_refill_verifier = verifier;
 386   }
 387 #endif // ASSERT
 388 
 389  private:
 390 
 391   // Debug support for checking if code allows safepoints or not.
 392   // Safepoints in the VM can happen because of allocation, invoking a VM operation, or blocking on
 393   // mutex, or blocking on an object synchronizer (Java locking).
 394   // If _no_safepoint_count is non-zero, then an assertion failure will happen in any of
 395   // the above cases.
 396   //
 397   // The class NoSafepointVerifier is used to set this counter.
 398   //
 399   NOT_PRODUCT(int _no_safepoint_count;)         // If 0, thread allow a safepoint to happen
 400 
 401  private:
 402   // Used by SkipGCALot class.
 403   NOT_PRODUCT(bool _skip_gcalot;)               // Should we elide gc-a-lot?
 404 
 405   friend class GCLocker;
 406   friend class NoSafepointVerifier;
 407   friend class PauseNoSafepointVerifier;
 408 
 409   volatile void* _polling_page;                 // Thread local polling page
 410 
 411   ThreadLocalAllocBuffer _tlab;                 // Thread-local eden
 412   jlong _allocated_bytes;                       // Cumulative number of bytes allocated on
 413                                                 // the Java heap
 414   ThreadHeapSampler _heap_sampler;              // For use when sampling the memory.
 415 
 416   ThreadStatisticalInfo _statistical_info;      // Statistics about the thread
 417 
 418   JFR_ONLY(DEFINE_THREAD_LOCAL_FIELD_JFR;)      // Thread-local data for jfr
 419 
 420   int   _vm_operation_started_count;            // VM_Operation support
 421   int   _vm_operation_completed_count;          // VM_Operation support
 422 
 423   ObjectMonitor* _current_pending_monitor;      // ObjectMonitor this thread
 424                                                 // is waiting to lock
 425   bool _current_pending_monitor_is_from_java;   // locking is from Java code
 426   JvmtiRawMonitor* _current_pending_raw_monitor; // JvmtiRawMonitor this thread
 427                                                  // is waiting to lock
 428 
 429 
 430   // ObjectMonitor on which this thread called Object.wait()
 431   ObjectMonitor* _current_waiting_monitor;
 432 
 433   // Per-thread ObjectMonitor lists:
 434  public:
 435   ObjectMonitor* om_free_list;                  // SLL of free ObjectMonitors
 436   int om_free_count;                            // # on om_free_list
 437   int om_free_provision;                        // # to try to allocate next
 438   ObjectMonitor* om_in_use_list;                // SLL of in-use ObjectMonitors
 439   int om_in_use_count;                          // # on om_in_use_list
 440 
 441 #ifdef ASSERT
 442  private:
 443   volatile uint64_t _visited_for_critical_count;
 444 
 445  public:
 446   void set_visited_for_critical_count(uint64_t safepoint_id) {
 447     assert(_visited_for_critical_count == 0, &quot;Must be reset before set&quot;);
 448     assert((safepoint_id &amp; 0x1) == 1, &quot;Must be odd&quot;);
 449     _visited_for_critical_count = safepoint_id;
 450   }
 451   void reset_visited_for_critical_count(uint64_t safepoint_id) {
 452     assert(_visited_for_critical_count == safepoint_id, &quot;Was not visited&quot;);
 453     _visited_for_critical_count = 0;
 454   }
 455   bool was_visited_for_critical_count(uint64_t safepoint_id) const {
 456     return _visited_for_critical_count == safepoint_id;
 457   }
 458 #endif
 459 
 460  public:
 461   enum {
 462     is_definitely_current_thread = true
 463   };
 464 
 465   // Constructor
 466   Thread();
 467   virtual ~Thread() = 0;        // Thread is abstract.
 468 
 469   // Manage Thread::current()
 470   void initialize_thread_current();
 471   static void clear_thread_current(); // TLS cleanup needed before threads terminate
 472 
 473  protected:
 474   // To be implemented by children.
 475   virtual void run() = 0;
 476   virtual void pre_run() = 0;
 477   virtual void post_run() = 0;  // Note: Thread must not be deleted prior to calling this!
 478 
 479 #ifdef ASSERT
 480   enum RunState {
 481     PRE_CALL_RUN,
 482     CALL_RUN,
 483     PRE_RUN,
 484     RUN,
 485     POST_RUN
 486     // POST_CALL_RUN - can&#39;t define this one as &#39;this&#39; may be deleted when we want to set it
 487   };
 488   RunState _run_state;  // for lifecycle checks
 489 #endif
 490 
 491 
 492  public:
 493   // invokes &lt;ChildThreadClass&gt;::run(), with common preparations and cleanups.
 494   void call_run();
 495 
 496   // Testers
 497   virtual bool is_VM_thread()       const            { return false; }
 498   virtual bool is_Java_thread()     const            { return false; }
 499   virtual bool is_Compiler_thread() const            { return false; }
 500   virtual bool is_Code_cache_sweeper_thread() const  { return false; }
 501   virtual bool is_service_thread() const             { return false; }
 502   virtual bool is_hidden_from_external_view() const  { return false; }
 503   virtual bool is_jvmti_agent_thread() const         { return false; }
 504   // True iff the thread can perform GC operations at a safepoint.
 505   // Generally will be true only of VM thread and parallel GC WorkGang
 506   // threads.
 507   virtual bool is_GC_task_thread() const             { return false; }
 508   virtual bool is_Watcher_thread() const             { return false; }
 509   virtual bool is_ConcurrentGC_thread() const        { return false; }
 510   virtual bool is_Named_thread() const               { return false; }
 511   virtual bool is_Worker_thread() const              { return false; }
 512 
 513   // Can this thread make Java upcalls
 514   virtual bool can_call_java() const                 { return false; }
 515 
 516   // Is this a JavaThread that is on the VM&#39;s current ThreadsList?
 517   // If so it must participate in the safepoint protocol.
 518   virtual bool is_active_Java_thread() const         { return false; }
 519 
 520   // Casts
 521   virtual WorkerThread* as_Worker_thread() const     { return NULL; }
 522 
 523   virtual char* name() const { return (char*)&quot;Unknown thread&quot;; }
 524 
 525   // Returns the current thread (ASSERTS if NULL)
 526   static inline Thread* current();
 527   // Returns the current thread, or NULL if not attached
 528   static inline Thread* current_or_null();
 529   // Returns the current thread, or NULL if not attached, and is
 530   // safe for use from signal-handlers
 531   static inline Thread* current_or_null_safe();
 532 
 533   // Common thread operations
 534 #ifdef ASSERT
 535   static void check_for_dangling_thread_pointer(Thread *thread);
 536 #endif
 537   static void set_priority(Thread* thread, ThreadPriority priority);
 538   static ThreadPriority get_priority(const Thread* const thread);
 539   static void start(Thread* thread);
 540 
 541   void set_native_thread_name(const char *name) {
 542     assert(Thread::current() == this, &quot;set_native_thread_name can only be called on the current thread&quot;);
 543     os::set_native_thread_name(name);
 544   }
 545 
 546   ObjectMonitor** om_in_use_list_addr()          { return (ObjectMonitor **)&amp;om_in_use_list; }
 547   Monitor* SR_lock() const                       { return _SR_lock; }
 548 
 549   bool has_async_exception() const { return (_suspend_flags &amp; _has_async_exception) != 0; }
 550 
 551   inline void set_suspend_flag(SuspendFlags f);
 552   inline void clear_suspend_flag(SuspendFlags f);
 553 
 554   inline void set_has_async_exception();
 555   inline void clear_has_async_exception();
 556 
 557   bool do_critical_native_unlock() const { return (_suspend_flags &amp; _critical_native_unlock) != 0; }
 558 
 559   inline void set_critical_native_unlock();
 560   inline void clear_critical_native_unlock();
 561 
 562   inline void set_trace_flag();
 563   inline void clear_trace_flag();
 564 
 565   // Support for Unhandled Oop detection
 566   // Add the field for both, fastdebug and debug, builds to keep
 567   // Thread&#39;s fields layout the same.
 568   // Note: CHECK_UNHANDLED_OOPS is defined only for fastdebug build.
 569 #ifdef CHECK_UNHANDLED_OOPS
 570  private:
 571   UnhandledOops* _unhandled_oops;
 572 #elif defined(ASSERT)
 573  private:
 574   void* _unhandled_oops;
 575 #endif
 576 #ifdef CHECK_UNHANDLED_OOPS
 577  public:
 578   UnhandledOops* unhandled_oops() { return _unhandled_oops; }
 579   // Mark oop safe for gc.  It may be stack allocated but won&#39;t move.
 580   void allow_unhandled_oop(oop *op) {
 581     if (CheckUnhandledOops) unhandled_oops()-&gt;allow_unhandled_oop(op);
 582   }
 583   // Clear oops at safepoint so crashes point to unhandled oop violator
 584   void clear_unhandled_oops() {
 585     if (CheckUnhandledOops) unhandled_oops()-&gt;clear_unhandled_oops();
 586   }
 587 #endif // CHECK_UNHANDLED_OOPS
 588 
 589  public:
 590 #ifndef PRODUCT
 591   bool skip_gcalot()           { return _skip_gcalot; }
 592   void set_skip_gcalot(bool v) { _skip_gcalot = v;    }
 593 #endif
 594 
 595   // Installs a pending exception to be inserted later
 596   static void send_async_exception(oop thread_oop, oop java_throwable);
 597 
 598   // Resource area
 599   ResourceArea* resource_area() const            { return _resource_area; }
 600   void set_resource_area(ResourceArea* area)     { _resource_area = area; }
 601 
 602   OSThread* osthread() const                     { return _osthread;   }
 603   void set_osthread(OSThread* thread)            { _osthread = thread; }
 604 
 605   // JNI handle support
 606   JNIHandleBlock* active_handles() const         { return _active_handles; }
 607   void set_active_handles(JNIHandleBlock* block) { _active_handles = block; }
 608   JNIHandleBlock* free_handle_block() const      { return _free_handle_block; }
 609   void set_free_handle_block(JNIHandleBlock* block) { _free_handle_block = block; }
 610 
 611   // Internal handle support
 612   HandleArea* handle_area() const                { return _handle_area; }
 613   void set_handle_area(HandleArea* area)         { _handle_area = area; }
 614 
 615   GrowableArray&lt;Metadata*&gt;* metadata_handles() const          { return _metadata_handles; }
 616   void set_metadata_handles(GrowableArray&lt;Metadata*&gt;* handles){ _metadata_handles = handles; }
 617 
 618   // Thread-Local Allocation Buffer (TLAB) support
 619   ThreadLocalAllocBuffer&amp; tlab()                 { return _tlab; }
 620   void initialize_tlab() {
 621     if (UseTLAB) {
 622       tlab().initialize();
 623     }
 624   }
 625 
 626   jlong allocated_bytes()               { return _allocated_bytes; }
 627   void set_allocated_bytes(jlong value) { _allocated_bytes = value; }
 628   void incr_allocated_bytes(jlong size) { _allocated_bytes += size; }
 629   inline jlong cooked_allocated_bytes();
 630 
 631   ThreadHeapSampler&amp; heap_sampler()     { return _heap_sampler; }
 632 
 633   ThreadStatisticalInfo&amp; statistical_info() { return _statistical_info; }
 634 
 635   JFR_ONLY(DEFINE_THREAD_LOCAL_ACCESSOR_JFR;)
 636 
 637   bool is_trace_suspend()               { return (_suspend_flags &amp; _trace_flag) != 0; }
 638 
 639   // VM operation support
 640   int vm_operation_ticket()                      { return ++_vm_operation_started_count; }
 641   int vm_operation_completed_count()             { return _vm_operation_completed_count; }
 642   void increment_vm_operation_completed_count()  { _vm_operation_completed_count++; }
 643 
 644   // For tracking the heavyweight monitor the thread is pending on.
 645   ObjectMonitor* current_pending_monitor() {
 646     return _current_pending_monitor;
 647   }
 648   void set_current_pending_monitor(ObjectMonitor* monitor) {
 649     _current_pending_monitor = monitor;
 650   }
 651   void set_current_pending_monitor_is_from_java(bool from_java) {
 652     _current_pending_monitor_is_from_java = from_java;
 653   }
 654   bool current_pending_monitor_is_from_java() {
 655     return _current_pending_monitor_is_from_java;
 656   }
 657 
 658   // For tracking the ObjectMonitor on which this thread called Object.wait()
 659   ObjectMonitor* current_waiting_monitor() {
 660     return _current_waiting_monitor;
 661   }
 662   void set_current_waiting_monitor(ObjectMonitor* monitor) {
 663     _current_waiting_monitor = monitor;
 664   }
 665 
 666   // For tracking the Jvmti raw monitor the thread is pending on.
 667   JvmtiRawMonitor* current_pending_raw_monitor() {
 668     return _current_pending_raw_monitor;
 669   }
 670   void set_current_pending_raw_monitor(JvmtiRawMonitor* monitor) {
 671     _current_pending_raw_monitor = monitor;
 672   }
 673 
 674   // GC support
 675   // Apply &quot;f-&gt;do_oop&quot; to all root oops in &quot;this&quot;.
 676   //   Used by JavaThread::oops_do.
 677   // Apply &quot;cf-&gt;do_code_blob&quot; (if !NULL) to all code blobs active in frames
 678   virtual void oops_do(OopClosure* f, CodeBlobClosure* cf);
 679 
 680   // Handles the parallel case for claim_threads_do.
 681  private:
 682   bool claim_par_threads_do(uintx claim_token);
 683  public:
 684   // Requires that &quot;claim_token&quot; is that of the current iteration.
 685   // If &quot;is_par&quot; is false, sets the token of &quot;this&quot; to
 686   // &quot;claim_token&quot;, and returns &quot;true&quot;.  If &quot;is_par&quot; is true,
 687   // uses an atomic instruction to set the current thread&#39;s token to
 688   // &quot;claim_token&quot;, if it is not already.  Returns &quot;true&quot; iff the
 689   // calling thread does the update, this indicates that the calling thread
 690   // has claimed the thread in the current iteration.
 691   bool claim_threads_do(bool is_par, uintx claim_token) {
 692     if (!is_par) {
 693       _threads_do_token = claim_token;
 694       return true;
 695     } else {
 696       return claim_par_threads_do(claim_token);
 697     }
 698   }
 699 
 700   uintx threads_do_token() const { return _threads_do_token; }
 701 
 702   // jvmtiRedefineClasses support
 703   void metadata_handles_do(void f(Metadata*));
 704 
 705   // Used by fast lock support
 706   virtual bool is_lock_owned(address adr) const;
 707 
 708   // Check if address is in the stack of the thread (not just for locks).
 709   // Warning: the method can only be used on the running thread
 710   bool is_in_stack(address adr) const;
 711   // Check if address is in the usable part of the stack (excludes protected
 712   // guard pages)
 713   bool is_in_usable_stack(address adr) const;
 714 
 715   // Sets this thread as starting thread. Returns failure if thread
 716   // creation fails due to lack of memory, too many threads etc.
 717   bool set_as_starting_thread();
 718 
 719 protected:
 720   // OS data associated with the thread
 721   OSThread* _osthread;  // Platform-specific thread information
 722 
 723   // Thread local resource area for temporary allocation within the VM
 724   ResourceArea* _resource_area;
 725 
 726   DEBUG_ONLY(ResourceMark* _current_resource_mark;)
 727 
 728   // Thread local handle area for allocation of handles within the VM
 729   HandleArea* _handle_area;
 730   GrowableArray&lt;Metadata*&gt;* _metadata_handles;
 731 
 732   // Support for stack overflow handling, get_thread, etc.
 733   address          _stack_base;
 734   size_t           _stack_size;
 735   int              _lgrp_id;
 736 
 737   volatile void** polling_page_addr() { return &amp;_polling_page; }
 738 
 739  public:
 740   // Stack overflow support
 741   address stack_base() const           { assert(_stack_base != NULL,&quot;Sanity check&quot;); return _stack_base; }
 742   void    set_stack_base(address base) { _stack_base = base; }
 743   size_t  stack_size() const           { return _stack_size; }
 744   void    set_stack_size(size_t size)  { _stack_size = size; }
 745   address stack_end()  const           { return stack_base() - stack_size(); }
 746   void    record_stack_base_and_size();
 747   void    register_thread_stack_with_NMT() NOT_NMT_RETURN;
 748 
 749   bool    on_local_stack(address adr) const {
 750     // QQQ this has knowledge of direction, ought to be a stack method
 751     return (_stack_base &gt; adr &amp;&amp; adr &gt;= stack_end());
 752   }
 753 
 754   int     lgrp_id() const        { return _lgrp_id; }
 755   void    set_lgrp_id(int value) { _lgrp_id = value; }
 756 
 757   // Printing
 758   void print_on(outputStream* st, bool print_extended_info) const;
 759   virtual void print_on(outputStream* st) const { print_on(st, false); }
 760   void print() const;
 761   virtual void print_on_error(outputStream* st, char* buf, int buflen) const;
 762   void print_value_on(outputStream* st) const;
 763 
 764   // Debug-only code
 765 #ifdef ASSERT
 766  private:
 767   // Deadlock detection support for Mutex locks. List of locks own by thread.
 768   Mutex* _owned_locks;
 769   // Mutex::set_owner_implementation is the only place where _owned_locks is modified,
 770   // thus the friendship
 771   friend class Mutex;
 772   friend class Monitor;
 773 
 774  public:
 775   void print_owned_locks_on(outputStream* st) const;
 776   void print_owned_locks() const                 { print_owned_locks_on(tty);    }
 777   Mutex* owned_locks() const                     { return _owned_locks;          }
 778   bool owns_locks() const                        { return owned_locks() != NULL; }
 779 
 780   // Deadlock detection
 781   ResourceMark* current_resource_mark()          { return _current_resource_mark; }
 782   void set_current_resource_mark(ResourceMark* rm) { _current_resource_mark = rm; }
 783 #endif // ASSERT
 784 
 785   // These functions check conditions on a JavaThread before possibly going to a safepoint,
 786   // including NoSafepointVerifier.
 787   void check_for_valid_safepoint_state() NOT_DEBUG_RETURN;
 788   void check_possible_safepoint() NOT_DEBUG_RETURN;
 789 
 790  private:
 791   volatile int _jvmti_env_iteration_count;
 792 
 793  public:
 794   void entering_jvmti_env_iteration()            { ++_jvmti_env_iteration_count; }
 795   void leaving_jvmti_env_iteration()             { --_jvmti_env_iteration_count; }
 796   bool is_inside_jvmti_env_iteration()           { return _jvmti_env_iteration_count &gt; 0; }
 797 
 798   // Code generation
 799   static ByteSize exception_file_offset()        { return byte_offset_of(Thread, _exception_file); }
 800   static ByteSize exception_line_offset()        { return byte_offset_of(Thread, _exception_line); }
 801   static ByteSize active_handles_offset()        { return byte_offset_of(Thread, _active_handles); }
 802 
 803   static ByteSize stack_base_offset()            { return byte_offset_of(Thread, _stack_base); }
 804   static ByteSize stack_size_offset()            { return byte_offset_of(Thread, _stack_size); }
 805 
 806   static ByteSize polling_page_offset()          { return byte_offset_of(Thread, _polling_page); }
 807 
 808   static ByteSize tlab_start_offset()            { return byte_offset_of(Thread, _tlab) + ThreadLocalAllocBuffer::start_offset(); }
 809   static ByteSize tlab_end_offset()              { return byte_offset_of(Thread, _tlab) + ThreadLocalAllocBuffer::end_offset(); }
 810   static ByteSize tlab_top_offset()              { return byte_offset_of(Thread, _tlab) + ThreadLocalAllocBuffer::top_offset(); }
 811   static ByteSize tlab_pf_top_offset()           { return byte_offset_of(Thread, _tlab) + ThreadLocalAllocBuffer::pf_top_offset(); }
 812 
 813   static ByteSize allocated_bytes_offset()       { return byte_offset_of(Thread, _allocated_bytes); }
 814 
 815   JFR_ONLY(DEFINE_THREAD_LOCAL_OFFSET_JFR;)
 816 
 817  public:
 818   volatile intptr_t _Stalled;
 819   volatile int _TypeTag;
 820   ParkEvent * _ParkEvent;                     // for Object monitors and JVMTI raw monitors
 821   ParkEvent * _MuxEvent;                      // for low-level muxAcquire-muxRelease
 822   int NativeSyncRecursion;                    // diagnostic
 823 
 824   volatile int _OnTrap;                       // Resume-at IP delta
 825   jint _hashStateW;                           // Marsaglia Shift-XOR thread-local RNG
 826   jint _hashStateX;                           // thread-specific hashCode generator state
 827   jint _hashStateY;
 828   jint _hashStateZ;
 829 
 830   // Low-level leaf-lock primitives used to implement synchronization
 831   // and native monitor-mutex infrastructure.
 832   // Not for general synchronization use.
 833   static void SpinAcquire(volatile int * Lock, const char * Name);
 834   static void SpinRelease(volatile int * Lock);
 835   static void muxAcquire(volatile intptr_t * Lock, const char * Name);
 836   static void muxRelease(volatile intptr_t * Lock);
 837 };
 838 
 839 // Inline implementation of Thread::current()
 840 inline Thread* Thread::current() {
 841   Thread* current = current_or_null();
 842   assert(current != NULL, &quot;Thread::current() called on detached thread&quot;);
 843   return current;
 844 }
 845 
 846 inline Thread* Thread::current_or_null() {
 847 #ifndef USE_LIBRARY_BASED_TLS_ONLY
 848   return _thr_current;
 849 #else
 850   if (ThreadLocalStorage::is_initialized()) {
 851     return ThreadLocalStorage::thread();
 852   }
 853   return NULL;
 854 #endif
 855 }
 856 
 857 inline Thread* Thread::current_or_null_safe() {
 858   if (ThreadLocalStorage::is_initialized()) {
 859     return ThreadLocalStorage::thread();
 860   }
 861   return NULL;
 862 }
 863 
 864 class NonJavaThread: public Thread {
 865   friend class VMStructs;
 866 
 867   NonJavaThread* volatile _next;
 868 
 869   class List;
 870   static List _the_list;
 871 
 872   void add_to_the_list();
 873   void remove_from_the_list();
 874 
 875  protected:
 876   virtual void pre_run();
 877   virtual void post_run();
 878 
 879  public:
 880   NonJavaThread();
 881   ~NonJavaThread();
 882 
 883   class Iterator;
 884 };
 885 
 886 // Provides iteration over the list of NonJavaThreads.
 887 // List addition occurs in pre_run(), and removal occurs in post_run(),
 888 // so that only live fully-initialized threads can be found in the list.
 889 // Threads created after an iterator is constructed will not be visited
 890 // by the iterator. The scope of an iterator is a critical section; there
 891 // must be no safepoint checks in that scope.
 892 class NonJavaThread::Iterator : public StackObj {
 893   uint _protect_enter;
 894   NonJavaThread* _current;
 895 
 896   NONCOPYABLE(Iterator);
 897 
 898 public:
 899   Iterator();
 900   ~Iterator();
 901 
 902   bool end() const { return _current == NULL; }
 903   NonJavaThread* current() const { return _current; }
 904   void step();
 905 };
 906 
 907 // Name support for threads.  non-JavaThread subclasses with multiple
 908 // uniquely named instances should derive from this.
 909 class NamedThread: public NonJavaThread {
 910   friend class VMStructs;
 911   enum {
 912     max_name_len = 64
 913   };
 914  private:
 915   char* _name;
 916   // log JavaThread being processed by oops_do
 917   JavaThread* _processed_thread;
 918   uint _gc_id; // The current GC id when a thread takes part in GC
 919 
 920  public:
 921   NamedThread();
 922   ~NamedThread();
 923   // May only be called once per thread.
 924   void set_name(const char* format, ...)  ATTRIBUTE_PRINTF(2, 3);
 925   virtual bool is_Named_thread() const { return true; }
 926   virtual char* name() const { return _name == NULL ? (char*)&quot;Unknown Thread&quot; : _name; }
 927   JavaThread *processed_thread() { return _processed_thread; }
 928   void set_processed_thread(JavaThread *thread) { _processed_thread = thread; }
 929   virtual void print_on(outputStream* st) const;
 930 
 931   void set_gc_id(uint gc_id) { _gc_id = gc_id; }
 932   uint gc_id() { return _gc_id; }
 933 };
 934 
 935 // Worker threads are named and have an id of an assigned work.
 936 class WorkerThread: public NamedThread {
 937  private:
 938   uint _id;
 939  public:
 940   WorkerThread() : _id(0)               { }
 941   virtual bool is_Worker_thread() const { return true; }
 942 
 943   virtual WorkerThread* as_Worker_thread() const {
 944     assert(is_Worker_thread(), &quot;Dubious cast to WorkerThread*?&quot;);
 945     return (WorkerThread*) this;
 946   }
 947 
 948   void set_id(uint work_id)             { _id = work_id; }
 949   uint id() const                       { return _id; }
 950 };
 951 
 952 // A single WatcherThread is used for simulating timer interrupts.
 953 class WatcherThread: public NonJavaThread {
 954   friend class VMStructs;
 955  protected:
 956   virtual void run();
 957 
 958  private:
 959   static WatcherThread* _watcher_thread;
 960 
 961   static bool _startable;
 962   // volatile due to at least one lock-free read
 963   volatile static bool _should_terminate;
 964  public:
 965   enum SomeConstants {
 966     delay_interval = 10                          // interrupt delay in milliseconds
 967   };
 968 
 969   // Constructor
 970   WatcherThread();
 971 
 972   // No destruction allowed
 973   ~WatcherThread() {
 974     guarantee(false, &quot;WatcherThread deletion must fix the race with VM termination&quot;);
 975   }
 976 
 977   // Tester
 978   bool is_Watcher_thread() const                 { return true; }
 979 
 980   // Printing
 981   char* name() const { return (char*)&quot;VM Periodic Task Thread&quot;; }
 982   void print_on(outputStream* st) const;
 983   void unpark();
 984 
 985   // Returns the single instance of WatcherThread
 986   static WatcherThread* watcher_thread()         { return _watcher_thread; }
 987 
 988   // Create and start the single instance of WatcherThread, or stop it on shutdown
 989   static void start();
 990   static void stop();
 991   // Only allow start once the VM is sufficiently initialized
 992   // Otherwise the first task to enroll will trigger the start
 993   static void make_startable();
 994  private:
 995   int sleep() const;
 996 };
 997 
 998 
 999 class CompilerThread;
1000 
1001 typedef void (*ThreadFunction)(JavaThread*, TRAPS);
1002 
1003 class JavaThread: public Thread {
1004   friend class VMStructs;
1005   friend class JVMCIVMStructs;
1006   friend class WhiteBox;
1007   friend class Continuation;
1008  private:
1009   bool           _on_thread_list;                // Is set when this JavaThread is added to the Threads list
1010   oop            _threadObj;                     // The Java level thread object
1011 
1012 #ifdef ASSERT
1013  private:
1014   int _java_call_counter;
1015 
1016  public:
1017   int  java_call_counter()                       { return _java_call_counter; }
1018   void inc_java_call_counter()                   { _java_call_counter++; }
1019   void dec_java_call_counter() {
1020     assert(_java_call_counter &gt; 0, &quot;Invalid nesting of JavaCallWrapper&quot;);
1021     _java_call_counter--;
1022   }
1023  private:  // restore original namespace restriction
1024 #endif  // ifdef ASSERT
1025 
1026 #ifndef PRODUCT
1027  public:
1028   enum {
1029     jump_ring_buffer_size = 16
1030   };
1031  private:  // restore original namespace restriction
1032 #endif
1033 
1034   JavaFrameAnchor _anchor;                       // Encapsulation of current java frame and it state
1035 
1036   ThreadFunction _entry_point;
1037 
1038   JNIEnv        _jni_environment;
1039 
1040   // Deopt support
1041   DeoptResourceMark*  _deopt_mark;               // Holds special ResourceMark for deoptimization
1042 
1043   CompiledMethod*       _deopt_nmethod;         // CompiledMethod that is currently being deoptimized
1044   vframeArray*  _vframe_array_head;              // Holds the heap of the active vframeArrays
1045   vframeArray*  _vframe_array_last;              // Holds last vFrameArray we popped
1046   // Because deoptimization is lazy we must save jvmti requests to set locals
1047   // in compiled frames until we deoptimize and we have an interpreter frame.
1048   // This holds the pointer to array (yeah like there might be more than one) of
1049   // description of compiled vframes that have locals that need to be updated.
1050   GrowableArray&lt;jvmtiDeferredLocalVariableSet*&gt;* _deferred_locals_updates;
1051   GrowableArray&lt;WeakHandle&lt;vm_nmethod_keepalive_data&gt; &gt;* _keepalive_cleanup;
1052 
1053   // Handshake value for fixing 6243940. We need a place for the i2c
1054   // adapter to store the callee Method*. This value is NEVER live
1055   // across a gc point so it does NOT have to be gc&#39;d
1056   // The handshake is open ended since we can&#39;t be certain that it will
1057   // be NULLed. This is because we rarely ever see the race and end up
1058   // in handle_wrong_method which is the backend of the handshake. See
1059   // code in i2c adapters and handle_wrong_method.
1060 
1061   Method*       _callee_target;
1062 
1063   // Used to pass back results to the interpreter or generated code running Java code.
1064   oop           _vm_result;    // oop result is GC-preserved
1065   Metadata*     _vm_result_2;  // non-oop result
1066 
1067   // See ReduceInitialCardMarks: this holds the precise space interval of
1068   // the most recent slow path allocation for which compiled code has
1069   // elided card-marks for performance along the fast-path.
1070   MemRegion     _deferred_card_mark;
1071 
1072   MonitorChunk* _monitor_chunks;                 // Contains the off stack monitors
1073                                                  // allocated during deoptimization
1074                                                  // and by JNI_MonitorEnter/Exit
1075 
1076   // Async. requests support
1077   enum AsyncRequests {
1078     _no_async_condition = 0,
1079     _async_exception,
1080     _async_unsafe_access_error
1081   };
1082   AsyncRequests _special_runtime_exit_condition; // Enum indicating pending async. request
1083   oop           _pending_async_exception;
1084 
1085   // Safepoint support
1086  public:                                         // Expose _thread_state for SafeFetchInt()
1087   volatile JavaThreadState _thread_state;
1088  private:
1089   ThreadSafepointState* _safepoint_state;        // Holds information about a thread during a safepoint
1090   address               _saved_exception_pc;     // Saved pc of instruction where last implicit exception happened
1091 
1092   // JavaThread termination support
1093   enum TerminatedTypes {
1094     _not_terminated = 0xDEAD - 2,
1095     _thread_exiting,                             // JavaThread::exit() has been called for this thread
1096     _thread_terminated,                          // JavaThread is removed from thread list
1097     _vm_exited                                   // JavaThread is still executing native code, but VM is terminated
1098                                                  // only VM_Exit can set _vm_exited
1099   };
1100 
1101   // In general a JavaThread&#39;s _terminated field transitions as follows:
1102   //
1103   //   _not_terminated =&gt; _thread_exiting =&gt; _thread_terminated
1104   //
1105   // _vm_exited is a special value to cover the case of a JavaThread
1106   // executing native code after the VM itself is terminated.
1107   volatile TerminatedTypes _terminated;
1108   // suspend/resume support
1109   volatile bool         _suspend_equivalent;     // Suspend equivalent condition
1110   jint                  _in_deopt_handler;       // count of deoptimization
1111                                                  // handlers thread is in
1112   volatile bool         _doing_unsafe_access;    // Thread may fault due to unsafe access
1113   bool                  _do_not_unlock_if_synchronized;  // Do not unlock the receiver of a synchronized method (since it was
1114                                                          // never locked) when throwing an exception. Used by interpreter only.
1115 
1116   // JNI attach states:
1117   enum JNIAttachStates {
1118     _not_attaching_via_jni = 1,  // thread is not attaching via JNI
1119     _attaching_via_jni,          // thread is attaching via JNI
1120     _attached_via_jni            // thread has attached via JNI
1121   };
1122 
1123   // A regular JavaThread&#39;s _jni_attach_state is _not_attaching_via_jni.
1124   // A native thread that is attaching via JNI starts with a value
1125   // of _attaching_via_jni and transitions to _attached_via_jni.
1126   volatile JNIAttachStates _jni_attach_state;
1127 
1128  public:
1129 
1130   // State of the stack guard pages for this thread.
1131   enum StackGuardState {
1132     stack_guard_unused,         // not needed
1133     stack_guard_reserved_disabled,
1134     stack_guard_yellow_reserved_disabled,// disabled (temporarily) after stack overflow
1135     stack_guard_enabled         // enabled
1136   };
1137 
1138  private:
1139 
1140 #if INCLUDE_JVMCI
1141   // The _pending_* fields below are used to communicate extra information
1142   // from an uncommon trap in JVMCI compiled code to the uncommon trap handler.
1143 
1144   // Communicates the DeoptReason and DeoptAction of the uncommon trap
1145   int       _pending_deoptimization;
1146 
1147   // Specifies whether the uncommon trap is to bci 0 of a synchronized method
1148   // before the monitor has been acquired.
1149   bool      _pending_monitorenter;
1150 
1151   // Specifies if the DeoptReason for the last uncommon trap was Reason_transfer_to_interpreter
1152   bool      _pending_transfer_to_interpreter;
1153 
1154   // True if in a runtime call from compiled code that will deoptimize
1155   // and re-execute a failed heap allocation in the interpreter.
1156   bool      _in_retryable_allocation;
1157 
1158   // An id of a speculation that JVMCI compiled code can use to further describe and
1159   // uniquely identify the  speculative optimization guarded by the uncommon trap
1160   jlong     _pending_failed_speculation;
1161 
1162   // These fields are mutually exclusive in terms of live ranges.
1163   union {
1164     // Communicates the pc at which the most recent implicit exception occurred
1165     // from the signal handler to a deoptimization stub.
1166     address   _implicit_exception_pc;
1167 
1168     // Communicates an alternative call target to an i2c stub from a JavaCall .
1169     address   _alternate_call_target;
1170   } _jvmci;
1171 
1172   // Support for high precision, thread sensitive counters in JVMCI compiled code.
1173   jlong*    _jvmci_counters;
1174 
1175  public:
1176   static jlong* _jvmci_old_thread_counters;
1177   static void collect_counters(jlong* array, int length);
1178   void resize_counters(int current_size, int new_size);
1179   static void resize_all_jvmci_counters(int new_size);
1180 
1181  private:
1182 #endif // INCLUDE_JVMCI
1183 
1184   StackGuardState  _stack_guard_state;
1185 
1186   // Precompute the limit of the stack as used in stack overflow checks.
1187   // We load it from here to simplify the stack overflow check in assembly.
1188   address          _stack_overflow_limit;
1189   address          _reserved_stack_activation;
1190 
1191   // Compiler exception handling (NOTE: The _exception_oop is *NOT* the same as _pending_exception. It is
1192   // used to temp. parsing values into and out of the runtime system during exception handling for compiled
1193   // code)
1194   volatile oop     _exception_oop;               // Exception thrown in compiled code
1195   volatile address _exception_pc;                // PC where exception happened
1196   volatile address _exception_handler_pc;        // PC for handler of exception
1197   volatile int     _is_method_handle_return;     // true (== 1) if the current exception PC is a MethodHandle call site.
1198 
1199  private:
1200   // support for JNI critical regions
1201   jint    _jni_active_critical;                  // count of entries into JNI critical region
1202 
1203   // Checked JNI: function name requires exception check
1204   char* _pending_jni_exception_check_fn;
1205 
1206   // For deadlock detection.
1207   int _depth_first_number;
1208 
1209   // JVMTI PopFrame support
1210   // This is set to popframe_pending to signal that top Java frame should be popped immediately
1211   int _popframe_condition;
1212 
1213   // If reallocation of scalar replaced objects fails, we throw OOM
1214   // and during exception propagation, pop the top
1215   // _frames_to_pop_failed_realloc frames, the ones that reference
1216   // failed reallocations.
1217   int _frames_to_pop_failed_realloc;
1218 
1219   bool _cont_yield; // a continuation yield is in progress
1220   bool _cont_preempt;
1221   FrameInfo _cont_frame;
1222   int _cont_fastpath;
1223   int _held_monitor_count; // used by continuations for fast lock detection
1224 public:
1225   oopDesc* _continuation; // a hack used to make continuation thaw a bit faster; see prepare_thaw
1226 private:
1227 
1228   friend class VMThread;
1229   friend class ThreadWaitTransition;
1230   friend class VM_Exit;
1231 
<a name="1" id="anc1"></a><span class="line-added">1232 public:</span>
<span class="line-added">1233 </span>
<span class="line-added">1234   oop _scopedCache;</span>
<span class="line-added">1235   jlong _scoped_hash_table_shift;</span>
<span class="line-added">1236 </span>
<span class="line-added">1237   void allocate_scoped_hash_table(int count);</span>
<span class="line-added">1238 </span>
1239   void initialize();                             // Initialized the instance variables
1240 
1241  public:
1242   // Constructor
1243   JavaThread(bool is_attaching_via_jni = false); // for main thread and JNI attached threads
1244   JavaThread(ThreadFunction entry_point, size_t stack_size = 0);
1245   ~JavaThread();
1246 
1247 #ifdef ASSERT
1248   // verify this JavaThread hasn&#39;t be published in the Threads::list yet
1249   void verify_not_published();
1250 #endif // ASSERT
1251 
1252   //JNI functiontable getter/setter for JVMTI jni function table interception API.
1253   void set_jni_functions(struct JNINativeInterface_* functionTable) {
1254     _jni_environment.functions = functionTable;
1255   }
1256   struct JNINativeInterface_* get_jni_functions() {
1257     return (struct JNINativeInterface_ *)_jni_environment.functions;
1258   }
1259 
1260   // This function is called at thread creation to allow
1261   // platform specific thread variables to be initialized.
1262   void cache_global_variables();
1263 
1264   // Executes Shutdown.shutdown()
1265   void invoke_shutdown_hooks();
1266 
1267   // Cleanup on thread exit
1268   enum ExitType {
1269     normal_exit,
1270     jni_detach
1271   };
1272   void exit(bool destroy_vm, ExitType exit_type = normal_exit);
1273 
1274   void cleanup_failed_attach_current_thread(bool is_daemon);
1275 
1276   // Testers
1277   virtual bool is_Java_thread() const            { return true;  }
1278   virtual bool can_call_java() const             { return true; }
1279 
1280   virtual bool is_active_Java_thread() const {
1281     return on_thread_list() &amp;&amp; !is_terminated();
1282   }
1283 
1284   // Thread oop. threadObj() can be NULL for initial JavaThread
1285   // (or for threads attached via JNI)
1286   oop threadObj() const                          { return _threadObj; }
1287   void set_threadObj(oop p)                      { _threadObj = p; }
1288 
1289   // Prepare thread and add to priority queue.  If a priority is
1290   // not specified, use the priority of the thread object. Threads_lock
1291   // must be held while this function is called.
1292   void prepare(jobject jni_thread, ThreadPriority prio=NoPriority);
1293 
1294   void set_saved_exception_pc(address pc)        { _saved_exception_pc = pc; }
1295   address saved_exception_pc()                   { return _saved_exception_pc; }
1296 
1297 
1298   ThreadFunction entry_point() const             { return _entry_point; }
1299 
1300   // Allocates a new Java level thread object for this thread. thread_name may be NULL.
1301   void allocate_threadObj(Handle thread_group, const char* thread_name, bool daemon, TRAPS);
1302 
1303   // Last frame anchor routines
1304 
1305   JavaFrameAnchor* frame_anchor(void)            { return &amp;_anchor; }
1306 
1307   // last_Java_sp
1308   bool has_last_Java_frame() const               { return _anchor.has_last_Java_frame(); }
1309   intptr_t* last_Java_sp() const                 { return _anchor.last_Java_sp(); }
1310 
1311   // last_Java_pc
1312 
1313   address last_Java_pc(void)                     { return _anchor.last_Java_pc(); }
1314 
1315   // Safepoint support
1316   inline JavaThreadState thread_state() const;
1317   inline void set_thread_state(JavaThreadState s);
1318   inline void set_thread_state_fence(JavaThreadState s);  // fence after setting thread state
1319   inline ThreadSafepointState* safepoint_state() const;
1320   inline void set_safepoint_state(ThreadSafepointState* state);
1321   inline bool is_at_poll_safepoint();
1322 
1323   // JavaThread termination and lifecycle support:
1324   void smr_delete();
1325   bool on_thread_list() const { return _on_thread_list; }
1326   void set_on_thread_list() { _on_thread_list = true; }
1327 
1328   // thread has called JavaThread::exit() or is terminated
1329   bool is_exiting() const;
1330   // thread is terminated (no longer on the threads list); we compare
1331   // against the two non-terminated values so that a freed JavaThread
1332   // will also be considered terminated.
1333   bool check_is_terminated(TerminatedTypes l_terminated) const {
1334     return l_terminated != _not_terminated &amp;&amp; l_terminated != _thread_exiting;
1335   }
1336   bool is_terminated() const;
1337   void set_terminated(TerminatedTypes t);
1338   // special for Threads::remove() which is static:
1339   void set_terminated_value();
1340   void block_if_vm_exited();
1341 
1342   bool doing_unsafe_access()                     { return _doing_unsafe_access; }
1343   void set_doing_unsafe_access(bool val)         { _doing_unsafe_access = val; }
1344 
1345   bool do_not_unlock_if_synchronized()             { return _do_not_unlock_if_synchronized; }
1346   void set_do_not_unlock_if_synchronized(bool val) { _do_not_unlock_if_synchronized = val; }
1347 
1348   inline void set_polling_page_release(void* poll_value);
1349   inline void set_polling_page(void* poll_value);
1350   inline volatile void* get_polling_page();
1351 
1352   // Continuation support
1353   bool cont_yield() { return _cont_yield; }
1354   void set_cont_yield(bool x) { _cont_yield = x; }
1355   bool cont_fastpath() { return _cont_fastpath != 0; }
1356   void set_cont_fastpath(bool x) { _cont_fastpath = (int)x; }
1357   bool cont_preempt() { return _cont_preempt; }
1358   void set_cont_preempt(bool x) { _cont_preempt = x; }
1359   FrameInfo* cont_frame() { return &amp;_cont_frame; }
1360   int held_monitor_count() { return _held_monitor_count; }
1361   void reset_held_monitor_count() { _held_monitor_count = 0; }
1362   void inc_held_monitor_count() { _held_monitor_count++; }
1363   void dec_held_monitor_count() { /* assert (_held_monitor_count &gt; 0, &quot;&quot;); -- TODO LOOM: currently this does not hold because we don&#39;t handle nesting well */ 
1364                                   _held_monitor_count--; }
1365 
1366  private:
1367   // Support for thread handshake operations
1368   HandshakeState _handshake;
1369  public:
1370   void set_handshake_operation(HandshakeOperation* op) {
1371     _handshake.set_operation(this, op);
1372   }
1373 
1374   bool has_handshake() const {
1375     return _handshake.has_operation();
1376   }
1377 
1378   void handshake_process_by_self() {
1379     _handshake.process_by_self(this);
1380   }
1381 
1382   bool handshake_try_process_by_vmThread() {
1383     return _handshake.try_process_by_vmThread(this);
1384   }
1385 
1386 #ifdef ASSERT
1387   bool is_vmthread_processing_handshake() const {
1388     return _handshake.is_vmthread_processing_handshake();
1389   }
1390 #endif
1391 
1392   // Suspend/resume support for JavaThread
1393  private:
1394   inline void set_ext_suspended();
1395   inline void clear_ext_suspended();
1396 
1397  public:
1398   void java_suspend(); // higher-level suspension logic called by the public APIs
1399   void java_resume();  // higher-level resume logic called by the public APIs
1400   int  java_suspend_self(); // low-level self-suspension mechanics
1401 
1402  private:
1403   // mid-level wrapper around java_suspend_self to set up correct state and
1404   // check for a pending safepoint at the end
1405   void java_suspend_self_with_safepoint_check();
1406 
1407  public:
1408   void check_and_wait_while_suspended() {
1409     assert(JavaThread::current() == this, &quot;sanity check&quot;);
1410 
1411     bool do_self_suspend;
1412     do {
1413       // were we externally suspended while we were waiting?
1414       do_self_suspend = handle_special_suspend_equivalent_condition();
1415       if (do_self_suspend) {
1416         // don&#39;t surprise the thread that suspended us by returning
1417         java_suspend_self();
1418         set_suspend_equivalent();
1419       }
1420     } while (do_self_suspend);
1421   }
1422   static void check_safepoint_and_suspend_for_native_trans(JavaThread *thread);
1423   // Check for async exception in addition to safepoint and suspend request.
1424   static void check_special_condition_for_native_trans(JavaThread *thread);
1425 
1426   // Same as check_special_condition_for_native_trans but finishes the
1427   // transition into thread_in_Java mode so that it can potentially
1428   // block.
1429   static void check_special_condition_for_native_trans_and_transition(JavaThread *thread);
1430 
1431   bool is_ext_suspend_completed(bool called_by_wait, int delay, uint32_t *bits);
1432   bool is_ext_suspend_completed_with_lock(uint32_t *bits) {
1433     MutexLocker ml(SR_lock(), Mutex::_no_safepoint_check_flag);
1434     // Warning: is_ext_suspend_completed() may temporarily drop the
1435     // SR_lock to allow the thread to reach a stable thread state if
1436     // it is currently in a transient thread state.
1437     return is_ext_suspend_completed(false /* !called_by_wait */,
1438                                     SuspendRetryDelay, bits);
1439   }
1440 
1441   // We cannot allow wait_for_ext_suspend_completion() to run forever or
1442   // we could hang. SuspendRetryCount and SuspendRetryDelay are normally
1443   // passed as the count and delay parameters. Experiments with specific
1444   // calls to wait_for_ext_suspend_completion() can be done by passing
1445   // other values in the code. Experiments with all calls can be done
1446   // via the appropriate -XX options.
1447   bool wait_for_ext_suspend_completion(int count, int delay, uint32_t *bits);
1448 
1449   // test for suspend - most (all?) of these should go away
1450   bool is_thread_fully_suspended(bool wait_for_suspend, uint32_t *bits);
1451 
1452   inline void set_external_suspend();
1453   inline void clear_external_suspend();
1454 
1455   bool is_external_suspend() const {
1456     return (_suspend_flags &amp; _external_suspend) != 0;
1457   }
1458   // Whenever a thread transitions from native to vm/java it must suspend
1459   // if external|deopt suspend is present.
1460   bool is_suspend_after_native() const {
1461     return (_suspend_flags &amp; (_external_suspend JFR_ONLY(| _trace_flag))) != 0;
1462   }
1463 
1464   // external suspend request is completed
1465   bool is_ext_suspended() const {
1466     return (_suspend_flags &amp; _ext_suspended) != 0;
1467   }
1468 
1469   bool is_external_suspend_with_lock() const {
1470     MutexLocker ml(SR_lock(), Mutex::_no_safepoint_check_flag);
1471     return is_external_suspend();
1472   }
1473 
1474   // Special method to handle a pending external suspend request
1475   // when a suspend equivalent condition lifts.
1476   bool handle_special_suspend_equivalent_condition() {
1477     assert(is_suspend_equivalent(),
1478            &quot;should only be called in a suspend equivalence condition&quot;);
1479     MutexLocker ml(SR_lock(), Mutex::_no_safepoint_check_flag);
1480     bool ret = is_external_suspend();
1481     if (!ret) {
1482       // not about to self-suspend so clear suspend equivalence
1483       clear_suspend_equivalent();
1484     }
1485     // implied else:
1486     // We have a pending external suspend request so we leave the
1487     // suspend_equivalent flag set until java_suspend_self() sets
1488     // the ext_suspended flag and clears the suspend_equivalent
1489     // flag. This insures that wait_for_ext_suspend_completion()
1490     // will return consistent values.
1491     return ret;
1492   }
1493 
1494   // utility methods to see if we are doing some kind of suspension
1495   bool is_being_ext_suspended() const            {
1496     MutexLocker ml(SR_lock(), Mutex::_no_safepoint_check_flag);
1497     return is_ext_suspended() || is_external_suspend();
1498   }
1499 
1500   bool is_suspend_equivalent() const             { return _suspend_equivalent; }
1501 
1502   void set_suspend_equivalent()                  { _suspend_equivalent = true; }
1503   void clear_suspend_equivalent()                { _suspend_equivalent = false; }
1504 
1505   // Thread.stop support
1506   void send_thread_stop(oop throwable);
1507   AsyncRequests clear_special_runtime_exit_condition() {
1508     AsyncRequests x = _special_runtime_exit_condition;
1509     _special_runtime_exit_condition = _no_async_condition;
1510     return x;
1511   }
1512 
1513   bool is_cont_force_yield() { return cont_preempt(); }
1514   // Are any async conditions present?
1515   bool has_async_condition() { return (_special_runtime_exit_condition != _no_async_condition); }
1516 
1517   void check_and_handle_async_exceptions(bool check_unsafe_error = true);
1518 
1519   // these next two are also used for self-suspension and async exception support
1520   void handle_special_runtime_exit_condition(bool check_asyncs = true);
1521 
1522   // Return true if JavaThread has an asynchronous condition or
1523   // if external suspension is requested.
1524   bool has_special_runtime_exit_condition() {
1525     // Because we don&#39;t use is_external_suspend_with_lock
1526     // it is possible that we won&#39;t see an asynchronous external suspend
1527     // request that has just gotten started, i.e., SR_lock grabbed but
1528     // _external_suspend field change either not made yet or not visible
1529     // yet. However, this is okay because the request is asynchronous and
1530     // we will see the new flag value the next time through. It&#39;s also
1531     // possible that the external suspend request is dropped after
1532     // we have checked is_external_suspend(), we will recheck its value
1533     // under SR_lock in java_suspend_self().
1534     return (_special_runtime_exit_condition != _no_async_condition) ||
1535             is_external_suspend() || is_trace_suspend() || is_cont_force_yield();
1536   }
1537 
1538   void set_pending_unsafe_access_error()          { _special_runtime_exit_condition = _async_unsafe_access_error; }
1539 
1540   inline void set_pending_async_exception(oop e);
1541 
1542   // Fast-locking support
1543   bool is_lock_owned(address adr) const;
1544 
1545   // Accessors for vframe array top
1546   // The linked list of vframe arrays are sorted on sp. This means when we
1547   // unpack the head must contain the vframe array to unpack.
1548   void set_vframe_array_head(vframeArray* value) { _vframe_array_head = value; }
1549   vframeArray* vframe_array_head() const         { return _vframe_array_head;  }
1550 
1551   // Side structure for deferring update of java frame locals until deopt occurs
1552   GrowableArray&lt;jvmtiDeferredLocalVariableSet*&gt;* deferred_locals() const { return _deferred_locals_updates; }
1553   void set_deferred_locals(GrowableArray&lt;jvmtiDeferredLocalVariableSet *&gt;* vf) { _deferred_locals_updates = vf; }
1554 
1555   void set_keepalive_cleanup(GrowableArray&lt;WeakHandle&lt;vm_nmethod_keepalive_data&gt; &gt;* lst) { _keepalive_cleanup = lst; }
1556   GrowableArray&lt;WeakHandle&lt;vm_nmethod_keepalive_data&gt; &gt;* keepalive_cleanup() const { return _keepalive_cleanup; }
1557 
1558   // These only really exist to make debugging deopt problems simpler
1559 
1560   void set_vframe_array_last(vframeArray* value) { _vframe_array_last = value; }
1561   vframeArray* vframe_array_last() const         { return _vframe_array_last;  }
1562 
1563   // The special resourceMark used during deoptimization
1564 
1565   void set_deopt_mark(DeoptResourceMark* value)  { _deopt_mark = value; }
1566   DeoptResourceMark* deopt_mark(void)            { return _deopt_mark; }
1567 
1568   void set_deopt_compiled_method(CompiledMethod* nm)  { _deopt_nmethod = nm; }
1569   CompiledMethod* deopt_compiled_method()        { return _deopt_nmethod; }
1570 
1571   Method*    callee_target() const               { return _callee_target; }
1572   void set_callee_target  (Method* x)          { _callee_target   = x; }
1573 
1574   // Oop results of vm runtime calls
1575   oop  vm_result() const                         { return _vm_result; }
1576   void set_vm_result  (oop x)                    { _vm_result   = x; }
1577 
1578   Metadata*    vm_result_2() const               { return _vm_result_2; }
1579   void set_vm_result_2  (Metadata* x)          { _vm_result_2   = x; }
1580 
1581   MemRegion deferred_card_mark() const           { return _deferred_card_mark; }
1582   void set_deferred_card_mark(MemRegion mr)      { _deferred_card_mark = mr;   }
1583 
1584 #if INCLUDE_JVMCI
1585   int  pending_deoptimization() const             { return _pending_deoptimization; }
1586   jlong pending_failed_speculation() const        { return _pending_failed_speculation; }
1587   bool has_pending_monitorenter() const           { return _pending_monitorenter; }
1588   void set_pending_monitorenter(bool b)           { _pending_monitorenter = b; }
1589   void set_pending_deoptimization(int reason)     { _pending_deoptimization = reason; }
1590   void set_pending_failed_speculation(jlong failed_speculation) { _pending_failed_speculation = failed_speculation; }
1591   void set_pending_transfer_to_interpreter(bool b) { _pending_transfer_to_interpreter = b; }
1592   void set_jvmci_alternate_call_target(address a) { assert(_jvmci._alternate_call_target == NULL, &quot;must be&quot;); _jvmci._alternate_call_target = a; }
1593   void set_jvmci_implicit_exception_pc(address a) { assert(_jvmci._implicit_exception_pc == NULL, &quot;must be&quot;); _jvmci._implicit_exception_pc = a; }
1594 
1595   virtual bool in_retryable_allocation() const    { return _in_retryable_allocation; }
1596   void set_in_retryable_allocation(bool b)        { _in_retryable_allocation = b; }
1597 #endif // INCLUDE_JVMCI
1598 
1599   // Exception handling for compiled methods
1600   oop      exception_oop() const                 { return _exception_oop; }
1601   address  exception_pc() const                  { return _exception_pc; }
1602   address  exception_handler_pc() const          { return _exception_handler_pc; }
1603   bool     is_method_handle_return() const       { return _is_method_handle_return == 1; }
1604 
1605   void set_exception_oop(oop o)                  { (void)const_cast&lt;oop&amp;&gt;(_exception_oop = o); }
1606   void set_exception_pc(address a)               { _exception_pc = a; }
1607   void set_exception_handler_pc(address a)       { _exception_handler_pc = a; }
1608   void set_is_method_handle_return(bool value)   { _is_method_handle_return = value ? 1 : 0; }
1609 
1610   void clear_exception_oop_and_pc() {
1611     set_exception_oop(NULL);
1612     set_exception_pc(NULL);
1613   }
1614 
1615   // Stack overflow support
1616   //
1617   //  (small addresses)
1618   //
1619   //  --  &lt;-- stack_end()                   ---
1620   //  |                                      |
1621   //  |  red pages                           |
1622   //  |                                      |
1623   //  --  &lt;-- stack_red_zone_base()          |
1624   //  |                                      |
1625   //  |                                     guard
1626   //  |  yellow pages                       zone
1627   //  |                                      |
1628   //  |                                      |
1629   //  --  &lt;-- stack_yellow_zone_base()       |
1630   //  |                                      |
1631   //  |                                      |
1632   //  |  reserved pages                      |
1633   //  |                                      |
1634   //  --  &lt;-- stack_reserved_zone_base()    ---      ---
1635   //                                                 /|\  shadow     &lt;--  stack_overflow_limit() (somewhere in here)
1636   //                                                  |   zone
1637   //                                                 \|/  size
1638   //  some untouched memory                          ---
1639   //
1640   //
1641   //  --
1642   //  |
1643   //  |  shadow zone
1644   //  |
1645   //  --
1646   //  x    frame n
1647   //  --
1648   //  x    frame n-1
1649   //  x
1650   //  --
1651   //  ...
1652   //
1653   //  --
1654   //  x    frame 0
1655   //  --  &lt;-- stack_base()
1656   //
1657   //  (large addresses)
1658   //
1659 
1660  private:
1661   // These values are derived from flags StackRedPages, StackYellowPages,
1662   // StackReservedPages and StackShadowPages. The zone size is determined
1663   // ergonomically if page_size &gt; 4K.
1664   static size_t _stack_red_zone_size;
1665   static size_t _stack_yellow_zone_size;
1666   static size_t _stack_reserved_zone_size;
1667   static size_t _stack_shadow_zone_size;
1668  public:
1669   inline size_t stack_available(address cur_sp);
1670 
1671   static size_t stack_red_zone_size() {
1672     assert(_stack_red_zone_size &gt; 0, &quot;Don&#39;t call this before the field is initialized.&quot;);
1673     return _stack_red_zone_size;
1674   }
1675   static void set_stack_red_zone_size(size_t s) {
1676     assert(is_aligned(s, os::vm_page_size()),
1677            &quot;We can not protect if the red zone size is not page aligned.&quot;);
1678     assert(_stack_red_zone_size == 0, &quot;This should be called only once.&quot;);
1679     _stack_red_zone_size = s;
1680   }
1681   address stack_red_zone_base() {
1682     return (address)(stack_end() + stack_red_zone_size());
1683   }
1684   bool in_stack_red_zone(address a) {
1685     return a &lt;= stack_red_zone_base() &amp;&amp; a &gt;= stack_end();
1686   }
1687 
1688   static size_t stack_yellow_zone_size() {
1689     assert(_stack_yellow_zone_size &gt; 0, &quot;Don&#39;t call this before the field is initialized.&quot;);
1690     return _stack_yellow_zone_size;
1691   }
1692   static void set_stack_yellow_zone_size(size_t s) {
1693     assert(is_aligned(s, os::vm_page_size()),
1694            &quot;We can not protect if the yellow zone size is not page aligned.&quot;);
1695     assert(_stack_yellow_zone_size == 0, &quot;This should be called only once.&quot;);
1696     _stack_yellow_zone_size = s;
1697   }
1698 
1699   static size_t stack_reserved_zone_size() {
1700     // _stack_reserved_zone_size may be 0. This indicates the feature is off.
1701     return _stack_reserved_zone_size;
1702   }
1703   static void set_stack_reserved_zone_size(size_t s) {
1704     assert(is_aligned(s, os::vm_page_size()),
1705            &quot;We can not protect if the reserved zone size is not page aligned.&quot;);
1706     assert(_stack_reserved_zone_size == 0, &quot;This should be called only once.&quot;);
1707     _stack_reserved_zone_size = s;
1708   }
1709   address stack_reserved_zone_base() {
1710     return (address)(stack_end() +
1711                      (stack_red_zone_size() + stack_yellow_zone_size() + stack_reserved_zone_size()));
1712   }
1713   bool in_stack_reserved_zone(address a) {
1714     return (a &lt;= stack_reserved_zone_base()) &amp;&amp;
1715            (a &gt;= (address)((intptr_t)stack_reserved_zone_base() - stack_reserved_zone_size()));
1716   }
1717 
1718   static size_t stack_yellow_reserved_zone_size() {
1719     return _stack_yellow_zone_size + _stack_reserved_zone_size;
1720   }
1721   bool in_stack_yellow_reserved_zone(address a) {
1722     return (a &lt;= stack_reserved_zone_base()) &amp;&amp; (a &gt;= stack_red_zone_base());
1723   }
1724 
1725   // Size of red + yellow + reserved zones.
1726   static size_t stack_guard_zone_size() {
1727     return stack_red_zone_size() + stack_yellow_reserved_zone_size();
1728   }
1729 
1730   static size_t stack_shadow_zone_size() {
1731     assert(_stack_shadow_zone_size &gt; 0, &quot;Don&#39;t call this before the field is initialized.&quot;);
1732     return _stack_shadow_zone_size;
1733   }
1734   static void set_stack_shadow_zone_size(size_t s) {
1735     // The shadow area is not allocated or protected, so
1736     // it needs not be page aligned.
1737     // But the stack bang currently assumes that it is a
1738     // multiple of page size. This guarantees that the bang
1739     // loop touches all pages in the shadow zone.
1740     // This can be guaranteed differently, as well.  E.g., if
1741     // the page size is a multiple of 4K, banging in 4K steps
1742     // suffices to touch all pages. (Some pages are banged
1743     // several times, though.)
1744     assert(is_aligned(s, os::vm_page_size()),
1745            &quot;Stack bang assumes multiple of page size.&quot;);
1746     assert(_stack_shadow_zone_size == 0, &quot;This should be called only once.&quot;);
1747     _stack_shadow_zone_size = s;
1748   }
1749 
1750   void create_stack_guard_pages();
1751   void remove_stack_guard_pages();
1752 
1753   void enable_stack_reserved_zone();
1754   void disable_stack_reserved_zone();
1755   void enable_stack_yellow_reserved_zone();
1756   void disable_stack_yellow_reserved_zone();
1757   void enable_stack_red_zone();
1758   void disable_stack_red_zone();
1759 
1760   inline bool stack_guard_zone_unused();
1761   inline bool stack_yellow_reserved_zone_disabled();
1762   inline bool stack_reserved_zone_disabled();
1763   inline bool stack_guards_enabled();
1764 
1765   address reserved_stack_activation() const { return _reserved_stack_activation; }
1766   void set_reserved_stack_activation(address addr) {
1767     assert(_reserved_stack_activation == stack_base()
1768             || _reserved_stack_activation == NULL
1769             || addr == stack_base(), &quot;Must not be set twice&quot;);
1770     _reserved_stack_activation = addr;
1771   }
1772 
1773   // Attempt to reguard the stack after a stack overflow may have occurred.
1774   // Returns true if (a) guard pages are not needed on this thread, (b) the
1775   // pages are already guarded, or (c) the pages were successfully reguarded.
1776   // Returns false if there is not enough stack space to reguard the pages, in
1777   // which case the caller should unwind a frame and try again.  The argument
1778   // should be the caller&#39;s (approximate) sp.
1779   bool reguard_stack(address cur_sp);
1780   // Similar to above but see if current stackpoint is out of the guard area
1781   // and reguard if possible.
1782   bool reguard_stack(void);
1783 
1784   address stack_overflow_limit() { return _stack_overflow_limit; }
1785   void set_stack_overflow_limit() {
1786     _stack_overflow_limit =
1787       stack_end() + MAX2(JavaThread::stack_guard_zone_size(), JavaThread::stack_shadow_zone_size());
1788   }
1789 
1790   // Misc. accessors/mutators
1791   void set_do_not_unlock(void)                   { _do_not_unlock_if_synchronized = true; }
1792   void clr_do_not_unlock(void)                   { _do_not_unlock_if_synchronized = false; }
1793   bool do_not_unlock(void)                       { return _do_not_unlock_if_synchronized; }
1794 
<a name="2" id="anc2"></a><span class="line-added">1795 static ByteSize scopedCache_offset()             { return byte_offset_of(JavaThread, _scopedCache); }</span>
<span class="line-added">1796 </span>
1797   // For assembly stub generation
1798   static ByteSize threadObj_offset()             { return byte_offset_of(JavaThread, _threadObj); }
1799   static ByteSize jni_environment_offset()       { return byte_offset_of(JavaThread, _jni_environment); }
1800   static ByteSize pending_jni_exception_check_fn_offset() {
1801     return byte_offset_of(JavaThread, _pending_jni_exception_check_fn);
1802   }
1803   static ByteSize last_Java_sp_offset() {
1804     return byte_offset_of(JavaThread, _anchor) + JavaFrameAnchor::last_Java_sp_offset();
1805   }
1806   static ByteSize last_Java_pc_offset() {
1807     return byte_offset_of(JavaThread, _anchor) + JavaFrameAnchor::last_Java_pc_offset();
1808   }
1809   static ByteSize frame_anchor_offset() {
1810     return byte_offset_of(JavaThread, _anchor);
1811   }
1812   static ByteSize callee_target_offset()         { return byte_offset_of(JavaThread, _callee_target); }
1813   static ByteSize vm_result_offset()             { return byte_offset_of(JavaThread, _vm_result); }
1814   static ByteSize vm_result_2_offset()           { return byte_offset_of(JavaThread, _vm_result_2); }
1815   static ByteSize thread_state_offset()          { return byte_offset_of(JavaThread, _thread_state); }
1816   static ByteSize saved_exception_pc_offset()    { return byte_offset_of(JavaThread, _saved_exception_pc); }
1817   static ByteSize osthread_offset()              { return byte_offset_of(JavaThread, _osthread); }
1818 #if INCLUDE_JVMCI
1819   static ByteSize pending_deoptimization_offset() { return byte_offset_of(JavaThread, _pending_deoptimization); }
1820   static ByteSize pending_monitorenter_offset()  { return byte_offset_of(JavaThread, _pending_monitorenter); }
1821   static ByteSize pending_failed_speculation_offset() { return byte_offset_of(JavaThread, _pending_failed_speculation); }
1822   static ByteSize jvmci_alternate_call_target_offset() { return byte_offset_of(JavaThread, _jvmci._alternate_call_target); }
1823   static ByteSize jvmci_implicit_exception_pc_offset() { return byte_offset_of(JavaThread, _jvmci._implicit_exception_pc); }
1824   static ByteSize jvmci_counters_offset()        { return byte_offset_of(JavaThread, _jvmci_counters); }
1825 #endif // INCLUDE_JVMCI
1826   static ByteSize exception_oop_offset()         { return byte_offset_of(JavaThread, _exception_oop); }
1827   static ByteSize exception_pc_offset()          { return byte_offset_of(JavaThread, _exception_pc); }
1828   static ByteSize exception_handler_pc_offset()  { return byte_offset_of(JavaThread, _exception_handler_pc); }
1829   static ByteSize stack_overflow_limit_offset()  { return byte_offset_of(JavaThread, _stack_overflow_limit); }
1830   static ByteSize is_method_handle_return_offset() { return byte_offset_of(JavaThread, _is_method_handle_return); }
1831   static ByteSize stack_guard_state_offset()     { return byte_offset_of(JavaThread, _stack_guard_state); }
1832   static ByteSize reserved_stack_activation_offset() { return byte_offset_of(JavaThread, _reserved_stack_activation); }
1833   static ByteSize suspend_flags_offset()         { return byte_offset_of(JavaThread, _suspend_flags); }
1834 
1835   static ByteSize do_not_unlock_if_synchronized_offset() { return byte_offset_of(JavaThread, _do_not_unlock_if_synchronized); }
1836   static ByteSize should_post_on_exceptions_flag_offset() {
1837     return byte_offset_of(JavaThread, _should_post_on_exceptions_flag);
1838   }
1839   static ByteSize doing_unsafe_access_offset() { return byte_offset_of(JavaThread, _doing_unsafe_access); }
1840 
1841   DEBUG_ONLY(static ByteSize continuation_offset() { return byte_offset_of(JavaThread, _continuation); })
1842   static ByteSize cont_fastpath_offset()      { return byte_offset_of(JavaThread, _cont_fastpath); }
1843   static ByteSize cont_frame_offset()         { return byte_offset_of(JavaThread, _cont_frame); }
1844   static ByteSize cont_preempt_offset()       { return byte_offset_of(JavaThread, _cont_preempt); }
1845   static ByteSize held_monitor_count_offset() { return byte_offset_of(JavaThread, _held_monitor_count); }
1846 
1847   // Returns the jni environment for this thread
1848   JNIEnv* jni_environment()                      { return &amp;_jni_environment; }
1849 
1850   static JavaThread* thread_from_jni_environment(JNIEnv* env) {
1851     JavaThread *thread_from_jni_env = (JavaThread*)((intptr_t)env - in_bytes(jni_environment_offset()));
1852     // Only return NULL if thread is off the thread list; starting to
1853     // exit should not return NULL.
1854     if (thread_from_jni_env-&gt;is_terminated()) {
1855       thread_from_jni_env-&gt;block_if_vm_exited();
1856       return NULL;
1857     } else {
1858       return thread_from_jni_env;
1859     }
1860   }
1861 
1862   // JNI critical regions. These can nest.
1863   bool in_critical()    { return _jni_active_critical &gt; 0; }
1864   bool in_last_critical()  { return _jni_active_critical == 1; }
1865   inline void enter_critical();
1866   void exit_critical() {
1867     assert(Thread::current() == this, &quot;this must be current thread&quot;);
1868     _jni_active_critical--;
1869     assert(_jni_active_critical &gt;= 0, &quot;JNI critical nesting problem?&quot;);
1870   }
1871 
1872   // Checked JNI: is the programmer required to check for exceptions, if so specify
1873   // which function name. Returning to a Java frame should implicitly clear the
1874   // pending check, this is done for Native-&gt;Java transitions (i.e. user JNI code).
1875   // VM-&gt;Java transistions are not cleared, it is expected that JNI code enclosed
1876   // within ThreadToNativeFromVM makes proper exception checks (i.e. VM internal).
1877   bool is_pending_jni_exception_check() const { return _pending_jni_exception_check_fn != NULL; }
1878   void clear_pending_jni_exception_check() { _pending_jni_exception_check_fn = NULL; }
1879   const char* get_pending_jni_exception_check() const { return _pending_jni_exception_check_fn; }
1880   void set_pending_jni_exception_check(const char* fn_name) { _pending_jni_exception_check_fn = (char*) fn_name; }
1881 
1882   // For deadlock detection
1883   int depth_first_number() { return _depth_first_number; }
1884   void set_depth_first_number(int dfn) { _depth_first_number = dfn; }
1885 
1886  private:
1887   void set_monitor_chunks(MonitorChunk* monitor_chunks) { _monitor_chunks = monitor_chunks; }
1888 
1889  public:
1890   MonitorChunk* monitor_chunks() const           { return _monitor_chunks; }
1891   void add_monitor_chunk(MonitorChunk* chunk);
1892   void remove_monitor_chunk(MonitorChunk* chunk);
1893   bool in_deopt_handler() const                  { return _in_deopt_handler &gt; 0; }
1894   void inc_in_deopt_handler()                    { _in_deopt_handler++; }
1895   void dec_in_deopt_handler() {
1896     assert(_in_deopt_handler &gt; 0, &quot;mismatched deopt nesting&quot;);
1897     if (_in_deopt_handler &gt; 0) { // robustness
1898       _in_deopt_handler--;
1899     }
1900   }
1901 
1902  private:
1903   void set_entry_point(ThreadFunction entry_point) { _entry_point = entry_point; }
1904 
1905  public:
1906 
1907   // Frame iteration; calls the function f for all frames on the stack
1908   void frames_do(void f(frame*, const RegisterMap*));
1909 
1910   // Memory operations
1911   void oops_do(OopClosure* f, CodeBlobClosure* cf);
1912 
1913   // Sweeper operations
1914   virtual void nmethods_do(CodeBlobClosure* cf);
1915 
1916   // RedefineClasses Support
1917   void metadata_do(MetadataClosure* f);
1918 
1919   // Debug method asserting thread states are correct during a handshake operation.
1920   DEBUG_ONLY(void verify_states_for_handshake();)
1921 
1922   // Misc. operations
1923   char* name() const { return (char*)get_thread_name(); }
1924   void print_on(outputStream* st, bool print_extended_info) const;
1925   void print_on(outputStream* st) const { print_on(st, false); }
1926   void print() const;
1927   void print_thread_state_on(outputStream*) const      PRODUCT_RETURN;
1928   DEBUG_ONLY(const char* thread_state_name() const;)
1929   void print_on_error(outputStream* st, char* buf, int buflen) const;
1930   void print_name_on_error(outputStream* st, char* buf, int buflen) const;
1931   void verify();
1932   const char* get_thread_name() const;
1933  protected:
1934   // factor out low-level mechanics for use in both normal and error cases
1935   virtual const char* get_thread_name_string(char* buf = NULL, int buflen = 0) const;
1936  public:
1937   // Accessing frames
1938   frame last_frame() {
1939     _anchor.make_walkable(this);
1940     return pd_last_frame();
1941   }
1942   javaVFrame* last_java_vframe(RegisterMap* reg_map);
1943 
1944   oop last_continuation();
1945   
1946   // Returns method at &#39;depth&#39; java or native frames down the stack
1947   // Used for security checks
1948   Klass* security_get_caller_class(int depth);
1949 
1950   // Print stack trace in external format
1951   void print_stack_on(outputStream* st);
1952   void print_stack() { print_stack_on(tty); }
1953 
1954   // Print stack traces in various internal formats
1955   void trace_stack()                             PRODUCT_RETURN;
1956   void trace_stack_from(vframe* start_vf)        PRODUCT_RETURN;
1957   void trace_frames()                            PRODUCT_RETURN;
1958 
1959   // Print an annotated view of the stack frames
1960   void print_frame_layout(int depth = 0, bool validate_only = false) NOT_DEBUG_RETURN;
1961   void validate_frame_layout() {
1962     print_frame_layout(0, true);
1963   }
1964 
1965   // Function for testing deoptimization
1966   void deoptimize();
1967   void make_zombies();
1968 
1969   void deoptimize_marked_methods();
1970 
1971  public:
1972   // Returns the running thread as a JavaThread
1973   static inline JavaThread* current();
1974 
1975   // Returns the active Java thread.  Do not use this if you know you are calling
1976   // from a JavaThread, as it&#39;s slower than JavaThread::current.  If called from
1977   // the VMThread, it also returns the JavaThread that instigated the VMThread&#39;s
1978   // operation.  You may not want that either.
1979   static JavaThread* active();
1980 
1981   inline CompilerThread* as_CompilerThread();
1982 
1983  protected:
1984   virtual void pre_run();
1985   virtual void run();
1986   void thread_main_inner();
1987   virtual void post_run();
1988 
1989 
1990  private:
1991   GrowableArray&lt;oop&gt;* _array_for_gc;
1992  public:
1993 
1994   void register_array_for_gc(GrowableArray&lt;oop&gt;* array) { _array_for_gc = array; }
1995 
1996  public:
1997   // Thread local information maintained by JVMTI.
1998   void set_jvmti_thread_state(JvmtiThreadState *value)                           { _jvmti_thread_state = value; }
1999   // A JvmtiThreadState is lazily allocated. This jvmti_thread_state()
2000   // getter is used to get this JavaThread&#39;s JvmtiThreadState if it has
2001   // one which means NULL can be returned. JvmtiThreadState::state_for()
2002   // is used to get the specified JavaThread&#39;s JvmtiThreadState if it has
2003   // one or it allocates a new JvmtiThreadState for the JavaThread and
2004   // returns it. JvmtiThreadState::state_for() will return NULL only if
2005   // the specified JavaThread is exiting.
2006   JvmtiThreadState *jvmti_thread_state() const                                   { return _jvmti_thread_state; }
2007   static ByteSize jvmti_thread_state_offset()                                    { return byte_offset_of(JavaThread, _jvmti_thread_state); }
2008 
2009   // JVMTI PopFrame support
2010   // Setting and clearing popframe_condition
2011   // All of these enumerated values are bits. popframe_pending
2012   // indicates that a PopFrame() has been requested and not yet been
2013   // completed. popframe_processing indicates that that PopFrame() is in
2014   // the process of being completed. popframe_force_deopt_reexecution_bit
2015   // indicates that special handling is required when returning to a
2016   // deoptimized caller.
2017   enum PopCondition {
2018     popframe_inactive                      = 0x00,
2019     popframe_pending_bit                   = 0x01,
2020     popframe_processing_bit                = 0x02,
2021     popframe_force_deopt_reexecution_bit   = 0x04
2022   };
2023   PopCondition popframe_condition()                   { return (PopCondition) _popframe_condition; }
2024   void set_popframe_condition(PopCondition c)         { _popframe_condition = c; }
2025   void set_popframe_condition_bit(PopCondition c)     { _popframe_condition |= c; }
2026   void clear_popframe_condition()                     { _popframe_condition = popframe_inactive; }
2027   static ByteSize popframe_condition_offset()         { return byte_offset_of(JavaThread, _popframe_condition); }
2028   bool has_pending_popframe()                         { return (popframe_condition() &amp; popframe_pending_bit) != 0; }
2029   bool popframe_forcing_deopt_reexecution()           { return (popframe_condition() &amp; popframe_force_deopt_reexecution_bit) != 0; }
2030   void clear_popframe_forcing_deopt_reexecution()     { _popframe_condition &amp;= ~popframe_force_deopt_reexecution_bit; }
2031 #ifdef CC_INTERP
2032   bool pop_frame_pending(void)                        { return ((_popframe_condition &amp; popframe_pending_bit) != 0); }
2033   void clr_pop_frame_pending(void)                    { _popframe_condition = popframe_inactive; }
2034   bool pop_frame_in_process(void)                     { return ((_popframe_condition &amp; popframe_processing_bit) != 0); }
2035   void set_pop_frame_in_process(void)                 { _popframe_condition |= popframe_processing_bit; }
2036   void clr_pop_frame_in_process(void)                 { _popframe_condition &amp;= ~popframe_processing_bit; }
2037 #endif
2038 
2039   int frames_to_pop_failed_realloc() const            { return _frames_to_pop_failed_realloc; }
2040   void set_frames_to_pop_failed_realloc(int nb)       { _frames_to_pop_failed_realloc = nb; }
2041   void dec_frames_to_pop_failed_realloc()             { _frames_to_pop_failed_realloc--; }
2042 
2043  private:
2044   // Saved incoming arguments to popped frame.
2045   // Used only when popped interpreted frame returns to deoptimized frame.
2046   void*    _popframe_preserved_args;
2047   int      _popframe_preserved_args_size;
2048 
2049  public:
2050   void  popframe_preserve_args(ByteSize size_in_bytes, void* start);
2051   void* popframe_preserved_args();
2052   ByteSize popframe_preserved_args_size();
2053   WordSize popframe_preserved_args_size_in_words();
2054   void  popframe_free_preserved_args();
2055 
2056 
2057  private:
2058   JvmtiThreadState *_jvmti_thread_state;
2059 
2060   // Used by the interpreter in fullspeed mode for frame pop, method
2061   // entry, method exit and single stepping support. This field is
2062   // only set to non-zero by the VM_EnterInterpOnlyMode VM operation.
2063   // It can be set to zero asynchronously (i.e., without a VM operation
2064   // or a lock) so we have to be very careful.
2065   int               _interp_only_mode;
2066 
2067  public:
2068   // used by the interpreter for fullspeed debugging support (see above)
2069   static ByteSize interp_only_mode_offset() { return byte_offset_of(JavaThread, _interp_only_mode); }
2070   bool is_interp_only_mode()                { return (_interp_only_mode != 0); }
2071   int get_interp_only_mode()                { return _interp_only_mode; }
2072   void increment_interp_only_mode()         { ++_interp_only_mode; }
2073   void decrement_interp_only_mode()         { --_interp_only_mode; }
2074 
2075   // support for cached flag that indicates whether exceptions need to be posted for this thread
2076   // if this is false, we can avoid deoptimizing when events are thrown
2077   // this gets set to reflect whether jvmtiExport::post_exception_throw would actually do anything
2078  private:
2079   int    _should_post_on_exceptions_flag;
2080 
2081  public:
2082   int   should_post_on_exceptions_flag()  { return _should_post_on_exceptions_flag; }
2083   void  set_should_post_on_exceptions_flag(int val)  { _should_post_on_exceptions_flag = val; }
2084 
2085  private:
2086   ThreadStatistics *_thread_stat;
2087 
2088  public:
2089   ThreadStatistics* get_thread_stat() const    { return _thread_stat; }
2090 
2091   // Return a blocker object for which this thread is blocked parking.
2092   oop current_park_blocker();
2093 
2094  private:
2095   static size_t _stack_size_at_create;
2096 
2097  public:
2098   static inline size_t stack_size_at_create(void) {
2099     return _stack_size_at_create;
2100   }
2101   static inline void set_stack_size_at_create(size_t value) {
2102     _stack_size_at_create = value;
2103   }
2104 
2105   // Machine dependent stuff
2106 #include OS_CPU_HEADER(thread)
2107 
2108   // JSR166 per-thread parker
2109  private:
2110   Parker*    _parker;
2111  public:
2112   Parker*     parker() { return _parker; }
2113 
2114   // Biased locking support
2115  private:
2116   GrowableArray&lt;MonitorInfo*&gt;* _cached_monitor_info;
2117  public:
2118   GrowableArray&lt;MonitorInfo*&gt;* cached_monitor_info() { return _cached_monitor_info; }
2119   void set_cached_monitor_info(GrowableArray&lt;MonitorInfo*&gt;* info) { _cached_monitor_info = info; }
2120 
2121   // clearing/querying jni attach status
2122   bool is_attaching_via_jni() const { return _jni_attach_state == _attaching_via_jni; }
2123   bool has_attached_via_jni() const { return is_attaching_via_jni() || _jni_attach_state == _attached_via_jni; }
2124   inline void set_done_attaching_via_jni();
2125 
2126   // Stack dump assistance:
2127   // Track the class we want to initialize but for which we have to wait
2128   // on its init_lock() because it is already being initialized.
2129   void set_class_to_be_initialized(InstanceKlass* k);
2130   InstanceKlass* class_to_be_initialized() const;
2131 
2132 private:
2133   InstanceKlass* _class_to_be_initialized;
2134 
2135   // java.lang.Thread.sleep support
2136   ParkEvent * _SleepEvent;
2137 public:
2138   bool sleep(jlong millis);
2139 
2140   // java.lang.Thread interruption support
2141   void interrupt();
2142   bool is_interrupted(bool clear_interrupted);
2143 
2144 };
2145 
2146 // Inline implementation of JavaThread::current
2147 inline JavaThread* JavaThread::current() {
2148   Thread* thread = Thread::current();
2149   assert(thread-&gt;is_Java_thread(), &quot;just checking&quot;);
2150   return (JavaThread*)thread;
2151 }
2152 
2153 inline CompilerThread* JavaThread::as_CompilerThread() {
2154   assert(is_Compiler_thread(), &quot;just checking&quot;);
2155   return (CompilerThread*)this;
2156 }
2157 
2158 // Dedicated thread to sweep the code cache
2159 class CodeCacheSweeperThread : public JavaThread {
2160   CompiledMethod*       _scanned_compiled_method; // nmethod being scanned by the sweeper
2161  public:
2162   CodeCacheSweeperThread();
2163   // Track the nmethod currently being scanned by the sweeper
2164   void set_scanned_compiled_method(CompiledMethod* cm) {
2165     assert(_scanned_compiled_method == NULL || cm == NULL, &quot;should reset to NULL before writing a new value&quot;);
2166     _scanned_compiled_method = cm;
2167   }
2168 
2169   // Hide sweeper thread from external view.
2170   bool is_hidden_from_external_view() const { return true; }
2171 
2172   bool is_Code_cache_sweeper_thread() const { return true; }
2173 
2174   // Prevent GC from unloading _scanned_compiled_method
2175   void oops_do(OopClosure* f, CodeBlobClosure* cf);
2176   void nmethods_do(CodeBlobClosure* cf);
2177 };
2178 
2179 // A thread used for Compilation.
2180 class CompilerThread : public JavaThread {
2181   friend class VMStructs;
2182  private:
2183   CompilerCounters* _counters;
2184 
2185   ciEnv*                _env;
2186   CompileLog*           _log;
2187   CompileTask* volatile _task;  // print_threads_compiling can read this concurrently.
2188   CompileQueue*         _queue;
2189   BufferBlob*           _buffer_blob;
2190 
2191   AbstractCompiler*     _compiler;
2192   TimeStamp             _idle_time;
2193 
2194  public:
2195 
2196   static CompilerThread* current();
2197 
2198   CompilerThread(CompileQueue* queue, CompilerCounters* counters);
2199   ~CompilerThread();
2200 
2201   bool is_Compiler_thread() const                { return true; }
2202 
2203   virtual bool can_call_java() const;
2204 
2205   // Hide native compiler threads from external view.
2206   bool is_hidden_from_external_view() const      { return !can_call_java(); }
2207 
2208   void set_compiler(AbstractCompiler* c)         { _compiler = c; }
2209   AbstractCompiler* compiler() const             { return _compiler; }
2210 
2211   CompileQueue* queue()        const             { return _queue; }
2212   CompilerCounters* counters() const             { return _counters; }
2213 
2214   // Get/set the thread&#39;s compilation environment.
2215   ciEnv*        env()                            { return _env; }
2216   void          set_env(ciEnv* env)              { _env = env; }
2217 
2218   BufferBlob*   get_buffer_blob() const          { return _buffer_blob; }
2219   void          set_buffer_blob(BufferBlob* b)   { _buffer_blob = b; }
2220 
2221   // Get/set the thread&#39;s logging information
2222   CompileLog*   log()                            { return _log; }
2223   void          init_log(CompileLog* log) {
2224     // Set once, for good.
2225     assert(_log == NULL, &quot;set only once&quot;);
2226     _log = log;
2227   }
2228 
2229   void start_idle_timer()                        { _idle_time.update(); }
2230   jlong idle_time_millis() {
2231     return TimeHelper::counter_to_millis(_idle_time.ticks_since_update());
2232   }
2233 
2234 #ifndef PRODUCT
2235  private:
2236   IdealGraphPrinter *_ideal_graph_printer;
2237  public:
2238   IdealGraphPrinter *ideal_graph_printer()           { return _ideal_graph_printer; }
2239   void set_ideal_graph_printer(IdealGraphPrinter *n) { _ideal_graph_printer = n; }
2240 #endif
2241 
2242   // Get/set the thread&#39;s current task
2243   CompileTask* task()                      { return _task; }
2244   void         set_task(CompileTask* task) { _task = task; }
2245 };
2246 
2247 inline CompilerThread* CompilerThread::current() {
2248   return JavaThread::current()-&gt;as_CompilerThread();
2249 }
2250 
2251 // The active thread queue. It also keeps track of the current used
2252 // thread priorities.
2253 class Threads: AllStatic {
2254   friend class VMStructs;
2255  private:
2256   static int         _number_of_threads;
2257   static int         _number_of_non_daemon_threads;
2258   static int         _return_code;
2259   static uintx       _thread_claim_token;
2260 #ifdef ASSERT
2261   static bool        _vm_complete;
2262 #endif
2263 
2264   static void initialize_java_lang_classes(JavaThread* main_thread, TRAPS);
2265   static void initialize_jsr292_core_classes(TRAPS);
2266 
2267  public:
2268   // Thread management
2269   // force_daemon is a concession to JNI, where we may need to add a
2270   // thread to the thread list before allocating its thread object
2271   static void add(JavaThread* p, bool force_daemon = false);
2272   static void remove(JavaThread* p, bool is_daemon);
2273   static void non_java_threads_do(ThreadClosure* tc);
2274   static void java_threads_do(ThreadClosure* tc);
2275   static void java_threads_and_vm_thread_do(ThreadClosure* tc);
2276   static void threads_do(ThreadClosure* tc);
2277   static void possibly_parallel_threads_do(bool is_par, ThreadClosure* tc);
2278 
2279   // Initializes the vm and creates the vm thread
2280   static jint create_vm(JavaVMInitArgs* args, bool* canTryAgain);
2281   static void convert_vm_init_libraries_to_agents();
2282   static void create_vm_init_libraries();
2283   static void create_vm_init_agents();
2284   static void shutdown_vm_agents();
2285   static bool destroy_vm();
2286   // Supported VM versions via JNI
2287   // Includes JNI_VERSION_1_1
2288   static jboolean is_supported_jni_version_including_1_1(jint version);
2289   // Does not include JNI_VERSION_1_1
2290   static jboolean is_supported_jni_version(jint version);
2291 
2292   // The &quot;thread claim token&quot; provides a way for threads to be claimed
2293   // by parallel worker tasks.
2294   //
2295   // Each thread contains a &quot;token&quot; field. A task will claim the
2296   // thread only if its token is different from the global token,
2297   // which is updated by calling change_thread_claim_token().  When
2298   // a thread is claimed, it&#39;s token is set to the global token value
2299   // so other threads in the same iteration pass won&#39;t claim it.
2300   //
2301   // For this to work change_thread_claim_token() needs to be called
2302   // exactly once in sequential code before starting parallel tasks
2303   // that should claim threads.
2304   //
2305   // New threads get their token set to 0 and change_thread_claim_token()
2306   // never sets the global token to 0.
2307   static uintx thread_claim_token() { return _thread_claim_token; }
2308   static void change_thread_claim_token();
2309   static void assert_all_threads_claimed() NOT_DEBUG_RETURN;
2310 
2311   // Apply &quot;f-&gt;do_oop&quot; to all root oops in all threads.
2312   // This version may only be called by sequential code.
2313   static void oops_do(OopClosure* f, CodeBlobClosure* cf);
2314   // This version may be called by sequential or parallel code.
2315   static void possibly_parallel_oops_do(bool is_par, OopClosure* f, CodeBlobClosure* cf);
2316 
2317   // Sweeper
2318   static void nmethods_do(CodeBlobClosure* cf);
2319 
2320   // RedefineClasses support
2321   static void metadata_do(MetadataClosure* f);
2322   static void metadata_handles_do(void f(Metadata*));
2323 
2324 #ifdef ASSERT
2325   static bool is_vm_complete() { return _vm_complete; }
2326 #endif // ASSERT
2327 
2328   // Verification
2329   static void verify();
2330   static void print_on(outputStream* st, bool print_stacks, bool internal_format, bool print_concurrent_locks, bool print_extended_info);
2331   static void print(bool print_stacks, bool internal_format) {
2332     // this function is only used by debug.cpp
2333     print_on(tty, print_stacks, internal_format, false /* no concurrent lock printed */, false /* simple format */);
2334   }
2335   static void print_on_error(outputStream* st, Thread* current, char* buf, int buflen);
2336   static void print_on_error(Thread* this_thread, outputStream* st, Thread* current, char* buf,
2337                              int buflen, bool* found_current);
2338   static void print_threads_compiling(outputStream* st, char* buf, int buflen, bool short_form = false);
2339 
2340   // Get Java threads that are waiting to enter a monitor.
2341   static GrowableArray&lt;JavaThread*&gt;* get_pending_threads(ThreadsList * t_list,
2342                                                          int count, address monitor);
2343 
2344   // Get owning Java thread from the monitor&#39;s owner field.
2345   static JavaThread *owning_thread_from_monitor_owner(ThreadsList * t_list,
2346                                                       address owner);
2347 
2348   // Number of threads on the active threads list
2349   static int number_of_threads()                 { return _number_of_threads; }
2350   // Number of non-daemon threads on the active threads list
2351   static int number_of_non_daemon_threads()      { return _number_of_non_daemon_threads; }
2352 
2353   // Deoptimizes all frames tied to marked nmethods
2354   static void deoptimized_wrt_marked_nmethods();
2355 
2356   struct Test;                  // For private gtest access.
2357 };
2358 
2359 class SignalHandlerMark: public StackObj {
2360  private:
2361   Thread* _thread;
2362  public:
2363   SignalHandlerMark(Thread* t) {
2364     _thread = t;
2365     if (_thread) _thread-&gt;enter_signal_handler();
2366   }
2367   ~SignalHandlerMark() {
2368     if (_thread) _thread-&gt;leave_signal_handler();
2369     _thread = NULL;
2370   }
2371 };
2372 
2373 
2374 #endif // SHARE_RUNTIME_THREAD_HPP
<a name="3" id="anc3"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="3" type="hidden" />
</body>
</html>