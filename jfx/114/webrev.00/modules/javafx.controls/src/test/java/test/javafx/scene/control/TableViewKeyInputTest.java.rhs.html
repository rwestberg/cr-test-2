<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames modules/javafx.controls/src/test/java/test/javafx/scene/control/TableViewKeyInputTest.java</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>   1 /*
<a name="1" id="anc1"></a><span class="line-modified">   2  * Copyright (c) 2011, 2020, Oracle and/or its affiliates. All rights reserved.</span>
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.  Oracle designates this
   8  * particular file as subject to the &quot;Classpath&quot; exception as provided
   9  * by Oracle in the LICENSE file that accompanied this code.
  10  *
  11  * This code is distributed in the hope that it will be useful, but WITHOUT
  12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  14  * version 2 for more details (a copy is included in the LICENSE file that
  15  * accompanied this code).
  16  *
  17  * You should have received a copy of the GNU General Public License version
  18  * 2 along with this work; if not, write to the Free Software Foundation,
  19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  20  *
  21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  22  * or visit www.oracle.com if you need additional information or have any
  23  * questions.
  24  */
  25 
  26 package test.javafx.scene.control;
  27 
  28 import com.sun.javafx.scene.control.behavior.TableCellBehavior;
  29 import javafx.beans.property.ReadOnlyStringWrapper;
  30 import javafx.collections.FXCollections;
  31 import javafx.collections.ListChangeListener;
  32 import javafx.collections.ObservableList;
  33 import javafx.scene.Group;
  34 import javafx.scene.control.Button;
  35 import javafx.scene.input.KeyCode;
  36 import javafx.scene.layout.HBox;
  37 
<a name="2" id="anc2"></a><span class="line-added">  38 import java.util.Arrays;</span>
<span class="line-added">  39 import java.util.Collection;</span>
  40 import java.util.List;
  41 import java.util.function.Function;
  42 
  43 import com.sun.javafx.PlatformUtil;
  44 import com.sun.javafx.util.Utils;
  45 import test.com.sun.javafx.scene.control.behavior.TableViewAnchorRetriever;
  46 import test.com.sun.javafx.scene.control.infrastructure.ControlTestUtils;
  47 import test.com.sun.javafx.scene.control.infrastructure.KeyEventFirer;
  48 import test.com.sun.javafx.scene.control.infrastructure.KeyModifier;
  49 import test.com.sun.javafx.scene.control.infrastructure.StageLoader;
  50 import test.com.sun.javafx.scene.control.infrastructure.VirtualFlowTestUtils;
  51 import com.sun.javafx.tk.Toolkit;
  52 import javafx.scene.control.FocusModel;
  53 import javafx.scene.control.MultipleSelectionModel;
  54 import javafx.scene.control.SelectionMode;
  55 import javafx.scene.control.TableCell;
  56 import javafx.scene.control.TableCellShim;
  57 import javafx.scene.control.TableColumn;
  58 import javafx.scene.control.TableFocusModel;
  59 import javafx.scene.control.TablePosition;
  60 import javafx.scene.control.TableSelectionModel;
  61 import javafx.scene.control.TableView;
<a name="3" id="anc3"></a><span class="line-added">  62 import javafx.geometry.NodeOrientation;</span>
  63 import org.junit.After;
  64 import org.junit.Before;
  65 import org.junit.Ignore;
  66 import org.junit.Test;
<a name="4" id="anc4"></a><span class="line-added">  67 import org.junit.runner.RunWith;</span>
<span class="line-added">  68 import org.junit.runners.Parameterized;</span>
<span class="line-added">  69 </span>
  70 import static org.junit.Assert.assertEquals;
  71 import static org.junit.Assert.assertFalse;
  72 import static org.junit.Assert.assertNotSame;
  73 import static org.junit.Assert.assertNull;
  74 import static org.junit.Assert.assertTrue;
<a name="5" id="anc5"></a><span class="line-added">  75 </span>
  76 import static org.junit.Assert.fail;
  77 
<a name="6" id="anc6"></a><span class="line-added">  78 @RunWith(Parameterized.class)</span>
  79 public class TableViewKeyInputTest {
<a name="7" id="anc7"></a><span class="line-added">  80     @Parameterized.Parameters public static Collection implementations() {</span>
<span class="line-added">  81         return Arrays.asList(new Object[][]{</span>
<span class="line-added">  82                 {NodeOrientation.LEFT_TO_RIGHT},</span>
<span class="line-added">  83                 {NodeOrientation.RIGHT_TO_LEFT}</span>
<span class="line-added">  84         });</span>
<span class="line-added">  85     }</span>
<span class="line-added">  86 </span>
  87     private TableView&lt;String&gt; tableView;
  88 //    private TableSelectionModel&lt;String&gt; sm;
  89     private TableView.TableViewSelectionModel&lt;String&gt; sm;
  90     private TableView.TableViewFocusModel&lt;String&gt; fm;
  91 
  92     private KeyEventFirer keyboard;
  93 
  94     private StageLoader stageLoader;
  95 
  96     private TableColumn&lt;String, String&gt; col0;
  97     private TableColumn&lt;String, String&gt; col1;
  98     private TableColumn&lt;String, String&gt; col2;
  99     private TableColumn&lt;String, String&gt; col3;
 100     private TableColumn&lt;String, String&gt; col4;
 101 
<a name="8" id="anc8"></a><span class="line-added"> 102     private NodeOrientation orientation;</span>
<span class="line-added"> 103 </span>
<span class="line-added"> 104     public TableViewKeyInputTest(NodeOrientation val) {</span>
<span class="line-added"> 105         orientation = val;</span>
<span class="line-added"> 106     }</span>
<span class="line-added"> 107 </span>
 108     @Before public void setup() {
 109         tableView = new TableView&lt;String&gt;();
<a name="9" id="anc9"></a><span class="line-added"> 110         tableView.setNodeOrientation(orientation);</span>
 111         sm = tableView.getSelectionModel();
 112         fm = tableView.getFocusModel();
 113 
 114         sm.setSelectionMode(SelectionMode.MULTIPLE);
 115         sm.setCellSelectionEnabled(false);
 116 
 117         tableView.getItems().setAll(&quot;1&quot;, &quot;2&quot;, &quot;3&quot;, &quot;4&quot;, &quot;5&quot;, &quot;6&quot;, &quot;7&quot;, &quot;8&quot;, &quot;9&quot;, &quot;10&quot;, &quot;11&quot;, &quot;12&quot;);
 118 
 119         col0 = new TableColumn&lt;String, String&gt;(&quot;col0&quot;);
 120         col1 = new TableColumn&lt;String, String&gt;(&quot;col1&quot;);
 121         col2 = new TableColumn&lt;String, String&gt;(&quot;col2&quot;);
 122         col3 = new TableColumn&lt;String, String&gt;(&quot;col3&quot;);
 123         col4 = new TableColumn&lt;String, String&gt;(&quot;col4&quot;);
 124         tableView.getColumns().setAll(col0, col1, col2, col3, col4);
 125 
 126         keyboard = new KeyEventFirer(tableView);
 127 
 128         stageLoader = new StageLoader(tableView);
 129         stageLoader.getStage().show();
 130     }
 131 
 132     @After public void tearDown() {
 133         tableView.getSkin().dispose();
 134         stageLoader.dispose();
 135     }
 136 
 137     /***************************************************************************
 138      * Util methods
 139      **************************************************************************/
 140 
 141     private String debug() {
 142         StringBuilder sb = new StringBuilder(&quot;Selected Cells: [&quot;);
 143 
 144         List&lt;TablePosition&gt; cells = sm.getSelectedCells();
 145         for (TablePosition&lt;String,?&gt; tp : cells) {
 146             sb.append(&quot;(&quot;);
 147             sb.append(tp.getRow());
 148             sb.append(&quot;,&quot;);
 149             sb.append(tp.getColumn());
 150             sb.append(&quot;), &quot;);
 151         }
 152 
 153         sb.append(&quot;] \nFocus: (&quot; + fm.getFocusedCell().getRow() + &quot;, &quot; + fm.getFocusedCell().getColumn() + &quot;)&quot;);
 154         sb.append(&quot; \nAnchor: (&quot; + getAnchor().getRow() + &quot;, &quot; + getAnchor().getColumn() + &quot;)&quot;);
 155         return sb.toString();
 156     }
 157 
 158     // Returns true if ALL indices are selected
 159     private boolean isSelected(int... indices) {
 160         for (int index : indices) {
 161             if (! sm.isSelected(index)) {
 162                 System.out.println(&quot;Index &quot; + index + &quot; is not selected, but it is expected to be&quot;);
 163                 return false;
 164             }
 165         }
 166         return true;
 167     }
 168 
 169     // Returns true if ALL indices are NOT selected
 170     private boolean isNotSelected(int... indices) {
 171         for (int index : indices) {
 172             if (sm.isSelected(index)) {
 173                 System.out.println(&quot;Index &quot; + index + &quot; is selected, but it is not expected to be&quot;);
 174                 return false;
 175             }
 176         }
 177         return true;
 178     }
 179 
 180     private TablePosition getAnchor() {
 181         return TableViewAnchorRetriever.getAnchor(tableView);
 182     }
 183 
 184     private boolean isAnchor(int row) {
 185         TablePosition tp = new TablePosition(tableView, row, null);
 186         return getAnchor() != null &amp;&amp; getAnchor().equals(tp);
 187     }
 188 
 189     private boolean isAnchor(int row, int col) {
 190         TablePosition tp = new TablePosition(tableView, row, tableView.getColumns().get(col));
 191         return getAnchor() != null &amp;&amp; getAnchor().equals(tp);
 192     }
 193 
 194     /***************************************************************************
 195      * General tests
 196      **************************************************************************/
 197 
 198     @Test public void testInitialState() {
 199         assertEquals(0,sm.getSelectedCells().size());
 200         assertEquals(0,sm.getSelectedIndices().size());
 201         assertEquals(0,sm.getSelectedItems().size());
 202     }
 203 
 204 
 205     /***************************************************************************
 206      * Tests for row-based single selection
 207      **************************************************************************/
 208 
 209     @Test public void testDownArrowChangesSelection() {
 210         sm.clearAndSelect(0);
 211         keyboard.doDownArrowPress();
 212         assertFalse(sm.isSelected(0));
 213         assertTrue(sm.isSelected(1));
 214     }
 215 
 216     @Test public void testDownArrowDoesNotChangeSelectionWhenAtLastIndex() {
 217         int endIndex = tableView.getItems().size() - 1;
 218         sm.clearAndSelect(endIndex);
 219         assertTrue(sm.isSelected(endIndex));
 220         keyboard.doDownArrowPress();
 221         assertTrue(sm.isSelected(endIndex));
 222     }
 223 
 224     @Test public void testUpArrowDoesNotChangeSelectionWhenAt0Index() {
 225         sm.clearAndSelect(0);
 226         keyboard.doUpArrowPress();
 227 
 228         assertTrue(sm.isSelected(0));
 229         assertEquals(1, sm.getSelectedIndices().size());
 230         assertEquals(1, sm.getSelectedItems().size());
 231     }
 232 
 233     @Test public void testUpArrowChangesSelection() {
 234         sm.clearAndSelect(1);
 235         keyboard.doUpArrowPress();
 236         assertFalse(sm.isSelected(1));
 237         assertTrue(sm.isSelected(0));
 238     }
 239 
 240     @Test public void testLeftArrowDoesNotChangeState() {
 241         keyboard.doLeftArrowPress();
 242         testInitialState();
 243     }
 244 
 245     @Test public void testRightArrowDoesNotChangeState() {
 246         keyboard.doRightArrowPress();
 247         testInitialState();
 248     }
 249 
 250     /* test 19
 251     @Test public void testCtrlDownMovesFocusButLeavesSelectionAlone() {
 252         assertTrue(fm.isFocused(0));
 253         keyboard.doDownArrowPress(KeyModifier.getShortcutKey());
 254         assertTrue(fm.isFocused(1));
 255         assertTrue(sm.isSelected(0));
 256         assertFalse(sm.isSelected(1));
 257     } */
 258 
 259     // test 20
 260     @Test public void testCtrlUpDoesNotMoveFocus() {
 261         sm.clearAndSelect(0);
 262         assertTrue(fm.isFocused(0));
 263         keyboard.doUpArrowPress(KeyModifier.getShortcutKey());
 264         assertTrue(fm.isFocused(0));
 265         assertTrue(sm.isSelected(0));
 266     }
 267 
 268     // test 21
 269     @Test public void testCtrlLeftDoesNotMoveFocus() {
 270         sm.clearAndSelect(0);
 271         assertTrue(fm.isFocused(0));
 272         keyboard.doLeftArrowPress(KeyModifier.getShortcutKey());
 273         assertTrue(fm.isFocused(0));
 274         assertTrue(sm.isSelected(0));
 275     }
 276 
 277     // test 22
 278     @Test public void testCtrlRightDoesNotMoveFocus() {
 279         sm.clearAndSelect(0);
 280         assertTrue(fm.isFocused(0));
 281         keyboard.doRightArrowPress(KeyModifier.getShortcutKey());
 282         assertTrue(fm.isFocused(0));
 283         assertTrue(sm.isSelected(0));
 284     }
 285 
 286     /* test 23
 287     @Test public void testCtrlUpMovesFocus() {
 288         sm.clearAndSelect(1);
 289         assertTrue(fm.isFocused(1));
 290         assertTrue(sm.isSelected(1));
 291         keyboard.doUpArrowPress(KeyModifier.getShortcutKey());
 292         assertTrue(fm.isFocused(0));
 293         assertTrue(sm.isSelected(1));
 294     } */
 295 
 296     // test 24
 297     @Test public void testCtrlDownDoesNotMoveFocusWhenAtLastIndex() {
 298         int endIndex = tableView.getItems().size() - 1;
 299         sm.clearAndSelect(endIndex);
 300         assertTrue(fm.isFocused(endIndex));
 301         assertTrue(sm.isSelected(endIndex));
 302         keyboard.doDownArrowPress(KeyModifier.getShortcutKey());
 303         assertTrue(fm.isFocused(endIndex));
 304         assertTrue(sm.isSelected(endIndex));
 305     }
 306 
 307     /* test 25
 308     @Test public void testCtrlDownArrowWithSpaceChangesAnchor() {
 309         sm.clearAndSelect(0);
 310         keyboard.doDownArrowPress(KeyModifier.getShortcutKey());    // move focus to 1
 311         keyboard.doDownArrowPress(KeyModifier.getShortcutKey());    // move focus to 2
 312         keyboard.doKeyPress(KeyCode.SPACE,
 313                 KeyModifier.getShortcutKey(),
 314                 (Utils.isMac()  ? KeyModifier.CTRL : null));  // select 2
 315         assertTrue(isSelected(0, 2));
 316         assertTrue(isNotSelected(1));
 317         assertTrue(isAnchor(2));
 318     } */
 319 
 320     /* test 26
 321     @Test public void testCtrlUpArrowWithSpaceChangesAnchor() {
 322         sm.clearAndSelect(2);
 323         keyboard.doUpArrowPress(KeyModifier.getShortcutKey());    // move focus to 1
 324         keyboard.doUpArrowPress(KeyModifier.getShortcutKey());    // move focus to 0
 325         keyboard.doKeyPress(KeyCode.SPACE,
 326                 KeyModifier.getShortcutKey(),
 327                 (Utils.isMac()  ? KeyModifier.CTRL : null));  // select 0
 328         assertTrue(isSelected(0, 2));
 329         assertTrue(isNotSelected(1));
 330         assertTrue(isAnchor(0));
 331     } */
 332 
 333     // test 44
 334     @Test public void testHomeKey() {
 335         sm.clearAndSelect(3);
 336         keyboard.doKeyPress(KeyCode.HOME);
 337         assertTrue(isSelected(0));
 338         assertTrue(isNotSelected(1,2,3));
 339     }
 340 
 341     // test 45
 342     @Test public void testEndKey() {
 343         sm.clearAndSelect(3);
 344         keyboard.doKeyPress(KeyCode.END);
 345         assertTrue(isSelected(tableView.getItems().size() - 1));
 346         assertTrue(isNotSelected(1,2,3));
 347     }
 348 
 349     /* test 53
 350     @Test public void testCtrlHome() {
 351         sm.clearAndSelect(5);
 352         keyboard.doKeyPress(KeyCode.HOME, KeyModifier.getShortcutKey());
 353         assertTrue(isSelected(5));
 354         assertTrue(fm.isFocused(0));
 355     } */
 356 
 357     /* test 54
 358     @Test public void testCtrlEnd() {
 359         sm.clearAndSelect(5);
 360         keyboard.doKeyPress(KeyCode.END, KeyModifier.getShortcutKey());
 361         assertTrue(isSelected(5));
 362         assertTrue(fm.isFocused(tableView.getItems().size() - 1));
 363     } */
 364 
 365     /* test 68
 366     @Test public void testCtrlSpaceToClearSelection() {
 367         sm.clearAndSelect(5);
 368         assertTrue(isSelected(5));
 369         assertTrue(fm.isFocused(5));
 370         keyboard.doKeyPress(KeyCode.SPACE,
 371                 KeyModifier.getShortcutKey(),
 372                 (Utils.isMac()  ? KeyModifier.CTRL : null));
 373         assertTrue(isNotSelected(5));
 374         assertTrue(debug(), fm.isFocused(5));
 375         assertTrue(isAnchor(5));
 376     } */
 377 
 378 
 379 
 380     /***************************************************************************
 381      * Tests for row-based multiple selection
 382      **************************************************************************/
 383 
 384     @Test public void testShiftDownArrowIncreasesSelection() {
 385         sm.clearAndSelect(0);
 386         keyboard.doDownArrowPress(KeyModifier.SHIFT);
 387         assertTrue(sm.isSelected(0));
 388         assertTrue(sm.isSelected(1));
 389     }
 390 
 391     @Test public void testShiftDownArrowDoesNotChangeSelectionWhenAtLastIndex() {
 392         int endIndex = tableView.getItems().size() - 1;
 393         sm.clearAndSelect(endIndex);
 394         assertTrue(sm.isSelected(endIndex));
 395         keyboard.doDownArrowPress(KeyModifier.SHIFT);
 396         assertTrue(sm.isSelected(endIndex));
 397     }
 398 
 399     @Test public void testShiftUpArrowIncreasesSelection() {
 400         sm.clearAndSelect(1);
 401         keyboard.doUpArrowPress(KeyModifier.SHIFT);
 402         assertTrue(sm.isSelected(0));
 403         assertTrue(sm.isSelected(1));
 404     }
 405 
 406     @Test public void testShiftUpArrowWhenAt0Index() {
 407         sm.clearAndSelect(0);
 408         keyboard.doUpArrowPress(KeyModifier.SHIFT);
 409         assertTrue(sm.isSelected(0));
 410     }
 411 
 412     @Test public void testShiftLeftArrowWhenAt0Index() {
 413         sm.clearAndSelect(0);
 414         keyboard.doLeftArrowPress(KeyModifier.SHIFT);
 415         assertTrue(sm.isSelected(0));
 416         assertFalse(sm.isSelected(1));
 417     }
 418 
 419     @Test public void testShiftRightArrowWhenAt0Index() {
 420         sm.clearAndSelect(0);
 421         keyboard.doRightArrowPress(KeyModifier.SHIFT);
 422         assertTrue(sm.isSelected(0));
 423         assertFalse(sm.isSelected(1));
 424     }
 425 
 426     @Test public void testShiftDownTwiceThenShiftUp() {
 427         sm.clearAndSelect(0);
 428         keyboard.doDownArrowPress(KeyModifier.SHIFT);
 429         keyboard.doDownArrowPress(KeyModifier.SHIFT);
 430         keyboard.doUpArrowPress(KeyModifier.SHIFT);
 431         assertTrue(debug(), sm.isSelected(0));
 432         assertTrue(sm.isSelected(1));
 433         assertFalse(sm.isSelected(2));
 434     }
 435 
 436     @Test public void testShiftUpTwiceThenShiftDownFrom0Index() {
 437         sm.clearAndSelect(0);
 438         keyboard.doUpArrowPress(KeyModifier.SHIFT);
 439         keyboard.doUpArrowPress(KeyModifier.SHIFT);
 440         keyboard.doDownArrowPress(KeyModifier.SHIFT);
 441         assertTrue(sm.isSelected(0));
 442         assertTrue(sm.isSelected(1));
 443         assertFalse(sm.isSelected(2));
 444     }
 445 
 446     @Test public void testShiftLeftTwiceThenShiftRight() {
 447         sm.clearAndSelect(0);
 448         keyboard.doLeftArrowPress(KeyModifier.SHIFT);
 449         keyboard.doLeftArrowPress(KeyModifier.SHIFT);
 450         keyboard.doRightArrowPress(KeyModifier.SHIFT);
 451         assertTrue(sm.isSelected(0));
 452         assertFalse(sm.isSelected(1));
 453         assertFalse(sm.isSelected(2));
 454     }
 455 
 456     @Test public void testShiftRightTwiceThenShiftLeft() {
 457         sm.clearAndSelect(0);
 458         keyboard.doRightArrowPress(KeyModifier.SHIFT);
 459         keyboard.doRightArrowPress(KeyModifier.SHIFT);
 460         keyboard.doLeftArrowPress(KeyModifier.SHIFT);
 461         assertTrue(sm.isSelected(0));
 462         assertFalse(sm.isSelected(1));
 463         assertFalse(sm.isSelected(2));
 464     }
 465 
 466     @Test public void testShiftUpTwiceThenShiftDown() {
 467         sm.clearAndSelect(2);                           // select 2
 468         keyboard.doUpArrowPress(KeyModifier.SHIFT);     // also select 1
 469         keyboard.doUpArrowPress(KeyModifier.SHIFT);     // also select 0
 470         keyboard.doDownArrowPress(KeyModifier.SHIFT);   // deselect 0
 471         assertFalse(debug(), sm.isSelected(0));
 472         assertTrue(sm.isSelected(1));
 473         assertTrue(sm.isSelected(2));
 474         assertFalse(sm.isSelected(3));
 475     }
 476 
 477     // test 18 from Jindra&#39;s testcases.rtf file
 478     @Test public void testShiftDownTwiceThenShiftUpWhenAtLastIndex() {
 479         int endIndex = tableView.getItems().size() - 1;
 480         sm.clearAndSelect(endIndex);
 481         keyboard.doDownArrowPress(KeyModifier.SHIFT);
 482         keyboard.doDownArrowPress(KeyModifier.SHIFT);
 483         keyboard.doUpArrowPress(KeyModifier.SHIFT);
 484         assertTrue(sm.isSelected(endIndex));
 485         assertTrue(sm.isSelected(endIndex - 1));
 486         assertFalse(sm.isSelected(endIndex - 2));
 487     }
 488 
 489     // test 27
 490     @Test public void testCtrlDownArrowWithSpaceChangesAnchor_extended() {
 491         sm.clearAndSelect(0);
 492         keyboard.doDownArrowPress(KeyModifier.getShortcutKey());    // move focus to 1
 493         keyboard.doDownArrowPress(KeyModifier.getShortcutKey());    // move focus to 2
 494         keyboard.doKeyPress(KeyCode.SPACE,
 495                 KeyModifier.getShortcutKey(),
 496                 (Utils.isMac()  ? KeyModifier.CTRL : null));  // select 2
 497 
 498         keyboard.doUpArrowPress(KeyModifier.getShortcutKey());    // move focus to 1
 499         keyboard.doUpArrowPress(KeyModifier.getShortcutKey());    // move focus to 0
 500         keyboard.doKeyPress(KeyCode.SPACE,
 501                 KeyModifier.getShortcutKey(),
 502                 (Utils.isMac()  ? KeyModifier.CTRL : null));  // deselect 0
 503         assertTrue(isSelected(2));
 504         assertTrue(isNotSelected(0, 1));
 505         assertTrue(isAnchor(0));
 506     }
 507 
 508     // test 28
 509     @Test public void testCtrlUpArrowWithSpaceChangesAnchor_extended() {
 510         sm.clearAndSelect(2);
 511         keyboard.doUpArrowPress(KeyModifier.getShortcutKey());    // move focus to 1
 512         keyboard.doUpArrowPress(KeyModifier.getShortcutKey());    // move focus to 0
 513         keyboard.doKeyPress(KeyCode.SPACE,
 514                 KeyModifier.getShortcutKey(),
 515                 (Utils.isMac()  ? KeyModifier.CTRL : null));  // select 0
 516 
 517         keyboard.doDownArrowPress(KeyModifier.getShortcutKey());    // move focus to 1
 518         keyboard.doDownArrowPress(KeyModifier.getShortcutKey());    // move focus to 2
 519         keyboard.doKeyPress(KeyCode.SPACE,
 520                 KeyModifier.getShortcutKey(),
 521                 (Utils.isMac()  ? KeyModifier.CTRL : null));  // deselect 2
 522         assertTrue(isSelected(0));
 523         assertTrue(isNotSelected(1, 2));
 524         assertTrue(isAnchor(2));
 525     }
 526 
 527     // test 29
 528     @Test public void testCtrlDownArrowWithSpaceChangesAnchor_extended2() {
 529         sm.clearAndSelect(0);
 530         keyboard.doDownArrowPress(KeyModifier.getShortcutKey());    // move focus to 1
 531         keyboard.doDownArrowPress(KeyModifier.getShortcutKey());    // move focus to 2
 532         keyboard.doKeyPress(KeyCode.SPACE,
 533                 KeyModifier.getShortcutKey(),
 534                 (Utils.isMac()  ? KeyModifier.CTRL : null));  // select 2
 535 
 536         keyboard.doDownArrowPress(KeyModifier.getShortcutKey());    // move focus to 3
 537         keyboard.doDownArrowPress(KeyModifier.getShortcutKey());    // move focus to 4
 538         keyboard.doKeyPress(KeyCode.SPACE,
 539                 KeyModifier.getShortcutKey(),
 540                 (Utils.isMac()  ? KeyModifier.CTRL : null));  // select 4
 541         assertTrue(isSelected(0, 2, 4));
 542         assertTrue(isNotSelected(1, 3, 5));
 543         assertTrue(isAnchor(4));
 544     }
 545 
 546     // test 30
 547     @Test public void testCtrlUpArrowWithSpaceChangesAnchor_extended2() {
 548         sm.clearAndSelect(4);
 549         keyboard.doUpArrowPress(KeyModifier.getShortcutKey());    // move focus to 3
 550         keyboard.doUpArrowPress(KeyModifier.getShortcutKey());    // move focus to 2
 551         keyboard.doKeyPress(KeyCode.SPACE,
 552                 KeyModifier.getShortcutKey(),
 553                 (Utils.isMac()  ? KeyModifier.CTRL : null));  // select 2
 554 
 555         keyboard.doUpArrowPress(KeyModifier.getShortcutKey());    // move focus to 1
 556         keyboard.doUpArrowPress(KeyModifier.getShortcutKey());    // move focus to 0
 557         keyboard.doKeyPress(KeyCode.SPACE,
 558                 KeyModifier.getShortcutKey(),
 559                 (Utils.isMac()  ? KeyModifier.CTRL : null));  // select 0
 560         assertTrue(isSelected(0, 2, 4));
 561         assertTrue(isNotSelected(1, 3));
 562         assertTrue(isAnchor(0));
 563     }
 564 
 565     // test 31
 566     @Test public void testCtrlDownArrowThenShiftSpaceToSelectRange() {
 567         sm.clearAndSelect(0);
 568         keyboard.doDownArrowPress(KeyModifier.getShortcutKey());    // move focus to 1
 569         keyboard.doDownArrowPress(KeyModifier.getShortcutKey());    // move focus to 2
 570         keyboard.doKeyPress(KeyCode.SPACE, KeyModifier.SHIFT);  // select 0,1,2
 571         assertTrue(isSelected(0, 1, 2));
 572         assertTrue(isNotSelected(3));
 573         assertTrue(isAnchor(0));
 574     }
 575 
 576     // test 32
 577     @Test public void testCtrlUpArrowThenShiftSpaceToSelectRange() {
 578         sm.clearAndSelect(2);
 579         keyboard.doUpArrowPress(KeyModifier.getShortcutKey());    // move focus to 1
 580         keyboard.doUpArrowPress(KeyModifier.getShortcutKey());    // move focus to 0
 581         keyboard.doKeyPress(KeyCode.SPACE, KeyModifier.SHIFT);  // select 0,1,2
 582         assertTrue(isSelected(0, 1, 2));
 583         assertTrue(isNotSelected(3));
 584         assertTrue(debug(), isAnchor(2));
 585     }
 586 
 587     // test 33
 588     @Test public void testCtrlDownArrowThenSpaceToChangeSelection() {
 589         sm.clearAndSelect(0);
 590         keyboard.doDownArrowPress(KeyModifier.getShortcutKey());    // move focus to 1
 591         keyboard.doDownArrowPress(KeyModifier.getShortcutKey());    // move focus to 2
 592         keyboard.doKeyPress(KeyCode.SPACE,
 593                 KeyModifier.getShortcutKey(),
 594                 (Utils.isMac()  ? KeyModifier.CTRL : null));  // select 2, keeping 0 selected
 595         assertTrue(isSelected(0, 2));
 596         assertTrue(isNotSelected(1, 3));
 597         assertTrue(isAnchor(2));
 598 
 599         keyboard.doDownArrowPress(KeyModifier.getShortcutKey());    // move focus to 3
 600         keyboard.doDownArrowPress(KeyModifier.getShortcutKey());    // move focus to 4
 601         keyboard.doKeyPress(KeyCode.SPACE, KeyModifier.SHIFT);  // select 2,3,4
 602         assertTrue(isSelected(2, 3, 4));
 603         assertTrue(isNotSelected(0, 1));
 604         assertTrue(isAnchor(2));
 605     }
 606 
 607     // test 34
 608     @Test public void testCtrlUpArrowThenSpaceToChangeSelection() {
 609         sm.clearAndSelect(4);
 610         keyboard.doUpArrowPress(KeyModifier.getShortcutKey());    // move focus to 3
 611         keyboard.doUpArrowPress(KeyModifier.getShortcutKey());    // move focus to 2
 612         keyboard.doKeyPress(KeyCode.SPACE,
 613                 KeyModifier.getShortcutKey(),
 614                 (Utils.isMac()  ? KeyModifier.CTRL : null));  // select 2, keeping 4 selected
 615         assertTrue(isSelected(2, 4));
 616         assertTrue(isNotSelected(0, 1, 3));
 617         assertTrue(isAnchor(2));
 618 
 619         keyboard.doUpArrowPress(KeyModifier.getShortcutKey());    // move focus to 1
 620         keyboard.doUpArrowPress(KeyModifier.getShortcutKey());    // move focus to 0
 621         keyboard.doKeyPress(KeyCode.SPACE, KeyModifier.SHIFT);  // select 0,1,2
 622         assertTrue(isSelected(0, 1, 2));
 623         assertTrue(isNotSelected(3, 4));
 624         assertTrue(debug(), isAnchor(2));
 625     }
 626 
 627     // test 35
 628     @Test public void testCtrlDownTwiceThenShiftDown() {
 629         sm.clearAndSelect(0);
 630         keyboard.doDownArrowPress(KeyModifier.getShortcutKey());    // move focus to 1
 631         keyboard.doDownArrowPress(KeyModifier.getShortcutKey());    // move focus to 2
 632         keyboard.doKeyPress(KeyCode.DOWN, KeyModifier.SHIFT);  // select 0,1,2,3
 633         assertTrue(isSelected(0, 1, 2, 3));
 634     }
 635 
 636     // test 36
 637     @Test public void testCtrlUpTwiceThenShiftDown() {
 638         sm.clearAndSelect(3);
 639         keyboard.doUpArrowPress(KeyModifier.getShortcutKey());    // move focus to 2
 640         keyboard.doUpArrowPress(KeyModifier.getShortcutKey());    // move focus to 1
 641         keyboard.doUpArrowPress(KeyModifier.getShortcutKey());    // move focus to 0
 642         keyboard.doKeyPress(KeyCode.DOWN, KeyModifier.SHIFT);  // select 1,2,3
 643         assertTrue(isSelected(1, 2, 3));
 644         assertTrue(isNotSelected(0));
 645     }
 646 
 647     // test 37
 648     @Test public void testCtrlDownThriceThenShiftUp() {
 649         sm.clearAndSelect(0);
 650         keyboard.doDownArrowPress(KeyModifier.getShortcutKey());    // move focus to 1
 651         keyboard.doDownArrowPress(KeyModifier.getShortcutKey());    // move focus to 2
 652         keyboard.doDownArrowPress(KeyModifier.getShortcutKey());    // move focus to 3
 653         keyboard.doKeyPress(KeyCode.UP, KeyModifier.SHIFT);  // select 0,1,2
 654         assertTrue(isSelected(0, 1, 2));
 655         assertTrue(isNotSelected(3, 4));
 656     }
 657 
 658     // test 38
 659     @Test public void testCtrlUpTwiceThenShiftUp() {
 660         sm.clearAndSelect(3);
 661         keyboard.doUpArrowPress(KeyModifier.getShortcutKey());    // move focus to 2
 662         keyboard.doUpArrowPress(KeyModifier.getShortcutKey());    // move focus to 1
 663         keyboard.doKeyPress(KeyCode.UP, KeyModifier.SHIFT);  // select 0,1,2,3
 664         assertTrue(isSelected(0, 1, 2, 3));
 665         assertTrue(isNotSelected(4));
 666     }
 667 
 668     // test 39
 669     @Test public void testCtrlDownTwiceThenSpace_extended() {
 670         sm.clearAndSelect(0);
 671         keyboard.doDownArrowPress(KeyModifier.getShortcutKey());    // move focus to 1
 672         keyboard.doDownArrowPress(KeyModifier.getShortcutKey());    // move focus to 2
 673         keyboard.doKeyPress(KeyCode.SPACE,
 674                 KeyModifier.getShortcutKey(),
 675                 (Utils.isMac()  ? KeyModifier.CTRL : null));  // select 0,2
 676         assertTrue(isSelected(0, 2));
 677         assertTrue(isNotSelected(1, 3));
 678         assertTrue(isAnchor(2));
 679 
 680         keyboard.doDownArrowPress(KeyModifier.getShortcutKey());    // move focus to 3
 681         keyboard.doDownArrowPress(KeyModifier.getShortcutKey());    // move focus to 4
 682         keyboard.doDownArrowPress(KeyModifier.SHIFT);   // select 2,3,4,5
 683         assertTrue(isSelected(2, 3, 4, 5));
 684         assertTrue(isNotSelected(0, 1));
 685         assertTrue(isAnchor(2));
 686     }
 687 
 688     // test 40
 689     @Test public void testCtrlUpTwiceThenSpace_extended() {
 690         sm.clearAndSelect(5);
 691         keyboard.doUpArrowPress(KeyModifier.getShortcutKey());    // move focus to 4
 692         keyboard.doUpArrowPress(KeyModifier.getShortcutKey());    // move focus to 3
 693         keyboard.doKeyPress(KeyCode.SPACE,
 694                 KeyModifier.getShortcutKey(),
 695                 (Utils.isMac()  ? KeyModifier.CTRL : null));  // select 3,5
 696         assertTrue(isSelected(3,5));
 697         assertTrue(isNotSelected(0,1,2,4));
 698         assertTrue(isAnchor(3));
 699 
 700         keyboard.doUpArrowPress(KeyModifier.getShortcutKey());    // move focus to 2
 701         keyboard.doUpArrowPress(KeyModifier.getShortcutKey());    // move focus to 1
 702         keyboard.doUpArrowPress(KeyModifier.getShortcutKey());    // move focus to 0
 703         keyboard.doDownArrowPress(KeyModifier.SHIFT);   // select 1,2,3
 704         assertTrue(isSelected(1,2,3));
 705         assertTrue(isNotSelected(0,4,5));
 706         assertTrue(isAnchor(3));
 707     }
 708 
 709     // test 41
 710     @Test public void testCtrlDownTwiceThenSpace_extended2() {
 711         sm.clearAndSelect(0);
 712         keyboard.doDownArrowPress(KeyModifier.getShortcutKey());    // move focus to 1
 713         keyboard.doDownArrowPress(KeyModifier.getShortcutKey());    // move focus to 2
 714         keyboard.doKeyPress(KeyCode.SPACE,
 715                 KeyModifier.getShortcutKey(),
 716                 (Utils.isMac()  ? KeyModifier.CTRL : null));  // select 0,2
 717         assertTrue(isSelected(0,2));
 718         assertTrue(isNotSelected(1,3,4));
 719         assertTrue(isAnchor(2));
 720 
 721         keyboard.doDownArrowPress(KeyModifier.getShortcutKey());    // move focus to 3
 722         keyboard.doDownArrowPress(KeyModifier.getShortcutKey());    // move focus to 4
 723         keyboard.doDownArrowPress(KeyModifier.getShortcutKey());    // move focus to 5
 724         keyboard.doUpArrowPress(KeyModifier.SHIFT);     // select 2,3,4
 725         assertTrue(isSelected(2,3,4));
 726         assertTrue(isNotSelected(0,1,5));
 727         assertTrue(isAnchor(2));
 728     }
 729 
 730     // test 50
 731     @Test public void testCtrlDownThenShiftHome() {
 732         sm.clearAndSelect(0);
 733         keyboard.doDownArrowPress(KeyModifier.getShortcutKey());    // move focus to 1
 734         keyboard.doDownArrowPress(KeyModifier.getShortcutKey());    // move focus to 2
 735         keyboard.doKeyPress(KeyCode.SPACE,
 736                 KeyModifier.getShortcutKey(),
 737                 (Utils.isMac()  ? KeyModifier.CTRL : null));  // select 0,2
 738         assertTrue(isSelected(0,2));
 739         assertTrue(isNotSelected(1,3,4));
 740         assertTrue(isAnchor(2));
 741 
 742         keyboard.doDownArrowPress(KeyModifier.getShortcutKey());    // move focus to 3
 743         keyboard.doDownArrowPress(KeyModifier.getShortcutKey());    // move focus to 4
 744         keyboard.doKeyPress(KeyCode.HOME, KeyModifier.SHIFT);
 745         assertTrue(isSelected(0,1,2));
 746         assertTrue(isNotSelected(3,4));
 747         assertTrue(debug(),isAnchor(2));
 748     }
 749 
 750     // test 51
 751     @Test public void testCtrlUpThenShiftEnd() {
 752         sm.clearAndSelect(5);
 753         keyboard.doUpArrowPress(KeyModifier.getShortcutKey());    // move focus to 4
 754         keyboard.doUpArrowPress(KeyModifier.getShortcutKey());    // move focus to 3
 755         keyboard.doKeyPress(KeyCode.SPACE,
 756                 KeyModifier.getShortcutKey(),
 757                 (Utils.isMac()  ? KeyModifier.CTRL : null));  // select 3,5
 758         assertTrue(isSelected(3,5));
 759         assertTrue(isNotSelected(1,2,4));
 760         assertTrue(isAnchor(3));
 761 
 762         keyboard.doUpArrowPress(KeyModifier.getShortcutKey());    // move focus to 2
 763         keyboard.doUpArrowPress(KeyModifier.getShortcutKey());    // move focus to 1
 764         keyboard.doKeyPress(KeyCode.END, KeyModifier.SHIFT);
 765         assertTrue(isSelected(3,4,5,6,7,8,9));
 766         assertTrue(isNotSelected(0,1,2));
 767         assertTrue(debug(),isAnchor(3));
 768     }
 769 
 770     // test 42
 771     @Test public void testCtrlUpTwiceThenSpace_extended2() {
 772         sm.clearAndSelect(5);
 773         keyboard.doUpArrowPress(KeyModifier.getShortcutKey());    // move focus to 4
 774         keyboard.doUpArrowPress(KeyModifier.getShortcutKey());    // move focus to 3
 775         keyboard.doKeyPress(KeyCode.SPACE,
 776                 KeyModifier.getShortcutKey(),
 777                 (Utils.isMac()  ? KeyModifier.CTRL : null));  // select 3,5
 778         assertTrue(isSelected(3,5));
 779         assertTrue(isNotSelected(0,1,2,4));
 780         assertTrue(isAnchor(3));
 781 
 782         keyboard.doUpArrowPress(KeyModifier.getShortcutKey());    // move focus to 2
 783         keyboard.doUpArrowPress(KeyModifier.getShortcutKey());    // move focus to 1
 784         keyboard.doUpArrowPress(KeyModifier.SHIFT);     // select 0,1,2,3
 785         assertTrue(isSelected(0,1,2,3));
 786         assertTrue(isNotSelected(4,5));
 787         assertTrue(isAnchor(3));
 788     }
 789 
 790     // test 46
 791     @Test public void testHomeKey_withSelectedItems() {
 792         sm.clearSelection();
 793         sm.selectRange(4, 11);
 794         keyboard.doKeyPress(KeyCode.HOME);
 795         assertTrue(isSelected(0));
 796         assertTrue(isNotSelected(1,2,3,4,5,6,7,8,9,10,11));
 797     }
 798 
 799     // test 47
 800     @Test public void testEndKey_withSelectedItems() {
 801         sm.clearSelection();
 802         sm.selectRange(4, 11);
 803         keyboard.doKeyPress(KeyCode.END);
 804         assertTrue(isSelected(tableView.getItems().size() - 1));
 805         assertTrue(isNotSelected(1,2,3,4,5,6,7,8));
 806     }
 807 
 808     // test 48
 809     @Test public void testShiftHome() {
 810         sm.clearAndSelect(3);
 811         keyboard.doKeyPress(KeyCode.HOME, KeyModifier.SHIFT);
 812         assertTrue(isSelected(0,1,2,3));
 813         assertTrue(isNotSelected(4,5));
 814         assertTrue(debug(), isAnchor(3));
 815     }
 816 
 817     // test 49
 818     @Test public void testShiftEnd() {
 819         sm.clearAndSelect(3);
 820         keyboard.doKeyPress(KeyCode.END, KeyModifier.SHIFT);
 821         assertTrue(isSelected(3,4,5,6,7,8,9));
 822         assertTrue(isNotSelected(0,1,2));
 823         assertTrue(debug(), isAnchor(3));
 824     }
 825 
 826     // test 52
 827     @Test public void testShiftHomeThenShiftEnd() {
 828         sm.clearAndSelect(5);
 829         keyboard.doKeyPress(KeyCode.HOME, KeyModifier.SHIFT);
 830         assertTrue(isSelected(0,1,2,3,4,5));
 831         assertTrue(isAnchor(5));
 832 
 833         keyboard.doKeyPress(KeyCode.END, KeyModifier.SHIFT);
 834         assertTrue(isSelected(5,6,7,8,9));
 835         assertTrue(isAnchor(5));
 836     }
 837 
 838     // test 65
 839     @Test public void testShiftPageUp() {
 840         sm.clearAndSelect(0);
 841         keyboard.doDownArrowPress(KeyModifier.getShortcutKey());
 842         keyboard.doDownArrowPress(KeyModifier.getShortcutKey());
 843         keyboard.doKeyPress(KeyCode.SPACE,
 844                 KeyModifier.getShortcutKey(),
 845                 (Utils.isMac()  ? KeyModifier.CTRL : null));
 846         assertTrue(isSelected(0,2));
 847         assertTrue(isAnchor(2));
 848 
 849         keyboard.doDownArrowPress(KeyModifier.getShortcutKey());
 850         keyboard.doDownArrowPress(KeyModifier.getShortcutKey());
 851         keyboard.doKeyPress(KeyCode.PAGE_UP, KeyModifier.SHIFT);
 852         assertTrue(debug(), isSelected(0,1,2));
 853         assertTrue(isAnchor(2));
 854     }
 855 
 856     // test 67
 857     @Test public void testCtrlAToSelectAll() {
 858         sm.clearAndSelect(5);
 859         keyboard.doKeyPress(KeyCode.A, KeyModifier.getShortcutKey());
 860         assertTrue(isSelected(0,1,2,3,4,5,6,7,8,9));
 861     }
 862 
 863 
 864     /***************************************************************************
 865      * Tests for cell-based multiple selection
 866      **************************************************************************/
 867 
 868     @Ignore(&quot;Bug persists&quot;)
 869     @Test public void testSelectionPathDeviationWorks1() {
 870         // select horizontally, then select two items vertically, then go back
 871         // in opposite direction
 872         sm.setCellSelectionEnabled(true);
 873         sm.clearAndSelect(1, col0);
 874 
 875         keyboard.doRightArrowPress(KeyModifier.SHIFT);   // select (1, col2)
 876         keyboard.doRightArrowPress(KeyModifier.SHIFT);   // select (1, col3)
 877         keyboard.doDownArrowPress(KeyModifier.SHIFT);    // select (2, col3)
 878         keyboard.doDownArrowPress(KeyModifier.SHIFT);    // select (3, col3)
 879         assertTrue(sm.isSelected(1, col2));
 880         assertTrue(sm.isSelected(2, col2));
 881         assertTrue(sm.isSelected(3, col2));
 882 
 883         keyboard.doUpArrowPress(KeyModifier.SHIFT);    // deselect (3, col3)
 884         assertTrue(sm.isSelected(1, col2));
 885         assertTrue(sm.isSelected(2, col2));
 886         assertFalse(sm.isSelected(3, col2));
 887 
 888         keyboard.doUpArrowPress(KeyModifier.SHIFT);    // deselect (2, col3)
 889         assertTrue(sm.isSelected(1, col2));
 890         assertFalse(sm.isSelected(2, col2));
 891         assertFalse(sm.isSelected(3, col2));
 892 
 893         keyboard.doUpArrowPress(KeyModifier.SHIFT);    // deselect (1, col3)
 894         assertFalse(debug(), sm.isSelected(1, col2));
 895         assertFalse(sm.isSelected(2, col2));
 896         assertFalse(sm.isSelected(3, col2));
 897 
 898         keyboard.doLeftArrowPress(KeyModifier.SHIFT);    // deselect (1, col2)
 899         assertFalse(sm.isSelected(1, col1));
 900     }
 901 
 902 
 903     /***************************************************************************
 904      * Tests for discontinuous multiple row selection (RT-18951)
 905      **************************************************************************/
 906 
 907     // Test 1
 908     @Test public void test_rt18591_row_1() {
 909         sm.clearAndSelect(0);
 910         keyboard.doDownArrowPress(KeyModifier.getShortcutKey());
 911         keyboard.doDownArrowPress(KeyModifier.getShortcutKey());
 912         keyboard.doKeyPress(KeyCode.SPACE,
 913                 KeyModifier.getShortcutKey(),
 914                 (Utils.isMac()  ? KeyModifier.CTRL : null));
 915         assertTrue(isSelected(0,2));
 916         assertTrue(isAnchor(2));
 917 
 918         keyboard.doDownArrowPress(KeyModifier.SHIFT, KeyModifier.getShortcutKey());
 919         keyboard.doDownArrowPress(KeyModifier.SHIFT, KeyModifier.getShortcutKey());
 920         assertTrue(isSelected(0,2,3,4));
 921         assertTrue(isAnchor(2));
 922     }
 923 
 924     // Test 2
 925     @Test public void test_rt18591_row_2() {
 926         sm.clearAndSelect(5);
 927         keyboard.doUpArrowPress(KeyModifier.getShortcutKey());
 928         keyboard.doUpArrowPress(KeyModifier.getShortcutKey());
 929         keyboard.doKeyPress(KeyCode.SPACE,
 930                 KeyModifier.getShortcutKey(),
 931                 (Utils.isMac()  ? KeyModifier.CTRL : null));
 932         assertTrue(isSelected(3,5));
 933         assertTrue(isAnchor(3));
 934 
 935         keyboard.doUpArrowPress(KeyModifier.SHIFT, KeyModifier.getShortcutKey());
 936         keyboard.doUpArrowPress(KeyModifier.SHIFT, KeyModifier.getShortcutKey());
 937         assertTrue(isSelected(1,2,3,5));
 938         assertTrue(isAnchor(3));
 939     }
 940 
 941     // Test 3
 942     @Test public void test_rt18591_row_3() {
 943         // same as test 1 above
 944         sm.clearAndSelect(0);
 945         keyboard.doDownArrowPress(KeyModifier.getShortcutKey());
 946         keyboard.doDownArrowPress(KeyModifier.getShortcutKey());
 947         keyboard.doKeyPress(KeyCode.SPACE,
 948                 KeyModifier.getShortcutKey(),
 949                 (Utils.isMac()  ? KeyModifier.CTRL : null));
 950         assertTrue(isSelected(0,2));
 951         assertTrue(isAnchor(2));
 952 
 953         keyboard.doDownArrowPress(KeyModifier.SHIFT, KeyModifier.getShortcutKey());
 954         keyboard.doDownArrowPress(KeyModifier.SHIFT, KeyModifier.getShortcutKey());
 955         assertTrue(isSelected(0,2,3,4));
 956         assertTrue(isAnchor(2));
 957         // end of similarities
 958 
 959         keyboard.doUpArrowPress(KeyModifier.SHIFT, KeyModifier.getShortcutKey());
 960         keyboard.doUpArrowPress(KeyModifier.SHIFT, KeyModifier.getShortcutKey());
 961         keyboard.doUpArrowPress(KeyModifier.SHIFT, KeyModifier.getShortcutKey());
 962         assertTrue(isSelected(0,1,2,3,4));
 963         assertTrue(isAnchor(2));
 964     }
 965 
 966     // Test 4
 967     @Test public void test_rt18591_row_4() {
 968         // same as test 2 above
 969         sm.clearAndSelect(5);
 970         keyboard.doUpArrowPress(KeyModifier.getShortcutKey());
 971         keyboard.doUpArrowPress(KeyModifier.getShortcutKey());
 972         keyboard.doKeyPress(KeyCode.SPACE,
 973                 KeyModifier.getShortcutKey(),
 974                 (Utils.isMac()  ? KeyModifier.CTRL : null));
 975         assertTrue(isSelected(3,5));
 976         assertTrue(isAnchor(3));
 977 
 978         keyboard.doUpArrowPress(KeyModifier.SHIFT, KeyModifier.getShortcutKey());
 979         keyboard.doUpArrowPress(KeyModifier.SHIFT, KeyModifier.getShortcutKey());
 980         assertTrue(isSelected(1,2,3,5));
 981         assertTrue(isAnchor(3));
 982         // end of similarities
 983 
 984         keyboard.doDownArrowPress(KeyModifier.SHIFT, KeyModifier.getShortcutKey());
 985         keyboard.doDownArrowPress(KeyModifier.SHIFT, KeyModifier.getShortcutKey());
 986         keyboard.doDownArrowPress(KeyModifier.SHIFT, KeyModifier.getShortcutKey());
 987         assertTrue(isSelected(1,2,3,4,5));
 988         assertTrue(isAnchor(3));
 989     }
 990 
 991     // Test 5 (need Page down support)
 992 //    @Test public void test_5() {
 993 //        // same as test 1 above
 994 //        sm.clearAndSelect(0);
 995 //        keyboard.doDownArrowPress(KeyModifier.getShortcutKey());
 996 //        keyboard.doDownArrowPress(KeyModifier.getShortcutKey());
 997 //        keyboard.doKeyPress(KeyCode.SPACE,
 998 //                KeyModifier.getShortcutKey(),
 999 //                (Utils.isMac()  ? KeyModifier.CTRL : null));
1000 //        assertTrue(isSelected(0,2));
1001 //        assertTrue(isAnchor(2));
1002 //        // end of similarities
1003 //
1004 //        keyboard.doKeyPress(KeyCode.PAGE_DOWN, KeyModifier.SHIFT, KeyModifier.getShortcutKey());
1005 //        assertTrue(isSelected(0,2,/*until end of page */));
1006 //        assertTrue(isAnchor(2));
1007 //    }
1008 
1009     // Test 6
1010     @Test public void test_rt18591_row_6() {
1011         sm.clearAndSelect(10);
1012         keyboard.doUpArrowPress(KeyModifier.getShortcutKey());
1013         keyboard.doUpArrowPress(KeyModifier.getShortcutKey());
1014         keyboard.doKeyPress(KeyCode.SPACE,
1015                 KeyModifier.getShortcutKey(),
1016                 (Utils.isMac() ? KeyModifier.CTRL : null));
1017         assertTrue(debug(), isSelected(8,10));
1018         assertTrue(isAnchor(8));
1019 
1020         keyboard.doKeyPress(KeyCode.PAGE_UP, KeyModifier.SHIFT, KeyModifier.getShortcutKey());
1021         assertTrue(debug(), isSelected(0,1,2,3,4,5,6,7,8,10));
1022         assertTrue(isAnchor(8));
1023     }
1024 
1025 //    // Test 7
1026 //    @Test public void test_rt18591_row_7() {
1027 //        sm.clearAndSelect(0);
1028 //        keyboard.doDownArrowPress(KeyModifier.getShortcutKey());
1029 //        keyboard.doDownArrowPress(KeyModifier.getShortcutKey());
1030 //        keyboard.doKeyPress(KeyCode.SPACE,
1031 //                KeyModifier.getShortcutKey(),
1032 //                (Utils.isMac()  ? KeyModifier.CTRL : null));
1033 //        assertTrue(isSelected(0,2));
1034 //        assertTrue(isAnchor(2));
1035 //
1036 //        keyboard.doKeyPress(KeyCode.PAGE_DOWN, KeyModifier.SHIFT, KeyModifier.getShortcutKey());
1037 //        keyboard.doKeyPress(KeyCode.PAGE_DOWN, KeyModifier.SHIFT, KeyModifier.getShortcutKey());
1038 //        assertTrue(isSelected(0,2,3,4,5,6,7,8,10)); // this isn&#39;t right
1039 //        assertTrue(isAnchor(8));
1040 //
1041 //        // NOT COMPLETE
1042 //    }
1043 //
1044 //    // Test 8
1045 //    @Test public void test_rt18591_row_8() {
1046 //        // NOT COMPLETE
1047 //    }
1048 
1049     // Test 9
1050     @Test public void test_rt18591_row_9() {
1051         sm.clearAndSelect(0);
1052         keyboard.doDownArrowPress(KeyModifier.getShortcutKey());
1053         keyboard.doDownArrowPress(KeyModifier.getShortcutKey());
1054         keyboard.doKeyPress(KeyCode.SPACE,
1055                 KeyModifier.getShortcutKey(),
1056                 (Utils.isMac()  ? KeyModifier.CTRL : null));
1057         assertTrue(isSelected(0,2));
1058         assertTrue(isAnchor(2));
1059 
1060         keyboard.doKeyPress(KeyCode.END, KeyModifier.SHIFT, KeyModifier.getShortcutKey());
1061         assertTrue(isSelected(0,2,3,4,5,6,7,8,9));
1062         assertTrue(isAnchor(2));
1063     }
1064 
1065     // Test 10
1066     @Test public void test_rt18591_row_10() {
1067         sm.clearAndSelect(8);
1068         keyboard.doUpArrowPress(KeyModifier.getShortcutKey());
1069         keyboard.doUpArrowPress(KeyModifier.getShortcutKey());
1070         keyboard.doKeyPress(KeyCode.SPACE,
1071                 KeyModifier.getShortcutKey(),
1072                 (Utils.isMac()  ? KeyModifier.CTRL : null));
1073         assertTrue(isSelected(6,8));
1074         assertTrue(isAnchor(6));
1075 
1076         keyboard.doKeyPress(KeyCode.HOME, KeyModifier.SHIFT, KeyModifier.getShortcutKey());
1077         assertTrue(isSelected(0,1,2,3,4,5,6,8));
1078         assertTrue(isAnchor(6));
1079     }
1080 
1081     // Test 11
1082     @Test public void test_rt18591_row_11() {
1083         sm.clearAndSelect(5);
1084         keyboard.doKeyPress(KeyCode.HOME, KeyModifier.SHIFT, KeyModifier.getShortcutKey());
1085         assertTrue(isSelected(0,1,2,3,4,5));
1086         assertTrue(isAnchor(5));
1087 
1088         keyboard.doKeyPress(KeyCode.END, KeyModifier.SHIFT, KeyModifier.getShortcutKey());
1089         assertTrue(isSelected(0,1,2,3,4,5,6,7,8,9));
1090         assertTrue(isAnchor(5));
1091     }
1092 
1093     // Test 12
1094     @Test public void test_rt18591_row_12() {
1095         sm.clearAndSelect(0);
1096         keyboard.doDownArrowPress(KeyModifier.getShortcutKey());
1097         keyboard.doDownArrowPress(KeyModifier.getShortcutKey());
1098         keyboard.doKeyPress(KeyCode.SPACE,
1099                 KeyModifier.getShortcutKey(),
1100                 (Utils.isMac()  ? KeyModifier.CTRL : null));
1101         assertTrue(isSelected(0,2));
1102         assertTrue(isAnchor(2));
1103 
1104         keyboard.doDownArrowPress(KeyModifier.SHIFT, KeyModifier.getShortcutKey());
1105         keyboard.doDownArrowPress(KeyModifier.SHIFT, KeyModifier.getShortcutKey());
1106         assertTrue(isSelected(0,2,3,4));
1107         assertTrue(isAnchor(2));
1108 
1109         keyboard.doUpArrowPress(KeyModifier.SHIFT, KeyModifier.getShortcutKey());
1110         keyboard.doUpArrowPress(KeyModifier.SHIFT, KeyModifier.getShortcutKey());
1111         keyboard.doUpArrowPress(KeyModifier.SHIFT, KeyModifier.getShortcutKey());
1112         assertTrue(isSelected(0,1,2,3,4));
1113         assertTrue(isAnchor(2));
1114 
1115         keyboard.doUpArrowPress(KeyModifier.getShortcutKey());
1116         keyboard.doKeyPress(KeyCode.SPACE,
1117                 KeyModifier.getShortcutKey(),
1118                 (Utils.isMac()  ? KeyModifier.CTRL : null));
1119         assertTrue(isSelected(1,2,3,4));
1120         assertTrue(isAnchor(0));
1121         assertTrue(fm.isFocused(0));
1122     }
1123 
1124 
1125     /***************************************************************************
1126      * Tests for discontinuous multiple cell selection (RT-18951)
1127      **************************************************************************/
1128 
1129     // Test 1
1130     @Test public void test_rt18591_cell_1() {
1131         sm.setSelectionMode(SelectionMode.MULTIPLE);
1132         sm.setCellSelectionEnabled(true);
1133         sm.select(0, col0);
<a name="10" id="anc10"></a><span class="line-modified">1134 </span>
<span class="line-modified">1135         if (orientation == NodeOrientation.LEFT_TO_RIGHT) {</span>
<span class="line-added">1136             keyboard.doRightArrowPress(KeyModifier.getShortcutKey());</span>
<span class="line-added">1137             keyboard.doRightArrowPress(KeyModifier.getShortcutKey());</span>
<span class="line-added">1138         } else if (orientation == NodeOrientation.RIGHT_TO_LEFT) {</span>
<span class="line-added">1139             keyboard.doLeftArrowPress(KeyModifier.getShortcutKey());</span>
<span class="line-added">1140             keyboard.doLeftArrowPress(KeyModifier.getShortcutKey());</span>
<span class="line-added">1141         }</span>
1142         keyboard.doKeyPress(KeyCode.SPACE,
1143                 KeyModifier.getShortcutKey(),
1144                 (Utils.isMac()  ? KeyModifier.CTRL : null));
1145         assertTrue(sm.isSelected(0,col0));
1146         assertTrue(sm.isSelected(0,col2));
1147         assertTrue(isAnchor(0,2));
1148 
<a name="11" id="anc11"></a><span class="line-modified">1149         if (orientation == NodeOrientation.LEFT_TO_RIGHT) {</span>
<span class="line-modified">1150             keyboard.doRightArrowPress(KeyModifier.SHIFT, KeyModifier.getShortcutKey());</span>
<span class="line-added">1151             keyboard.doRightArrowPress(KeyModifier.SHIFT, KeyModifier.getShortcutKey());</span>
<span class="line-added">1152         } else if (orientation == NodeOrientation.RIGHT_TO_LEFT) {</span>
<span class="line-added">1153             keyboard.doLeftArrowPress(KeyModifier.SHIFT, KeyModifier.getShortcutKey());</span>
<span class="line-added">1154             keyboard.doLeftArrowPress(KeyModifier.SHIFT, KeyModifier.getShortcutKey());</span>
<span class="line-added">1155         }</span>
1156         assertTrue(sm.isSelected(0,col0));
1157         assertTrue(sm.isSelected(0,col2));
1158         assertTrue(sm.isSelected(0,col3));
1159         assertTrue(sm.isSelected(0,col4));
1160         assertTrue(isAnchor(0,2));
1161     }
1162 
1163     // Test 2
1164     @Test public void test_rt18591_cell_2() {
1165         sm.setSelectionMode(SelectionMode.MULTIPLE);
1166         sm.setCellSelectionEnabled(true);
1167         sm.select(0, col4);
<a name="12" id="anc12"></a><span class="line-modified">1168         if (orientation == NodeOrientation.LEFT_TO_RIGHT) {</span>
<span class="line-modified">1169             keyboard.doLeftArrowPress(KeyModifier.getShortcutKey());</span>
<span class="line-added">1170             keyboard.doLeftArrowPress(KeyModifier.getShortcutKey());</span>
<span class="line-added">1171         } else if (orientation == NodeOrientation.RIGHT_TO_LEFT) {</span>
<span class="line-added">1172             keyboard.doRightArrowPress(KeyModifier.getShortcutKey());</span>
<span class="line-added">1173             keyboard.doRightArrowPress(KeyModifier.getShortcutKey());</span>
<span class="line-added">1174         }</span>
1175         keyboard.doKeyPress(KeyCode.SPACE,
1176                 KeyModifier.getShortcutKey(),
1177                 (Utils.isMac()  ? KeyModifier.CTRL : null));
1178         assertTrue(sm.isSelected(0,col4));
1179         assertTrue(sm.isSelected(0,col2));
1180         assertTrue(isAnchor(0,2));
1181 
<a name="13" id="anc13"></a><span class="line-modified">1182         if (orientation == NodeOrientation.LEFT_TO_RIGHT) {</span>
<span class="line-modified">1183             keyboard.doLeftArrowPress(KeyModifier.SHIFT, KeyModifier.getShortcutKey());</span>
<span class="line-added">1184             keyboard.doLeftArrowPress(KeyModifier.SHIFT, KeyModifier.getShortcutKey());</span>
<span class="line-added">1185         } else if (orientation == NodeOrientation.RIGHT_TO_LEFT) {</span>
<span class="line-added">1186             keyboard.doRightArrowPress(KeyModifier.SHIFT, KeyModifier.getShortcutKey());</span>
<span class="line-added">1187             keyboard.doRightArrowPress(KeyModifier.SHIFT, KeyModifier.getShortcutKey());</span>
<span class="line-added">1188         }</span>
1189         assertTrue(sm.isSelected(0,col0));
1190         assertTrue(sm.isSelected(0,col1));
1191         assertTrue(sm.isSelected(0,col2));
1192         assertTrue(sm.isSelected(0,col4));
1193         assertTrue(isAnchor(0,2));
1194     }
1195 
1196     // Test 3
1197     @Test public void test_rt18591_cell_3() {
1198         sm.setSelectionMode(SelectionMode.MULTIPLE);
1199         sm.setCellSelectionEnabled(true);
1200         sm.select(0, col0);
<a name="14" id="anc14"></a><span class="line-modified">1201         if (orientation == NodeOrientation.LEFT_TO_RIGHT) {</span>
<span class="line-modified">1202             keyboard.doRightArrowPress(KeyModifier.getShortcutKey());</span>
<span class="line-added">1203             keyboard.doRightArrowPress(KeyModifier.getShortcutKey());</span>
<span class="line-added">1204         } else if (orientation == NodeOrientation.RIGHT_TO_LEFT) {</span>
<span class="line-added">1205             keyboard.doLeftArrowPress(KeyModifier.getShortcutKey());</span>
<span class="line-added">1206             keyboard.doLeftArrowPress(KeyModifier.getShortcutKey());</span>
<span class="line-added">1207         }</span>
1208         keyboard.doKeyPress(KeyCode.SPACE,
1209                 KeyModifier.getShortcutKey(),
1210                 (Utils.isMac()  ? KeyModifier.CTRL : null));
1211         assertTrue(sm.isSelected(0,col0));
1212         assertTrue(sm.isSelected(0,col2));
1213         assertTrue(isAnchor(0,2));
1214 
<a name="15" id="anc15"></a><span class="line-modified">1215         if (orientation == NodeOrientation.LEFT_TO_RIGHT) {</span>
<span class="line-modified">1216             keyboard.doRightArrowPress(KeyModifier.SHIFT, KeyModifier.getShortcutKey());</span>
<span class="line-added">1217             keyboard.doRightArrowPress(KeyModifier.SHIFT, KeyModifier.getShortcutKey());</span>
<span class="line-added">1218         } else if (orientation == NodeOrientation.RIGHT_TO_LEFT) {</span>
<span class="line-added">1219             keyboard.doLeftArrowPress(KeyModifier.SHIFT, KeyModifier.getShortcutKey());</span>
<span class="line-added">1220             keyboard.doLeftArrowPress(KeyModifier.SHIFT, KeyModifier.getShortcutKey());</span>
<span class="line-added">1221         }</span>
1222         assertTrue(sm.isSelected(0,col0));
1223         assertTrue(sm.isSelected(0,col2));
1224         assertTrue(sm.isSelected(0,col3));
1225         assertTrue(sm.isSelected(0,col4));
1226         assertTrue(isAnchor(0,2));
1227 
<a name="16" id="anc16"></a><span class="line-modified">1228         if (orientation == NodeOrientation.LEFT_TO_RIGHT) {</span>
<span class="line-modified">1229             keyboard.doLeftArrowPress(KeyModifier.SHIFT, KeyModifier.getShortcutKey());</span>
<span class="line-modified">1230             keyboard.doLeftArrowPress(KeyModifier.SHIFT, KeyModifier.getShortcutKey());</span>
<span class="line-added">1231             keyboard.doLeftArrowPress(KeyModifier.SHIFT, KeyModifier.getShortcutKey());</span>
<span class="line-added">1232         } else if (orientation == NodeOrientation.RIGHT_TO_LEFT) {</span>
<span class="line-added">1233             keyboard.doRightArrowPress(KeyModifier.SHIFT, KeyModifier.getShortcutKey());</span>
<span class="line-added">1234             keyboard.doRightArrowPress(KeyModifier.SHIFT, KeyModifier.getShortcutKey());</span>
<span class="line-added">1235             keyboard.doRightArrowPress(KeyModifier.SHIFT, KeyModifier.getShortcutKey());</span>
<span class="line-added">1236         }</span>
1237         assertTrue(sm.isSelected(0,col0));
1238         assertTrue(sm.isSelected(0,col1));
1239         assertTrue(sm.isSelected(0,col2));
1240         assertTrue(sm.isSelected(0,col3));
1241         assertTrue(sm.isSelected(0,col4));
1242         assertTrue(isAnchor(0,2));
1243     }
1244 
1245     // Test 4
1246     @Test public void test_rt18591_cell_4() {
1247         sm.setSelectionMode(SelectionMode.MULTIPLE);
1248         sm.setCellSelectionEnabled(true);
1249         sm.select(0, col4);
<a name="17" id="anc17"></a><span class="line-modified">1250 </span>
<span class="line-modified">1251         if (orientation == NodeOrientation.LEFT_TO_RIGHT) {</span>
<span class="line-added">1252             keyboard.doLeftArrowPress(KeyModifier.getShortcutKey());</span>
<span class="line-added">1253             keyboard.doLeftArrowPress(KeyModifier.getShortcutKey());</span>
<span class="line-added">1254         } else if (orientation == NodeOrientation.RIGHT_TO_LEFT) {</span>
<span class="line-added">1255             keyboard.doRightArrowPress(KeyModifier.getShortcutKey());</span>
<span class="line-added">1256             keyboard.doRightArrowPress(KeyModifier.getShortcutKey());</span>
<span class="line-added">1257         }</span>
1258         keyboard.doKeyPress(KeyCode.SPACE,
1259                 KeyModifier.getShortcutKey(),
1260                 (Utils.isMac()  ? KeyModifier.CTRL : null));
1261         assertTrue(sm.isSelected(0,col4));
1262         assertTrue(sm.isSelected(0,col2));
1263         assertTrue(isAnchor(0,2));
1264 
<a name="18" id="anc18"></a><span class="line-modified">1265         if (orientation == NodeOrientation.LEFT_TO_RIGHT) {</span>
<span class="line-modified">1266             keyboard.doLeftArrowPress(KeyModifier.SHIFT, KeyModifier.getShortcutKey());</span>
<span class="line-added">1267             keyboard.doLeftArrowPress(KeyModifier.SHIFT, KeyModifier.getShortcutKey());</span>
<span class="line-added">1268         } else if (orientation == NodeOrientation.RIGHT_TO_LEFT) {</span>
<span class="line-added">1269             keyboard.doRightArrowPress(KeyModifier.SHIFT, KeyModifier.getShortcutKey());</span>
<span class="line-added">1270             keyboard.doRightArrowPress(KeyModifier.SHIFT, KeyModifier.getShortcutKey());</span>
<span class="line-added">1271         }</span>
1272         assertTrue(sm.isSelected(0,col0));
1273         assertTrue(sm.isSelected(0,col1));
1274         assertTrue(sm.isSelected(0,col2));
1275         assertTrue(sm.isSelected(0,col4));
1276         assertTrue(isAnchor(0,2));
1277 
<a name="19" id="anc19"></a><span class="line-modified">1278         if (orientation == NodeOrientation.LEFT_TO_RIGHT) {</span>
<span class="line-modified">1279             keyboard.doRightArrowPress(KeyModifier.SHIFT, KeyModifier.getShortcutKey());</span>
<span class="line-modified">1280             keyboard.doRightArrowPress(KeyModifier.SHIFT, KeyModifier.getShortcutKey());</span>
<span class="line-added">1281             keyboard.doRightArrowPress(KeyModifier.SHIFT, KeyModifier.getShortcutKey());</span>
<span class="line-added">1282         } else if (orientation == NodeOrientation.RIGHT_TO_LEFT) {</span>
<span class="line-added">1283             keyboard.doLeftArrowPress(KeyModifier.SHIFT, KeyModifier.getShortcutKey());</span>
<span class="line-added">1284             keyboard.doLeftArrowPress(KeyModifier.SHIFT, KeyModifier.getShortcutKey());</span>
<span class="line-added">1285             keyboard.doLeftArrowPress(KeyModifier.SHIFT, KeyModifier.getShortcutKey());</span>
<span class="line-added">1286         }</span>
1287         assertTrue(sm.isSelected(0,col0));
1288         assertTrue(sm.isSelected(0,col1));
1289         assertTrue(sm.isSelected(0,col2));
1290         assertTrue(sm.isSelected(0,col3));
1291         assertTrue(sm.isSelected(0,col4));
1292         assertTrue(isAnchor(0,2));
1293     }
1294 
1295     // Test 5
1296     @Test public void test_rt18591_cell_5() {
1297         sm.setSelectionMode(SelectionMode.MULTIPLE);
1298         sm.setCellSelectionEnabled(true);
1299         sm.select(0, col1);
1300         keyboard.doDownArrowPress(KeyModifier.getShortcutKey());
1301         keyboard.doDownArrowPress(KeyModifier.getShortcutKey());
1302         keyboard.doKeyPress(KeyCode.SPACE,
1303                 KeyModifier.getShortcutKey(),
1304                 (Utils.isMac()  ? KeyModifier.CTRL : null));
1305         assertTrue(sm.isSelected(0,col1));
1306         assertTrue(sm.isSelected(2,col1));
1307         assertTrue(isAnchor(2,1));
1308 
1309         keyboard.doDownArrowPress(KeyModifier.SHIFT, KeyModifier.getShortcutKey());
1310         keyboard.doDownArrowPress(KeyModifier.SHIFT, KeyModifier.getShortcutKey());
1311         assertTrue(sm.isSelected(0,col1));
1312         assertTrue(sm.isSelected(2,col1));
1313         assertTrue(sm.isSelected(3,col1));
1314         assertTrue(sm.isSelected(4,col1));
1315         assertTrue(isAnchor(2,1));
1316     }
1317 
1318     // Test 6
1319     @Test public void test_rt18591_cell_6() {
1320         sm.setSelectionMode(SelectionMode.MULTIPLE);
1321         sm.setCellSelectionEnabled(true);
1322         sm.select(5, col1);
1323         keyboard.doUpArrowPress(KeyModifier.getShortcutKey());
1324         keyboard.doUpArrowPress(KeyModifier.getShortcutKey());
1325         keyboard.doKeyPress(KeyCode.SPACE,
1326                 KeyModifier.getShortcutKey(),
1327                 (Utils.isMac()  ? KeyModifier.CTRL : null));
1328         assertTrue(sm.isSelected(5,col1));
1329         assertTrue(sm.isSelected(3,col1));
1330         assertTrue(isAnchor(3,1));
1331 
1332         keyboard.doUpArrowPress(KeyModifier.SHIFT, KeyModifier.getShortcutKey());
1333         keyboard.doUpArrowPress(KeyModifier.SHIFT, KeyModifier.getShortcutKey());
1334         assertTrue(sm.isSelected(1,col1));
1335         assertTrue(sm.isSelected(2,col1));
1336         assertTrue(sm.isSelected(3,col1));
1337         assertTrue(sm.isSelected(5,col1));
1338         assertTrue(isAnchor(3,1));
1339     }
1340 
1341     // Test 7
1342     @Test public void test_rt18591_cell_7() {
1343         sm.setSelectionMode(SelectionMode.MULTIPLE);
1344         sm.setCellSelectionEnabled(true);
1345         sm.select(0, col1);
1346         keyboard.doDownArrowPress(KeyModifier.getShortcutKey());
1347         keyboard.doDownArrowPress(KeyModifier.getShortcutKey());
1348         keyboard.doKeyPress(KeyCode.SPACE,
1349                 KeyModifier.getShortcutKey(),
1350                 (Utils.isMac()  ? KeyModifier.CTRL : null));
1351         assertTrue(sm.isSelected(0,col1));
1352         assertTrue(sm.isSelected(2,col1));
1353         assertTrue(isAnchor(2,1));
1354 
1355         keyboard.doDownArrowPress(KeyModifier.SHIFT, KeyModifier.getShortcutKey());
1356         keyboard.doDownArrowPress(KeyModifier.SHIFT, KeyModifier.getShortcutKey());
1357         assertTrue(sm.isSelected(0,col1));
1358         assertTrue(sm.isSelected(2,col1));
1359         assertTrue(sm.isSelected(3,col1));
1360         assertTrue(sm.isSelected(4,col1));
1361         assertTrue(isAnchor(2,1));
1362 
1363         keyboard.doUpArrowPress(KeyModifier.SHIFT, KeyModifier.getShortcutKey());
1364         keyboard.doUpArrowPress(KeyModifier.SHIFT, KeyModifier.getShortcutKey());
1365         keyboard.doUpArrowPress(KeyModifier.SHIFT, KeyModifier.getShortcutKey());
1366         assertTrue(sm.isSelected(0,col1));
1367         assertTrue(sm.isSelected(1,col1));
1368         assertTrue(sm.isSelected(2,col1));
1369         assertTrue(sm.isSelected(3,col1));
1370         assertTrue(sm.isSelected(4,col1));
1371         assertTrue(isAnchor(2,1));
1372     }
1373 
1374     // Test 8
1375     @Test public void test_rt18591_cell_8() {
1376         sm.setSelectionMode(SelectionMode.MULTIPLE);
1377         sm.setCellSelectionEnabled(true);
1378         sm.select(5, col1);
1379         keyboard.doUpArrowPress(KeyModifier.getShortcutKey());
1380         keyboard.doUpArrowPress(KeyModifier.getShortcutKey());
1381         keyboard.doKeyPress(KeyCode.SPACE,
1382                 KeyModifier.getShortcutKey(),
1383                 (Utils.isMac()  ? KeyModifier.CTRL : null));
1384         assertTrue(sm.isSelected(5,col1));
1385         assertTrue(sm.isSelected(3,col1));
1386         assertTrue(isAnchor(3,1));
1387 
1388         keyboard.doUpArrowPress(KeyModifier.SHIFT, KeyModifier.getShortcutKey());
1389         keyboard.doUpArrowPress(KeyModifier.SHIFT, KeyModifier.getShortcutKey());
1390         assertTrue(sm.isSelected(1,col1));
1391         assertTrue(sm.isSelected(2,col1));
1392         assertTrue(sm.isSelected(3,col1));
1393         assertTrue(sm.isSelected(5,col1));
1394         assertTrue(isAnchor(3,1));
1395 
1396         keyboard.doDownArrowPress(KeyModifier.SHIFT, KeyModifier.getShortcutKey());
1397         keyboard.doDownArrowPress(KeyModifier.SHIFT, KeyModifier.getShortcutKey());
1398         keyboard.doDownArrowPress(KeyModifier.SHIFT, KeyModifier.getShortcutKey());
1399         assertTrue(sm.isSelected(1,col1));
1400         assertTrue(sm.isSelected(2,col1));
1401         assertTrue(sm.isSelected(3,col1));
1402         assertTrue(sm.isSelected(4,col1));
1403         assertTrue(sm.isSelected(5,col1));
1404         assertTrue(isAnchor(3,1));
1405     }
1406 
1407     // Skipped tests 9 - 12 as they require Page Up/Down support
1408 
1409     // Test 13
1410     @Test public void test_rt18591_cell_13() {
1411         sm.setSelectionMode(SelectionMode.MULTIPLE);
1412         sm.setCellSelectionEnabled(true);
1413         sm.select(0, col1);
1414         keyboard.doDownArrowPress(KeyModifier.getShortcutKey());
1415         keyboard.doDownArrowPress(KeyModifier.getShortcutKey());
1416         keyboard.doKeyPress(KeyCode.SPACE,
1417                 KeyModifier.getShortcutKey(),
1418                 (Utils.isMac()  ? KeyModifier.CTRL : null));
1419         assertTrue(sm.isSelected(0,col1));
1420         assertTrue(sm.isSelected(2,col1));
1421         assertTrue(isAnchor(2,1));
1422 
1423         keyboard.doKeyPress(KeyCode.END, KeyModifier.SHIFT, KeyModifier.getShortcutKey());
1424         assertTrue(sm.isSelected(0,col1));
1425         for (int i = 2; i &lt; tableView.getItems().size(); i++) {
1426             assertTrue(debug(),sm.isSelected(i,col1));
1427         }
1428         assertTrue(isAnchor(2,1));
1429     }
1430 
1431     // Test 14
1432     @Test public void test_rt18591_cell_14() {
1433         int n = tableView.getItems().size() - 1;
1434         sm.setSelectionMode(SelectionMode.MULTIPLE);
1435         sm.setCellSelectionEnabled(true);
1436         sm.select(n, col1);
1437         keyboard.doUpArrowPress(KeyModifier.getShortcutKey());
1438         keyboard.doUpArrowPress(KeyModifier.getShortcutKey());
1439         keyboard.doKeyPress(KeyCode.SPACE,
1440                 KeyModifier.getShortcutKey(),
1441                 (Utils.isMac()  ? KeyModifier.CTRL : null));
1442         assertTrue(sm.isSelected(n,col1));
1443         assertTrue(sm.isSelected(n - 2,col1));
1444         assertTrue(isAnchor(n - 2,1));
1445 
1446         keyboard.doKeyPress(KeyCode.HOME, KeyModifier.SHIFT, KeyModifier.getShortcutKey());
1447         assertTrue(sm.isSelected(n,col1));
1448         for (int i = 0; i &lt; n - 2; i++) {
1449             assertTrue(sm.isSelected(i,col1));
1450         }
1451         assertTrue(isAnchor(n - 2,1));
1452     }
1453 
1454     // Test 15
1455     @Test public void test_rt18591_cell_15() {
1456         sm.setSelectionMode(SelectionMode.MULTIPLE);
1457         sm.setCellSelectionEnabled(true);
1458         sm.select(5, col1);
1459         assertTrue(debug(), isAnchor(5,1));
1460 
1461         keyboard.doKeyPress(KeyCode.HOME, KeyModifier.SHIFT, KeyModifier.getShortcutKey());
1462         for (int i = 0; i &lt;= 5; i++) {
1463             assertTrue(sm.isSelected(i,col1));
1464         }
1465         assertTrue(debug(), isAnchor(5,1));
1466 
1467         keyboard.doKeyPress(KeyCode.END, KeyModifier.SHIFT, KeyModifier.getShortcutKey());
1468         for (int i = 0; i &lt; tableView.getItems().size() - 1; i++) {
1469             assertTrue(sm.isSelected(i,col1));
1470         }
1471         assertTrue(isAnchor(5,1));
1472     }
1473 
1474     // Test 16
1475     @Test public void test_rt18591_cell_16() {
1476         sm.setSelectionMode(SelectionMode.MULTIPLE);
1477         sm.setCellSelectionEnabled(true);
1478         sm.select(0, col1);
1479         keyboard.doDownArrowPress(KeyModifier.getShortcutKey());
1480         keyboard.doDownArrowPress(KeyModifier.getShortcutKey());
1481         keyboard.doKeyPress(KeyCode.SPACE,
1482                 KeyModifier.getShortcutKey(),
1483                 (Utils.isMac()  ? KeyModifier.CTRL : null));
1484         assertTrue(sm.isSelected(0,col1));
1485         assertTrue(sm.isSelected(2,col1));
1486         assertTrue(isAnchor(2,1));
1487 
1488         keyboard.doDownArrowPress(KeyModifier.SHIFT, KeyModifier.getShortcutKey());
1489         keyboard.doDownArrowPress(KeyModifier.SHIFT, KeyModifier.getShortcutKey());
1490         assertTrue(sm.isSelected(0,col1));
1491         assertTrue(sm.isSelected(2,col1));
1492         assertTrue(sm.isSelected(3,col1));
1493         assertTrue(sm.isSelected(4,col1));
1494         assertTrue(isAnchor(2,1));
1495 
1496         keyboard.doUpArrowPress(KeyModifier.SHIFT, KeyModifier.getShortcutKey());
1497         keyboard.doUpArrowPress(KeyModifier.SHIFT, KeyModifier.getShortcutKey());
1498         keyboard.doUpArrowPress(KeyModifier.SHIFT, KeyModifier.getShortcutKey());
1499         assertTrue(sm.isSelected(0,col1));
1500         assertTrue(sm.isSelected(1,col1));
1501         assertTrue(sm.isSelected(2,col1));
1502         assertTrue(sm.isSelected(3,col1));
1503         assertTrue(sm.isSelected(4,col1));
1504         assertTrue(isAnchor(2,1));
1505 
1506         keyboard.doUpArrowPress(KeyModifier.getShortcutKey());
1507         keyboard.doKeyPress(KeyCode.SPACE,
1508                 KeyModifier.getShortcutKey(),
1509                 (Utils.isMac()  ? KeyModifier.CTRL : null));
1510         assertFalse(sm.isSelected(0,col1));
1511         assertTrue(sm.isSelected(1,col1));
1512         assertTrue(sm.isSelected(2,col1));
1513         assertTrue(sm.isSelected(3,col1));
1514         assertTrue(sm.isSelected(4,col1));
1515         assertTrue(isAnchor(0,1));
1516         assertTrue(fm.isFocused(0,col1));
1517     }
1518 
1519 //    // Test 17
1520 //    @Test public void test_rt18591_cell_17() {
1521 //        sm.setSelectionMode(SelectionMode.MULTIPLE);
1522 //        sm.setCellSelectionEnabled(true);
1523 //        sm.select(3, col1);
1524 //        keyboard.doRightArrowPress(KeyModifier.getShortcutKey());
1525 //        keyboard.doRightArrowPress(KeyModifier.getShortcutKey());
1526 //        keyboard.doKeyPress(KeyCode.SPACE,
1527 //                KeyModifier.getShortcutKey(),
1528 //                (Utils.isMac()  ? KeyModifier.CTRL : null));
1529 //        assertTrue(sm.isSelected(3,col1));
1530 //        assertTrue(sm.isSelected(3,col3));
1531 //        assertTrue(isAnchor(3,3));
1532 //
1533 //        keyboard.doRightArrowPress(KeyModifier.SHIFT, KeyModifier.getShortcutKey());
1534 //        assertTrue(sm.isSelected(3,col1));
1535 //        assertTrue(sm.isSelected(3,col3));
1536 //        assertTrue(sm.isSelected(3,col4));
1537 //        assertTrue(isAnchor(3,3));
1538 //
1539 //        keyboard.doDownArrowPress(KeyModifier.SHIFT, KeyModifier.getShortcutKey());
1540 //        keyboard.doDownArrowPress(KeyModifier.SHIFT, KeyModifier.getShortcutKey());
1541 //        assertTrue(sm.isSelected(3,col1));
1542 //        assertTrue(sm.isSelected(3,col3));
1543 //        assertTrue(sm.isSelected(3,col4));
1544 //        assertTrue(sm.isSelected(4,col3));
1545 //        assertTrue(sm.isSelected(5,col3));
1546 //        assertTrue(isAnchor(3,3));
1547 //    }
1548 
1549 
1550     /***************************************************************************
1551      * Tests for specific bug reports
1552      **************************************************************************/
1553 
1554     @Test public void test_rt18488_selectToLeft() {
1555         sm.setCellSelectionEnabled(true);
1556         sm.clearAndSelect(1, col4);
1557 
1558         keyboard.doLeftArrowPress(KeyModifier.SHIFT);   // select (1, col4)
1559         keyboard.doLeftArrowPress(KeyModifier.SHIFT);   // select (1, col3)
1560         keyboard.doLeftArrowPress(KeyModifier.SHIFT);   // select (1, col2)
1561         keyboard.doLeftArrowPress(KeyModifier.SHIFT);   // select (1, col1)
<a name="20" id="anc20"></a><span class="line-modified">1562 </span>
<span class="line-modified">1563         if (orientation == NodeOrientation.LEFT_TO_RIGHT) {</span>
<span class="line-modified">1564             assertTrue(sm.isSelected(1, col4));</span>
<span class="line-modified">1565             assertTrue(sm.isSelected(1, col3));</span>
<span class="line-modified">1566             assertTrue(sm.isSelected(1, col2));</span>
<span class="line-added">1567             assertTrue(sm.isSelected(1, col1));</span>
<span class="line-added">1568             assertTrue(sm.isSelected(1, col0));</span>
<span class="line-added">1569         } else if (orientation == NodeOrientation.RIGHT_TO_LEFT) {</span>
<span class="line-added">1570             assertTrue(sm.isSelected(1, col4));</span>
<span class="line-added">1571             assertFalse(sm.isSelected(1, col3));</span>
<span class="line-added">1572             assertFalse(sm.isSelected(1, col2));</span>
<span class="line-added">1573             assertFalse(sm.isSelected(1, col1));</span>
<span class="line-added">1574             assertFalse(sm.isSelected(1, col0));</span>
<span class="line-added">1575         }</span>
1576 
1577         keyboard.doRightArrowPress(KeyModifier.SHIFT);   // deselect (1, col1)
<a name="21" id="anc21"></a><span class="line-modified">1578 </span>
<span class="line-modified">1579         if (orientation == NodeOrientation.LEFT_TO_RIGHT) {</span>
<span class="line-modified">1580             assertTrue(sm.isSelected(1, col4));</span>
<span class="line-modified">1581             assertTrue(sm.isSelected(1, col3));</span>
<span class="line-modified">1582             assertTrue(sm.isSelected(1, col2));</span>
<span class="line-added">1583             assertTrue(debug(), sm.isSelected(1, col1));</span>
<span class="line-added">1584             assertFalse(sm.isSelected(1, col0));</span>
<span class="line-added">1585         } else if (orientation == NodeOrientation.RIGHT_TO_LEFT) {</span>
<span class="line-added">1586             assertTrue(sm.isSelected(1, col4));</span>
<span class="line-added">1587             assertTrue(sm.isSelected(1, col3));</span>
<span class="line-added">1588         }</span>
1589     }
1590 
1591     @Test public void test_rt18488_selectToRight() {
1592         sm.setCellSelectionEnabled(true);
1593         sm.clearAndSelect(1, col0);
1594 
1595         keyboard.doRightArrowPress(KeyModifier.SHIFT);   // select (1, col2)
1596         keyboard.doRightArrowPress(KeyModifier.SHIFT);   // select (1, col3)
1597         keyboard.doRightArrowPress(KeyModifier.SHIFT);   // select (1, col4)
1598         keyboard.doRightArrowPress(KeyModifier.SHIFT);   // select (1, col5)
<a name="22" id="anc22"></a><span class="line-modified">1599 </span>
<span class="line-modified">1600         if (orientation == NodeOrientation.LEFT_TO_RIGHT) {</span>
<span class="line-modified">1601             assertTrue(sm.isSelected(1, col4));</span>
<span class="line-modified">1602             assertTrue(sm.isSelected(1, col3));</span>
<span class="line-modified">1603             assertTrue(sm.isSelected(1, col2));</span>
<span class="line-added">1604             assertTrue(sm.isSelected(1, col1));</span>
<span class="line-added">1605             assertTrue(sm.isSelected(1, col0));</span>
<span class="line-added">1606         } else if (orientation == NodeOrientation.RIGHT_TO_LEFT) {</span>
<span class="line-added">1607             assertFalse(sm.isSelected(1, col4));</span>
<span class="line-added">1608             assertFalse(sm.isSelected(1, col3));</span>
<span class="line-added">1609             assertFalse(sm.isSelected(1, col2));</span>
<span class="line-added">1610             assertFalse(sm.isSelected(1, col1));</span>
<span class="line-added">1611             assertTrue(sm.isSelected(1, col0));</span>
<span class="line-added">1612         }</span>
1613 
1614         keyboard.doLeftArrowPress(KeyModifier.SHIFT);   // deselect (1, col5)
<a name="23" id="anc23"></a><span class="line-modified">1615 </span>
<span class="line-modified">1616         if (orientation == NodeOrientation.LEFT_TO_RIGHT) {</span>
<span class="line-modified">1617             assertFalse(sm.isSelected(1, col4));</span>
<span class="line-modified">1618             assertTrue(sm.isSelected(1, col3));</span>
<span class="line-modified">1619             assertTrue(sm.isSelected(1, col2));</span>
<span class="line-added">1620             assertTrue(sm.isSelected(1, col1));</span>
<span class="line-added">1621             assertTrue(sm.isSelected(1, col0));</span>
<span class="line-added">1622         } else if (orientation == NodeOrientation.RIGHT_TO_LEFT) {</span>
<span class="line-added">1623             assertFalse(sm.isSelected(1, col4));</span>
<span class="line-added">1624             assertFalse(sm.isSelected(1, col3));</span>
<span class="line-added">1625             assertFalse(sm.isSelected(1, col2));</span>
<span class="line-added">1626             assertTrue(sm.isSelected(1, col1));</span>
<span class="line-added">1627             assertTrue(sm.isSelected(1, col0));</span>
<span class="line-added">1628         }</span>
1629     }
1630 
1631     @Test public void test_rt18488_comment1() {
1632         sm.setCellSelectionEnabled(true);
1633         sm.clearAndSelect(1, col0);
1634 
1635         keyboard.doRightArrowPress(KeyModifier.SHIFT);   // select (1, col2)
1636         keyboard.doRightArrowPress(KeyModifier.SHIFT);   // select (1, col3)
1637         keyboard.doRightArrowPress(KeyModifier.SHIFT);   // select (1, col4)
1638         keyboard.doRightArrowPress(KeyModifier.SHIFT);   // select (1, col5)
1639         keyboard.doDownArrowPress(KeyModifier.SHIFT);    // select (2, col5)
1640 
<a name="24" id="anc24"></a><span class="line-modified">1641         if (orientation == NodeOrientation.LEFT_TO_RIGHT) {</span>
<span class="line-modified">1642             assertTrue(sm.isSelected(2, col4));</span>
<span class="line-modified">1643             assertTrue(sm.isSelected(1, col4));</span>
<span class="line-modified">1644             assertTrue(sm.isSelected(1, col3));</span>
<span class="line-modified">1645             assertTrue(sm.isSelected(1, col2));</span>
<span class="line-modified">1646             assertTrue(sm.isSelected(1, col1));</span>
<span class="line-added">1647             assertTrue(sm.isSelected(1, col0));</span>
<span class="line-added">1648         } else if (orientation == NodeOrientation.RIGHT_TO_LEFT)  {</span>
<span class="line-added">1649             assertFalse(sm.isSelected(1, col4));</span>
<span class="line-added">1650             assertFalse(sm.isSelected(1, col3));</span>
<span class="line-added">1651             assertFalse(sm.isSelected(1, col2));</span>
<span class="line-added">1652             assertFalse(sm.isSelected(1, col1));</span>
<span class="line-added">1653             assertTrue(sm.isSelected(1, col0));</span>
<span class="line-added">1654             assertTrue(sm.isSelected(2, col0));</span>
<span class="line-added">1655         }</span>
1656 
1657         keyboard.doUpArrowPress(KeyModifier.SHIFT);     // deselect (2, col5)
<a name="25" id="anc25"></a><span class="line-modified">1658 </span>
<span class="line-modified">1659         if (orientation == NodeOrientation.LEFT_TO_RIGHT) {</span>
<span class="line-modified">1660             assertFalse(sm.isSelected(2, col4));</span>
<span class="line-modified">1661             assertTrue(sm.isSelected(1, col4));</span>
<span class="line-modified">1662             assertTrue(sm.isSelected(1, col3));</span>
<span class="line-modified">1663             assertTrue(sm.isSelected(1, col2));</span>
<span class="line-added">1664             assertTrue(sm.isSelected(1, col1));</span>
<span class="line-added">1665             assertTrue(sm.isSelected(1, col0));</span>
<span class="line-added">1666         } else if (orientation == NodeOrientation.RIGHT_TO_LEFT)  {</span>
<span class="line-added">1667             assertFalse(sm.isSelected(1, col4));</span>
<span class="line-added">1668             assertFalse(sm.isSelected(1, col3));</span>
<span class="line-added">1669             assertFalse(sm.isSelected(1, col2));</span>
<span class="line-added">1670             assertFalse(sm.isSelected(1, col1));</span>
<span class="line-added">1671             assertTrue(sm.isSelected(1, col0));</span>
<span class="line-added">1672             assertFalse(sm.isSelected(2, col0));</span>
<span class="line-added">1673         }</span>
1674     }
1675 
1676     @Test public void test_rt18536_positive_horizontal() {
<a name="26" id="anc26"></a><span class="line-modified">1677         if (orientation == NodeOrientation.LEFT_TO_RIGHT) {</span>
<span class="line-modified">1678             // Test shift selection when focus is elsewhere (so as to select a range)</span>
<span class="line-modified">1679             sm.setCellSelectionEnabled(true);</span>
<span class="line-modified">1680             sm.clearAndSelect(1, col0);</span>
<span class="line-modified">1681 </span>
<span class="line-modified">1682             // move focus by holding down ctrl button</span>
<span class="line-modified">1683             keyboard.doRightArrowPress(KeyModifier.getShortcutKey());   // move focus to (1, col2)</span>
<span class="line-modified">1684             keyboard.doRightArrowPress(KeyModifier.getShortcutKey());   // move focus to (1, col3)</span>
<span class="line-modified">1685             keyboard.doRightArrowPress(KeyModifier.getShortcutKey());   // move focus to (1, col4)</span>
<span class="line-modified">1686             keyboard.doRightArrowPress(KeyModifier.getShortcutKey());   // move focus to (1, col5)</span>
<span class="line-modified">1687             assertTrue(fm.isFocused(1, col4));</span>
<span class="line-modified">1688 </span>
<span class="line-modified">1689             // press shift + space to select all cells between (1, col1) and (1, col5)</span>
<span class="line-modified">1690             keyboard.doKeyPress(KeyCode.SPACE, KeyModifier.SHIFT);</span>
<span class="line-modified">1691             assertTrue(sm.isSelected(1, col4));</span>
<span class="line-modified">1692             assertTrue(debug(), sm.isSelected(1, col3));</span>
<span class="line-modified">1693             assertTrue(sm.isSelected(1, col2));</span>
<span class="line-modified">1694             assertTrue(sm.isSelected(1, col1));</span>
<span class="line-added">1695             assertTrue(sm.isSelected(1, col0));</span>
<span class="line-added">1696         } else if (orientation == NodeOrientation.RIGHT_TO_LEFT) {</span>
<span class="line-added">1697             // Test shift selection when focus is elsewhere (so as to select a range)</span>
<span class="line-added">1698             sm.setCellSelectionEnabled(true);</span>
<span class="line-added">1699             sm.clearAndSelect(1, col4);</span>
<span class="line-added">1700 </span>
<span class="line-added">1701             // move focus by holding down ctrl button</span>
<span class="line-added">1702             keyboard.doRightArrowPress(KeyModifier.getShortcutKey());   // move focus to (1, col3)</span>
<span class="line-added">1703             keyboard.doRightArrowPress(KeyModifier.getShortcutKey());   // move focus to (1, col2)</span>
<span class="line-added">1704             keyboard.doRightArrowPress(KeyModifier.getShortcutKey());   // move focus to (1, col1)</span>
<span class="line-added">1705             keyboard.doRightArrowPress(KeyModifier.getShortcutKey());   // move focus to (1, col0)</span>
<span class="line-added">1706             assertTrue(fm.isFocused(1, col0));</span>
<span class="line-added">1707 </span>
<span class="line-added">1708             // press shift + space to select all cells between (1, col1) and (1, col5)</span>
<span class="line-added">1709             keyboard.doKeyPress(KeyCode.SPACE, KeyModifier.SHIFT);</span>
<span class="line-added">1710             assertTrue(sm.isSelected(1, col0));</span>
<span class="line-added">1711             assertTrue(debug(), sm.isSelected(1, col3));</span>
<span class="line-added">1712             assertTrue(sm.isSelected(1, col2));</span>
<span class="line-added">1713             assertTrue(sm.isSelected(1, col1));</span>
<span class="line-added">1714             assertTrue(sm.isSelected(1, col0));</span>
<span class="line-added">1715         }</span>
1716     }
1717 
1718     @Test public void test_rt18536_negative_horizontal() {
<a name="27" id="anc27"></a>









1719 
<a name="28" id="anc28"></a><span class="line-modified">1720         if (orientation == NodeOrientation.LEFT_TO_RIGHT) {</span>
<span class="line-modified">1721             // Test shift selection when focus is elsewhere (so as to select a range)</span>
<span class="line-modified">1722             sm.setCellSelectionEnabled(true);</span>
<span class="line-modified">1723             sm.clearAndSelect(1, col4);</span>
<span class="line-modified">1724 </span>
<span class="line-modified">1725             // move focus by holding down ctrl button</span>
<span class="line-modified">1726             keyboard.doLeftArrowPress(KeyModifier.getShortcutKey());   // move focus to (1, col4)</span>
<span class="line-added">1727             keyboard.doLeftArrowPress(KeyModifier.getShortcutKey());   // move focus to (1, col3)</span>
<span class="line-added">1728             keyboard.doLeftArrowPress(KeyModifier.getShortcutKey());   // move focus to (1, col2)</span>
<span class="line-added">1729             keyboard.doLeftArrowPress(KeyModifier.getShortcutKey());   // move focus to (1, col1)</span>
<span class="line-added">1730             assertTrue(fm.isFocused(1, col0));</span>
<span class="line-added">1731 </span>
<span class="line-added">1732             // press shift + space to select all cells between (1, col1) and (1, col5)</span>
<span class="line-added">1733             keyboard.doKeyPress(KeyCode.SPACE, KeyModifier.SHIFT);</span>
<span class="line-added">1734             assertTrue(debug(), sm.isSelected(1, col4));</span>
<span class="line-added">1735             assertTrue(sm.isSelected(1, col3));</span>
<span class="line-added">1736             assertTrue(sm.isSelected(1, col2));</span>
<span class="line-added">1737             assertTrue(sm.isSelected(1, col1));</span>
<span class="line-added">1738             assertTrue(sm.isSelected(1, col0));</span>
<span class="line-added">1739         } else if (orientation == NodeOrientation.RIGHT_TO_LEFT) {</span>
<span class="line-added">1740             // Test shift selection when focus is elsewhere (so as to select a range)</span>
<span class="line-added">1741             sm.setCellSelectionEnabled(true);</span>
<span class="line-added">1742             sm.clearAndSelect(1, col0);</span>
<span class="line-added">1743 </span>
<span class="line-added">1744             // move focus by holding down ctrl button</span>
<span class="line-added">1745             keyboard.doLeftArrowPress(KeyModifier.getShortcutKey());   // move focus to (1, col1)</span>
<span class="line-added">1746             keyboard.doLeftArrowPress(KeyModifier.getShortcutKey());   // move focus to (1, col2)</span>
<span class="line-added">1747             keyboard.doLeftArrowPress(KeyModifier.getShortcutKey());   // move focus to (1, col3)</span>
<span class="line-added">1748             keyboard.doLeftArrowPress(KeyModifier.getShortcutKey());   // move focus to (1, col4)</span>
<span class="line-added">1749             assertTrue(fm.isFocused(1, col4));</span>
<span class="line-added">1750 </span>
<span class="line-added">1751             // press shift + space to select all cells between (1, col1) and (1, col5)</span>
<span class="line-added">1752             keyboard.doKeyPress(KeyCode.SPACE, KeyModifier.SHIFT);</span>
<span class="line-added">1753             assertTrue(debug(), sm.isSelected(1, col0));</span>
<span class="line-added">1754             assertTrue(sm.isSelected(1, col3));</span>
<span class="line-added">1755             assertTrue(sm.isSelected(1, col2));</span>
<span class="line-added">1756             assertTrue(sm.isSelected(1, col1));</span>
<span class="line-added">1757             assertTrue(sm.isSelected(1, col0));</span>
<span class="line-added">1758         }</span>
1759     }
1760 
1761     //
1762     @Test public void test_rt18536_positive_vertical() {
1763         // Test shift selection when focus is elsewhere (so as to select a range)
1764         sm.setCellSelectionEnabled(true);
1765         sm.clearAndSelect(1, col4);
1766 
1767         // move focus by holding down ctrl button
1768         keyboard.doDownArrowPress(KeyModifier.getShortcutKey());   // move focus to (2, col5)
1769         keyboard.doDownArrowPress(KeyModifier.getShortcutKey());   // move focus to (3, col5)
1770         keyboard.doDownArrowPress(KeyModifier.getShortcutKey());   // move focus to (4, col5)
1771         keyboard.doDownArrowPress(KeyModifier.getShortcutKey());   // move focus to (5, col5)
1772         assertTrue(fm.isFocused(5, col4));
1773 
1774         // press shift + space to select all cells between (1, col5) and (5, col5)
1775         keyboard.doKeyPress(KeyCode.SPACE, KeyModifier.SHIFT);
1776         assertTrue(sm.isSelected(1, col4));
1777         assertTrue(sm.isSelected(2, col4));
1778         assertTrue(sm.isSelected(3, col4));
1779         assertTrue(sm.isSelected(4, col4));
1780         assertTrue(sm.isSelected(5, col4));
1781     }
1782 
1783     //
1784     @Test public void test_rt18536_negative_vertical() {
1785         // Test shift selection when focus is elsewhere (so as to select a range)
1786         sm.setCellSelectionEnabled(true);
1787         sm.clearAndSelect(5, col4);
1788 
1789         // move focus by holding down ctrl button
1790         keyboard.doUpArrowPress(KeyModifier.getShortcutKey());   // move focus to (4, col5)
1791         keyboard.doUpArrowPress(KeyModifier.getShortcutKey());   // move focus to (3, col5)
1792         keyboard.doUpArrowPress(KeyModifier.getShortcutKey());   // move focus to (2, col5)
1793         keyboard.doUpArrowPress(KeyModifier.getShortcutKey());   // move focus to (1, col5)
1794         assertTrue(fm.isFocused(1, col4));
1795 
1796         // press shift + space to select all cells between (1, col5) and (5, col5)
1797         keyboard.doKeyPress(KeyCode.SPACE, KeyModifier.SHIFT);
1798         assertTrue(sm.isSelected(1, col4));
1799         assertTrue(sm.isSelected(2, col4));
1800         assertTrue(sm.isSelected(3, col4));
1801         assertTrue(sm.isSelected(4, col4));
1802         assertTrue(sm.isSelected(5, col4));
1803     }
1804 
1805     //
1806     @Test public void test_rt18642() {
1807         sm.setCellSelectionEnabled(false);
1808         sm.clearAndSelect(1);                          // select 1
1809         keyboard.doDownArrowPress(KeyModifier.getShortcutKey());   // shift focus to 2
1810         keyboard.doDownArrowPress(KeyModifier.getShortcutKey());   // shift focus to 3
1811         keyboard.doKeyPress(KeyCode.SPACE,
1812                 KeyModifier.getShortcutKey(),
1813                 (Utils.isMac()  ? KeyModifier.CTRL : null)); // set anchor, and also select, 3
1814         keyboard.doDownArrowPress(KeyModifier.getShortcutKey());   // shift focus to 4
1815         keyboard.doDownArrowPress(KeyModifier.getShortcutKey());   // shift focus to 5
1816         keyboard.doKeyPress(KeyCode.SPACE,
1817                 KeyModifier.getShortcutKey(),
1818                 (Utils.isMac()  ? KeyModifier.CTRL : null)); // set anchor, and also select, 5
1819 
1820         assertTrue(isSelected(1, 3, 5));
1821         assertTrue(isNotSelected(0, 2, 4));
1822 
1823         // anchor is at 5, so shift+UP should select rows 4 and 5 only
1824         keyboard.doUpArrowPress(KeyModifier.SHIFT);
1825         assertTrue(isSelected(4, 5));
1826         assertTrue(isNotSelected(0, 1, 2, 3));
1827     }
1828 
1829     @Test public void test_rt14451_1() {
1830         sm.clearAndSelect(5);
1831 
1832         keyboard.doKeyPress(KeyCode.HOME, KeyModifier.SHIFT);
1833         assertTrue(isSelected(0,1,2,3,4,5));
1834         assertTrue(isNotSelected(6,7,8,9));
1835 
1836         keyboard.doKeyPress(KeyCode.END, KeyModifier.SHIFT);
1837         assertTrue(isNotSelected(0,1,2,3,4));
1838         assertTrue(isSelected(5,6,7,8,9));
1839 
1840         keyboard.doKeyPress(KeyCode.HOME, KeyModifier.SHIFT);
1841         assertTrue(isSelected(0,1,2,3,4,5));
1842         assertTrue(debug(), isNotSelected(6,7,8,9));
1843     }
1844 
1845     @Test public void test_rt14451_2() {
1846         sm.clearAndSelect(5);
1847 
1848         keyboard.doKeyPress(KeyCode.END, KeyModifier.SHIFT);
1849         assertTrue(isNotSelected(0,1,2,3,4));
1850         assertTrue(isSelected(5,6,7,8,9));
1851 
1852         keyboard.doKeyPress(KeyCode.HOME, KeyModifier.SHIFT);
1853         assertTrue(isSelected(0,1,2,3,4,5));
1854         assertTrue(debug(), isNotSelected(6,7,8,9));
1855 
1856         keyboard.doKeyPress(KeyCode.END, KeyModifier.SHIFT);
1857         assertTrue(isNotSelected(0,1,2,3,4));
1858         assertTrue(isSelected(5,6,7,8,9));
1859     }
1860 
1861     @Test public void test_rt26835_1() {
1862         sm.clearAndSelect(5);
1863         keyboard.doKeyPress(KeyCode.HOME, KeyModifier.getShortcutKey());
1864         assertTrue(fm.isFocused(0));
1865     }
1866 
1867     @Test public void test_rt26835_2() {
1868         sm.clearAndSelect(5);
1869         keyboard.doKeyPress(KeyCode.END, KeyModifier.getShortcutKey());
1870         assertTrue(debug(), fm.isFocused(tableView.getItems().size() - 1));
1871     }
1872 
1873     @Test public void test_rt27175() {
1874         sm.clearAndSelect(5);
1875         keyboard.doKeyPress(KeyCode.HOME, KeyModifier.SHIFT, KeyModifier.getShortcutKey());
1876         assertTrue(debug(), fm.isFocused(0));
1877         assertTrue(isSelected(0,1,2,3,4,5));
1878     }
1879 
1880     @Test public void test_rt28065() {
1881         sm.setSelectionMode(SelectionMode.MULTIPLE);
1882         tableView.getItems().setAll(&quot;Apple&quot;, &quot;Orange&quot;, &quot;Banana&quot;);
1883 
1884         tableView.getSelectionModel().select(0);
1885         assertEquals(0, tableView.getSelectionModel().getSelectedIndex());
1886         assertEquals(&quot;Apple&quot;, tableView.getSelectionModel().getSelectedItem());
1887         assertEquals(0, tableView.getFocusModel().getFocusedIndex());
1888         assertEquals(&quot;Apple&quot;, tableView.getFocusModel().getFocusedItem());
1889 
1890         keyboard.doKeyPress(KeyCode.A, KeyModifier.getShortcutKey());
1891         assertEquals(0, tableView.getSelectionModel().getSelectedIndex());
1892         assertEquals(&quot;Apple&quot;, tableView.getSelectionModel().getSelectedItem());
1893         assertEquals(0, tableView.getFocusModel().getFocusedIndex());
1894         assertEquals(&quot;Apple&quot;, tableView.getFocusModel().getFocusedItem());
1895     }
1896 
1897     @Test public void test_rt27583_cellSelection_1() {
1898         sm.setCellSelectionEnabled(true);
1899         sm.setSelectionMode(SelectionMode.MULTIPLE);
1900 
1901         sm.select(0, col0);
1902         assertTrue(fm.isFocused(0, col0));
1903 
1904         // focus should not go out the top of the table
1905         keyboard.doDownArrowPress(KeyModifier.SHIFT);
1906         assertTrue(fm.isFocused(1, col0));
1907         keyboard.doUpArrowPress(KeyModifier.SHIFT);
1908         assertTrue(fm.isFocused(0, col0));
1909         keyboard.doUpArrowPress(KeyModifier.SHIFT);
1910         assertTrue(debug(), fm.isFocused(0, col0));
1911 
1912     }
1913 
1914     @Test public void test_rt27583_cellSelection_2() {
1915         sm.setCellSelectionEnabled(true);
1916         sm.setSelectionMode(SelectionMode.MULTIPLE);
1917 
1918         sm.select(9, col0);
1919         assertTrue(fm.isFocused(9, col0));
1920 
1921         // focus should not go out the bottom of the table
1922         keyboard.doDownArrowPress(KeyModifier.SHIFT);
1923         assertTrue(fm.isFocused(10, col0));
1924         keyboard.doDownArrowPress(KeyModifier.SHIFT);
1925         assertTrue(fm.isFocused(11, col0));
1926         keyboard.doDownArrowPress(KeyModifier.SHIFT);
1927         assertTrue(debug(), fm.isFocused(11, col0));
1928     }
1929 
1930     @Test public void test_rt27583_rowSelection_1() {
1931         sm.setCellSelectionEnabled(false);
1932         sm.setSelectionMode(SelectionMode.MULTIPLE);
1933 
1934         sm.select(0);
1935         assertTrue(fm.isFocused(0));
1936 
1937         // focus should not go out the top of the table
1938         keyboard.doDownArrowPress(KeyModifier.SHIFT);
1939         assertTrue(fm.isFocused(1));
1940         keyboard.doUpArrowPress(KeyModifier.SHIFT);
1941         assertTrue(fm.isFocused(0));
1942         keyboard.doUpArrowPress(KeyModifier.SHIFT);
1943         assertTrue(debug(), fm.isFocused(0));
1944 
1945     }
1946 
1947     @Test public void test_rt27583_rowSelection_2() {
1948         sm.setCellSelectionEnabled(false);
1949         sm.setSelectionMode(SelectionMode.MULTIPLE);
1950 
1951         sm.select(9);
1952         assertTrue(fm.isFocused(9));
1953 
1954         // focus should not go out the bottom of the table
1955         keyboard.doDownArrowPress(KeyModifier.SHIFT);
1956         assertTrue(fm.isFocused(10));
1957         keyboard.doDownArrowPress(KeyModifier.SHIFT);
1958         assertTrue(fm.isFocused(11));
1959         keyboard.doDownArrowPress(KeyModifier.SHIFT);
1960         assertTrue(debug(), fm.isFocused(11));
1961     }
1962 
1963     @Test public void test_rt29833_keyboard_select_upwards() {
1964         sm.setCellSelectionEnabled(false);
1965         sm.setSelectionMode(SelectionMode.MULTIPLE);
1966 
1967         sm.clearAndSelect(9);
1968 
1969         // select all from 9 - 7
1970         fm.focus(7);
1971         keyboard.doKeyPress(KeyCode.SPACE, KeyModifier.SHIFT);
1972         assertTrue(isSelected(7,8,9));
1973 
1974         // select all from 9 - 7 - 5
1975         fm.focus(5);
1976         keyboard.doKeyPress(KeyCode.SPACE, KeyModifier.SHIFT);
1977         assertTrue(isSelected(5,6,7,8,9));
1978     }
1979 
1980     @Test public void test_rt29833_keyboard_select_downwards() {
1981         sm.setCellSelectionEnabled(false);
1982         sm.setSelectionMode(SelectionMode.MULTIPLE);
1983 
1984         sm.clearAndSelect(5);
1985 
1986         // select all from 5 - 7
1987         fm.focus(7);
1988         keyboard.doKeyPress(KeyCode.SPACE, KeyModifier.SHIFT);
1989         assertTrue(isSelected(5,6,7));
1990 
1991         // select all from 5 - 7 - 9
1992         fm.focus(9);
1993         keyboard.doKeyPress(KeyCode.SPACE, KeyModifier.SHIFT);
1994         assertTrue(isSelected(5,6,7,8,9));
1995     }
1996 
1997     @Test public void test_rt29930() {
1998         sm.setCellSelectionEnabled(false);
1999         sm.setSelectionMode(SelectionMode.MULTIPLE);
2000 
2001         sm.clearAndSelect(0);
2002 
2003         keyboard.doDownArrowPress(KeyModifier.SHIFT); // select rows [0,1]
2004         keyboard.doDownArrowPress(KeyModifier.SHIFT); // select rows [0,1,2]
2005         assertTrue(isSelected(0,1,2));
2006         assertEquals(3, sm.getSelectedIndices().size());
2007         assertEquals(3, sm.getSelectedCells().size());
2008         assertEquals(2, fm.getFocusedIndex());
2009         assertEquals(0, getAnchor().getRow());
2010 
2011         keyboard.doKeyPress(KeyCode.SPACE, KeyModifier.getShortcutKey(), PlatformUtil.isMac() ? KeyModifier.CTRL : null); // set new anchor point
2012         assertTrue(isSelected(0,1));
2013         assertEquals(2, sm.getSelectedIndices().size());
2014         assertEquals(2, sm.getSelectedCells().size());
2015         assertEquals(2, fm.getFocusedIndex());
2016         assertEquals(2, getAnchor().getRow());
2017 
2018         keyboard.doDownArrowPress(KeyModifier.SHIFT); // select rows [2,3]
2019         assertTrue(isSelected(2,3));
2020         assertTrue(isNotSelected(0,1));
2021         assertEquals(2, sm.getSelectedIndices().size());
2022         assertEquals(2, sm.getSelectedCells().size());
2023         assertEquals(3, fm.getFocusedIndex());
2024         assertEquals(2, getAnchor().getRow());
2025     }
2026 
2027     private int rt29849_start_count = 0;
2028     private int rt29849_cancel_count = 0;
2029     @Test public void test_rt29849() {
2030         tableView.setEditable(true);
2031         col0.setEditable(true);
2032 
2033         col0.setCellValueFactory(param -&gt; new ReadOnlyStringWrapper(&quot;DUMMY TEXT&quot;));
2034 
2035         col0.setOnEditStart(t -&gt; {
2036             rt29849_start_count++;
2037         });
2038         col0.setOnEditCancel(t -&gt; {
2039             rt29849_cancel_count++;
2040         });
2041 
2042         // initially the counts should be zero
2043         assertEquals(0, rt29849_start_count);
2044         assertEquals(0, rt29849_cancel_count);
2045 
2046         TableCell cell = (TableCell)VirtualFlowTestUtils.getCell(tableView, 0, 0);
2047         TableCellShim.set_lockItemOnEdit(cell, false);
2048         assertTrue(cell.isEditable());
2049         assertFalse(cell.isEditing());
2050         assertEquals(0, cell.getIndex());
2051 
2052         // do an edit, start count should be one, cancel still zero
2053         tableView.edit(0, col0);
2054         assertTrue(cell.isEditing());
2055         assertEquals(1, rt29849_start_count);
2056         assertEquals(0, rt29849_cancel_count);
2057 
2058         // cancel edit, now both counts should be 1
2059         keyboard.doKeyPress(KeyCode.ESCAPE);
2060         assertFalse(cell.isEditing());
2061         assertEquals(1, rt29849_start_count);
2062         assertEquals(1, rt29849_cancel_count);
2063     }
2064 
2065     private int rt31577_count = 0;
2066     @Test public void test_rt31577() {
2067         final TableSelectionModel sm = tableView.getSelectionModel();
2068         sm.setCellSelectionEnabled(false);
2069         sm.setSelectionMode(SelectionMode.SINGLE);
2070         sm.clearSelection();
2071 
2072         // the actual bug is that the selectedItem property does not fire an
2073         // event when the selected items list changes (due to deselection).
2074         // It actually does always contain the right value - it just doesn&#39;t
2075         // let anyone know it!
2076         sm.selectedItemProperty().addListener(observable -&gt; {
2077             rt31577_count++;
2078         });
2079 
2080         assertTrue(sm.getSelectedItems().isEmpty());
2081         assertFalse(sm.isSelected(1));
2082         assertEquals(0, rt31577_count);
2083 
2084         // select the first row
2085         keyboard.doKeyPress(KeyCode.KP_DOWN);
2086         assertEquals(1, sm.getSelectedItems().size());
2087         assertTrue(sm.isSelected(0));
2088         assertTrue(sm.getSelectedItems().contains(&quot;1&quot;));
2089         assertEquals(&quot;1&quot;, sm.getSelectedItem());
2090         assertEquals(1, rt31577_count);
2091 
2092         // deselect the row
2093         keyboard.doKeyPress(KeyCode.SPACE, KeyModifier.CTRL,
2094                 Utils.isMac() ? KeyModifier.getShortcutKey() : null);
2095         assertTrue(sm.getSelectedItems().isEmpty());
2096         assertFalse(sm.isSelected(1));
2097         assertNull(sm.getSelectedItem());
2098         assertEquals(2, rt31577_count);
2099     }
2100 
2101     @Test public void test_rt32383_pageDown() {
2102         // this test requires a lot of data
2103         tableView.getItems().clear();
2104         for (int i = 0; i &lt; 100; i++) {
2105             tableView.getItems().add(&quot;Row &quot; + i);
2106         }
2107 
2108         final MultipleSelectionModel sm = tableView.getSelectionModel();
2109         sm.setSelectionMode(SelectionMode.SINGLE);
2110         sm.clearAndSelect(0);
2111 
2112         final String initialFocusOwner = fm.getFocusedItem();
2113 
2114         keyboard.doKeyPress(KeyCode.PAGE_DOWN, KeyModifier.getShortcutKey());
2115         Toolkit.getToolkit().firePulse();
2116         final String newFocusOwner = fm.getFocusedItem();
2117         assertNotSame(initialFocusOwner, newFocusOwner);
2118 
2119         keyboard.doKeyPress(KeyCode.PAGE_DOWN, KeyModifier.getShortcutKey());
2120         Toolkit.getToolkit().firePulse();
2121         final String nextFocusOwner = fm.getFocusedItem();
2122         assertNotSame(initialFocusOwner, nextFocusOwner);
2123         assertNotSame(newFocusOwner, nextFocusOwner);
2124     }
2125 
2126     @Test public void test_rt32383_pageUp() {
2127         // this test requires a lot of data
2128         tableView.getItems().clear();
2129         for (int i = 0; i &lt; 100; i++) {
2130             tableView.getItems().add(&quot;Row &quot; + i);
2131         }
2132 
2133         final int lastIndex = 99;
2134 
2135         final MultipleSelectionModel sm = tableView.getSelectionModel();
2136         sm.setSelectionMode(SelectionMode.SINGLE);
2137         sm.clearAndSelect(lastIndex);
2138 
2139         // need to make sure we scroll down to the bottom!
2140         tableView.scrollTo(lastIndex);
2141         Toolkit.getToolkit().firePulse();
2142 
2143         final String initialFocusOwner = fm.getFocusedItem();
2144 
2145         keyboard.doKeyPress(KeyCode.PAGE_UP, KeyModifier.getShortcutKey());
2146         Toolkit.getToolkit().firePulse();
2147         final String newFocusOwner = fm.getFocusedItem();
2148         assertNotSame(initialFocusOwner, newFocusOwner);
2149 
2150         keyboard.doKeyPress(KeyCode.PAGE_UP, KeyModifier.getShortcutKey());
2151         Toolkit.getToolkit().firePulse();
2152         final String nextFocusOwner = fm.getFocusedItem();
2153         assertNotSame(initialFocusOwner, nextFocusOwner);
2154         assertNotSame(newFocusOwner, nextFocusOwner);
2155     }
2156 
2157     @Test public void test_rt27710_pageDown_singleSelection_cell() {
2158         // this test requires a lot of data
2159         tableView.getItems().clear();
2160         for (int i = 0; i &lt; 100; i++) {
2161             tableView.getItems().add(&quot;Row &quot; + i);
2162         }
2163 
2164         col0.setCellValueFactory(param -&gt; new ReadOnlyStringWrapper(param.getValue()));
2165 
2166         final TableSelectionModel sm = tableView.getSelectionModel();
2167         sm.setSelectionMode(SelectionMode.SINGLE);
2168         sm.setCellSelectionEnabled(true);
2169         sm.clearAndSelect(0, col0);
2170 
2171         final String initialFocusOwner = fm.getFocusedItem();
2172 
2173         keyboard.doKeyPress(KeyCode.PAGE_DOWN, KeyModifier.SHIFT);
2174         Toolkit.getToolkit().firePulse();
2175         final String newFocusOwner = fm.getFocusedItem();
2176         assertNotSame(initialFocusOwner, newFocusOwner);
2177 
2178         keyboard.doKeyPress(KeyCode.PAGE_DOWN, KeyModifier.SHIFT);
2179         Toolkit.getToolkit().firePulse();
2180         final String nextFocusOwner = fm.getFocusedItem();
2181         assertNotSame(initialFocusOwner, nextFocusOwner);
2182         assertNotSame(newFocusOwner, nextFocusOwner);
2183     }
2184 
2185     @Test public void test_rt27710_pageUp_singleSelection_cell() {
2186         // this test requires a lot of data
2187         tableView.getItems().clear();
2188         for (int i = 0; i &lt; 100; i++) {
2189             tableView.getItems().add(&quot;Row &quot; + i);
2190         }
2191 
2192         col0.setCellValueFactory(param -&gt; new ReadOnlyStringWrapper(param.getValue()));
2193 
2194         final int lastIndex = 99;
2195 
2196         final TableSelectionModel sm = tableView.getSelectionModel();
2197         sm.setSelectionMode(SelectionMode.SINGLE);
2198         sm.setCellSelectionEnabled(true);
2199         sm.clearAndSelect(lastIndex, col0);
2200 
2201         // need to make sure we scroll down to the bottom!
2202         tableView.scrollTo(lastIndex);
2203         Toolkit.getToolkit().firePulse();
2204 
2205         final String initialFocusOwner = fm.getFocusedItem();
2206         final Object initialSelectionOwner = sm.getSelectedItem();
2207 
2208         keyboard.doKeyPress(KeyCode.PAGE_UP, KeyModifier.SHIFT);
2209         Toolkit.getToolkit().firePulse();
2210         final String newFocusOwner = fm.getFocusedItem();
2211         final Object newSelectionOwner = sm.getSelectedItem();
2212         assertNotSame(initialFocusOwner, newFocusOwner);
2213         assertNotSame(initialSelectionOwner, newSelectionOwner);
2214 
2215         keyboard.doKeyPress(KeyCode.PAGE_UP, KeyModifier.SHIFT);
2216         Toolkit.getToolkit().firePulse();
2217         final String nextFocusOwner = fm.getFocusedItem();
2218         final Object nextSelectionOwner = sm.getSelectedItem();
2219         assertNotSame(initialFocusOwner, nextFocusOwner);
2220         assertNotSame(newFocusOwner, nextFocusOwner);
2221         assertNotSame(initialSelectionOwner, nextSelectionOwner);
2222         assertNotSame(newSelectionOwner, nextSelectionOwner);
2223     }
2224 
2225     @Test public void test_rt19053_pageUp() {
2226         final int items = 8;
2227         tableView.getItems().clear();
2228         for (int i = 0; i &lt; items; i++) {
2229             tableView.getItems().add(&quot;Row &quot; + i);
2230         }
2231 
2232         final int middleIndex = items / 2;
2233 
2234         final MultipleSelectionModel sm = tableView.getSelectionModel();
2235         sm.setSelectionMode(SelectionMode.SINGLE);
2236         sm.clearAndSelect(middleIndex);
2237 
2238         assertEquals(middleIndex, sm.getSelectedIndex());
2239 
2240         final Object initialSelectionOwner = sm.getSelectedItem();
2241 
2242         keyboard.doKeyPress(KeyCode.PAGE_DOWN, KeyModifier.SHIFT);
2243         Toolkit.getToolkit().firePulse();
2244         final Object newSelectionOwner = sm.getSelectedItem();
2245         assertNotSame(initialSelectionOwner + &quot; == &quot; + newSelectionOwner, initialSelectionOwner, newSelectionOwner);
2246 
2247         // selection should go all the way to the top, but this bug
2248         // shows that instead it seems to stop midway - where the anchor is
2249         keyboard.doKeyPress(KeyCode.PAGE_UP, KeyModifier.SHIFT);
2250         Toolkit.getToolkit().firePulse();
2251         assertEquals(0, fm.getFocusedIndex());
2252         assertEquals(0, sm.getSelectedIndex());
2253         final Object nextSelectionOwner =  sm.getSelectedItem();
2254         assertNotSame(initialSelectionOwner, nextSelectionOwner);
2255         assertNotSame(newSelectionOwner, nextSelectionOwner);
2256     }
2257 
2258     @Test public void test_rt19053_pageDown() {
2259         final int items = 8;
2260         tableView.getItems().clear();
2261         for (int i = 0; i &lt; items; i++) {
2262             tableView.getItems().add(&quot;Row &quot; + i);
2263         }
2264 
2265         final int middleIndex = items / 2;
2266 
2267         final MultipleSelectionModel sm = tableView.getSelectionModel();
2268         sm.setSelectionMode(SelectionMode.SINGLE);
2269         sm.clearAndSelect(middleIndex);
2270 
2271         assertEquals(middleIndex, sm.getSelectedIndex());
2272 
2273         final Object initialSelectionOwner = sm.getSelectedItem();
2274 
2275         keyboard.doKeyPress(KeyCode.PAGE_UP, KeyModifier.SHIFT);
2276         Toolkit.getToolkit().firePulse();
2277         final Object newSelectionOwner = sm.getSelectedItem();
2278         assertNotSame(initialSelectionOwner, newSelectionOwner);
2279 
2280         // selection should go all the way to the bottom, but this bug
2281         // shows that instead it seems to stop midway - where the anchor is
2282         keyboard.doKeyPress(KeyCode.PAGE_DOWN, KeyModifier.SHIFT);
2283         Toolkit.getToolkit().firePulse();
2284         assertEquals(items - 1, fm.getFocusedIndex());
2285         assertEquals(items - 1, sm.getSelectedIndex());
2286         final Object nextSelectionOwner =  sm.getSelectedItem();
2287         assertNotSame(initialSelectionOwner, nextSelectionOwner);
2288         assertNotSame(newSelectionOwner, nextSelectionOwner);
2289     }
2290 
2291     @Test public void test_rt21444_up() {
2292         final int items = 8;
2293         tableView.getItems().clear();
2294         for (int i = 1; i &lt;= items; i++) {
2295             tableView.getItems().add(&quot;Row &quot; + i);
2296         }
2297 
2298         final MultipleSelectionModel sm = tableView.getSelectionModel();
2299         sm.setSelectionMode(SelectionMode.MULTIPLE);
2300         sm.clearAndSelect(3);
2301 
2302         assertEquals(3, sm.getSelectedIndex());
2303         assertEquals(&quot;Row 4&quot;, sm.getSelectedItem());
2304 
2305         keyboard.doKeyPress(KeyCode.UP, KeyModifier.SHIFT);
2306         Toolkit.getToolkit().firePulse();
2307         assertEquals(2, sm.getSelectedItems().size());
2308         assertEquals(&quot;Row 3&quot;, sm.getSelectedItem());
2309         assertEquals(&quot;Row 3&quot;, sm.getSelectedItems().get(0));
2310     }
2311 
2312     @Test public void test_rt21444_down() {
2313         final int items = 8;
2314         tableView.getItems().clear();
2315         for (int i = 1; i &lt;= items; i++) {
2316             tableView.getItems().add(&quot;Row &quot; + i);
2317         }
2318 
2319         final MultipleSelectionModel sm = tableView.getSelectionModel();
2320         sm.setSelectionMode(SelectionMode.MULTIPLE);
2321         sm.clearAndSelect(3);
2322 
2323         assertEquals(3, sm.getSelectedIndex());
2324         assertEquals(&quot;Row 4&quot;, sm.getSelectedItem());
2325 
2326         keyboard.doKeyPress(KeyCode.DOWN, KeyModifier.SHIFT);
2327         Toolkit.getToolkit().firePulse();
2328         assertEquals(2, sm.getSelectedItems().size());
2329         assertEquals(&quot;Row 5&quot;, sm.getSelectedItem());
2330         assertEquals(&quot;Row 5&quot;, sm.getSelectedItems().get(1));
2331     }
2332 
2333     @Test public void test_rt21375_scenario_1a_down() {
2334         final int items = 8;
2335         tableView.getItems().clear();
2336         for (int i = 1; i &lt;= items; i++) {
2337             tableView.getItems().add(&quot;Row &quot; + i);
2338         }
2339 
2340         final MultipleSelectionModel sm = tableView.getSelectionModel();
2341         sm.setSelectionMode(SelectionMode.MULTIPLE);
2342         sm.clearAndSelect(0);
2343 
2344         keyboard.doKeyPress(KeyCode.DOWN, KeyModifier.getShortcutKey());
2345         keyboard.doKeyPress(KeyCode.DOWN, KeyModifier.getShortcutKey());
2346         keyboard.doKeyPress(KeyCode.DOWN, KeyModifier.SHIFT);
2347         Toolkit.getToolkit().firePulse();
2348         assertTrue(isSelected(0,1,2,3));
2349         assertEquals(4, sm.getSelectedItems().size());
2350     }
2351 
2352     @Test public void test_rt21375_scenario_1b_down() {
2353         final int items = 8;
2354         tableView.getItems().clear();
2355         for (int i = 1; i &lt;= items; i++) {
2356             tableView.getItems().add(&quot;Row &quot; + i);
2357         }
2358 
2359         final MultipleSelectionModel sm = tableView.getSelectionModel();
2360         sm.setSelectionMode(SelectionMode.MULTIPLE);
2361         sm.clearAndSelect(0);
2362 
2363         keyboard.doKeyPress(KeyCode.DOWN, KeyModifier.getShortcutKey());
2364         keyboard.doKeyPress(KeyCode.DOWN, KeyModifier.getShortcutKey());
2365         keyboard.doKeyPress(KeyCode.DOWN, KeyModifier.getShortcutKey(), KeyModifier.SHIFT);
2366         Toolkit.getToolkit().firePulse();
2367         assertTrue(isSelected(0,1,2,3));
2368         assertEquals(4, sm.getSelectedItems().size());
2369     }
2370 
2371     @Test public void test_rt21375_scenario_2_down() {
2372         final int items = 8;
2373         tableView.getItems().clear();
2374         for (int i = 1; i &lt;= items; i++) {
2375             tableView.getItems().add(&quot;Row &quot; + i);
2376         }
2377 
2378         final MultipleSelectionModel sm = tableView.getSelectionModel();
2379         sm.setSelectionMode(SelectionMode.MULTIPLE);
2380         sm.clearAndSelect(0);
2381 
2382         keyboard.doKeyPress(KeyCode.DOWN,  KeyModifier.getShortcutKey());
2383         keyboard.doKeyPress(KeyCode.DOWN,  KeyModifier.getShortcutKey());
2384         keyboard.doKeyPress(KeyCode.SPACE, KeyModifier.getShortcutKey(), PlatformUtil.isMac() ? KeyModifier.CTRL : null);
2385         keyboard.doKeyPress(KeyCode.DOWN,  KeyModifier.getShortcutKey());
2386         keyboard.doKeyPress(KeyCode.DOWN,  KeyModifier.SHIFT);
2387         Toolkit.getToolkit().firePulse();
2388         assertTrue(isSelected(2,3,4));
2389         assertEquals(3, sm.getSelectedItems().size());
2390     }
2391 
2392     @Test public void test_rt21375_scenario_3_down() {
2393         final int items = 8;
2394         tableView.getItems().clear();
2395         for (int i = 1; i &lt;= items; i++) {
2396             tableView.getItems().add(&quot;Row &quot; + i);
2397         }
2398 
2399         final MultipleSelectionModel sm = tableView.getSelectionModel();
2400         sm.setSelectionMode(SelectionMode.MULTIPLE);
2401         sm.clearAndSelect(0);
2402 
2403         keyboard.doKeyPress(KeyCode.DOWN,  KeyModifier.getShortcutKey());
2404         keyboard.doKeyPress(KeyCode.DOWN,  KeyModifier.getShortcutKey());
2405         keyboard.doKeyPress(KeyCode.SPACE, KeyModifier.getShortcutKey(), PlatformUtil.isMac() ? KeyModifier.CTRL : null);
2406         keyboard.doKeyPress(KeyCode.DOWN,  KeyModifier.getShortcutKey());
2407         keyboard.doKeyPress(KeyCode.DOWN,  KeyModifier.getShortcutKey(), KeyModifier.SHIFT);
2408         Toolkit.getToolkit().firePulse();
2409         assertTrue(isSelected(0,2,3,4));
2410         assertEquals(4, sm.getSelectedItems().size());
2411     }
2412 
2413     @Test public void test_rt21375_scenario_1a_up() {
2414         final int items = 8;
2415         tableView.getItems().clear();
2416         for (int i = 1; i &lt;= items; i++) {
2417             tableView.getItems().add(&quot;Row &quot; + i);
2418         }
2419 
2420         final MultipleSelectionModel sm = tableView.getSelectionModel();
2421         sm.setSelectionMode(SelectionMode.MULTIPLE);
2422         sm.clearAndSelect(7);
2423 
2424         keyboard.doKeyPress(KeyCode.UP, KeyModifier.getShortcutKey());
2425         keyboard.doKeyPress(KeyCode.UP, KeyModifier.getShortcutKey());
2426         keyboard.doKeyPress(KeyCode.UP, KeyModifier.SHIFT);
2427         Toolkit.getToolkit().firePulse();
2428         assertTrue(isSelected(7,6,5,4));
2429         assertEquals(4, sm.getSelectedItems().size());
2430     }
2431 
2432     @Test public void test_rt21375_scenario_1b_up() {
2433         final int items = 8;
2434         tableView.getItems().clear();
2435         for (int i = 1; i &lt;= items; i++) {
2436             tableView.getItems().add(&quot;Row &quot; + i);
2437         }
2438 
2439         final MultipleSelectionModel sm = tableView.getSelectionModel();
2440         sm.setSelectionMode(SelectionMode.MULTIPLE);
2441         sm.clearAndSelect(7);
2442 
2443         keyboard.doKeyPress(KeyCode.UP, KeyModifier.getShortcutKey());
2444         keyboard.doKeyPress(KeyCode.UP, KeyModifier.getShortcutKey());
2445         keyboard.doKeyPress(KeyCode.UP, KeyModifier.getShortcutKey(), KeyModifier.SHIFT);
2446         Toolkit.getToolkit().firePulse();
2447         assertTrue(isSelected(7, 6, 5, 4));
2448         assertEquals(4, sm.getSelectedItems().size());
2449     }
2450 
2451     @Test public void test_rt21375_scenario_2_up() {
2452         final int items = 8;
2453         tableView.getItems().clear();
2454         for (int i = 1; i &lt;= items; i++) {
2455             tableView.getItems().add(&quot;Row &quot; + i);
2456         }
2457 
2458         final MultipleSelectionModel sm = tableView.getSelectionModel();
2459         sm.setSelectionMode(SelectionMode.MULTIPLE);
2460         sm.clearAndSelect(7);
2461 
2462         keyboard.doKeyPress(KeyCode.UP,  KeyModifier.getShortcutKey());
2463         keyboard.doKeyPress(KeyCode.UP,  KeyModifier.getShortcutKey());
2464         keyboard.doKeyPress(KeyCode.SPACE, KeyModifier.getShortcutKey(), PlatformUtil.isMac() ? KeyModifier.CTRL : null);
2465         keyboard.doKeyPress(KeyCode.UP, KeyModifier.getShortcutKey());
2466         keyboard.doKeyPress(KeyCode.UP, KeyModifier.SHIFT);
2467         Toolkit.getToolkit().firePulse();
2468         assertTrue(isSelected(5, 4, 3));
2469         assertEquals(3, sm.getSelectedItems().size());
2470     }
2471 
2472     @Test public void test_rt21375_scenario_3_up() {
2473         final int items = 8;
2474         tableView.getItems().clear();
2475         for (int i = 1; i &lt;= items; i++) {
2476             tableView.getItems().add(&quot;Row &quot; + i);
2477         }
2478 
2479         final MultipleSelectionModel sm = tableView.getSelectionModel();
2480         sm.setSelectionMode(SelectionMode.MULTIPLE);
2481         sm.clearAndSelect(7);
2482 
2483         keyboard.doKeyPress(KeyCode.UP,  KeyModifier.getShortcutKey());
2484         keyboard.doKeyPress(KeyCode.UP,  KeyModifier.getShortcutKey());
2485         keyboard.doKeyPress(KeyCode.SPACE, KeyModifier.getShortcutKey(), PlatformUtil.isMac() ? KeyModifier.CTRL : null);
2486         keyboard.doKeyPress(KeyCode.UP, KeyModifier.getShortcutKey());
2487         keyboard.doKeyPress(KeyCode.UP, KeyModifier.getShortcutKey(), KeyModifier.SHIFT);
2488         Toolkit.getToolkit().firePulse();
2489         assertTrue(isSelected(7, 5, 4, 3));
2490         assertEquals(4, sm.getSelectedItems().size());
2491     }
2492 
2493     @Test public void test_rt33301_multipleSelection_down() {
2494         final int items = 5;
2495         tableView.getItems().clear();
2496         for (int i = 0; i &lt; items; i++) {
2497             tableView.getItems().add(&quot;Row &quot; + i);
2498         }
2499 
2500         final TableFocusModel fm = tableView.getFocusModel();
2501         final TableSelectionModel sm = tableView.getSelectionModel();
2502         sm.setSelectionMode(SelectionMode.MULTIPLE);
2503         sm.setCellSelectionEnabled(false);
2504         sm.clearAndSelect(2);
2505 
2506         keyboard.doKeyPress(KeyCode.DOWN,  KeyModifier.getShortcutKey(), KeyModifier.SHIFT); // row 3
2507         keyboard.doKeyPress(KeyCode.DOWN,  KeyModifier.getShortcutKey(), KeyModifier.SHIFT); // row 4
2508         Toolkit.getToolkit().firePulse();
2509         assertTrue(isNotSelected(0,1));
2510         assertTrue(isSelected(2,3,4));
2511         assertEquals(3, sm.getSelectedItems().size());
2512         assertTrue(fm.isFocused(4));
2513 
2514         keyboard.doKeyPress(KeyCode.DOWN,  KeyModifier.getShortcutKey(), KeyModifier.SHIFT); // should stay at row 4
2515         keyboard.doKeyPress(KeyCode.DOWN,  KeyModifier.getShortcutKey(), KeyModifier.SHIFT); // should stay at row 4
2516         keyboard.doKeyPress(KeyCode.DOWN,  KeyModifier.getShortcutKey(), KeyModifier.SHIFT); // should stay at row 4
2517         Toolkit.getToolkit().firePulse();
2518         assertTrue(isNotSelected(0,1));
2519         assertTrue(isSelected(2,3,4));
2520         assertEquals(3, sm.getSelectedItems().size());
2521         assertTrue(&quot;Focus index incorrectly at: &quot; + fm.getFocusedIndex(), fm.isFocused(4));
2522     }
2523 
2524     @Test public void test_rt33301_multipleSelection_up() {
2525         final int items = 5;
2526         tableView.getItems().clear();
2527         for (int i = 0; i &lt; items; i++) {
2528             tableView.getItems().add(&quot;Row &quot; + i);
2529         }
2530 
2531         final TableFocusModel fm = tableView.getFocusModel();
2532         final TableSelectionModel sm = tableView.getSelectionModel();
2533         sm.setSelectionMode(SelectionMode.MULTIPLE);
2534         sm.setCellSelectionEnabled(false);
2535         sm.clearAndSelect(2);
2536 
2537         keyboard.doKeyPress(KeyCode.UP, KeyModifier.getShortcutKey(), KeyModifier.SHIFT); // row 1
2538         keyboard.doKeyPress(KeyCode.UP, KeyModifier.getShortcutKey(), KeyModifier.SHIFT); // row 0
2539         Toolkit.getToolkit().firePulse();
2540         assertTrue(isNotSelected(3,4));
2541         assertTrue(isSelected(0,1,2));
2542         assertEquals(3, sm.getSelectedItems().size());
2543         assertTrue(fm.isFocused(0));
2544 
2545         keyboard.doKeyPress(KeyCode.UP,  KeyModifier.getShortcutKey(), KeyModifier.SHIFT); // should stay at row 0
2546         keyboard.doKeyPress(KeyCode.UP,  KeyModifier.getShortcutKey(), KeyModifier.SHIFT); // should stay at row 0
2547         keyboard.doKeyPress(KeyCode.UP,  KeyModifier.getShortcutKey(), KeyModifier.SHIFT); // should stay at row 0
2548         Toolkit.getToolkit().firePulse();
2549         assertTrue(isNotSelected(3, 4));
2550         assertTrue(isSelected(0,1,2));
2551         assertEquals(3, sm.getSelectedItems().size());
2552         assertTrue(fm.isFocused(0));
2553     }
2554 
2555     @Test public void test_rt33301_singleSelection_down() {
2556         final int items = 5;
2557         tableView.getItems().clear();
2558         for (int i = 0; i &lt; items; i++) {
2559             tableView.getItems().add(&quot;Row &quot; + i);
2560         }
2561 
2562         final TableFocusModel fm = tableView.getFocusModel();
2563         final TableSelectionModel sm = tableView.getSelectionModel();
2564         sm.setSelectionMode(SelectionMode.SINGLE);
2565         sm.setCellSelectionEnabled(false);
2566         sm.clearAndSelect(2);
2567 
2568         keyboard.doKeyPress(KeyCode.DOWN, KeyModifier.getShortcutKey(), KeyModifier.SHIFT); // row 3
2569         keyboard.doKeyPress(KeyCode.DOWN, KeyModifier.getShortcutKey(), KeyModifier.SHIFT); // row 4
2570         Toolkit.getToolkit().firePulse();
2571         assertTrue(isNotSelected(0,1,2,3));
2572         assertTrue(isSelected(4));
2573         assertEquals(1, sm.getSelectedItems().size());
2574         assertTrue(fm.isFocused(4));
2575 
2576         keyboard.doKeyPress(KeyCode.DOWN,  KeyModifier.getShortcutKey(), KeyModifier.SHIFT); // should stay at row 4
2577         keyboard.doKeyPress(KeyCode.DOWN,  KeyModifier.getShortcutKey(), KeyModifier.SHIFT); // should stay at row 4
2578         keyboard.doKeyPress(KeyCode.DOWN,  KeyModifier.getShortcutKey(), KeyModifier.SHIFT); // should stay at row 4
2579         Toolkit.getToolkit().firePulse();
2580         assertTrue(isNotSelected(0, 1, 2, 3));
2581         assertTrue(isSelected(4));
2582         assertEquals(1, sm.getSelectedItems().size());
2583         assertTrue(fm.isFocused(4));
2584     }
2585 
2586     @Test public void test_rt33301_singleSelection_up() {
2587         final int items = 5;
2588         tableView.getItems().clear();
2589         for (int i = 0; i &lt; items; i++) {
2590             tableView.getItems().add(&quot;Row &quot; + i);
2591         }
2592 
2593         final TableFocusModel fm = tableView.getFocusModel();
2594         final TableSelectionModel sm = tableView.getSelectionModel();
2595         sm.setSelectionMode(SelectionMode.SINGLE);
2596         sm.setCellSelectionEnabled(false);
2597         sm.clearAndSelect(2);
2598 
2599         keyboard.doKeyPress(KeyCode.UP,  KeyModifier.getShortcutKey(), KeyModifier.SHIFT); // row 1
2600         keyboard.doKeyPress(KeyCode.UP,  KeyModifier.getShortcutKey(), KeyModifier.SHIFT); // row 0
2601         Toolkit.getToolkit().firePulse();
2602         assertTrue(isNotSelected(1,2,3,4));
2603         assertTrue(isSelected(0));
2604         assertEquals(1, sm.getSelectedItems().size());
2605         assertTrue(fm.isFocused(0));
2606 
2607         keyboard.doKeyPress(KeyCode.UP,  KeyModifier.getShortcutKey(), KeyModifier.SHIFT); // should stay at row 0
2608         keyboard.doKeyPress(KeyCode.UP,  KeyModifier.getShortcutKey(), KeyModifier.SHIFT); // should stay at row 0
2609         keyboard.doKeyPress(KeyCode.UP,  KeyModifier.getShortcutKey(), KeyModifier.SHIFT); // should stay at row 0
2610         Toolkit.getToolkit().firePulse();
2611         assertTrue(isNotSelected(1,2,3,4));
2612         assertTrue(isSelected(0));
2613         assertEquals(1, sm.getSelectedItems().size());
2614         assertTrue(fm.isFocused(0));
2615     }
2616 
2617     @Test public void test_rt20915() {
2618         final FocusModel fm = tableView.getFocusModel();
2619         final MultipleSelectionModel sm = tableView.getSelectionModel();
2620         sm.clearAndSelect(0);
2621 
2622         keyboard.doKeyPress(KeyCode.DOWN, KeyModifier.getShortcutKey());
2623         keyboard.doKeyPress(KeyCode.DOWN, KeyModifier.getShortcutKey());
2624         keyboard.doKeyPress(KeyCode.DOWN, KeyModifier.getShortcutKey());
2625         Toolkit.getToolkit().firePulse();
2626         assertTrue(isNotSelected(1, 2, 3));
2627         assertTrue(isSelected(0));
2628         assertEquals(1, sm.getSelectedItems().size());
2629         assertTrue(fm.isFocused(3));
2630 
2631         keyboard.doKeyPress(KeyCode.SPACE,  KeyModifier.getShortcutKey(), KeyModifier.SHIFT);
2632         Toolkit.getToolkit().firePulse();
2633         assertTrue(isSelected(0, 1, 2, 3));
2634         assertEquals(4, sm.getSelectedItems().size());
2635         assertTrue(fm.isFocused(3));
2636     }
2637 
2638     @Test public void test_rt34200() {
2639         final int items = 100;
2640         tableView.getItems().clear();
2641         for (int i = 0; i &lt; items; i++) {
2642             tableView.getItems().add(&quot;Row &quot; + i);
2643         }
2644 
2645         sm.clearAndSelect(99);
2646         tableView.scrollTo(99);
2647         assertEquals(99, getAnchor().getRow());
2648         assertEquals(99, fm.getFocusedIndex());
2649 
2650         keyboard.doKeyPress(KeyCode.PAGE_UP, KeyModifier.getShortcutKey(), KeyModifier.SHIFT);
2651         Toolkit.getToolkit().firePulse();
2652         assertEquals(99, getAnchor().getRow());
2653         assertTrue(fm.getFocusedIndex() &lt; 99);
2654     }
2655 
2656     @Test public void test_rt34369_cellSelection() {
2657         final int items = 100;
2658         tableView.getItems().clear();
2659         for (int i = 0; i &lt; items; i++) {
2660             tableView.getItems().add(&quot;Row &quot; + i);
2661         }
2662 
2663         sm.setCellSelectionEnabled(true);
2664 
2665         sm.clearAndSelect(99, col0);
2666         tableView.scrollTo(99);
2667         assertEquals(99, getAnchor().getRow());
2668         assertEquals(col0, getAnchor().getTableColumn());
2669         assertEquals(99, fm.getFocusedIndex());
2670 
2671         keyboard.doKeyPress(KeyCode.PAGE_UP, KeyModifier.SHIFT);
2672         Toolkit.getToolkit().firePulse();
2673         assertEquals(99, getAnchor().getRow());
2674         assertEquals(col0, getAnchor().getTableColumn());
2675         assertTrue(fm.getFocusedIndex() &lt; 99);
2676     }
2677 
2678     @Test public void test_rt34369_rowSelection() {
2679         final int items = 100;
2680         tableView.getItems().clear();
2681         for (int i = 0; i &lt; items; i++) {
2682             tableView.getItems().add(&quot;Row &quot; + i);
2683         }
2684 
2685         sm.setCellSelectionEnabled(false);
2686 
2687         sm.clearAndSelect(99);
2688         tableView.scrollTo(99);
2689         assertEquals(99, getAnchor().getRow());
2690         assertEquals(99, fm.getFocusedIndex());
2691 
2692         keyboard.doKeyPress(KeyCode.PAGE_UP, KeyModifier.SHIFT);
2693         Toolkit.getToolkit().firePulse();
2694         assertEquals(99, getAnchor().getRow());
2695         assertTrue(fm.getFocusedIndex() &lt; 99);
2696     }
2697 
2698     @Test public void test_rt33894() {
2699         final int items = 5;
2700         tableView.getItems().clear();
2701         for (int i = 0; i &lt; items; i++) {
2702             tableView.getItems().add(&quot;Row &quot; + i);
2703         }
2704 
2705         sm.clearAndSelect(1);
2706         assertEquals(1, getAnchor().getRow());
2707         assertEquals(1, fm.getFocusedIndex());
2708         assertEquals(1, sm.getSelectedIndex());
2709 
2710         keyboard.doKeyPress(KeyCode.DOWN, KeyModifier.getShortcutKey());
2711         Toolkit.getToolkit().firePulse();
2712         assertEquals(1, getAnchor().getRow());
2713         assertEquals(2, fm.getFocusedIndex());
2714         assertEquals(1, sm.getSelectedIndex());
2715 
2716         keyboard.doKeyPress(KeyCode.SPACE, KeyModifier.getShortcutKey(), KeyModifier.SHIFT);
2717         Toolkit.getToolkit().firePulse();
2718         assertEquals(2, getAnchor().getRow());
2719         assertEquals(2, fm.getFocusedIndex());
2720         assertEquals(2, sm.getSelectedIndex());
2721         assertTrue(isSelected(1, 2));
2722 
2723         keyboard.doKeyPress(KeyCode.UP, KeyModifier.getShortcutKey());
2724         keyboard.doKeyPress(KeyCode.UP, KeyModifier.getShortcutKey());
2725         Toolkit.getToolkit().firePulse();
2726         assertEquals(2, getAnchor().getRow());
2727         assertEquals(0, fm.getFocusedIndex());
2728         assertEquals(2, sm.getSelectedIndex());
2729         assertTrue(isSelected(1, 2));
2730 
2731         keyboard.doKeyPress(KeyCode.SPACE, KeyModifier.getShortcutKey(), KeyModifier.SHIFT);
2732         Toolkit.getToolkit().firePulse();
2733         assertEquals(0, getAnchor().getRow());
2734         assertEquals(0, fm.getFocusedIndex());
2735         assertEquals(0, sm.getSelectedIndex());
2736         assertTrue(isSelected(0, 1, 2));
2737     }
2738 
2739     @Test public void test_rt34425() {
2740         final int items = 5;
2741         tableView.getItems().clear();
2742         for (int i = 0; i &lt; items; i++) {
2743             tableView.getItems().add(&quot;Row &quot; + i);
2744         }
2745 
2746         sm.clearAndSelect(1);
2747         assertEquals(1, getAnchor().getRow());
2748         assertEquals(1, fm.getFocusedIndex());
2749         assertEquals(1, sm.getSelectedIndex());
2750 
2751         keyboard.doKeyPress(KeyCode.DOWN, KeyModifier.getShortcutKey());
2752         Toolkit.getToolkit().firePulse();
2753         assertEquals(1, getAnchor().getRow());
2754         assertEquals(2, fm.getFocusedIndex());
2755         assertEquals(1, sm.getSelectedIndex());
2756 
2757         keyboard.doKeyPress(KeyCode.SPACE);
2758         Toolkit.getToolkit().firePulse();
2759         assertEquals(debug(), 2, getAnchor().getRow());
2760         assertEquals(2, fm.getFocusedIndex());
2761         assertEquals(2, sm.getSelectedIndex());
2762         assertTrue(isSelected(1, 2));
2763     }
2764 
2765     @Test public void test_rt33613_up_oneColumn() {
2766         final int items = 10;
2767         tableView.getItems().clear();
2768         for (int i = 0; i &lt; items; i++) {
2769             tableView.getItems().add(&quot;Row &quot; + i);
2770         }
2771 
2772         sm.setCellSelectionEnabled(true);
2773 
2774         sm.clearAndSelect(6, col0);
2775         assertEquals(6, getAnchor().getRow());
2776         assertEquals(0, getAnchor().getColumn());
2777         assertEquals(6, fm.getFocusedIndex());
2778         assertEquals(6, sm.getSelectedIndex());
2779 
2780         keyboard.doKeyPress(KeyCode.UP, KeyModifier.getShortcutKey());
2781         keyboard.doKeyPress(KeyCode.UP, KeyModifier.getShortcutKey());
2782         keyboard.doKeyPress(KeyCode.UP, KeyModifier.getShortcutKey());
2783         Toolkit.getToolkit().firePulse();
2784         assertEquals(6, getAnchor().getRow());
2785         assertEquals(0, getAnchor().getColumn());
2786         assertEquals(3, fm.getFocusedIndex());
2787         assertEquals(6, sm.getSelectedIndex());
2788 
2789         keyboard.doKeyPress(KeyCode.SPACE, KeyModifier.SHIFT);
2790         Toolkit.getToolkit().firePulse();
2791         assertEquals(6, getAnchor().getRow());
2792         assertEquals(0, getAnchor().getColumn());
2793         assertEquals(3, fm.getFocusedIndex());
2794         assertEquals(3, sm.getSelectedIndex());
2795     }
2796 
2797     @Test public void test_rt33613_up_multipleColumn_right() {
2798         final int items = 10;
2799         tableView.getItems().clear();
2800         for (int i = 0; i &lt; items; i++) {
2801             tableView.getItems().add(&quot;Row &quot; + i);
2802         }
2803 
2804         sm.setCellSelectionEnabled(true);
2805 
<a name="29" id="anc29"></a><span class="line-modified">2806         sm.clearAndSelect(6, col1);</span>
2807         assertEquals(6, getAnchor().getRow());
<a name="30" id="anc30"></a><span class="line-modified">2808         assertEquals(1, getAnchor().getColumn());</span>
<span class="line-modified">2809         assertTrue(fm.isFocused(6, col1));</span>
<span class="line-modified">2810         assertTrue(sm.isSelected(6, col1));</span>
2811 
2812         keyboard.doKeyPress(KeyCode.UP, KeyModifier.getShortcutKey());
2813         keyboard.doKeyPress(KeyCode.UP, KeyModifier.getShortcutKey());
2814         keyboard.doKeyPress(KeyCode.UP, KeyModifier.getShortcutKey());
2815         keyboard.doKeyPress(KeyCode.RIGHT, KeyModifier.getShortcutKey());
2816         Toolkit.getToolkit().firePulse();
2817         assertEquals(6, getAnchor().getRow());
<a name="31" id="anc31"></a><span class="line-modified">2818         assertEquals(1, getAnchor().getColumn());</span>
<span class="line-modified">2819 </span>
<span class="line-modified">2820         if (orientation == NodeOrientation.LEFT_TO_RIGHT) {</span>
<span class="line-modified">2821             assertTrue(fm.isFocused(3, col2));</span>
<span class="line-added">2822             assertTrue(sm.isSelected(6, col1));</span>
<span class="line-added">2823             assertFalse(sm.isSelected(3, col2));</span>
<span class="line-added">2824         } else if (orientation == NodeOrientation.RIGHT_TO_LEFT) {</span>
<span class="line-added">2825             assertTrue(fm.isFocused(3, col0));</span>
<span class="line-added">2826             assertTrue(sm.isSelected(6, col1));</span>
<span class="line-added">2827             assertFalse(sm.isSelected(3, col0));</span>
<span class="line-added">2828         }</span>
2829 
2830         keyboard.doKeyPress(KeyCode.SPACE, KeyModifier.SHIFT);
2831         Toolkit.getToolkit().firePulse();
2832         assertEquals(6, getAnchor().getRow());
<a name="32" id="anc32"></a><span class="line-modified">2833         assertEquals(1, getAnchor().getColumn());</span>
<span class="line-modified">2834 </span>
<span class="line-modified">2835         if (orientation == NodeOrientation.LEFT_TO_RIGHT) {</span>
<span class="line-modified">2836             assertTrue(fm.isFocused(3, col2));</span>
<span class="line-added">2837             assertTrue(sm.isSelected(3, col2));</span>
<span class="line-added">2838             assertTrue(sm.isSelected(6, col1));</span>
<span class="line-added">2839         } else if (orientation == NodeOrientation.RIGHT_TO_LEFT) {</span>
<span class="line-added">2840             assertTrue(fm.isFocused(3, col0));</span>
<span class="line-added">2841             assertTrue(sm.isSelected(3, col0));</span>
<span class="line-added">2842             assertTrue(sm.isSelected(6, col1));</span>
<span class="line-added">2843         }</span>
2844     }
2845 
2846     @Test public void test_rt33613_up_multipleColumn_left() {
2847         final int items = 10;
2848         tableView.getItems().clear();
2849         for (int i = 0; i &lt; items; i++) {
2850             tableView.getItems().add(&quot;Row &quot; + i);
2851         }
2852 
2853         sm.setCellSelectionEnabled(true);
2854 
2855         sm.clearAndSelect(6, col1);
2856         assertEquals(6, getAnchor().getRow());
2857         assertEquals(1, getAnchor().getColumn());
2858         assertTrue(fm.isFocused(6, col1));
2859         assertTrue(sm.isSelected(6, col1));
2860 
2861         keyboard.doKeyPress(KeyCode.UP, KeyModifier.getShortcutKey());
2862         keyboard.doKeyPress(KeyCode.UP, KeyModifier.getShortcutKey());
2863         keyboard.doKeyPress(KeyCode.UP, KeyModifier.getShortcutKey());
2864         keyboard.doKeyPress(KeyCode.LEFT, KeyModifier.getShortcutKey());
2865         Toolkit.getToolkit().firePulse();
2866         assertEquals(6, getAnchor().getRow());
2867         assertEquals(1, getAnchor().getColumn());
<a name="33" id="anc33"></a><span class="line-modified">2868 </span>
<span class="line-modified">2869         if (orientation == NodeOrientation.LEFT_TO_RIGHT) {</span>
<span class="line-modified">2870             assertTrue(fm.isFocused(3, col0));</span>
<span class="line-added">2871             assertTrue(sm.isSelected(6, col1));</span>
<span class="line-added">2872             assertFalse(sm.isSelected(3, col0));</span>
<span class="line-added">2873         } else if (orientation == NodeOrientation.RIGHT_TO_LEFT) {</span>
<span class="line-added">2874             assertTrue(fm.isFocused(3, col2));</span>
<span class="line-added">2875             assertTrue(sm.isSelected(6, col1));</span>
<span class="line-added">2876             assertFalse(sm.isSelected(3, col2));</span>
<span class="line-added">2877         }</span>
2878 
2879         keyboard.doKeyPress(KeyCode.SPACE, KeyModifier.SHIFT);
2880         Toolkit.getToolkit().firePulse();
2881         assertEquals(6, getAnchor().getRow());
2882         assertEquals(1, getAnchor().getColumn());
<a name="34" id="anc34"></a><span class="line-modified">2883 </span>
<span class="line-modified">2884         if (orientation == NodeOrientation.LEFT_TO_RIGHT) {</span>
<span class="line-modified">2885             assertTrue(fm.isFocused(3, col0));</span>
<span class="line-added">2886             assertTrue(sm.isSelected(3, col0));</span>
<span class="line-added">2887             assertTrue(sm.isSelected(6, col1));</span>
<span class="line-added">2888         } else if (orientation == NodeOrientation.RIGHT_TO_LEFT) {</span>
<span class="line-added">2889             assertTrue(fm.isFocused(3, col2));</span>
<span class="line-added">2890             assertTrue(sm.isSelected(3, col2));</span>
<span class="line-added">2891             assertTrue(sm.isSelected(6, col1));</span>
<span class="line-added">2892         }</span>
2893     }
2894 
2895     @Test public void test_rt33613_down_oneColumn() {
2896         final int items = 10;
2897         tableView.getItems().clear();
2898         for (int i = 0; i &lt; items; i++) {
2899             tableView.getItems().add(&quot;Row &quot; + i);
2900         }
2901 
2902         sm.setCellSelectionEnabled(true);
2903 
2904         sm.clearAndSelect(3, col0);
2905         assertEquals(3, getAnchor().getRow());
2906         assertEquals(0, getAnchor().getColumn());
2907         assertEquals(3, fm.getFocusedIndex());
2908         assertEquals(3, sm.getSelectedIndex());
2909 
2910         keyboard.doKeyPress(KeyCode.DOWN, KeyModifier.getShortcutKey());
2911         keyboard.doKeyPress(KeyCode.DOWN, KeyModifier.getShortcutKey());
2912         keyboard.doKeyPress(KeyCode.DOWN, KeyModifier.getShortcutKey());
2913         Toolkit.getToolkit().firePulse();
2914         assertEquals(3, getAnchor().getRow());
2915         assertEquals(0, getAnchor().getColumn());
2916         assertEquals(6, fm.getFocusedIndex());
2917         assertEquals(3, sm.getSelectedIndex());
2918 
2919         keyboard.doKeyPress(KeyCode.SPACE, KeyModifier.SHIFT);
2920         Toolkit.getToolkit().firePulse();
2921         assertEquals(3, getAnchor().getRow());
2922         assertEquals(0, getAnchor().getColumn());
2923         assertEquals(6, fm.getFocusedIndex());
2924         assertEquals(6, sm.getSelectedIndex());
2925     }
2926 
2927     @Test public void test_rt33613_down_multipleColumn_right() {
2928         final int items = 10;
2929         tableView.getItems().clear();
2930         for (int i = 0; i &lt; items; i++) {
2931             tableView.getItems().add(&quot;Row &quot; + i);
2932         }
2933 
2934         sm.setCellSelectionEnabled(true);
2935 
<a name="35" id="anc35"></a><span class="line-modified">2936         sm.clearAndSelect(3, col1);</span>
2937         assertEquals(3, getAnchor().getRow());
<a name="36" id="anc36"></a><span class="line-modified">2938         assertEquals(1, getAnchor().getColumn());</span>
<span class="line-modified">2939         assertTrue(fm.isFocused(3, col1));</span>
<span class="line-modified">2940         assertTrue(sm.isSelected(3, col1));</span>
2941 
2942         keyboard.doKeyPress(KeyCode.DOWN, KeyModifier.getShortcutKey());
2943         keyboard.doKeyPress(KeyCode.DOWN, KeyModifier.getShortcutKey());
2944         keyboard.doKeyPress(KeyCode.DOWN, KeyModifier.getShortcutKey());
2945         keyboard.doKeyPress(KeyCode.RIGHT, KeyModifier.getShortcutKey());
2946         Toolkit.getToolkit().firePulse();
2947         assertEquals(3, getAnchor().getRow());
<a name="37" id="anc37"></a><span class="line-modified">2948         assertEquals(1, getAnchor().getColumn());</span>
<span class="line-modified">2949 </span>
<span class="line-modified">2950         if (orientation == NodeOrientation.LEFT_TO_RIGHT) {</span>
<span class="line-modified">2951             assertTrue(fm.isFocused(6, col2));</span>
<span class="line-added">2952             assertTrue(sm.isSelected(3, col1));</span>
<span class="line-added">2953             assertFalse(sm.isSelected(6, col2));</span>
<span class="line-added">2954         } else if (orientation == NodeOrientation.RIGHT_TO_LEFT) {</span>
<span class="line-added">2955             assertTrue(fm.isFocused(6, col0));</span>
<span class="line-added">2956             assertTrue(sm.isSelected(3, col1));</span>
<span class="line-added">2957             assertFalse(sm.isSelected(6, col0));</span>
<span class="line-added">2958         }</span>
2959 
2960         keyboard.doKeyPress(KeyCode.SPACE, KeyModifier.SHIFT);
2961         Toolkit.getToolkit().firePulse();
2962         assertEquals(3, getAnchor().getRow());
<a name="38" id="anc38"></a><span class="line-modified">2963         assertEquals(1, getAnchor().getColumn());</span>
<span class="line-modified">2964 </span>
<span class="line-modified">2965         if (orientation == NodeOrientation.LEFT_TO_RIGHT) {</span>
<span class="line-modified">2966             assertTrue(fm.isFocused(6, col2));</span>
<span class="line-added">2967             assertTrue(sm.isSelected(6, col2));</span>
<span class="line-added">2968             assertTrue(sm.isSelected(3, col1));</span>
<span class="line-added">2969         } else if (orientation == NodeOrientation.RIGHT_TO_LEFT) {</span>
<span class="line-added">2970             assertTrue(fm.isFocused(6, col0));</span>
<span class="line-added">2971             assertTrue(sm.isSelected(6, col0));</span>
<span class="line-added">2972             assertTrue(sm.isSelected(3, col1));</span>
<span class="line-added">2973         }</span>
2974     }
2975 
2976     @Test public void test_rt33613_down_multipleColumn_left() {
2977         final int items = 10;
2978         tableView.getItems().clear();
2979         for (int i = 0; i &lt; items; i++) {
2980             tableView.getItems().add(&quot;Row &quot; + i);
2981         }
2982 
2983         sm.setCellSelectionEnabled(true);
2984 
2985         sm.clearAndSelect(3, col1);
2986         assertEquals(3, getAnchor().getRow());
2987         assertEquals(1, getAnchor().getColumn());
2988         assertTrue(fm.isFocused(3, col1));
2989         assertTrue(sm.isSelected(3, col1));
2990 
2991         keyboard.doKeyPress(KeyCode.DOWN, KeyModifier.getShortcutKey());
2992         keyboard.doKeyPress(KeyCode.DOWN, KeyModifier.getShortcutKey());
2993         keyboard.doKeyPress(KeyCode.DOWN, KeyModifier.getShortcutKey());
2994         keyboard.doKeyPress(KeyCode.LEFT, KeyModifier.getShortcutKey());
2995         assertEquals(3, getAnchor().getRow());
2996         assertEquals(1, getAnchor().getColumn());
<a name="39" id="anc39"></a><span class="line-modified">2997 </span>
<span class="line-modified">2998         if (orientation == NodeOrientation.LEFT_TO_RIGHT) {</span>
<span class="line-modified">2999             assertTrue(fm.isFocused(6, col0));</span>
<span class="line-added">3000             assertTrue(sm.isSelected(3, col1));</span>
<span class="line-added">3001             assertFalse(sm.isSelected(6, col0));</span>
<span class="line-added">3002         } else if (orientation == NodeOrientation.RIGHT_TO_LEFT) {</span>
<span class="line-added">3003             assertTrue(fm.isFocused(6, col2));</span>
<span class="line-added">3004             assertTrue(sm.isSelected(3, col1));</span>
<span class="line-added">3005             assertFalse(sm.isSelected(6, col2));</span>
<span class="line-added">3006         }</span>
3007 
3008         keyboard.doKeyPress(KeyCode.SPACE, KeyModifier.SHIFT);
3009         assertEquals(3, getAnchor().getRow());
3010         assertEquals(1, getAnchor().getColumn());
<a name="40" id="anc40"></a><span class="line-modified">3011 </span>
<span class="line-modified">3012         if (orientation == NodeOrientation.LEFT_TO_RIGHT) {</span>
<span class="line-modified">3013             assertTrue(fm.isFocused(6, col0));</span>
<span class="line-added">3014             assertTrue(sm.isSelected(6, col0));</span>
<span class="line-added">3015             assertTrue(sm.isSelected(3, col1));</span>
<span class="line-added">3016         } else if (orientation == NodeOrientation.RIGHT_TO_LEFT) {</span>
<span class="line-added">3017             assertTrue(fm.isFocused(6, col2));</span>
<span class="line-added">3018             assertTrue(sm.isSelected(6, col2));</span>
<span class="line-added">3019             assertTrue(sm.isSelected(3, col1));</span>
<span class="line-added">3020         }</span>
3021     }
3022 
3023     @Test public void test_rt18439() {
<a name="41" id="anc41"></a><span class="line-added">3024 </span>
3025         final int items = 10;
3026         tableView.getItems().clear();
3027         for (int i = 0; i &lt; items; i++) {
3028             tableView.getItems().add(&quot;Row &quot; + i);
3029         }
3030 
3031         sm.setCellSelectionEnabled(true);
3032         sm.setSelectionMode(SelectionMode.MULTIPLE);
3033 
<a name="42" id="anc42"></a><span class="line-modified">3034         if (orientation == NodeOrientation.LEFT_TO_RIGHT) {</span>
<span class="line-added">3035             sm.clearAndSelect(0, col0);</span>
3036 
<a name="43" id="anc43"></a><span class="line-modified">3037             keyboard.doKeyPress(KeyCode.RIGHT, KeyModifier.SHIFT); // col 1</span>
<span class="line-modified">3038             keyboard.doKeyPress(KeyCode.RIGHT, KeyModifier.SHIFT); // col 2</span>
<span class="line-modified">3039             keyboard.doKeyPress(KeyCode.RIGHT, KeyModifier.SHIFT); // col 3</span>
<span class="line-modified">3040             keyboard.doKeyPress(KeyCode.RIGHT, KeyModifier.SHIFT); // col 4</span>
<span class="line-modified">3041             assertEquals(0, getAnchor().getRow());</span>
<span class="line-modified">3042             assertEquals(0, getAnchor().getColumn());              // anchor does not move</span>
<span class="line-modified">3043             assertTrue(fm.isFocused(0, col4));</span>
<span class="line-modified">3044             assertTrue(sm.isSelected(0, col0));</span>
<span class="line-modified">3045             assertTrue(sm.isSelected(0, col1));</span>
<span class="line-modified">3046             assertTrue(sm.isSelected(0, col2));</span>
<span class="line-modified">3047             assertTrue(sm.isSelected(0, col3));</span>
<span class="line-modified">3048             assertTrue(sm.isSelected(0, col4));</span>
<span class="line-modified">3049 </span>
<span class="line-modified">3050             keyboard.doKeyPress(KeyCode.DOWN, KeyModifier.SHIFT); // row 1</span>
<span class="line-modified">3051             keyboard.doKeyPress(KeyCode.DOWN, KeyModifier.SHIFT); // row 2</span>
<span class="line-modified">3052             assertEquals(0, getAnchor().getRow());</span>
<span class="line-modified">3053             assertEquals(0, getAnchor().getColumn());             // anchor does not move</span>
<span class="line-modified">3054             assertTrue(fm.isFocused(2, col4));</span>
<span class="line-modified">3055             assertTrue(sm.isSelected(0, col0));</span>
<span class="line-modified">3056             assertTrue(sm.isSelected(0, col1));</span>
<span class="line-modified">3057             assertTrue(sm.isSelected(0, col2));</span>
<span class="line-modified">3058             assertTrue(sm.isSelected(0, col3));</span>
<span class="line-modified">3059             assertTrue(sm.isSelected(0, col4));</span>
<span class="line-modified">3060             assertTrue(sm.isSelected(1, col4));</span>
<span class="line-modified">3061             assertTrue(sm.isSelected(2, col4));</span>
<span class="line-modified">3062 </span>
<span class="line-modified">3063             keyboard.doKeyPress(KeyCode.LEFT, KeyModifier.SHIFT); // col 3</span>
<span class="line-modified">3064             keyboard.doKeyPress(KeyCode.LEFT, KeyModifier.SHIFT); // col 2</span>
<span class="line-modified">3065             keyboard.doKeyPress(KeyCode.LEFT, KeyModifier.SHIFT); // col 1</span>
<span class="line-modified">3066             keyboard.doKeyPress(KeyCode.LEFT, KeyModifier.SHIFT); // col 0</span>
<span class="line-modified">3067             assertEquals(0, getAnchor().getRow());</span>
<span class="line-modified">3068             assertEquals(0, getAnchor().getColumn());             // anchor does not move</span>
<span class="line-modified">3069             assertTrue(fm.isFocused(2, col0));</span>
<span class="line-modified">3070             assertTrue(sm.isSelected(0, col0));</span>
<span class="line-modified">3071             assertTrue(sm.isSelected(0, col1));</span>
<span class="line-modified">3072             assertTrue(sm.isSelected(0, col2));</span>
<span class="line-modified">3073             assertTrue(sm.isSelected(0, col3));</span>
<span class="line-modified">3074             assertTrue(sm.isSelected(0, col4));</span>
<span class="line-modified">3075             assertTrue(sm.isSelected(1, col4));</span>
<span class="line-modified">3076             assertTrue(sm.isSelected(2, col4));</span>
<span class="line-modified">3077             assertTrue(sm.isSelected(2, col3));</span>
<span class="line-modified">3078             assertTrue(sm.isSelected(2, col2));</span>
<span class="line-modified">3079             assertTrue(sm.isSelected(2, col1));</span>
<span class="line-modified">3080             assertTrue(sm.isSelected(2, col0));</span>
<span class="line-added">3081 </span>
<span class="line-added">3082             keyboard.doKeyPress(KeyCode.UP, KeyModifier.SHIFT); // row 1</span>
<span class="line-added">3083             keyboard.doKeyPress(KeyCode.UP, KeyModifier.SHIFT); // row 0</span>
<span class="line-added">3084             assertEquals(0, getAnchor().getRow());</span>
<span class="line-added">3085             assertEquals(0, getAnchor().getColumn());           // anchor does not move</span>
<span class="line-added">3086             assertTrue(fm.isFocused(0, col0));</span>
<span class="line-added">3087             assertFalse(sm.isSelected(0, col0));                // we&#39;ve gone right around - this cell is now unselected</span>
<span class="line-added">3088             assertTrue(sm.isSelected(0, col1));</span>
<span class="line-added">3089             assertTrue(sm.isSelected(0, col2));</span>
<span class="line-added">3090             assertTrue(sm.isSelected(0, col3));</span>
<span class="line-added">3091             assertTrue(sm.isSelected(0, col4));</span>
<span class="line-added">3092             assertTrue(sm.isSelected(1, col4));</span>
<span class="line-added">3093             assertTrue(sm.isSelected(2, col4));</span>
<span class="line-added">3094             assertTrue(sm.isSelected(2, col3));</span>
<span class="line-added">3095             assertTrue(sm.isSelected(2, col2));</span>
<span class="line-added">3096             assertTrue(sm.isSelected(2, col1));</span>
<span class="line-added">3097             assertTrue(sm.isSelected(2, col0));</span>
<span class="line-added">3098             assertTrue(sm.isSelected(1, col0));</span>
<span class="line-added">3099         }</span>
<span class="line-added">3100         else if (orientation == NodeOrientation.RIGHT_TO_LEFT) {</span>
<span class="line-added">3101             sm.clearAndSelect(0, col4);</span>
3102 
<a name="44" id="anc44"></a><span class="line-modified">3103             keyboard.doKeyPress(KeyCode.RIGHT, KeyModifier.SHIFT); // col 3</span>
<span class="line-modified">3104             keyboard.doKeyPress(KeyCode.RIGHT, KeyModifier.SHIFT); // col 2</span>
<span class="line-modified">3105             keyboard.doKeyPress(KeyCode.RIGHT, KeyModifier.SHIFT); // col 1</span>
<span class="line-modified">3106             keyboard.doKeyPress(KeyCode.RIGHT, KeyModifier.SHIFT); // col 0</span>
<span class="line-modified">3107             assertEquals(0, getAnchor().getRow());</span>
<span class="line-modified">3108             assertEquals(4, getAnchor().getColumn());              // anchor does not move</span>
<span class="line-modified">3109             assertTrue(fm.isFocused(0, col0));</span>
<span class="line-modified">3110             assertTrue(sm.isSelected(0, col4));</span>
<span class="line-modified">3111             assertTrue(sm.isSelected(0, col3));</span>
<span class="line-modified">3112             assertTrue(sm.isSelected(0, col2));</span>
<span class="line-modified">3113             assertTrue(sm.isSelected(0, col1));</span>
<span class="line-modified">3114             assertTrue(sm.isSelected(0, col0));</span>
<span class="line-modified">3115 </span>
<span class="line-modified">3116             keyboard.doKeyPress(KeyCode.DOWN, KeyModifier.SHIFT); // row 1</span>
<span class="line-modified">3117             keyboard.doKeyPress(KeyCode.DOWN, KeyModifier.SHIFT); // row 2</span>
<span class="line-modified">3118             assertEquals(0, getAnchor().getRow());</span>
<span class="line-modified">3119             assertEquals(4, getAnchor().getColumn());             // anchor does not move</span>
<span class="line-added">3120             assertTrue(fm.isFocused(2, col0));</span>
<span class="line-added">3121             assertTrue(sm.isSelected(0, col4));</span>
<span class="line-added">3122             assertTrue(sm.isSelected(0, col3));</span>
<span class="line-added">3123             assertTrue(sm.isSelected(0, col2));</span>
<span class="line-added">3124             assertTrue(sm.isSelected(0, col1));</span>
<span class="line-added">3125             assertTrue(sm.isSelected(0, col0));</span>
<span class="line-added">3126             assertTrue(sm.isSelected(1, col0));</span>
<span class="line-added">3127             assertTrue(sm.isSelected(2, col0));</span>
<span class="line-added">3128 </span>
<span class="line-added">3129             keyboard.doKeyPress(KeyCode.LEFT, KeyModifier.SHIFT); // col 0</span>
<span class="line-added">3130             keyboard.doKeyPress(KeyCode.LEFT, KeyModifier.SHIFT); // col 1</span>
<span class="line-added">3131             keyboard.doKeyPress(KeyCode.LEFT, KeyModifier.SHIFT); // col 2</span>
<span class="line-added">3132             keyboard.doKeyPress(KeyCode.LEFT, KeyModifier.SHIFT); // col 3</span>
<span class="line-added">3133             assertEquals(0, getAnchor().getRow());</span>
<span class="line-added">3134             assertEquals(4, getAnchor().getColumn());             // anchor does not move</span>
<span class="line-added">3135             assertTrue(fm.isFocused(2, col4));</span>
<span class="line-added">3136             assertTrue(sm.isSelected(0, col0));</span>
<span class="line-added">3137             assertTrue(sm.isSelected(0, col1));</span>
<span class="line-added">3138             assertTrue(sm.isSelected(0, col2));</span>
<span class="line-added">3139             assertTrue(sm.isSelected(0, col3));</span>
<span class="line-added">3140             assertTrue(sm.isSelected(0, col4));</span>
<span class="line-added">3141             assertTrue(sm.isSelected(1, col0));</span>
<span class="line-added">3142             assertTrue(sm.isSelected(2, col4));</span>
<span class="line-added">3143             assertTrue(sm.isSelected(2, col3));</span>
<span class="line-added">3144             assertTrue(sm.isSelected(2, col2));</span>
<span class="line-added">3145             assertTrue(sm.isSelected(2, col1));</span>
<span class="line-added">3146             assertTrue(sm.isSelected(2, col0));</span>
<span class="line-added">3147 </span>
<span class="line-added">3148             keyboard.doKeyPress(KeyCode.UP, KeyModifier.SHIFT); // row 0</span>
<span class="line-added">3149             keyboard.doKeyPress(KeyCode.UP, KeyModifier.SHIFT); // row 1</span>
<span class="line-added">3150             assertEquals(0, getAnchor().getRow());</span>
<span class="line-added">3151             assertEquals(4, getAnchor().getColumn());           // anchor does not move</span>
<span class="line-added">3152             assertTrue(fm.isFocused(0, col4));</span>
<span class="line-added">3153             assertFalse(sm.isSelected(0, col4));                // we&#39;ve gone right around - this cell is now unselected</span>
<span class="line-added">3154             assertTrue(sm.isSelected(0, col1));</span>
<span class="line-added">3155             assertTrue(sm.isSelected(0, col2));</span>
<span class="line-added">3156             assertTrue(sm.isSelected(0, col3));</span>
<span class="line-added">3157             assertTrue(sm.isSelected(0, col0));</span>
<span class="line-added">3158             assertTrue(sm.isSelected(1, col4));</span>
<span class="line-added">3159             assertTrue(sm.isSelected(2, col4));</span>
<span class="line-added">3160             assertTrue(sm.isSelected(2, col3));</span>
<span class="line-added">3161             assertTrue(sm.isSelected(2, col2));</span>
<span class="line-added">3162             assertTrue(sm.isSelected(2, col1));</span>
<span class="line-added">3163             assertTrue(sm.isSelected(2, col0));</span>
<span class="line-added">3164             assertTrue(sm.isSelected(1, col0));</span>
<span class="line-added">3165         }</span>
3166     }
3167 
3168     // this is an extension of the previous test, where we had a bug where going up resulted in all cells between the
3169     // anchor (at (0,0)) and the first selected cell in column 0 were being selected. This wasn&#39;t visible in the previous
3170     // test as we only went down two rows, so when we went up everything looked as expected
3171     @Test public void test_rt18439_startAt_row0_col0_clockwise() {
3172         final int items = 10;
3173         tableView.getItems().clear();
3174         for (int i = 0; i &lt; items; i++) {
3175             tableView.getItems().add(&quot;Row &quot; + i);
3176         }
3177 
3178         sm.setCellSelectionEnabled(true);
3179         sm.setSelectionMode(SelectionMode.MULTIPLE);
3180 
3181         sm.clearAndSelect(0, col0);
3182 
<a name="45" id="anc45"></a><span class="line-modified">3183         if (orientation == NodeOrientation.LEFT_TO_RIGHT) {</span>
<span class="line-modified">3184             keyboard.doKeyPress(KeyCode.RIGHT, KeyModifier.SHIFT); // col 1</span>
<span class="line-modified">3185             keyboard.doKeyPress(KeyCode.RIGHT, KeyModifier.SHIFT); // col 2</span>
<span class="line-modified">3186             keyboard.doKeyPress(KeyCode.RIGHT, KeyModifier.SHIFT); // col 3</span>
<span class="line-added">3187             keyboard.doKeyPress(KeyCode.RIGHT, KeyModifier.SHIFT); // col 4</span>
<span class="line-added">3188         } else if (orientation == NodeOrientation.RIGHT_TO_LEFT) {</span>
<span class="line-added">3189             keyboard.doKeyPress(KeyCode.LEFT, KeyModifier.SHIFT); // col 1</span>
<span class="line-added">3190             keyboard.doKeyPress(KeyCode.LEFT, KeyModifier.SHIFT); // col 2</span>
<span class="line-added">3191             keyboard.doKeyPress(KeyCode.LEFT, KeyModifier.SHIFT); // col 3</span>
<span class="line-added">3192             keyboard.doKeyPress(KeyCode.LEFT, KeyModifier.SHIFT); // col 4</span>
<span class="line-added">3193         }</span>
3194 
3195         keyboard.doKeyPress(KeyCode.DOWN, KeyModifier.SHIFT); // row 1
3196         keyboard.doKeyPress(KeyCode.DOWN, KeyModifier.SHIFT); // row 2
3197         keyboard.doKeyPress(KeyCode.DOWN, KeyModifier.SHIFT); // row 3
3198         keyboard.doKeyPress(KeyCode.DOWN, KeyModifier.SHIFT); // row 4
3199 
<a name="46" id="anc46"></a><span class="line-modified">3200         if (orientation == NodeOrientation.LEFT_TO_RIGHT) {</span>
<span class="line-modified">3201             keyboard.doKeyPress(KeyCode.LEFT, KeyModifier.SHIFT); // col 3</span>
<span class="line-modified">3202             keyboard.doKeyPress(KeyCode.LEFT, KeyModifier.SHIFT); // col 2</span>
<span class="line-modified">3203             keyboard.doKeyPress(KeyCode.LEFT, KeyModifier.SHIFT); // col 1</span>
<span class="line-modified">3204             keyboard.doKeyPress(KeyCode.LEFT, KeyModifier.SHIFT); // col 0</span>
<span class="line-added">3205         } else if (orientation == NodeOrientation.RIGHT_TO_LEFT) {</span>
<span class="line-added">3206             keyboard.doKeyPress(KeyCode.RIGHT, KeyModifier.SHIFT); // col 1</span>
<span class="line-added">3207             keyboard.doKeyPress(KeyCode.RIGHT, KeyModifier.SHIFT); // col 2</span>
<span class="line-added">3208             keyboard.doKeyPress(KeyCode.RIGHT, KeyModifier.SHIFT); // col 3</span>
<span class="line-added">3209             keyboard.doKeyPress(KeyCode.RIGHT, KeyModifier.SHIFT); // col 4</span>
<span class="line-added">3210         }</span>
3211         keyboard.doKeyPress(KeyCode.UP, KeyModifier.SHIFT); // row 3
3212         assertEquals(0, getAnchor().getRow());
3213         assertEquals(0, getAnchor().getColumn());           // anchor does not move
3214         assertTrue(fm.isFocused(3, col0));
3215         assertTrue(sm.isSelected(0, col0));
3216         assertTrue(sm.isSelected(0, col1));
3217         assertTrue(sm.isSelected(0, col2));
3218         assertTrue(sm.isSelected(0, col3));
3219         assertTrue(sm.isSelected(0, col4));
3220         assertTrue(sm.isSelected(1, col4));
3221         assertTrue(sm.isSelected(2, col4));
3222         assertTrue(sm.isSelected(3, col4));
3223         assertTrue(sm.isSelected(4, col4));
3224         assertTrue(sm.isSelected(4, col3));
3225         assertTrue(sm.isSelected(4, col2));
3226         assertTrue(sm.isSelected(4, col1));
3227         assertTrue(sm.isSelected(4, col0));
3228         assertTrue(sm.isSelected(3, col0));
3229 
3230         // critical part - these cells should not be selected!
3231         assertFalse(sm.isSelected(1, col0));
3232         assertFalse(sm.isSelected(2, col0));
3233     }
3234 
3235     @Test public void test_rt18439_startAt_row0_col4_clockwise() {
3236         final int items = 10;
3237         tableView.getItems().clear();
3238         for (int i = 0; i &lt; items; i++) {
3239             tableView.getItems().add(&quot;Row &quot; + i);
3240         }
3241 
3242         sm.setCellSelectionEnabled(true);
3243         sm.setSelectionMode(SelectionMode.MULTIPLE);
3244 
3245         sm.clearAndSelect(0, col4);
3246 
3247         keyboard.doKeyPress(KeyCode.DOWN, KeyModifier.SHIFT); // row 1
3248         keyboard.doKeyPress(KeyCode.DOWN, KeyModifier.SHIFT); // row 2
3249         keyboard.doKeyPress(KeyCode.DOWN, KeyModifier.SHIFT); // row 3
3250         keyboard.doKeyPress(KeyCode.DOWN, KeyModifier.SHIFT); // row 4
3251 
<a name="47" id="anc47"></a><span class="line-modified">3252         if (orientation == NodeOrientation.LEFT_TO_RIGHT) {</span>
<span class="line-modified">3253             keyboard.doKeyPress(KeyCode.LEFT, KeyModifier.SHIFT); // col 3</span>
<span class="line-modified">3254             keyboard.doKeyPress(KeyCode.LEFT, KeyModifier.SHIFT); // col 2</span>
<span class="line-modified">3255             keyboard.doKeyPress(KeyCode.LEFT, KeyModifier.SHIFT); // col 1</span>
<span class="line-added">3256             keyboard.doKeyPress(KeyCode.LEFT, KeyModifier.SHIFT); // col 0</span>
<span class="line-added">3257         } else if (orientation == NodeOrientation.RIGHT_TO_LEFT) {</span>
<span class="line-added">3258             keyboard.doKeyPress(KeyCode.RIGHT, KeyModifier.SHIFT); // col 3</span>
<span class="line-added">3259             keyboard.doKeyPress(KeyCode.RIGHT, KeyModifier.SHIFT); // col 2</span>
<span class="line-added">3260             keyboard.doKeyPress(KeyCode.RIGHT, KeyModifier.SHIFT); // col 1</span>
<span class="line-added">3261             keyboard.doKeyPress(KeyCode.RIGHT, KeyModifier.SHIFT); // col 0</span>
<span class="line-added">3262         }</span>
3263 
3264         keyboard.doKeyPress(KeyCode.UP, KeyModifier.SHIFT);   // row 3
3265         keyboard.doKeyPress(KeyCode.UP, KeyModifier.SHIFT);   // row 2
3266         keyboard.doKeyPress(KeyCode.UP, KeyModifier.SHIFT);   // row 1
3267         keyboard.doKeyPress(KeyCode.UP, KeyModifier.SHIFT);   // row 0
3268 
<a name="48" id="anc48"></a><span class="line-modified">3269         if (orientation == NodeOrientation.LEFT_TO_RIGHT) {</span>
<span class="line-added">3270             keyboard.doKeyPress(KeyCode.RIGHT, KeyModifier.SHIFT); // col 1</span>
<span class="line-added">3271         } else if (orientation == NodeOrientation.RIGHT_TO_LEFT) {</span>
<span class="line-added">3272             keyboard.doKeyPress(KeyCode.LEFT, KeyModifier.SHIFT); // col 1</span>
<span class="line-added">3273         }</span>
3274         assertEquals(0, getAnchor().getRow());
3275         assertEquals(4, getAnchor().getColumn());           // anchor does not move
3276         assertTrue(fm.isFocused(0, col1));
3277         assertTrue(sm.isSelected(0, col4));
3278         assertTrue(sm.isSelected(1, col4));
3279         assertTrue(sm.isSelected(2, col4));
3280         assertTrue(sm.isSelected(3, col4));
3281         assertTrue(sm.isSelected(4, col4));
3282         assertTrue(sm.isSelected(4, col3));
3283         assertTrue(sm.isSelected(4, col2));
3284         assertTrue(sm.isSelected(4, col1));
3285         assertTrue(sm.isSelected(4, col0));
3286         assertTrue(sm.isSelected(3, col0));
3287         assertTrue(sm.isSelected(2, col0));
3288         assertTrue(sm.isSelected(1, col0));
3289         assertTrue(sm.isSelected(0, col0));
3290         assertTrue(sm.isSelected(0, col1));
3291 
3292         // critical part - these cells should not be selected!
3293         assertFalse(sm.isSelected(0, col2));
3294         assertFalse(sm.isSelected(0, col3));
3295     }
3296 
3297     @Test public void test_rt18439_startAt_row4_col4_clockwise() {
3298         final int items = 10;
3299         tableView.getItems().clear();
3300         for (int i = 0; i &lt; items; i++) {
3301             tableView.getItems().add(&quot;Row &quot; + i);
3302         }
3303 
3304         sm.setCellSelectionEnabled(true);
3305         sm.setSelectionMode(SelectionMode.MULTIPLE);
3306 
3307         sm.clearAndSelect(4, col4);
3308 
<a name="49" id="anc49"></a><span class="line-modified">3309         if (orientation == NodeOrientation.LEFT_TO_RIGHT) {</span>
<span class="line-modified">3310             keyboard.doKeyPress(KeyCode.LEFT, KeyModifier.SHIFT); // col 3</span>
<span class="line-modified">3311             keyboard.doKeyPress(KeyCode.LEFT, KeyModifier.SHIFT); // col 2</span>
<span class="line-modified">3312             keyboard.doKeyPress(KeyCode.LEFT, KeyModifier.SHIFT); // col 1</span>
<span class="line-added">3313             keyboard.doKeyPress(KeyCode.LEFT, KeyModifier.SHIFT); // col 0</span>
<span class="line-added">3314         } else if (orientation == NodeOrientation.RIGHT_TO_LEFT) {</span>
<span class="line-added">3315             keyboard.doKeyPress(KeyCode.RIGHT, KeyModifier.SHIFT); // col 3</span>
<span class="line-added">3316             keyboard.doKeyPress(KeyCode.RIGHT, KeyModifier.SHIFT); // col 2</span>
<span class="line-added">3317             keyboard.doKeyPress(KeyCode.RIGHT, KeyModifier.SHIFT); // col 1</span>
<span class="line-added">3318             keyboard.doKeyPress(KeyCode.RIGHT, KeyModifier.SHIFT); // col 0</span>
<span class="line-added">3319         }</span>
3320 
3321         keyboard.doKeyPress(KeyCode.UP, KeyModifier.SHIFT);   // row 3
3322         keyboard.doKeyPress(KeyCode.UP, KeyModifier.SHIFT);   // row 2
3323         keyboard.doKeyPress(KeyCode.UP, KeyModifier.SHIFT);   // row 1
3324         keyboard.doKeyPress(KeyCode.UP, KeyModifier.SHIFT);   // row 0
3325 
<a name="50" id="anc50"></a><span class="line-modified">3326         if (orientation == NodeOrientation.LEFT_TO_RIGHT) {</span>
<span class="line-modified">3327             keyboard.doKeyPress(KeyCode.RIGHT, KeyModifier.SHIFT); // col 1</span>
<span class="line-modified">3328             keyboard.doKeyPress(KeyCode.RIGHT, KeyModifier.SHIFT); // col 2</span>
<span class="line-modified">3329             keyboard.doKeyPress(KeyCode.RIGHT, KeyModifier.SHIFT); // col 3</span>
<span class="line-added">3330             keyboard.doKeyPress(KeyCode.RIGHT, KeyModifier.SHIFT); // col 4</span>
<span class="line-added">3331         } else if (orientation == NodeOrientation.RIGHT_TO_LEFT) {</span>
<span class="line-added">3332             keyboard.doKeyPress(KeyCode.LEFT, KeyModifier.SHIFT); // col 1</span>
<span class="line-added">3333             keyboard.doKeyPress(KeyCode.LEFT, KeyModifier.SHIFT); // col 2</span>
<span class="line-added">3334             keyboard.doKeyPress(KeyCode.LEFT, KeyModifier.SHIFT); // col 3</span>
<span class="line-added">3335             keyboard.doKeyPress(KeyCode.LEFT, KeyModifier.SHIFT); // col 4</span>
<span class="line-added">3336         }</span>
3337 
3338         keyboard.doKeyPress(KeyCode.DOWN, KeyModifier.SHIFT); // row 1
3339         assertEquals(4, getAnchor().getRow());
3340         assertEquals(4, getAnchor().getColumn());           // anchor does not move
3341         assertTrue(fm.isFocused(1, col4));
3342         assertTrue(sm.isSelected(4, col4));
3343         assertTrue(sm.isSelected(4, col2));
3344         assertTrue(sm.isSelected(4, col2));
3345         assertTrue(sm.isSelected(4, col1));
3346         assertTrue(sm.isSelected(4, col0));
3347         assertTrue(sm.isSelected(3, col0));
3348         assertTrue(sm.isSelected(2, col0));
3349         assertTrue(sm.isSelected(1, col0));
3350         assertTrue(sm.isSelected(0, col0));
3351         assertTrue(sm.isSelected(0, col1));
3352         assertTrue(sm.isSelected(0, col2));
3353         assertTrue(sm.isSelected(0, col3));
3354         assertTrue(sm.isSelected(0, col4));
3355         assertTrue(sm.isSelected(1, col4));
3356 
3357         // critical part - these cells should not be selected!
3358         assertFalse(sm.isSelected(2, col4));
3359         assertFalse(sm.isSelected(3, col4));
3360     }
3361 
3362     @Test public void test_rt18439_startAt_row4_col0_clockwise() {
3363         final int items = 10;
3364         tableView.getItems().clear();
3365         for (int i = 0; i &lt; items; i++) {
3366             tableView.getItems().add(&quot;Row &quot; + i);
3367         }
3368 
3369         sm.setCellSelectionEnabled(true);
3370         sm.setSelectionMode(SelectionMode.MULTIPLE);
3371 
3372         sm.clearAndSelect(4, col0);
3373 
3374         keyboard.doKeyPress(KeyCode.UP, KeyModifier.SHIFT); // row 3
3375         keyboard.doKeyPress(KeyCode.UP, KeyModifier.SHIFT); // row 2
3376         keyboard.doKeyPress(KeyCode.UP, KeyModifier.SHIFT); // row 1
3377         keyboard.doKeyPress(KeyCode.UP, KeyModifier.SHIFT); // row 0
3378 
<a name="51" id="anc51"></a><span class="line-modified">3379         if (orientation == NodeOrientation.LEFT_TO_RIGHT) {</span>
<span class="line-modified">3380             keyboard.doKeyPress(KeyCode.RIGHT, KeyModifier.SHIFT);   // col 1</span>
<span class="line-modified">3381             keyboard.doKeyPress(KeyCode.RIGHT, KeyModifier.SHIFT);   // col 2</span>
<span class="line-modified">3382             keyboard.doKeyPress(KeyCode.RIGHT, KeyModifier.SHIFT);   // col 3</span>
<span class="line-added">3383             keyboard.doKeyPress(KeyCode.RIGHT, KeyModifier.SHIFT);   // col 4</span>
<span class="line-added">3384         } if (orientation == NodeOrientation.RIGHT_TO_LEFT) {</span>
<span class="line-added">3385             keyboard.doKeyPress(KeyCode.LEFT, KeyModifier.SHIFT);   // col 1</span>
<span class="line-added">3386             keyboard.doKeyPress(KeyCode.LEFT, KeyModifier.SHIFT);   // col 2</span>
<span class="line-added">3387             keyboard.doKeyPress(KeyCode.LEFT, KeyModifier.SHIFT);   // col 3</span>
<span class="line-added">3388             keyboard.doKeyPress(KeyCode.LEFT, KeyModifier.SHIFT);   // col 4</span>
<span class="line-added">3389         }</span>
3390 
3391         keyboard.doKeyPress(KeyCode.DOWN, KeyModifier.SHIFT); // row 1
3392         keyboard.doKeyPress(KeyCode.DOWN, KeyModifier.SHIFT); // row 2
3393         keyboard.doKeyPress(KeyCode.DOWN, KeyModifier.SHIFT); // row 3
3394         keyboard.doKeyPress(KeyCode.DOWN, KeyModifier.SHIFT); // row 4
3395 
<a name="52" id="anc52"></a><span class="line-modified">3396         if (orientation == NodeOrientation.LEFT_TO_RIGHT) {</span>
<span class="line-added">3397             keyboard.doKeyPress(KeyCode.LEFT, KeyModifier.SHIFT); // col 3</span>
<span class="line-added">3398         } if (orientation == NodeOrientation.RIGHT_TO_LEFT) {</span>
<span class="line-added">3399             keyboard.doKeyPress(KeyCode.RIGHT, KeyModifier.SHIFT); // col 3</span>
<span class="line-added">3400         }</span>
3401         assertEquals(4, getAnchor().getRow());
3402         assertEquals(0, getAnchor().getColumn());           // anchor does not move
3403         assertTrue(fm.isFocused(4, col3));
3404         assertTrue(sm.isSelected(4, col0));
3405         assertTrue(sm.isSelected(3, col0));
3406         assertTrue(sm.isSelected(2, col0));
3407         assertTrue(sm.isSelected(1, col0));
3408         assertTrue(sm.isSelected(0, col0));
3409         assertTrue(sm.isSelected(0, col1));
3410         assertTrue(sm.isSelected(0, col2));
3411         assertTrue(sm.isSelected(0, col3));
3412         assertTrue(sm.isSelected(0, col4));
3413         assertTrue(sm.isSelected(1, col4));
3414         assertTrue(sm.isSelected(2, col4));
3415         assertTrue(sm.isSelected(3, col4));
3416         assertTrue(sm.isSelected(4, col4));
3417         assertTrue(sm.isSelected(4, col3));
3418 
3419         // critical part - these cells should not be selected!
3420         assertFalse(sm.isSelected(4, col2));
3421         assertFalse(sm.isSelected(4, col1));
3422     }
3423 
3424     @Test public void test_rt34461_cellSelection() {
3425         final int items = 10;
3426         tableView.getItems().clear();
3427         for (int i = 0; i &lt; items; i++) {
3428             tableView.getItems().add(&quot;Row &quot; + i);
3429         }
3430 
3431         sm.setCellSelectionEnabled(true);
3432         sm.setSelectionMode(SelectionMode.MULTIPLE);
3433 
3434         sm.clearAndSelect(0, col0);
3435         assertEquals(0, getAnchor().getRow());
3436         assertEquals(0, getAnchor().getColumn());
3437         assertTrue(fm.isFocused(0, col0));
3438         assertTrue(sm.isSelected(0, col0));
3439         assertFalse(sm.isSelected(1, col0));
3440 
3441         keyboard.doKeyPress(KeyCode.DOWN, KeyModifier.getShortcutKey());
3442         assertEquals(0, getAnchor().getRow());
3443         assertEquals(0, getAnchor().getColumn());
3444         assertTrue(fm.isFocused(1, col0));
3445         assertTrue(sm.isSelected(0, col0));
3446         assertFalse(sm.isSelected(1, col0));
3447 
3448         keyboard.doKeyPress(KeyCode.SPACE);
3449         assertEquals(1, getAnchor().getRow());      // new anchor point
3450         assertEquals(0, getAnchor().getColumn());
3451         assertTrue(fm.isFocused(1, col0));
3452         assertTrue(sm.isSelected(0, col0));
3453         assertTrue(sm.isSelected(1, col0));
3454 
3455         keyboard.doKeyPress(KeyCode.DOWN, KeyModifier.SHIFT);
3456         assertEquals(1, getAnchor().getRow());
3457         assertEquals(0, getAnchor().getColumn());
3458         assertTrue(fm.isFocused(2, col0));
3459         assertFalse(sm.isSelected(0, col0));    // selection moves off here as the anchor point moved with the space
3460         assertTrue(sm.isSelected(1, col0));
3461         assertTrue(sm.isSelected(2, col0));
3462     }
3463 
3464     @Test public void test_rt34461_rowSelection() {
3465         final int items = 10;
3466         tableView.getItems().clear();
3467         for (int i = 0; i &lt; items; i++) {
3468             tableView.getItems().add(&quot;Row &quot; + i);
3469         }
3470 
3471         sm.setCellSelectionEnabled(false);
3472         sm.setSelectionMode(SelectionMode.MULTIPLE);
3473 
3474         sm.clearAndSelect(0);
3475         assertEquals(0, getAnchor().getRow());
3476         assertEquals(-1, getAnchor().getColumn());
3477         assertTrue(fm.isFocused(0));
3478         assertTrue(sm.isSelected(0));
3479         assertFalse(sm.isSelected(1));
3480 
3481         keyboard.doKeyPress(KeyCode.DOWN, KeyModifier.getShortcutKey());
3482         assertEquals(0, getAnchor().getRow());
3483         assertEquals(-1, getAnchor().getColumn());
3484         assertTrue(fm.isFocused(1));
3485         assertTrue(sm.isSelected(0));
3486         assertFalse(sm.isSelected(1));
3487 
3488         keyboard.doKeyPress(KeyCode.SPACE);
3489         assertEquals(1, getAnchor().getRow());      // new anchor point
3490         assertEquals(-1, getAnchor().getColumn());
3491         assertTrue(fm.isFocused(1));
3492         assertTrue(sm.isSelected(0));
3493         assertTrue(sm.isSelected(1));
3494 
3495         keyboard.doKeyPress(KeyCode.DOWN, KeyModifier.SHIFT);
3496         assertEquals(1, getAnchor().getRow());
3497         assertEquals(-1, getAnchor().getColumn());
3498         assertTrue(fm.isFocused(2));
3499         assertFalse(sm.isSelected(0));    // selection moves off here as the anchor point moved with the space
3500         assertTrue(sm.isSelected(1));
3501         assertTrue(sm.isSelected(2));
3502     }
3503 
3504     @Test public void test_rt34407_down_down_up() {
3505         final int items = 100;
3506         tableView.getItems().clear();
3507         for (int i = 0; i &lt; items; i++) {
3508             tableView.getItems().add(&quot;Row &quot; + i);
3509         }
3510         tableView.setPrefHeight(130); // roughly room for four rows
3511 
3512         StageLoader sl = new StageLoader(tableView);
3513         sm.setCellSelectionEnabled(false);
3514         sm.setSelectionMode(SelectionMode.MULTIPLE);
3515 
3516         sm.clearAndSelect(0);
3517         fm.focus(0);
3518         assertEquals(0, getAnchor().getRow());
3519         assertEquals(-1, getAnchor().getColumn());
3520         assertTrue(fm.isFocused(0));
3521         assertTrue(sm.isSelected(0));
3522         assertFalse(sm.isSelected(1));
3523 
3524         // we expect the final Page-up to return us back to this selected index and with the same number of selected indices
3525         keyboard.doKeyPress(KeyCode.PAGE_DOWN, KeyModifier.SHIFT);
3526         final int leadSelectedIndex = sm.getSelectedIndex();
3527         final int selectedIndicesCount = sm.getSelectedIndices().size();
3528         assertEquals(3, leadSelectedIndex);
3529         assertEquals(3, fm.getFocusedIndex());
3530         assertEquals(4, selectedIndicesCount);
3531 
3532         keyboard.doKeyPress(KeyCode.PAGE_DOWN, KeyModifier.SHIFT);
3533         assertEquals(leadSelectedIndex * 2, sm.getSelectedIndex());
3534         assertEquals(leadSelectedIndex * 2, fm.getFocusedIndex());
3535         assertEquals(selectedIndicesCount * 2 - 1, sm.getSelectedIndices().size());
3536 
3537         keyboard.doKeyPress(KeyCode.PAGE_UP, KeyModifier.SHIFT);
3538         assertEquals(leadSelectedIndex, sm.getSelectedIndex());
3539         assertEquals(leadSelectedIndex, fm.getFocusedIndex());
3540         assertEquals(selectedIndicesCount, sm.getSelectedIndices().size());
3541 
3542         sl.dispose();
3543     }
3544 
3545     @Test public void test_rt34407_up_up_down() {
3546         final int items = 100;
3547         tableView.getItems().clear();
3548         for (int i = 0; i &lt; items; i++) {
3549             tableView.getItems().add(&quot;Row &quot; + i);
3550         }
3551         tableView.setPrefHeight(130); // roughly room for four rows
3552 
3553         StageLoader sl = new StageLoader(tableView);
3554         sm.setCellSelectionEnabled(false);
3555         sm.setSelectionMode(SelectionMode.MULTIPLE);
3556 
3557         sm.clearAndSelect(99);
3558         fm.focus(99);
3559         tableView.scrollTo(99);
3560         Toolkit.getToolkit().firePulse();
3561 
3562         assertEquals(99, getAnchor().getRow());
3563         assertEquals(-1, getAnchor().getColumn());
3564         assertTrue(fm.isFocused(99));
3565         assertTrue(sm.isSelected(99));
3566         assertFalse(sm.isSelected(98));
3567 
3568         // we expect the final Page-down to return us back to this selected index and with the same number of selected indices
3569         keyboard.doKeyPress(KeyCode.PAGE_UP, KeyModifier.SHIFT);
3570         final int leadSelectedIndex = sm.getSelectedIndex();
3571         final int selectedIndicesCount = sm.getSelectedIndices().size();
3572         final int diff = 99 - leadSelectedIndex;
3573         assertEquals(99 - diff, leadSelectedIndex);
3574         assertEquals(99 - diff, fm.getFocusedIndex());
3575         assertEquals(4, selectedIndicesCount);
3576 
3577         keyboard.doKeyPress(KeyCode.PAGE_UP, KeyModifier.SHIFT);
3578         assertEquals(99 - diff * 2, sm.getSelectedIndex());
3579         assertEquals(selectedIndicesCount * 2 - 1, sm.getSelectedIndices().size());
3580 
3581         keyboard.doKeyPress(KeyCode.PAGE_DOWN, KeyModifier.SHIFT);
3582         assertEquals(leadSelectedIndex, sm.getSelectedIndex());
3583         assertEquals(selectedIndicesCount, sm.getSelectedIndices().size());
3584 
3585         sl.dispose();
3586     }
3587 
3588     @Test public void test_rt34768() {
3589         tableView.getSelectionModel().setSelectionMode(SelectionMode.MULTIPLE);
3590         TableColumn&lt;String, String&gt; firstNameCol = new TableColumn&lt;&gt;(&quot;First Name&quot;);
3591         tableView.getColumns().setAll(firstNameCol);
3592         tableView.getItems().clear();
3593 
3594         // no need for an assert here - we&#39;re testing for an AIOOBE
3595         keyboard.doKeyPress(KeyCode.A, KeyModifier.getShortcutKey());
3596     }
3597 
3598     @Test public void test_rt35853_multipleSelection_rowSelection_shiftDown() {
3599         final int items = 10;
3600         tableView.getItems().clear();
3601         for (int i = 0; i &lt; items; i++) {
3602             tableView.getItems().add(&quot;Row &quot; + i);
3603         }
3604 
3605         sm.setSelectionMode(SelectionMode.MULTIPLE);
3606 
3607         sm.clearAndSelect(5);
3608         assertEquals(5, getAnchor().getRow());
3609         assertTrue(fm.isFocused(5));
3610         assertTrue(sm.isSelected(5));
3611 
3612         sm.selectedIndexProperty().addListener(observable -&gt; {
3613             // we expect only one selected index change event, from 5 to 4
3614             assertEquals(4, sm.getSelectedIndex());
3615         });
3616 
3617         keyboard.doKeyPress(KeyCode.UP, KeyModifier.SHIFT);
3618         assertEquals(5, getAnchor().getRow());
3619         assertTrue(fm.isFocused(4));
3620         assertTrue(sm.isSelected(4));
3621         assertTrue(sm.isSelected(5));
3622     }
3623 
3624     @Test public void test_rt35853_multipleSelection_rowSelection_noShiftDown() {
3625         final int items = 10;
3626         tableView.getItems().clear();
3627         for (int i = 0; i &lt; items; i++) {
3628             tableView.getItems().add(&quot;Row &quot; + i);
3629         }
3630 
3631         sm.setSelectionMode(SelectionMode.MULTIPLE);
3632 
3633         sm.clearAndSelect(5);
3634         assertEquals(5, getAnchor().getRow());
3635         assertTrue(fm.isFocused(5));
3636         assertTrue(sm.isSelected(5));
3637 
3638         sm.selectedIndexProperty().addListener(observable -&gt; {
3639             // we expect only one selected index change event, from 5 to 4
3640             assertEquals(4, sm.getSelectedIndex());
3641         });
3642 
3643         keyboard.doKeyPress(KeyCode.UP);
3644         assertEquals(4, getAnchor().getRow());
3645         assertTrue(fm.isFocused(4));
3646         assertTrue(sm.isSelected(4));
3647         assertFalse(sm.isSelected(5));
3648     }
3649 
3650     @Test public void test_rt35853_singleSelection_rowSelection_shiftDown() {
3651         final int items = 10;
3652         tableView.getItems().clear();
3653         for (int i = 0; i &lt; items; i++) {
3654             tableView.getItems().add(&quot;Row &quot; + i);
3655         }
3656 
3657         sm.setSelectionMode(SelectionMode.SINGLE);
3658 
3659         sm.clearAndSelect(5);
3660         assertEquals(5, getAnchor().getRow());
3661         assertTrue(fm.isFocused(5));
3662         assertTrue(sm.isSelected(5));
3663 
3664         sm.selectedIndexProperty().addListener(observable -&gt; {
3665             // we expect only one selected index change event, from 5 to 4
3666             assertEquals(4, sm.getSelectedIndex());
3667         });
3668 
3669         keyboard.doKeyPress(KeyCode.UP, KeyModifier.SHIFT);
3670         assertEquals(4, getAnchor().getRow());
3671         assertTrue(fm.isFocused(4));
3672         assertTrue(sm.isSelected(4));
3673         assertFalse(sm.isSelected(5));
3674     }
3675 
3676     @Test public void test_rt35853_singleSelection_rowSelection_noShiftDown() {
3677         final int items = 10;
3678         tableView.getItems().clear();
3679         for (int i = 0; i &lt; items; i++) {
3680             tableView.getItems().add(&quot;Row &quot; + i);
3681         }
3682 
3683         sm.setSelectionMode(SelectionMode.SINGLE);
3684 
3685         sm.clearAndSelect(5);
3686         assertEquals(5, getAnchor().getRow());
3687         assertTrue(fm.isFocused(5));
3688         assertTrue(sm.isSelected(5));
3689 
3690         sm.selectedIndexProperty().addListener(observable -&gt; {
3691             // we expect only one selected index change event, from 5 to 4
3692             assertEquals(4, sm.getSelectedIndex());
3693         });
3694 
3695         keyboard.doKeyPress(KeyCode.UP);
3696         assertEquals(4, getAnchor().getRow());
3697         assertTrue(fm.isFocused(4));
3698         assertTrue(sm.isSelected(4));
3699         assertFalse(sm.isSelected(5));
3700     }
3701 
3702     @Test public void test_rt35853_multipleSelection_cellSelection_shiftDown() {
3703         final int items = 10;
3704         tableView.getItems().clear();
3705         for (int i = 0; i &lt; items; i++) {
3706             tableView.getItems().add(&quot;Row &quot; + i);
3707         }
3708 
3709         TableColumn&lt;String, String&gt; col = new TableColumn&lt;&gt;(&quot;Column&quot;);
3710         col.setCellValueFactory(param -&gt; new ReadOnlyStringWrapper(param.getValue()));
3711         tableView.getColumns().setAll(col);
3712 
3713         sm.setSelectionMode(SelectionMode.MULTIPLE);
3714         sm.setCellSelectionEnabled(true);
3715 
3716         sm.clearAndSelect(5, col);
3717         assertEquals(5, getAnchor().getRow());
3718         assertTrue(fm.isFocused(5, col));
3719         assertTrue(sm.isSelected(5, col));
3720 
3721         sm.selectedIndexProperty().addListener(observable -&gt; {
3722             // we expect only one selected index change event, from 5 to 4
3723             assertEquals(4, sm.getSelectedIndex());
3724         });
3725 
3726         keyboard.doKeyPress(KeyCode.UP, KeyModifier.SHIFT);
3727         assertEquals(5, getAnchor().getRow());
3728         assertTrue(fm.isFocused(4, col));
3729         assertTrue(sm.isSelected(4, col));
3730         assertTrue(sm.isSelected(5, col));
3731     }
3732 
3733     @Test public void test_rt35853_multipleSelection_cellSelection_noShiftDown() {
3734         final int items = 10;
3735         tableView.getItems().clear();
3736         for (int i = 0; i &lt; items; i++) {
3737             tableView.getItems().add(&quot;Row &quot; + i);
3738         }
3739 
3740         TableColumn&lt;String, String&gt; col = new TableColumn&lt;&gt;(&quot;Column&quot;);
3741         col.setCellValueFactory(param -&gt; new ReadOnlyStringWrapper(param.getValue()));
3742         tableView.getColumns().setAll(col);
3743 
3744         sm.setSelectionMode(SelectionMode.MULTIPLE);
3745         sm.setCellSelectionEnabled(true);
3746 
3747         sm.clearAndSelect(5, col);
3748         assertEquals(5, getAnchor().getRow());
3749         assertTrue(fm.isFocused(5, col));
3750         assertTrue(sm.isSelected(5, col));
3751 
3752         sm.selectedIndexProperty().addListener(observable -&gt; {
3753             // we expect only one selected index change event, from 5 to 4
3754             assertEquals(4, sm.getSelectedIndex());
3755         });
3756 
3757         keyboard.doKeyPress(KeyCode.UP);
3758         assertEquals(4, getAnchor().getRow());
3759         assertTrue(fm.isFocused(4, col));
3760         assertTrue(sm.isSelected(4, col));
3761         assertFalse(sm.isSelected(5, col));
3762     }
3763 
3764     @Test public void test_rt35853_singleSelection_cellSelection_shiftDown() {
3765         final int items = 10;
3766         tableView.getItems().clear();
3767         for (int i = 0; i &lt; items; i++) {
3768             tableView.getItems().add(&quot;Row &quot; + i);
3769         }
3770 
3771         TableColumn&lt;String, String&gt; col = new TableColumn&lt;&gt;(&quot;Column&quot;);
3772         col.setCellValueFactory(param -&gt; new ReadOnlyStringWrapper(param.getValue()));
3773         tableView.getColumns().setAll(col);
3774 
3775         sm.setSelectionMode(SelectionMode.SINGLE);
3776         sm.setCellSelectionEnabled(true);
3777 
3778         sm.clearAndSelect(5, col);
3779         assertEquals(5, getAnchor().getRow());
3780         assertTrue(fm.isFocused(5, col));
3781         assertTrue(sm.isSelected(5, col));
3782 
3783         sm.selectedIndexProperty().addListener(observable -&gt; {
3784             // we expect only one selected index change event, from 5 to 4
3785             assertEquals(4, sm.getSelectedIndex());
3786         });
3787 
3788         keyboard.doKeyPress(KeyCode.UP, KeyModifier.SHIFT);
3789         assertEquals(4, getAnchor().getRow());
3790         assertTrue(fm.isFocused(4, col));
3791         assertTrue(sm.isSelected(4, col));
3792         assertFalse(sm.isSelected(5, col));
3793     }
3794 
3795     @Test public void test_rt35853_singleSelection_cellSelection_noShiftDown() {
3796         final int items = 10;
3797         tableView.getItems().clear();
3798         for (int i = 0; i &lt; items; i++) {
3799             tableView.getItems().add(&quot;Row &quot; + i);
3800         }
3801 
3802         TableColumn&lt;String, String&gt; col = new TableColumn&lt;&gt;(&quot;Column&quot;);
3803         col.setCellValueFactory(param -&gt; new ReadOnlyStringWrapper(param.getValue()));
3804         tableView.getColumns().setAll(col);
3805 
3806         sm.setSelectionMode(SelectionMode.SINGLE);
3807         sm.setCellSelectionEnabled(true);
3808 
3809         sm.clearAndSelect(5, col);
3810         assertEquals(5, getAnchor().getRow());
3811         assertTrue(fm.isFocused(5, col));
3812         assertTrue(sm.isSelected(5, col));
3813 
3814         sm.selectedIndexProperty().addListener(observable -&gt; {
3815             // we expect only one selected index change event, from 5 to 4
3816             assertEquals(4, sm.getSelectedIndex());
3817         });
3818 
3819         keyboard.doKeyPress(KeyCode.UP);
3820         assertEquals(4, getAnchor().getRow());
3821         assertTrue(fm.isFocused(4, col));
3822         assertTrue(sm.isSelected(4, col));
3823         assertFalse(sm.isSelected(5, col));
3824     }
3825 
3826     @Test public void test_rt36800_rowSelection() {
3827         test_rt36800(false);
3828     }
3829 
3830     @Test public void test_rt36800_cellSelection() {
3831         test_rt36800(true);
3832     }
3833 
3834     private void test_rt36800(boolean cellSelection) {
3835         final int items = 10;
3836         tableView.getItems().clear();
3837         for (int i = 0; i &lt; items; i++) {
3838             tableView.getItems().add(&quot;Row &quot; + i);
3839         }
3840 
3841         TableColumn&lt;String, String&gt; col = new TableColumn&lt;&gt;(&quot;Column&quot;);
3842         col.setCellValueFactory(param -&gt; new ReadOnlyStringWrapper(param.getValue()));
3843         tableView.getColumns().setAll(col);
3844 
3845         sm.setSelectionMode(SelectionMode.SINGLE);
3846         sm.setCellSelectionEnabled(cellSelection);
3847 
3848         if (cellSelection) {
3849             sm.clearAndSelect(5, col);
3850             assertEquals(5, getAnchor().getRow());
3851             assertEquals(col, getAnchor().getTableColumn());
3852             assertTrue(fm.isFocused(5, col));
3853             assertTrue(sm.isSelected(5, col));
3854         } else {
3855             sm.clearAndSelect(5);
3856             assertEquals(5, getAnchor().getRow());
3857             assertTrue(fm.isFocused(5));
3858             assertTrue(sm.isSelected(5));
3859         }
3860 
3861         keyboard.doKeyPress(KeyCode.UP, KeyModifier.SHIFT); // 4
3862         keyboard.doKeyPress(KeyCode.UP, KeyModifier.SHIFT); // 3
3863         keyboard.doKeyPress(KeyCode.UP, KeyModifier.SHIFT); // 2
3864         keyboard.doKeyPress(KeyCode.UP, KeyModifier.SHIFT); // 1
3865         keyboard.doKeyPress(KeyCode.UP, KeyModifier.SHIFT); // 0
3866 
3867         ControlTestUtils.runWithExceptionHandler(() -&gt; {
3868             keyboard.doKeyPress(KeyCode.UP, KeyModifier.SHIFT); // bug time?
3869         });
3870 
3871         if (cellSelection) {
3872             assertEquals(0, getAnchor().getRow());
3873             assertEquals(col, getAnchor().getTableColumn());
3874             assertTrue(fm.isFocused(0, col));
3875             assertTrue(sm.isSelected(0, col));
3876             assertFalse(sm.isSelected(1, col));
3877             assertFalse(sm.isSelected(2, col));
3878             assertFalse(sm.isSelected(3, col));
3879             assertFalse(sm.isSelected(4, col));
3880             assertFalse(sm.isSelected(5, col));
3881         } else {
3882             assertEquals(0, getAnchor().getRow());
3883             assertTrue(fm.isFocused(0));
3884             assertTrue(sm.isSelected(0));
3885             assertFalse(sm.isSelected(1));
3886             assertFalse(sm.isSelected(2));
3887             assertFalse(sm.isSelected(3));
3888             assertFalse(sm.isSelected(4));
3889             assertFalse(sm.isSelected(5));
3890         }
3891     }
3892 
3893     @Test public void test_rt_36942() {
3894         final int items = 3;
3895         tableView.getItems().clear();
3896         for (int i = 0; i &lt; items; i++) {
3897             tableView.getItems().add(&quot;Row &quot; + i);
3898         }
3899 
3900         TableColumn&lt;String, String&gt; col = new TableColumn&lt;&gt;(&quot;Column&quot;);
3901         col.setCellValueFactory(param -&gt; new ReadOnlyStringWrapper(param.getValue()));
3902         tableView.getColumns().setAll(col);
3903 
3904         MultipleSelectionModel&lt;String&gt; sm = tableView.getSelectionModel();
3905         sm.setSelectionMode(SelectionMode.MULTIPLE);
3906         ObservableList&lt;String&gt; selectedItems = sm.getSelectedItems();
3907 
3908         TableView&lt;String&gt; selectedItemsTableView = new TableView&lt;&gt;(selectedItems);
3909         selectedItemsTableView.getColumns().setAll(col);
3910 
3911         HBox root = new HBox(5, tableView, selectedItemsTableView);
3912 
3913         StageLoader sl = new StageLoader(root);
3914 
3915         sm.select(0);
3916         keyboard.doKeyPress(KeyCode.DOWN, KeyModifier.SHIFT); // 0,1
3917         keyboard.doKeyPress(KeyCode.DOWN, KeyModifier.SHIFT); // 0,1,2
3918 
3919         ControlTestUtils.runWithExceptionHandler(() -&gt; {
3920             keyboard.doKeyPress(KeyCode.DOWN, KeyModifier.SHIFT); // 0,1,2,Exception?
3921         });
3922 
3923         sl.dispose();
3924     }
3925 
3926     @Test public void test_rt_37130_pageUpAtTop() {
3927         final int items = 100;
3928         tableView.getItems().clear();
3929         for (int i = 0; i &lt; items; i++) {
3930             tableView.getItems().add(&quot;Row &quot; + i);
3931         }
3932 
3933         TableColumn&lt;String, String&gt; col = new TableColumn&lt;&gt;(&quot;Column&quot;);
3934         col.setCellValueFactory(param -&gt; new ReadOnlyStringWrapper(param.getValue()));
3935         tableView.getColumns().setAll(col);
3936 
3937         TableSelectionModel&lt;String&gt; sm = tableView.getSelectionModel();
3938         sm.setSelectionMode(SelectionMode.MULTIPLE);
3939         sm.setCellSelectionEnabled(true);
3940 
3941         StageLoader sl = new StageLoader(tableView);
3942 
3943         sm.select(5, col);
3944         keyboard.doKeyPress(KeyCode.PAGE_UP, KeyModifier.SHIFT);
3945         keyboard.doKeyPress(KeyCode.PAGE_UP, KeyModifier.SHIFT);
3946 
3947         sl.dispose();
3948     }
3949 
3950     @Test public void test_rt_37130_pageUpAtBottom() {
3951         final int items = 100;
3952         tableView.getItems().clear();
3953         for (int i = 0; i &lt; items; i++) {
3954             tableView.getItems().add(&quot;Row &quot; + i);
3955         }
3956 
3957         TableColumn&lt;String, String&gt; col = new TableColumn&lt;&gt;(&quot;Column&quot;);
3958         col.setCellValueFactory(param -&gt; new ReadOnlyStringWrapper(param.getValue()));
3959         tableView.getColumns().setAll(col);
3960 
3961         TableSelectionModel&lt;String&gt; sm = tableView.getSelectionModel();
3962         sm.setSelectionMode(SelectionMode.MULTIPLE);
3963         sm.setCellSelectionEnabled(true);
3964 
3965         StageLoader sl = new StageLoader(tableView);
3966 
3967         sm.select(95, col);
3968         keyboard.doKeyPress(KeyCode.PAGE_UP, KeyModifier.SHIFT);
3969         keyboard.doKeyPress(KeyCode.PAGE_UP, KeyModifier.SHIFT);
3970 
3971         sl.dispose();
3972     }
3973 
3974     @Test public void test_rt_37130_pageDownAtTop() {
3975         final int items = 100;
3976         tableView.getItems().clear();
3977         for (int i = 0; i &lt; items; i++) {
3978             tableView.getItems().add(&quot;Row &quot; + i);
3979         }
3980 
3981         TableColumn&lt;String, String&gt; col = new TableColumn&lt;&gt;(&quot;Column&quot;);
3982         col.setCellValueFactory(param -&gt; new ReadOnlyStringWrapper(param.getValue()));
3983         tableView.getColumns().setAll(col);
3984 
3985         TableSelectionModel&lt;String&gt; sm = tableView.getSelectionModel();
3986         sm.setSelectionMode(SelectionMode.MULTIPLE);
3987         sm.setCellSelectionEnabled(true);
3988 
3989         StageLoader sl = new StageLoader(tableView);
3990 
3991         sm.select(5, col);
3992         keyboard.doKeyPress(KeyCode.PAGE_DOWN, KeyModifier.SHIFT);
3993         keyboard.doKeyPress(KeyCode.PAGE_DOWN, KeyModifier.SHIFT);
3994 
3995         sl.dispose();
3996     }
3997 
3998     @Test public void test_rt_37130_pageDownAtBottom() {
3999         final int items = 100;
4000         tableView.getItems().clear();
4001         for (int i = 0; i &lt; items; i++) {
4002             tableView.getItems().add(&quot;Row &quot; + i);
4003         }
4004 
4005         TableColumn&lt;String, String&gt; col = new TableColumn&lt;&gt;(&quot;Column&quot;);
4006         col.setCellValueFactory(param -&gt; new ReadOnlyStringWrapper(param.getValue()));
4007         tableView.getColumns().setAll(col);
4008 
4009         TableSelectionModel&lt;String&gt; sm = tableView.getSelectionModel();
4010         sm.setSelectionMode(SelectionMode.MULTIPLE);
4011         sm.setCellSelectionEnabled(true);
4012 
4013         StageLoader sl = new StageLoader(tableView);
4014 
4015         sm.select(95, col);
4016         keyboard.doKeyPress(KeyCode.PAGE_DOWN, KeyModifier.SHIFT);
4017         keyboard.doKeyPress(KeyCode.PAGE_DOWN, KeyModifier.SHIFT);
4018 
4019         sl.dispose();
4020     }
4021 
4022 //    @Test public void test_rt_38326() {
4023 //        int argCount = 5;
4024 //        int testCount = (int) Math.pow(2, argCount);
4025 //        for (int test = 0; test &lt; testCount; test++) {
4026 //            boolean moveUp                                      = (test &amp; 0b10000) == 0b10000;
4027 //            boolean singleSelection                             = (test &amp; 0b01000) == 0b01000;
4028 //            boolean cellSelection                               = (test &amp; 0b00100) == 0b00100;
4029 //            boolean replaceItemsList                            = (test &amp; 0b00010) == 0b00010;
4030 //            boolean updateItemsListBeforeSelectionModelChanges  = (test &amp; 0b00001) == 0b00001;
4031 //
4032 //            StringBuilder sb = new StringBuilder(&quot;@Test public void test_rt_38326_focusLostOnShortcutKeyNav_&quot;);
4033 //            sb.append(moveUp ? &quot;moveUp_&quot; : &quot;moveDown_&quot;);
4034 //            sb.append(singleSelection ? &quot;singleSelection_&quot; : &quot;multipleSelection_&quot;);
4035 //            sb.append(cellSelection ? &quot;cellSelection_&quot; : &quot;rowSelection_&quot;);
4036 //            sb.append(replaceItemsList ? &quot;replaceItemsList_&quot; : &quot;reuseItemsList_&quot;);
4037 //            sb.append(updateItemsListBeforeSelectionModelChanges ? &quot;updateItemsListBeforeSelectionModelChanges&quot; : &quot;updateItemsListAfterSelectionModelChanges&quot;);
4038 //            sb.append(&quot;() {\n    &quot;);
4039 //            sb.append(&quot;test_rt_38326(&quot;);
4040 //            sb.append(moveUp + &quot;, &quot;);
4041 //            sb.append(singleSelection + &quot;, &quot;);
4042 //            sb.append(cellSelection + &quot;, &quot;);
4043 //            sb.append(replaceItemsList + &quot;, &quot;);
4044 //            sb.append(updateItemsListBeforeSelectionModelChanges);
4045 //            sb.append(&quot;);\n}&quot;);
4046 //
4047 //            System.out.println(sb);
4048 //        }
4049 //    }
4050 
4051     // -- tests generated by above commented out code
4052     @Test public void test_rt_38326_focusLostOnShortcutKeyNav_moveDown_multipleSelection_rowSelection_reuseItemsList_updateItemsListAfterSelectionModelChanges() {
4053         test_rt_38326(false, false, false, false, false);
4054     }
4055     @Test public void test_rt_38326_focusLostOnShortcutKeyNav_moveDown_multipleSelection_rowSelection_reuseItemsList_updateItemsListBeforeSelectionModelChanges() {
4056         test_rt_38326(false, false, false, false, true);
4057     }
4058     @Test public void test_rt_38326_focusLostOnShortcutKeyNav_moveDown_multipleSelection_rowSelection_replaceItemsList_updateItemsListAfterSelectionModelChanges() {
4059         test_rt_38326(false, false, false, true, false);
4060     }
4061     @Test public void test_rt_38326_focusLostOnShortcutKeyNav_moveDown_multipleSelection_rowSelection_replaceItemsList_updateItemsListBeforeSelectionModelChanges() {
4062         test_rt_38326(false, false, false, true, true);
4063     }
4064     @Test public void test_rt_38326_focusLostOnShortcutKeyNav_moveDown_multipleSelection_cellSelection_reuseItemsList_updateItemsListAfterSelectionModelChanges() {
4065         test_rt_38326(false, false, true, false, false);
4066     }
4067     @Test public void test_rt_38326_focusLostOnShortcutKeyNav_moveDown_multipleSelection_cellSelection_reuseItemsList_updateItemsListBeforeSelectionModelChanges() {
4068         test_rt_38326(false, false, true, false, true);
4069     }
4070     @Test public void test_rt_38326_focusLostOnShortcutKeyNav_moveDown_multipleSelection_cellSelection_replaceItemsList_updateItemsListAfterSelectionModelChanges() {
4071         test_rt_38326(false, false, true, true, false);
4072     }
4073     @Test public void test_rt_38326_focusLostOnShortcutKeyNav_moveDown_multipleSelection_cellSelection_replaceItemsList_updateItemsListBeforeSelectionModelChanges() {
4074         test_rt_38326(false, false, true, true, true);
4075     }
4076     @Test public void test_rt_38326_focusLostOnShortcutKeyNav_moveDown_singleSelection_rowSelection_reuseItemsList_updateItemsListAfterSelectionModelChanges() {
4077         test_rt_38326(false, true, false, false, false);
4078     }
4079     @Test public void test_rt_38326_focusLostOnShortcutKeyNav_moveDown_singleSelection_rowSelection_reuseItemsList_updateItemsListBeforeSelectionModelChanges() {
4080         test_rt_38326(false, true, false, false, true);
4081     }
4082     @Test public void test_rt_38326_focusLostOnShortcutKeyNav_moveDown_singleSelection_rowSelection_replaceItemsList_updateItemsListAfterSelectionModelChanges() {
4083         test_rt_38326(false, true, false, true, false);
4084     }
4085     @Test public void test_rt_38326_focusLostOnShortcutKeyNav_moveDown_singleSelection_rowSelection_replaceItemsList_updateItemsListBeforeSelectionModelChanges() {
4086         test_rt_38326(false, true, false, true, true);
4087     }
4088     @Test public void test_rt_38326_focusLostOnShortcutKeyNav_moveDown_singleSelection_cellSelection_reuseItemsList_updateItemsListAfterSelectionModelChanges() {
4089         test_rt_38326(false, true, true, false, false);
4090     }
4091     @Test public void test_rt_38326_focusLostOnShortcutKeyNav_moveDown_singleSelection_cellSelection_reuseItemsList_updateItemsListBeforeSelectionModelChanges() {
4092         test_rt_38326(false, true, true, false, true);
4093     }
4094     @Test public void test_rt_38326_focusLostOnShortcutKeyNav_moveDown_singleSelection_cellSelection_replaceItemsList_updateItemsListAfterSelectionModelChanges() {
4095         test_rt_38326(false, true, true, true, false);
4096     }
4097     @Test public void test_rt_38326_focusLostOnShortcutKeyNav_moveDown_singleSelection_cellSelection_replaceItemsList_updateItemsListBeforeSelectionModelChanges() {
4098         test_rt_38326(false, true, true, true, true);
4099     }
4100     @Test public void test_rt_38326_focusLostOnShortcutKeyNav_moveUp_multipleSelection_rowSelection_reuseItemsList_updateItemsListAfterSelectionModelChanges() {
4101         test_rt_38326(true, false, false, false, false);
4102     }
4103     @Test public void test_rt_38326_focusLostOnShortcutKeyNav_moveUp_multipleSelection_rowSelection_reuseItemsList_updateItemsListBeforeSelectionModelChanges() {
4104         test_rt_38326(true, false, false, false, true);
4105     }
4106     @Test public void test_rt_38326_focusLostOnShortcutKeyNav_moveUp_multipleSelection_rowSelection_replaceItemsList_updateItemsListAfterSelectionModelChanges() {
4107         test_rt_38326(true, false, false, true, false);
4108     }
4109     @Test public void test_rt_38326_focusLostOnShortcutKeyNav_moveUp_multipleSelection_rowSelection_replaceItemsList_updateItemsListBeforeSelectionModelChanges() {
4110         test_rt_38326(true, false, false, true, true);
4111     }
4112     @Test public void test_rt_38326_focusLostOnShortcutKeyNav_moveUp_multipleSelection_cellSelection_reuseItemsList_updateItemsListAfterSelectionModelChanges() {
4113         test_rt_38326(true, false, true, false, false);
4114     }
4115     @Test public void test_rt_38326_focusLostOnShortcutKeyNav_moveUp_multipleSelection_cellSelection_reuseItemsList_updateItemsListBeforeSelectionModelChanges() {
4116         test_rt_38326(true, false, true, false, true);
4117     }
4118     @Test public void test_rt_38326_focusLostOnShortcutKeyNav_moveUp_multipleSelection_cellSelection_replaceItemsList_updateItemsListAfterSelectionModelChanges() {
4119         test_rt_38326(true, false, true, true, false);
4120     }
4121     @Test public void test_rt_38326_focusLostOnShortcutKeyNav_moveUp_multipleSelection_cellSelection_replaceItemsList_updateItemsListBeforeSelectionModelChanges() {
4122         test_rt_38326(true, false, true, true, true);
4123     }
4124     @Test public void test_rt_38326_focusLostOnShortcutKeyNav_moveUp_singleSelection_rowSelection_reuseItemsList_updateItemsListAfterSelectionModelChanges() {
4125         test_rt_38326(true, true, false, false, false);
4126     }
4127     @Test public void test_rt_38326_focusLostOnShortcutKeyNav_moveUp_singleSelection_rowSelection_reuseItemsList_updateItemsListBeforeSelectionModelChanges() {
4128         test_rt_38326(true, true, false, false, true);
4129     }
4130     @Test public void test_rt_38326_focusLostOnShortcutKeyNav_moveUp_singleSelection_rowSelection_replaceItemsList_updateItemsListAfterSelectionModelChanges() {
4131         test_rt_38326(true, true, false, true, false);
4132     }
4133     @Test public void test_rt_38326_focusLostOnShortcutKeyNav_moveUp_singleSelection_rowSelection_replaceItemsList_updateItemsListBeforeSelectionModelChanges() {
4134         test_rt_38326(true, true, false, true, true);
4135     }
4136     @Test public void test_rt_38326_focusLostOnShortcutKeyNav_moveUp_singleSelection_cellSelection_reuseItemsList_updateItemsListAfterSelectionModelChanges() {
4137         test_rt_38326(true, true, true, false, false);
4138     }
4139     @Test public void test_rt_38326_focusLostOnShortcutKeyNav_moveUp_singleSelection_cellSelection_reuseItemsList_updateItemsListBeforeSelectionModelChanges() {
4140         test_rt_38326(true, true, true, false, true);
4141     }
4142     @Test public void test_rt_38326_focusLostOnShortcutKeyNav_moveUp_singleSelection_cellSelection_replaceItemsList_updateItemsListAfterSelectionModelChanges() {
4143         test_rt_38326(true, true, true, true, false);
4144     }
4145     @Test public void test_rt_38326_focusLostOnShortcutKeyNav_moveUp_singleSelection_cellSelection_replaceItemsList_updateItemsListBeforeSelectionModelChanges() {
4146         test_rt_38326(true, true, true, true, true);
4147     }
4148 
4149     private void test_rt_38326(boolean moveUp, boolean singleSelection, boolean cellSelection, boolean replaceItemsList, boolean updateItemsListBeforeSelectionModelChanges) {
4150         final int items = 10;
4151         ObservableList&lt;String&gt; itemsList = FXCollections.observableArrayList();
4152         for (int i = 0; i &lt; items; i++) {
4153             itemsList.add(&quot;Row &quot; + i);
4154         }
4155 
4156         if (updateItemsListBeforeSelectionModelChanges) {
4157             if (replaceItemsList) {
4158                 tableView.setItems(itemsList);
4159             } else {
4160                 tableView.getItems().clear();
4161                 tableView.getItems().addAll(itemsList);
4162             }
4163         }
4164 
4165         TableColumn&lt;String, String&gt; col = new TableColumn&lt;&gt;(&quot;Column&quot;);
4166         col.setCellValueFactory(param -&gt; new ReadOnlyStringWrapper(param.getValue()));
4167 
4168         TableColumn&lt;String, String&gt; col2 = new TableColumn&lt;&gt;(&quot;Column 2&quot;);
4169         col2.setCellValueFactory(param -&gt; new ReadOnlyStringWrapper(param.getValue()));
4170 
4171         tableView.getColumns().setAll(col, col2);
4172 
4173         TableView.TableViewSelectionModel&lt;String&gt; sm = tableView.getSelectionModel();
4174         sm.setSelectionMode(singleSelection ? SelectionMode.SINGLE : SelectionMode.MULTIPLE);
4175         sm.setCellSelectionEnabled(cellSelection);
4176 
4177         if (! updateItemsListBeforeSelectionModelChanges) {
4178             if (replaceItemsList) {
4179                 tableView.setItems(itemsList);
4180             } else {
4181                 tableView.getItems().clear();
4182                 tableView.getItems().addAll(itemsList);
4183             }
4184         }
4185 
4186         StageLoader sl = new StageLoader(tableView);
4187 
4188         // test the initial state to ensure it is as we expect
4189         assertFalse(sm.isSelected(0));
4190         assertFalse(sm.isSelected(0, col));
4191         assertFalse(sm.isSelected(0, col2));
4192         assertEquals(0, sm.getSelectedIndices().size());
4193         assertEquals(0, sm.getSelectedItems().size());
4194         assertEquals(0, sm.getSelectedCells().size());
4195 
4196         final int startRow = 5;
4197         sm.clearSelection();
4198         sm.select(startRow, col);
4199         assertEquals(1, sm.getSelectedCells().size());
4200         assertEquals(startRow, sm.getSelectedCells().get(0).getRow());
4201         assertEquals(col, sm.getSelectedCells().get(0).getTableColumn());
4202         assertEquals(startRow, tableView.getFocusModel().getFocusedCell().getRow());
4203         assertEquals(col, tableView.getFocusModel().getFocusedCell().getTableColumn());
4204 
4205         keyboard.doKeyPress(moveUp ? KeyCode.UP : KeyCode.DOWN, KeyModifier.getShortcutKey());
4206         assertEquals(moveUp ? startRow-1 : startRow+1, tableView.getFocusModel().getFocusedCell().getRow());
4207         assertEquals(col, tableView.getFocusModel().getFocusedCell().getTableColumn());
4208 
4209         sl.dispose();
4210     }
4211 
4212     private int rt_39088_indices_event_count = 0;
4213     private int rt_39088_items_event_count = 0;
4214     @Test public void test_rt_39088() {
4215         ObservableList&lt;String&gt; itemsList = FXCollections.observableArrayList();
4216         for (int i = 0; i &lt; 4; i++) {
4217             itemsList.add(&quot;Row &quot; + i);
4218         }
4219 
4220         tableView.setItems(itemsList);
4221 
4222         TableColumn&lt;String, String&gt; col = new TableColumn&lt;&gt;(&quot;Column&quot;);
4223         col.setCellValueFactory(param -&gt; new ReadOnlyStringWrapper(param.getValue()));
4224 
4225         tableView.getColumns().setAll(col);
4226 
4227         TableView.TableViewSelectionModel&lt;String&gt; sm = tableView.getSelectionModel();
4228         sm.setSelectionMode(SelectionMode.MULTIPLE);
4229         sm.setCellSelectionEnabled(false);
4230 
4231         ObservableList&lt;Integer&gt; indices = sm.getSelectedIndices();
4232         ObservableList&lt;String&gt; items = sm.getSelectedItems();
4233 
4234         indices.addListener((ListChangeListener&lt;Integer&gt;) change -&gt; rt_39088_indices_event_count++);
4235         items.addListener((ListChangeListener&lt;String&gt;) change -&gt; rt_39088_items_event_count++);
4236 
4237         StageLoader sl = new StageLoader(tableView);
4238 
4239         assertEquals(0, rt_39088_indices_event_count);
4240         assertEquals(0, rt_39088_items_event_count);
4241         assertEquals(0, indices.size());
4242         assertEquals(0, items.size());
4243 
4244         sm.select(3);
4245         assertEquals(1, rt_39088_indices_event_count);
4246         assertEquals(1, rt_39088_items_event_count);
4247         assertEquals(1, indices.size());
4248         assertEquals(1, items.size());
4249 
4250         keyboard.doKeyPress(KeyCode.UP, KeyModifier.SHIFT);
4251         assertEquals(2, rt_39088_indices_event_count);
4252         assertEquals(2, rt_39088_items_event_count);
4253         assertEquals(2, indices.size());
4254         assertEquals(2, items.size());
4255 
4256         // this is where the test fails...
4257         keyboard.doKeyPress(KeyCode.UP, KeyModifier.SHIFT);
4258         assertEquals(3, rt_39088_indices_event_count);
4259         assertEquals(3, rt_39088_items_event_count);
4260         assertEquals(3, indices.size());
4261         assertEquals(3, items.size());
4262 
4263         sl.dispose();
4264     }
4265 
4266     @Test public void test_rt_27709_singleSelection_cellSelection() {
4267         test_rt_27709(SelectionMode.SINGLE, true, false);
4268     }
4269 
4270     @Test public void test_rt_27709_multipleSelection_cellSelection() {
4271         test_rt_27709(SelectionMode.MULTIPLE, true, false);
4272     }
4273 
4274     @Test public void test_rt_27709_singleSelection_rowSelection() {
4275         test_rt_27709(SelectionMode.SINGLE, false, false);
4276     }
4277 
4278     @Test public void test_rt_27709_multipleSelection_rowSelection() {
4279         test_rt_27709(SelectionMode.MULTIPLE, false, false);
4280     }
4281 
4282     @Test public void test_rt_27709_singleSelection_cellSelection_resetSelection() {
4283         test_rt_27709(SelectionMode.SINGLE, true, true);
4284     }
4285 
4286     @Test public void test_rt_27709_multipleSelection_cellSelection_resetSelection() {
4287         test_rt_27709(SelectionMode.MULTIPLE, true, true);
4288     }
4289 
4290     @Test public void test_rt_27709_singleSelection_rowSelection_resetSelection() {
4291         test_rt_27709(SelectionMode.SINGLE, false, true);
4292     }
4293 
4294     @Test public void test_rt_27709_multipleSelection_rowSelection_resetSelection() {
4295         test_rt_27709(SelectionMode.MULTIPLE, false, true);
4296     }
4297 
4298     private void test_rt_27709(SelectionMode mode, boolean cellSelectionMode, boolean resetSelection) {
4299         ObservableList&lt;String&gt; itemsList = FXCollections.observableArrayList();
4300         for (int i = 0; i &lt; 10; i++) {
4301             itemsList.add(&quot;Row &quot; + i);
4302         }
4303 
4304         tableView.setItems(itemsList);
4305 
4306         TableColumn&lt;String, String&gt; col = new TableColumn&lt;&gt;(&quot;Column&quot;);
4307         col.setCellValueFactory(param -&gt; new ReadOnlyStringWrapper(param.getValue()));
4308 
4309         tableView.getColumns().setAll(col);
4310 
4311         TableView.TableViewSelectionModel&lt;String&gt; sm = tableView.getSelectionModel();
4312         sm.setSelectionMode(mode);
4313         sm.setCellSelectionEnabled(cellSelectionMode);
4314 
4315         ObservableList&lt;Integer&gt; indices = sm.getSelectedIndices();
4316         ObservableList&lt;TablePosition&gt; cells = sm.getSelectedCells();
4317 
4318         StageLoader sl = new StageLoader(tableView);
4319 
4320         int expectedSize = mode == SelectionMode.SINGLE ? 1 : 10;
4321         int lookupIndex = mode == SelectionMode.SINGLE ? 0 : 9;
4322 
4323         sm.select(0, col);
4324         assertEquals(1, indices.size());
4325         assertEquals(1, cells.size());
4326 
4327         keyboard.doKeyPress(KeyCode.END, KeyModifier.SHIFT);
4328         assertEquals(expectedSize, indices.size());
4329         assertEquals(expectedSize, cells.size());
4330         assertEquals(9, (int) indices.get(lookupIndex));
4331         assertEquals(9, cells.get(lookupIndex).getRow());
4332 
4333         if (resetSelection) {
4334             sm.clearAndSelect(9, col);
4335             TablePosition&lt;?,?&gt; anchor = TableCellBehavior.getAnchor(tableView, null);
4336             assertEquals(9, anchor.getRow());
4337             assertEquals(col, anchor.getTableColumn());
4338         } else {
4339             expectedSize = 1;
4340         }
4341 
4342         keyboard.doKeyPress(KeyCode.HOME, KeyModifier.SHIFT);
4343         assertEquals(expectedSize, indices.size());
4344         assertEquals(expectedSize, cells.size());
4345         assertTrue(sm.isSelected(0, col));
4346 
4347         if (resetSelection) {
4348             sm.clearAndSelect(0, col);
4349 
4350             TablePosition&lt;?,?&gt; anchor = TableCellBehavior.getAnchor(tableView, null);
4351             assertEquals(0, anchor.getRow());
4352             assertEquals(col, anchor.getTableColumn());
4353         } else {
4354             expectedSize = mode == SelectionMode.SINGLE ? 1 : 10;
4355         }
4356 
4357         keyboard.doKeyPress(KeyCode.END, KeyModifier.SHIFT);
4358         assertEquals(expectedSize, indices.size());
4359         assertEquals(expectedSize, cells.size());
4360         assertTrue(sm.isSelected(9, col));
4361 
4362         sl.dispose();
4363     }
4364 
4365     @Test public void test_rt_18440_goLeft() {
<a name="53" id="anc53"></a><span class="line-modified">4366         if (orientation == NodeOrientation.LEFT_TO_RIGHT) {</span>
<span class="line-modified">4367             test_rt_18440(KeyCode.LEFT, 3, false, colIndex -&gt; {</span>
<span class="line-modified">4368                 keyboard.doLeftArrowPress(KeyModifier.getShortcutKey());</span>
<span class="line-modified">4369                 return colIndex - 1;</span>
<span class="line-added">4370             });</span>
<span class="line-added">4371         } else if (orientation == NodeOrientation.RIGHT_TO_LEFT) {</span>
<span class="line-added">4372             test_rt_18440(KeyCode.LEFT, 0, false, colIndex -&gt; {</span>
<span class="line-added">4373                 keyboard.doLeftArrowPress(KeyModifier.getShortcutKey());</span>
<span class="line-added">4374                 return colIndex + 1;</span>
<span class="line-added">4375             });</span>
<span class="line-added">4376         }</span>
4377     }
4378 
4379     @Test public void test_rt_18440_goLeft_toEnd() {
<a name="54" id="anc54"></a><span class="line-modified">4380         if (orientation == NodeOrientation.LEFT_TO_RIGHT) {</span>
<span class="line-modified">4381             test_rt_18440(KeyCode.LEFT, 3, true, colIndex -&gt; {</span>
<span class="line-modified">4382                 keyboard.doLeftArrowPress(KeyModifier.getShortcutKey());</span>
<span class="line-modified">4383                 return colIndex - 1;</span>
<span class="line-added">4384             });</span>
<span class="line-added">4385         } else if (orientation == NodeOrientation.RIGHT_TO_LEFT) {</span>
<span class="line-added">4386             test_rt_18440(KeyCode.LEFT, 0, true, colIndex -&gt; {</span>
<span class="line-added">4387                 keyboard.doLeftArrowPress(KeyModifier.getShortcutKey());</span>
<span class="line-added">4388                 return colIndex + 1;</span>
<span class="line-added">4389             });</span>
<span class="line-added">4390         }</span>
4391     }
4392 
4393     @Test public void test_rt_18440_goRight() {
<a name="55" id="anc55"></a><span class="line-modified">4394         if (orientation == NodeOrientation.LEFT_TO_RIGHT) {</span>
<span class="line-modified">4395             test_rt_18440(KeyCode.RIGHT, 0, false, colIndex -&gt; {</span>
<span class="line-modified">4396                 keyboard.doRightArrowPress(KeyModifier.getShortcutKey());</span>
<span class="line-modified">4397                 return colIndex + 1;</span>
<span class="line-added">4398             });</span>
<span class="line-added">4399         } else if (orientation == NodeOrientation.RIGHT_TO_LEFT) {</span>
<span class="line-added">4400             test_rt_18440(KeyCode.RIGHT, 3, false, colIndex -&gt; {</span>
<span class="line-added">4401                 keyboard.doRightArrowPress(KeyModifier.getShortcutKey());</span>
<span class="line-added">4402                 return colIndex - 1;</span>
<span class="line-added">4403             });</span>
<span class="line-added">4404         }</span>
4405     }
4406 
4407     @Test public void test_rt_18440_goRight_toEnd() {
<a name="56" id="anc56"></a><span class="line-modified">4408         if (orientation == NodeOrientation.LEFT_TO_RIGHT) {</span>
<span class="line-modified">4409             test_rt_18440(KeyCode.RIGHT, 0, true, colIndex -&gt; {</span>
<span class="line-modified">4410                 keyboard.doRightArrowPress(KeyModifier.getShortcutKey());</span>
<span class="line-modified">4411                 return colIndex + 1;</span>
<span class="line-added">4412             });</span>
<span class="line-added">4413         } else if (orientation == NodeOrientation.RIGHT_TO_LEFT) {</span>
<span class="line-added">4414             test_rt_18440(KeyCode.RIGHT, 3, true, colIndex -&gt; {</span>
<span class="line-added">4415                 keyboard.doRightArrowPress(KeyModifier.getShortcutKey());</span>
<span class="line-added">4416                 return colIndex - 1;</span>
<span class="line-added">4417             });</span>
<span class="line-added">4418         }</span>
4419     }
4420 
4421     private void test_rt_18440(KeyCode direction, int startColumn, boolean goToEnd, Function&lt;Integer, Integer&gt; r) {
4422         ObservableList&lt;String&gt; itemsList = FXCollections.observableArrayList();
4423         for (int i = 0; i &lt; 10; i++) {
4424             itemsList.add(&quot;Row &quot; + i);
4425         }
4426 
4427         tableView.setItems(itemsList);
4428 
4429         tableView.getColumns().clear();
4430         for (int i = 0; i &lt; 4; i++) {
4431             TableColumn&lt;String, String&gt; col = new TableColumn&lt;&gt;(&quot;Column &quot; + i);
4432             col.setCellValueFactory(param -&gt; new ReadOnlyStringWrapper(param.getValue()));
4433             tableView.getColumns().add(col);
4434         }
4435 
4436         TableView.TableViewFocusModel fm = tableView.getFocusModel();
4437         TableView.TableViewSelectionModel&lt;String&gt; sm = tableView.getSelectionModel();
4438         sm.setSelectionMode(SelectionMode.MULTIPLE);
4439         sm.setCellSelectionEnabled(true);
4440 
4441         ObservableList&lt;Integer&gt; indices = sm.getSelectedIndices();
4442         ObservableList&lt;String&gt; items = sm.getSelectedItems();
4443 
4444         StageLoader sl = new StageLoader(tableView);
4445 
4446         assertEquals(0, indices.size());
4447         assertEquals(0, items.size());
4448 
4449         sm.select(0, tableView.getColumns().get(startColumn));
4450         assertEquals(0, sm.getSelectedIndex());
4451         assertEquals(tableView.getColumns().get(startColumn), sm.getSelectedCells().get(0).getTableColumn());
4452         assertEquals(0, fm.getFocusedIndex());
4453         assertEquals(tableView.getColumns().get(startColumn), fm.getFocusedCell().getTableColumn());
4454 
4455         int expectedColumn = r.apply(startColumn);
4456         assertEquals(0, sm.getSelectedIndex());
4457         assertEquals(tableView.getColumns().get(startColumn), sm.getSelectedCells().get(0).getTableColumn());
4458         assertEquals(0, fm.getFocusedIndex());
4459         assertEquals(tableView.getColumns().get(expectedColumn), fm.getFocusedCell().getTableColumn());
4460 
4461         expectedColumn = r.apply(expectedColumn);
4462         assertEquals(0, sm.getSelectedIndex());
4463         assertEquals(tableView.getColumns().get(startColumn), sm.getSelectedCells().get(0).getTableColumn());
4464         assertEquals(0, fm.getFocusedIndex());
4465         assertEquals(tableView.getColumns().get(expectedColumn), fm.getFocusedCell().getTableColumn());
4466 
4467         if (goToEnd) {
4468             expectedColumn = r.apply(expectedColumn);
4469             assertEquals(0, sm.getSelectedIndex());
4470             assertEquals(tableView.getColumns().get(startColumn), sm.getSelectedCells().get(0).getTableColumn());
4471             assertEquals(0, fm.getFocusedIndex());
4472             assertEquals(tableView.getColumns().get(expectedColumn), fm.getFocusedCell().getTableColumn());
4473         }
4474 
<a name="57" id="anc57"></a><span class="line-modified">4475         if (orientation == NodeOrientation.LEFT_TO_RIGHT) {</span>
<span class="line-modified">4476             expectedColumn = direction == KeyCode.RIGHT ? 3 : 0;</span>
<span class="line-modified">4477             keyboard.doKeyPress(direction, KeyModifier.SHIFT);</span>
<span class="line-modified">4478             assertEquals(0, sm.getSelectedIndex());</span>
<span class="line-modified">4479             assertEquals(debug(), 4, sm.getSelectedCells().size());</span>
<span class="line-modified">4480             assertEquals(0, fm.getFocusedIndex());</span>
<span class="line-modified">4481             assertEquals(tableView.getColumns().get(expectedColumn), fm.getFocusedCell().getTableColumn());</span>
<span class="line-added">4482         } else if (orientation == NodeOrientation.RIGHT_TO_LEFT) {</span>
<span class="line-added">4483             expectedColumn = direction == KeyCode.LEFT ? 3 : 0;</span>
<span class="line-added">4484             keyboard.doKeyPress(direction, KeyModifier.SHIFT);</span>
<span class="line-added">4485             assertEquals(0, sm.getSelectedIndex());</span>
<span class="line-added">4486             assertEquals(debug(), 4, sm.getSelectedCells().size());</span>
<span class="line-added">4487             assertEquals(0, fm.getFocusedIndex());</span>
<span class="line-added">4488             assertEquals(tableView.getColumns().get(expectedColumn), fm.getFocusedCell().getTableColumn());</span>
<span class="line-added">4489         }</span>
4490         sl.dispose();
4491     }
4492 
4493     @Test public void test_rt_24865_moveDownwards() {
4494         tableView.getItems().clear();
4495         for (int i = 0; i &lt; 100; i++) {
4496             tableView.getItems().add(&quot;Row &quot; + i);
4497         }
4498 
4499         Toolkit.getToolkit().firePulse();
4500 
4501         ObservableList&lt;Integer&gt; indices = sm.getSelectedIndices();
4502 
4503         sm.select(0);
4504         assertTrue(isSelected(0));
4505         assertTrue(fm.isFocused(0));
4506         assertEquals(1, indices.size());
4507         assertEquals(0, ((TablePosition)TableCellBehavior.getAnchor(tableView, null)).getRow());
4508 
4509         keyboard.doDownArrowPress(KeyModifier.SHIFT);
4510         keyboard.doDownArrowPress(KeyModifier.SHIFT);
4511         keyboard.doDownArrowPress(KeyModifier.SHIFT);
4512         assertTrue(isSelected(0, 1, 2, 3));
4513         assertTrue(fm.isFocused(3));
4514         assertEquals(4, indices.size());
4515         assertEquals(0, ((TablePosition)TableCellBehavior.getAnchor(tableView, null)).getRow());
4516 
4517         keyboard.doDownArrowPress(KeyModifier.getShortcutKey());
4518         keyboard.doDownArrowPress(KeyModifier.getShortcutKey());
4519         keyboard.doDownArrowPress(KeyModifier.getShortcutKey());
4520         assertTrue(isSelected(0, 1, 2, 3));
4521         assertTrue(isNotSelected(4, 5, 6, 7, 8, 9));
4522         assertTrue(fm.isFocused(6));
4523         assertEquals(4, indices.size());
4524         assertEquals(0, ((TablePosition)TableCellBehavior.getAnchor(tableView, null)).getRow());
4525 
4526         // main point of test: selection between the last index (3) and the focus
4527         // index (6) should now be true
4528         keyboard.doKeyPress(KeyCode.PAGE_DOWN, KeyModifier.getShortcutKey(), KeyModifier.SHIFT);
4529         final int selectedRowCount = indices.size();
4530         for (int i = 0; i &lt; selectedRowCount; i++) {
4531             assertTrue(isSelected(i));
4532         }
4533         assertTrue(fm.isFocused(selectedRowCount - 1));
4534         assertEquals(0, ((TablePosition)TableCellBehavior.getAnchor(tableView, null)).getRow());
4535 
4536         keyboard.doDownArrowPress(KeyModifier.SHIFT);
4537         int newSelectedRowCount = selectedRowCount + 1;
4538         for (int i = 0; i &lt; newSelectedRowCount; i++) {
4539             assertTrue(isSelected(i));
4540         }
4541         assertTrue(fm.isFocused(newSelectedRowCount - 1));
4542         assertEquals(0, ((TablePosition)TableCellBehavior.getAnchor(tableView, null)).getRow());
4543     }
4544 
4545     @Test public void test_rt_24865_moveUpwards() {
4546         tableView.getItems().clear();
4547         for (int i = 0; i &lt; 100; i++) {
4548             tableView.getItems().add(&quot;Row &quot; + i);
4549         }
4550 
4551         Toolkit.getToolkit().firePulse();
4552 
4553         ObservableList&lt;Integer&gt; indices = sm.getSelectedIndices();
4554 
4555         sm.select(50);
4556         tableView.scrollTo(50);
4557 
4558         Toolkit.getToolkit().firePulse();
4559 
4560         assertTrue(isSelected(50));
4561         assertTrue(fm.isFocused(50));
4562         assertEquals(1, indices.size());
4563         assertEquals(50, ((TablePosition)TableCellBehavior.getAnchor(tableView, null)).getRow());
4564 
4565         keyboard.doUpArrowPress(KeyModifier.SHIFT);
4566         keyboard.doUpArrowPress(KeyModifier.SHIFT);
4567         keyboard.doUpArrowPress(KeyModifier.SHIFT);
4568         assertTrue(isSelected(50, 49, 48, 47));
4569         assertTrue(fm.isFocused(47));
4570         assertEquals(4, indices.size());
4571         assertEquals(50, ((TablePosition)TableCellBehavior.getAnchor(tableView, null)).getRow());
4572 
4573         keyboard.doUpArrowPress(KeyModifier.getShortcutKey());
4574         keyboard.doUpArrowPress(KeyModifier.getShortcutKey());
4575         keyboard.doUpArrowPress(KeyModifier.getShortcutKey());
4576         assertTrue(isSelected(50, 49, 48, 47));
4577         assertTrue(isNotSelected(46, 45, 44, 43, 42, 41));
4578         assertTrue(fm.isFocused(44));
4579         assertEquals(4, indices.size());
4580         assertEquals(50, ((TablePosition)TableCellBehavior.getAnchor(tableView, null)).getRow());
4581 
4582         // main point of test: selection between the last index (47) and the focus
4583         // index (44) should now be true
4584         keyboard.doKeyPress(KeyCode.PAGE_UP, KeyModifier.getShortcutKey(), KeyModifier.SHIFT);
4585         final int selectedRowCount = indices.size();
4586         for (int i = 0; i &lt; selectedRowCount; i++) {
4587             assertTrue(isSelected(50 - i));
4588         }
4589         assertTrue(fm.isFocused(50 - selectedRowCount + 1));
4590         assertEquals(50, ((TablePosition)TableCellBehavior.getAnchor(tableView, null)).getRow());
4591 
4592         keyboard.doUpArrowPress(KeyModifier.SHIFT);
4593         int newSelectedRowCount = selectedRowCount + 1;
4594         for (int i = 0; i &lt; newSelectedRowCount; i++) {
4595             assertTrue(isSelected(50 - i));
4596         }
4597         assertTrue(fm.isFocused(50 - newSelectedRowCount + 1));
4598         assertEquals(50, ((TablePosition)TableCellBehavior.getAnchor(tableView, null)).getRow());
4599     }
4600 
4601     @Test public void test_rt_39792_goLeft_goPastEnd() {
<a name="58" id="anc58"></a><span class="line-modified">4602 </span>
<span class="line-modified">4603         if (orientation == NodeOrientation.LEFT_TO_RIGHT) {</span>
<span class="line-modified">4604             test_rt_39792(3, colIndex -&gt; {</span>
<span class="line-modified">4605                 keyboard.doLeftArrowPress(KeyModifier.SHIFT);</span>
<span class="line-added">4606                 return colIndex - 1;</span>
<span class="line-added">4607             });</span>
<span class="line-added">4608         } else if (orientation == NodeOrientation.RIGHT_TO_LEFT) {</span>
<span class="line-added">4609             test_rt_39792(0, colIndex -&gt; {</span>
<span class="line-added">4610                 keyboard.doLeftArrowPress(KeyModifier.SHIFT);</span>
<span class="line-added">4611                 return colIndex + 1;</span>
<span class="line-added">4612             });</span>
<span class="line-added">4613         }</span>
4614     }
4615 
4616     @Test public void test_rt_39792_goRight_goPastEnd() {
<a name="59" id="anc59"></a><span class="line-modified">4617 </span>
<span class="line-modified">4618         if (orientation == NodeOrientation.LEFT_TO_RIGHT) {</span>
<span class="line-modified">4619             test_rt_39792(0, colIndex -&gt; {</span>
<span class="line-modified">4620                 keyboard.doRightArrowPress(KeyModifier.SHIFT);</span>
<span class="line-added">4621                 return colIndex + 1;</span>
<span class="line-added">4622             });</span>
<span class="line-added">4623         } else if (orientation == NodeOrientation.RIGHT_TO_LEFT) {</span>
<span class="line-added">4624             test_rt_39792(3, colIndex -&gt; {</span>
<span class="line-added">4625                 keyboard.doRightArrowPress(KeyModifier.SHIFT);</span>
<span class="line-added">4626                 return colIndex - 1;</span>
<span class="line-added">4627             });</span>
<span class="line-added">4628         }</span>
4629     }
4630 
4631     private void test_rt_39792(int startColumn, Function&lt;Integer, Integer&gt; r) {
4632         ObservableList&lt;String&gt; itemsList = FXCollections.observableArrayList();
4633         for (int i = 0; i &lt; 10; i++) {
4634             itemsList.add(&quot;Row &quot; + i);
4635         }
4636 
4637         tableView.setItems(itemsList);
4638 
4639         tableView.getColumns().clear();
4640         for (int i = 0; i &lt; 4; i++) {
4641             TableColumn&lt;String, String&gt; col = new TableColumn&lt;&gt;(&quot;Column &quot; + i);
4642             col.setCellValueFactory(param -&gt; new ReadOnlyStringWrapper(param.getValue()));
4643             tableView.getColumns().add(col);
4644         }
4645 
4646         TableView.TableViewSelectionModel&lt;String&gt; sm = tableView.getSelectionModel();
4647         sm.setSelectionMode(SelectionMode.MULTIPLE);
4648         sm.setCellSelectionEnabled(true);
4649 
4650         ObservableList&lt;Integer&gt; indices = sm.getSelectedIndices();
4651         ObservableList&lt;String&gt; items = sm.getSelectedItems();
4652 
4653         StageLoader sl = new StageLoader(tableView);
4654 
4655         assertEquals(0, indices.size());
4656         assertEquals(0, items.size());
4657 
4658         sm.select(0, tableView.getColumns().get(startColumn));
4659         assertEquals(1, sm.getSelectedCells().size());
4660 
4661         int expectedColumn = r.apply(startColumn);
4662         assertEquals(2, sm.getSelectedCells().size());
4663 
4664         expectedColumn = r.apply(expectedColumn);
4665         assertEquals(3, sm.getSelectedCells().size());
4666 
4667         expectedColumn = r.apply(expectedColumn);
4668         assertEquals(4, sm.getSelectedCells().size());
4669 
4670         // this should not cause any issue, but it does - as noted in RT-39792
4671         /*expectedColumn = */r.apply(expectedColumn);
4672         assertEquals(4, sm.getSelectedCells().size());
4673 
4674         sl.dispose();
4675     }
4676 
4677     @Test public void test_jdk_8160858() {
4678         // create a button to move focus over to
4679         Button btn = new Button(&quot;Button&quot;);
4680         ((Group)tableView.getScene().getRoot()).getChildren().add(btn);
4681 
4682         tableView.requestFocus();
4683         Toolkit.getToolkit().firePulse();
4684         assertEquals(stageLoader.getStage().getScene().getFocusOwner(), tableView);
4685 
4686         // we expect initially that selection is on -1, and focus is on 0
4687         assertEquals(-1, sm.getSelectedIndex());
4688         assertEquals(0, fm.getFocusedIndex());
4689 
4690         keyboard.doDownArrowPress();
4691         assertEquals(1, sm.getSelectedIndex());
4692         assertEquals(1, fm.getFocusedIndex());
4693 
4694         btn.requestFocus();
4695         Toolkit.getToolkit().firePulse();
4696         assertEquals(stageLoader.getStage().getScene().getFocusOwner(), btn);
4697 
4698         sm.setCellSelectionEnabled(true);
4699 
4700         tableView.requestFocus();
4701         Toolkit.getToolkit().firePulse();
4702         assertEquals(stageLoader.getStage().getScene().getFocusOwner(), tableView);
4703 
4704         assertEquals(1, sm.getSelectedIndex());
4705         assertEquals(1, fm.getFocusedIndex());
4706     }
4707 
4708     @Test public void test_jdk_8222214() {
4709         tableView.getFocusModel().focus(0);
4710         keyboard.doUpArrowPress();
4711 
4712         assertEquals(0, tableView.getSelectionModel().getSelectedIndex());
4713     }
4714 }
<a name="60" id="anc60"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="60" type="hidden" />
</body>
</html>