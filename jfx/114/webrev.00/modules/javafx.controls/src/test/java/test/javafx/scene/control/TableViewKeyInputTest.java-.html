<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Old modules/javafx.controls/src/test/java/test/javafx/scene/control/TableViewKeyInputTest.java</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
  <body>
    <pre>
   1 /*
   2  * Copyright (c) 2011, 2019, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.  Oracle designates this
   8  * particular file as subject to the &quot;Classpath&quot; exception as provided
   9  * by Oracle in the LICENSE file that accompanied this code.
  10  *
  11  * This code is distributed in the hope that it will be useful, but WITHOUT
  12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  14  * version 2 for more details (a copy is included in the LICENSE file that
  15  * accompanied this code).
  16  *
  17  * You should have received a copy of the GNU General Public License version
  18  * 2 along with this work; if not, write to the Free Software Foundation,
  19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  20  *
  21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  22  * or visit www.oracle.com if you need additional information or have any
  23  * questions.
  24  */
  25 
  26 package test.javafx.scene.control;
  27 
  28 import com.sun.javafx.scene.control.behavior.TableCellBehavior;
  29 import javafx.beans.property.ReadOnlyStringWrapper;
  30 import javafx.collections.FXCollections;
  31 import javafx.collections.ListChangeListener;
  32 import javafx.collections.ObservableList;
  33 import javafx.scene.Group;
  34 import javafx.scene.control.Button;
  35 import javafx.scene.input.KeyCode;
  36 import javafx.scene.layout.HBox;
  37 
  38 import java.util.List;
  39 import java.util.function.Function;
  40 
  41 import com.sun.javafx.PlatformUtil;
  42 import com.sun.javafx.util.Utils;
  43 import test.com.sun.javafx.scene.control.behavior.TableViewAnchorRetriever;
  44 import test.com.sun.javafx.scene.control.infrastructure.ControlTestUtils;
  45 import test.com.sun.javafx.scene.control.infrastructure.KeyEventFirer;
  46 import test.com.sun.javafx.scene.control.infrastructure.KeyModifier;
  47 import test.com.sun.javafx.scene.control.infrastructure.StageLoader;
  48 import test.com.sun.javafx.scene.control.infrastructure.VirtualFlowTestUtils;
  49 import com.sun.javafx.tk.Toolkit;
  50 import javafx.scene.control.FocusModel;
  51 import javafx.scene.control.MultipleSelectionModel;
  52 import javafx.scene.control.SelectionMode;
  53 import javafx.scene.control.TableCell;
  54 import javafx.scene.control.TableCellShim;
  55 import javafx.scene.control.TableColumn;
  56 import javafx.scene.control.TableFocusModel;
  57 import javafx.scene.control.TablePosition;
  58 import javafx.scene.control.TableSelectionModel;
  59 import javafx.scene.control.TableView;
  60 import org.junit.After;
  61 import org.junit.Before;
  62 import org.junit.Ignore;
  63 import org.junit.Test;
  64 import static org.junit.Assert.assertEquals;
  65 import static org.junit.Assert.assertFalse;
  66 import static org.junit.Assert.assertNotSame;
  67 import static org.junit.Assert.assertNull;
  68 import static org.junit.Assert.assertTrue;
  69 import static org.junit.Assert.fail;
  70 
  71 public class TableViewKeyInputTest {
  72     private TableView&lt;String&gt; tableView;
  73 //    private TableSelectionModel&lt;String&gt; sm;
  74     private TableView.TableViewSelectionModel&lt;String&gt; sm;
  75     private TableView.TableViewFocusModel&lt;String&gt; fm;
  76 
  77     private KeyEventFirer keyboard;
  78 
  79     private StageLoader stageLoader;
  80 
  81     private TableColumn&lt;String, String&gt; col0;
  82     private TableColumn&lt;String, String&gt; col1;
  83     private TableColumn&lt;String, String&gt; col2;
  84     private TableColumn&lt;String, String&gt; col3;
  85     private TableColumn&lt;String, String&gt; col4;
  86 
  87     @Before public void setup() {
  88         tableView = new TableView&lt;String&gt;();
  89         sm = tableView.getSelectionModel();
  90         fm = tableView.getFocusModel();
  91 
  92         sm.setSelectionMode(SelectionMode.MULTIPLE);
  93         sm.setCellSelectionEnabled(false);
  94 
  95         tableView.getItems().setAll(&quot;1&quot;, &quot;2&quot;, &quot;3&quot;, &quot;4&quot;, &quot;5&quot;, &quot;6&quot;, &quot;7&quot;, &quot;8&quot;, &quot;9&quot;, &quot;10&quot;, &quot;11&quot;, &quot;12&quot;);
  96 
  97         col0 = new TableColumn&lt;String, String&gt;(&quot;col0&quot;);
  98         col1 = new TableColumn&lt;String, String&gt;(&quot;col1&quot;);
  99         col2 = new TableColumn&lt;String, String&gt;(&quot;col2&quot;);
 100         col3 = new TableColumn&lt;String, String&gt;(&quot;col3&quot;);
 101         col4 = new TableColumn&lt;String, String&gt;(&quot;col4&quot;);
 102         tableView.getColumns().setAll(col0, col1, col2, col3, col4);
 103 
 104         keyboard = new KeyEventFirer(tableView);
 105 
 106         stageLoader = new StageLoader(tableView);
 107         stageLoader.getStage().show();
 108     }
 109 
 110     @After public void tearDown() {
 111         tableView.getSkin().dispose();
 112         stageLoader.dispose();
 113     }
 114 
 115     /***************************************************************************
 116      * Util methods
 117      **************************************************************************/
 118 
 119     private String debug() {
 120         StringBuilder sb = new StringBuilder(&quot;Selected Cells: [&quot;);
 121 
 122         List&lt;TablePosition&gt; cells = sm.getSelectedCells();
 123         for (TablePosition&lt;String,?&gt; tp : cells) {
 124             sb.append(&quot;(&quot;);
 125             sb.append(tp.getRow());
 126             sb.append(&quot;,&quot;);
 127             sb.append(tp.getColumn());
 128             sb.append(&quot;), &quot;);
 129         }
 130 
 131         sb.append(&quot;] \nFocus: (&quot; + fm.getFocusedCell().getRow() + &quot;, &quot; + fm.getFocusedCell().getColumn() + &quot;)&quot;);
 132         sb.append(&quot; \nAnchor: (&quot; + getAnchor().getRow() + &quot;, &quot; + getAnchor().getColumn() + &quot;)&quot;);
 133         return sb.toString();
 134     }
 135 
 136     // Returns true if ALL indices are selected
 137     private boolean isSelected(int... indices) {
 138         for (int index : indices) {
 139             if (! sm.isSelected(index)) {
 140                 System.out.println(&quot;Index &quot; + index + &quot; is not selected, but it is expected to be&quot;);
 141                 return false;
 142             }
 143         }
 144         return true;
 145     }
 146 
 147     // Returns true if ALL indices are NOT selected
 148     private boolean isNotSelected(int... indices) {
 149         for (int index : indices) {
 150             if (sm.isSelected(index)) {
 151                 System.out.println(&quot;Index &quot; + index + &quot; is selected, but it is not expected to be&quot;);
 152                 return false;
 153             }
 154         }
 155         return true;
 156     }
 157 
 158     private TablePosition getAnchor() {
 159         return TableViewAnchorRetriever.getAnchor(tableView);
 160     }
 161 
 162     private boolean isAnchor(int row) {
 163         TablePosition tp = new TablePosition(tableView, row, null);
 164         return getAnchor() != null &amp;&amp; getAnchor().equals(tp);
 165     }
 166 
 167     private boolean isAnchor(int row, int col) {
 168         TablePosition tp = new TablePosition(tableView, row, tableView.getColumns().get(col));
 169         return getAnchor() != null &amp;&amp; getAnchor().equals(tp);
 170     }
 171 
 172     /***************************************************************************
 173      * General tests
 174      **************************************************************************/
 175 
 176     @Test public void testInitialState() {
 177         assertEquals(0,sm.getSelectedCells().size());
 178         assertEquals(0,sm.getSelectedIndices().size());
 179         assertEquals(0,sm.getSelectedItems().size());
 180     }
 181 
 182 
 183     /***************************************************************************
 184      * Tests for row-based single selection
 185      **************************************************************************/
 186 
 187     @Test public void testDownArrowChangesSelection() {
 188         sm.clearAndSelect(0);
 189         keyboard.doDownArrowPress();
 190         assertFalse(sm.isSelected(0));
 191         assertTrue(sm.isSelected(1));
 192     }
 193 
 194     @Test public void testDownArrowDoesNotChangeSelectionWhenAtLastIndex() {
 195         int endIndex = tableView.getItems().size() - 1;
 196         sm.clearAndSelect(endIndex);
 197         assertTrue(sm.isSelected(endIndex));
 198         keyboard.doDownArrowPress();
 199         assertTrue(sm.isSelected(endIndex));
 200     }
 201 
 202     @Test public void testUpArrowDoesNotChangeSelectionWhenAt0Index() {
 203         sm.clearAndSelect(0);
 204         keyboard.doUpArrowPress();
 205 
 206         assertTrue(sm.isSelected(0));
 207         assertEquals(1, sm.getSelectedIndices().size());
 208         assertEquals(1, sm.getSelectedItems().size());
 209     }
 210 
 211     @Test public void testUpArrowChangesSelection() {
 212         sm.clearAndSelect(1);
 213         keyboard.doUpArrowPress();
 214         assertFalse(sm.isSelected(1));
 215         assertTrue(sm.isSelected(0));
 216     }
 217 
 218     @Test public void testLeftArrowDoesNotChangeState() {
 219         keyboard.doLeftArrowPress();
 220         testInitialState();
 221     }
 222 
 223     @Test public void testRightArrowDoesNotChangeState() {
 224         keyboard.doRightArrowPress();
 225         testInitialState();
 226     }
 227 
 228     /* test 19
 229     @Test public void testCtrlDownMovesFocusButLeavesSelectionAlone() {
 230         assertTrue(fm.isFocused(0));
 231         keyboard.doDownArrowPress(KeyModifier.getShortcutKey());
 232         assertTrue(fm.isFocused(1));
 233         assertTrue(sm.isSelected(0));
 234         assertFalse(sm.isSelected(1));
 235     } */
 236 
 237     // test 20
 238     @Test public void testCtrlUpDoesNotMoveFocus() {
 239         sm.clearAndSelect(0);
 240         assertTrue(fm.isFocused(0));
 241         keyboard.doUpArrowPress(KeyModifier.getShortcutKey());
 242         assertTrue(fm.isFocused(0));
 243         assertTrue(sm.isSelected(0));
 244     }
 245 
 246     // test 21
 247     @Test public void testCtrlLeftDoesNotMoveFocus() {
 248         sm.clearAndSelect(0);
 249         assertTrue(fm.isFocused(0));
 250         keyboard.doLeftArrowPress(KeyModifier.getShortcutKey());
 251         assertTrue(fm.isFocused(0));
 252         assertTrue(sm.isSelected(0));
 253     }
 254 
 255     // test 22
 256     @Test public void testCtrlRightDoesNotMoveFocus() {
 257         sm.clearAndSelect(0);
 258         assertTrue(fm.isFocused(0));
 259         keyboard.doRightArrowPress(KeyModifier.getShortcutKey());
 260         assertTrue(fm.isFocused(0));
 261         assertTrue(sm.isSelected(0));
 262     }
 263 
 264     /* test 23
 265     @Test public void testCtrlUpMovesFocus() {
 266         sm.clearAndSelect(1);
 267         assertTrue(fm.isFocused(1));
 268         assertTrue(sm.isSelected(1));
 269         keyboard.doUpArrowPress(KeyModifier.getShortcutKey());
 270         assertTrue(fm.isFocused(0));
 271         assertTrue(sm.isSelected(1));
 272     } */
 273 
 274     // test 24
 275     @Test public void testCtrlDownDoesNotMoveFocusWhenAtLastIndex() {
 276         int endIndex = tableView.getItems().size() - 1;
 277         sm.clearAndSelect(endIndex);
 278         assertTrue(fm.isFocused(endIndex));
 279         assertTrue(sm.isSelected(endIndex));
 280         keyboard.doDownArrowPress(KeyModifier.getShortcutKey());
 281         assertTrue(fm.isFocused(endIndex));
 282         assertTrue(sm.isSelected(endIndex));
 283     }
 284 
 285     /* test 25
 286     @Test public void testCtrlDownArrowWithSpaceChangesAnchor() {
 287         sm.clearAndSelect(0);
 288         keyboard.doDownArrowPress(KeyModifier.getShortcutKey());    // move focus to 1
 289         keyboard.doDownArrowPress(KeyModifier.getShortcutKey());    // move focus to 2
 290         keyboard.doKeyPress(KeyCode.SPACE,
 291                 KeyModifier.getShortcutKey(),
 292                 (Utils.isMac()  ? KeyModifier.CTRL : null));  // select 2
 293         assertTrue(isSelected(0, 2));
 294         assertTrue(isNotSelected(1));
 295         assertTrue(isAnchor(2));
 296     } */
 297 
 298     /* test 26
 299     @Test public void testCtrlUpArrowWithSpaceChangesAnchor() {
 300         sm.clearAndSelect(2);
 301         keyboard.doUpArrowPress(KeyModifier.getShortcutKey());    // move focus to 1
 302         keyboard.doUpArrowPress(KeyModifier.getShortcutKey());    // move focus to 0
 303         keyboard.doKeyPress(KeyCode.SPACE,
 304                 KeyModifier.getShortcutKey(),
 305                 (Utils.isMac()  ? KeyModifier.CTRL : null));  // select 0
 306         assertTrue(isSelected(0, 2));
 307         assertTrue(isNotSelected(1));
 308         assertTrue(isAnchor(0));
 309     } */
 310 
 311     // test 44
 312     @Test public void testHomeKey() {
 313         sm.clearAndSelect(3);
 314         keyboard.doKeyPress(KeyCode.HOME);
 315         assertTrue(isSelected(0));
 316         assertTrue(isNotSelected(1,2,3));
 317     }
 318 
 319     // test 45
 320     @Test public void testEndKey() {
 321         sm.clearAndSelect(3);
 322         keyboard.doKeyPress(KeyCode.END);
 323         assertTrue(isSelected(tableView.getItems().size() - 1));
 324         assertTrue(isNotSelected(1,2,3));
 325     }
 326 
 327     /* test 53
 328     @Test public void testCtrlHome() {
 329         sm.clearAndSelect(5);
 330         keyboard.doKeyPress(KeyCode.HOME, KeyModifier.getShortcutKey());
 331         assertTrue(isSelected(5));
 332         assertTrue(fm.isFocused(0));
 333     } */
 334 
 335     /* test 54
 336     @Test public void testCtrlEnd() {
 337         sm.clearAndSelect(5);
 338         keyboard.doKeyPress(KeyCode.END, KeyModifier.getShortcutKey());
 339         assertTrue(isSelected(5));
 340         assertTrue(fm.isFocused(tableView.getItems().size() - 1));
 341     } */
 342 
 343     /* test 68
 344     @Test public void testCtrlSpaceToClearSelection() {
 345         sm.clearAndSelect(5);
 346         assertTrue(isSelected(5));
 347         assertTrue(fm.isFocused(5));
 348         keyboard.doKeyPress(KeyCode.SPACE,
 349                 KeyModifier.getShortcutKey(),
 350                 (Utils.isMac()  ? KeyModifier.CTRL : null));
 351         assertTrue(isNotSelected(5));
 352         assertTrue(debug(), fm.isFocused(5));
 353         assertTrue(isAnchor(5));
 354     } */
 355 
 356 
 357 
 358     /***************************************************************************
 359      * Tests for row-based multiple selection
 360      **************************************************************************/
 361 
 362     @Test public void testShiftDownArrowIncreasesSelection() {
 363         sm.clearAndSelect(0);
 364         keyboard.doDownArrowPress(KeyModifier.SHIFT);
 365         assertTrue(sm.isSelected(0));
 366         assertTrue(sm.isSelected(1));
 367     }
 368 
 369     @Test public void testShiftDownArrowDoesNotChangeSelectionWhenAtLastIndex() {
 370         int endIndex = tableView.getItems().size() - 1;
 371         sm.clearAndSelect(endIndex);
 372         assertTrue(sm.isSelected(endIndex));
 373         keyboard.doDownArrowPress(KeyModifier.SHIFT);
 374         assertTrue(sm.isSelected(endIndex));
 375     }
 376 
 377     @Test public void testShiftUpArrowIncreasesSelection() {
 378         sm.clearAndSelect(1);
 379         keyboard.doUpArrowPress(KeyModifier.SHIFT);
 380         assertTrue(sm.isSelected(0));
 381         assertTrue(sm.isSelected(1));
 382     }
 383 
 384     @Test public void testShiftUpArrowWhenAt0Index() {
 385         sm.clearAndSelect(0);
 386         keyboard.doUpArrowPress(KeyModifier.SHIFT);
 387         assertTrue(sm.isSelected(0));
 388     }
 389 
 390     @Test public void testShiftLeftArrowWhenAt0Index() {
 391         sm.clearAndSelect(0);
 392         keyboard.doLeftArrowPress(KeyModifier.SHIFT);
 393         assertTrue(sm.isSelected(0));
 394         assertFalse(sm.isSelected(1));
 395     }
 396 
 397     @Test public void testShiftRightArrowWhenAt0Index() {
 398         sm.clearAndSelect(0);
 399         keyboard.doRightArrowPress(KeyModifier.SHIFT);
 400         assertTrue(sm.isSelected(0));
 401         assertFalse(sm.isSelected(1));
 402     }
 403 
 404     @Test public void testShiftDownTwiceThenShiftUp() {
 405         sm.clearAndSelect(0);
 406         keyboard.doDownArrowPress(KeyModifier.SHIFT);
 407         keyboard.doDownArrowPress(KeyModifier.SHIFT);
 408         keyboard.doUpArrowPress(KeyModifier.SHIFT);
 409         assertTrue(debug(), sm.isSelected(0));
 410         assertTrue(sm.isSelected(1));
 411         assertFalse(sm.isSelected(2));
 412     }
 413 
 414     @Test public void testShiftUpTwiceThenShiftDownFrom0Index() {
 415         sm.clearAndSelect(0);
 416         keyboard.doUpArrowPress(KeyModifier.SHIFT);
 417         keyboard.doUpArrowPress(KeyModifier.SHIFT);
 418         keyboard.doDownArrowPress(KeyModifier.SHIFT);
 419         assertTrue(sm.isSelected(0));
 420         assertTrue(sm.isSelected(1));
 421         assertFalse(sm.isSelected(2));
 422     }
 423 
 424     @Test public void testShiftLeftTwiceThenShiftRight() {
 425         sm.clearAndSelect(0);
 426         keyboard.doLeftArrowPress(KeyModifier.SHIFT);
 427         keyboard.doLeftArrowPress(KeyModifier.SHIFT);
 428         keyboard.doRightArrowPress(KeyModifier.SHIFT);
 429         assertTrue(sm.isSelected(0));
 430         assertFalse(sm.isSelected(1));
 431         assertFalse(sm.isSelected(2));
 432     }
 433 
 434     @Test public void testShiftRightTwiceThenShiftLeft() {
 435         sm.clearAndSelect(0);
 436         keyboard.doRightArrowPress(KeyModifier.SHIFT);
 437         keyboard.doRightArrowPress(KeyModifier.SHIFT);
 438         keyboard.doLeftArrowPress(KeyModifier.SHIFT);
 439         assertTrue(sm.isSelected(0));
 440         assertFalse(sm.isSelected(1));
 441         assertFalse(sm.isSelected(2));
 442     }
 443 
 444     @Test public void testShiftUpTwiceThenShiftDown() {
 445         sm.clearAndSelect(2);                           // select 2
 446         keyboard.doUpArrowPress(KeyModifier.SHIFT);     // also select 1
 447         keyboard.doUpArrowPress(KeyModifier.SHIFT);     // also select 0
 448         keyboard.doDownArrowPress(KeyModifier.SHIFT);   // deselect 0
 449         assertFalse(debug(), sm.isSelected(0));
 450         assertTrue(sm.isSelected(1));
 451         assertTrue(sm.isSelected(2));
 452         assertFalse(sm.isSelected(3));
 453     }
 454 
 455     // test 18 from Jindra&#39;s testcases.rtf file
 456     @Test public void testShiftDownTwiceThenShiftUpWhenAtLastIndex() {
 457         int endIndex = tableView.getItems().size() - 1;
 458         sm.clearAndSelect(endIndex);
 459         keyboard.doDownArrowPress(KeyModifier.SHIFT);
 460         keyboard.doDownArrowPress(KeyModifier.SHIFT);
 461         keyboard.doUpArrowPress(KeyModifier.SHIFT);
 462         assertTrue(sm.isSelected(endIndex));
 463         assertTrue(sm.isSelected(endIndex - 1));
 464         assertFalse(sm.isSelected(endIndex - 2));
 465     }
 466 
 467     // test 27
 468     @Test public void testCtrlDownArrowWithSpaceChangesAnchor_extended() {
 469         sm.clearAndSelect(0);
 470         keyboard.doDownArrowPress(KeyModifier.getShortcutKey());    // move focus to 1
 471         keyboard.doDownArrowPress(KeyModifier.getShortcutKey());    // move focus to 2
 472         keyboard.doKeyPress(KeyCode.SPACE,
 473                 KeyModifier.getShortcutKey(),
 474                 (Utils.isMac()  ? KeyModifier.CTRL : null));  // select 2
 475 
 476         keyboard.doUpArrowPress(KeyModifier.getShortcutKey());    // move focus to 1
 477         keyboard.doUpArrowPress(KeyModifier.getShortcutKey());    // move focus to 0
 478         keyboard.doKeyPress(KeyCode.SPACE,
 479                 KeyModifier.getShortcutKey(),
 480                 (Utils.isMac()  ? KeyModifier.CTRL : null));  // deselect 0
 481         assertTrue(isSelected(2));
 482         assertTrue(isNotSelected(0, 1));
 483         assertTrue(isAnchor(0));
 484     }
 485 
 486     // test 28
 487     @Test public void testCtrlUpArrowWithSpaceChangesAnchor_extended() {
 488         sm.clearAndSelect(2);
 489         keyboard.doUpArrowPress(KeyModifier.getShortcutKey());    // move focus to 1
 490         keyboard.doUpArrowPress(KeyModifier.getShortcutKey());    // move focus to 0
 491         keyboard.doKeyPress(KeyCode.SPACE,
 492                 KeyModifier.getShortcutKey(),
 493                 (Utils.isMac()  ? KeyModifier.CTRL : null));  // select 0
 494 
 495         keyboard.doDownArrowPress(KeyModifier.getShortcutKey());    // move focus to 1
 496         keyboard.doDownArrowPress(KeyModifier.getShortcutKey());    // move focus to 2
 497         keyboard.doKeyPress(KeyCode.SPACE,
 498                 KeyModifier.getShortcutKey(),
 499                 (Utils.isMac()  ? KeyModifier.CTRL : null));  // deselect 2
 500         assertTrue(isSelected(0));
 501         assertTrue(isNotSelected(1, 2));
 502         assertTrue(isAnchor(2));
 503     }
 504 
 505     // test 29
 506     @Test public void testCtrlDownArrowWithSpaceChangesAnchor_extended2() {
 507         sm.clearAndSelect(0);
 508         keyboard.doDownArrowPress(KeyModifier.getShortcutKey());    // move focus to 1
 509         keyboard.doDownArrowPress(KeyModifier.getShortcutKey());    // move focus to 2
 510         keyboard.doKeyPress(KeyCode.SPACE,
 511                 KeyModifier.getShortcutKey(),
 512                 (Utils.isMac()  ? KeyModifier.CTRL : null));  // select 2
 513 
 514         keyboard.doDownArrowPress(KeyModifier.getShortcutKey());    // move focus to 3
 515         keyboard.doDownArrowPress(KeyModifier.getShortcutKey());    // move focus to 4
 516         keyboard.doKeyPress(KeyCode.SPACE,
 517                 KeyModifier.getShortcutKey(),
 518                 (Utils.isMac()  ? KeyModifier.CTRL : null));  // select 4
 519         assertTrue(isSelected(0, 2, 4));
 520         assertTrue(isNotSelected(1, 3, 5));
 521         assertTrue(isAnchor(4));
 522     }
 523 
 524     // test 30
 525     @Test public void testCtrlUpArrowWithSpaceChangesAnchor_extended2() {
 526         sm.clearAndSelect(4);
 527         keyboard.doUpArrowPress(KeyModifier.getShortcutKey());    // move focus to 3
 528         keyboard.doUpArrowPress(KeyModifier.getShortcutKey());    // move focus to 2
 529         keyboard.doKeyPress(KeyCode.SPACE,
 530                 KeyModifier.getShortcutKey(),
 531                 (Utils.isMac()  ? KeyModifier.CTRL : null));  // select 2
 532 
 533         keyboard.doUpArrowPress(KeyModifier.getShortcutKey());    // move focus to 1
 534         keyboard.doUpArrowPress(KeyModifier.getShortcutKey());    // move focus to 0
 535         keyboard.doKeyPress(KeyCode.SPACE,
 536                 KeyModifier.getShortcutKey(),
 537                 (Utils.isMac()  ? KeyModifier.CTRL : null));  // select 0
 538         assertTrue(isSelected(0, 2, 4));
 539         assertTrue(isNotSelected(1, 3));
 540         assertTrue(isAnchor(0));
 541     }
 542 
 543     // test 31
 544     @Test public void testCtrlDownArrowThenShiftSpaceToSelectRange() {
 545         sm.clearAndSelect(0);
 546         keyboard.doDownArrowPress(KeyModifier.getShortcutKey());    // move focus to 1
 547         keyboard.doDownArrowPress(KeyModifier.getShortcutKey());    // move focus to 2
 548         keyboard.doKeyPress(KeyCode.SPACE, KeyModifier.SHIFT);  // select 0,1,2
 549         assertTrue(isSelected(0, 1, 2));
 550         assertTrue(isNotSelected(3));
 551         assertTrue(isAnchor(0));
 552     }
 553 
 554     // test 32
 555     @Test public void testCtrlUpArrowThenShiftSpaceToSelectRange() {
 556         sm.clearAndSelect(2);
 557         keyboard.doUpArrowPress(KeyModifier.getShortcutKey());    // move focus to 1
 558         keyboard.doUpArrowPress(KeyModifier.getShortcutKey());    // move focus to 0
 559         keyboard.doKeyPress(KeyCode.SPACE, KeyModifier.SHIFT);  // select 0,1,2
 560         assertTrue(isSelected(0, 1, 2));
 561         assertTrue(isNotSelected(3));
 562         assertTrue(debug(), isAnchor(2));
 563     }
 564 
 565     // test 33
 566     @Test public void testCtrlDownArrowThenSpaceToChangeSelection() {
 567         sm.clearAndSelect(0);
 568         keyboard.doDownArrowPress(KeyModifier.getShortcutKey());    // move focus to 1
 569         keyboard.doDownArrowPress(KeyModifier.getShortcutKey());    // move focus to 2
 570         keyboard.doKeyPress(KeyCode.SPACE,
 571                 KeyModifier.getShortcutKey(),
 572                 (Utils.isMac()  ? KeyModifier.CTRL : null));  // select 2, keeping 0 selected
 573         assertTrue(isSelected(0, 2));
 574         assertTrue(isNotSelected(1, 3));
 575         assertTrue(isAnchor(2));
 576 
 577         keyboard.doDownArrowPress(KeyModifier.getShortcutKey());    // move focus to 3
 578         keyboard.doDownArrowPress(KeyModifier.getShortcutKey());    // move focus to 4
 579         keyboard.doKeyPress(KeyCode.SPACE, KeyModifier.SHIFT);  // select 2,3,4
 580         assertTrue(isSelected(2, 3, 4));
 581         assertTrue(isNotSelected(0, 1));
 582         assertTrue(isAnchor(2));
 583     }
 584 
 585     // test 34
 586     @Test public void testCtrlUpArrowThenSpaceToChangeSelection() {
 587         sm.clearAndSelect(4);
 588         keyboard.doUpArrowPress(KeyModifier.getShortcutKey());    // move focus to 3
 589         keyboard.doUpArrowPress(KeyModifier.getShortcutKey());    // move focus to 2
 590         keyboard.doKeyPress(KeyCode.SPACE,
 591                 KeyModifier.getShortcutKey(),
 592                 (Utils.isMac()  ? KeyModifier.CTRL : null));  // select 2, keeping 4 selected
 593         assertTrue(isSelected(2, 4));
 594         assertTrue(isNotSelected(0, 1, 3));
 595         assertTrue(isAnchor(2));
 596 
 597         keyboard.doUpArrowPress(KeyModifier.getShortcutKey());    // move focus to 1
 598         keyboard.doUpArrowPress(KeyModifier.getShortcutKey());    // move focus to 0
 599         keyboard.doKeyPress(KeyCode.SPACE, KeyModifier.SHIFT);  // select 0,1,2
 600         assertTrue(isSelected(0, 1, 2));
 601         assertTrue(isNotSelected(3, 4));
 602         assertTrue(debug(), isAnchor(2));
 603     }
 604 
 605     // test 35
 606     @Test public void testCtrlDownTwiceThenShiftDown() {
 607         sm.clearAndSelect(0);
 608         keyboard.doDownArrowPress(KeyModifier.getShortcutKey());    // move focus to 1
 609         keyboard.doDownArrowPress(KeyModifier.getShortcutKey());    // move focus to 2
 610         keyboard.doKeyPress(KeyCode.DOWN, KeyModifier.SHIFT);  // select 0,1,2,3
 611         assertTrue(isSelected(0, 1, 2, 3));
 612     }
 613 
 614     // test 36
 615     @Test public void testCtrlUpTwiceThenShiftDown() {
 616         sm.clearAndSelect(3);
 617         keyboard.doUpArrowPress(KeyModifier.getShortcutKey());    // move focus to 2
 618         keyboard.doUpArrowPress(KeyModifier.getShortcutKey());    // move focus to 1
 619         keyboard.doUpArrowPress(KeyModifier.getShortcutKey());    // move focus to 0
 620         keyboard.doKeyPress(KeyCode.DOWN, KeyModifier.SHIFT);  // select 1,2,3
 621         assertTrue(isSelected(1, 2, 3));
 622         assertTrue(isNotSelected(0));
 623     }
 624 
 625     // test 37
 626     @Test public void testCtrlDownThriceThenShiftUp() {
 627         sm.clearAndSelect(0);
 628         keyboard.doDownArrowPress(KeyModifier.getShortcutKey());    // move focus to 1
 629         keyboard.doDownArrowPress(KeyModifier.getShortcutKey());    // move focus to 2
 630         keyboard.doDownArrowPress(KeyModifier.getShortcutKey());    // move focus to 3
 631         keyboard.doKeyPress(KeyCode.UP, KeyModifier.SHIFT);  // select 0,1,2
 632         assertTrue(isSelected(0, 1, 2));
 633         assertTrue(isNotSelected(3, 4));
 634     }
 635 
 636     // test 38
 637     @Test public void testCtrlUpTwiceThenShiftUp() {
 638         sm.clearAndSelect(3);
 639         keyboard.doUpArrowPress(KeyModifier.getShortcutKey());    // move focus to 2
 640         keyboard.doUpArrowPress(KeyModifier.getShortcutKey());    // move focus to 1
 641         keyboard.doKeyPress(KeyCode.UP, KeyModifier.SHIFT);  // select 0,1,2,3
 642         assertTrue(isSelected(0, 1, 2, 3));
 643         assertTrue(isNotSelected(4));
 644     }
 645 
 646     // test 39
 647     @Test public void testCtrlDownTwiceThenSpace_extended() {
 648         sm.clearAndSelect(0);
 649         keyboard.doDownArrowPress(KeyModifier.getShortcutKey());    // move focus to 1
 650         keyboard.doDownArrowPress(KeyModifier.getShortcutKey());    // move focus to 2
 651         keyboard.doKeyPress(KeyCode.SPACE,
 652                 KeyModifier.getShortcutKey(),
 653                 (Utils.isMac()  ? KeyModifier.CTRL : null));  // select 0,2
 654         assertTrue(isSelected(0, 2));
 655         assertTrue(isNotSelected(1, 3));
 656         assertTrue(isAnchor(2));
 657 
 658         keyboard.doDownArrowPress(KeyModifier.getShortcutKey());    // move focus to 3
 659         keyboard.doDownArrowPress(KeyModifier.getShortcutKey());    // move focus to 4
 660         keyboard.doDownArrowPress(KeyModifier.SHIFT);   // select 2,3,4,5
 661         assertTrue(isSelected(2, 3, 4, 5));
 662         assertTrue(isNotSelected(0, 1));
 663         assertTrue(isAnchor(2));
 664     }
 665 
 666     // test 40
 667     @Test public void testCtrlUpTwiceThenSpace_extended() {
 668         sm.clearAndSelect(5);
 669         keyboard.doUpArrowPress(KeyModifier.getShortcutKey());    // move focus to 4
 670         keyboard.doUpArrowPress(KeyModifier.getShortcutKey());    // move focus to 3
 671         keyboard.doKeyPress(KeyCode.SPACE,
 672                 KeyModifier.getShortcutKey(),
 673                 (Utils.isMac()  ? KeyModifier.CTRL : null));  // select 3,5
 674         assertTrue(isSelected(3,5));
 675         assertTrue(isNotSelected(0,1,2,4));
 676         assertTrue(isAnchor(3));
 677 
 678         keyboard.doUpArrowPress(KeyModifier.getShortcutKey());    // move focus to 2
 679         keyboard.doUpArrowPress(KeyModifier.getShortcutKey());    // move focus to 1
 680         keyboard.doUpArrowPress(KeyModifier.getShortcutKey());    // move focus to 0
 681         keyboard.doDownArrowPress(KeyModifier.SHIFT);   // select 1,2,3
 682         assertTrue(isSelected(1,2,3));
 683         assertTrue(isNotSelected(0,4,5));
 684         assertTrue(isAnchor(3));
 685     }
 686 
 687     // test 41
 688     @Test public void testCtrlDownTwiceThenSpace_extended2() {
 689         sm.clearAndSelect(0);
 690         keyboard.doDownArrowPress(KeyModifier.getShortcutKey());    // move focus to 1
 691         keyboard.doDownArrowPress(KeyModifier.getShortcutKey());    // move focus to 2
 692         keyboard.doKeyPress(KeyCode.SPACE,
 693                 KeyModifier.getShortcutKey(),
 694                 (Utils.isMac()  ? KeyModifier.CTRL : null));  // select 0,2
 695         assertTrue(isSelected(0,2));
 696         assertTrue(isNotSelected(1,3,4));
 697         assertTrue(isAnchor(2));
 698 
 699         keyboard.doDownArrowPress(KeyModifier.getShortcutKey());    // move focus to 3
 700         keyboard.doDownArrowPress(KeyModifier.getShortcutKey());    // move focus to 4
 701         keyboard.doDownArrowPress(KeyModifier.getShortcutKey());    // move focus to 5
 702         keyboard.doUpArrowPress(KeyModifier.SHIFT);     // select 2,3,4
 703         assertTrue(isSelected(2,3,4));
 704         assertTrue(isNotSelected(0,1,5));
 705         assertTrue(isAnchor(2));
 706     }
 707 
 708     // test 50
 709     @Test public void testCtrlDownThenShiftHome() {
 710         sm.clearAndSelect(0);
 711         keyboard.doDownArrowPress(KeyModifier.getShortcutKey());    // move focus to 1
 712         keyboard.doDownArrowPress(KeyModifier.getShortcutKey());    // move focus to 2
 713         keyboard.doKeyPress(KeyCode.SPACE,
 714                 KeyModifier.getShortcutKey(),
 715                 (Utils.isMac()  ? KeyModifier.CTRL : null));  // select 0,2
 716         assertTrue(isSelected(0,2));
 717         assertTrue(isNotSelected(1,3,4));
 718         assertTrue(isAnchor(2));
 719 
 720         keyboard.doDownArrowPress(KeyModifier.getShortcutKey());    // move focus to 3
 721         keyboard.doDownArrowPress(KeyModifier.getShortcutKey());    // move focus to 4
 722         keyboard.doKeyPress(KeyCode.HOME, KeyModifier.SHIFT);
 723         assertTrue(isSelected(0,1,2));
 724         assertTrue(isNotSelected(3,4));
 725         assertTrue(debug(),isAnchor(2));
 726     }
 727 
 728     // test 51
 729     @Test public void testCtrlUpThenShiftEnd() {
 730         sm.clearAndSelect(5);
 731         keyboard.doUpArrowPress(KeyModifier.getShortcutKey());    // move focus to 4
 732         keyboard.doUpArrowPress(KeyModifier.getShortcutKey());    // move focus to 3
 733         keyboard.doKeyPress(KeyCode.SPACE,
 734                 KeyModifier.getShortcutKey(),
 735                 (Utils.isMac()  ? KeyModifier.CTRL : null));  // select 3,5
 736         assertTrue(isSelected(3,5));
 737         assertTrue(isNotSelected(1,2,4));
 738         assertTrue(isAnchor(3));
 739 
 740         keyboard.doUpArrowPress(KeyModifier.getShortcutKey());    // move focus to 2
 741         keyboard.doUpArrowPress(KeyModifier.getShortcutKey());    // move focus to 1
 742         keyboard.doKeyPress(KeyCode.END, KeyModifier.SHIFT);
 743         assertTrue(isSelected(3,4,5,6,7,8,9));
 744         assertTrue(isNotSelected(0,1,2));
 745         assertTrue(debug(),isAnchor(3));
 746     }
 747 
 748     // test 42
 749     @Test public void testCtrlUpTwiceThenSpace_extended2() {
 750         sm.clearAndSelect(5);
 751         keyboard.doUpArrowPress(KeyModifier.getShortcutKey());    // move focus to 4
 752         keyboard.doUpArrowPress(KeyModifier.getShortcutKey());    // move focus to 3
 753         keyboard.doKeyPress(KeyCode.SPACE,
 754                 KeyModifier.getShortcutKey(),
 755                 (Utils.isMac()  ? KeyModifier.CTRL : null));  // select 3,5
 756         assertTrue(isSelected(3,5));
 757         assertTrue(isNotSelected(0,1,2,4));
 758         assertTrue(isAnchor(3));
 759 
 760         keyboard.doUpArrowPress(KeyModifier.getShortcutKey());    // move focus to 2
 761         keyboard.doUpArrowPress(KeyModifier.getShortcutKey());    // move focus to 1
 762         keyboard.doUpArrowPress(KeyModifier.SHIFT);     // select 0,1,2,3
 763         assertTrue(isSelected(0,1,2,3));
 764         assertTrue(isNotSelected(4,5));
 765         assertTrue(isAnchor(3));
 766     }
 767 
 768     // test 46
 769     @Test public void testHomeKey_withSelectedItems() {
 770         sm.clearSelection();
 771         sm.selectRange(4, 11);
 772         keyboard.doKeyPress(KeyCode.HOME);
 773         assertTrue(isSelected(0));
 774         assertTrue(isNotSelected(1,2,3,4,5,6,7,8,9,10,11));
 775     }
 776 
 777     // test 47
 778     @Test public void testEndKey_withSelectedItems() {
 779         sm.clearSelection();
 780         sm.selectRange(4, 11);
 781         keyboard.doKeyPress(KeyCode.END);
 782         assertTrue(isSelected(tableView.getItems().size() - 1));
 783         assertTrue(isNotSelected(1,2,3,4,5,6,7,8));
 784     }
 785 
 786     // test 48
 787     @Test public void testShiftHome() {
 788         sm.clearAndSelect(3);
 789         keyboard.doKeyPress(KeyCode.HOME, KeyModifier.SHIFT);
 790         assertTrue(isSelected(0,1,2,3));
 791         assertTrue(isNotSelected(4,5));
 792         assertTrue(debug(), isAnchor(3));
 793     }
 794 
 795     // test 49
 796     @Test public void testShiftEnd() {
 797         sm.clearAndSelect(3);
 798         keyboard.doKeyPress(KeyCode.END, KeyModifier.SHIFT);
 799         assertTrue(isSelected(3,4,5,6,7,8,9));
 800         assertTrue(isNotSelected(0,1,2));
 801         assertTrue(debug(), isAnchor(3));
 802     }
 803 
 804     // test 52
 805     @Test public void testShiftHomeThenShiftEnd() {
 806         sm.clearAndSelect(5);
 807         keyboard.doKeyPress(KeyCode.HOME, KeyModifier.SHIFT);
 808         assertTrue(isSelected(0,1,2,3,4,5));
 809         assertTrue(isAnchor(5));
 810 
 811         keyboard.doKeyPress(KeyCode.END, KeyModifier.SHIFT);
 812         assertTrue(isSelected(5,6,7,8,9));
 813         assertTrue(isAnchor(5));
 814     }
 815 
 816     // test 65
 817     @Test public void testShiftPageUp() {
 818         sm.clearAndSelect(0);
 819         keyboard.doDownArrowPress(KeyModifier.getShortcutKey());
 820         keyboard.doDownArrowPress(KeyModifier.getShortcutKey());
 821         keyboard.doKeyPress(KeyCode.SPACE,
 822                 KeyModifier.getShortcutKey(),
 823                 (Utils.isMac()  ? KeyModifier.CTRL : null));
 824         assertTrue(isSelected(0,2));
 825         assertTrue(isAnchor(2));
 826 
 827         keyboard.doDownArrowPress(KeyModifier.getShortcutKey());
 828         keyboard.doDownArrowPress(KeyModifier.getShortcutKey());
 829         keyboard.doKeyPress(KeyCode.PAGE_UP, KeyModifier.SHIFT);
 830         assertTrue(debug(), isSelected(0,1,2));
 831         assertTrue(isAnchor(2));
 832     }
 833 
 834     // test 67
 835     @Test public void testCtrlAToSelectAll() {
 836         sm.clearAndSelect(5);
 837         keyboard.doKeyPress(KeyCode.A, KeyModifier.getShortcutKey());
 838         assertTrue(isSelected(0,1,2,3,4,5,6,7,8,9));
 839     }
 840 
 841 
 842     /***************************************************************************
 843      * Tests for cell-based multiple selection
 844      **************************************************************************/
 845 
 846     @Ignore(&quot;Bug persists&quot;)
 847     @Test public void testSelectionPathDeviationWorks1() {
 848         // select horizontally, then select two items vertically, then go back
 849         // in opposite direction
 850         sm.setCellSelectionEnabled(true);
 851         sm.clearAndSelect(1, col0);
 852 
 853         keyboard.doRightArrowPress(KeyModifier.SHIFT);   // select (1, col2)
 854         keyboard.doRightArrowPress(KeyModifier.SHIFT);   // select (1, col3)
 855         keyboard.doDownArrowPress(KeyModifier.SHIFT);    // select (2, col3)
 856         keyboard.doDownArrowPress(KeyModifier.SHIFT);    // select (3, col3)
 857         assertTrue(sm.isSelected(1, col2));
 858         assertTrue(sm.isSelected(2, col2));
 859         assertTrue(sm.isSelected(3, col2));
 860 
 861         keyboard.doUpArrowPress(KeyModifier.SHIFT);    // deselect (3, col3)
 862         assertTrue(sm.isSelected(1, col2));
 863         assertTrue(sm.isSelected(2, col2));
 864         assertFalse(sm.isSelected(3, col2));
 865 
 866         keyboard.doUpArrowPress(KeyModifier.SHIFT);    // deselect (2, col3)
 867         assertTrue(sm.isSelected(1, col2));
 868         assertFalse(sm.isSelected(2, col2));
 869         assertFalse(sm.isSelected(3, col2));
 870 
 871         keyboard.doUpArrowPress(KeyModifier.SHIFT);    // deselect (1, col3)
 872         assertFalse(debug(), sm.isSelected(1, col2));
 873         assertFalse(sm.isSelected(2, col2));
 874         assertFalse(sm.isSelected(3, col2));
 875 
 876         keyboard.doLeftArrowPress(KeyModifier.SHIFT);    // deselect (1, col2)
 877         assertFalse(sm.isSelected(1, col1));
 878     }
 879 
 880 
 881     /***************************************************************************
 882      * Tests for discontinuous multiple row selection (RT-18951)
 883      **************************************************************************/
 884 
 885     // Test 1
 886     @Test public void test_rt18591_row_1() {
 887         sm.clearAndSelect(0);
 888         keyboard.doDownArrowPress(KeyModifier.getShortcutKey());
 889         keyboard.doDownArrowPress(KeyModifier.getShortcutKey());
 890         keyboard.doKeyPress(KeyCode.SPACE,
 891                 KeyModifier.getShortcutKey(),
 892                 (Utils.isMac()  ? KeyModifier.CTRL : null));
 893         assertTrue(isSelected(0,2));
 894         assertTrue(isAnchor(2));
 895 
 896         keyboard.doDownArrowPress(KeyModifier.SHIFT, KeyModifier.getShortcutKey());
 897         keyboard.doDownArrowPress(KeyModifier.SHIFT, KeyModifier.getShortcutKey());
 898         assertTrue(isSelected(0,2,3,4));
 899         assertTrue(isAnchor(2));
 900     }
 901 
 902     // Test 2
 903     @Test public void test_rt18591_row_2() {
 904         sm.clearAndSelect(5);
 905         keyboard.doUpArrowPress(KeyModifier.getShortcutKey());
 906         keyboard.doUpArrowPress(KeyModifier.getShortcutKey());
 907         keyboard.doKeyPress(KeyCode.SPACE,
 908                 KeyModifier.getShortcutKey(),
 909                 (Utils.isMac()  ? KeyModifier.CTRL : null));
 910         assertTrue(isSelected(3,5));
 911         assertTrue(isAnchor(3));
 912 
 913         keyboard.doUpArrowPress(KeyModifier.SHIFT, KeyModifier.getShortcutKey());
 914         keyboard.doUpArrowPress(KeyModifier.SHIFT, KeyModifier.getShortcutKey());
 915         assertTrue(isSelected(1,2,3,5));
 916         assertTrue(isAnchor(3));
 917     }
 918 
 919     // Test 3
 920     @Test public void test_rt18591_row_3() {
 921         // same as test 1 above
 922         sm.clearAndSelect(0);
 923         keyboard.doDownArrowPress(KeyModifier.getShortcutKey());
 924         keyboard.doDownArrowPress(KeyModifier.getShortcutKey());
 925         keyboard.doKeyPress(KeyCode.SPACE,
 926                 KeyModifier.getShortcutKey(),
 927                 (Utils.isMac()  ? KeyModifier.CTRL : null));
 928         assertTrue(isSelected(0,2));
 929         assertTrue(isAnchor(2));
 930 
 931         keyboard.doDownArrowPress(KeyModifier.SHIFT, KeyModifier.getShortcutKey());
 932         keyboard.doDownArrowPress(KeyModifier.SHIFT, KeyModifier.getShortcutKey());
 933         assertTrue(isSelected(0,2,3,4));
 934         assertTrue(isAnchor(2));
 935         // end of similarities
 936 
 937         keyboard.doUpArrowPress(KeyModifier.SHIFT, KeyModifier.getShortcutKey());
 938         keyboard.doUpArrowPress(KeyModifier.SHIFT, KeyModifier.getShortcutKey());
 939         keyboard.doUpArrowPress(KeyModifier.SHIFT, KeyModifier.getShortcutKey());
 940         assertTrue(isSelected(0,1,2,3,4));
 941         assertTrue(isAnchor(2));
 942     }
 943 
 944     // Test 4
 945     @Test public void test_rt18591_row_4() {
 946         // same as test 2 above
 947         sm.clearAndSelect(5);
 948         keyboard.doUpArrowPress(KeyModifier.getShortcutKey());
 949         keyboard.doUpArrowPress(KeyModifier.getShortcutKey());
 950         keyboard.doKeyPress(KeyCode.SPACE,
 951                 KeyModifier.getShortcutKey(),
 952                 (Utils.isMac()  ? KeyModifier.CTRL : null));
 953         assertTrue(isSelected(3,5));
 954         assertTrue(isAnchor(3));
 955 
 956         keyboard.doUpArrowPress(KeyModifier.SHIFT, KeyModifier.getShortcutKey());
 957         keyboard.doUpArrowPress(KeyModifier.SHIFT, KeyModifier.getShortcutKey());
 958         assertTrue(isSelected(1,2,3,5));
 959         assertTrue(isAnchor(3));
 960         // end of similarities
 961 
 962         keyboard.doDownArrowPress(KeyModifier.SHIFT, KeyModifier.getShortcutKey());
 963         keyboard.doDownArrowPress(KeyModifier.SHIFT, KeyModifier.getShortcutKey());
 964         keyboard.doDownArrowPress(KeyModifier.SHIFT, KeyModifier.getShortcutKey());
 965         assertTrue(isSelected(1,2,3,4,5));
 966         assertTrue(isAnchor(3));
 967     }
 968 
 969     // Test 5 (need Page down support)
 970 //    @Test public void test_5() {
 971 //        // same as test 1 above
 972 //        sm.clearAndSelect(0);
 973 //        keyboard.doDownArrowPress(KeyModifier.getShortcutKey());
 974 //        keyboard.doDownArrowPress(KeyModifier.getShortcutKey());
 975 //        keyboard.doKeyPress(KeyCode.SPACE,
 976 //                KeyModifier.getShortcutKey(),
 977 //                (Utils.isMac()  ? KeyModifier.CTRL : null));
 978 //        assertTrue(isSelected(0,2));
 979 //        assertTrue(isAnchor(2));
 980 //        // end of similarities
 981 //
 982 //        keyboard.doKeyPress(KeyCode.PAGE_DOWN, KeyModifier.SHIFT, KeyModifier.getShortcutKey());
 983 //        assertTrue(isSelected(0,2,/*until end of page */));
 984 //        assertTrue(isAnchor(2));
 985 //    }
 986 
 987     // Test 6
 988     @Test public void test_rt18591_row_6() {
 989         sm.clearAndSelect(10);
 990         keyboard.doUpArrowPress(KeyModifier.getShortcutKey());
 991         keyboard.doUpArrowPress(KeyModifier.getShortcutKey());
 992         keyboard.doKeyPress(KeyCode.SPACE,
 993                 KeyModifier.getShortcutKey(),
 994                 (Utils.isMac() ? KeyModifier.CTRL : null));
 995         assertTrue(debug(), isSelected(8,10));
 996         assertTrue(isAnchor(8));
 997 
 998         keyboard.doKeyPress(KeyCode.PAGE_UP, KeyModifier.SHIFT, KeyModifier.getShortcutKey());
 999         assertTrue(debug(), isSelected(0,1,2,3,4,5,6,7,8,10));
1000         assertTrue(isAnchor(8));
1001     }
1002 
1003 //    // Test 7
1004 //    @Test public void test_rt18591_row_7() {
1005 //        sm.clearAndSelect(0);
1006 //        keyboard.doDownArrowPress(KeyModifier.getShortcutKey());
1007 //        keyboard.doDownArrowPress(KeyModifier.getShortcutKey());
1008 //        keyboard.doKeyPress(KeyCode.SPACE,
1009 //                KeyModifier.getShortcutKey(),
1010 //                (Utils.isMac()  ? KeyModifier.CTRL : null));
1011 //        assertTrue(isSelected(0,2));
1012 //        assertTrue(isAnchor(2));
1013 //
1014 //        keyboard.doKeyPress(KeyCode.PAGE_DOWN, KeyModifier.SHIFT, KeyModifier.getShortcutKey());
1015 //        keyboard.doKeyPress(KeyCode.PAGE_DOWN, KeyModifier.SHIFT, KeyModifier.getShortcutKey());
1016 //        assertTrue(isSelected(0,2,3,4,5,6,7,8,10)); // this isn&#39;t right
1017 //        assertTrue(isAnchor(8));
1018 //
1019 //        // NOT COMPLETE
1020 //    }
1021 //
1022 //    // Test 8
1023 //    @Test public void test_rt18591_row_8() {
1024 //        // NOT COMPLETE
1025 //    }
1026 
1027     // Test 9
1028     @Test public void test_rt18591_row_9() {
1029         sm.clearAndSelect(0);
1030         keyboard.doDownArrowPress(KeyModifier.getShortcutKey());
1031         keyboard.doDownArrowPress(KeyModifier.getShortcutKey());
1032         keyboard.doKeyPress(KeyCode.SPACE,
1033                 KeyModifier.getShortcutKey(),
1034                 (Utils.isMac()  ? KeyModifier.CTRL : null));
1035         assertTrue(isSelected(0,2));
1036         assertTrue(isAnchor(2));
1037 
1038         keyboard.doKeyPress(KeyCode.END, KeyModifier.SHIFT, KeyModifier.getShortcutKey());
1039         assertTrue(isSelected(0,2,3,4,5,6,7,8,9));
1040         assertTrue(isAnchor(2));
1041     }
1042 
1043     // Test 10
1044     @Test public void test_rt18591_row_10() {
1045         sm.clearAndSelect(8);
1046         keyboard.doUpArrowPress(KeyModifier.getShortcutKey());
1047         keyboard.doUpArrowPress(KeyModifier.getShortcutKey());
1048         keyboard.doKeyPress(KeyCode.SPACE,
1049                 KeyModifier.getShortcutKey(),
1050                 (Utils.isMac()  ? KeyModifier.CTRL : null));
1051         assertTrue(isSelected(6,8));
1052         assertTrue(isAnchor(6));
1053 
1054         keyboard.doKeyPress(KeyCode.HOME, KeyModifier.SHIFT, KeyModifier.getShortcutKey());
1055         assertTrue(isSelected(0,1,2,3,4,5,6,8));
1056         assertTrue(isAnchor(6));
1057     }
1058 
1059     // Test 11
1060     @Test public void test_rt18591_row_11() {
1061         sm.clearAndSelect(5);
1062         keyboard.doKeyPress(KeyCode.HOME, KeyModifier.SHIFT, KeyModifier.getShortcutKey());
1063         assertTrue(isSelected(0,1,2,3,4,5));
1064         assertTrue(isAnchor(5));
1065 
1066         keyboard.doKeyPress(KeyCode.END, KeyModifier.SHIFT, KeyModifier.getShortcutKey());
1067         assertTrue(isSelected(0,1,2,3,4,5,6,7,8,9));
1068         assertTrue(isAnchor(5));
1069     }
1070 
1071     // Test 12
1072     @Test public void test_rt18591_row_12() {
1073         sm.clearAndSelect(0);
1074         keyboard.doDownArrowPress(KeyModifier.getShortcutKey());
1075         keyboard.doDownArrowPress(KeyModifier.getShortcutKey());
1076         keyboard.doKeyPress(KeyCode.SPACE,
1077                 KeyModifier.getShortcutKey(),
1078                 (Utils.isMac()  ? KeyModifier.CTRL : null));
1079         assertTrue(isSelected(0,2));
1080         assertTrue(isAnchor(2));
1081 
1082         keyboard.doDownArrowPress(KeyModifier.SHIFT, KeyModifier.getShortcutKey());
1083         keyboard.doDownArrowPress(KeyModifier.SHIFT, KeyModifier.getShortcutKey());
1084         assertTrue(isSelected(0,2,3,4));
1085         assertTrue(isAnchor(2));
1086 
1087         keyboard.doUpArrowPress(KeyModifier.SHIFT, KeyModifier.getShortcutKey());
1088         keyboard.doUpArrowPress(KeyModifier.SHIFT, KeyModifier.getShortcutKey());
1089         keyboard.doUpArrowPress(KeyModifier.SHIFT, KeyModifier.getShortcutKey());
1090         assertTrue(isSelected(0,1,2,3,4));
1091         assertTrue(isAnchor(2));
1092 
1093         keyboard.doUpArrowPress(KeyModifier.getShortcutKey());
1094         keyboard.doKeyPress(KeyCode.SPACE,
1095                 KeyModifier.getShortcutKey(),
1096                 (Utils.isMac()  ? KeyModifier.CTRL : null));
1097         assertTrue(isSelected(1,2,3,4));
1098         assertTrue(isAnchor(0));
1099         assertTrue(fm.isFocused(0));
1100     }
1101 
1102 
1103     /***************************************************************************
1104      * Tests for discontinuous multiple cell selection (RT-18951)
1105      **************************************************************************/
1106 
1107     // Test 1
1108     @Test public void test_rt18591_cell_1() {
1109         sm.setSelectionMode(SelectionMode.MULTIPLE);
1110         sm.setCellSelectionEnabled(true);
1111         sm.select(0, col0);
1112         keyboard.doRightArrowPress(KeyModifier.getShortcutKey());
1113         keyboard.doRightArrowPress(KeyModifier.getShortcutKey());
1114         keyboard.doKeyPress(KeyCode.SPACE,
1115                 KeyModifier.getShortcutKey(),
1116                 (Utils.isMac()  ? KeyModifier.CTRL : null));
1117         assertTrue(sm.isSelected(0,col0));
1118         assertTrue(sm.isSelected(0,col2));
1119         assertTrue(isAnchor(0,2));
1120 
1121         keyboard.doRightArrowPress(KeyModifier.SHIFT, KeyModifier.getShortcutKey());
1122         keyboard.doRightArrowPress(KeyModifier.SHIFT, KeyModifier.getShortcutKey());
1123         assertTrue(sm.isSelected(0,col0));
1124         assertTrue(sm.isSelected(0,col2));
1125         assertTrue(sm.isSelected(0,col3));
1126         assertTrue(sm.isSelected(0,col4));
1127         assertTrue(isAnchor(0,2));
1128     }
1129 
1130     // Test 2
1131     @Test public void test_rt18591_cell_2() {
1132         sm.setSelectionMode(SelectionMode.MULTIPLE);
1133         sm.setCellSelectionEnabled(true);
1134         sm.select(0, col4);
1135         keyboard.doLeftArrowPress(KeyModifier.getShortcutKey());
1136         keyboard.doLeftArrowPress(KeyModifier.getShortcutKey());
1137         keyboard.doKeyPress(KeyCode.SPACE,
1138                 KeyModifier.getShortcutKey(),
1139                 (Utils.isMac()  ? KeyModifier.CTRL : null));
1140         assertTrue(sm.isSelected(0,col4));
1141         assertTrue(sm.isSelected(0,col2));
1142         assertTrue(isAnchor(0,2));
1143 
1144         keyboard.doLeftArrowPress(KeyModifier.SHIFT, KeyModifier.getShortcutKey());
1145         keyboard.doLeftArrowPress(KeyModifier.SHIFT, KeyModifier.getShortcutKey());
1146         assertTrue(sm.isSelected(0,col0));
1147         assertTrue(sm.isSelected(0,col1));
1148         assertTrue(sm.isSelected(0,col2));
1149         assertTrue(sm.isSelected(0,col4));
1150         assertTrue(isAnchor(0,2));
1151     }
1152 
1153     // Test 3
1154     @Test public void test_rt18591_cell_3() {
1155         sm.setSelectionMode(SelectionMode.MULTIPLE);
1156         sm.setCellSelectionEnabled(true);
1157         sm.select(0, col0);
1158         keyboard.doRightArrowPress(KeyModifier.getShortcutKey());
1159         keyboard.doRightArrowPress(KeyModifier.getShortcutKey());
1160         keyboard.doKeyPress(KeyCode.SPACE,
1161                 KeyModifier.getShortcutKey(),
1162                 (Utils.isMac()  ? KeyModifier.CTRL : null));
1163         assertTrue(sm.isSelected(0,col0));
1164         assertTrue(sm.isSelected(0,col2));
1165         assertTrue(isAnchor(0,2));
1166 
1167         keyboard.doRightArrowPress(KeyModifier.SHIFT, KeyModifier.getShortcutKey());
1168         keyboard.doRightArrowPress(KeyModifier.SHIFT, KeyModifier.getShortcutKey());
1169         assertTrue(sm.isSelected(0,col0));
1170         assertTrue(sm.isSelected(0,col2));
1171         assertTrue(sm.isSelected(0,col3));
1172         assertTrue(sm.isSelected(0,col4));
1173         assertTrue(isAnchor(0,2));
1174 
1175         keyboard.doLeftArrowPress(KeyModifier.SHIFT, KeyModifier.getShortcutKey());
1176         keyboard.doLeftArrowPress(KeyModifier.SHIFT, KeyModifier.getShortcutKey());
1177         keyboard.doLeftArrowPress(KeyModifier.SHIFT, KeyModifier.getShortcutKey());
1178         assertTrue(sm.isSelected(0,col0));
1179         assertTrue(sm.isSelected(0,col1));
1180         assertTrue(sm.isSelected(0,col2));
1181         assertTrue(sm.isSelected(0,col3));
1182         assertTrue(sm.isSelected(0,col4));
1183         assertTrue(isAnchor(0,2));
1184     }
1185 
1186     // Test 4
1187     @Test public void test_rt18591_cell_4() {
1188         sm.setSelectionMode(SelectionMode.MULTIPLE);
1189         sm.setCellSelectionEnabled(true);
1190         sm.select(0, col4);
1191         keyboard.doLeftArrowPress(KeyModifier.getShortcutKey());
1192         keyboard.doLeftArrowPress(KeyModifier.getShortcutKey());
1193         keyboard.doKeyPress(KeyCode.SPACE,
1194                 KeyModifier.getShortcutKey(),
1195                 (Utils.isMac()  ? KeyModifier.CTRL : null));
1196         assertTrue(sm.isSelected(0,col4));
1197         assertTrue(sm.isSelected(0,col2));
1198         assertTrue(isAnchor(0,2));
1199 
1200         keyboard.doLeftArrowPress(KeyModifier.SHIFT, KeyModifier.getShortcutKey());
1201         keyboard.doLeftArrowPress(KeyModifier.SHIFT, KeyModifier.getShortcutKey());
1202         assertTrue(sm.isSelected(0,col0));
1203         assertTrue(sm.isSelected(0,col1));
1204         assertTrue(sm.isSelected(0,col2));
1205         assertTrue(sm.isSelected(0,col4));
1206         assertTrue(isAnchor(0,2));
1207 
1208         keyboard.doRightArrowPress(KeyModifier.SHIFT, KeyModifier.getShortcutKey());
1209         keyboard.doRightArrowPress(KeyModifier.SHIFT, KeyModifier.getShortcutKey());
1210         keyboard.doRightArrowPress(KeyModifier.SHIFT, KeyModifier.getShortcutKey());
1211         assertTrue(sm.isSelected(0,col0));
1212         assertTrue(sm.isSelected(0,col1));
1213         assertTrue(sm.isSelected(0,col2));
1214         assertTrue(sm.isSelected(0,col3));
1215         assertTrue(sm.isSelected(0,col4));
1216         assertTrue(isAnchor(0,2));
1217     }
1218 
1219     // Test 5
1220     @Test public void test_rt18591_cell_5() {
1221         sm.setSelectionMode(SelectionMode.MULTIPLE);
1222         sm.setCellSelectionEnabled(true);
1223         sm.select(0, col1);
1224         keyboard.doDownArrowPress(KeyModifier.getShortcutKey());
1225         keyboard.doDownArrowPress(KeyModifier.getShortcutKey());
1226         keyboard.doKeyPress(KeyCode.SPACE,
1227                 KeyModifier.getShortcutKey(),
1228                 (Utils.isMac()  ? KeyModifier.CTRL : null));
1229         assertTrue(sm.isSelected(0,col1));
1230         assertTrue(sm.isSelected(2,col1));
1231         assertTrue(isAnchor(2,1));
1232 
1233         keyboard.doDownArrowPress(KeyModifier.SHIFT, KeyModifier.getShortcutKey());
1234         keyboard.doDownArrowPress(KeyModifier.SHIFT, KeyModifier.getShortcutKey());
1235         assertTrue(sm.isSelected(0,col1));
1236         assertTrue(sm.isSelected(2,col1));
1237         assertTrue(sm.isSelected(3,col1));
1238         assertTrue(sm.isSelected(4,col1));
1239         assertTrue(isAnchor(2,1));
1240     }
1241 
1242     // Test 6
1243     @Test public void test_rt18591_cell_6() {
1244         sm.setSelectionMode(SelectionMode.MULTIPLE);
1245         sm.setCellSelectionEnabled(true);
1246         sm.select(5, col1);
1247         keyboard.doUpArrowPress(KeyModifier.getShortcutKey());
1248         keyboard.doUpArrowPress(KeyModifier.getShortcutKey());
1249         keyboard.doKeyPress(KeyCode.SPACE,
1250                 KeyModifier.getShortcutKey(),
1251                 (Utils.isMac()  ? KeyModifier.CTRL : null));
1252         assertTrue(sm.isSelected(5,col1));
1253         assertTrue(sm.isSelected(3,col1));
1254         assertTrue(isAnchor(3,1));
1255 
1256         keyboard.doUpArrowPress(KeyModifier.SHIFT, KeyModifier.getShortcutKey());
1257         keyboard.doUpArrowPress(KeyModifier.SHIFT, KeyModifier.getShortcutKey());
1258         assertTrue(sm.isSelected(1,col1));
1259         assertTrue(sm.isSelected(2,col1));
1260         assertTrue(sm.isSelected(3,col1));
1261         assertTrue(sm.isSelected(5,col1));
1262         assertTrue(isAnchor(3,1));
1263     }
1264 
1265     // Test 7
1266     @Test public void test_rt18591_cell_7() {
1267         sm.setSelectionMode(SelectionMode.MULTIPLE);
1268         sm.setCellSelectionEnabled(true);
1269         sm.select(0, col1);
1270         keyboard.doDownArrowPress(KeyModifier.getShortcutKey());
1271         keyboard.doDownArrowPress(KeyModifier.getShortcutKey());
1272         keyboard.doKeyPress(KeyCode.SPACE,
1273                 KeyModifier.getShortcutKey(),
1274                 (Utils.isMac()  ? KeyModifier.CTRL : null));
1275         assertTrue(sm.isSelected(0,col1));
1276         assertTrue(sm.isSelected(2,col1));
1277         assertTrue(isAnchor(2,1));
1278 
1279         keyboard.doDownArrowPress(KeyModifier.SHIFT, KeyModifier.getShortcutKey());
1280         keyboard.doDownArrowPress(KeyModifier.SHIFT, KeyModifier.getShortcutKey());
1281         assertTrue(sm.isSelected(0,col1));
1282         assertTrue(sm.isSelected(2,col1));
1283         assertTrue(sm.isSelected(3,col1));
1284         assertTrue(sm.isSelected(4,col1));
1285         assertTrue(isAnchor(2,1));
1286 
1287         keyboard.doUpArrowPress(KeyModifier.SHIFT, KeyModifier.getShortcutKey());
1288         keyboard.doUpArrowPress(KeyModifier.SHIFT, KeyModifier.getShortcutKey());
1289         keyboard.doUpArrowPress(KeyModifier.SHIFT, KeyModifier.getShortcutKey());
1290         assertTrue(sm.isSelected(0,col1));
1291         assertTrue(sm.isSelected(1,col1));
1292         assertTrue(sm.isSelected(2,col1));
1293         assertTrue(sm.isSelected(3,col1));
1294         assertTrue(sm.isSelected(4,col1));
1295         assertTrue(isAnchor(2,1));
1296     }
1297 
1298     // Test 8
1299     @Test public void test_rt18591_cell_8() {
1300         sm.setSelectionMode(SelectionMode.MULTIPLE);
1301         sm.setCellSelectionEnabled(true);
1302         sm.select(5, col1);
1303         keyboard.doUpArrowPress(KeyModifier.getShortcutKey());
1304         keyboard.doUpArrowPress(KeyModifier.getShortcutKey());
1305         keyboard.doKeyPress(KeyCode.SPACE,
1306                 KeyModifier.getShortcutKey(),
1307                 (Utils.isMac()  ? KeyModifier.CTRL : null));
1308         assertTrue(sm.isSelected(5,col1));
1309         assertTrue(sm.isSelected(3,col1));
1310         assertTrue(isAnchor(3,1));
1311 
1312         keyboard.doUpArrowPress(KeyModifier.SHIFT, KeyModifier.getShortcutKey());
1313         keyboard.doUpArrowPress(KeyModifier.SHIFT, KeyModifier.getShortcutKey());
1314         assertTrue(sm.isSelected(1,col1));
1315         assertTrue(sm.isSelected(2,col1));
1316         assertTrue(sm.isSelected(3,col1));
1317         assertTrue(sm.isSelected(5,col1));
1318         assertTrue(isAnchor(3,1));
1319 
1320         keyboard.doDownArrowPress(KeyModifier.SHIFT, KeyModifier.getShortcutKey());
1321         keyboard.doDownArrowPress(KeyModifier.SHIFT, KeyModifier.getShortcutKey());
1322         keyboard.doDownArrowPress(KeyModifier.SHIFT, KeyModifier.getShortcutKey());
1323         assertTrue(sm.isSelected(1,col1));
1324         assertTrue(sm.isSelected(2,col1));
1325         assertTrue(sm.isSelected(3,col1));
1326         assertTrue(sm.isSelected(4,col1));
1327         assertTrue(sm.isSelected(5,col1));
1328         assertTrue(isAnchor(3,1));
1329     }
1330 
1331     // Skipped tests 9 - 12 as they require Page Up/Down support
1332 
1333     // Test 13
1334     @Test public void test_rt18591_cell_13() {
1335         sm.setSelectionMode(SelectionMode.MULTIPLE);
1336         sm.setCellSelectionEnabled(true);
1337         sm.select(0, col1);
1338         keyboard.doDownArrowPress(KeyModifier.getShortcutKey());
1339         keyboard.doDownArrowPress(KeyModifier.getShortcutKey());
1340         keyboard.doKeyPress(KeyCode.SPACE,
1341                 KeyModifier.getShortcutKey(),
1342                 (Utils.isMac()  ? KeyModifier.CTRL : null));
1343         assertTrue(sm.isSelected(0,col1));
1344         assertTrue(sm.isSelected(2,col1));
1345         assertTrue(isAnchor(2,1));
1346 
1347         keyboard.doKeyPress(KeyCode.END, KeyModifier.SHIFT, KeyModifier.getShortcutKey());
1348         assertTrue(sm.isSelected(0,col1));
1349         for (int i = 2; i &lt; tableView.getItems().size(); i++) {
1350             assertTrue(debug(),sm.isSelected(i,col1));
1351         }
1352         assertTrue(isAnchor(2,1));
1353     }
1354 
1355     // Test 14
1356     @Test public void test_rt18591_cell_14() {
1357         int n = tableView.getItems().size() - 1;
1358         sm.setSelectionMode(SelectionMode.MULTIPLE);
1359         sm.setCellSelectionEnabled(true);
1360         sm.select(n, col1);
1361         keyboard.doUpArrowPress(KeyModifier.getShortcutKey());
1362         keyboard.doUpArrowPress(KeyModifier.getShortcutKey());
1363         keyboard.doKeyPress(KeyCode.SPACE,
1364                 KeyModifier.getShortcutKey(),
1365                 (Utils.isMac()  ? KeyModifier.CTRL : null));
1366         assertTrue(sm.isSelected(n,col1));
1367         assertTrue(sm.isSelected(n - 2,col1));
1368         assertTrue(isAnchor(n - 2,1));
1369 
1370         keyboard.doKeyPress(KeyCode.HOME, KeyModifier.SHIFT, KeyModifier.getShortcutKey());
1371         assertTrue(sm.isSelected(n,col1));
1372         for (int i = 0; i &lt; n - 2; i++) {
1373             assertTrue(sm.isSelected(i,col1));
1374         }
1375         assertTrue(isAnchor(n - 2,1));
1376     }
1377 
1378     // Test 15
1379     @Test public void test_rt18591_cell_15() {
1380         sm.setSelectionMode(SelectionMode.MULTIPLE);
1381         sm.setCellSelectionEnabled(true);
1382         sm.select(5, col1);
1383         assertTrue(debug(), isAnchor(5,1));
1384 
1385         keyboard.doKeyPress(KeyCode.HOME, KeyModifier.SHIFT, KeyModifier.getShortcutKey());
1386         for (int i = 0; i &lt;= 5; i++) {
1387             assertTrue(sm.isSelected(i,col1));
1388         }
1389         assertTrue(debug(), isAnchor(5,1));
1390 
1391         keyboard.doKeyPress(KeyCode.END, KeyModifier.SHIFT, KeyModifier.getShortcutKey());
1392         for (int i = 0; i &lt; tableView.getItems().size() - 1; i++) {
1393             assertTrue(sm.isSelected(i,col1));
1394         }
1395         assertTrue(isAnchor(5,1));
1396     }
1397 
1398     // Test 16
1399     @Test public void test_rt18591_cell_16() {
1400         sm.setSelectionMode(SelectionMode.MULTIPLE);
1401         sm.setCellSelectionEnabled(true);
1402         sm.select(0, col1);
1403         keyboard.doDownArrowPress(KeyModifier.getShortcutKey());
1404         keyboard.doDownArrowPress(KeyModifier.getShortcutKey());
1405         keyboard.doKeyPress(KeyCode.SPACE,
1406                 KeyModifier.getShortcutKey(),
1407                 (Utils.isMac()  ? KeyModifier.CTRL : null));
1408         assertTrue(sm.isSelected(0,col1));
1409         assertTrue(sm.isSelected(2,col1));
1410         assertTrue(isAnchor(2,1));
1411 
1412         keyboard.doDownArrowPress(KeyModifier.SHIFT, KeyModifier.getShortcutKey());
1413         keyboard.doDownArrowPress(KeyModifier.SHIFT, KeyModifier.getShortcutKey());
1414         assertTrue(sm.isSelected(0,col1));
1415         assertTrue(sm.isSelected(2,col1));
1416         assertTrue(sm.isSelected(3,col1));
1417         assertTrue(sm.isSelected(4,col1));
1418         assertTrue(isAnchor(2,1));
1419 
1420         keyboard.doUpArrowPress(KeyModifier.SHIFT, KeyModifier.getShortcutKey());
1421         keyboard.doUpArrowPress(KeyModifier.SHIFT, KeyModifier.getShortcutKey());
1422         keyboard.doUpArrowPress(KeyModifier.SHIFT, KeyModifier.getShortcutKey());
1423         assertTrue(sm.isSelected(0,col1));
1424         assertTrue(sm.isSelected(1,col1));
1425         assertTrue(sm.isSelected(2,col1));
1426         assertTrue(sm.isSelected(3,col1));
1427         assertTrue(sm.isSelected(4,col1));
1428         assertTrue(isAnchor(2,1));
1429 
1430         keyboard.doUpArrowPress(KeyModifier.getShortcutKey());
1431         keyboard.doKeyPress(KeyCode.SPACE,
1432                 KeyModifier.getShortcutKey(),
1433                 (Utils.isMac()  ? KeyModifier.CTRL : null));
1434         assertFalse(sm.isSelected(0,col1));
1435         assertTrue(sm.isSelected(1,col1));
1436         assertTrue(sm.isSelected(2,col1));
1437         assertTrue(sm.isSelected(3,col1));
1438         assertTrue(sm.isSelected(4,col1));
1439         assertTrue(isAnchor(0,1));
1440         assertTrue(fm.isFocused(0,col1));
1441     }
1442 
1443 //    // Test 17
1444 //    @Test public void test_rt18591_cell_17() {
1445 //        sm.setSelectionMode(SelectionMode.MULTIPLE);
1446 //        sm.setCellSelectionEnabled(true);
1447 //        sm.select(3, col1);
1448 //        keyboard.doRightArrowPress(KeyModifier.getShortcutKey());
1449 //        keyboard.doRightArrowPress(KeyModifier.getShortcutKey());
1450 //        keyboard.doKeyPress(KeyCode.SPACE,
1451 //                KeyModifier.getShortcutKey(),
1452 //                (Utils.isMac()  ? KeyModifier.CTRL : null));
1453 //        assertTrue(sm.isSelected(3,col1));
1454 //        assertTrue(sm.isSelected(3,col3));
1455 //        assertTrue(isAnchor(3,3));
1456 //
1457 //        keyboard.doRightArrowPress(KeyModifier.SHIFT, KeyModifier.getShortcutKey());
1458 //        assertTrue(sm.isSelected(3,col1));
1459 //        assertTrue(sm.isSelected(3,col3));
1460 //        assertTrue(sm.isSelected(3,col4));
1461 //        assertTrue(isAnchor(3,3));
1462 //
1463 //        keyboard.doDownArrowPress(KeyModifier.SHIFT, KeyModifier.getShortcutKey());
1464 //        keyboard.doDownArrowPress(KeyModifier.SHIFT, KeyModifier.getShortcutKey());
1465 //        assertTrue(sm.isSelected(3,col1));
1466 //        assertTrue(sm.isSelected(3,col3));
1467 //        assertTrue(sm.isSelected(3,col4));
1468 //        assertTrue(sm.isSelected(4,col3));
1469 //        assertTrue(sm.isSelected(5,col3));
1470 //        assertTrue(isAnchor(3,3));
1471 //    }
1472 
1473 
1474     /***************************************************************************
1475      * Tests for specific bug reports
1476      **************************************************************************/
1477 
1478     @Test public void test_rt18488_selectToLeft() {
1479         sm.setCellSelectionEnabled(true);
1480         sm.clearAndSelect(1, col4);
1481 
1482         keyboard.doLeftArrowPress(KeyModifier.SHIFT);   // select (1, col4)
1483         keyboard.doLeftArrowPress(KeyModifier.SHIFT);   // select (1, col3)
1484         keyboard.doLeftArrowPress(KeyModifier.SHIFT);   // select (1, col2)
1485         keyboard.doLeftArrowPress(KeyModifier.SHIFT);   // select (1, col1)
1486         assertTrue(sm.isSelected(1, col4));
1487         assertTrue(sm.isSelected(1, col3));
1488         assertTrue(sm.isSelected(1, col2));
1489         assertTrue(sm.isSelected(1, col1));
1490         assertTrue(sm.isSelected(1, col0));
1491 
1492         keyboard.doRightArrowPress(KeyModifier.SHIFT);   // deselect (1, col1)
1493         assertTrue(sm.isSelected(1, col4));
1494         assertTrue(sm.isSelected(1, col3));
1495         assertTrue(sm.isSelected(1, col2));
1496         assertTrue(debug(), sm.isSelected(1, col1));
1497         assertFalse(sm.isSelected(1, col0));
1498     }
1499 
1500     @Test public void test_rt18488_selectToRight() {
1501         sm.setCellSelectionEnabled(true);
1502         sm.clearAndSelect(1, col0);
1503 
1504         keyboard.doRightArrowPress(KeyModifier.SHIFT);   // select (1, col2)
1505         keyboard.doRightArrowPress(KeyModifier.SHIFT);   // select (1, col3)
1506         keyboard.doRightArrowPress(KeyModifier.SHIFT);   // select (1, col4)
1507         keyboard.doRightArrowPress(KeyModifier.SHIFT);   // select (1, col5)
1508         assertTrue(sm.isSelected(1, col4));
1509         assertTrue(sm.isSelected(1, col3));
1510         assertTrue(sm.isSelected(1, col2));
1511         assertTrue(sm.isSelected(1, col1));
1512         assertTrue(sm.isSelected(1, col0));
1513 
1514         keyboard.doLeftArrowPress(KeyModifier.SHIFT);   // deselect (1, col5)
1515         assertFalse(sm.isSelected(1, col4));
1516         assertTrue(sm.isSelected(1, col3));
1517         assertTrue(sm.isSelected(1, col2));
1518         assertTrue(sm.isSelected(1, col1));
1519         assertTrue(sm.isSelected(1, col0));
1520     }
1521 
1522     @Test public void test_rt18488_comment1() {
1523         sm.setCellSelectionEnabled(true);
1524         sm.clearAndSelect(1, col0);
1525 
1526         keyboard.doRightArrowPress(KeyModifier.SHIFT);   // select (1, col2)
1527         keyboard.doRightArrowPress(KeyModifier.SHIFT);   // select (1, col3)
1528         keyboard.doRightArrowPress(KeyModifier.SHIFT);   // select (1, col4)
1529         keyboard.doRightArrowPress(KeyModifier.SHIFT);   // select (1, col5)
1530         keyboard.doDownArrowPress(KeyModifier.SHIFT);    // select (2, col5)
1531 
1532         assertTrue(sm.isSelected(2, col4));
1533         assertTrue(sm.isSelected(1, col4));
1534         assertTrue(sm.isSelected(1, col3));
1535         assertTrue(sm.isSelected(1, col2));
1536         assertTrue(sm.isSelected(1, col1));
1537         assertTrue(sm.isSelected(1, col0));
1538 
1539         keyboard.doUpArrowPress(KeyModifier.SHIFT);     // deselect (2, col5)
1540         assertFalse(sm.isSelected(2, col4));
1541         assertTrue(sm.isSelected(1, col4));
1542         assertTrue(sm.isSelected(1, col3));
1543         assertTrue(sm.isSelected(1, col2));
1544         assertTrue(sm.isSelected(1, col1));
1545         assertTrue(sm.isSelected(1, col0));
1546     }
1547 
1548     @Test public void test_rt18536_positive_horizontal() {
1549         // Test shift selection when focus is elsewhere (so as to select a range)
1550         sm.setCellSelectionEnabled(true);
1551         sm.clearAndSelect(1, col0);
1552 
1553         // move focus by holding down ctrl button
1554         keyboard.doRightArrowPress(KeyModifier.getShortcutKey());   // move focus to (1, col2)
1555         keyboard.doRightArrowPress(KeyModifier.getShortcutKey());   // move focus to (1, col3)
1556         keyboard.doRightArrowPress(KeyModifier.getShortcutKey());   // move focus to (1, col4)
1557         keyboard.doRightArrowPress(KeyModifier.getShortcutKey());   // move focus to (1, col5)
1558         assertTrue(fm.isFocused(1, col4));
1559 
1560         // press shift + space to select all cells between (1, col1) and (1, col5)
1561         keyboard.doKeyPress(KeyCode.SPACE, KeyModifier.SHIFT);
1562         assertTrue(sm.isSelected(1, col4));
1563         assertTrue(debug(), sm.isSelected(1, col3));
1564         assertTrue(sm.isSelected(1, col2));
1565         assertTrue(sm.isSelected(1, col1));
1566         assertTrue(sm.isSelected(1, col0));
1567     }
1568 
1569     @Test public void test_rt18536_negative_horizontal() {
1570         // Test shift selection when focus is elsewhere (so as to select a range)
1571         sm.setCellSelectionEnabled(true);
1572         sm.clearAndSelect(1, col4);
1573 
1574         // move focus by holding down ctrl button
1575         keyboard.doLeftArrowPress(KeyModifier.getShortcutKey());   // move focus to (1, col4)
1576         keyboard.doLeftArrowPress(KeyModifier.getShortcutKey());   // move focus to (1, col3)
1577         keyboard.doLeftArrowPress(KeyModifier.getShortcutKey());   // move focus to (1, col2)
1578         keyboard.doLeftArrowPress(KeyModifier.getShortcutKey());   // move focus to (1, col1)
1579         assertTrue(fm.isFocused(1, col0));
1580 
1581         // press shift + space to select all cells between (1, col1) and (1, col5)
1582         keyboard.doKeyPress(KeyCode.SPACE, KeyModifier.SHIFT);
1583         assertTrue(debug(), sm.isSelected(1, col4));
1584         assertTrue(sm.isSelected(1, col3));
1585         assertTrue(sm.isSelected(1, col2));
1586         assertTrue(sm.isSelected(1, col1));
1587         assertTrue(sm.isSelected(1, col0));
1588     }
1589 
1590     //
1591     @Test public void test_rt18536_positive_vertical() {
1592         // Test shift selection when focus is elsewhere (so as to select a range)
1593         sm.setCellSelectionEnabled(true);
1594         sm.clearAndSelect(1, col4);
1595 
1596         // move focus by holding down ctrl button
1597         keyboard.doDownArrowPress(KeyModifier.getShortcutKey());   // move focus to (2, col5)
1598         keyboard.doDownArrowPress(KeyModifier.getShortcutKey());   // move focus to (3, col5)
1599         keyboard.doDownArrowPress(KeyModifier.getShortcutKey());   // move focus to (4, col5)
1600         keyboard.doDownArrowPress(KeyModifier.getShortcutKey());   // move focus to (5, col5)
1601         assertTrue(fm.isFocused(5, col4));
1602 
1603         // press shift + space to select all cells between (1, col5) and (5, col5)
1604         keyboard.doKeyPress(KeyCode.SPACE, KeyModifier.SHIFT);
1605         assertTrue(sm.isSelected(1, col4));
1606         assertTrue(sm.isSelected(2, col4));
1607         assertTrue(sm.isSelected(3, col4));
1608         assertTrue(sm.isSelected(4, col4));
1609         assertTrue(sm.isSelected(5, col4));
1610     }
1611 
1612     //
1613     @Test public void test_rt18536_negative_vertical() {
1614         // Test shift selection when focus is elsewhere (so as to select a range)
1615         sm.setCellSelectionEnabled(true);
1616         sm.clearAndSelect(5, col4);
1617 
1618         // move focus by holding down ctrl button
1619         keyboard.doUpArrowPress(KeyModifier.getShortcutKey());   // move focus to (4, col5)
1620         keyboard.doUpArrowPress(KeyModifier.getShortcutKey());   // move focus to (3, col5)
1621         keyboard.doUpArrowPress(KeyModifier.getShortcutKey());   // move focus to (2, col5)
1622         keyboard.doUpArrowPress(KeyModifier.getShortcutKey());   // move focus to (1, col5)
1623         assertTrue(fm.isFocused(1, col4));
1624 
1625         // press shift + space to select all cells between (1, col5) and (5, col5)
1626         keyboard.doKeyPress(KeyCode.SPACE, KeyModifier.SHIFT);
1627         assertTrue(sm.isSelected(1, col4));
1628         assertTrue(sm.isSelected(2, col4));
1629         assertTrue(sm.isSelected(3, col4));
1630         assertTrue(sm.isSelected(4, col4));
1631         assertTrue(sm.isSelected(5, col4));
1632     }
1633 
1634     //
1635     @Test public void test_rt18642() {
1636         sm.setCellSelectionEnabled(false);
1637         sm.clearAndSelect(1);                          // select 1
1638         keyboard.doDownArrowPress(KeyModifier.getShortcutKey());   // shift focus to 2
1639         keyboard.doDownArrowPress(KeyModifier.getShortcutKey());   // shift focus to 3
1640         keyboard.doKeyPress(KeyCode.SPACE,
1641                 KeyModifier.getShortcutKey(),
1642                 (Utils.isMac()  ? KeyModifier.CTRL : null)); // set anchor, and also select, 3
1643         keyboard.doDownArrowPress(KeyModifier.getShortcutKey());   // shift focus to 4
1644         keyboard.doDownArrowPress(KeyModifier.getShortcutKey());   // shift focus to 5
1645         keyboard.doKeyPress(KeyCode.SPACE,
1646                 KeyModifier.getShortcutKey(),
1647                 (Utils.isMac()  ? KeyModifier.CTRL : null)); // set anchor, and also select, 5
1648 
1649         assertTrue(isSelected(1, 3, 5));
1650         assertTrue(isNotSelected(0, 2, 4));
1651 
1652         // anchor is at 5, so shift+UP should select rows 4 and 5 only
1653         keyboard.doUpArrowPress(KeyModifier.SHIFT);
1654         assertTrue(isSelected(4, 5));
1655         assertTrue(isNotSelected(0, 1, 2, 3));
1656     }
1657 
1658     @Test public void test_rt14451_1() {
1659         sm.clearAndSelect(5);
1660 
1661         keyboard.doKeyPress(KeyCode.HOME, KeyModifier.SHIFT);
1662         assertTrue(isSelected(0,1,2,3,4,5));
1663         assertTrue(isNotSelected(6,7,8,9));
1664 
1665         keyboard.doKeyPress(KeyCode.END, KeyModifier.SHIFT);
1666         assertTrue(isNotSelected(0,1,2,3,4));
1667         assertTrue(isSelected(5,6,7,8,9));
1668 
1669         keyboard.doKeyPress(KeyCode.HOME, KeyModifier.SHIFT);
1670         assertTrue(isSelected(0,1,2,3,4,5));
1671         assertTrue(debug(), isNotSelected(6,7,8,9));
1672     }
1673 
1674     @Test public void test_rt14451_2() {
1675         sm.clearAndSelect(5);
1676 
1677         keyboard.doKeyPress(KeyCode.END, KeyModifier.SHIFT);
1678         assertTrue(isNotSelected(0,1,2,3,4));
1679         assertTrue(isSelected(5,6,7,8,9));
1680 
1681         keyboard.doKeyPress(KeyCode.HOME, KeyModifier.SHIFT);
1682         assertTrue(isSelected(0,1,2,3,4,5));
1683         assertTrue(debug(), isNotSelected(6,7,8,9));
1684 
1685         keyboard.doKeyPress(KeyCode.END, KeyModifier.SHIFT);
1686         assertTrue(isNotSelected(0,1,2,3,4));
1687         assertTrue(isSelected(5,6,7,8,9));
1688     }
1689 
1690     @Test public void test_rt26835_1() {
1691         sm.clearAndSelect(5);
1692         keyboard.doKeyPress(KeyCode.HOME, KeyModifier.getShortcutKey());
1693         assertTrue(fm.isFocused(0));
1694     }
1695 
1696     @Test public void test_rt26835_2() {
1697         sm.clearAndSelect(5);
1698         keyboard.doKeyPress(KeyCode.END, KeyModifier.getShortcutKey());
1699         assertTrue(debug(), fm.isFocused(tableView.getItems().size() - 1));
1700     }
1701 
1702     @Test public void test_rt27175() {
1703         sm.clearAndSelect(5);
1704         keyboard.doKeyPress(KeyCode.HOME, KeyModifier.SHIFT, KeyModifier.getShortcutKey());
1705         assertTrue(debug(), fm.isFocused(0));
1706         assertTrue(isSelected(0,1,2,3,4,5));
1707     }
1708 
1709     @Test public void test_rt28065() {
1710         sm.setSelectionMode(SelectionMode.MULTIPLE);
1711         tableView.getItems().setAll(&quot;Apple&quot;, &quot;Orange&quot;, &quot;Banana&quot;);
1712 
1713         tableView.getSelectionModel().select(0);
1714         assertEquals(0, tableView.getSelectionModel().getSelectedIndex());
1715         assertEquals(&quot;Apple&quot;, tableView.getSelectionModel().getSelectedItem());
1716         assertEquals(0, tableView.getFocusModel().getFocusedIndex());
1717         assertEquals(&quot;Apple&quot;, tableView.getFocusModel().getFocusedItem());
1718 
1719         keyboard.doKeyPress(KeyCode.A, KeyModifier.getShortcutKey());
1720         assertEquals(0, tableView.getSelectionModel().getSelectedIndex());
1721         assertEquals(&quot;Apple&quot;, tableView.getSelectionModel().getSelectedItem());
1722         assertEquals(0, tableView.getFocusModel().getFocusedIndex());
1723         assertEquals(&quot;Apple&quot;, tableView.getFocusModel().getFocusedItem());
1724     }
1725 
1726     @Test public void test_rt27583_cellSelection_1() {
1727         sm.setCellSelectionEnabled(true);
1728         sm.setSelectionMode(SelectionMode.MULTIPLE);
1729 
1730         sm.select(0, col0);
1731         assertTrue(fm.isFocused(0, col0));
1732 
1733         // focus should not go out the top of the table
1734         keyboard.doDownArrowPress(KeyModifier.SHIFT);
1735         assertTrue(fm.isFocused(1, col0));
1736         keyboard.doUpArrowPress(KeyModifier.SHIFT);
1737         assertTrue(fm.isFocused(0, col0));
1738         keyboard.doUpArrowPress(KeyModifier.SHIFT);
1739         assertTrue(debug(), fm.isFocused(0, col0));
1740 
1741     }
1742 
1743     @Test public void test_rt27583_cellSelection_2() {
1744         sm.setCellSelectionEnabled(true);
1745         sm.setSelectionMode(SelectionMode.MULTIPLE);
1746 
1747         sm.select(9, col0);
1748         assertTrue(fm.isFocused(9, col0));
1749 
1750         // focus should not go out the bottom of the table
1751         keyboard.doDownArrowPress(KeyModifier.SHIFT);
1752         assertTrue(fm.isFocused(10, col0));
1753         keyboard.doDownArrowPress(KeyModifier.SHIFT);
1754         assertTrue(fm.isFocused(11, col0));
1755         keyboard.doDownArrowPress(KeyModifier.SHIFT);
1756         assertTrue(debug(), fm.isFocused(11, col0));
1757     }
1758 
1759     @Test public void test_rt27583_rowSelection_1() {
1760         sm.setCellSelectionEnabled(false);
1761         sm.setSelectionMode(SelectionMode.MULTIPLE);
1762 
1763         sm.select(0);
1764         assertTrue(fm.isFocused(0));
1765 
1766         // focus should not go out the top of the table
1767         keyboard.doDownArrowPress(KeyModifier.SHIFT);
1768         assertTrue(fm.isFocused(1));
1769         keyboard.doUpArrowPress(KeyModifier.SHIFT);
1770         assertTrue(fm.isFocused(0));
1771         keyboard.doUpArrowPress(KeyModifier.SHIFT);
1772         assertTrue(debug(), fm.isFocused(0));
1773 
1774     }
1775 
1776     @Test public void test_rt27583_rowSelection_2() {
1777         sm.setCellSelectionEnabled(false);
1778         sm.setSelectionMode(SelectionMode.MULTIPLE);
1779 
1780         sm.select(9);
1781         assertTrue(fm.isFocused(9));
1782 
1783         // focus should not go out the bottom of the table
1784         keyboard.doDownArrowPress(KeyModifier.SHIFT);
1785         assertTrue(fm.isFocused(10));
1786         keyboard.doDownArrowPress(KeyModifier.SHIFT);
1787         assertTrue(fm.isFocused(11));
1788         keyboard.doDownArrowPress(KeyModifier.SHIFT);
1789         assertTrue(debug(), fm.isFocused(11));
1790     }
1791 
1792     @Test public void test_rt29833_keyboard_select_upwards() {
1793         sm.setCellSelectionEnabled(false);
1794         sm.setSelectionMode(SelectionMode.MULTIPLE);
1795 
1796         sm.clearAndSelect(9);
1797 
1798         // select all from 9 - 7
1799         fm.focus(7);
1800         keyboard.doKeyPress(KeyCode.SPACE, KeyModifier.SHIFT);
1801         assertTrue(isSelected(7,8,9));
1802 
1803         // select all from 9 - 7 - 5
1804         fm.focus(5);
1805         keyboard.doKeyPress(KeyCode.SPACE, KeyModifier.SHIFT);
1806         assertTrue(isSelected(5,6,7,8,9));
1807     }
1808 
1809     @Test public void test_rt29833_keyboard_select_downwards() {
1810         sm.setCellSelectionEnabled(false);
1811         sm.setSelectionMode(SelectionMode.MULTIPLE);
1812 
1813         sm.clearAndSelect(5);
1814 
1815         // select all from 5 - 7
1816         fm.focus(7);
1817         keyboard.doKeyPress(KeyCode.SPACE, KeyModifier.SHIFT);
1818         assertTrue(isSelected(5,6,7));
1819 
1820         // select all from 5 - 7 - 9
1821         fm.focus(9);
1822         keyboard.doKeyPress(KeyCode.SPACE, KeyModifier.SHIFT);
1823         assertTrue(isSelected(5,6,7,8,9));
1824     }
1825 
1826     @Test public void test_rt29930() {
1827         sm.setCellSelectionEnabled(false);
1828         sm.setSelectionMode(SelectionMode.MULTIPLE);
1829 
1830         sm.clearAndSelect(0);
1831 
1832         keyboard.doDownArrowPress(KeyModifier.SHIFT); // select rows [0,1]
1833         keyboard.doDownArrowPress(KeyModifier.SHIFT); // select rows [0,1,2]
1834         assertTrue(isSelected(0,1,2));
1835         assertEquals(3, sm.getSelectedIndices().size());
1836         assertEquals(3, sm.getSelectedCells().size());
1837         assertEquals(2, fm.getFocusedIndex());
1838         assertEquals(0, getAnchor().getRow());
1839 
1840         keyboard.doKeyPress(KeyCode.SPACE, KeyModifier.getShortcutKey(), PlatformUtil.isMac() ? KeyModifier.CTRL : null); // set new anchor point
1841         assertTrue(isSelected(0,1));
1842         assertEquals(2, sm.getSelectedIndices().size());
1843         assertEquals(2, sm.getSelectedCells().size());
1844         assertEquals(2, fm.getFocusedIndex());
1845         assertEquals(2, getAnchor().getRow());
1846 
1847         keyboard.doDownArrowPress(KeyModifier.SHIFT); // select rows [2,3]
1848         assertTrue(isSelected(2,3));
1849         assertTrue(isNotSelected(0,1));
1850         assertEquals(2, sm.getSelectedIndices().size());
1851         assertEquals(2, sm.getSelectedCells().size());
1852         assertEquals(3, fm.getFocusedIndex());
1853         assertEquals(2, getAnchor().getRow());
1854     }
1855 
1856     private int rt29849_start_count = 0;
1857     private int rt29849_cancel_count = 0;
1858     @Test public void test_rt29849() {
1859         tableView.setEditable(true);
1860         col0.setEditable(true);
1861 
1862         col0.setCellValueFactory(param -&gt; new ReadOnlyStringWrapper(&quot;DUMMY TEXT&quot;));
1863 
1864         col0.setOnEditStart(t -&gt; {
1865             rt29849_start_count++;
1866         });
1867         col0.setOnEditCancel(t -&gt; {
1868             rt29849_cancel_count++;
1869         });
1870 
1871         // initially the counts should be zero
1872         assertEquals(0, rt29849_start_count);
1873         assertEquals(0, rt29849_cancel_count);
1874 
1875         TableCell cell = (TableCell)VirtualFlowTestUtils.getCell(tableView, 0, 0);
1876         TableCellShim.set_lockItemOnEdit(cell, false);
1877         assertTrue(cell.isEditable());
1878         assertFalse(cell.isEditing());
1879         assertEquals(0, cell.getIndex());
1880 
1881         // do an edit, start count should be one, cancel still zero
1882         tableView.edit(0, col0);
1883         assertTrue(cell.isEditing());
1884         assertEquals(1, rt29849_start_count);
1885         assertEquals(0, rt29849_cancel_count);
1886 
1887         // cancel edit, now both counts should be 1
1888         keyboard.doKeyPress(KeyCode.ESCAPE);
1889         assertFalse(cell.isEditing());
1890         assertEquals(1, rt29849_start_count);
1891         assertEquals(1, rt29849_cancel_count);
1892     }
1893 
1894     private int rt31577_count = 0;
1895     @Test public void test_rt31577() {
1896         final TableSelectionModel sm = tableView.getSelectionModel();
1897         sm.setCellSelectionEnabled(false);
1898         sm.setSelectionMode(SelectionMode.SINGLE);
1899         sm.clearSelection();
1900 
1901         // the actual bug is that the selectedItem property does not fire an
1902         // event when the selected items list changes (due to deselection).
1903         // It actually does always contain the right value - it just doesn&#39;t
1904         // let anyone know it!
1905         sm.selectedItemProperty().addListener(observable -&gt; {
1906             rt31577_count++;
1907         });
1908 
1909         assertTrue(sm.getSelectedItems().isEmpty());
1910         assertFalse(sm.isSelected(1));
1911         assertEquals(0, rt31577_count);
1912 
1913         // select the first row
1914         keyboard.doKeyPress(KeyCode.KP_DOWN);
1915         assertEquals(1, sm.getSelectedItems().size());
1916         assertTrue(sm.isSelected(0));
1917         assertTrue(sm.getSelectedItems().contains(&quot;1&quot;));
1918         assertEquals(&quot;1&quot;, sm.getSelectedItem());
1919         assertEquals(1, rt31577_count);
1920 
1921         // deselect the row
1922         keyboard.doKeyPress(KeyCode.SPACE, KeyModifier.CTRL,
1923                 Utils.isMac() ? KeyModifier.getShortcutKey() : null);
1924         assertTrue(sm.getSelectedItems().isEmpty());
1925         assertFalse(sm.isSelected(1));
1926         assertNull(sm.getSelectedItem());
1927         assertEquals(2, rt31577_count);
1928     }
1929 
1930     @Test public void test_rt32383_pageDown() {
1931         // this test requires a lot of data
1932         tableView.getItems().clear();
1933         for (int i = 0; i &lt; 100; i++) {
1934             tableView.getItems().add(&quot;Row &quot; + i);
1935         }
1936 
1937         final MultipleSelectionModel sm = tableView.getSelectionModel();
1938         sm.setSelectionMode(SelectionMode.SINGLE);
1939         sm.clearAndSelect(0);
1940 
1941         final String initialFocusOwner = fm.getFocusedItem();
1942 
1943         keyboard.doKeyPress(KeyCode.PAGE_DOWN, KeyModifier.getShortcutKey());
1944         Toolkit.getToolkit().firePulse();
1945         final String newFocusOwner = fm.getFocusedItem();
1946         assertNotSame(initialFocusOwner, newFocusOwner);
1947 
1948         keyboard.doKeyPress(KeyCode.PAGE_DOWN, KeyModifier.getShortcutKey());
1949         Toolkit.getToolkit().firePulse();
1950         final String nextFocusOwner = fm.getFocusedItem();
1951         assertNotSame(initialFocusOwner, nextFocusOwner);
1952         assertNotSame(newFocusOwner, nextFocusOwner);
1953     }
1954 
1955     @Test public void test_rt32383_pageUp() {
1956         // this test requires a lot of data
1957         tableView.getItems().clear();
1958         for (int i = 0; i &lt; 100; i++) {
1959             tableView.getItems().add(&quot;Row &quot; + i);
1960         }
1961 
1962         final int lastIndex = 99;
1963 
1964         final MultipleSelectionModel sm = tableView.getSelectionModel();
1965         sm.setSelectionMode(SelectionMode.SINGLE);
1966         sm.clearAndSelect(lastIndex);
1967 
1968         // need to make sure we scroll down to the bottom!
1969         tableView.scrollTo(lastIndex);
1970         Toolkit.getToolkit().firePulse();
1971 
1972         final String initialFocusOwner = fm.getFocusedItem();
1973 
1974         keyboard.doKeyPress(KeyCode.PAGE_UP, KeyModifier.getShortcutKey());
1975         Toolkit.getToolkit().firePulse();
1976         final String newFocusOwner = fm.getFocusedItem();
1977         assertNotSame(initialFocusOwner, newFocusOwner);
1978 
1979         keyboard.doKeyPress(KeyCode.PAGE_UP, KeyModifier.getShortcutKey());
1980         Toolkit.getToolkit().firePulse();
1981         final String nextFocusOwner = fm.getFocusedItem();
1982         assertNotSame(initialFocusOwner, nextFocusOwner);
1983         assertNotSame(newFocusOwner, nextFocusOwner);
1984     }
1985 
1986     @Test public void test_rt27710_pageDown_singleSelection_cell() {
1987         // this test requires a lot of data
1988         tableView.getItems().clear();
1989         for (int i = 0; i &lt; 100; i++) {
1990             tableView.getItems().add(&quot;Row &quot; + i);
1991         }
1992 
1993         col0.setCellValueFactory(param -&gt; new ReadOnlyStringWrapper(param.getValue()));
1994 
1995         final TableSelectionModel sm = tableView.getSelectionModel();
1996         sm.setSelectionMode(SelectionMode.SINGLE);
1997         sm.setCellSelectionEnabled(true);
1998         sm.clearAndSelect(0, col0);
1999 
2000         final String initialFocusOwner = fm.getFocusedItem();
2001 
2002         keyboard.doKeyPress(KeyCode.PAGE_DOWN, KeyModifier.SHIFT);
2003         Toolkit.getToolkit().firePulse();
2004         final String newFocusOwner = fm.getFocusedItem();
2005         assertNotSame(initialFocusOwner, newFocusOwner);
2006 
2007         keyboard.doKeyPress(KeyCode.PAGE_DOWN, KeyModifier.SHIFT);
2008         Toolkit.getToolkit().firePulse();
2009         final String nextFocusOwner = fm.getFocusedItem();
2010         assertNotSame(initialFocusOwner, nextFocusOwner);
2011         assertNotSame(newFocusOwner, nextFocusOwner);
2012     }
2013 
2014     @Test public void test_rt27710_pageUp_singleSelection_cell() {
2015         // this test requires a lot of data
2016         tableView.getItems().clear();
2017         for (int i = 0; i &lt; 100; i++) {
2018             tableView.getItems().add(&quot;Row &quot; + i);
2019         }
2020 
2021         col0.setCellValueFactory(param -&gt; new ReadOnlyStringWrapper(param.getValue()));
2022 
2023         final int lastIndex = 99;
2024 
2025         final TableSelectionModel sm = tableView.getSelectionModel();
2026         sm.setSelectionMode(SelectionMode.SINGLE);
2027         sm.setCellSelectionEnabled(true);
2028         sm.clearAndSelect(lastIndex, col0);
2029 
2030         // need to make sure we scroll down to the bottom!
2031         tableView.scrollTo(lastIndex);
2032         Toolkit.getToolkit().firePulse();
2033 
2034         final String initialFocusOwner = fm.getFocusedItem();
2035         final Object initialSelectionOwner = sm.getSelectedItem();
2036 
2037         keyboard.doKeyPress(KeyCode.PAGE_UP, KeyModifier.SHIFT);
2038         Toolkit.getToolkit().firePulse();
2039         final String newFocusOwner = fm.getFocusedItem();
2040         final Object newSelectionOwner = sm.getSelectedItem();
2041         assertNotSame(initialFocusOwner, newFocusOwner);
2042         assertNotSame(initialSelectionOwner, newSelectionOwner);
2043 
2044         keyboard.doKeyPress(KeyCode.PAGE_UP, KeyModifier.SHIFT);
2045         Toolkit.getToolkit().firePulse();
2046         final String nextFocusOwner = fm.getFocusedItem();
2047         final Object nextSelectionOwner = sm.getSelectedItem();
2048         assertNotSame(initialFocusOwner, nextFocusOwner);
2049         assertNotSame(newFocusOwner, nextFocusOwner);
2050         assertNotSame(initialSelectionOwner, nextSelectionOwner);
2051         assertNotSame(newSelectionOwner, nextSelectionOwner);
2052     }
2053 
2054     @Test public void test_rt19053_pageUp() {
2055         final int items = 8;
2056         tableView.getItems().clear();
2057         for (int i = 0; i &lt; items; i++) {
2058             tableView.getItems().add(&quot;Row &quot; + i);
2059         }
2060 
2061         final int middleIndex = items / 2;
2062 
2063         final MultipleSelectionModel sm = tableView.getSelectionModel();
2064         sm.setSelectionMode(SelectionMode.SINGLE);
2065         sm.clearAndSelect(middleIndex);
2066 
2067         assertEquals(middleIndex, sm.getSelectedIndex());
2068 
2069         final Object initialSelectionOwner = sm.getSelectedItem();
2070 
2071         keyboard.doKeyPress(KeyCode.PAGE_DOWN, KeyModifier.SHIFT);
2072         Toolkit.getToolkit().firePulse();
2073         final Object newSelectionOwner = sm.getSelectedItem();
2074         assertNotSame(initialSelectionOwner + &quot; == &quot; + newSelectionOwner, initialSelectionOwner, newSelectionOwner);
2075 
2076         // selection should go all the way to the top, but this bug
2077         // shows that instead it seems to stop midway - where the anchor is
2078         keyboard.doKeyPress(KeyCode.PAGE_UP, KeyModifier.SHIFT);
2079         Toolkit.getToolkit().firePulse();
2080         assertEquals(0, fm.getFocusedIndex());
2081         assertEquals(0, sm.getSelectedIndex());
2082         final Object nextSelectionOwner =  sm.getSelectedItem();
2083         assertNotSame(initialSelectionOwner, nextSelectionOwner);
2084         assertNotSame(newSelectionOwner, nextSelectionOwner);
2085     }
2086 
2087     @Test public void test_rt19053_pageDown() {
2088         final int items = 8;
2089         tableView.getItems().clear();
2090         for (int i = 0; i &lt; items; i++) {
2091             tableView.getItems().add(&quot;Row &quot; + i);
2092         }
2093 
2094         final int middleIndex = items / 2;
2095 
2096         final MultipleSelectionModel sm = tableView.getSelectionModel();
2097         sm.setSelectionMode(SelectionMode.SINGLE);
2098         sm.clearAndSelect(middleIndex);
2099 
2100         assertEquals(middleIndex, sm.getSelectedIndex());
2101 
2102         final Object initialSelectionOwner = sm.getSelectedItem();
2103 
2104         keyboard.doKeyPress(KeyCode.PAGE_UP, KeyModifier.SHIFT);
2105         Toolkit.getToolkit().firePulse();
2106         final Object newSelectionOwner = sm.getSelectedItem();
2107         assertNotSame(initialSelectionOwner, newSelectionOwner);
2108 
2109         // selection should go all the way to the bottom, but this bug
2110         // shows that instead it seems to stop midway - where the anchor is
2111         keyboard.doKeyPress(KeyCode.PAGE_DOWN, KeyModifier.SHIFT);
2112         Toolkit.getToolkit().firePulse();
2113         assertEquals(items - 1, fm.getFocusedIndex());
2114         assertEquals(items - 1, sm.getSelectedIndex());
2115         final Object nextSelectionOwner =  sm.getSelectedItem();
2116         assertNotSame(initialSelectionOwner, nextSelectionOwner);
2117         assertNotSame(newSelectionOwner, nextSelectionOwner);
2118     }
2119 
2120     @Test public void test_rt21444_up() {
2121         final int items = 8;
2122         tableView.getItems().clear();
2123         for (int i = 1; i &lt;= items; i++) {
2124             tableView.getItems().add(&quot;Row &quot; + i);
2125         }
2126 
2127         final MultipleSelectionModel sm = tableView.getSelectionModel();
2128         sm.setSelectionMode(SelectionMode.MULTIPLE);
2129         sm.clearAndSelect(3);
2130 
2131         assertEquals(3, sm.getSelectedIndex());
2132         assertEquals(&quot;Row 4&quot;, sm.getSelectedItem());
2133 
2134         keyboard.doKeyPress(KeyCode.UP, KeyModifier.SHIFT);
2135         Toolkit.getToolkit().firePulse();
2136         assertEquals(2, sm.getSelectedItems().size());
2137         assertEquals(&quot;Row 3&quot;, sm.getSelectedItem());
2138         assertEquals(&quot;Row 3&quot;, sm.getSelectedItems().get(0));
2139     }
2140 
2141     @Test public void test_rt21444_down() {
2142         final int items = 8;
2143         tableView.getItems().clear();
2144         for (int i = 1; i &lt;= items; i++) {
2145             tableView.getItems().add(&quot;Row &quot; + i);
2146         }
2147 
2148         final MultipleSelectionModel sm = tableView.getSelectionModel();
2149         sm.setSelectionMode(SelectionMode.MULTIPLE);
2150         sm.clearAndSelect(3);
2151 
2152         assertEquals(3, sm.getSelectedIndex());
2153         assertEquals(&quot;Row 4&quot;, sm.getSelectedItem());
2154 
2155         keyboard.doKeyPress(KeyCode.DOWN, KeyModifier.SHIFT);
2156         Toolkit.getToolkit().firePulse();
2157         assertEquals(2, sm.getSelectedItems().size());
2158         assertEquals(&quot;Row 5&quot;, sm.getSelectedItem());
2159         assertEquals(&quot;Row 5&quot;, sm.getSelectedItems().get(1));
2160     }
2161 
2162     @Test public void test_rt21375_scenario_1a_down() {
2163         final int items = 8;
2164         tableView.getItems().clear();
2165         for (int i = 1; i &lt;= items; i++) {
2166             tableView.getItems().add(&quot;Row &quot; + i);
2167         }
2168 
2169         final MultipleSelectionModel sm = tableView.getSelectionModel();
2170         sm.setSelectionMode(SelectionMode.MULTIPLE);
2171         sm.clearAndSelect(0);
2172 
2173         keyboard.doKeyPress(KeyCode.DOWN, KeyModifier.getShortcutKey());
2174         keyboard.doKeyPress(KeyCode.DOWN, KeyModifier.getShortcutKey());
2175         keyboard.doKeyPress(KeyCode.DOWN, KeyModifier.SHIFT);
2176         Toolkit.getToolkit().firePulse();
2177         assertTrue(isSelected(0,1,2,3));
2178         assertEquals(4, sm.getSelectedItems().size());
2179     }
2180 
2181     @Test public void test_rt21375_scenario_1b_down() {
2182         final int items = 8;
2183         tableView.getItems().clear();
2184         for (int i = 1; i &lt;= items; i++) {
2185             tableView.getItems().add(&quot;Row &quot; + i);
2186         }
2187 
2188         final MultipleSelectionModel sm = tableView.getSelectionModel();
2189         sm.setSelectionMode(SelectionMode.MULTIPLE);
2190         sm.clearAndSelect(0);
2191 
2192         keyboard.doKeyPress(KeyCode.DOWN, KeyModifier.getShortcutKey());
2193         keyboard.doKeyPress(KeyCode.DOWN, KeyModifier.getShortcutKey());
2194         keyboard.doKeyPress(KeyCode.DOWN, KeyModifier.getShortcutKey(), KeyModifier.SHIFT);
2195         Toolkit.getToolkit().firePulse();
2196         assertTrue(isSelected(0,1,2,3));
2197         assertEquals(4, sm.getSelectedItems().size());
2198     }
2199 
2200     @Test public void test_rt21375_scenario_2_down() {
2201         final int items = 8;
2202         tableView.getItems().clear();
2203         for (int i = 1; i &lt;= items; i++) {
2204             tableView.getItems().add(&quot;Row &quot; + i);
2205         }
2206 
2207         final MultipleSelectionModel sm = tableView.getSelectionModel();
2208         sm.setSelectionMode(SelectionMode.MULTIPLE);
2209         sm.clearAndSelect(0);
2210 
2211         keyboard.doKeyPress(KeyCode.DOWN,  KeyModifier.getShortcutKey());
2212         keyboard.doKeyPress(KeyCode.DOWN,  KeyModifier.getShortcutKey());
2213         keyboard.doKeyPress(KeyCode.SPACE, KeyModifier.getShortcutKey(), PlatformUtil.isMac() ? KeyModifier.CTRL : null);
2214         keyboard.doKeyPress(KeyCode.DOWN,  KeyModifier.getShortcutKey());
2215         keyboard.doKeyPress(KeyCode.DOWN,  KeyModifier.SHIFT);
2216         Toolkit.getToolkit().firePulse();
2217         assertTrue(isSelected(2,3,4));
2218         assertEquals(3, sm.getSelectedItems().size());
2219     }
2220 
2221     @Test public void test_rt21375_scenario_3_down() {
2222         final int items = 8;
2223         tableView.getItems().clear();
2224         for (int i = 1; i &lt;= items; i++) {
2225             tableView.getItems().add(&quot;Row &quot; + i);
2226         }
2227 
2228         final MultipleSelectionModel sm = tableView.getSelectionModel();
2229         sm.setSelectionMode(SelectionMode.MULTIPLE);
2230         sm.clearAndSelect(0);
2231 
2232         keyboard.doKeyPress(KeyCode.DOWN,  KeyModifier.getShortcutKey());
2233         keyboard.doKeyPress(KeyCode.DOWN,  KeyModifier.getShortcutKey());
2234         keyboard.doKeyPress(KeyCode.SPACE, KeyModifier.getShortcutKey(), PlatformUtil.isMac() ? KeyModifier.CTRL : null);
2235         keyboard.doKeyPress(KeyCode.DOWN,  KeyModifier.getShortcutKey());
2236         keyboard.doKeyPress(KeyCode.DOWN,  KeyModifier.getShortcutKey(), KeyModifier.SHIFT);
2237         Toolkit.getToolkit().firePulse();
2238         assertTrue(isSelected(0,2,3,4));
2239         assertEquals(4, sm.getSelectedItems().size());
2240     }
2241 
2242     @Test public void test_rt21375_scenario_1a_up() {
2243         final int items = 8;
2244         tableView.getItems().clear();
2245         for (int i = 1; i &lt;= items; i++) {
2246             tableView.getItems().add(&quot;Row &quot; + i);
2247         }
2248 
2249         final MultipleSelectionModel sm = tableView.getSelectionModel();
2250         sm.setSelectionMode(SelectionMode.MULTIPLE);
2251         sm.clearAndSelect(7);
2252 
2253         keyboard.doKeyPress(KeyCode.UP, KeyModifier.getShortcutKey());
2254         keyboard.doKeyPress(KeyCode.UP, KeyModifier.getShortcutKey());
2255         keyboard.doKeyPress(KeyCode.UP, KeyModifier.SHIFT);
2256         Toolkit.getToolkit().firePulse();
2257         assertTrue(isSelected(7,6,5,4));
2258         assertEquals(4, sm.getSelectedItems().size());
2259     }
2260 
2261     @Test public void test_rt21375_scenario_1b_up() {
2262         final int items = 8;
2263         tableView.getItems().clear();
2264         for (int i = 1; i &lt;= items; i++) {
2265             tableView.getItems().add(&quot;Row &quot; + i);
2266         }
2267 
2268         final MultipleSelectionModel sm = tableView.getSelectionModel();
2269         sm.setSelectionMode(SelectionMode.MULTIPLE);
2270         sm.clearAndSelect(7);
2271 
2272         keyboard.doKeyPress(KeyCode.UP, KeyModifier.getShortcutKey());
2273         keyboard.doKeyPress(KeyCode.UP, KeyModifier.getShortcutKey());
2274         keyboard.doKeyPress(KeyCode.UP, KeyModifier.getShortcutKey(), KeyModifier.SHIFT);
2275         Toolkit.getToolkit().firePulse();
2276         assertTrue(isSelected(7, 6, 5, 4));
2277         assertEquals(4, sm.getSelectedItems().size());
2278     }
2279 
2280     @Test public void test_rt21375_scenario_2_up() {
2281         final int items = 8;
2282         tableView.getItems().clear();
2283         for (int i = 1; i &lt;= items; i++) {
2284             tableView.getItems().add(&quot;Row &quot; + i);
2285         }
2286 
2287         final MultipleSelectionModel sm = tableView.getSelectionModel();
2288         sm.setSelectionMode(SelectionMode.MULTIPLE);
2289         sm.clearAndSelect(7);
2290 
2291         keyboard.doKeyPress(KeyCode.UP,  KeyModifier.getShortcutKey());
2292         keyboard.doKeyPress(KeyCode.UP,  KeyModifier.getShortcutKey());
2293         keyboard.doKeyPress(KeyCode.SPACE, KeyModifier.getShortcutKey(), PlatformUtil.isMac() ? KeyModifier.CTRL : null);
2294         keyboard.doKeyPress(KeyCode.UP, KeyModifier.getShortcutKey());
2295         keyboard.doKeyPress(KeyCode.UP, KeyModifier.SHIFT);
2296         Toolkit.getToolkit().firePulse();
2297         assertTrue(isSelected(5, 4, 3));
2298         assertEquals(3, sm.getSelectedItems().size());
2299     }
2300 
2301     @Test public void test_rt21375_scenario_3_up() {
2302         final int items = 8;
2303         tableView.getItems().clear();
2304         for (int i = 1; i &lt;= items; i++) {
2305             tableView.getItems().add(&quot;Row &quot; + i);
2306         }
2307 
2308         final MultipleSelectionModel sm = tableView.getSelectionModel();
2309         sm.setSelectionMode(SelectionMode.MULTIPLE);
2310         sm.clearAndSelect(7);
2311 
2312         keyboard.doKeyPress(KeyCode.UP,  KeyModifier.getShortcutKey());
2313         keyboard.doKeyPress(KeyCode.UP,  KeyModifier.getShortcutKey());
2314         keyboard.doKeyPress(KeyCode.SPACE, KeyModifier.getShortcutKey(), PlatformUtil.isMac() ? KeyModifier.CTRL : null);
2315         keyboard.doKeyPress(KeyCode.UP, KeyModifier.getShortcutKey());
2316         keyboard.doKeyPress(KeyCode.UP, KeyModifier.getShortcutKey(), KeyModifier.SHIFT);
2317         Toolkit.getToolkit().firePulse();
2318         assertTrue(isSelected(7, 5, 4, 3));
2319         assertEquals(4, sm.getSelectedItems().size());
2320     }
2321 
2322     @Test public void test_rt33301_multipleSelection_down() {
2323         final int items = 5;
2324         tableView.getItems().clear();
2325         for (int i = 0; i &lt; items; i++) {
2326             tableView.getItems().add(&quot;Row &quot; + i);
2327         }
2328 
2329         final TableFocusModel fm = tableView.getFocusModel();
2330         final TableSelectionModel sm = tableView.getSelectionModel();
2331         sm.setSelectionMode(SelectionMode.MULTIPLE);
2332         sm.setCellSelectionEnabled(false);
2333         sm.clearAndSelect(2);
2334 
2335         keyboard.doKeyPress(KeyCode.DOWN,  KeyModifier.getShortcutKey(), KeyModifier.SHIFT); // row 3
2336         keyboard.doKeyPress(KeyCode.DOWN,  KeyModifier.getShortcutKey(), KeyModifier.SHIFT); // row 4
2337         Toolkit.getToolkit().firePulse();
2338         assertTrue(isNotSelected(0,1));
2339         assertTrue(isSelected(2,3,4));
2340         assertEquals(3, sm.getSelectedItems().size());
2341         assertTrue(fm.isFocused(4));
2342 
2343         keyboard.doKeyPress(KeyCode.DOWN,  KeyModifier.getShortcutKey(), KeyModifier.SHIFT); // should stay at row 4
2344         keyboard.doKeyPress(KeyCode.DOWN,  KeyModifier.getShortcutKey(), KeyModifier.SHIFT); // should stay at row 4
2345         keyboard.doKeyPress(KeyCode.DOWN,  KeyModifier.getShortcutKey(), KeyModifier.SHIFT); // should stay at row 4
2346         Toolkit.getToolkit().firePulse();
2347         assertTrue(isNotSelected(0,1));
2348         assertTrue(isSelected(2,3,4));
2349         assertEquals(3, sm.getSelectedItems().size());
2350         assertTrue(&quot;Focus index incorrectly at: &quot; + fm.getFocusedIndex(), fm.isFocused(4));
2351     }
2352 
2353     @Test public void test_rt33301_multipleSelection_up() {
2354         final int items = 5;
2355         tableView.getItems().clear();
2356         for (int i = 0; i &lt; items; i++) {
2357             tableView.getItems().add(&quot;Row &quot; + i);
2358         }
2359 
2360         final TableFocusModel fm = tableView.getFocusModel();
2361         final TableSelectionModel sm = tableView.getSelectionModel();
2362         sm.setSelectionMode(SelectionMode.MULTIPLE);
2363         sm.setCellSelectionEnabled(false);
2364         sm.clearAndSelect(2);
2365 
2366         keyboard.doKeyPress(KeyCode.UP, KeyModifier.getShortcutKey(), KeyModifier.SHIFT); // row 1
2367         keyboard.doKeyPress(KeyCode.UP, KeyModifier.getShortcutKey(), KeyModifier.SHIFT); // row 0
2368         Toolkit.getToolkit().firePulse();
2369         assertTrue(isNotSelected(3,4));
2370         assertTrue(isSelected(0,1,2));
2371         assertEquals(3, sm.getSelectedItems().size());
2372         assertTrue(fm.isFocused(0));
2373 
2374         keyboard.doKeyPress(KeyCode.UP,  KeyModifier.getShortcutKey(), KeyModifier.SHIFT); // should stay at row 0
2375         keyboard.doKeyPress(KeyCode.UP,  KeyModifier.getShortcutKey(), KeyModifier.SHIFT); // should stay at row 0
2376         keyboard.doKeyPress(KeyCode.UP,  KeyModifier.getShortcutKey(), KeyModifier.SHIFT); // should stay at row 0
2377         Toolkit.getToolkit().firePulse();
2378         assertTrue(isNotSelected(3, 4));
2379         assertTrue(isSelected(0,1,2));
2380         assertEquals(3, sm.getSelectedItems().size());
2381         assertTrue(fm.isFocused(0));
2382     }
2383 
2384     @Test public void test_rt33301_singleSelection_down() {
2385         final int items = 5;
2386         tableView.getItems().clear();
2387         for (int i = 0; i &lt; items; i++) {
2388             tableView.getItems().add(&quot;Row &quot; + i);
2389         }
2390 
2391         final TableFocusModel fm = tableView.getFocusModel();
2392         final TableSelectionModel sm = tableView.getSelectionModel();
2393         sm.setSelectionMode(SelectionMode.SINGLE);
2394         sm.setCellSelectionEnabled(false);
2395         sm.clearAndSelect(2);
2396 
2397         keyboard.doKeyPress(KeyCode.DOWN, KeyModifier.getShortcutKey(), KeyModifier.SHIFT); // row 3
2398         keyboard.doKeyPress(KeyCode.DOWN, KeyModifier.getShortcutKey(), KeyModifier.SHIFT); // row 4
2399         Toolkit.getToolkit().firePulse();
2400         assertTrue(isNotSelected(0,1,2,3));
2401         assertTrue(isSelected(4));
2402         assertEquals(1, sm.getSelectedItems().size());
2403         assertTrue(fm.isFocused(4));
2404 
2405         keyboard.doKeyPress(KeyCode.DOWN,  KeyModifier.getShortcutKey(), KeyModifier.SHIFT); // should stay at row 4
2406         keyboard.doKeyPress(KeyCode.DOWN,  KeyModifier.getShortcutKey(), KeyModifier.SHIFT); // should stay at row 4
2407         keyboard.doKeyPress(KeyCode.DOWN,  KeyModifier.getShortcutKey(), KeyModifier.SHIFT); // should stay at row 4
2408         Toolkit.getToolkit().firePulse();
2409         assertTrue(isNotSelected(0, 1, 2, 3));
2410         assertTrue(isSelected(4));
2411         assertEquals(1, sm.getSelectedItems().size());
2412         assertTrue(fm.isFocused(4));
2413     }
2414 
2415     @Test public void test_rt33301_singleSelection_up() {
2416         final int items = 5;
2417         tableView.getItems().clear();
2418         for (int i = 0; i &lt; items; i++) {
2419             tableView.getItems().add(&quot;Row &quot; + i);
2420         }
2421 
2422         final TableFocusModel fm = tableView.getFocusModel();
2423         final TableSelectionModel sm = tableView.getSelectionModel();
2424         sm.setSelectionMode(SelectionMode.SINGLE);
2425         sm.setCellSelectionEnabled(false);
2426         sm.clearAndSelect(2);
2427 
2428         keyboard.doKeyPress(KeyCode.UP,  KeyModifier.getShortcutKey(), KeyModifier.SHIFT); // row 1
2429         keyboard.doKeyPress(KeyCode.UP,  KeyModifier.getShortcutKey(), KeyModifier.SHIFT); // row 0
2430         Toolkit.getToolkit().firePulse();
2431         assertTrue(isNotSelected(1,2,3,4));
2432         assertTrue(isSelected(0));
2433         assertEquals(1, sm.getSelectedItems().size());
2434         assertTrue(fm.isFocused(0));
2435 
2436         keyboard.doKeyPress(KeyCode.UP,  KeyModifier.getShortcutKey(), KeyModifier.SHIFT); // should stay at row 0
2437         keyboard.doKeyPress(KeyCode.UP,  KeyModifier.getShortcutKey(), KeyModifier.SHIFT); // should stay at row 0
2438         keyboard.doKeyPress(KeyCode.UP,  KeyModifier.getShortcutKey(), KeyModifier.SHIFT); // should stay at row 0
2439         Toolkit.getToolkit().firePulse();
2440         assertTrue(isNotSelected(1,2,3,4));
2441         assertTrue(isSelected(0));
2442         assertEquals(1, sm.getSelectedItems().size());
2443         assertTrue(fm.isFocused(0));
2444     }
2445 
2446     @Test public void test_rt20915() {
2447         final FocusModel fm = tableView.getFocusModel();
2448         final MultipleSelectionModel sm = tableView.getSelectionModel();
2449         sm.clearAndSelect(0);
2450 
2451         keyboard.doKeyPress(KeyCode.DOWN, KeyModifier.getShortcutKey());
2452         keyboard.doKeyPress(KeyCode.DOWN, KeyModifier.getShortcutKey());
2453         keyboard.doKeyPress(KeyCode.DOWN, KeyModifier.getShortcutKey());
2454         Toolkit.getToolkit().firePulse();
2455         assertTrue(isNotSelected(1, 2, 3));
2456         assertTrue(isSelected(0));
2457         assertEquals(1, sm.getSelectedItems().size());
2458         assertTrue(fm.isFocused(3));
2459 
2460         keyboard.doKeyPress(KeyCode.SPACE,  KeyModifier.getShortcutKey(), KeyModifier.SHIFT);
2461         Toolkit.getToolkit().firePulse();
2462         assertTrue(isSelected(0, 1, 2, 3));
2463         assertEquals(4, sm.getSelectedItems().size());
2464         assertTrue(fm.isFocused(3));
2465     }
2466 
2467     @Test public void test_rt34200() {
2468         final int items = 100;
2469         tableView.getItems().clear();
2470         for (int i = 0; i &lt; items; i++) {
2471             tableView.getItems().add(&quot;Row &quot; + i);
2472         }
2473 
2474         sm.clearAndSelect(99);
2475         tableView.scrollTo(99);
2476         assertEquals(99, getAnchor().getRow());
2477         assertEquals(99, fm.getFocusedIndex());
2478 
2479         keyboard.doKeyPress(KeyCode.PAGE_UP, KeyModifier.getShortcutKey(), KeyModifier.SHIFT);
2480         Toolkit.getToolkit().firePulse();
2481         assertEquals(99, getAnchor().getRow());
2482         assertTrue(fm.getFocusedIndex() &lt; 99);
2483     }
2484 
2485     @Test public void test_rt34369_cellSelection() {
2486         final int items = 100;
2487         tableView.getItems().clear();
2488         for (int i = 0; i &lt; items; i++) {
2489             tableView.getItems().add(&quot;Row &quot; + i);
2490         }
2491 
2492         sm.setCellSelectionEnabled(true);
2493 
2494         sm.clearAndSelect(99, col0);
2495         tableView.scrollTo(99);
2496         assertEquals(99, getAnchor().getRow());
2497         assertEquals(col0, getAnchor().getTableColumn());
2498         assertEquals(99, fm.getFocusedIndex());
2499 
2500         keyboard.doKeyPress(KeyCode.PAGE_UP, KeyModifier.SHIFT);
2501         Toolkit.getToolkit().firePulse();
2502         assertEquals(99, getAnchor().getRow());
2503         assertEquals(col0, getAnchor().getTableColumn());
2504         assertTrue(fm.getFocusedIndex() &lt; 99);
2505     }
2506 
2507     @Test public void test_rt34369_rowSelection() {
2508         final int items = 100;
2509         tableView.getItems().clear();
2510         for (int i = 0; i &lt; items; i++) {
2511             tableView.getItems().add(&quot;Row &quot; + i);
2512         }
2513 
2514         sm.setCellSelectionEnabled(false);
2515 
2516         sm.clearAndSelect(99);
2517         tableView.scrollTo(99);
2518         assertEquals(99, getAnchor().getRow());
2519         assertEquals(99, fm.getFocusedIndex());
2520 
2521         keyboard.doKeyPress(KeyCode.PAGE_UP, KeyModifier.SHIFT);
2522         Toolkit.getToolkit().firePulse();
2523         assertEquals(99, getAnchor().getRow());
2524         assertTrue(fm.getFocusedIndex() &lt; 99);
2525     }
2526 
2527     @Test public void test_rt33894() {
2528         final int items = 5;
2529         tableView.getItems().clear();
2530         for (int i = 0; i &lt; items; i++) {
2531             tableView.getItems().add(&quot;Row &quot; + i);
2532         }
2533 
2534         sm.clearAndSelect(1);
2535         assertEquals(1, getAnchor().getRow());
2536         assertEquals(1, fm.getFocusedIndex());
2537         assertEquals(1, sm.getSelectedIndex());
2538 
2539         keyboard.doKeyPress(KeyCode.DOWN, KeyModifier.getShortcutKey());
2540         Toolkit.getToolkit().firePulse();
2541         assertEquals(1, getAnchor().getRow());
2542         assertEquals(2, fm.getFocusedIndex());
2543         assertEquals(1, sm.getSelectedIndex());
2544 
2545         keyboard.doKeyPress(KeyCode.SPACE, KeyModifier.getShortcutKey(), KeyModifier.SHIFT);
2546         Toolkit.getToolkit().firePulse();
2547         assertEquals(2, getAnchor().getRow());
2548         assertEquals(2, fm.getFocusedIndex());
2549         assertEquals(2, sm.getSelectedIndex());
2550         assertTrue(isSelected(1, 2));
2551 
2552         keyboard.doKeyPress(KeyCode.UP, KeyModifier.getShortcutKey());
2553         keyboard.doKeyPress(KeyCode.UP, KeyModifier.getShortcutKey());
2554         Toolkit.getToolkit().firePulse();
2555         assertEquals(2, getAnchor().getRow());
2556         assertEquals(0, fm.getFocusedIndex());
2557         assertEquals(2, sm.getSelectedIndex());
2558         assertTrue(isSelected(1, 2));
2559 
2560         keyboard.doKeyPress(KeyCode.SPACE, KeyModifier.getShortcutKey(), KeyModifier.SHIFT);
2561         Toolkit.getToolkit().firePulse();
2562         assertEquals(0, getAnchor().getRow());
2563         assertEquals(0, fm.getFocusedIndex());
2564         assertEquals(0, sm.getSelectedIndex());
2565         assertTrue(isSelected(0, 1, 2));
2566     }
2567 
2568     @Test public void test_rt34425() {
2569         final int items = 5;
2570         tableView.getItems().clear();
2571         for (int i = 0; i &lt; items; i++) {
2572             tableView.getItems().add(&quot;Row &quot; + i);
2573         }
2574 
2575         sm.clearAndSelect(1);
2576         assertEquals(1, getAnchor().getRow());
2577         assertEquals(1, fm.getFocusedIndex());
2578         assertEquals(1, sm.getSelectedIndex());
2579 
2580         keyboard.doKeyPress(KeyCode.DOWN, KeyModifier.getShortcutKey());
2581         Toolkit.getToolkit().firePulse();
2582         assertEquals(1, getAnchor().getRow());
2583         assertEquals(2, fm.getFocusedIndex());
2584         assertEquals(1, sm.getSelectedIndex());
2585 
2586         keyboard.doKeyPress(KeyCode.SPACE);
2587         Toolkit.getToolkit().firePulse();
2588         assertEquals(debug(), 2, getAnchor().getRow());
2589         assertEquals(2, fm.getFocusedIndex());
2590         assertEquals(2, sm.getSelectedIndex());
2591         assertTrue(isSelected(1, 2));
2592     }
2593 
2594     @Test public void test_rt33613_up_oneColumn() {
2595         final int items = 10;
2596         tableView.getItems().clear();
2597         for (int i = 0; i &lt; items; i++) {
2598             tableView.getItems().add(&quot;Row &quot; + i);
2599         }
2600 
2601         sm.setCellSelectionEnabled(true);
2602 
2603         sm.clearAndSelect(6, col0);
2604         assertEquals(6, getAnchor().getRow());
2605         assertEquals(0, getAnchor().getColumn());
2606         assertEquals(6, fm.getFocusedIndex());
2607         assertEquals(6, sm.getSelectedIndex());
2608 
2609         keyboard.doKeyPress(KeyCode.UP, KeyModifier.getShortcutKey());
2610         keyboard.doKeyPress(KeyCode.UP, KeyModifier.getShortcutKey());
2611         keyboard.doKeyPress(KeyCode.UP, KeyModifier.getShortcutKey());
2612         Toolkit.getToolkit().firePulse();
2613         assertEquals(6, getAnchor().getRow());
2614         assertEquals(0, getAnchor().getColumn());
2615         assertEquals(3, fm.getFocusedIndex());
2616         assertEquals(6, sm.getSelectedIndex());
2617 
2618         keyboard.doKeyPress(KeyCode.SPACE, KeyModifier.SHIFT);
2619         Toolkit.getToolkit().firePulse();
2620         assertEquals(6, getAnchor().getRow());
2621         assertEquals(0, getAnchor().getColumn());
2622         assertEquals(3, fm.getFocusedIndex());
2623         assertEquals(3, sm.getSelectedIndex());
2624     }
2625 
2626     @Test public void test_rt33613_up_multipleColumn_right() {
2627         final int items = 10;
2628         tableView.getItems().clear();
2629         for (int i = 0; i &lt; items; i++) {
2630             tableView.getItems().add(&quot;Row &quot; + i);
2631         }
2632 
2633         sm.setCellSelectionEnabled(true);
2634 
2635         sm.clearAndSelect(6, col0);
2636         assertEquals(6, getAnchor().getRow());
2637         assertEquals(0, getAnchor().getColumn());
2638         assertTrue(fm.isFocused(6, col0));
2639         assertTrue(sm.isSelected(6, col0));
2640 
2641         keyboard.doKeyPress(KeyCode.UP, KeyModifier.getShortcutKey());
2642         keyboard.doKeyPress(KeyCode.UP, KeyModifier.getShortcutKey());
2643         keyboard.doKeyPress(KeyCode.UP, KeyModifier.getShortcutKey());
2644         keyboard.doKeyPress(KeyCode.RIGHT, KeyModifier.getShortcutKey());
2645         Toolkit.getToolkit().firePulse();
2646         assertEquals(6, getAnchor().getRow());
2647         assertEquals(0, getAnchor().getColumn());
2648         assertTrue(fm.isFocused(3, col1));
2649         assertTrue(sm.isSelected(6, col0));
2650         assertFalse(sm.isSelected(3, col1));
2651 
2652         keyboard.doKeyPress(KeyCode.SPACE, KeyModifier.SHIFT);
2653         Toolkit.getToolkit().firePulse();
2654         assertEquals(6, getAnchor().getRow());
2655         assertEquals(0, getAnchor().getColumn());
2656         assertTrue(fm.isFocused(3, col1));
2657         assertTrue(sm.isSelected(3, col1));
2658         assertTrue(sm.isSelected(6, col0));
2659     }
2660 
2661     @Test public void test_rt33613_up_multipleColumn_left() {
2662         final int items = 10;
2663         tableView.getItems().clear();
2664         for (int i = 0; i &lt; items; i++) {
2665             tableView.getItems().add(&quot;Row &quot; + i);
2666         }
2667 
2668         sm.setCellSelectionEnabled(true);
2669 
2670         sm.clearAndSelect(6, col1);
2671         assertEquals(6, getAnchor().getRow());
2672         assertEquals(1, getAnchor().getColumn());
2673         assertTrue(fm.isFocused(6, col1));
2674         assertTrue(sm.isSelected(6, col1));
2675 
2676         keyboard.doKeyPress(KeyCode.UP, KeyModifier.getShortcutKey());
2677         keyboard.doKeyPress(KeyCode.UP, KeyModifier.getShortcutKey());
2678         keyboard.doKeyPress(KeyCode.UP, KeyModifier.getShortcutKey());
2679         keyboard.doKeyPress(KeyCode.LEFT, KeyModifier.getShortcutKey());
2680         Toolkit.getToolkit().firePulse();
2681         assertEquals(6, getAnchor().getRow());
2682         assertEquals(1, getAnchor().getColumn());
2683         assertTrue(fm.isFocused(3, col0));
2684         assertTrue(sm.isSelected(6, col1));
2685         assertFalse(sm.isSelected(3, col0));
2686 
2687         keyboard.doKeyPress(KeyCode.SPACE, KeyModifier.SHIFT);
2688         Toolkit.getToolkit().firePulse();
2689         assertEquals(6, getAnchor().getRow());
2690         assertEquals(1, getAnchor().getColumn());
2691         assertTrue(fm.isFocused(3, col0));
2692         assertTrue(sm.isSelected(3, col0));
2693         assertTrue(sm.isSelected(6, col1));
2694     }
2695 
2696     @Test public void test_rt33613_down_oneColumn() {
2697         final int items = 10;
2698         tableView.getItems().clear();
2699         for (int i = 0; i &lt; items; i++) {
2700             tableView.getItems().add(&quot;Row &quot; + i);
2701         }
2702 
2703         sm.setCellSelectionEnabled(true);
2704 
2705         sm.clearAndSelect(3, col0);
2706         assertEquals(3, getAnchor().getRow());
2707         assertEquals(0, getAnchor().getColumn());
2708         assertEquals(3, fm.getFocusedIndex());
2709         assertEquals(3, sm.getSelectedIndex());
2710 
2711         keyboard.doKeyPress(KeyCode.DOWN, KeyModifier.getShortcutKey());
2712         keyboard.doKeyPress(KeyCode.DOWN, KeyModifier.getShortcutKey());
2713         keyboard.doKeyPress(KeyCode.DOWN, KeyModifier.getShortcutKey());
2714         Toolkit.getToolkit().firePulse();
2715         assertEquals(3, getAnchor().getRow());
2716         assertEquals(0, getAnchor().getColumn());
2717         assertEquals(6, fm.getFocusedIndex());
2718         assertEquals(3, sm.getSelectedIndex());
2719 
2720         keyboard.doKeyPress(KeyCode.SPACE, KeyModifier.SHIFT);
2721         Toolkit.getToolkit().firePulse();
2722         assertEquals(3, getAnchor().getRow());
2723         assertEquals(0, getAnchor().getColumn());
2724         assertEquals(6, fm.getFocusedIndex());
2725         assertEquals(6, sm.getSelectedIndex());
2726     }
2727 
2728     @Test public void test_rt33613_down_multipleColumn_right() {
2729         final int items = 10;
2730         tableView.getItems().clear();
2731         for (int i = 0; i &lt; items; i++) {
2732             tableView.getItems().add(&quot;Row &quot; + i);
2733         }
2734 
2735         sm.setCellSelectionEnabled(true);
2736 
2737         sm.clearAndSelect(3, col0);
2738         assertEquals(3, getAnchor().getRow());
2739         assertEquals(0, getAnchor().getColumn());
2740         assertTrue(fm.isFocused(3, col0));
2741         assertTrue(sm.isSelected(3, col0));
2742 
2743         keyboard.doKeyPress(KeyCode.DOWN, KeyModifier.getShortcutKey());
2744         keyboard.doKeyPress(KeyCode.DOWN, KeyModifier.getShortcutKey());
2745         keyboard.doKeyPress(KeyCode.DOWN, KeyModifier.getShortcutKey());
2746         keyboard.doKeyPress(KeyCode.RIGHT, KeyModifier.getShortcutKey());
2747         Toolkit.getToolkit().firePulse();
2748         assertEquals(3, getAnchor().getRow());
2749         assertEquals(0, getAnchor().getColumn());
2750         assertTrue(fm.isFocused(6, col1));
2751         assertTrue(sm.isSelected(3, col0));
2752         assertFalse(sm.isSelected(6, col1));
2753 
2754         keyboard.doKeyPress(KeyCode.SPACE, KeyModifier.SHIFT);
2755         Toolkit.getToolkit().firePulse();
2756         assertEquals(3, getAnchor().getRow());
2757         assertEquals(0, getAnchor().getColumn());
2758         assertTrue(fm.isFocused(6, col1));
2759         assertTrue(sm.isSelected(6, col1));
2760         assertTrue(sm.isSelected(3, col0));
2761     }
2762 
2763     @Test public void test_rt33613_down_multipleColumn_left() {
2764         final int items = 10;
2765         tableView.getItems().clear();
2766         for (int i = 0; i &lt; items; i++) {
2767             tableView.getItems().add(&quot;Row &quot; + i);
2768         }
2769 
2770         sm.setCellSelectionEnabled(true);
2771 
2772         sm.clearAndSelect(3, col1);
2773         assertEquals(3, getAnchor().getRow());
2774         assertEquals(1, getAnchor().getColumn());
2775         assertTrue(fm.isFocused(3, col1));
2776         assertTrue(sm.isSelected(3, col1));
2777 
2778         keyboard.doKeyPress(KeyCode.DOWN, KeyModifier.getShortcutKey());
2779         keyboard.doKeyPress(KeyCode.DOWN, KeyModifier.getShortcutKey());
2780         keyboard.doKeyPress(KeyCode.DOWN, KeyModifier.getShortcutKey());
2781         keyboard.doKeyPress(KeyCode.LEFT, KeyModifier.getShortcutKey());
2782         assertEquals(3, getAnchor().getRow());
2783         assertEquals(1, getAnchor().getColumn());
2784         assertTrue(fm.isFocused(6, col0));
2785         assertTrue(sm.isSelected(3, col1));
2786         assertFalse(sm.isSelected(6, col0));
2787 
2788         keyboard.doKeyPress(KeyCode.SPACE, KeyModifier.SHIFT);
2789         assertEquals(3, getAnchor().getRow());
2790         assertEquals(1, getAnchor().getColumn());
2791         assertTrue(fm.isFocused(6, col0));
2792         assertTrue(sm.isSelected(6, col0));
2793         assertTrue(sm.isSelected(3, col1));
2794     }
2795 
2796     @Test public void test_rt18439() {
2797         final int items = 10;
2798         tableView.getItems().clear();
2799         for (int i = 0; i &lt; items; i++) {
2800             tableView.getItems().add(&quot;Row &quot; + i);
2801         }
2802 
2803         sm.setCellSelectionEnabled(true);
2804         sm.setSelectionMode(SelectionMode.MULTIPLE);
2805 
2806         sm.clearAndSelect(0, col0);
2807 
2808         keyboard.doKeyPress(KeyCode.RIGHT, KeyModifier.SHIFT); // col 1
2809         keyboard.doKeyPress(KeyCode.RIGHT, KeyModifier.SHIFT); // col 2
2810         keyboard.doKeyPress(KeyCode.RIGHT, KeyModifier.SHIFT); // col 3
2811         keyboard.doKeyPress(KeyCode.RIGHT, KeyModifier.SHIFT); // col 4
2812         assertEquals(0, getAnchor().getRow());
2813         assertEquals(0, getAnchor().getColumn());              // anchor does not move
2814         assertTrue(fm.isFocused(0, col4));
2815         assertTrue(sm.isSelected(0, col0));
2816         assertTrue(sm.isSelected(0, col1));
2817         assertTrue(sm.isSelected(0, col2));
2818         assertTrue(sm.isSelected(0, col3));
2819         assertTrue(sm.isSelected(0, col4));
2820 
2821         keyboard.doKeyPress(KeyCode.DOWN, KeyModifier.SHIFT); // row 1
2822         keyboard.doKeyPress(KeyCode.DOWN, KeyModifier.SHIFT); // row 2
2823         assertEquals(0, getAnchor().getRow());
2824         assertEquals(0, getAnchor().getColumn());             // anchor does not move
2825         assertTrue(fm.isFocused(2, col4));
2826         assertTrue(sm.isSelected(0, col0));
2827         assertTrue(sm.isSelected(0, col1));
2828         assertTrue(sm.isSelected(0, col2));
2829         assertTrue(sm.isSelected(0, col3));
2830         assertTrue(sm.isSelected(0, col4));
2831         assertTrue(sm.isSelected(1, col4));
2832         assertTrue(sm.isSelected(2, col4));
2833 
2834         keyboard.doKeyPress(KeyCode.LEFT, KeyModifier.SHIFT); // col 3
2835         keyboard.doKeyPress(KeyCode.LEFT, KeyModifier.SHIFT); // col 2
2836         keyboard.doKeyPress(KeyCode.LEFT, KeyModifier.SHIFT); // col 1
2837         keyboard.doKeyPress(KeyCode.LEFT, KeyModifier.SHIFT); // col 0
2838         assertEquals(0, getAnchor().getRow());
2839         assertEquals(0, getAnchor().getColumn());             // anchor does not move
2840         assertTrue(fm.isFocused(2, col0));
2841         assertTrue(sm.isSelected(0, col0));
2842         assertTrue(sm.isSelected(0, col1));
2843         assertTrue(sm.isSelected(0, col2));
2844         assertTrue(sm.isSelected(0, col3));
2845         assertTrue(sm.isSelected(0, col4));
2846         assertTrue(sm.isSelected(1, col4));
2847         assertTrue(sm.isSelected(2, col4));
2848         assertTrue(sm.isSelected(2, col3));
2849         assertTrue(sm.isSelected(2, col2));
2850         assertTrue(sm.isSelected(2, col1));
2851         assertTrue(sm.isSelected(2, col0));
2852 
2853         keyboard.doKeyPress(KeyCode.UP, KeyModifier.SHIFT); // row 1
2854         keyboard.doKeyPress(KeyCode.UP, KeyModifier.SHIFT); // row 0
2855         assertEquals(0, getAnchor().getRow());
2856         assertEquals(0, getAnchor().getColumn());           // anchor does not move
2857         assertTrue(fm.isFocused(0, col0));
2858         assertFalse(sm.isSelected(0, col0));                // we&#39;ve gone right around - this cell is now unselected
2859         assertTrue(sm.isSelected(0, col1));
2860         assertTrue(sm.isSelected(0, col2));
2861         assertTrue(sm.isSelected(0, col3));
2862         assertTrue(sm.isSelected(0, col4));
2863         assertTrue(sm.isSelected(1, col4));
2864         assertTrue(sm.isSelected(2, col4));
2865         assertTrue(sm.isSelected(2, col3));
2866         assertTrue(sm.isSelected(2, col2));
2867         assertTrue(sm.isSelected(2, col1));
2868         assertTrue(sm.isSelected(2, col0));
2869         assertTrue(sm.isSelected(1, col0));
2870     }
2871 
2872     // this is an extension of the previous test, where we had a bug where going up resulted in all cells between the
2873     // anchor (at (0,0)) and the first selected cell in column 0 were being selected. This wasn&#39;t visible in the previous
2874     // test as we only went down two rows, so when we went up everything looked as expected
2875     @Test public void test_rt18439_startAt_row0_col0_clockwise() {
2876         final int items = 10;
2877         tableView.getItems().clear();
2878         for (int i = 0; i &lt; items; i++) {
2879             tableView.getItems().add(&quot;Row &quot; + i);
2880         }
2881 
2882         sm.setCellSelectionEnabled(true);
2883         sm.setSelectionMode(SelectionMode.MULTIPLE);
2884 
2885         sm.clearAndSelect(0, col0);
2886 
2887         keyboard.doKeyPress(KeyCode.RIGHT, KeyModifier.SHIFT); // col 1
2888         keyboard.doKeyPress(KeyCode.RIGHT, KeyModifier.SHIFT); // col 2
2889         keyboard.doKeyPress(KeyCode.RIGHT, KeyModifier.SHIFT); // col 3
2890         keyboard.doKeyPress(KeyCode.RIGHT, KeyModifier.SHIFT); // col 4
2891 
2892         keyboard.doKeyPress(KeyCode.DOWN, KeyModifier.SHIFT); // row 1
2893         keyboard.doKeyPress(KeyCode.DOWN, KeyModifier.SHIFT); // row 2
2894         keyboard.doKeyPress(KeyCode.DOWN, KeyModifier.SHIFT); // row 3
2895         keyboard.doKeyPress(KeyCode.DOWN, KeyModifier.SHIFT); // row 4
2896 
2897         keyboard.doKeyPress(KeyCode.LEFT, KeyModifier.SHIFT); // col 3
2898         keyboard.doKeyPress(KeyCode.LEFT, KeyModifier.SHIFT); // col 2
2899         keyboard.doKeyPress(KeyCode.LEFT, KeyModifier.SHIFT); // col 1
2900         keyboard.doKeyPress(KeyCode.LEFT, KeyModifier.SHIFT); // col 0
2901 
2902         keyboard.doKeyPress(KeyCode.UP, KeyModifier.SHIFT); // row 3
2903         assertEquals(0, getAnchor().getRow());
2904         assertEquals(0, getAnchor().getColumn());           // anchor does not move
2905         assertTrue(fm.isFocused(3, col0));
2906         assertTrue(sm.isSelected(0, col0));
2907         assertTrue(sm.isSelected(0, col1));
2908         assertTrue(sm.isSelected(0, col2));
2909         assertTrue(sm.isSelected(0, col3));
2910         assertTrue(sm.isSelected(0, col4));
2911         assertTrue(sm.isSelected(1, col4));
2912         assertTrue(sm.isSelected(2, col4));
2913         assertTrue(sm.isSelected(3, col4));
2914         assertTrue(sm.isSelected(4, col4));
2915         assertTrue(sm.isSelected(4, col3));
2916         assertTrue(sm.isSelected(4, col2));
2917         assertTrue(sm.isSelected(4, col1));
2918         assertTrue(sm.isSelected(4, col0));
2919         assertTrue(sm.isSelected(3, col0));
2920 
2921         // critical part - these cells should not be selected!
2922         assertFalse(sm.isSelected(1, col0));
2923         assertFalse(sm.isSelected(2, col0));
2924     }
2925 
2926     @Test public void test_rt18439_startAt_row0_col4_clockwise() {
2927         final int items = 10;
2928         tableView.getItems().clear();
2929         for (int i = 0; i &lt; items; i++) {
2930             tableView.getItems().add(&quot;Row &quot; + i);
2931         }
2932 
2933         sm.setCellSelectionEnabled(true);
2934         sm.setSelectionMode(SelectionMode.MULTIPLE);
2935 
2936         sm.clearAndSelect(0, col4);
2937 
2938         keyboard.doKeyPress(KeyCode.DOWN, KeyModifier.SHIFT); // row 1
2939         keyboard.doKeyPress(KeyCode.DOWN, KeyModifier.SHIFT); // row 2
2940         keyboard.doKeyPress(KeyCode.DOWN, KeyModifier.SHIFT); // row 3
2941         keyboard.doKeyPress(KeyCode.DOWN, KeyModifier.SHIFT); // row 4
2942 
2943         keyboard.doKeyPress(KeyCode.LEFT, KeyModifier.SHIFT); // col 3
2944         keyboard.doKeyPress(KeyCode.LEFT, KeyModifier.SHIFT); // col 2
2945         keyboard.doKeyPress(KeyCode.LEFT, KeyModifier.SHIFT); // col 1
2946         keyboard.doKeyPress(KeyCode.LEFT, KeyModifier.SHIFT); // col 0
2947 
2948         keyboard.doKeyPress(KeyCode.UP, KeyModifier.SHIFT);   // row 3
2949         keyboard.doKeyPress(KeyCode.UP, KeyModifier.SHIFT);   // row 2
2950         keyboard.doKeyPress(KeyCode.UP, KeyModifier.SHIFT);   // row 1
2951         keyboard.doKeyPress(KeyCode.UP, KeyModifier.SHIFT);   // row 0
2952 
2953         keyboard.doKeyPress(KeyCode.RIGHT, KeyModifier.SHIFT); // col 1
2954         assertEquals(0, getAnchor().getRow());
2955         assertEquals(4, getAnchor().getColumn());           // anchor does not move
2956         assertTrue(fm.isFocused(0, col1));
2957         assertTrue(sm.isSelected(0, col4));
2958         assertTrue(sm.isSelected(1, col4));
2959         assertTrue(sm.isSelected(2, col4));
2960         assertTrue(sm.isSelected(3, col4));
2961         assertTrue(sm.isSelected(4, col4));
2962         assertTrue(sm.isSelected(4, col3));
2963         assertTrue(sm.isSelected(4, col2));
2964         assertTrue(sm.isSelected(4, col1));
2965         assertTrue(sm.isSelected(4, col0));
2966         assertTrue(sm.isSelected(3, col0));
2967         assertTrue(sm.isSelected(2, col0));
2968         assertTrue(sm.isSelected(1, col0));
2969         assertTrue(sm.isSelected(0, col0));
2970         assertTrue(sm.isSelected(0, col1));
2971 
2972         // critical part - these cells should not be selected!
2973         assertFalse(sm.isSelected(0, col2));
2974         assertFalse(sm.isSelected(0, col3));
2975     }
2976 
2977     @Test public void test_rt18439_startAt_row4_col4_clockwise() {
2978         final int items = 10;
2979         tableView.getItems().clear();
2980         for (int i = 0; i &lt; items; i++) {
2981             tableView.getItems().add(&quot;Row &quot; + i);
2982         }
2983 
2984         sm.setCellSelectionEnabled(true);
2985         sm.setSelectionMode(SelectionMode.MULTIPLE);
2986 
2987         sm.clearAndSelect(4, col4);
2988 
2989         keyboard.doKeyPress(KeyCode.LEFT, KeyModifier.SHIFT); // col 3
2990         keyboard.doKeyPress(KeyCode.LEFT, KeyModifier.SHIFT); // col 2
2991         keyboard.doKeyPress(KeyCode.LEFT, KeyModifier.SHIFT); // col 1
2992         keyboard.doKeyPress(KeyCode.LEFT, KeyModifier.SHIFT); // col 0
2993 
2994         keyboard.doKeyPress(KeyCode.UP, KeyModifier.SHIFT);   // row 3
2995         keyboard.doKeyPress(KeyCode.UP, KeyModifier.SHIFT);   // row 2
2996         keyboard.doKeyPress(KeyCode.UP, KeyModifier.SHIFT);   // row 1
2997         keyboard.doKeyPress(KeyCode.UP, KeyModifier.SHIFT);   // row 0
2998 
2999         keyboard.doKeyPress(KeyCode.RIGHT, KeyModifier.SHIFT); // col 1
3000         keyboard.doKeyPress(KeyCode.RIGHT, KeyModifier.SHIFT); // col 2
3001         keyboard.doKeyPress(KeyCode.RIGHT, KeyModifier.SHIFT); // col 3
3002         keyboard.doKeyPress(KeyCode.RIGHT, KeyModifier.SHIFT); // col 4
3003 
3004         keyboard.doKeyPress(KeyCode.DOWN, KeyModifier.SHIFT); // row 1
3005         assertEquals(4, getAnchor().getRow());
3006         assertEquals(4, getAnchor().getColumn());           // anchor does not move
3007         assertTrue(fm.isFocused(1, col4));
3008         assertTrue(sm.isSelected(4, col4));
3009         assertTrue(sm.isSelected(4, col2));
3010         assertTrue(sm.isSelected(4, col2));
3011         assertTrue(sm.isSelected(4, col1));
3012         assertTrue(sm.isSelected(4, col0));
3013         assertTrue(sm.isSelected(3, col0));
3014         assertTrue(sm.isSelected(2, col0));
3015         assertTrue(sm.isSelected(1, col0));
3016         assertTrue(sm.isSelected(0, col0));
3017         assertTrue(sm.isSelected(0, col1));
3018         assertTrue(sm.isSelected(0, col2));
3019         assertTrue(sm.isSelected(0, col3));
3020         assertTrue(sm.isSelected(0, col4));
3021         assertTrue(sm.isSelected(1, col4));
3022 
3023         // critical part - these cells should not be selected!
3024         assertFalse(sm.isSelected(2, col4));
3025         assertFalse(sm.isSelected(3, col4));
3026     }
3027 
3028     @Test public void test_rt18439_startAt_row4_col0_clockwise() {
3029         final int items = 10;
3030         tableView.getItems().clear();
3031         for (int i = 0; i &lt; items; i++) {
3032             tableView.getItems().add(&quot;Row &quot; + i);
3033         }
3034 
3035         sm.setCellSelectionEnabled(true);
3036         sm.setSelectionMode(SelectionMode.MULTIPLE);
3037 
3038         sm.clearAndSelect(4, col0);
3039 
3040         keyboard.doKeyPress(KeyCode.UP, KeyModifier.SHIFT); // row 3
3041         keyboard.doKeyPress(KeyCode.UP, KeyModifier.SHIFT); // row 2
3042         keyboard.doKeyPress(KeyCode.UP, KeyModifier.SHIFT); // row 1
3043         keyboard.doKeyPress(KeyCode.UP, KeyModifier.SHIFT); // row 0
3044 
3045         keyboard.doKeyPress(KeyCode.RIGHT, KeyModifier.SHIFT);   // col 1
3046         keyboard.doKeyPress(KeyCode.RIGHT, KeyModifier.SHIFT);   // col 2
3047         keyboard.doKeyPress(KeyCode.RIGHT, KeyModifier.SHIFT);   // col 3
3048         keyboard.doKeyPress(KeyCode.RIGHT, KeyModifier.SHIFT);   // col 4
3049 
3050         keyboard.doKeyPress(KeyCode.DOWN, KeyModifier.SHIFT); // row 1
3051         keyboard.doKeyPress(KeyCode.DOWN, KeyModifier.SHIFT); // row 2
3052         keyboard.doKeyPress(KeyCode.DOWN, KeyModifier.SHIFT); // row 3
3053         keyboard.doKeyPress(KeyCode.DOWN, KeyModifier.SHIFT); // row 4
3054 
3055         keyboard.doKeyPress(KeyCode.LEFT, KeyModifier.SHIFT); // col 3
3056         assertEquals(4, getAnchor().getRow());
3057         assertEquals(0, getAnchor().getColumn());           // anchor does not move
3058         assertTrue(fm.isFocused(4, col3));
3059         assertTrue(sm.isSelected(4, col0));
3060         assertTrue(sm.isSelected(3, col0));
3061         assertTrue(sm.isSelected(2, col0));
3062         assertTrue(sm.isSelected(1, col0));
3063         assertTrue(sm.isSelected(0, col0));
3064         assertTrue(sm.isSelected(0, col1));
3065         assertTrue(sm.isSelected(0, col2));
3066         assertTrue(sm.isSelected(0, col3));
3067         assertTrue(sm.isSelected(0, col4));
3068         assertTrue(sm.isSelected(1, col4));
3069         assertTrue(sm.isSelected(2, col4));
3070         assertTrue(sm.isSelected(3, col4));
3071         assertTrue(sm.isSelected(4, col4));
3072         assertTrue(sm.isSelected(4, col3));
3073 
3074         // critical part - these cells should not be selected!
3075         assertFalse(sm.isSelected(4, col2));
3076         assertFalse(sm.isSelected(4, col1));
3077     }
3078 
3079     @Test public void test_rt34461_cellSelection() {
3080         final int items = 10;
3081         tableView.getItems().clear();
3082         for (int i = 0; i &lt; items; i++) {
3083             tableView.getItems().add(&quot;Row &quot; + i);
3084         }
3085 
3086         sm.setCellSelectionEnabled(true);
3087         sm.setSelectionMode(SelectionMode.MULTIPLE);
3088 
3089         sm.clearAndSelect(0, col0);
3090         assertEquals(0, getAnchor().getRow());
3091         assertEquals(0, getAnchor().getColumn());
3092         assertTrue(fm.isFocused(0, col0));
3093         assertTrue(sm.isSelected(0, col0));
3094         assertFalse(sm.isSelected(1, col0));
3095 
3096         keyboard.doKeyPress(KeyCode.DOWN, KeyModifier.getShortcutKey());
3097         assertEquals(0, getAnchor().getRow());
3098         assertEquals(0, getAnchor().getColumn());
3099         assertTrue(fm.isFocused(1, col0));
3100         assertTrue(sm.isSelected(0, col0));
3101         assertFalse(sm.isSelected(1, col0));
3102 
3103         keyboard.doKeyPress(KeyCode.SPACE);
3104         assertEquals(1, getAnchor().getRow());      // new anchor point
3105         assertEquals(0, getAnchor().getColumn());
3106         assertTrue(fm.isFocused(1, col0));
3107         assertTrue(sm.isSelected(0, col0));
3108         assertTrue(sm.isSelected(1, col0));
3109 
3110         keyboard.doKeyPress(KeyCode.DOWN, KeyModifier.SHIFT);
3111         assertEquals(1, getAnchor().getRow());
3112         assertEquals(0, getAnchor().getColumn());
3113         assertTrue(fm.isFocused(2, col0));
3114         assertFalse(sm.isSelected(0, col0));    // selection moves off here as the anchor point moved with the space
3115         assertTrue(sm.isSelected(1, col0));
3116         assertTrue(sm.isSelected(2, col0));
3117     }
3118 
3119     @Test public void test_rt34461_rowSelection() {
3120         final int items = 10;
3121         tableView.getItems().clear();
3122         for (int i = 0; i &lt; items; i++) {
3123             tableView.getItems().add(&quot;Row &quot; + i);
3124         }
3125 
3126         sm.setCellSelectionEnabled(false);
3127         sm.setSelectionMode(SelectionMode.MULTIPLE);
3128 
3129         sm.clearAndSelect(0);
3130         assertEquals(0, getAnchor().getRow());
3131         assertEquals(-1, getAnchor().getColumn());
3132         assertTrue(fm.isFocused(0));
3133         assertTrue(sm.isSelected(0));
3134         assertFalse(sm.isSelected(1));
3135 
3136         keyboard.doKeyPress(KeyCode.DOWN, KeyModifier.getShortcutKey());
3137         assertEquals(0, getAnchor().getRow());
3138         assertEquals(-1, getAnchor().getColumn());
3139         assertTrue(fm.isFocused(1));
3140         assertTrue(sm.isSelected(0));
3141         assertFalse(sm.isSelected(1));
3142 
3143         keyboard.doKeyPress(KeyCode.SPACE);
3144         assertEquals(1, getAnchor().getRow());      // new anchor point
3145         assertEquals(-1, getAnchor().getColumn());
3146         assertTrue(fm.isFocused(1));
3147         assertTrue(sm.isSelected(0));
3148         assertTrue(sm.isSelected(1));
3149 
3150         keyboard.doKeyPress(KeyCode.DOWN, KeyModifier.SHIFT);
3151         assertEquals(1, getAnchor().getRow());
3152         assertEquals(-1, getAnchor().getColumn());
3153         assertTrue(fm.isFocused(2));
3154         assertFalse(sm.isSelected(0));    // selection moves off here as the anchor point moved with the space
3155         assertTrue(sm.isSelected(1));
3156         assertTrue(sm.isSelected(2));
3157     }
3158 
3159     @Test public void test_rt34407_down_down_up() {
3160         final int items = 100;
3161         tableView.getItems().clear();
3162         for (int i = 0; i &lt; items; i++) {
3163             tableView.getItems().add(&quot;Row &quot; + i);
3164         }
3165         tableView.setPrefHeight(130); // roughly room for four rows
3166 
3167         StageLoader sl = new StageLoader(tableView);
3168         sm.setCellSelectionEnabled(false);
3169         sm.setSelectionMode(SelectionMode.MULTIPLE);
3170 
3171         sm.clearAndSelect(0);
3172         fm.focus(0);
3173         assertEquals(0, getAnchor().getRow());
3174         assertEquals(-1, getAnchor().getColumn());
3175         assertTrue(fm.isFocused(0));
3176         assertTrue(sm.isSelected(0));
3177         assertFalse(sm.isSelected(1));
3178 
3179         // we expect the final Page-up to return us back to this selected index and with the same number of selected indices
3180         keyboard.doKeyPress(KeyCode.PAGE_DOWN, KeyModifier.SHIFT);
3181         final int leadSelectedIndex = sm.getSelectedIndex();
3182         final int selectedIndicesCount = sm.getSelectedIndices().size();
3183         assertEquals(3, leadSelectedIndex);
3184         assertEquals(3, fm.getFocusedIndex());
3185         assertEquals(4, selectedIndicesCount);
3186 
3187         keyboard.doKeyPress(KeyCode.PAGE_DOWN, KeyModifier.SHIFT);
3188         assertEquals(leadSelectedIndex * 2, sm.getSelectedIndex());
3189         assertEquals(leadSelectedIndex * 2, fm.getFocusedIndex());
3190         assertEquals(selectedIndicesCount * 2 - 1, sm.getSelectedIndices().size());
3191 
3192         keyboard.doKeyPress(KeyCode.PAGE_UP, KeyModifier.SHIFT);
3193         assertEquals(leadSelectedIndex, sm.getSelectedIndex());
3194         assertEquals(leadSelectedIndex, fm.getFocusedIndex());
3195         assertEquals(selectedIndicesCount, sm.getSelectedIndices().size());
3196 
3197         sl.dispose();
3198     }
3199 
3200     @Test public void test_rt34407_up_up_down() {
3201         final int items = 100;
3202         tableView.getItems().clear();
3203         for (int i = 0; i &lt; items; i++) {
3204             tableView.getItems().add(&quot;Row &quot; + i);
3205         }
3206         tableView.setPrefHeight(130); // roughly room for four rows
3207 
3208         StageLoader sl = new StageLoader(tableView);
3209         sm.setCellSelectionEnabled(false);
3210         sm.setSelectionMode(SelectionMode.MULTIPLE);
3211 
3212         sm.clearAndSelect(99);
3213         fm.focus(99);
3214         tableView.scrollTo(99);
3215         Toolkit.getToolkit().firePulse();
3216 
3217         assertEquals(99, getAnchor().getRow());
3218         assertEquals(-1, getAnchor().getColumn());
3219         assertTrue(fm.isFocused(99));
3220         assertTrue(sm.isSelected(99));
3221         assertFalse(sm.isSelected(98));
3222 
3223         // we expect the final Page-down to return us back to this selected index and with the same number of selected indices
3224         keyboard.doKeyPress(KeyCode.PAGE_UP, KeyModifier.SHIFT);
3225         final int leadSelectedIndex = sm.getSelectedIndex();
3226         final int selectedIndicesCount = sm.getSelectedIndices().size();
3227         final int diff = 99 - leadSelectedIndex;
3228         assertEquals(99 - diff, leadSelectedIndex);
3229         assertEquals(99 - diff, fm.getFocusedIndex());
3230         assertEquals(4, selectedIndicesCount);
3231 
3232         keyboard.doKeyPress(KeyCode.PAGE_UP, KeyModifier.SHIFT);
3233         assertEquals(99 - diff * 2, sm.getSelectedIndex());
3234         assertEquals(selectedIndicesCount * 2 - 1, sm.getSelectedIndices().size());
3235 
3236         keyboard.doKeyPress(KeyCode.PAGE_DOWN, KeyModifier.SHIFT);
3237         assertEquals(leadSelectedIndex, sm.getSelectedIndex());
3238         assertEquals(selectedIndicesCount, sm.getSelectedIndices().size());
3239 
3240         sl.dispose();
3241     }
3242 
3243     @Test public void test_rt34768() {
3244         tableView.getSelectionModel().setSelectionMode(SelectionMode.MULTIPLE);
3245         TableColumn&lt;String, String&gt; firstNameCol = new TableColumn&lt;&gt;(&quot;First Name&quot;);
3246         tableView.getColumns().setAll(firstNameCol);
3247         tableView.getItems().clear();
3248 
3249         // no need for an assert here - we&#39;re testing for an AIOOBE
3250         keyboard.doKeyPress(KeyCode.A, KeyModifier.getShortcutKey());
3251     }
3252 
3253     @Test public void test_rt35853_multipleSelection_rowSelection_shiftDown() {
3254         final int items = 10;
3255         tableView.getItems().clear();
3256         for (int i = 0; i &lt; items; i++) {
3257             tableView.getItems().add(&quot;Row &quot; + i);
3258         }
3259 
3260         sm.setSelectionMode(SelectionMode.MULTIPLE);
3261 
3262         sm.clearAndSelect(5);
3263         assertEquals(5, getAnchor().getRow());
3264         assertTrue(fm.isFocused(5));
3265         assertTrue(sm.isSelected(5));
3266 
3267         sm.selectedIndexProperty().addListener(observable -&gt; {
3268             // we expect only one selected index change event, from 5 to 4
3269             assertEquals(4, sm.getSelectedIndex());
3270         });
3271 
3272         keyboard.doKeyPress(KeyCode.UP, KeyModifier.SHIFT);
3273         assertEquals(5, getAnchor().getRow());
3274         assertTrue(fm.isFocused(4));
3275         assertTrue(sm.isSelected(4));
3276         assertTrue(sm.isSelected(5));
3277     }
3278 
3279     @Test public void test_rt35853_multipleSelection_rowSelection_noShiftDown() {
3280         final int items = 10;
3281         tableView.getItems().clear();
3282         for (int i = 0; i &lt; items; i++) {
3283             tableView.getItems().add(&quot;Row &quot; + i);
3284         }
3285 
3286         sm.setSelectionMode(SelectionMode.MULTIPLE);
3287 
3288         sm.clearAndSelect(5);
3289         assertEquals(5, getAnchor().getRow());
3290         assertTrue(fm.isFocused(5));
3291         assertTrue(sm.isSelected(5));
3292 
3293         sm.selectedIndexProperty().addListener(observable -&gt; {
3294             // we expect only one selected index change event, from 5 to 4
3295             assertEquals(4, sm.getSelectedIndex());
3296         });
3297 
3298         keyboard.doKeyPress(KeyCode.UP);
3299         assertEquals(4, getAnchor().getRow());
3300         assertTrue(fm.isFocused(4));
3301         assertTrue(sm.isSelected(4));
3302         assertFalse(sm.isSelected(5));
3303     }
3304 
3305     @Test public void test_rt35853_singleSelection_rowSelection_shiftDown() {
3306         final int items = 10;
3307         tableView.getItems().clear();
3308         for (int i = 0; i &lt; items; i++) {
3309             tableView.getItems().add(&quot;Row &quot; + i);
3310         }
3311 
3312         sm.setSelectionMode(SelectionMode.SINGLE);
3313 
3314         sm.clearAndSelect(5);
3315         assertEquals(5, getAnchor().getRow());
3316         assertTrue(fm.isFocused(5));
3317         assertTrue(sm.isSelected(5));
3318 
3319         sm.selectedIndexProperty().addListener(observable -&gt; {
3320             // we expect only one selected index change event, from 5 to 4
3321             assertEquals(4, sm.getSelectedIndex());
3322         });
3323 
3324         keyboard.doKeyPress(KeyCode.UP, KeyModifier.SHIFT);
3325         assertEquals(4, getAnchor().getRow());
3326         assertTrue(fm.isFocused(4));
3327         assertTrue(sm.isSelected(4));
3328         assertFalse(sm.isSelected(5));
3329     }
3330 
3331     @Test public void test_rt35853_singleSelection_rowSelection_noShiftDown() {
3332         final int items = 10;
3333         tableView.getItems().clear();
3334         for (int i = 0; i &lt; items; i++) {
3335             tableView.getItems().add(&quot;Row &quot; + i);
3336         }
3337 
3338         sm.setSelectionMode(SelectionMode.SINGLE);
3339 
3340         sm.clearAndSelect(5);
3341         assertEquals(5, getAnchor().getRow());
3342         assertTrue(fm.isFocused(5));
3343         assertTrue(sm.isSelected(5));
3344 
3345         sm.selectedIndexProperty().addListener(observable -&gt; {
3346             // we expect only one selected index change event, from 5 to 4
3347             assertEquals(4, sm.getSelectedIndex());
3348         });
3349 
3350         keyboard.doKeyPress(KeyCode.UP);
3351         assertEquals(4, getAnchor().getRow());
3352         assertTrue(fm.isFocused(4));
3353         assertTrue(sm.isSelected(4));
3354         assertFalse(sm.isSelected(5));
3355     }
3356 
3357     @Test public void test_rt35853_multipleSelection_cellSelection_shiftDown() {
3358         final int items = 10;
3359         tableView.getItems().clear();
3360         for (int i = 0; i &lt; items; i++) {
3361             tableView.getItems().add(&quot;Row &quot; + i);
3362         }
3363 
3364         TableColumn&lt;String, String&gt; col = new TableColumn&lt;&gt;(&quot;Column&quot;);
3365         col.setCellValueFactory(param -&gt; new ReadOnlyStringWrapper(param.getValue()));
3366         tableView.getColumns().setAll(col);
3367 
3368         sm.setSelectionMode(SelectionMode.MULTIPLE);
3369         sm.setCellSelectionEnabled(true);
3370 
3371         sm.clearAndSelect(5, col);
3372         assertEquals(5, getAnchor().getRow());
3373         assertTrue(fm.isFocused(5, col));
3374         assertTrue(sm.isSelected(5, col));
3375 
3376         sm.selectedIndexProperty().addListener(observable -&gt; {
3377             // we expect only one selected index change event, from 5 to 4
3378             assertEquals(4, sm.getSelectedIndex());
3379         });
3380 
3381         keyboard.doKeyPress(KeyCode.UP, KeyModifier.SHIFT);
3382         assertEquals(5, getAnchor().getRow());
3383         assertTrue(fm.isFocused(4, col));
3384         assertTrue(sm.isSelected(4, col));
3385         assertTrue(sm.isSelected(5, col));
3386     }
3387 
3388     @Test public void test_rt35853_multipleSelection_cellSelection_noShiftDown() {
3389         final int items = 10;
3390         tableView.getItems().clear();
3391         for (int i = 0; i &lt; items; i++) {
3392             tableView.getItems().add(&quot;Row &quot; + i);
3393         }
3394 
3395         TableColumn&lt;String, String&gt; col = new TableColumn&lt;&gt;(&quot;Column&quot;);
3396         col.setCellValueFactory(param -&gt; new ReadOnlyStringWrapper(param.getValue()));
3397         tableView.getColumns().setAll(col);
3398 
3399         sm.setSelectionMode(SelectionMode.MULTIPLE);
3400         sm.setCellSelectionEnabled(true);
3401 
3402         sm.clearAndSelect(5, col);
3403         assertEquals(5, getAnchor().getRow());
3404         assertTrue(fm.isFocused(5, col));
3405         assertTrue(sm.isSelected(5, col));
3406 
3407         sm.selectedIndexProperty().addListener(observable -&gt; {
3408             // we expect only one selected index change event, from 5 to 4
3409             assertEquals(4, sm.getSelectedIndex());
3410         });
3411 
3412         keyboard.doKeyPress(KeyCode.UP);
3413         assertEquals(4, getAnchor().getRow());
3414         assertTrue(fm.isFocused(4, col));
3415         assertTrue(sm.isSelected(4, col));
3416         assertFalse(sm.isSelected(5, col));
3417     }
3418 
3419     @Test public void test_rt35853_singleSelection_cellSelection_shiftDown() {
3420         final int items = 10;
3421         tableView.getItems().clear();
3422         for (int i = 0; i &lt; items; i++) {
3423             tableView.getItems().add(&quot;Row &quot; + i);
3424         }
3425 
3426         TableColumn&lt;String, String&gt; col = new TableColumn&lt;&gt;(&quot;Column&quot;);
3427         col.setCellValueFactory(param -&gt; new ReadOnlyStringWrapper(param.getValue()));
3428         tableView.getColumns().setAll(col);
3429 
3430         sm.setSelectionMode(SelectionMode.SINGLE);
3431         sm.setCellSelectionEnabled(true);
3432 
3433         sm.clearAndSelect(5, col);
3434         assertEquals(5, getAnchor().getRow());
3435         assertTrue(fm.isFocused(5, col));
3436         assertTrue(sm.isSelected(5, col));
3437 
3438         sm.selectedIndexProperty().addListener(observable -&gt; {
3439             // we expect only one selected index change event, from 5 to 4
3440             assertEquals(4, sm.getSelectedIndex());
3441         });
3442 
3443         keyboard.doKeyPress(KeyCode.UP, KeyModifier.SHIFT);
3444         assertEquals(4, getAnchor().getRow());
3445         assertTrue(fm.isFocused(4, col));
3446         assertTrue(sm.isSelected(4, col));
3447         assertFalse(sm.isSelected(5, col));
3448     }
3449 
3450     @Test public void test_rt35853_singleSelection_cellSelection_noShiftDown() {
3451         final int items = 10;
3452         tableView.getItems().clear();
3453         for (int i = 0; i &lt; items; i++) {
3454             tableView.getItems().add(&quot;Row &quot; + i);
3455         }
3456 
3457         TableColumn&lt;String, String&gt; col = new TableColumn&lt;&gt;(&quot;Column&quot;);
3458         col.setCellValueFactory(param -&gt; new ReadOnlyStringWrapper(param.getValue()));
3459         tableView.getColumns().setAll(col);
3460 
3461         sm.setSelectionMode(SelectionMode.SINGLE);
3462         sm.setCellSelectionEnabled(true);
3463 
3464         sm.clearAndSelect(5, col);
3465         assertEquals(5, getAnchor().getRow());
3466         assertTrue(fm.isFocused(5, col));
3467         assertTrue(sm.isSelected(5, col));
3468 
3469         sm.selectedIndexProperty().addListener(observable -&gt; {
3470             // we expect only one selected index change event, from 5 to 4
3471             assertEquals(4, sm.getSelectedIndex());
3472         });
3473 
3474         keyboard.doKeyPress(KeyCode.UP);
3475         assertEquals(4, getAnchor().getRow());
3476         assertTrue(fm.isFocused(4, col));
3477         assertTrue(sm.isSelected(4, col));
3478         assertFalse(sm.isSelected(5, col));
3479     }
3480 
3481     @Test public void test_rt36800_rowSelection() {
3482         test_rt36800(false);
3483     }
3484 
3485     @Test public void test_rt36800_cellSelection() {
3486         test_rt36800(true);
3487     }
3488 
3489     private void test_rt36800(boolean cellSelection) {
3490         final int items = 10;
3491         tableView.getItems().clear();
3492         for (int i = 0; i &lt; items; i++) {
3493             tableView.getItems().add(&quot;Row &quot; + i);
3494         }
3495 
3496         TableColumn&lt;String, String&gt; col = new TableColumn&lt;&gt;(&quot;Column&quot;);
3497         col.setCellValueFactory(param -&gt; new ReadOnlyStringWrapper(param.getValue()));
3498         tableView.getColumns().setAll(col);
3499 
3500         sm.setSelectionMode(SelectionMode.SINGLE);
3501         sm.setCellSelectionEnabled(cellSelection);
3502 
3503         if (cellSelection) {
3504             sm.clearAndSelect(5, col);
3505             assertEquals(5, getAnchor().getRow());
3506             assertEquals(col, getAnchor().getTableColumn());
3507             assertTrue(fm.isFocused(5, col));
3508             assertTrue(sm.isSelected(5, col));
3509         } else {
3510             sm.clearAndSelect(5);
3511             assertEquals(5, getAnchor().getRow());
3512             assertTrue(fm.isFocused(5));
3513             assertTrue(sm.isSelected(5));
3514         }
3515 
3516         keyboard.doKeyPress(KeyCode.UP, KeyModifier.SHIFT); // 4
3517         keyboard.doKeyPress(KeyCode.UP, KeyModifier.SHIFT); // 3
3518         keyboard.doKeyPress(KeyCode.UP, KeyModifier.SHIFT); // 2
3519         keyboard.doKeyPress(KeyCode.UP, KeyModifier.SHIFT); // 1
3520         keyboard.doKeyPress(KeyCode.UP, KeyModifier.SHIFT); // 0
3521 
3522         ControlTestUtils.runWithExceptionHandler(() -&gt; {
3523             keyboard.doKeyPress(KeyCode.UP, KeyModifier.SHIFT); // bug time?
3524         });
3525 
3526         if (cellSelection) {
3527             assertEquals(0, getAnchor().getRow());
3528             assertEquals(col, getAnchor().getTableColumn());
3529             assertTrue(fm.isFocused(0, col));
3530             assertTrue(sm.isSelected(0, col));
3531             assertFalse(sm.isSelected(1, col));
3532             assertFalse(sm.isSelected(2, col));
3533             assertFalse(sm.isSelected(3, col));
3534             assertFalse(sm.isSelected(4, col));
3535             assertFalse(sm.isSelected(5, col));
3536         } else {
3537             assertEquals(0, getAnchor().getRow());
3538             assertTrue(fm.isFocused(0));
3539             assertTrue(sm.isSelected(0));
3540             assertFalse(sm.isSelected(1));
3541             assertFalse(sm.isSelected(2));
3542             assertFalse(sm.isSelected(3));
3543             assertFalse(sm.isSelected(4));
3544             assertFalse(sm.isSelected(5));
3545         }
3546     }
3547 
3548     @Test public void test_rt_36942() {
3549         final int items = 3;
3550         tableView.getItems().clear();
3551         for (int i = 0; i &lt; items; i++) {
3552             tableView.getItems().add(&quot;Row &quot; + i);
3553         }
3554 
3555         TableColumn&lt;String, String&gt; col = new TableColumn&lt;&gt;(&quot;Column&quot;);
3556         col.setCellValueFactory(param -&gt; new ReadOnlyStringWrapper(param.getValue()));
3557         tableView.getColumns().setAll(col);
3558 
3559         MultipleSelectionModel&lt;String&gt; sm = tableView.getSelectionModel();
3560         sm.setSelectionMode(SelectionMode.MULTIPLE);
3561         ObservableList&lt;String&gt; selectedItems = sm.getSelectedItems();
3562 
3563         TableView&lt;String&gt; selectedItemsTableView = new TableView&lt;&gt;(selectedItems);
3564         selectedItemsTableView.getColumns().setAll(col);
3565 
3566         HBox root = new HBox(5, tableView, selectedItemsTableView);
3567 
3568         StageLoader sl = new StageLoader(root);
3569 
3570         sm.select(0);
3571         keyboard.doKeyPress(KeyCode.DOWN, KeyModifier.SHIFT); // 0,1
3572         keyboard.doKeyPress(KeyCode.DOWN, KeyModifier.SHIFT); // 0,1,2
3573 
3574         ControlTestUtils.runWithExceptionHandler(() -&gt; {
3575             keyboard.doKeyPress(KeyCode.DOWN, KeyModifier.SHIFT); // 0,1,2,Exception?
3576         });
3577 
3578         sl.dispose();
3579     }
3580 
3581     @Test public void test_rt_37130_pageUpAtTop() {
3582         final int items = 100;
3583         tableView.getItems().clear();
3584         for (int i = 0; i &lt; items; i++) {
3585             tableView.getItems().add(&quot;Row &quot; + i);
3586         }
3587 
3588         TableColumn&lt;String, String&gt; col = new TableColumn&lt;&gt;(&quot;Column&quot;);
3589         col.setCellValueFactory(param -&gt; new ReadOnlyStringWrapper(param.getValue()));
3590         tableView.getColumns().setAll(col);
3591 
3592         TableSelectionModel&lt;String&gt; sm = tableView.getSelectionModel();
3593         sm.setSelectionMode(SelectionMode.MULTIPLE);
3594         sm.setCellSelectionEnabled(true);
3595 
3596         StageLoader sl = new StageLoader(tableView);
3597 
3598         sm.select(5, col);
3599         keyboard.doKeyPress(KeyCode.PAGE_UP, KeyModifier.SHIFT);
3600         keyboard.doKeyPress(KeyCode.PAGE_UP, KeyModifier.SHIFT);
3601 
3602         sl.dispose();
3603     }
3604 
3605     @Test public void test_rt_37130_pageUpAtBottom() {
3606         final int items = 100;
3607         tableView.getItems().clear();
3608         for (int i = 0; i &lt; items; i++) {
3609             tableView.getItems().add(&quot;Row &quot; + i);
3610         }
3611 
3612         TableColumn&lt;String, String&gt; col = new TableColumn&lt;&gt;(&quot;Column&quot;);
3613         col.setCellValueFactory(param -&gt; new ReadOnlyStringWrapper(param.getValue()));
3614         tableView.getColumns().setAll(col);
3615 
3616         TableSelectionModel&lt;String&gt; sm = tableView.getSelectionModel();
3617         sm.setSelectionMode(SelectionMode.MULTIPLE);
3618         sm.setCellSelectionEnabled(true);
3619 
3620         StageLoader sl = new StageLoader(tableView);
3621 
3622         sm.select(95, col);
3623         keyboard.doKeyPress(KeyCode.PAGE_UP, KeyModifier.SHIFT);
3624         keyboard.doKeyPress(KeyCode.PAGE_UP, KeyModifier.SHIFT);
3625 
3626         sl.dispose();
3627     }
3628 
3629     @Test public void test_rt_37130_pageDownAtTop() {
3630         final int items = 100;
3631         tableView.getItems().clear();
3632         for (int i = 0; i &lt; items; i++) {
3633             tableView.getItems().add(&quot;Row &quot; + i);
3634         }
3635 
3636         TableColumn&lt;String, String&gt; col = new TableColumn&lt;&gt;(&quot;Column&quot;);
3637         col.setCellValueFactory(param -&gt; new ReadOnlyStringWrapper(param.getValue()));
3638         tableView.getColumns().setAll(col);
3639 
3640         TableSelectionModel&lt;String&gt; sm = tableView.getSelectionModel();
3641         sm.setSelectionMode(SelectionMode.MULTIPLE);
3642         sm.setCellSelectionEnabled(true);
3643 
3644         StageLoader sl = new StageLoader(tableView);
3645 
3646         sm.select(5, col);
3647         keyboard.doKeyPress(KeyCode.PAGE_DOWN, KeyModifier.SHIFT);
3648         keyboard.doKeyPress(KeyCode.PAGE_DOWN, KeyModifier.SHIFT);
3649 
3650         sl.dispose();
3651     }
3652 
3653     @Test public void test_rt_37130_pageDownAtBottom() {
3654         final int items = 100;
3655         tableView.getItems().clear();
3656         for (int i = 0; i &lt; items; i++) {
3657             tableView.getItems().add(&quot;Row &quot; + i);
3658         }
3659 
3660         TableColumn&lt;String, String&gt; col = new TableColumn&lt;&gt;(&quot;Column&quot;);
3661         col.setCellValueFactory(param -&gt; new ReadOnlyStringWrapper(param.getValue()));
3662         tableView.getColumns().setAll(col);
3663 
3664         TableSelectionModel&lt;String&gt; sm = tableView.getSelectionModel();
3665         sm.setSelectionMode(SelectionMode.MULTIPLE);
3666         sm.setCellSelectionEnabled(true);
3667 
3668         StageLoader sl = new StageLoader(tableView);
3669 
3670         sm.select(95, col);
3671         keyboard.doKeyPress(KeyCode.PAGE_DOWN, KeyModifier.SHIFT);
3672         keyboard.doKeyPress(KeyCode.PAGE_DOWN, KeyModifier.SHIFT);
3673 
3674         sl.dispose();
3675     }
3676 
3677 //    @Test public void test_rt_38326() {
3678 //        int argCount = 5;
3679 //        int testCount = (int) Math.pow(2, argCount);
3680 //        for (int test = 0; test &lt; testCount; test++) {
3681 //            boolean moveUp                                      = (test &amp; 0b10000) == 0b10000;
3682 //            boolean singleSelection                             = (test &amp; 0b01000) == 0b01000;
3683 //            boolean cellSelection                               = (test &amp; 0b00100) == 0b00100;
3684 //            boolean replaceItemsList                            = (test &amp; 0b00010) == 0b00010;
3685 //            boolean updateItemsListBeforeSelectionModelChanges  = (test &amp; 0b00001) == 0b00001;
3686 //
3687 //            StringBuilder sb = new StringBuilder(&quot;@Test public void test_rt_38326_focusLostOnShortcutKeyNav_&quot;);
3688 //            sb.append(moveUp ? &quot;moveUp_&quot; : &quot;moveDown_&quot;);
3689 //            sb.append(singleSelection ? &quot;singleSelection_&quot; : &quot;multipleSelection_&quot;);
3690 //            sb.append(cellSelection ? &quot;cellSelection_&quot; : &quot;rowSelection_&quot;);
3691 //            sb.append(replaceItemsList ? &quot;replaceItemsList_&quot; : &quot;reuseItemsList_&quot;);
3692 //            sb.append(updateItemsListBeforeSelectionModelChanges ? &quot;updateItemsListBeforeSelectionModelChanges&quot; : &quot;updateItemsListAfterSelectionModelChanges&quot;);
3693 //            sb.append(&quot;() {\n    &quot;);
3694 //            sb.append(&quot;test_rt_38326(&quot;);
3695 //            sb.append(moveUp + &quot;, &quot;);
3696 //            sb.append(singleSelection + &quot;, &quot;);
3697 //            sb.append(cellSelection + &quot;, &quot;);
3698 //            sb.append(replaceItemsList + &quot;, &quot;);
3699 //            sb.append(updateItemsListBeforeSelectionModelChanges);
3700 //            sb.append(&quot;);\n}&quot;);
3701 //
3702 //            System.out.println(sb);
3703 //        }
3704 //    }
3705 
3706     // -- tests generated by above commented out code
3707     @Test public void test_rt_38326_focusLostOnShortcutKeyNav_moveDown_multipleSelection_rowSelection_reuseItemsList_updateItemsListAfterSelectionModelChanges() {
3708         test_rt_38326(false, false, false, false, false);
3709     }
3710     @Test public void test_rt_38326_focusLostOnShortcutKeyNav_moveDown_multipleSelection_rowSelection_reuseItemsList_updateItemsListBeforeSelectionModelChanges() {
3711         test_rt_38326(false, false, false, false, true);
3712     }
3713     @Test public void test_rt_38326_focusLostOnShortcutKeyNav_moveDown_multipleSelection_rowSelection_replaceItemsList_updateItemsListAfterSelectionModelChanges() {
3714         test_rt_38326(false, false, false, true, false);
3715     }
3716     @Test public void test_rt_38326_focusLostOnShortcutKeyNav_moveDown_multipleSelection_rowSelection_replaceItemsList_updateItemsListBeforeSelectionModelChanges() {
3717         test_rt_38326(false, false, false, true, true);
3718     }
3719     @Test public void test_rt_38326_focusLostOnShortcutKeyNav_moveDown_multipleSelection_cellSelection_reuseItemsList_updateItemsListAfterSelectionModelChanges() {
3720         test_rt_38326(false, false, true, false, false);
3721     }
3722     @Test public void test_rt_38326_focusLostOnShortcutKeyNav_moveDown_multipleSelection_cellSelection_reuseItemsList_updateItemsListBeforeSelectionModelChanges() {
3723         test_rt_38326(false, false, true, false, true);
3724     }
3725     @Test public void test_rt_38326_focusLostOnShortcutKeyNav_moveDown_multipleSelection_cellSelection_replaceItemsList_updateItemsListAfterSelectionModelChanges() {
3726         test_rt_38326(false, false, true, true, false);
3727     }
3728     @Test public void test_rt_38326_focusLostOnShortcutKeyNav_moveDown_multipleSelection_cellSelection_replaceItemsList_updateItemsListBeforeSelectionModelChanges() {
3729         test_rt_38326(false, false, true, true, true);
3730     }
3731     @Test public void test_rt_38326_focusLostOnShortcutKeyNav_moveDown_singleSelection_rowSelection_reuseItemsList_updateItemsListAfterSelectionModelChanges() {
3732         test_rt_38326(false, true, false, false, false);
3733     }
3734     @Test public void test_rt_38326_focusLostOnShortcutKeyNav_moveDown_singleSelection_rowSelection_reuseItemsList_updateItemsListBeforeSelectionModelChanges() {
3735         test_rt_38326(false, true, false, false, true);
3736     }
3737     @Test public void test_rt_38326_focusLostOnShortcutKeyNav_moveDown_singleSelection_rowSelection_replaceItemsList_updateItemsListAfterSelectionModelChanges() {
3738         test_rt_38326(false, true, false, true, false);
3739     }
3740     @Test public void test_rt_38326_focusLostOnShortcutKeyNav_moveDown_singleSelection_rowSelection_replaceItemsList_updateItemsListBeforeSelectionModelChanges() {
3741         test_rt_38326(false, true, false, true, true);
3742     }
3743     @Test public void test_rt_38326_focusLostOnShortcutKeyNav_moveDown_singleSelection_cellSelection_reuseItemsList_updateItemsListAfterSelectionModelChanges() {
3744         test_rt_38326(false, true, true, false, false);
3745     }
3746     @Test public void test_rt_38326_focusLostOnShortcutKeyNav_moveDown_singleSelection_cellSelection_reuseItemsList_updateItemsListBeforeSelectionModelChanges() {
3747         test_rt_38326(false, true, true, false, true);
3748     }
3749     @Test public void test_rt_38326_focusLostOnShortcutKeyNav_moveDown_singleSelection_cellSelection_replaceItemsList_updateItemsListAfterSelectionModelChanges() {
3750         test_rt_38326(false, true, true, true, false);
3751     }
3752     @Test public void test_rt_38326_focusLostOnShortcutKeyNav_moveDown_singleSelection_cellSelection_replaceItemsList_updateItemsListBeforeSelectionModelChanges() {
3753         test_rt_38326(false, true, true, true, true);
3754     }
3755     @Test public void test_rt_38326_focusLostOnShortcutKeyNav_moveUp_multipleSelection_rowSelection_reuseItemsList_updateItemsListAfterSelectionModelChanges() {
3756         test_rt_38326(true, false, false, false, false);
3757     }
3758     @Test public void test_rt_38326_focusLostOnShortcutKeyNav_moveUp_multipleSelection_rowSelection_reuseItemsList_updateItemsListBeforeSelectionModelChanges() {
3759         test_rt_38326(true, false, false, false, true);
3760     }
3761     @Test public void test_rt_38326_focusLostOnShortcutKeyNav_moveUp_multipleSelection_rowSelection_replaceItemsList_updateItemsListAfterSelectionModelChanges() {
3762         test_rt_38326(true, false, false, true, false);
3763     }
3764     @Test public void test_rt_38326_focusLostOnShortcutKeyNav_moveUp_multipleSelection_rowSelection_replaceItemsList_updateItemsListBeforeSelectionModelChanges() {
3765         test_rt_38326(true, false, false, true, true);
3766     }
3767     @Test public void test_rt_38326_focusLostOnShortcutKeyNav_moveUp_multipleSelection_cellSelection_reuseItemsList_updateItemsListAfterSelectionModelChanges() {
3768         test_rt_38326(true, false, true, false, false);
3769     }
3770     @Test public void test_rt_38326_focusLostOnShortcutKeyNav_moveUp_multipleSelection_cellSelection_reuseItemsList_updateItemsListBeforeSelectionModelChanges() {
3771         test_rt_38326(true, false, true, false, true);
3772     }
3773     @Test public void test_rt_38326_focusLostOnShortcutKeyNav_moveUp_multipleSelection_cellSelection_replaceItemsList_updateItemsListAfterSelectionModelChanges() {
3774         test_rt_38326(true, false, true, true, false);
3775     }
3776     @Test public void test_rt_38326_focusLostOnShortcutKeyNav_moveUp_multipleSelection_cellSelection_replaceItemsList_updateItemsListBeforeSelectionModelChanges() {
3777         test_rt_38326(true, false, true, true, true);
3778     }
3779     @Test public void test_rt_38326_focusLostOnShortcutKeyNav_moveUp_singleSelection_rowSelection_reuseItemsList_updateItemsListAfterSelectionModelChanges() {
3780         test_rt_38326(true, true, false, false, false);
3781     }
3782     @Test public void test_rt_38326_focusLostOnShortcutKeyNav_moveUp_singleSelection_rowSelection_reuseItemsList_updateItemsListBeforeSelectionModelChanges() {
3783         test_rt_38326(true, true, false, false, true);
3784     }
3785     @Test public void test_rt_38326_focusLostOnShortcutKeyNav_moveUp_singleSelection_rowSelection_replaceItemsList_updateItemsListAfterSelectionModelChanges() {
3786         test_rt_38326(true, true, false, true, false);
3787     }
3788     @Test public void test_rt_38326_focusLostOnShortcutKeyNav_moveUp_singleSelection_rowSelection_replaceItemsList_updateItemsListBeforeSelectionModelChanges() {
3789         test_rt_38326(true, true, false, true, true);
3790     }
3791     @Test public void test_rt_38326_focusLostOnShortcutKeyNav_moveUp_singleSelection_cellSelection_reuseItemsList_updateItemsListAfterSelectionModelChanges() {
3792         test_rt_38326(true, true, true, false, false);
3793     }
3794     @Test public void test_rt_38326_focusLostOnShortcutKeyNav_moveUp_singleSelection_cellSelection_reuseItemsList_updateItemsListBeforeSelectionModelChanges() {
3795         test_rt_38326(true, true, true, false, true);
3796     }
3797     @Test public void test_rt_38326_focusLostOnShortcutKeyNav_moveUp_singleSelection_cellSelection_replaceItemsList_updateItemsListAfterSelectionModelChanges() {
3798         test_rt_38326(true, true, true, true, false);
3799     }
3800     @Test public void test_rt_38326_focusLostOnShortcutKeyNav_moveUp_singleSelection_cellSelection_replaceItemsList_updateItemsListBeforeSelectionModelChanges() {
3801         test_rt_38326(true, true, true, true, true);
3802     }
3803 
3804     private void test_rt_38326(boolean moveUp, boolean singleSelection, boolean cellSelection, boolean replaceItemsList, boolean updateItemsListBeforeSelectionModelChanges) {
3805         final int items = 10;
3806         ObservableList&lt;String&gt; itemsList = FXCollections.observableArrayList();
3807         for (int i = 0; i &lt; items; i++) {
3808             itemsList.add(&quot;Row &quot; + i);
3809         }
3810 
3811         if (updateItemsListBeforeSelectionModelChanges) {
3812             if (replaceItemsList) {
3813                 tableView.setItems(itemsList);
3814             } else {
3815                 tableView.getItems().clear();
3816                 tableView.getItems().addAll(itemsList);
3817             }
3818         }
3819 
3820         TableColumn&lt;String, String&gt; col = new TableColumn&lt;&gt;(&quot;Column&quot;);
3821         col.setCellValueFactory(param -&gt; new ReadOnlyStringWrapper(param.getValue()));
3822 
3823         TableColumn&lt;String, String&gt; col2 = new TableColumn&lt;&gt;(&quot;Column 2&quot;);
3824         col2.setCellValueFactory(param -&gt; new ReadOnlyStringWrapper(param.getValue()));
3825 
3826         tableView.getColumns().setAll(col, col2);
3827 
3828         TableView.TableViewSelectionModel&lt;String&gt; sm = tableView.getSelectionModel();
3829         sm.setSelectionMode(singleSelection ? SelectionMode.SINGLE : SelectionMode.MULTIPLE);
3830         sm.setCellSelectionEnabled(cellSelection);
3831 
3832         if (! updateItemsListBeforeSelectionModelChanges) {
3833             if (replaceItemsList) {
3834                 tableView.setItems(itemsList);
3835             } else {
3836                 tableView.getItems().clear();
3837                 tableView.getItems().addAll(itemsList);
3838             }
3839         }
3840 
3841         StageLoader sl = new StageLoader(tableView);
3842 
3843         // test the initial state to ensure it is as we expect
3844         assertFalse(sm.isSelected(0));
3845         assertFalse(sm.isSelected(0, col));
3846         assertFalse(sm.isSelected(0, col2));
3847         assertEquals(0, sm.getSelectedIndices().size());
3848         assertEquals(0, sm.getSelectedItems().size());
3849         assertEquals(0, sm.getSelectedCells().size());
3850 
3851         final int startRow = 5;
3852         sm.clearSelection();
3853         sm.select(startRow, col);
3854         assertEquals(1, sm.getSelectedCells().size());
3855         assertEquals(startRow, sm.getSelectedCells().get(0).getRow());
3856         assertEquals(col, sm.getSelectedCells().get(0).getTableColumn());
3857         assertEquals(startRow, tableView.getFocusModel().getFocusedCell().getRow());
3858         assertEquals(col, tableView.getFocusModel().getFocusedCell().getTableColumn());
3859 
3860         keyboard.doKeyPress(moveUp ? KeyCode.UP : KeyCode.DOWN, KeyModifier.getShortcutKey());
3861         assertEquals(moveUp ? startRow-1 : startRow+1, tableView.getFocusModel().getFocusedCell().getRow());
3862         assertEquals(col, tableView.getFocusModel().getFocusedCell().getTableColumn());
3863 
3864         sl.dispose();
3865     }
3866 
3867     private int rt_39088_indices_event_count = 0;
3868     private int rt_39088_items_event_count = 0;
3869     @Test public void test_rt_39088() {
3870         ObservableList&lt;String&gt; itemsList = FXCollections.observableArrayList();
3871         for (int i = 0; i &lt; 4; i++) {
3872             itemsList.add(&quot;Row &quot; + i);
3873         }
3874 
3875         tableView.setItems(itemsList);
3876 
3877         TableColumn&lt;String, String&gt; col = new TableColumn&lt;&gt;(&quot;Column&quot;);
3878         col.setCellValueFactory(param -&gt; new ReadOnlyStringWrapper(param.getValue()));
3879 
3880         tableView.getColumns().setAll(col);
3881 
3882         TableView.TableViewSelectionModel&lt;String&gt; sm = tableView.getSelectionModel();
3883         sm.setSelectionMode(SelectionMode.MULTIPLE);
3884         sm.setCellSelectionEnabled(false);
3885 
3886         ObservableList&lt;Integer&gt; indices = sm.getSelectedIndices();
3887         ObservableList&lt;String&gt; items = sm.getSelectedItems();
3888 
3889         indices.addListener((ListChangeListener&lt;Integer&gt;) change -&gt; rt_39088_indices_event_count++);
3890         items.addListener((ListChangeListener&lt;String&gt;) change -&gt; rt_39088_items_event_count++);
3891 
3892         StageLoader sl = new StageLoader(tableView);
3893 
3894         assertEquals(0, rt_39088_indices_event_count);
3895         assertEquals(0, rt_39088_items_event_count);
3896         assertEquals(0, indices.size());
3897         assertEquals(0, items.size());
3898 
3899         sm.select(3);
3900         assertEquals(1, rt_39088_indices_event_count);
3901         assertEquals(1, rt_39088_items_event_count);
3902         assertEquals(1, indices.size());
3903         assertEquals(1, items.size());
3904 
3905         keyboard.doKeyPress(KeyCode.UP, KeyModifier.SHIFT);
3906         assertEquals(2, rt_39088_indices_event_count);
3907         assertEquals(2, rt_39088_items_event_count);
3908         assertEquals(2, indices.size());
3909         assertEquals(2, items.size());
3910 
3911         // this is where the test fails...
3912         keyboard.doKeyPress(KeyCode.UP, KeyModifier.SHIFT);
3913         assertEquals(3, rt_39088_indices_event_count);
3914         assertEquals(3, rt_39088_items_event_count);
3915         assertEquals(3, indices.size());
3916         assertEquals(3, items.size());
3917 
3918         sl.dispose();
3919     }
3920 
3921     @Test public void test_rt_27709_singleSelection_cellSelection() {
3922         test_rt_27709(SelectionMode.SINGLE, true, false);
3923     }
3924 
3925     @Test public void test_rt_27709_multipleSelection_cellSelection() {
3926         test_rt_27709(SelectionMode.MULTIPLE, true, false);
3927     }
3928 
3929     @Test public void test_rt_27709_singleSelection_rowSelection() {
3930         test_rt_27709(SelectionMode.SINGLE, false, false);
3931     }
3932 
3933     @Test public void test_rt_27709_multipleSelection_rowSelection() {
3934         test_rt_27709(SelectionMode.MULTIPLE, false, false);
3935     }
3936 
3937     @Test public void test_rt_27709_singleSelection_cellSelection_resetSelection() {
3938         test_rt_27709(SelectionMode.SINGLE, true, true);
3939     }
3940 
3941     @Test public void test_rt_27709_multipleSelection_cellSelection_resetSelection() {
3942         test_rt_27709(SelectionMode.MULTIPLE, true, true);
3943     }
3944 
3945     @Test public void test_rt_27709_singleSelection_rowSelection_resetSelection() {
3946         test_rt_27709(SelectionMode.SINGLE, false, true);
3947     }
3948 
3949     @Test public void test_rt_27709_multipleSelection_rowSelection_resetSelection() {
3950         test_rt_27709(SelectionMode.MULTIPLE, false, true);
3951     }
3952 
3953     private void test_rt_27709(SelectionMode mode, boolean cellSelectionMode, boolean resetSelection) {
3954         ObservableList&lt;String&gt; itemsList = FXCollections.observableArrayList();
3955         for (int i = 0; i &lt; 10; i++) {
3956             itemsList.add(&quot;Row &quot; + i);
3957         }
3958 
3959         tableView.setItems(itemsList);
3960 
3961         TableColumn&lt;String, String&gt; col = new TableColumn&lt;&gt;(&quot;Column&quot;);
3962         col.setCellValueFactory(param -&gt; new ReadOnlyStringWrapper(param.getValue()));
3963 
3964         tableView.getColumns().setAll(col);
3965 
3966         TableView.TableViewSelectionModel&lt;String&gt; sm = tableView.getSelectionModel();
3967         sm.setSelectionMode(mode);
3968         sm.setCellSelectionEnabled(cellSelectionMode);
3969 
3970         ObservableList&lt;Integer&gt; indices = sm.getSelectedIndices();
3971         ObservableList&lt;TablePosition&gt; cells = sm.getSelectedCells();
3972 
3973         StageLoader sl = new StageLoader(tableView);
3974 
3975         int expectedSize = mode == SelectionMode.SINGLE ? 1 : 10;
3976         int lookupIndex = mode == SelectionMode.SINGLE ? 0 : 9;
3977 
3978         sm.select(0, col);
3979         assertEquals(1, indices.size());
3980         assertEquals(1, cells.size());
3981 
3982         keyboard.doKeyPress(KeyCode.END, KeyModifier.SHIFT);
3983         assertEquals(expectedSize, indices.size());
3984         assertEquals(expectedSize, cells.size());
3985         assertEquals(9, (int) indices.get(lookupIndex));
3986         assertEquals(9, cells.get(lookupIndex).getRow());
3987 
3988         if (resetSelection) {
3989             sm.clearAndSelect(9, col);
3990             TablePosition&lt;?,?&gt; anchor = TableCellBehavior.getAnchor(tableView, null);
3991             assertEquals(9, anchor.getRow());
3992             assertEquals(col, anchor.getTableColumn());
3993         } else {
3994             expectedSize = 1;
3995         }
3996 
3997         keyboard.doKeyPress(KeyCode.HOME, KeyModifier.SHIFT);
3998         assertEquals(expectedSize, indices.size());
3999         assertEquals(expectedSize, cells.size());
4000         assertTrue(sm.isSelected(0, col));
4001 
4002         if (resetSelection) {
4003             sm.clearAndSelect(0, col);
4004 
4005             TablePosition&lt;?,?&gt; anchor = TableCellBehavior.getAnchor(tableView, null);
4006             assertEquals(0, anchor.getRow());
4007             assertEquals(col, anchor.getTableColumn());
4008         } else {
4009             expectedSize = mode == SelectionMode.SINGLE ? 1 : 10;
4010         }
4011 
4012         keyboard.doKeyPress(KeyCode.END, KeyModifier.SHIFT);
4013         assertEquals(expectedSize, indices.size());
4014         assertEquals(expectedSize, cells.size());
4015         assertTrue(sm.isSelected(9, col));
4016 
4017         sl.dispose();
4018     }
4019 
4020     @Test public void test_rt_18440_goLeft() {
4021         test_rt_18440(KeyCode.LEFT, 3, false, colIndex -&gt; {
4022             keyboard.doLeftArrowPress(KeyModifier.getShortcutKey());
4023             return colIndex - 1;
4024         });
4025     }
4026 
4027     @Test public void test_rt_18440_goLeft_toEnd() {
4028         test_rt_18440(KeyCode.LEFT, 3, true, colIndex -&gt; {
4029             keyboard.doLeftArrowPress(KeyModifier.getShortcutKey());
4030             return colIndex - 1;
4031         });
4032     }
4033 
4034     @Test public void test_rt_18440_goRight() {
4035         test_rt_18440(KeyCode.RIGHT, 0, false, colIndex -&gt; {
4036             keyboard.doRightArrowPress(KeyModifier.getShortcutKey());
4037             return colIndex + 1;
4038         });
4039     }
4040 
4041     @Test public void test_rt_18440_goRight_toEnd() {
4042         test_rt_18440(KeyCode.RIGHT, 0, true, colIndex -&gt; {
4043             keyboard.doRightArrowPress(KeyModifier.getShortcutKey());
4044             return colIndex + 1;
4045         });
4046     }
4047 
4048     private void test_rt_18440(KeyCode direction, int startColumn, boolean goToEnd, Function&lt;Integer, Integer&gt; r) {
4049         ObservableList&lt;String&gt; itemsList = FXCollections.observableArrayList();
4050         for (int i = 0; i &lt; 10; i++) {
4051             itemsList.add(&quot;Row &quot; + i);
4052         }
4053 
4054         tableView.setItems(itemsList);
4055 
4056         tableView.getColumns().clear();
4057         for (int i = 0; i &lt; 4; i++) {
4058             TableColumn&lt;String, String&gt; col = new TableColumn&lt;&gt;(&quot;Column &quot; + i);
4059             col.setCellValueFactory(param -&gt; new ReadOnlyStringWrapper(param.getValue()));
4060             tableView.getColumns().add(col);
4061         }
4062 
4063         TableView.TableViewFocusModel fm = tableView.getFocusModel();
4064         TableView.TableViewSelectionModel&lt;String&gt; sm = tableView.getSelectionModel();
4065         sm.setSelectionMode(SelectionMode.MULTIPLE);
4066         sm.setCellSelectionEnabled(true);
4067 
4068         ObservableList&lt;Integer&gt; indices = sm.getSelectedIndices();
4069         ObservableList&lt;String&gt; items = sm.getSelectedItems();
4070 
4071         StageLoader sl = new StageLoader(tableView);
4072 
4073         assertEquals(0, indices.size());
4074         assertEquals(0, items.size());
4075 
4076         sm.select(0, tableView.getColumns().get(startColumn));
4077         assertEquals(0, sm.getSelectedIndex());
4078         assertEquals(tableView.getColumns().get(startColumn), sm.getSelectedCells().get(0).getTableColumn());
4079         assertEquals(0, fm.getFocusedIndex());
4080         assertEquals(tableView.getColumns().get(startColumn), fm.getFocusedCell().getTableColumn());
4081 
4082         int expectedColumn = r.apply(startColumn);
4083         assertEquals(0, sm.getSelectedIndex());
4084         assertEquals(tableView.getColumns().get(startColumn), sm.getSelectedCells().get(0).getTableColumn());
4085         assertEquals(0, fm.getFocusedIndex());
4086         assertEquals(tableView.getColumns().get(expectedColumn), fm.getFocusedCell().getTableColumn());
4087 
4088         expectedColumn = r.apply(expectedColumn);
4089         assertEquals(0, sm.getSelectedIndex());
4090         assertEquals(tableView.getColumns().get(startColumn), sm.getSelectedCells().get(0).getTableColumn());
4091         assertEquals(0, fm.getFocusedIndex());
4092         assertEquals(tableView.getColumns().get(expectedColumn), fm.getFocusedCell().getTableColumn());
4093 
4094         if (goToEnd) {
4095             expectedColumn = r.apply(expectedColumn);
4096             assertEquals(0, sm.getSelectedIndex());
4097             assertEquals(tableView.getColumns().get(startColumn), sm.getSelectedCells().get(0).getTableColumn());
4098             assertEquals(0, fm.getFocusedIndex());
4099             assertEquals(tableView.getColumns().get(expectedColumn), fm.getFocusedCell().getTableColumn());
4100         }
4101 
4102         expectedColumn = direction == KeyCode.RIGHT ? 3 : 0;
4103         keyboard.doKeyPress(direction, KeyModifier.SHIFT);
4104         assertEquals(0, sm.getSelectedIndex());
4105         assertEquals(debug(), 4, sm.getSelectedCells().size());
4106         assertEquals(0, fm.getFocusedIndex());
4107         assertEquals(tableView.getColumns().get(expectedColumn), fm.getFocusedCell().getTableColumn());
4108 
4109         sl.dispose();
4110     }
4111 
4112     @Test public void test_rt_24865_moveDownwards() {
4113         tableView.getItems().clear();
4114         for (int i = 0; i &lt; 100; i++) {
4115             tableView.getItems().add(&quot;Row &quot; + i);
4116         }
4117 
4118         Toolkit.getToolkit().firePulse();
4119 
4120         ObservableList&lt;Integer&gt; indices = sm.getSelectedIndices();
4121 
4122         sm.select(0);
4123         assertTrue(isSelected(0));
4124         assertTrue(fm.isFocused(0));
4125         assertEquals(1, indices.size());
4126         assertEquals(0, ((TablePosition)TableCellBehavior.getAnchor(tableView, null)).getRow());
4127 
4128         keyboard.doDownArrowPress(KeyModifier.SHIFT);
4129         keyboard.doDownArrowPress(KeyModifier.SHIFT);
4130         keyboard.doDownArrowPress(KeyModifier.SHIFT);
4131         assertTrue(isSelected(0, 1, 2, 3));
4132         assertTrue(fm.isFocused(3));
4133         assertEquals(4, indices.size());
4134         assertEquals(0, ((TablePosition)TableCellBehavior.getAnchor(tableView, null)).getRow());
4135 
4136         keyboard.doDownArrowPress(KeyModifier.getShortcutKey());
4137         keyboard.doDownArrowPress(KeyModifier.getShortcutKey());
4138         keyboard.doDownArrowPress(KeyModifier.getShortcutKey());
4139         assertTrue(isSelected(0, 1, 2, 3));
4140         assertTrue(isNotSelected(4, 5, 6, 7, 8, 9));
4141         assertTrue(fm.isFocused(6));
4142         assertEquals(4, indices.size());
4143         assertEquals(0, ((TablePosition)TableCellBehavior.getAnchor(tableView, null)).getRow());
4144 
4145         // main point of test: selection between the last index (3) and the focus
4146         // index (6) should now be true
4147         keyboard.doKeyPress(KeyCode.PAGE_DOWN, KeyModifier.getShortcutKey(), KeyModifier.SHIFT);
4148         final int selectedRowCount = indices.size();
4149         for (int i = 0; i &lt; selectedRowCount; i++) {
4150             assertTrue(isSelected(i));
4151         }
4152         assertTrue(fm.isFocused(selectedRowCount - 1));
4153         assertEquals(0, ((TablePosition)TableCellBehavior.getAnchor(tableView, null)).getRow());
4154 
4155         keyboard.doDownArrowPress(KeyModifier.SHIFT);
4156         int newSelectedRowCount = selectedRowCount + 1;
4157         for (int i = 0; i &lt; newSelectedRowCount; i++) {
4158             assertTrue(isSelected(i));
4159         }
4160         assertTrue(fm.isFocused(newSelectedRowCount - 1));
4161         assertEquals(0, ((TablePosition)TableCellBehavior.getAnchor(tableView, null)).getRow());
4162     }
4163 
4164     @Test public void test_rt_24865_moveUpwards() {
4165         tableView.getItems().clear();
4166         for (int i = 0; i &lt; 100; i++) {
4167             tableView.getItems().add(&quot;Row &quot; + i);
4168         }
4169 
4170         Toolkit.getToolkit().firePulse();
4171 
4172         ObservableList&lt;Integer&gt; indices = sm.getSelectedIndices();
4173 
4174         sm.select(50);
4175         tableView.scrollTo(50);
4176 
4177         Toolkit.getToolkit().firePulse();
4178 
4179         assertTrue(isSelected(50));
4180         assertTrue(fm.isFocused(50));
4181         assertEquals(1, indices.size());
4182         assertEquals(50, ((TablePosition)TableCellBehavior.getAnchor(tableView, null)).getRow());
4183 
4184         keyboard.doUpArrowPress(KeyModifier.SHIFT);
4185         keyboard.doUpArrowPress(KeyModifier.SHIFT);
4186         keyboard.doUpArrowPress(KeyModifier.SHIFT);
4187         assertTrue(isSelected(50, 49, 48, 47));
4188         assertTrue(fm.isFocused(47));
4189         assertEquals(4, indices.size());
4190         assertEquals(50, ((TablePosition)TableCellBehavior.getAnchor(tableView, null)).getRow());
4191 
4192         keyboard.doUpArrowPress(KeyModifier.getShortcutKey());
4193         keyboard.doUpArrowPress(KeyModifier.getShortcutKey());
4194         keyboard.doUpArrowPress(KeyModifier.getShortcutKey());
4195         assertTrue(isSelected(50, 49, 48, 47));
4196         assertTrue(isNotSelected(46, 45, 44, 43, 42, 41));
4197         assertTrue(fm.isFocused(44));
4198         assertEquals(4, indices.size());
4199         assertEquals(50, ((TablePosition)TableCellBehavior.getAnchor(tableView, null)).getRow());
4200 
4201         // main point of test: selection between the last index (47) and the focus
4202         // index (44) should now be true
4203         keyboard.doKeyPress(KeyCode.PAGE_UP, KeyModifier.getShortcutKey(), KeyModifier.SHIFT);
4204         final int selectedRowCount = indices.size();
4205         for (int i = 0; i &lt; selectedRowCount; i++) {
4206             assertTrue(isSelected(50 - i));
4207         }
4208         assertTrue(fm.isFocused(50 - selectedRowCount + 1));
4209         assertEquals(50, ((TablePosition)TableCellBehavior.getAnchor(tableView, null)).getRow());
4210 
4211         keyboard.doUpArrowPress(KeyModifier.SHIFT);
4212         int newSelectedRowCount = selectedRowCount + 1;
4213         for (int i = 0; i &lt; newSelectedRowCount; i++) {
4214             assertTrue(isSelected(50 - i));
4215         }
4216         assertTrue(fm.isFocused(50 - newSelectedRowCount + 1));
4217         assertEquals(50, ((TablePosition)TableCellBehavior.getAnchor(tableView, null)).getRow());
4218     }
4219 
4220     @Test public void test_rt_39792_goLeft_goPastEnd() {
4221         test_rt_39792(3, colIndex -&gt; {
4222             keyboard.doLeftArrowPress(KeyModifier.SHIFT);
4223             return colIndex - 1;
4224         });
4225     }
4226 
4227     @Test public void test_rt_39792_goRight_goPastEnd() {
4228         test_rt_39792(0, colIndex -&gt; {
4229             keyboard.doRightArrowPress(KeyModifier.SHIFT);
4230             return colIndex + 1;
4231         });
4232     }
4233 
4234     private void test_rt_39792(int startColumn, Function&lt;Integer, Integer&gt; r) {
4235         ObservableList&lt;String&gt; itemsList = FXCollections.observableArrayList();
4236         for (int i = 0; i &lt; 10; i++) {
4237             itemsList.add(&quot;Row &quot; + i);
4238         }
4239 
4240         tableView.setItems(itemsList);
4241 
4242         tableView.getColumns().clear();
4243         for (int i = 0; i &lt; 4; i++) {
4244             TableColumn&lt;String, String&gt; col = new TableColumn&lt;&gt;(&quot;Column &quot; + i);
4245             col.setCellValueFactory(param -&gt; new ReadOnlyStringWrapper(param.getValue()));
4246             tableView.getColumns().add(col);
4247         }
4248 
4249         TableView.TableViewSelectionModel&lt;String&gt; sm = tableView.getSelectionModel();
4250         sm.setSelectionMode(SelectionMode.MULTIPLE);
4251         sm.setCellSelectionEnabled(true);
4252 
4253         ObservableList&lt;Integer&gt; indices = sm.getSelectedIndices();
4254         ObservableList&lt;String&gt; items = sm.getSelectedItems();
4255 
4256         StageLoader sl = new StageLoader(tableView);
4257 
4258         assertEquals(0, indices.size());
4259         assertEquals(0, items.size());
4260 
4261         sm.select(0, tableView.getColumns().get(startColumn));
4262         assertEquals(1, sm.getSelectedCells().size());
4263 
4264         int expectedColumn = r.apply(startColumn);
4265         assertEquals(2, sm.getSelectedCells().size());
4266 
4267         expectedColumn = r.apply(expectedColumn);
4268         assertEquals(3, sm.getSelectedCells().size());
4269 
4270         expectedColumn = r.apply(expectedColumn);
4271         assertEquals(4, sm.getSelectedCells().size());
4272 
4273         // this should not cause any issue, but it does - as noted in RT-39792
4274         /*expectedColumn = */r.apply(expectedColumn);
4275         assertEquals(4, sm.getSelectedCells().size());
4276 
4277         sl.dispose();
4278     }
4279 
4280     @Test public void test_jdk_8160858() {
4281         // create a button to move focus over to
4282         Button btn = new Button(&quot;Button&quot;);
4283         ((Group)tableView.getScene().getRoot()).getChildren().add(btn);
4284 
4285         tableView.requestFocus();
4286         Toolkit.getToolkit().firePulse();
4287         assertEquals(stageLoader.getStage().getScene().getFocusOwner(), tableView);
4288 
4289         // we expect initially that selection is on -1, and focus is on 0
4290         assertEquals(-1, sm.getSelectedIndex());
4291         assertEquals(0, fm.getFocusedIndex());
4292 
4293         keyboard.doDownArrowPress();
4294         assertEquals(1, sm.getSelectedIndex());
4295         assertEquals(1, fm.getFocusedIndex());
4296 
4297         btn.requestFocus();
4298         Toolkit.getToolkit().firePulse();
4299         assertEquals(stageLoader.getStage().getScene().getFocusOwner(), btn);
4300 
4301         sm.setCellSelectionEnabled(true);
4302 
4303         tableView.requestFocus();
4304         Toolkit.getToolkit().firePulse();
4305         assertEquals(stageLoader.getStage().getScene().getFocusOwner(), tableView);
4306 
4307         assertEquals(1, sm.getSelectedIndex());
4308         assertEquals(1, fm.getFocusedIndex());
4309     }
4310 
4311     @Test public void test_jdk_8222214() {
4312         tableView.getFocusModel().focus(0);
4313         keyboard.doUpArrowPress();
4314 
4315         assertEquals(0, tableView.getSelectionModel().getSelectedIndex());
4316     }
4317 }
    </pre>
  </body>
</html>