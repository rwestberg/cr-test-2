<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Old modules/javafx.controls/src/test/java/test/javafx/scene/control/ListViewTest.java</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
  <body>
    <pre>
   1 /*
   2  * Copyright (c) 2011, 2018, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.  Oracle designates this
   8  * particular file as subject to the &quot;Classpath&quot; exception as provided
   9  * by Oracle in the LICENSE file that accompanied this code.
  10  *
  11  * This code is distributed in the hope that it will be useful, but WITHOUT
  12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  14  * version 2 for more details (a copy is included in the LICENSE file that
  15  * accompanied this code).
  16  *
  17  * You should have received a copy of the GNU General Public License version
  18  * 2 along with this work; if not, write to the Free Software Foundation,
  19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  20  *
  21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  22  * or visit www.oracle.com if you need additional information or have any
  23  * questions.
  24  */
  25 
  26 package test.javafx.scene.control;
  27 
  28 import com.sun.javafx.scene.control.VirtualScrollBar;
  29 import com.sun.javafx.scene.control.behavior.ListCellBehavior;
  30 import com.sun.javafx.tk.Toolkit;
  31 import java.util.ArrayList;
  32 import java.util.Arrays;
  33 import java.util.Collections;
  34 import java.util.List;
  35 import java.util.ListIterator;
  36 import java.util.NoSuchElementException;
  37 import javafx.application.Platform;
  38 import javafx.beans.binding.Bindings;
  39 import javafx.beans.property.ObjectProperty;
  40 import javafx.beans.property.ReadOnlyBooleanWrapper;
  41 import javafx.beans.property.SimpleObjectProperty;
  42 import javafx.collections.FXCollections;
  43 import javafx.collections.ListChangeListener;
  44 import javafx.collections.ObservableList;
  45 import javafx.collections.transformation.SortedList;
  46 import javafx.scene.control.Button;
  47 import javafx.scene.control.FocusModel;
  48 import javafx.scene.control.IndexedCell;
  49 import javafx.scene.control.ListCell;
  50 import javafx.scene.control.ListCellShim;
  51 import javafx.scene.control.ListView;
  52 import javafx.scene.control.ListViewShim;
  53 import javafx.scene.control.MultipleSelectionModel;
  54 import javafx.scene.control.SelectionMode;
  55 import javafx.scene.control.SelectionModel;
  56 import javafx.scene.control.TextField;
  57 import javafx.scene.control.cell.CheckBoxListCell;
  58 import javafx.scene.control.cell.ComboBoxListCell;
  59 import javafx.scene.control.cell.TextFieldListCell;
  60 import javafx.scene.image.ImageView;
  61 import javafx.scene.input.KeyCode;
  62 import javafx.scene.layout.VBox;
  63 import javafx.scene.paint.Color;
  64 import javafx.scene.shape.Rectangle;
  65 import javafx.util.Callback;
  66 import static org.junit.Assert.assertArrayEquals;
  67 import static org.junit.Assert.assertEquals;
  68 import static org.junit.Assert.assertFalse;
  69 import static org.junit.Assert.assertNotNull;
  70 import static org.junit.Assert.assertNull;
  71 import static org.junit.Assert.assertSame;
  72 import static org.junit.Assert.assertTrue;
  73 import static org.junit.Assert.fail;
  74 import org.junit.Before;
  75 import org.junit.Test;
  76 import static test.com.sun.javafx.scene.control.infrastructure.ControlTestUtils.assertStyleClassContains;
  77 import test.com.sun.javafx.scene.control.infrastructure.KeyEventFirer;
  78 import test.com.sun.javafx.scene.control.infrastructure.KeyModifier;
  79 import test.com.sun.javafx.scene.control.infrastructure.StageLoader;
  80 import test.com.sun.javafx.scene.control.infrastructure.VirtualFlowTestUtils;
  81 import test.com.sun.javafx.scene.control.test.Person;
  82 import test.com.sun.javafx.scene.control.test.RT_22463_Person;
  83 
  84 public class ListViewTest {
  85     private ListView&lt;String&gt; listView;
  86     private MultipleSelectionModel&lt;String&gt; sm;
  87     private FocusModel&lt;String&gt; fm;
  88 
  89     @Before public void setup() {
  90         listView = new ListView&lt;&gt;();
  91         sm = listView.getSelectionModel();
  92         fm = listView.getFocusModel();
  93     }
  94 
  95 
  96     /*********************************************************************
  97      * Tests for the constructors                                        *
  98      ********************************************************************/
  99 
 100     @Test public void noArgConstructorSetsTheStyleClass() {
 101         assertStyleClassContains(listView, &quot;list-view&quot;);
 102     }
 103 
 104     @Test public void noArgConstructorSetsNonNullSelectionModel() {
 105         assertNotNull(sm);
 106     }
 107 
 108     @Test public void noArgConstructorSetsNonNullItems() {
 109         assertNotNull(listView.getItems());
 110     }
 111 
 112     @Test public void noArgConstructor_selectedItemIsNull() {
 113         assertNull(sm.getSelectedItem());
 114     }
 115 
 116     @Test public void noArgConstructor_selectedIndexIsNegativeOne() {
 117         assertEquals(-1, sm.getSelectedIndex());
 118     }
 119 
 120     @Test public void singleArgConstructorSetsTheStyleClass() {
 121         final ListView&lt;String&gt; b2 = new ListView&lt;&gt;(FXCollections.observableArrayList(&quot;Hi&quot;));
 122         assertStyleClassContains(b2, &quot;list-view&quot;);
 123     }
 124 
 125     @Test public void singleArgConstructorSetsNonNullSelectionModel() {
 126         final ListView&lt;String&gt; b2 = new ListView&lt;&gt;(FXCollections.&lt;String&gt;observableArrayList(&quot;Hi&quot;));
 127         assertNotNull(b2.getSelectionModel());
 128     }
 129 
 130     @Test public void singleArgConstructorAllowsNullItems() {
 131         final ListView&lt;String&gt; b2 = new ListView&lt;String&gt;(null);
 132         assertNull(b2.getItems());
 133     }
 134 
 135     @Test public void singleArgConstructorTakesItems() {
 136         ObservableList&lt;String&gt; items = FXCollections.observableArrayList(&quot;Hi&quot;);
 137         final ListView&lt;String&gt; b2 = new ListView&lt;&gt;(items);
 138         assertSame(items, b2.getItems());
 139     }
 140 
 141     @Test public void singleArgConstructor_selectedItemIsNull() {
 142         final ListView&lt;String&gt; b2 = new ListView&lt;&gt;(FXCollections.observableArrayList(&quot;Hi&quot;));
 143         assertNull(b2.getSelectionModel().getSelectedItem());
 144     }
 145 
 146     @Test public void singleArgConstructor_selectedIndexIsNegativeOne() {
 147         final ListView&lt;String&gt; b2 = new ListView&lt;&gt;(FXCollections.observableArrayList(&quot;Hi&quot;));
 148         assertEquals(-1, b2.getSelectionModel().getSelectedIndex());
 149     }
 150 
 151     /*********************************************************************
 152      * Tests for selection model                                         *
 153      ********************************************************************/
 154 
 155     @Test public void selectionModelCanBeNull() {
 156         listView.setSelectionModel(null);
 157         assertNull(listView.getSelectionModel());
 158     }
 159 
 160     @Test public void selectionModelCanBeBound() {
 161         MultipleSelectionModel&lt;String&gt; sm = ListViewShim.&lt;String&gt;getListViewBitSetSelectionModel(listView);
 162         ObjectProperty&lt;MultipleSelectionModel&lt;String&gt;&gt; other = new SimpleObjectProperty&lt;MultipleSelectionModel&lt;String&gt;&gt;(sm);
 163         listView.selectionModelProperty().bind(other);
 164         assertSame(sm, sm);
 165     }
 166 
 167     @Test public void selectionModelCanBeChanged() {
 168         MultipleSelectionModel&lt;String&gt; sm = ListViewShim.&lt;String&gt;getListViewBitSetSelectionModel(listView);
 169         listView.setSelectionModel(sm);
 170         assertSame(sm, sm);
 171     }
 172 
 173     @Test public void canSetSelectedItemToAnItemEvenWhenThereAreNoItems() {
 174         final String randomString = new String(&quot;I AM A CRAZY RANDOM STRING&quot;);
 175         sm.select(randomString);
 176         assertEquals(-1, sm.getSelectedIndex());
 177         assertSame(randomString, sm.getSelectedItem());
 178     }
 179 
 180     @Test public void canSetSelectedItemToAnItemNotInTheDataModel() {
 181         listView.getItems().addAll(&quot;Apple&quot;, &quot;Orange&quot;, &quot;Banana&quot;);
 182         final String randomString = new String(&quot;I AM A CRAZY RANDOM STRING&quot;);
 183         sm.select(randomString);
 184         assertEquals(-1, sm.getSelectedIndex());
 185         assertSame(randomString, sm.getSelectedItem());
 186     }
 187 
 188     @Test public void settingTheSelectedItemToAnItemInItemsResultsInTheCorrectSelectedIndex() {
 189         listView.getItems().addAll(&quot;Apple&quot;, &quot;Orange&quot;, &quot;Banana&quot;);
 190         sm.select(&quot;Orange&quot;);
 191         assertEquals(1, sm.getSelectedIndex());
 192         assertSame(&quot;Orange&quot;, sm.getSelectedItem());
 193     }
 194 
 195     @Test public void settingTheSelectedItemToANonexistantItemAndThenSettingItemsWhichContainsItResultsInCorrectSelectedIndex() {
 196         sm.select(&quot;Orange&quot;);
 197         listView.getItems().addAll(&quot;Apple&quot;, &quot;Orange&quot;, &quot;Banana&quot;);
 198         assertEquals(1, sm.getSelectedIndex());
 199         assertSame(&quot;Orange&quot;, sm.getSelectedItem());
 200     }
 201 
 202     @Test public void ensureSelectionClearsWhenAllItemsAreRemoved_selectIndex0() {
 203         listView.getItems().addAll(&quot;Apple&quot;, &quot;Orange&quot;, &quot;Banana&quot;);
 204         sm.select(0);
 205         listView.getItems().clear();
 206         assertEquals(-1, sm.getSelectedIndex());
 207         assertEquals(null, sm.getSelectedItem());
 208     }
 209 
 210     @Test public void ensureSelectionClearsWhenAllItemsAreRemoved_selectIndex2() {
 211         listView.getItems().addAll(&quot;Apple&quot;, &quot;Orange&quot;, &quot;Banana&quot;);
 212         sm.select(2);
 213         listView.getItems().clear();
 214         assertEquals(-1, sm.getSelectedIndex());
 215         assertEquals(null, sm.getSelectedItem());
 216     }
 217 
 218     @Test public void ensureSelectedItemRemainsAccurateWhenItemsAreCleared() {
 219         listView.getItems().addAll(&quot;Apple&quot;, &quot;Orange&quot;, &quot;Banana&quot;);
 220         sm.select(2);
 221         listView.getItems().clear();
 222         assertNull(sm.getSelectedItem());
 223         assertEquals(-1, sm.getSelectedIndex());
 224 
 225         listView.getItems().addAll(&quot;Kiwifruit&quot;, &quot;Mandarin&quot;, &quot;Pineapple&quot;);
 226         sm.select(2);
 227         assertEquals(&quot;Pineapple&quot;, sm.getSelectedItem());
 228     }
 229 
 230     @Test public void ensureSelectionShiftsDownWhenOneNewItemIsAdded() {
 231         listView.getItems().addAll(&quot;Apple&quot;, &quot;Orange&quot;, &quot;Banana&quot;);
 232         sm.select(1);
 233         assertEquals(1, sm.getSelectedIndex());
 234         assertEquals(&quot;Orange&quot;, sm.getSelectedItem());
 235 
 236         listView.getItems().add(0, &quot;Kiwifruit&quot;);
 237         assertEquals(2, sm.getSelectedIndex());
 238         assertEquals(&quot;Orange&quot;, sm.getSelectedItem());
 239     }
 240 
 241     @Test public void ensureSelectionShiftsDownWhenMultipleNewItemAreAdded() {
 242         listView.getItems().addAll(&quot;Apple&quot;, &quot;Orange&quot;, &quot;Banana&quot;);
 243         sm.select(1);
 244         assertEquals(1, sm.getSelectedIndex());
 245         assertEquals(&quot;Orange&quot;, sm.getSelectedItem());
 246 
 247         listView.getItems().addAll(0, Arrays.asList(&quot;Kiwifruit&quot;, &quot;Pineapple&quot;, &quot;Mandarin&quot;));
 248         assertEquals(&quot;Orange&quot;, sm.getSelectedItem());
 249         assertEquals(4, sm.getSelectedIndex());
 250     }
 251 
 252     @Test public void ensureSelectionShiftsUpWhenOneItemIsRemoved() {
 253         listView.getItems().addAll(&quot;Apple&quot;, &quot;Orange&quot;, &quot;Banana&quot;);
 254         sm.select(1);
 255         assertEquals(1, sm.getSelectedIndex());
 256         assertEquals(&quot;Orange&quot;, sm.getSelectedItem());
 257 
 258         listView.getItems().remove(&quot;Apple&quot;);
 259         assertEquals(0, sm.getSelectedIndex());
 260         assertEquals(&quot;Orange&quot;, sm.getSelectedItem());
 261     }
 262 
 263     @Test public void ensureSelectionShiftsUpWheMultipleItemsAreRemoved() {
 264         listView.getItems().addAll(&quot;Apple&quot;, &quot;Orange&quot;, &quot;Banana&quot;);
 265         sm.select(2);
 266         assertEquals(2, sm.getSelectedIndex());
 267         assertEquals(&quot;Banana&quot;, sm.getSelectedItem());
 268 
 269         listView.getItems().removeAll(Arrays.asList(&quot;Apple&quot;, &quot;Orange&quot;));
 270         assertEquals(0, sm.getSelectedIndex());
 271         assertEquals(&quot;Banana&quot;, sm.getSelectedItem());
 272     }
 273 
 274     @Test public void ensureSelectionIsCorrectWhenItemsChange() {
 275         listView.setItems(FXCollections.observableArrayList(&quot;Item 1&quot;));
 276         sm.select(0);
 277         assertEquals(&quot;Item 1&quot;, sm.getSelectedItem());
 278 
 279         listView.setItems(FXCollections.observableArrayList(&quot;Item 2&quot;));
 280         assertEquals(-1, sm.getSelectedIndex());
 281         assertNull(sm.getSelectedItem());
 282         assertEquals(0, fm.getFocusedIndex());
 283         assertEquals(&quot;Item 2&quot;, fm.getFocusedItem());
 284     }
 285 
 286     @Test public void test_rt15793() {
 287         // ListView selectedIndex is 0 although the items list is empty
 288         final ListView lv = new ListView();
 289         final ObservableList list = FXCollections.observableArrayList();
 290         lv.setItems(list);
 291         list.add(&quot;toto&quot;);
 292         lv.getSelectionModel().select(0);
 293         assertEquals(0, lv.getSelectionModel().getSelectedIndex());
 294         list.remove(0);
 295         assertEquals(-1, lv.getSelectionModel().getSelectedIndex());
 296     }
 297 
 298     @Test public void test_rt17522_focusShouldMoveWhenItemAddedAtFocusIndex() {
 299         final ListView lv = new ListView();
 300         FocusModel fm = lv.getFocusModel();
 301         lv.getItems().add(&quot;row1&quot;);
 302         fm.focus(0);
 303         assertTrue(fm.isFocused(0));
 304 
 305         lv.getItems().add(0, &quot;row0&quot;);
 306         assertTrue(fm.isFocused(1));
 307     }
 308 
 309     @Test public void test_rt17522_focusShouldMoveWhenItemAddedBeforeFocusIndex() {
 310         final ListView lv = new ListView();
 311         FocusModel fm = lv.getFocusModel();
 312         lv.getItems().addAll(&quot;row1&quot;, &quot;row2&quot;);
 313         fm.focus(1);
 314         assertTrue(fm.isFocused(1));
 315         assertEquals(&quot;row2&quot;, fm.getFocusedItem());
 316 
 317         lv.getItems().add(1, &quot;row0&quot;);
 318         assertTrue(fm.isFocused(2));
 319         assertEquals(&quot;row2&quot;, fm.getFocusedItem());
 320         assertFalse(fm.isFocused(1));
 321     }
 322 
 323     @Test public void test_rt17522_focusShouldNotMoveWhenItemAddedAfterFocusIndex() {
 324         final ListView lv = new ListView();
 325         FocusModel fm = lv.getFocusModel();
 326         lv.getItems().addAll(&quot;row1&quot;);
 327         fm.focus(0);
 328         assertTrue(fm.isFocused(0));
 329         assertEquals(&quot;row1&quot;, fm.getFocusedItem());
 330 
 331         lv.getItems().add(1, &quot;row2&quot;);
 332         assertTrue(fm.isFocused(0));
 333         assertEquals(&quot;row1&quot;, fm.getFocusedItem());
 334         assertFalse(fm.isFocused(1));
 335     }
 336 
 337     @Test public void test_rt17522_focusShouldBeResetWhenFocusedItemIsRemoved() {
 338         final ListView lv = new ListView();
 339         FocusModel fm = lv.getFocusModel();
 340         lv.getItems().add(&quot;row1&quot;);
 341         fm.focus(0);
 342         assertTrue(fm.isFocused(0));
 343 
 344         lv.getItems().remove(&quot;row1&quot;);
 345         assertTrue(fm.getFocusedIndex() == -1);
 346         assertNull(fm.getFocusedItem());
 347     }
 348 
 349     @Test public void test_rt17522_focusShouldMoveWhenItemRemovedBeforeFocusIndex() {
 350         final ListView lv = new ListView();
 351         FocusModel fm = lv.getFocusModel();
 352         lv.getItems().addAll(&quot;row1&quot;, &quot;row2&quot;);
 353         fm.focus(1);
 354         assertTrue(fm.isFocused(1));
 355         assertEquals(&quot;row2&quot;, fm.getFocusedItem());
 356 
 357         lv.getItems().remove(&quot;row1&quot;);
 358         assertTrue(fm.isFocused(0));
 359         assertEquals(&quot;row2&quot;, fm.getFocusedItem());
 360     }
 361 
 362     @Test public void test_rt17522_focusShouldNotMoveWhenItemRemovedAfterFocusIndex() {
 363         final ListView lv = new ListView();
 364         FocusModel fm = lv.getFocusModel();
 365         lv.getItems().addAll(&quot;row1&quot;, &quot;row2&quot;);
 366         fm.focus(0);
 367         assertTrue(fm.isFocused(0));
 368         assertEquals(&quot;row1&quot;, fm.getFocusedItem());
 369 
 370         lv.getItems().remove(&quot;row2&quot;);
 371         assertTrue(fm.isFocused(0));
 372         assertEquals(&quot;row1&quot;, fm.getFocusedItem());
 373     }
 374 
 375     @Test public void test_rt18385() {
 376         listView.getItems().addAll(&quot;row1&quot;, &quot;row2&quot;, &quot;row3&quot;);
 377         sm.select(1);
 378         listView.getItems().add(&quot;Another Row&quot;);
 379         assertEquals(1, sm.getSelectedIndices().size());
 380         assertEquals(1, sm.getSelectedItems().size());
 381     }
 382 
 383     @Test public void test_rt18339_onlyEditWhenListViewIsEditable_editableIsFalse() {
 384         listView.setEditable(false);
 385         listView.edit(1);
 386         assertEquals(-1, listView.getEditingIndex());
 387     }
 388 
 389     @Test public void test_rt18339_onlyEditWhenListViewIsEditable_editableIsTrue() {
 390         listView.setEditable(true);
 391         listView.edit(1);
 392         assertEquals(1, listView.getEditingIndex());
 393     }
 394 
 395     @Test public void test_rt14451() {
 396         listView.getItems().addAll(&quot;Apple&quot;, &quot;Orange&quot;, &quot;Banana&quot;);
 397         sm.setSelectionMode(SelectionMode.MULTIPLE);
 398         sm.selectRange(0, 2); // select from 0 (inclusive) to 2 (exclusive)
 399         assertEquals(2, sm.getSelectedIndices().size());
 400     }
 401 
 402     private int rt_18969_hitCount = 0;
 403     @Test public void test_rt18969() {
 404         rt_18969_hitCount = 0;
 405         ObservableList&lt;String&gt; emptyModel = FXCollections.observableArrayList();
 406         listView.setItems(emptyModel);
 407         assertTrue(listView.getItems().isEmpty());
 408 
 409         sm.selectedItemProperty().addListener((observable, oldValue, newValue) -&gt; {
 410             rt_18969_hitCount++;
 411         });
 412 
 413         ObservableList&lt;String&gt; mod = FXCollections.observableArrayList();
 414         mod.add(System.currentTimeMillis()+&quot;&quot;);
 415         listView.getItems().setAll(mod);
 416 
 417         sm.select(0);
 418         assertTrue(sm.isSelected(0));
 419         assertEquals(1, rt_18969_hitCount);
 420 
 421         // sleep for 100ms so that the currentTimeMillis is guaranteed to be
 422         // a different value than the first one
 423         try {
 424             Thread.sleep(100);
 425         } catch (InterruptedException ex) {
 426             ex.printStackTrace();
 427         }
 428 
 429         // the list is totally changing (it is being cleared), so we should
 430         // be nulling out the selection model state
 431         mod = FXCollections.observableArrayList();
 432         mod.add(System.currentTimeMillis()+&quot;&quot;);
 433         listView.getItems().setAll(mod);
 434 
 435         // it should be two, as there is no null event in between (although there
 436         // used to be, so the test used to be for three hits)
 437         assertEquals(2, rt_18969_hitCount);
 438     }
 439 
 440     @Test public void test_rt21586() {
 441         listView.getItems().setAll(&quot;Apple&quot;, &quot;Orange&quot;, &quot;Banana&quot;);
 442         listView.getSelectionModel().select(1);
 443         assertEquals(1, listView.getSelectionModel().getSelectedIndex());
 444         assertEquals(&quot;Orange&quot;, listView.getSelectionModel().getSelectedItem());
 445 
 446         listView.getItems().setAll(&quot;Kiwifruit&quot;, &quot;Pineapple&quot;, &quot;Grape&quot;);
 447         assertEquals(-1, listView.getSelectionModel().getSelectedIndex());
 448         assertNull(listView.getSelectionModel().getSelectedItem());
 449     }
 450 
 451     @Test public void test_rt27820_1() {
 452         listView.getItems().setAll(&quot;Apple&quot;, &quot;Orange&quot;);
 453         listView.getSelectionModel().select(0);
 454         assertEquals(1, listView.getSelectionModel().getSelectedItems().size());
 455         assertEquals(&quot;Apple&quot;, listView.getSelectionModel().getSelectedItem());
 456 
 457         listView.getItems().clear();
 458         assertEquals(0, listView.getSelectionModel().getSelectedItems().size());
 459         assertNull(listView.getSelectionModel().getSelectedItem());
 460     }
 461 
 462     @Test public void test_rt27820_2() {
 463         listView.getItems().setAll(&quot;Apple&quot;, &quot;Orange&quot;);
 464         listView.getSelectionModel().select(1);
 465         assertEquals(1, listView.getSelectionModel().getSelectedItems().size());
 466         assertEquals(&quot;Orange&quot;, listView.getSelectionModel().getSelectedItem());
 467 
 468         listView.getItems().clear();
 469         assertEquals(0, listView.getSelectionModel().getSelectedItems().size());
 470         assertNull(listView.getSelectionModel().getSelectedItem());
 471     }
 472 
 473     @Test public void test_rt28534() {
 474         ListView&lt;Person&gt; list = new ListView&lt;Person&gt;();
 475         list.setItems(FXCollections.observableArrayList(
 476                 new Person(&quot;Jacob&quot;, &quot;Smith&quot;, &quot;jacob.smith@example.com&quot;),
 477                 new Person(&quot;Isabella&quot;, &quot;Johnson&quot;, &quot;isabella.johnson@example.com&quot;),
 478                 new Person(&quot;Ethan&quot;, &quot;Williams&quot;, &quot;ethan.williams@example.com&quot;),
 479                 new Person(&quot;Emma&quot;, &quot;Jones&quot;, &quot;emma.jones@example.com&quot;),
 480                 new Person(&quot;Michael&quot;, &quot;Brown&quot;, &quot;michael.brown@example.com&quot;)));
 481 
 482         VirtualFlowTestUtils.assertRowsNotEmpty(list, 0, 5); // rows 0 - 5 should be filled
 483         VirtualFlowTestUtils.assertRowsEmpty(list, 5, -1); // rows 5+ should be empty
 484 
 485         // now we replace the data and expect the cells that have no data
 486         // to be empty
 487         list.setItems(FXCollections.observableArrayList(
 488                 new Person(&quot;*_*Emma&quot;, &quot;Jones&quot;, &quot;emma.jones@example.com&quot;),
 489                 new Person(&quot;_Michael&quot;, &quot;Brown&quot;, &quot;michael.brown@example.com&quot;)));
 490 
 491         VirtualFlowTestUtils.assertRowsNotEmpty(list, 0, 2); // rows 0 - 2 should be filled
 492         VirtualFlowTestUtils.assertRowsEmpty(list, 2, -1); // rows 2+ should be empty
 493     }
 494 
 495     @Test public void test_rt22463() {
 496         final ListView&lt;RT_22463_Person&gt; list = new ListView&lt;RT_22463_Person&gt;();
 497 
 498         // before the change things display fine
 499         RT_22463_Person p1 = new RT_22463_Person();
 500         p1.setId(1l);
 501         p1.setName(&quot;name1&quot;);
 502         RT_22463_Person p2 = new RT_22463_Person();
 503         p2.setId(2l);
 504         p2.setName(&quot;name2&quot;);
 505         list.setItems(FXCollections.observableArrayList(p1, p2));
 506         VirtualFlowTestUtils.assertCellTextEquals(list, 0, &quot;name1&quot;);
 507         VirtualFlowTestUtils.assertCellTextEquals(list, 1, &quot;name2&quot;);
 508 
 509         // now we change the persons but they are still equal as the ID&#39;s don&#39;t
 510         // change - but the items list is cleared so the cells should update
 511         RT_22463_Person new_p1 = new RT_22463_Person();
 512         new_p1.setId(1l);
 513         new_p1.setName(&quot;updated name1&quot;);
 514         RT_22463_Person new_p2 = new RT_22463_Person();
 515         new_p2.setId(2l);
 516         new_p2.setName(&quot;updated name2&quot;);
 517         list.getItems().clear();
 518         list.setItems(FXCollections.observableArrayList(new_p1, new_p2));
 519         VirtualFlowTestUtils.assertCellTextEquals(list, 0, &quot;updated name1&quot;);
 520         VirtualFlowTestUtils.assertCellTextEquals(list, 1, &quot;updated name2&quot;);
 521     }
 522 
 523     @Test public void test_rt28637() {
 524         ObservableList&lt;String&gt; items = FXCollections.observableArrayList(&quot;String1&quot;, &quot;String2&quot;, &quot;String3&quot;, &quot;String4&quot;);
 525 
 526         final ListView&lt;String&gt; listView = new ListView&lt;String&gt;();
 527         listView.setItems(items);
 528 
 529         listView.getSelectionModel().select(0);
 530         assertEquals(&quot;String1&quot;, listView.getSelectionModel().getSelectedItem());
 531         assertEquals(&quot;String1&quot;, listView.getSelectionModel().getSelectedItems().get(0));
 532         assertEquals(0, listView.getSelectionModel().getSelectedIndex());
 533 
 534         items.remove(listView.getSelectionModel().getSelectedItem());
 535         assertEquals(&quot;String2&quot;, listView.getSelectionModel().getSelectedItem());
 536         assertEquals(&quot;String2&quot;, listView.getSelectionModel().getSelectedItems().get(0));
 537         assertEquals(0, listView.getSelectionModel().getSelectedIndex());
 538     }
 539 
 540     @Test public void test_rt28819_1() {
 541         ObservableList&lt;String&gt; emptyModel = FXCollections.observableArrayList();
 542 
 543         final ListView&lt;String&gt; listView = new ListView&lt;String&gt;();
 544         listView.setItems(emptyModel);
 545         VirtualFlowTestUtils.assertRowsEmpty(listView, 0, 5);
 546 
 547         ObservableList&lt;String&gt; mod = FXCollections.observableArrayList();
 548         String value = System.currentTimeMillis()+&quot;&quot;;
 549         mod.add(value);
 550         listView.setItems(mod);
 551         VirtualFlowTestUtils.assertCellCount(listView, 1);
 552         VirtualFlowTestUtils.assertCellTextEquals(listView, 0, value);
 553     }
 554 
 555     @Test public void test_rt28819_2() {
 556         ObservableList&lt;String&gt; emptyModel = FXCollections.observableArrayList();
 557 
 558         final ListView&lt;String&gt; listView = new ListView&lt;String&gt;();
 559         listView.setItems(emptyModel);
 560         VirtualFlowTestUtils.assertRowsEmpty(listView, 0, 5);
 561 
 562         ObservableList&lt;String&gt; mod1 = FXCollections.observableArrayList();
 563         String value1 = System.currentTimeMillis()+&quot;&quot;;
 564         mod1.add(value1);
 565         listView.getItems().setAll(mod1);
 566         VirtualFlowTestUtils.assertCellCount(listView, 1);
 567         VirtualFlowTestUtils.assertCellTextEquals(listView, 0, value1);
 568     }
 569 
 570     @Test public void test_rt29390() {
 571         ObservableList&lt;String&gt; items = FXCollections.observableArrayList(
 572                 &quot;String1&quot;, &quot;String2&quot;, &quot;String3&quot;, &quot;String4&quot;,
 573                 &quot;String1&quot;, &quot;String2&quot;, &quot;String3&quot;, &quot;String4&quot;,
 574                 &quot;String1&quot;, &quot;String2&quot;, &quot;String3&quot;, &quot;String4&quot;,
 575                 &quot;String1&quot;, &quot;String2&quot;, &quot;String3&quot;, &quot;String4&quot;
 576         );
 577 
 578         final ListView&lt;String&gt; listView = new ListView&lt;String&gt;(items);
 579         listView.setMaxHeight(50);
 580         listView.setPrefHeight(50);
 581 
 582         // we want the vertical scrollbar
 583         VirtualScrollBar scrollBar = VirtualFlowTestUtils.getVirtualFlowVerticalScrollbar(listView);
 584 
 585         assertNotNull(scrollBar);
 586         assertTrue(scrollBar.isVisible());
 587         assertTrue(scrollBar.getVisibleAmount() &gt; 0.0);
 588         assertTrue(scrollBar.getVisibleAmount() &lt; 1.0);
 589 
 590         // this next test is likely to be brittle, but we&#39;ll see...If it is the
 591         // cause of failure then it can be commented out
 592         assertEquals(0.125, scrollBar.getVisibleAmount(), 0.0);
 593     }
 594 
 595     @Test public void test_rt30400() {
 596         // create a listview that&#39;ll render cells using the check box cell factory
 597         ObservableList&lt;String&gt; items = FXCollections.observableArrayList(&quot;String1&quot;);
 598         final ListView&lt;String&gt; listView = new ListView&lt;String&gt;(items);
 599         listView.setMinHeight(100);
 600         listView.setPrefHeight(100);
 601         listView.setCellFactory(CheckBoxListCell.forListView(param -&gt; new ReadOnlyBooleanWrapper(true)));
 602 
 603         // because only the first row has data, all other rows should be
 604         // empty (and not contain check boxes - we just check the first four here)
 605         VirtualFlowTestUtils.assertRowsNotEmpty(listView, 0, 1);
 606         VirtualFlowTestUtils.assertCellNotEmpty(VirtualFlowTestUtils.getCell(listView, 0));
 607         VirtualFlowTestUtils.assertCellEmpty(VirtualFlowTestUtils.getCell(listView, 1));
 608         VirtualFlowTestUtils.assertCellEmpty(VirtualFlowTestUtils.getCell(listView, 2));
 609         VirtualFlowTestUtils.assertCellEmpty(VirtualFlowTestUtils.getCell(listView, 3));
 610     }
 611 
 612     @Test public void test_rt29420() {
 613         final ListView&lt;String&gt; listView = new ListView&lt;String&gt;();
 614 
 615         VBox vbox = new VBox(listView);
 616         StageLoader sl = new StageLoader(vbox);
 617 
 618         // the initial width of a ListView should be the golden rectangle where
 619         // the height is hardcoded to be 400
 620         final double initialWidth = listView.prefWidth(-1);
 621         assertEquals(400 * 0.618033987, initialWidth, 0.00);
 622 
 623         // add in some items, and re-measure - seeing as the items are narrow,
 624         // the width shouldn&#39;t change
 625         listView.getItems().addAll(&quot;one&quot;, &quot;two&quot;, &quot;three&quot;, &quot;four&quot;, &quot;five&quot;, &quot;six&quot;);
 626         Toolkit.getToolkit().firePulse();
 627         final double withContentWidth = listView.prefWidth(-1);
 628         assertEquals(initialWidth, withContentWidth, 0.00);
 629 
 630         // remove the items - and the width should remain the same
 631         listView.getItems().clear();
 632         Toolkit.getToolkit().firePulse();
 633         final double afterEmptiedWidth = listView.prefWidth(-1);
 634         assertEquals(initialWidth, afterEmptiedWidth, 0.00);
 635 
 636         sl.dispose();
 637     }
 638 
 639     @Test public void test_rt31165() {
 640         final ObservableList names = FXCollections.observableArrayList(&quot;Adam&quot;, &quot;Alex&quot;, &quot;Alfred&quot;, &quot;Albert&quot;);
 641         final ObservableList data = FXCollections.observableArrayList();
 642         for (int i = 0; i &lt; 18; i++) {
 643             data.add(&quot;&quot;+i);
 644         }
 645 
 646         final ListView listView = new ListView(data);
 647         listView.setPrefSize(200, 250);
 648         listView.setEditable(true);
 649         listView.setCellFactory(ComboBoxListCell.forListView(names));
 650 
 651         IndexedCell cell = VirtualFlowTestUtils.getCell(listView, 1);
 652         assertEquals(&quot;1&quot;, cell.getText());
 653         assertFalse(cell.isEditing());
 654 
 655         listView.edit(1);
 656 
 657         assertEquals(1, listView.getEditingIndex());
 658         assertTrue(cell.isEditing());
 659 
 660         VirtualFlowTestUtils.getVirtualFlow(listView).requestLayout();
 661         Toolkit.getToolkit().firePulse();
 662 
 663         assertEquals(1, listView.getEditingIndex());
 664         assertTrue(cell.isEditing());
 665     }
 666 
 667     @Test public void test_rt31471() {
 668         final ObservableList names = FXCollections.observableArrayList(&quot;Adam&quot;, &quot;Alex&quot;, &quot;Alfred&quot;, &quot;Albert&quot;);
 669         final ListView listView = new ListView(names);
 670 
 671         IndexedCell cell = VirtualFlowTestUtils.getCell(listView, 0);
 672         assertEquals(&quot;Adam&quot;, cell.getItem());
 673 
 674         listView.setFixedCellSize(50);
 675 
 676         VirtualFlowTestUtils.getVirtualFlow(listView).requestLayout();
 677         Toolkit.getToolkit().firePulse();
 678 
 679         assertEquals(&quot;Adam&quot;, cell.getItem());
 680         assertEquals(50, cell.getHeight(), 0.00);
 681     }
 682 
 683     private int rt_31200_count = 0;
 684     @Test public void test_rt_31200() {
 685         final ListView listView = new ListView();
 686         listView.setCellFactory(new Callback&lt;ListView&lt;String&gt;, ListCell&lt;String&gt;&gt;() {
 687             @Override
 688             public ListCell&lt;String&gt; call(ListView&lt;String&gt; param) {
 689                 return new ListCellShim&lt;String&gt;() {
 690                     ImageView view = new ImageView();
 691                     { setGraphic(view); };
 692 
 693                     @Override
 694                     public void updateItem(String item, boolean empty) {
 695                         if (getItem() == null ? item == null : getItem().equals(item)) {
 696                             rt_31200_count++;
 697                         }
 698                         super.updateItem(item, empty);
 699                         if (item == null || empty) {
 700                             view.setImage(null);
 701                             setText(null);
 702                         } else {
 703                             setText(item);
 704                         }
 705                     }
 706                 };
 707             }
 708         });
 709         listView.getItems().setAll(&quot;one&quot;, &quot;two&quot;, &quot;three&quot;, &quot;four&quot;, &quot;five&quot;);
 710 
 711         StageLoader sl = new StageLoader(listView);
 712 
 713         assertEquals(24, rt_31200_count);
 714 
 715         // resize the stage
 716         sl.getStage().setHeight(250);
 717         Toolkit.getToolkit().firePulse();
 718         sl.getStage().setHeight(50);
 719         Toolkit.getToolkit().firePulse();
 720         assertEquals(24, rt_31200_count);
 721 
 722         sl.dispose();
 723     }
 724 
 725     @Test public void test_rt_30484() {
 726         final ListView listView = new ListView();
 727         listView.setCellFactory(new Callback&lt;ListView&lt;String&gt;, ListCell&lt;String&gt;&gt;() {
 728             @Override public ListCell&lt;String&gt; call(ListView&lt;String&gt; param) {
 729                 return new ListCellShim&lt;String&gt;() {
 730                     Rectangle graphic = new Rectangle(10, 10, Color.RED);
 731                     { setGraphic(graphic); };
 732 
 733                     @Override public void updateItem(String item, boolean empty) {
 734                         super.updateItem(item, empty);
 735                         if (item == null || empty) {
 736                             graphic.setVisible(false);
 737                             setText(null);
 738                         } else {
 739                             graphic.setVisible(true);
 740                             setText(item);
 741                         }
 742                     }
 743                 };
 744             }
 745         });
 746 
 747         // First two rows have content, so the graphic should show.
 748         // All other rows have no content, so graphic should not show.
 749         listView.getItems().setAll(&quot;one&quot;, &quot;two&quot;);
 750 
 751         VirtualFlowTestUtils.assertGraphicIsVisible(listView, 0);
 752         VirtualFlowTestUtils.assertGraphicIsVisible(listView, 1);
 753         VirtualFlowTestUtils.assertGraphicIsNotVisible(listView, 2);
 754         VirtualFlowTestUtils.assertGraphicIsNotVisible(listView, 3);
 755         VirtualFlowTestUtils.assertGraphicIsNotVisible(listView, 4);
 756         VirtualFlowTestUtils.assertGraphicIsNotVisible(listView, 5);
 757     }
 758 
 759     private int rt_29650_start_count = 0;
 760     private int rt_29650_commit_count = 0;
 761     private int rt_29650_cancel_count = 0;
 762     @Test public void test_rt_29650() {
 763         listView.setOnEditStart(t -&gt; {
 764             rt_29650_start_count++;
 765         });
 766         listView.setOnEditCommit(t -&gt; {
 767             rt_29650_commit_count++;
 768         });
 769         listView.setOnEditCancel(t -&gt; {
 770             rt_29650_cancel_count++;
 771         });
 772 
 773         listView.getItems().setAll(&quot;one&quot;, &quot;two&quot;, &quot;three&quot;, &quot;four&quot;, &quot;five&quot;);
 774         listView.setEditable(true);
 775         listView.setCellFactory(TextFieldListCell.forListView());
 776 
 777         StageLoader sl = new StageLoader(listView);
 778 
 779         listView.edit(0);
 780 
 781         Toolkit.getToolkit().firePulse();
 782 
 783         ListCell rootCell = (ListCell) VirtualFlowTestUtils.getCell(listView, 0);
 784         TextField textField = (TextField) rootCell.getGraphic();
 785         textField.setText(&quot;Testing!&quot;);
 786         KeyEventFirer keyboard = new KeyEventFirer(textField);
 787         keyboard.doKeyPress(KeyCode.ENTER);
 788 
 789         // TODO should the following assert be enabled?
 790 //        assertEquals(&quot;Testing!&quot;, listView.getItems().get(0));
 791         assertEquals(1, rt_29650_start_count);
 792         assertEquals(1, rt_29650_commit_count);
 793         assertEquals(0, rt_29650_cancel_count);
 794 
 795         sl.dispose();
 796     }
 797 
 798     @Test public void test_rt35039() {
 799         final List&lt;String&gt; data = new ArrayList&lt;&gt;();
 800         data.add(&quot;aabbaa&quot;);
 801         data.add(&quot;bbc&quot;);
 802 
 803         final ListView&lt;String&gt; listView = new ListView&lt;&gt;();
 804         listView.setItems(FXCollections.observableArrayList(data));
 805 
 806         StageLoader sl = new StageLoader(listView);
 807 
 808         // selection starts off on row -1
 809         assertNull(listView.getSelectionModel().getSelectedItem());
 810 
 811         // select &quot;bbc&quot; and ensure everything is set to that
 812         listView.getSelectionModel().select(1);
 813         assertEquals(&quot;bbc&quot;, listView.getSelectionModel().getSelectedItem());
 814 
 815         // change the items list - but retain the same content. We expect
 816         // that &quot;bbc&quot; remains selected as it is still in the list
 817         listView.setItems(FXCollections.observableArrayList(data));
 818         assertEquals(&quot;bbc&quot;, listView.getSelectionModel().getSelectedItem());
 819 
 820         sl.dispose();
 821     }
 822 
 823     @Test public void test_rt35857() {
 824         ObservableList&lt;String&gt; fxList = FXCollections.observableArrayList(&quot;A&quot;, &quot;B&quot;, &quot;C&quot;);
 825         final ListView&lt;String&gt; listView = new ListView&lt;String&gt;(fxList);
 826 
 827         listView.getSelectionModel().select(0);
 828 
 829         ObservableList&lt;String&gt; selectedItems = listView.getSelectionModel().getSelectedItems();
 830         assertEquals(1, selectedItems.size());
 831         assertEquals(&quot;A&quot;, selectedItems.get(0));
 832 
 833         listView.getItems().removeAll(selectedItems);
 834         assertEquals(2, fxList.size());
 835         assertEquals(&quot;B&quot;, fxList.get(0));
 836         assertEquals(&quot;C&quot;, fxList.get(1));
 837     }
 838 
 839     private int rt_35889_cancel_count = 0;
 840     @Test public void test_rt35889() {
 841         final ListView&lt;String&gt; textFieldListView = new ListView&lt;String&gt;();
 842         textFieldListView.setItems(FXCollections.observableArrayList(&quot;A&quot;, &quot;B&quot;, &quot;C&quot;));
 843         textFieldListView.setEditable(true);
 844         textFieldListView.setCellFactory(TextFieldListCell.forListView());
 845         textFieldListView.setOnEditCancel(t -&gt; {
 846             rt_35889_cancel_count++;
 847             System.out.println(&quot;On Edit Cancel: &quot; + t);
 848         });
 849 
 850         ListCell cell0 = (ListCell) VirtualFlowTestUtils.getCell(textFieldListView, 0);
 851         assertNull(cell0.getGraphic());
 852         assertEquals(&quot;A&quot;, cell0.getText());
 853 
 854         textFieldListView.edit(0);
 855         TextField textField = (TextField) cell0.getGraphic();
 856         assertNotNull(textField);
 857 
 858         assertEquals(0, rt_35889_cancel_count);
 859 
 860         textField.setText(&quot;Z&quot;);
 861         KeyEventFirer keyboard = new KeyEventFirer(textField);
 862         keyboard.doKeyPress(KeyCode.ENTER);
 863 
 864         assertEquals(0, rt_35889_cancel_count);
 865     }
 866 
 867     @Test public void test_rt25679() {
 868         Button focusBtn = new Button(&quot;Focus here&quot;);
 869 
 870         final ListView&lt;String&gt; listView = new ListView&lt;String&gt;();
 871         SelectionModel sm = listView.getSelectionModel();
 872         listView.setItems(FXCollections.observableArrayList(&quot;A&quot;, &quot;B&quot;, &quot;C&quot;));
 873 
 874         VBox vbox = new VBox(focusBtn, listView);
 875 
 876         StageLoader sl = new StageLoader(vbox);
 877         sl.getStage().requestFocus();
 878         focusBtn.requestFocus();
 879         Toolkit.getToolkit().firePulse();
 880 
 881         // test initial state
 882         assertEquals(sl.getStage().getScene().getFocusOwner(), focusBtn);
 883         assertTrue(focusBtn.isFocused());
 884         assertEquals(-1, sm.getSelectedIndex());
 885         assertNull(sm.getSelectedItem());
 886 
 887         // move focus to the listview
 888         listView.requestFocus();
 889 
 890         // ensure that there is a selection (where previously there was not one)
 891         assertEquals(sl.getStage().getScene().getFocusOwner(), listView);
 892         assertTrue(listView.isFocused());
 893         assertEquals(-1, sm.getSelectedIndex());
 894         assertNull(sm.getSelectedItem());
 895 
 896         sl.dispose();
 897     }
 898 
 899     private int rt_37061_index_counter = 0;
 900     private int rt_37061_item_counter = 0;
 901     @Test public void test_rt_37061() {
 902         ListView&lt;Integer&gt; tv = new ListView&lt;&gt;();
 903         tv.getItems().add(1);
 904         tv.getSelectionModel().select(0);
 905 
 906         // note we add the listeners after the selection is made, so the counters
 907         // at this point are still both at zero.
 908         tv.getSelectionModel().selectedIndexProperty().addListener((observable, oldValue, newValue) -&gt; {
 909             rt_37061_index_counter++;
 910         });
 911 
 912         tv.getSelectionModel().selectedItemProperty().addListener((observable, oldValue, newValue) -&gt; {
 913             rt_37061_item_counter++;
 914         });
 915 
 916         // add a new item. This does not impact the selected index or selected item
 917         // so the counters should remain at zero.
 918         tv.getItems().add(2);
 919         assertEquals(0, rt_37061_index_counter);
 920         assertEquals(0, rt_37061_item_counter);
 921     }
 922 
 923     private int rt_37538_count = 0;
 924     @Test public void test_rt_37538_noCNextCall() {
 925         test_rt_37538(false, false);
 926     }
 927 
 928     @Test public void test_rt_37538_callCNextOnce() {
 929         test_rt_37538(true, false);
 930     }
 931 
 932     @Test public void test_rt_37538_callCNextInLoop() {
 933         test_rt_37538(false, true);
 934     }
 935 
 936     private void test_rt_37538(boolean callCNextOnce, boolean callCNextInLoop) {
 937         ListView&lt;Integer&gt; list = new ListView&lt;&gt;();
 938         for ( int i = 1; i &lt;= 50; i++ ) {
 939             list.getItems().add(i);
 940         }
 941 
 942         list.getSelectionModel().getSelectedItems().addListener((ListChangeListener.Change&lt;? extends Integer&gt; c) -&gt; {
 943             if (callCNextOnce) {
 944                 c.next();
 945             } else if (callCNextInLoop) {
 946                 while (c.next()) {
 947                     // no-op
 948                 }
 949             }
 950 
 951             if (rt_37538_count &gt;= 1) {
 952                 Thread.dumpStack();
 953                 fail(&quot;This method should only be called once&quot;);
 954             }
 955 
 956             rt_37538_count++;
 957         });
 958 
 959         StageLoader sl = new StageLoader(list);
 960         assertEquals(0, rt_37538_count);
 961         list.getSelectionModel().select(0);
 962         assertEquals(1, rt_37538_count);
 963         sl.dispose();
 964     }
 965 
 966     @Test
 967     public void test_rt_35395_fixedCellSize() {
 968         test_rt_35395(true);
 969     }
 970 
 971     @Test
 972     public void test_rt_35395_notFixedCellSize() {
 973         test_rt_35395(false);
 974     }
 975 
 976     private int rt_35395_counter;
 977 
 978     private void test_rt_35395(boolean useFixedCellSize) {
 979         rt_35395_counter = 0;
 980 
 981         ObservableList&lt;String&gt; items = FXCollections.observableArrayList();
 982         for (int i = 0; i &lt; 20; ++i) {
 983             items.addAll(&quot;red&quot;, &quot;green&quot;, &quot;blue&quot;, &quot;purple&quot;);
 984         }
 985 
 986         ListView&lt;String&gt; listView = new ListView&lt;&gt;(items);
 987         if (useFixedCellSize) {
 988             listView.setFixedCellSize(24);
 989         }
 990         listView.setCellFactory(lv -&gt; new ListCellShim&lt;String&gt;() {
 991             @Override
 992             public void updateItem(String color, boolean empty) {
 993                 rt_35395_counter += 1;
 994                 super.updateItem(color, empty);
 995                 setText(null);
 996                 if (empty) {
 997                     setGraphic(null);
 998                 } else {
 999                     Rectangle rect = new Rectangle(16, 16);
1000                     rect.setStyle(&quot;-fx-fill: &quot; + color);
1001                     setGraphic(rect);
1002                 }
1003             }
1004         });
1005 
1006         StageLoader sl = new StageLoader(listView);
1007 
1008         Platform.runLater(() -&gt; {
1009             rt_35395_counter = 0;
1010             items.set(10, &quot;yellow&quot;);
1011             Platform.runLater(() -&gt; {
1012                 Toolkit.getToolkit().firePulse();
1013                 assertEquals(1, rt_35395_counter);
1014                 rt_35395_counter = 0;
1015                 items.set(30, &quot;yellow&quot;);
1016                 Platform.runLater(() -&gt; {
1017                     Toolkit.getToolkit().firePulse();
1018                     assertEquals(0, rt_35395_counter);
1019                     rt_35395_counter = 0;
1020                     items.remove(12);
1021                     Platform.runLater(() -&gt; {
1022                         Toolkit.getToolkit().firePulse();
1023                         assertEquals(useFixedCellSize ? 39 : 45, rt_35395_counter);
1024                         rt_35395_counter = 0;
1025                         items.add(12, &quot;yellow&quot;);
1026                         Platform.runLater(() -&gt; {
1027                             Toolkit.getToolkit().firePulse();
1028                             assertEquals(useFixedCellSize ? 39 : 45, rt_35395_counter);
1029                             rt_35395_counter = 0;
1030                             listView.scrollTo(5);
1031                             Platform.runLater(() -&gt; {
1032                                 Toolkit.getToolkit().firePulse();
1033                                 assertEquals(5, rt_35395_counter);
1034                                 rt_35395_counter = 0;
1035                                 listView.scrollTo(55);
1036                                 Platform.runLater(() -&gt; {
1037                                     Toolkit.getToolkit().firePulse();
1038                                     assertEquals(useFixedCellSize ? 17 : 53, rt_35395_counter);
1039                                     sl.dispose();
1040                                 });
1041                             });
1042                         });
1043                     });
1044                 });
1045             });
1046         });
1047     }
1048 
1049     @Test public void test_rt_37632() {
1050         final ObservableList&lt;String&gt; listOne = FXCollections.observableArrayList(&quot;A&quot;, &quot;B&quot;, &quot;C&quot;);
1051         final ObservableList&lt;String&gt; listTwo = FXCollections.observableArrayList(&quot;C&quot;);
1052 
1053         final ListView&lt;String&gt; listView = new ListView&lt;&gt;();
1054         MultipleSelectionModel&lt;String&gt; sm = listView.getSelectionModel();
1055         listView.setItems(listOne);
1056         listView.getSelectionModel().selectFirst();
1057 
1058         assertEquals(0, sm.getSelectedIndex());
1059         assertEquals(&quot;A&quot;, sm.getSelectedItem());
1060         assertEquals(1, sm.getSelectedIndices().size());
1061         assertEquals(0, (int) sm.getSelectedIndices().get(0));
1062         assertEquals(1, sm.getSelectedItems().size());
1063         assertEquals(&quot;A&quot;, sm.getSelectedItems().get(0));
1064 
1065         listView.setItems(listTwo);
1066 
1067         assertEquals(-1, sm.getSelectedIndex());
1068         assertNull(sm.getSelectedItem());
1069         assertEquals(0, sm.getSelectedIndices().size());
1070         assertEquals(0, sm.getSelectedItems().size());
1071     }
1072 
1073     private int rt_37853_cancelCount;
1074     private int rt_37853_commitCount;
1075     @Test public void test_rt_37853() {
1076         listView.setCellFactory(TextFieldListCell.forListView());
1077         listView.setEditable(true);
1078 
1079         for (int i = 0; i &lt; 10; i++) {
1080             listView.getItems().add(&quot;&quot; + i);
1081         }
1082 
1083         StageLoader sl = new StageLoader(listView);
1084 
1085         listView.setOnEditCancel(editEvent -&gt; rt_37853_cancelCount++);
1086         listView.setOnEditCommit(editEvent -&gt; rt_37853_commitCount++);
1087 
1088         assertEquals(0, rt_37853_cancelCount);
1089         assertEquals(0, rt_37853_commitCount);
1090 
1091         listView.edit(1);
1092         assertNotNull(listView.getEditingIndex());
1093 
1094         listView.getItems().clear();
1095         assertEquals(1, rt_37853_cancelCount);
1096         assertEquals(0, rt_37853_commitCount);
1097 
1098         sl.dispose();
1099     }
1100 
1101     @Test public void test_rt_38787_remove_b() {
1102         // selection moves to &quot;a&quot;
1103         test_rt_38787(&quot;a&quot;, 0, &quot;b&quot;);
1104     }
1105 
1106     @Test public void test_rt_38787_remove_b_c() {
1107         // selection moves to &quot;a&quot;
1108         test_rt_38787(&quot;a&quot;, 0, &quot;b&quot;, &quot;c&quot;);
1109     }
1110 
1111     @Test public void test_rt_38787_remove_c_d() {
1112         // selection moves to &quot;b&quot;
1113         test_rt_38787(&quot;b&quot;, 1, &quot;c&quot;, &quot;d&quot;);
1114     }
1115 
1116     @Test public void test_rt_38787_remove_a() {
1117         // selection moves to &quot;b&quot;, now in index 0
1118         test_rt_38787(&quot;b&quot;, 0, &quot;a&quot;);
1119     }
1120 
1121     @Test public void test_rt_38787_remove_z() {
1122         // selection shouldn&#39;t move as &#39;z&#39; doesn&#39;t exist
1123         test_rt_38787(&quot;b&quot;, 1, &quot;z&quot;);
1124     }
1125 
1126     private void test_rt_38787(String expectedItem, int expectedIndex, String... itemsToRemove) {
1127         ListView&lt;String&gt; stringListView = new ListView&lt;&gt;();
1128         stringListView.getItems().addAll(&quot;a&quot;,&quot;b&quot;,&quot;c&quot;,&quot;d&quot;);
1129 
1130         MultipleSelectionModel&lt;String&gt; sm = stringListView.getSelectionModel();
1131         sm.select(&quot;b&quot;);
1132 
1133         // test pre-conditions
1134         assertEquals(1, sm.getSelectedIndex());
1135         assertEquals(1, (int)sm.getSelectedIndices().get(0));
1136         assertEquals(&quot;b&quot;, sm.getSelectedItem());
1137         assertEquals(&quot;b&quot;, sm.getSelectedItems().get(0));
1138         assertFalse(sm.isSelected(0));
1139         assertTrue(sm.isSelected(1));
1140         assertFalse(sm.isSelected(2));
1141 
1142         // removing items
1143         stringListView.getItems().removeAll(itemsToRemove);
1144 
1145         // testing against expectations
1146         assertEquals(expectedIndex, sm.getSelectedIndex());
1147         assertEquals(expectedIndex, (int)sm.getSelectedIndices().get(0));
1148         assertEquals(expectedItem, sm.getSelectedItem());
1149         assertEquals(expectedItem, sm.getSelectedItems().get(0));
1150     }
1151 
1152     private int rt_38341_indices_count = 0;
1153     private int rt_38341_items_count = 0;
1154     @Test public void test_rt_38341() {
1155         ListView&lt;String&gt; stringListView = new ListView&lt;&gt;();
1156         stringListView.getItems().addAll(&quot;a&quot;,&quot;b&quot;,&quot;c&quot;,&quot;d&quot;);
1157 
1158         MultipleSelectionModel&lt;String&gt; sm = stringListView.getSelectionModel();
1159         sm.getSelectedIndices().addListener((ListChangeListener&lt;Integer&gt;) c -&gt; rt_38341_indices_count++);
1160         sm.getSelectedItems().addListener((ListChangeListener&lt;String&gt;) c -&gt; rt_38341_items_count++);
1161 
1162         assertEquals(0, rt_38341_indices_count);
1163         assertEquals(0, rt_38341_items_count);
1164 
1165         // expand the first child of root, and select it (note: root isn&#39;t visible)
1166         sm.select(1);
1167         assertEquals(1, sm.getSelectedIndex());
1168         assertEquals(1, sm.getSelectedIndices().size());
1169         assertEquals(1, (int)sm.getSelectedIndices().get(0));
1170         assertEquals(1, sm.getSelectedItems().size());
1171         assertEquals(&quot;b&quot;, sm.getSelectedItem());
1172         assertEquals(&quot;b&quot;, sm.getSelectedItems().get(0));
1173 
1174         assertEquals(1, rt_38341_indices_count);
1175         assertEquals(1, rt_38341_items_count);
1176 
1177         // now delete it
1178         stringListView.getItems().remove(1);
1179 
1180         // selection should move to the childs parent in index 0
1181         assertEquals(0, sm.getSelectedIndex());
1182         assertEquals(1, sm.getSelectedIndices().size());
1183         assertEquals(0, (int)sm.getSelectedIndices().get(0));
1184         assertEquals(1, sm.getSelectedItems().size());
1185         assertEquals(&quot;a&quot;, sm.getSelectedItem());
1186         assertEquals(&quot;a&quot;, sm.getSelectedItems().get(0));
1187 
1188         // we also expect there to be an event in the selection model for
1189         // selected indices and selected items
1190         assertEquals(sm.getSelectedIndices() +&quot;&quot;, 2, rt_38341_indices_count);
1191         assertEquals(2, rt_38341_items_count);
1192     }
1193 
1194     @Test public void test_rt_39132() {
1195         ObservableList items = FXCollections.observableArrayList(&quot;one&quot;, &quot;two&quot;, &quot;three&quot;);
1196         ListView listView = new ListView&lt;&gt;();
1197         listView.setItems(items);
1198 
1199         MultipleSelectionModel sm = listView.getSelectionModel();
1200         sm.select(0);
1201 
1202         assertEquals(0, sm.getSelectedIndex());
1203         assertEquals(&quot;one&quot;, sm.getSelectedItem());
1204 
1205         items.add(0, &quot;new item&quot;);
1206         assertEquals(1, sm.getSelectedIndex());
1207         assertEquals(&quot;one&quot;, sm.getSelectedItem());
1208     }
1209 
1210     private int rt_38943_index_count = 0;
1211     private int rt_38943_item_count = 0;
1212     @Test public void test_rt_38943() {
1213         ListView&lt;String&gt; listView = new ListView&lt;&gt;(FXCollections.observableArrayList(&quot;one&quot;, &quot;two&quot;, &quot;three&quot;));
1214 
1215         MultipleSelectionModel sm = listView.getSelectionModel();
1216 
1217         sm.selectedIndexProperty().addListener((observable, oldValue, newValue) -&gt; rt_38943_index_count++);
1218         sm.selectedItemProperty().addListener((observable, oldValue, newValue) -&gt; rt_38943_item_count++);
1219 
1220         assertEquals(-1, sm.getSelectedIndex());
1221         assertNull(sm.getSelectedItem());
1222         assertEquals(0, rt_38943_index_count);
1223         assertEquals(0, rt_38943_item_count);
1224 
1225         sm.select(0);
1226         assertEquals(0, sm.getSelectedIndex());
1227         assertEquals(&quot;one&quot;, sm.getSelectedItem());
1228         assertEquals(1, rt_38943_index_count);
1229         assertEquals(1, rt_38943_item_count);
1230 
1231         sm.clearSelection(0);
1232         assertEquals(-1, sm.getSelectedIndex());
1233         assertNull(sm.getSelectedItem());
1234         assertEquals(2, rt_38943_index_count);
1235         assertEquals(2, rt_38943_item_count);
1236     }
1237 
1238     @Test public void test_rt_38884() {
1239         ListView&lt;String&gt; listView = new ListView&lt;&gt;();
1240         ObservableList&lt;String&gt; items = listView.getItems();
1241 
1242         listView.getSelectionModel().getSelectedItems().addListener((ListChangeListener.Change&lt;? extends String&gt; c) -&gt; {
1243             while (c.next()) {
1244                 if (c.wasRemoved()) {
1245                     assertTrue(c.getRemovedSize() &gt; 0);
1246 
1247                     List&lt;? extends String&gt; removed = c.getRemoved();
1248                     String removedItem = null;
1249                     try {
1250                         removedItem = removed.get(0);
1251                     } catch (Exception e) {
1252                         fail();
1253                     }
1254 
1255                     assertEquals(&quot;foo&quot;, removedItem);
1256                 }
1257             }
1258         });
1259 
1260         items.add(&quot;foo&quot;);
1261         listView.getSelectionModel().select(0);
1262         items.clear();
1263     }
1264 
1265     private int rt_37360_add_count = 0;
1266     private int rt_37360_remove_count = 0;
1267     @Test public void test_rt_37360() {
1268         ListView&lt;String&gt; stringListView = new ListView&lt;&gt;();
1269         stringListView.getItems().addAll(&quot;a&quot;, &quot;b&quot;);
1270 
1271         MultipleSelectionModel&lt;String&gt; sm = stringListView.getSelectionModel();
1272         sm.setSelectionMode(SelectionMode.MULTIPLE);
1273         sm.getSelectedItems().addListener((ListChangeListener&lt;String&gt;) c -&gt; {
1274             while (c.next()) {
1275                 if (c.wasAdded()) {
1276                     rt_37360_add_count += c.getAddedSize();
1277                 }
1278                 if (c.wasRemoved()) {
1279                     rt_37360_remove_count += c.getRemovedSize();
1280                 }
1281             }
1282         });
1283 
1284         assertEquals(0, sm.getSelectedItems().size());
1285         assertEquals(0, rt_37360_add_count);
1286         assertEquals(0, rt_37360_remove_count);
1287 
1288         sm.select(0);
1289         assertEquals(1, sm.getSelectedItems().size());
1290         assertEquals(1, rt_37360_add_count);
1291         assertEquals(0, rt_37360_remove_count);
1292 
1293         sm.select(1);
1294         assertEquals(2, sm.getSelectedItems().size());
1295         assertEquals(2, rt_37360_add_count);
1296         assertEquals(0, rt_37360_remove_count);
1297 
1298         sm.clearAndSelect(1);
1299         assertEquals(1, sm.getSelectedItems().size());
1300         assertEquals(2, rt_37360_add_count);
1301         assertEquals(1, rt_37360_remove_count);
1302     }
1303 
1304     @Test public void test_rt_38491() {
1305         ListView&lt;String&gt; stringListView = new ListView&lt;&gt;();
1306         stringListView.getItems().addAll(&quot;a&quot;, &quot;b&quot;);
1307 
1308         MultipleSelectionModel&lt;String&gt; sm = stringListView.getSelectionModel();
1309         sm.setSelectionMode(SelectionMode.MULTIPLE);
1310 
1311         FocusModel&lt;String&gt; fm = stringListView.getFocusModel();
1312 
1313         // click on row 0
1314         VirtualFlowTestUtils.clickOnRow(stringListView, 0);
1315         assertTrue(sm.isSelected(0));
1316         assertEquals(&quot;a&quot;, sm.getSelectedItem());
1317         assertTrue(fm.isFocused(0));
1318         assertEquals(&quot;a&quot;, fm.getFocusedItem());
1319         assertEquals(0, fm.getFocusedIndex());
1320 
1321         int anchor = ListCellBehavior.getAnchor(stringListView, -1);
1322         assertTrue(ListCellBehavior.hasNonDefaultAnchor(stringListView));
1323         assertEquals(0, anchor);
1324 
1325         // now add a new item at row 0. This has the effect of pushing down
1326         // the selected item into row 1.
1327         stringListView.getItems().add(0, &quot;z&quot;);
1328 
1329         // The first bug was that selection and focus were not moving down to
1330         // be on row 1, so we test that now
1331         assertFalse(sm.isSelected(0));
1332         assertFalse(fm.isFocused(0));
1333         assertTrue(sm.isSelected(1));
1334         assertEquals(&quot;a&quot;, sm.getSelectedItem());
1335         assertTrue(fm.isFocused(1));
1336         assertEquals(&quot;a&quot;, fm.getFocusedItem());
1337         assertEquals(1, fm.getFocusedIndex());
1338 
1339         // The second bug was that the anchor was not being pushed down as well
1340         // (when it should).
1341         anchor = ListCellBehavior.getAnchor(stringListView, -1);
1342         assertTrue(ListCellBehavior.hasNonDefaultAnchor(stringListView));
1343         assertEquals(1, anchor);
1344     }
1345 
1346     private final ObservableList&lt;String&gt; rt_39256_list = FXCollections.observableArrayList();
1347     @Test public void test_rt_39256() {
1348         ListView&lt;String&gt; stringListView = new ListView&lt;&gt;();
1349         stringListView.getItems().addAll(&quot;a&quot;,&quot;b&quot;, &quot;c&quot;, &quot;d&quot;);
1350 
1351         MultipleSelectionModel&lt;String&gt; sm = stringListView.getSelectionModel();
1352         sm.setSelectionMode(SelectionMode.MULTIPLE);
1353 
1354 //        rt_39256_list.addListener((ListChangeListener&lt;String&gt;) change -&gt; {
1355 //            while (change.next()) {
1356 //                System.err.println(&quot;number of selected persons (in bound list): &quot; + change.getList().size());
1357 //            }
1358 //        });
1359 
1360         Bindings.bindContent(rt_39256_list, sm.getSelectedItems());
1361 
1362         assertEquals(0, sm.getSelectedItems().size());
1363         assertEquals(0, rt_39256_list.size());
1364 
1365         sm.selectAll();
1366         assertEquals(4, sm.getSelectedItems().size());
1367         assertEquals(4, rt_39256_list.size());
1368 
1369         sm.selectAll();
1370         assertEquals(4, sm.getSelectedItems().size());
1371         assertEquals(4, rt_39256_list.size());
1372 
1373         sm.selectAll();
1374         assertEquals(4, sm.getSelectedItems().size());
1375         assertEquals(4, rt_39256_list.size());
1376     }
1377 
1378     private final ObservableList&lt;String&gt; rt_39482_list = FXCollections.observableArrayList();
1379     @Test public void test_rt_39482() {
1380         ListView&lt;String&gt; stringListView = new ListView&lt;&gt;();
1381         stringListView.getItems().addAll(&quot;a&quot;, &quot;b&quot;, &quot;c&quot;, &quot;d&quot;);
1382 
1383         MultipleSelectionModel&lt;String&gt; sm = stringListView.getSelectionModel();
1384         sm.setSelectionMode(SelectionMode.MULTIPLE);
1385 
1386         sm.getSelectedItems().addListener((ListChangeListener&lt;String&gt;) change -&gt; {
1387             while (change.next()) {
1388                 System.out.println(&quot;sm.getSelectedItems(): &quot; + change.getList());
1389             }
1390         });
1391 
1392         rt_39482_list.addListener((ListChangeListener&lt;String&gt;) change -&gt; {
1393             while (change.next()) {
1394                 System.out.println(&quot;rt_39482_list: &quot; + change.getList());
1395             }
1396         });
1397 
1398         Bindings.bindContent(rt_39482_list, sm.getSelectedItems());
1399 
1400         assertEquals(0, sm.getSelectedItems().size());
1401         assertEquals(0, rt_39482_list.size());
1402 
1403         test_rt_39482_selectRow(&quot;a&quot;, sm, 0);
1404         test_rt_39482_selectRow(&quot;b&quot;, sm, 1);
1405         test_rt_39482_selectRow(&quot;c&quot;, sm, 2);
1406         test_rt_39482_selectRow(&quot;d&quot;, sm, 3);
1407     }
1408 
1409     private void test_rt_39482_selectRow(String expectedString,
1410                                          MultipleSelectionModel&lt;String&gt; sm,
1411                                          int rowToSelect) {
1412         System.out.println(&quot;\nSelect row &quot; + rowToSelect);
1413         sm.selectAll();
1414         assertEquals(4, sm.getSelectedIndices().size());
1415         assertEquals(4, sm.getSelectedItems().size());
1416         assertEquals(4, rt_39482_list.size());
1417 
1418         sm.clearAndSelect(rowToSelect);
1419         assertEquals(1, sm.getSelectedIndices().size());
1420         assertEquals(1, sm.getSelectedItems().size());
1421         assertEquals(expectedString, sm.getSelectedItem());
1422         assertEquals(expectedString, rt_39482_list.get(0));
1423         assertEquals(1, rt_39482_list.size());
1424     }
1425 
1426     @Test public void test_rt_39559_useSM_selectAll() {
1427         test_rt_39559(true);
1428     }
1429 
1430     @Test public void test_rt_39559_useKeyboard_selectAll() {
1431         test_rt_39559(false);
1432     }
1433 
1434     private void test_rt_39559(boolean useSMSelectAll) {
1435         ListView&lt;String&gt; stringListView = new ListView&lt;&gt;();
1436         stringListView.getItems().addAll(&quot;a&quot;, &quot;b&quot;, &quot;c&quot;, &quot;d&quot;);
1437 
1438         MultipleSelectionModel&lt;String&gt; sm = stringListView.getSelectionModel();
1439         sm.setSelectionMode(SelectionMode.MULTIPLE);
1440 
1441         StageLoader sl = new StageLoader(stringListView);
1442         KeyEventFirer keyboard = new KeyEventFirer(stringListView);
1443 
1444         assertEquals(0, sm.getSelectedItems().size());
1445 
1446         sm.clearAndSelect(0);
1447 
1448         if (useSMSelectAll) {
1449             sm.selectAll();
1450         } else {
1451             keyboard.doKeyPress(KeyCode.A, KeyModifier.getShortcutKey());
1452         }
1453 
1454         assertEquals(4, sm.getSelectedItems().size());
1455         assertEquals(0, (int) ListCellBehavior.getAnchor(stringListView, -1));
1456 
1457         keyboard.doKeyPress(KeyCode.DOWN, KeyModifier.SHIFT);
1458 
1459         assertEquals(0, (int) ListCellBehavior.getAnchor(stringListView, -1));
1460         assertEquals(2, sm.getSelectedItems().size());
1461         assertEquals(&quot;a&quot;, sm.getSelectedItems().get(0));
1462         assertEquals(&quot;b&quot;, sm.getSelectedItems().get(1));
1463 
1464         sl.dispose();
1465     }
1466 
1467     @Test public void test_rt_16068_firstElement_selectAndRemoveSameRow() {
1468         // select and then remove the &#39;a&#39; item, selection and focus should both
1469         // stay at the first row, now &#39;b&#39;
1470         test_rt_16068(0, 0, 0);
1471     }
1472 
1473     @Test public void test_rt_16068_firstElement_selectRowAndRemoveLaterSibling() {
1474         // select row &#39;a&#39;, and remove row &#39;c&#39;, selection and focus should not change
1475         test_rt_16068(0, 2, 0);
1476     }
1477 
1478     @Test public void test_rt_16068_middleElement_selectAndRemoveSameRow() {
1479         // select and then remove the &#39;b&#39; item, selection and focus should both
1480         // move up one row to the &#39;a&#39; item
1481         test_rt_16068(1, 1, 0);
1482     }
1483 
1484     @Test public void test_rt_16068_middleElement_selectRowAndRemoveLaterSibling() {
1485         // select row &#39;b&#39;, and remove row &#39;c&#39;, selection and focus should not change
1486         test_rt_16068(1, 2, 1);
1487     }
1488 
1489     @Test public void test_rt_16068_middleElement_selectRowAndRemoveEarlierSibling() {
1490         // select row &#39;b&#39;, and remove row &#39;a&#39;, selection and focus should move up
1491         // one row, remaining on &#39;b&#39;
1492         test_rt_16068(1, 0, 0);
1493     }
1494 
1495     @Test public void test_rt_16068_lastElement_selectAndRemoveSameRow() {
1496         // select and then remove the &#39;d&#39; item, selection and focus should both
1497         // move up one row to the &#39;c&#39; item
1498         test_rt_16068(3, 3, 2);
1499     }
1500 
1501     @Test public void test_rt_16068_lastElement_selectRowAndRemoveEarlierSibling() {
1502         // select row &#39;d&#39;, and remove row &#39;a&#39;, selection and focus should move up
1503         // one row, remaining on &#39;d&#39;
1504         test_rt_16068(3, 0, 2);
1505     }
1506 
1507     private void test_rt_16068(int indexToSelect, int indexToRemove, int expectedIndex) {
1508         ListView&lt;String&gt; stringListView = new ListView&lt;&gt;();
1509         stringListView.getItems().addAll(&quot;a&quot;, &quot;b&quot;, &quot;c&quot;, &quot;d&quot;);
1510 
1511         MultipleSelectionModel&lt;?&gt; sm = stringListView.getSelectionModel();
1512         FocusModel&lt;?&gt; fm = stringListView.getFocusModel();
1513 
1514         sm.select(indexToSelect);
1515         assertEquals(indexToSelect, sm.getSelectedIndex());
1516         assertEquals(stringListView.getItems().get(indexToSelect), sm.getSelectedItem());
1517         assertEquals(indexToSelect, fm.getFocusedIndex());
1518         assertEquals(stringListView.getItems().get(indexToSelect), fm.getFocusedItem());
1519 
1520         stringListView.getItems().remove(indexToRemove);
1521         assertEquals(expectedIndex, sm.getSelectedIndex());
1522         assertEquals(stringListView.getItems().get(expectedIndex), sm.getSelectedItem());
1523         assertEquals(expectedIndex, fm.getFocusedIndex());
1524         assertEquals(stringListView.getItems().get(expectedIndex), fm.getFocusedItem());
1525     }
1526 
1527     @Test public void test_rt_22599() {
1528         ObservableList&lt;RT22599_DataType&gt; initialData = FXCollections.observableArrayList(
1529                 new RT22599_DataType(1, &quot;row1&quot;),
1530                 new RT22599_DataType(2, &quot;row2&quot;),
1531                 new RT22599_DataType(3, &quot;row3&quot;)
1532         );
1533 
1534         ListView&lt;RT22599_DataType&gt; listView = new ListView&lt;&gt;();
1535         listView.setItems(initialData);
1536 
1537         StageLoader sl = new StageLoader(listView);
1538 
1539         // testing initial state
1540         assertNotNull(listView.getSkin());
1541         assertEquals(&quot;row1&quot;, VirtualFlowTestUtils.getCell(listView, 0).getText());
1542         assertEquals(&quot;row2&quot;, VirtualFlowTestUtils.getCell(listView, 1).getText());
1543         assertEquals(&quot;row3&quot;, VirtualFlowTestUtils.getCell(listView, 2).getText());
1544 
1545         // change row 0 (where &quot;row1&quot; currently resides), keeping same id.
1546         // Because &#39;set&#39; is called, the control should update to the new content
1547         // without any user interaction
1548         RT22599_DataType data;
1549         initialData.set(0, data = new RT22599_DataType(0, &quot;row1a&quot;));
1550         Toolkit.getToolkit().firePulse();
1551         assertEquals(&quot;row1a&quot;, VirtualFlowTestUtils.getCell(listView, 0).getText());
1552 
1553         // change the row 0 (where we currently have &quot;row1a&quot;) value directly.
1554         // Because there is no associated property, this won&#39;t be observed, so
1555         // the control should still show &quot;row1a&quot; rather than &quot;row1b&quot;
1556         data.text = &quot;row1b&quot;;
1557         Toolkit.getToolkit().firePulse();
1558         assertEquals(&quot;row1a&quot;, VirtualFlowTestUtils.getCell(listView, 0).getText());
1559 
1560         // call refresh() to force a refresh of all visible cells
1561         listView.refresh();
1562         Toolkit.getToolkit().firePulse();
1563         assertEquals(&quot;row1b&quot;, VirtualFlowTestUtils.getCell(listView, 0).getText());
1564 
1565         sl.dispose();
1566     }
1567 
1568     private static class RT22599_DataType {
1569         public int id = 0;
1570         public String text = &quot;&quot;;
1571 
1572         public RT22599_DataType(int id, String text) {
1573             this.id = id;
1574             this.text = text;
1575         }
1576 
1577         @Override public String toString() {
1578             return text;
1579         }
1580 
1581         @Override public boolean equals(Object obj) {
1582             if (obj == null) return false;
1583             return id == ((RT22599_DataType)obj).id;
1584         }
1585     }
1586 
1587     private int rt_39966_count = 0;
1588     @Test public void test_rt_39966() {
1589         ObservableList&lt;String&gt; list = FXCollections.observableArrayList(&quot;Hello World&quot;);
1590         ListView&lt;String&gt; listView = new ListView&lt;&gt;(list);
1591 
1592         StageLoader sl = new StageLoader(listView);
1593 
1594         // initially there is no selection
1595         assertTrue(listView.getSelectionModel().isEmpty());
1596 
1597         listView.getSelectionModel().selectedItemProperty().addListener((value, s1, s2) -&gt; {
1598             if (rt_39966_count == 0) {
1599                 rt_39966_count++;
1600                 assertFalse(listView.getSelectionModel().isEmpty());
1601             } else {
1602                 assertTrue(listView.getSelectionModel().isEmpty());
1603             }
1604         });
1605 
1606         // our assertion two lines down always succeeds. What fails is our
1607         // assertion above within the listener.
1608         listView.getSelectionModel().select(0);
1609         assertFalse(listView.getSelectionModel().isEmpty());
1610 
1611         list.remove(0);
1612         assertTrue(listView.getSelectionModel().isEmpty());
1613 
1614         sl.dispose();
1615     }
1616 
1617     /**
1618      * Bullet 1: selected index must be updated
1619      * Corner case: last selected. Fails for core
1620      */
1621     @Test public void test_rt_40012_selectedAtLastOnDisjointRemoveItemsAbove() {
1622         ObservableList&lt;String&gt; items = FXCollections.observableArrayList(&quot;0&quot;, &quot;1&quot;, &quot;2&quot;, &quot;3&quot;, &quot;4&quot;, &quot;5&quot;);
1623         ListView&lt;String&gt; listView = new ListView&lt;&gt;(items);
1624         SelectionModel sm = listView.getSelectionModel();
1625 
1626         int last = items.size() - 1;
1627 
1628         // selecting item &quot;5&quot;
1629         sm.select(last);
1630 
1631         // disjoint remove of 2 elements above the last selected
1632         // Removing &quot;1&quot; and &quot;3&quot;
1633         items.removeAll(items.get(1), items.get(3));
1634 
1635         // selection should move up two places such that it remains on item &quot;5&quot;,
1636         // but in index (last - 2).
1637         int expected = last - 2;
1638         assertEquals(&quot;5&quot;, sm.getSelectedItem());
1639         assertEquals(&quot;selected index after disjoint removes above&quot;, expected, sm.getSelectedIndex());
1640     }
1641 
1642     /**
1643      * Variant of 1: if selectedIndex is not updated,
1644      * the old index is no longer valid
1645      * for accessing the items.
1646      */
1647     @Test public void test_rt_40012_accessSelectedAtLastOnDisjointRemoveItemsAbove() {
1648         ObservableList&lt;String&gt; items = FXCollections.observableArrayList(&quot;0&quot;, &quot;1&quot;, &quot;2&quot;, &quot;3&quot;, &quot;4&quot;, &quot;5&quot;);
1649         ListView&lt;String&gt; listView = new ListView&lt;&gt;(items);
1650         SelectionModel sm = listView.getSelectionModel();
1651 
1652         int last = items.size() - 1;
1653 
1654         // selecting item &quot;5&quot;
1655         sm.select(last);
1656 
1657         // disjoint remove of 2 elements above the last selected
1658         items.removeAll(items.get(1), items.get(3));
1659         int selected = sm.getSelectedIndex();
1660         if (selected &gt; -1) {
1661             items.get(selected);
1662         }
1663     }
1664 
1665     /**
1666      * Bullet 2: selectedIndex notification count
1667      *
1668      * Note that we don&#39;t use the corner case of having the last index selected
1669      * (which fails already on updating the index)
1670      */
1671     private int rt_40012_count = 0;
1672     @Test public void test_rt_40012_selectedIndexNotificationOnDisjointRemovesAbove() {
1673         ObservableList&lt;String&gt; items = FXCollections.observableArrayList(&quot;0&quot;, &quot;1&quot;, &quot;2&quot;, &quot;3&quot;, &quot;4&quot;, &quot;5&quot;);
1674         ListView&lt;String&gt; listView = new ListView&lt;&gt;(items);
1675         SelectionModel sm = listView.getSelectionModel();
1676 
1677         int last = items.size() - 2;
1678         sm.select(last);
1679         assertEquals(last, sm.getSelectedIndex());
1680 
1681         rt_40012_count = 0;
1682         sm.selectedIndexProperty().addListener(o -&gt; rt_40012_count++);
1683 
1684         // disjoint remove of 2 elements above the last selected
1685         items.removeAll(items.get(1), items.get(3));
1686         assertEquals(&quot;sanity: selectedIndex must be shifted by -2&quot;, last - 2, sm.getSelectedIndex());
1687         assertEquals(&quot;must fire single event on removes above&quot;, 1, rt_40012_count);
1688     }
1689 
1690     /**
1691      * Bullet 3: unchanged selectedItem must not fire change
1692      */
1693     @Test
1694     public void test_rt_40012_selectedItemNotificationOnDisjointRemovesAbove() {
1695         ObservableList&lt;String&gt; items = FXCollections.observableArrayList(&quot;0&quot;, &quot;1&quot;, &quot;2&quot;, &quot;3&quot;, &quot;4&quot;, &quot;5&quot;);
1696         ListView&lt;String&gt; listView = new ListView&lt;&gt;(items);
1697         SelectionModel sm = listView.getSelectionModel();
1698 
1699         int last = items.size() - 2;
1700         Object lastItem = items.get(last);
1701         sm.select(last);
1702         assertEquals(lastItem, sm.getSelectedItem());
1703 
1704         rt_40012_count = 0;
1705         sm.selectedItemProperty().addListener(o -&gt; rt_40012_count++);
1706 
1707         // disjoint remove of 2 elements above the last selected
1708         items.removeAll(items.get(1), items.get(3));
1709         assertEquals(&quot;sanity: selectedItem unchanged&quot;, lastItem, sm.getSelectedItem());
1710         assertEquals(&quot;must not fire on unchanged selected item&quot;, 0, rt_40012_count);
1711     }
1712 
1713     @Test public void test_rt_40185() {
1714         final ListView&lt;String&gt; lv = new ListView&lt;&gt;();
1715         final ArrayList&lt;Integer&gt; expected = new ArrayList&lt;&gt;();
1716         Collections.addAll(expected, 1, 2);
1717 
1718         lv.getSelectionModel().setSelectionMode(SelectionMode.MULTIPLE);
1719         lv.getSelectionModel().getSelectedIndices().addListener((ListChangeListener&lt;Integer&gt;) change -&gt; {
1720             while (change.next()) {
1721                 if (change.wasRemoved()) {
1722                     assertEquals(expected, change.getRemoved());
1723                 }
1724             }
1725         });
1726 
1727         lv.getItems().addAll(&quot;-0-&quot;,&quot;-1-&quot;,&quot;-2-&quot;);
1728         lv.getSelectionModel().selectIndices(1, 2);
1729         lv.getSelectionModel().clearSelection();
1730     }
1731 
1732     /**
1733      * ClearAndSelect fires invalid change event if selectedIndex is unchanged.
1734      */
1735     private int rt_40212_count = 0;
1736     @Test public void test_rt_40212() {
1737         final ListView&lt;Integer&gt; lv = new ListView&lt;&gt;();
1738         for (int i = 0; i &lt; 10; i++) {
1739             lv.getItems().add(i);
1740         }
1741 
1742         MultipleSelectionModel&lt;Integer&gt; sm = lv.getSelectionModel();
1743         sm.setSelectionMode(SelectionMode.MULTIPLE);
1744 
1745         sm.selectRange(3, 5);
1746         int selected = sm.getSelectedIndex();
1747 
1748         sm.getSelectedIndices().addListener((ListChangeListener&lt;Integer&gt;) change -&gt; {
1749             assertEquals(&quot;sanity: selectedIndex unchanged&quot;, selected, sm.getSelectedIndex());
1750             while(change.next()) {
1751                 assertEquals(&quot;single event on clearAndSelect already selected&quot;, 1, ++rt_40212_count);
1752 
1753                 boolean type = change.wasAdded() || change.wasRemoved() || change.wasPermutated() || change.wasUpdated();
1754                 assertTrue(&quot;at least one of the change types must be true&quot;, type);
1755             }
1756         });
1757 
1758         sm.clearAndSelect(selected);
1759     }
1760 
1761     @Test public void test_rt_40280() {
1762         final ListView&lt;String&gt; view = new ListView&lt;&gt;();
1763         StageLoader sl = new StageLoader(view);
1764         view.getFocusModel().getFocusedIndex();
1765         sl.dispose();
1766     }
1767 
1768     /**
1769      * Test list change of selectedIndices on setIndices. Fails for core ..
1770      */
1771     @Test public void test_rt_40263() {
1772         final ListView&lt;Integer&gt; lv = new ListView&lt;&gt;();
1773         for (int i = 0; i &lt; 10; i++) {
1774             lv.getItems().add(i);
1775         }
1776 
1777         MultipleSelectionModel&lt;Integer&gt; sm = lv.getSelectionModel();
1778         sm.setSelectionMode(SelectionMode.MULTIPLE);
1779 
1780         int[] indices = new int[]{2, 5, 7};
1781         ListChangeListener&lt;Integer&gt; l = c -&gt; {
1782             // firstly, we expect only one change
1783             int subChanges = 0;
1784             while(c.next()) {
1785                 subChanges++;
1786             }
1787             assertEquals(1, subChanges);
1788 
1789             // secondly, we expect the added size to be three, as that is the
1790             // number of items selected
1791             c.reset();
1792             c.next();
1793             System.out.println(&quot;Added items: &quot; + c.getAddedSubList());
1794             assertEquals(indices.length, c.getAddedSize());
1795             assertArrayEquals(indices, c.getAddedSubList().stream().mapToInt(i -&gt; i).toArray());
1796         };
1797         sm.getSelectedIndices().addListener(l);
1798         sm.selectIndices(indices[0], indices);
1799     }
1800 
1801     @Test public void test_jdk8141124() {
1802         ListView&lt;String&gt; listView = new ListView&lt;&gt;();
1803         ObservableList&lt;String&gt; items = FXCollections.observableArrayList();
1804         SortedList&lt;String&gt; sortedItems = new SortedList&lt;&gt;(items);
1805         sortedItems.setComparator(String::compareTo);
1806         listView.setItems(sortedItems);
1807 
1808         MultipleSelectionModel&lt;String&gt; sm = listView.getSelectionModel();
1809 
1810         items.add(&quot;2&quot;);
1811         listView.getSelectionModel().selectFirst();
1812         assertEquals(&quot;2&quot;, sm.getSelectedItem());
1813         assertEquals(0, sm.getSelectedIndex());
1814         assertEquals(0, (int) sm.getSelectedIndices().get(0));
1815         assertEquals(&quot;2&quot;, sm.getSelectedItems().get(0));
1816 
1817         items.addAll(&quot;1&quot;, &quot;3&quot;);
1818         assertEquals(&quot;2&quot;, sm.getSelectedItem());
1819         assertEquals(1, sm.getSelectedIndex());
1820         assertEquals(1, (int) sm.getSelectedIndices().get(0));
1821         assertEquals(&quot;2&quot;, sm.getSelectedItems().get(0));
1822     }
1823 
1824     @Test public void test_jdk_8143594() {
1825         MultipleSelectionModel model = listView.getSelectionModel();
1826         model.setSelectionMode(SelectionMode.MULTIPLE);
1827 
1828         listView.getItems().addAll(&quot;Apple&quot;, &quot;Orange&quot;, null);
1829 
1830         model.select(0);
1831         model.clearAndSelect(2);
1832         model.clearAndSelect(0);
1833         model.clearAndSelect(2);
1834     }
1835 
1836     @Test public void test_jdk_8145887_selectedIndices_ListIterator() {
1837         int selectIndices[] = { 4, 7, 9 };
1838         ListView&lt;Integer&gt; lv = new ListView&lt;&gt;();
1839         for (int i = 0; i &lt; 10; ++i) {
1840             lv.getItems().add(i);
1841         }
1842 
1843         MultipleSelectionModel msm = lv.getSelectionModel();
1844         msm.setSelectionMode(SelectionMode.MULTIPLE);
1845         for (int i = 0 ; i &lt; selectIndices.length; ++i) {
1846             msm.select(selectIndices[i]);
1847         }
1848 
1849         ListIterator iter = lv.getSelectionModel().getSelectedIndices().listIterator();
1850 
1851         // Step 1. Initial values
1852         assertEquals(0, iter.nextIndex());
1853         assertEquals(-1, iter.previousIndex());
1854         assertEquals(true, iter.hasNext());
1855         assertEquals(false, iter.hasPrevious());
1856 
1857         // Step 2. Iterate forward.
1858         assertEquals(4, iter.next());
1859         assertEquals(1, iter.nextIndex());
1860         assertEquals(0, iter.previousIndex());
1861         assertEquals(true, iter.hasNext());
1862         assertEquals(true, iter.hasPrevious());
1863 
1864         // Step 3. Iterate forward.
1865         // Values would be at similar state of Step 2.
1866         assertEquals(7, iter.next());
1867 
1868         // Step 4. Iterate forward to Last element.
1869         assertEquals(9, iter.next());
1870         assertEquals(3, iter.nextIndex());
1871         assertEquals(2, iter.previousIndex());
1872         assertEquals(false, iter.hasNext());
1873         assertEquals(true, iter.hasPrevious());
1874 
1875         // Step 5. Verify NoSuchElementException by next()
1876         try {
1877             iter.next();
1878         } catch (Exception e) {
1879             assert(e instanceof NoSuchElementException);
1880         }
1881 
1882         // Step 6. Iterate backward to Last element.
1883         assertEquals(9, iter.previous());
1884         assertEquals(2, iter.nextIndex());
1885         assertEquals(1, iter.previousIndex());
1886         assertEquals(true, iter.hasNext());
1887         assertEquals(true, iter.hasPrevious());
1888 
1889         // Step 7. Iterate forward to Last element.
1890         assertEquals(9, iter.next());
1891         assertEquals(3, iter.nextIndex());
1892         assertEquals(2, iter.previousIndex());
1893         assertEquals(false, iter.hasNext());
1894         assertEquals(true, iter.hasPrevious());
1895 
1896         // Step 8. Iterate forward to last element.
1897         // Values would be at Same state of Step 2.
1898         assertEquals(9, iter.previous());
1899 
1900         // Step 9. Iterate backward.
1901         assertEquals(7, iter.previous());
1902         assertEquals(1, iter.nextIndex());
1903         assertEquals(0, iter.previousIndex());
1904         assertEquals(true, iter.hasNext());
1905         assertEquals(true, iter.hasPrevious());
1906 
1907         // Step 10. Iterate back to first element.
1908         assertEquals(4, iter.previous());
1909         assertEquals(0, iter.nextIndex());
1910         assertEquals(-1, iter.previousIndex());
1911         assertEquals(true, iter.hasNext());
1912         assertEquals(false, iter.hasPrevious());
1913 
1914         // Step 11. Verify NoSuchElementException by previous()
1915         try {
1916             iter.previous();
1917         } catch (Exception e) {
1918             assert(e instanceof NoSuchElementException);
1919         }
1920     }
1921 
1922     @Test public void testListEditStartOnCellStandalone_JDK8187432() {
1923         ListView&lt;String&gt; control = new ListView&lt;&gt;(FXCollections
1924                 .observableArrayList(&quot;Item1&quot;, &quot;Item2&quot;, &quot;Item3&quot;, &quot;Item4&quot;));
1925         control.setEditable(true);
1926         control.setCellFactory(TextFieldListCell.forListView());
1927         StageLoader sl = new StageLoader(control);
1928         int editIndex = 2;
1929 
1930         IndexedCell cell = VirtualFlowTestUtils.getCell(control, editIndex);
1931         ObjectProperty&lt;ListView.EditEvent&gt; editEvent = new SimpleObjectProperty&lt;&gt;();
1932         control.addEventHandler(ListView.editStartEvent(), e -&gt; editEvent.set(e));
1933 
1934         // start edit on cell
1935         cell.startEdit();
1936 
1937         // test cell state
1938         assertTrue(cell.isEditing());
1939         assertEquals(editIndex, cell.getIndex());
1940 
1941         // test editEvent
1942         assertNotNull(editEvent.get());
1943         assertEquals(&quot;type is startEdit&quot;,
1944                      ListView.editStartEvent(), editEvent.get().getEventType());
1945         assertEquals(&quot;index on start event&quot;,
1946                      editIndex, editEvent.get().getIndex());
1947 
1948         sl.dispose();
1949     }
1950 
1951     @Test
1952     public void testEventIndicesOnSelectRange() {
1953         ObservableList&lt;String&gt; listItems = FXCollections.observableArrayList(&quot;zero&quot;, &quot;one&quot;, &quot;two&quot;, &quot;three&quot;);
1954         final ListView&lt;String&gt; lv = new ListView&lt;&gt;();
1955         lv.setItems(listItems);
1956         MultipleSelectionModel&lt;String&gt; sm = lv.getSelectionModel();
1957 
1958         int selected = 1;
1959         sm.setSelectionMode(SelectionMode.MULTIPLE);
1960         sm.select(selected);
1961         sm.getSelectedIndices().addListener((ListChangeListener&lt;Integer&gt;) ch -&gt; {
1962             if (ch.next()) {
1963                 assertEquals(&quot;Two items should be selected.&quot;, 2, ch.getList().size());
1964                 assertEquals(&quot;Selection range should be from index 1 &quot;, 1, ch.getFrom());
1965                 assertEquals(&quot;Selection range should be till index 2 &quot;, 2, ch.getTo());
1966             } else {
1967                 fail(&quot;Change event is expected when selection is changed.&quot;);
1968             }
1969         });
1970         int focus = lv.getFocusModel().getFocusedIndex();
1971         assertEquals(&quot;Selected item should be focused.&quot;, selected, focus);
1972         // Select the next element
1973         sm.selectRange(selected, focus + 2);
1974         assertEquals(&quot;Two items should be selected.&quot;, 2, sm.getSelectedIndices().size());
1975         assertEquals(&quot;List item at index 1 should be selected&quot;, 1, (int) sm.getSelectedIndices().get(0));
1976         assertEquals(&quot;List item at index 2 should be selected&quot;, 2, (int) sm.getSelectedIndices().get(1));
1977     }
1978 }
    </pre>
  </body>
</html>