<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Old modules/javafx.media/src/main/native/jfxmedia/platform/osx/CoreAudioUtilityClasses/CoreAudio/AudioUnits/AUPublic/AUBase/AUBase.h</title>
    <link rel="stylesheet" href="../../../../../../../../../../../../../style.css" />
  </head>
  <body>
    <pre>
   1 /*
   2 Copyright (C) 2016 Apple Inc. All Rights Reserved.
   3 See LICENSE.txt for this sampleâ€™s licensing information
   4 
   5 Abstract:
   6 Part of Core Audio AUBase Classes
   7 */
   8 
   9 #ifndef __AUBase_h__
  10 #define __AUBase_h__
  11 
  12 #include &lt;TargetConditionals.h&gt;
  13 
  14 #if TARGET_OS_MAC
  15     #include &lt;pthread.h&gt;
  16 #elif TARGET_OS_WIN32
  17     #include &lt;windows.h&gt;
  18 #else
  19     #error Unsupported Operating System
  20 #endif
  21 
  22 #include &lt;vector&gt;
  23 
  24 #include &quot;AUScopeElement.h&quot;
  25 #include &quot;AUInputElement.h&quot;
  26 #include &quot;AUOutputElement.h&quot;
  27 #include &quot;AUBuffer.h&quot;
  28 #include &quot;CAMath.h&quot;
  29 #include &quot;CAThreadSafeList.h&quot;
  30 #include &quot;CAVectorUnit.h&quot;
  31 #include &quot;CAMutex.h&quot;
  32 #if !defined(__COREAUDIO_USE_FLAT_INCLUDES__)
  33     #include &lt;AudioUnit/AudioUnit.h&gt;
  34     #if !CA_BASIC_AU_FEATURES
  35         #include &lt;AudioUnit/MusicDevice.h&gt;
  36     #endif
  37 #else
  38     #include &quot;AudioUnit.h&quot;
  39     #if !CA_BASIC_AU_FEATURES
  40         #include &quot;MusicDevice.h&quot;
  41     #endif
  42 #endif
  43 
  44 #ifndef AUTRACE
  45     #define AUTRACE(code, obj, a, b, c, d)
  46 #endif
  47 
  48 #include &quot;AUPlugInDispatch.h&quot;
  49 
  50 #ifndef CA_CANONICAL_DEPRECATED
  51     #define CA_CANONICAL_DEPRECATED
  52 #endif
  53 
  54 // ________________________________________________________________________
  55 // These are to be moved to the public AudioUnit headers
  56 
  57 #define kAUDefaultSampleRate        44100.0
  58 #if !TARGET_OS_WIN32
  59 #define kAUDefaultMaxFramesPerSlice 1156
  60 //this allows enough default frames for a 512 dest 44K and SRC from 96K
  61 // add a padding of 4 frames for any altivec rounding
  62 #else
  63 #define kAUDefaultMaxFramesPerSlice 2048
  64 #endif
  65 
  66 // ________________________________________________________________________
  67 
  68 /*! @class AUBase */
  69 class AUBase : public ComponentBase {
  70 public:
  71 
  72     /*! @ctor AUBase */
  73                                 AUBase(                 AudioComponentInstance          inInstance,
  74                                                         UInt32                          numInputElements,
  75                                                         UInt32                          numOutputElements,
  76                                                         UInt32                          numGroupElements = 0);
  77     /*! @dtor AUBase */
  78     virtual                     ~AUBase();
  79 
  80     /*! @method PostConstructor */
  81     virtual void                PostConstructor() { CreateElements(); }
  82 
  83     /*! @method PreDestructor */
  84     virtual void                PreDestructor();
  85 
  86     /*! @method CreateElements */
  87     void                        CreateElements();
  88                                     // Called immediately after construction, when virtual methods work.
  89                                     // Or, a subclass may call this in order to have access to elements
  90                                     // in its constructor.
  91 
  92     /*! @method CreateExtendedElements */
  93     virtual void CreateExtendedElements() {}
  94 
  95 #pragma mark -
  96 #pragma mark AU dispatch
  97     // ________________________________________________________________________
  98     // Virtual methods (mostly) directly corresponding to the entry points.  Many of these
  99     // have useful implementations here and will not need overriding.
 100 
 101     /*! @method DoInitialize */
 102             OSStatus            DoInitialize();
 103                 // this implements the entry point and makes sure that initialization
 104                 // is only attempted exactly once...
 105 
 106     /*! @method Initialize */
 107     virtual OSStatus            Initialize();
 108                 // ... so that overrides to this method can assume that they will only
 109                 // be called exactly once.
 110 
 111     /*! @method IsInitialized */
 112             bool                IsInitialized() const { return mInitialized; }
 113     /*! @method HasBegunInitializing */
 114             bool                HasBegunInitializing() const { return mHasBegunInitializing; }
 115 
 116     /*! @method DoCleanup */
 117             void                DoCleanup();
 118                 // same pattern as with Initialize
 119 
 120     /*! @method Cleanup */
 121     virtual void                Cleanup();
 122 
 123     /*! @method Reset */
 124     virtual OSStatus            Reset(                  AudioUnitScope                  inScope,
 125                                                         AudioUnitElement                inElement);
 126 
 127     // Note about GetPropertyInfo, GetProperty, SetProperty:
 128     // Certain properties are trapped out in these dispatch functions and handled with different virtual
 129     // methods.  (To discourage hacks and keep vtable size down, these are non-virtual)
 130 
 131     /*! @method DispatchGetPropertyInfo */
 132             OSStatus            DispatchGetPropertyInfo(AudioUnitPropertyID             inID,
 133                                                         AudioUnitScope                  inScope,
 134                                                         AudioUnitElement                inElement,
 135                                                         UInt32 &amp;                        outDataSize,
 136                                                         Boolean &amp;                       outWritable);
 137 
 138     /*! @method DispatchGetProperty */
 139             OSStatus            DispatchGetProperty(    AudioUnitPropertyID             inID,
 140                                                         AudioUnitScope                  inScope,
 141                                                         AudioUnitElement                inElement,
 142                                                         void *                          outData);
 143 
 144     /*! @method DispatchSetProperty */
 145             OSStatus            DispatchSetProperty(    AudioUnitPropertyID             inID,
 146                                                         AudioUnitScope                  inScope,
 147                                                         AudioUnitElement                inElement,
 148                                                         const void *                    inData,
 149                                                         UInt32                          inDataSize);
 150 
 151             OSStatus            DispatchRemovePropertyValue(    AudioUnitPropertyID     inID,
 152                                                         AudioUnitScope                  inScope,
 153                                                         AudioUnitElement                inElement);
 154 
 155     /*! @method GetPropertyInfo */
 156     virtual OSStatus            GetPropertyInfo(        AudioUnitPropertyID             inID,
 157                                                         AudioUnitScope                  inScope,
 158                                                         AudioUnitElement                inElement,
 159                                                         UInt32 &amp;                        outDataSize,
 160                                                         Boolean &amp;                       outWritable);
 161 
 162     /*! @method GetProperty */
 163     virtual OSStatus            GetProperty(            AudioUnitPropertyID             inID,
 164                                                         AudioUnitScope                  inScope,
 165                                                         AudioUnitElement                inElement,
 166                                                         void *                          outData);
 167 
 168     /*! @method SetProperty */
 169     virtual OSStatus            SetProperty(            AudioUnitPropertyID             inID,
 170                                                         AudioUnitScope                  inScope,
 171                                                         AudioUnitElement                inElement,
 172                                                         const void *                    inData,
 173                                                         UInt32                          inDataSize);
 174 
 175     /*! @method ClearPropertyUsage */
 176     virtual OSStatus            RemovePropertyValue (   AudioUnitPropertyID             inID,
 177                                                         AudioUnitScope                  inScope,
 178                                                         AudioUnitElement                inElement);
 179 
 180     /*! @method AddPropertyListener */
 181     virtual OSStatus            AddPropertyListener(    AudioUnitPropertyID             inID,
 182                                                         AudioUnitPropertyListenerProc   inProc,
 183                                                         void *                          inProcRefCon);
 184 
 185     /*! @method RemovePropertyListener */
 186     virtual OSStatus            RemovePropertyListener( AudioUnitPropertyID             inID,
 187                                                         AudioUnitPropertyListenerProc   inProc,
 188                                                         void *                          inProcRefCon,
 189                                                         bool                            refConSpecified);
 190 
 191     /*! @method SetRenderNotification */
 192     virtual OSStatus            SetRenderNotification(  AURenderCallback                inProc,
 193                                                         void *                          inRefCon);
 194 
 195     /*! @method RemoveRenderNotification */
 196     virtual OSStatus            RemoveRenderNotification(
 197                                                         AURenderCallback                inProc,
 198                                                         void *                          inRefCon);
 199 
 200     /*! @method GetParameter */
 201     virtual OSStatus    GetParameter(           AudioUnitParameterID            inID,
 202                                                         AudioUnitScope                  inScope,
 203                                                         AudioUnitElement                inElement,
 204                                                         AudioUnitParameterValue &amp;       outValue);
 205 
 206     /*! @method SetParameter */
 207     virtual OSStatus    SetParameter(           AudioUnitParameterID            inID,
 208                                                         AudioUnitScope                  inScope,
 209                                                         AudioUnitElement                inElement,
 210                                                         AudioUnitParameterValue         inValue,
 211                                                         UInt32                          inBufferOffsetInFrames);
 212 
 213     /*! @method CanScheduleParams */
 214     virtual bool CanScheduleParameters() const = 0;
 215 
 216     /*! @method ScheduleParameter */
 217     virtual OSStatus    ScheduleParameter (     const AudioUnitParameterEvent   *inParameterEvent,
 218                                                         UInt32                          inNumEvents);
 219 
 220 
 221     /*! @method DoRender */
 222     OSStatus    DoRender(                               AudioUnitRenderActionFlags &amp;    ioActionFlags,
 223                                                         const AudioTimeStamp &amp;          inTimeStamp,
 224                                                         UInt32                          inBusNumber,
 225                                                         UInt32                          inNumberFrames,
 226                                                         AudioBufferList &amp;               ioData);
 227 
 228 
 229     /*! @method Process */
 230     OSStatus    DoProcess (                         AudioUnitRenderActionFlags  &amp;       ioActionFlags,
 231                                                     const AudioTimeStamp &amp;              inTimeStamp,
 232                                                     UInt32                              inFramesToProcess,
 233                                                     AudioBufferList &amp;                   ioData);
 234 
 235     /*! @method ProcessMultiple */
 236     OSStatus    DoProcessMultiple (                 AudioUnitRenderActionFlags  &amp;       ioActionFlags,
 237                                                     const AudioTimeStamp &amp;              inTimeStamp,
 238                                                     UInt32                              inFramesToProcess,
 239                                                     UInt32                              inNumberInputBufferLists,
 240                                                     const AudioBufferList **            inInputBufferLists,
 241                                                     UInt32                              inNumberOutputBufferLists,
 242                                                     AudioBufferList **                  ioOutputBufferLists);
 243 
 244     /*! @method ProcessBufferLists */
 245     virtual OSStatus    ProcessBufferLists(         AudioUnitRenderActionFlags &amp;        ioActionFlags,
 246                                                     const AudioBufferList &amp;             inBuffer,
 247                                                     AudioBufferList &amp;                   outBuffer,
 248                                                     UInt32                              inFramesToProcess )
 249                         {
 250                             return kAudio_UnimplementedError;
 251                         }
 252 
 253     /*! @method ProcessMultipleBufferLists */
 254     virtual OSStatus    ProcessMultipleBufferLists( AudioUnitRenderActionFlags &amp;        ioActionFlags,
 255                                                     UInt32                              inFramesToProcess,
 256                                                     UInt32                              inNumberInputBufferLists,
 257                                                     const AudioBufferList **            inInputBufferLists,
 258                                                     UInt32                              inNumberOutputBufferLists,
 259                                                     AudioBufferList **                  ioOutputBufferLists)
 260                         {
 261                             return kAudio_UnimplementedError;
 262                         }
 263 
 264     /*! @method ComplexRender */
 265     virtual OSStatus    ComplexRender(              AudioUnitRenderActionFlags &amp;        ioActionFlags,
 266                                                     const AudioTimeStamp &amp;              inTimeStamp,
 267                                                     UInt32                              inOutputBusNumber,
 268                                                     UInt32                              inNumberOfPackets,
 269                                                     UInt32 *                            outNumberOfPackets,
 270                                                     AudioStreamPacketDescription *      outPacketDescriptions,
 271                                                     AudioBufferList &amp;                   ioData,
 272                                                     void *                              outMetadata,
 273                                                     UInt32 *                            outMetadataByteSize)
 274                         {
 275                             return kAudio_UnimplementedError;
 276                         }
 277 
 278     // Override this method if your AU processes multiple output busses completely independently --
 279     // you&#39;ll want to just call Render without the NeedsToRender check.
 280     // Otherwise, override Render().
 281     //
 282     // N.B. Implementations of this method can assume that the output&#39;s buffer list has already been
 283     // prepared and access it with GetOutput(inBusNumber)-&gt;GetBufferList() instead of
 284     // GetOutput(inBusNumber)-&gt;PrepareBuffer(nFrames) -- if PrepareBuffer is called, a
 285     // copy may occur after rendering.
 286     /*! @method RenderBus */
 287     virtual OSStatus            RenderBus(              AudioUnitRenderActionFlags &amp;    ioActionFlags,
 288                                                         const AudioTimeStamp &amp;          inTimeStamp,
 289                                                         UInt32                          inBusNumber,
 290                                                         UInt32                          inNumberFrames)
 291                                 {
 292                                     if (NeedsToRender(inTimeStamp))
 293                                         return Render(ioActionFlags, inTimeStamp, inNumberFrames);
 294                                     return noErr;   // was presumably already rendered via another bus
 295                                 }
 296 
 297     // N.B. For a unit with only one output bus, it can assume in its implementation of this
 298     // method that the output&#39;s buffer list has already been prepared and access it with
 299     // GetOutput(0)-&gt;GetBufferList() instead of GetOutput(0)-&gt;PrepareBuffer(nFrames)
 300     //  -- if PrepareBuffer is called, a copy may occur after rendering.
 301     /*! @method Render */
 302     virtual OSStatus            Render(                 AudioUnitRenderActionFlags &amp;    ioActionFlags,
 303                                                         const AudioTimeStamp &amp;          inTimeStamp,
 304                                                         UInt32                          inNumberFrames)
 305                                 {
 306                                     return noErr;
 307                                 }
 308 
 309 
 310 #pragma mark -
 311 #pragma mark Property Dispatch
 312 
 313     static const Float64 kNoLastRenderedSampleTime;
 314 
 315     // ________________________________________________________________________
 316     // These are generated from DispatchGetProperty/DispatchGetPropertyInfo/DispatchSetProperty
 317 
 318     /*! @method BusCountWritable */
 319     virtual bool                BusCountWritable(       AudioUnitScope                  inScope)
 320                                 {
 321                                     return false;
 322                                 }
 323     virtual OSStatus            SetBusCount(        AudioUnitScope                  inScope,
 324                                                     UInt32                          inCount);
 325 
 326     /*! @method SetConnection */
 327     virtual OSStatus            SetConnection(          const AudioUnitConnection &amp;     inConnection);
 328 
 329     /*! @method SetInputCallback */
 330     virtual OSStatus            SetInputCallback(       UInt32                          inPropertyID,
 331                                                         AudioUnitElement                inElement,
 332                                                         AURenderCallback                inProc,
 333                                                         void *                          inRefCon);
 334 
 335     /*! @method GetParameterList */
 336     virtual OSStatus            GetParameterList(       AudioUnitScope                  inScope,
 337                                                         AudioUnitParameterID *          outParameterList,
 338                                                         UInt32 &amp;                        outNumParameters);
 339                                                             // outParameterList may be a null pointer
 340 
 341     /*! @method GetParameterInfo */
 342     virtual OSStatus            GetParameterInfo(       AudioUnitScope                  inScope,
 343                                                         AudioUnitParameterID            inParameterID,
 344                                                         AudioUnitParameterInfo &amp;        outParameterInfo);
 345 
 346     virtual OSStatus            GetParameterHistoryInfo(AudioUnitScope                  inScope,
 347                                                         AudioUnitParameterID            inParameterID,
 348                                                         Float32 &amp;                       outUpdatesPerSecond,
 349                                                         Float32 &amp;                       outHistoryDurationInSeconds);
 350 
 351     /*! @method SaveState */
 352     virtual OSStatus            SaveState(              CFPropertyListRef *             outData);
 353 
 354     /*! @method SaveExtendedScopes */
 355     virtual void                SaveExtendedScopes(     CFMutableDataRef                outData) {};
 356 
 357     /*! @method RestoreState */
 358     virtual OSStatus            RestoreState(           CFPropertyListRef               inData);
 359 
 360     /*! @method GetParameterValueStrings */
 361     virtual OSStatus            GetParameterValueStrings(AudioUnitScope                 inScope,
 362                                                         AudioUnitParameterID            inParameterID,
 363                                                         CFArrayRef *                    outStrings);
 364 
 365     /*! @method CopyClumpName */
 366     virtual OSStatus            CopyClumpName(          AudioUnitScope                  inScope,
 367                                                         UInt32                          inClumpID,
 368                                                         UInt32                          inDesiredNameLength,
 369                                                         CFStringRef *                   outClumpName);
 370 
 371     /*! @method GetPresets */
 372     virtual OSStatus            GetPresets (            CFArrayRef *                    outData) const;
 373 
 374         // set the default preset for the unit -&gt; the number of the preset MUST be &gt;= 0
 375         // and the name should be valid, or the preset WON&#39;T take
 376     /*! @method SetAFactoryPresetAsCurrent */
 377     bool                        SetAFactoryPresetAsCurrent (const AUPreset &amp; inPreset);
 378 
 379         // Called when someone sets a new, valid preset
 380         // If this is a valid preset, then the subclass sets its state to that preset
 381         // and returns noErr.
 382         // If not a valid preset, return an error, and the pre-existing preset is restored
 383     /*! @method NewFactoryPresetSet */
 384     virtual OSStatus            NewFactoryPresetSet (const AUPreset &amp; inNewFactoryPreset);
 385 
 386     /*! @method NewCustomPresetSet */
 387     virtual OSStatus            NewCustomPresetSet (const AUPreset &amp; inNewCustomPreset);
 388 
 389 #if !CA_USE_AUDIO_PLUGIN_ONLY
 390     /*! @method GetNumCustomUIComponents */
 391     virtual int                 GetNumCustomUIComponents ();
 392 
 393     /*! @method GetUIComponentDescs */
 394     virtual void                GetUIComponentDescs (ComponentDescription* inDescArray);
 395 #endif
 396 
 397     /*! @method CopyIconLocation */
 398     virtual CFURLRef            CopyIconLocation ();
 399 
 400     // default is no latency, and unimplemented tail time
 401     /*! @method GetLatency */
 402     virtual Float64             GetLatency() {return 0.0;}
 403     /*! @method GetTailTime */
 404     virtual Float64             GetTailTime() {return 0;}
 405     /*! @method SupportsRampAndTail */
 406     virtual bool                SupportsTail () { return false; }
 407 
 408     /*! @method IsStreamFormatWritable */
 409             bool                IsStreamFormatWritable( AudioUnitScope                  scope,
 410                                                         AudioUnitElement                element);
 411 
 412     /*! @method StreamFormatWritable */
 413     virtual bool                StreamFormatWritable(   AudioUnitScope                  scope,
 414                                                         AudioUnitElement                element) = 0;
 415                                                             // scope will always be input or output
 416 
 417             // pass in a pointer to get the struct, and num channel infos
 418             // you can pass in NULL to just get the number
 419             // a return value of 0 (the default in AUBase) means the property is not supported...
 420     /*! @method SupportedNumChannels */
 421     virtual UInt32              SupportedNumChannels (  const AUChannelInfo**           outInfo);
 422 
 423     /*! @method ValidFormat */
 424     virtual bool                ValidFormat(            AudioUnitScope                  inScope,
 425                                                         AudioUnitElement                inElement,
 426                                                         const CAStreamBasicDescription &amp; inNewFormat);
 427                                                             // Will only be called after StreamFormatWritable
 428                                                             // has succeeded.
 429                                                             // Default implementation requires canonical format:
 430                                                             // native-endian 32-bit float, any sample rate,
 431                                                             // any number of channels; override when other
 432                                                             // formats are supported.  A subclass&#39;s override can
 433                                                             // choose to always return true and trap invalid
 434                                                             // formats in ChangeStreamFormat.
 435 
 436 
 437     /*! @method FormatIsCanonical */
 438             CA_CANONICAL_DEPRECATED
 439             bool                FormatIsCanonical(      const CAStreamBasicDescription &amp;format);
 440 
 441     /*! @method MakeCanonicalFormat */
 442             CA_CANONICAL_DEPRECATED
 443             void                MakeCanonicalFormat(    CAStreamBasicDescription &amp;  outDesc,
 444                                                         int                         numChannels = 2);
 445 
 446     /*! @method GetStreamFormat */
 447     virtual const CAStreamBasicDescription &amp;
 448                                 GetStreamFormat(        AudioUnitScope                  inScope,
 449                                                         AudioUnitElement                inElement);
 450 
 451     /*! @method ChangeStreamFormat */
 452     virtual OSStatus            ChangeStreamFormat(     AudioUnitScope                  inScope,
 453                                                         AudioUnitElement                inElement,
 454                                                         const CAStreamBasicDescription &amp; inPrevFormat,
 455                                                         const CAStreamBasicDescription &amp; inNewFormat);
 456                                                             // Will only be called after StreamFormatWritable
 457                                                             // and ValidFormat have succeeded.
 458 
 459     // ________________________________________________________________________
 460 
 461 #if !CA_USE_AUDIO_PLUGIN_ONLY
 462     /*! @method ComponentEntryDispatch */
 463     static OSStatus         ComponentEntryDispatch( ComponentParameters *           params,
 464                                                         AUBase *                        This);
 465 #endif
 466 
 467     // ________________________________________________________________________
 468     // Methods useful for subclasses
 469 
 470     /*! @method GetScope */
 471     AUScope &amp;                   GetScope(               AudioUnitScope                  inScope)
 472     {
 473         if (inScope &gt;= kNumScopes) {
 474             AUScope * scope = GetScopeExtended(inScope);
 475             if (!scope) COMPONENT_THROW(kAudioUnitErr_InvalidScope);
 476             return *scope;
 477         }
 478         return mScopes[inScope];
 479     }
 480 
 481     /*! @method GetScopeExtended */
 482     virtual AUScope *           GetScopeExtended (AudioUnitScope inScope) { return NULL; }
 483 
 484     /*! @method GlobalScope */
 485     AUScope &amp;                   GlobalScope() { return mScopes[kAudioUnitScope_Global]; }
 486     /*! @method Inputs */
 487     AUScope &amp;                   Inputs()    { return mScopes[kAudioUnitScope_Input]; }
 488     /*! @method Outputs */
 489     AUScope &amp;                   Outputs()   { return mScopes[kAudioUnitScope_Output]; }
 490 #if !CA_BASIC_AU_FEATURES
 491     /*! @method Groups */
 492     AUScope &amp;                   Groups()    { return mScopes[kAudioUnitScope_Group]; }
 493 #endif
 494     /*! @method Globals */
 495     AUElement *                 Globals()   { return mScopes[kAudioUnitScope_Global].GetElement(0); }
 496 
 497     /*! @method SetNumberOfElements */
 498     void                        SetNumberOfElements(    AudioUnitScope                  inScope,
 499                                                         UInt32                          numElements);
 500 
 501     /*! @method GetElement */
 502     AUElement *                 GetElement(             AudioUnitScope                  inScope,
 503                                                         AudioUnitElement                inElement)
 504     {
 505         return GetScope(inScope).GetElement(inElement);
 506     }
 507 
 508     /*! @method GetIOElement */
 509     AUIOElement *               GetIOElement(           AudioUnitScope                  inScope,
 510                                                         AudioUnitElement                inElement)
 511     {
 512         return GetScope(inScope).GetIOElement(inElement);
 513     }
 514 
 515     /*! @method SafeGetElement */
 516     AUElement *                 SafeGetElement(         AudioUnitScope                  inScope,
 517                                                         AudioUnitElement                inElement)
 518     {
 519         return GetScope(inScope).SafeGetElement(inElement);
 520     }
 521 
 522     /*! @method GetInput */
 523     AUInputElement *            GetInput(               AudioUnitElement                inElement)
 524     {
 525         return static_cast&lt;AUInputElement *&gt;(Inputs().SafeGetElement(inElement));
 526     }
 527 
 528     /*! @method GetOutput */
 529     AUOutputElement *           GetOutput(              AudioUnitElement                inElement)
 530     {
 531         return static_cast&lt;AUOutputElement *&gt;(Outputs().SafeGetElement(inElement));
 532     }
 533 
 534 #if !CA_BASIC_AU_FEATURES
 535     /*! @method GetGroup */
 536     AUElement *                 GetGroup(               AudioUnitElement                inElement)
 537     {
 538         return Groups().SafeGetElement(inElement);
 539     }
 540 #endif
 541 
 542     /*! @method PullInput */
 543     OSStatus                    PullInput(              UInt32                      inBusNumber,
 544                                                         AudioUnitRenderActionFlags &amp;ioActionFlags,
 545                                                         const AudioTimeStamp &amp;      inTimeStamp,
 546                                                         UInt32                      inNumberFrames)
 547     {
 548         AUInputElement *input = GetInput(inBusNumber);  // throws if error
 549         return input-&gt;PullInput(ioActionFlags, inTimeStamp, inBusNumber, inNumberFrames);
 550     }
 551 
 552     /*! @method GetMaxFramesPerSlice */
 553     UInt32                      GetMaxFramesPerSlice() const { return mMaxFramesPerSlice; }
 554     /*! @method UsesFixedBlockSize */
 555     bool                        UsesFixedBlockSize() const { return mUsesFixedBlockSize; }
 556     /*! @method SetUsesFixedBlockSize */
 557     void                        SetUsesFixedBlockSize(bool inUsesFixedBlockSize) { mUsesFixedBlockSize = inUsesFixedBlockSize; }
 558 
 559     /*! @method GetVectorUnitType */
 560     static SInt32               GetVectorUnitType() { return sVectorUnitType; }
 561     /*! @method HasVectorUnit */
 562     static bool                 HasVectorUnit() { return sVectorUnitType &gt; 0; }
 563     /*! @method HasAltivec */
 564     static bool                 HasAltivec() { return sVectorUnitType == kVecAltivec; }
 565     /*! @method HasSSE2 */
 566     static bool                 HasSSE2() { return sVectorUnitType &gt;= kVecSSE2; }
 567     /*! @method HasSSE3 */
 568     static bool                 HasSSE3() { return sVectorUnitType &gt;= kVecSSE3; }
 569 
 570     /*! @method AudioUnitAPIVersion */
 571     UInt8                       AudioUnitAPIVersion() const { return mAudioUnitAPIVersion; }
 572 
 573     /*! @method IsRenderThread */
 574     bool                        InRenderThread () const
 575                                 {
 576 #if TARGET_OS_MAC
 577                                     return (mRenderThreadID ? pthread_equal (mRenderThreadID, pthread_self()) : false);
 578 #elif TARGET_OS_WIN32
 579                                     return (mRenderThreadID ? mRenderThreadID == GetCurrentThreadId() : false);
 580 #endif
 581                                 }
 582 
 583     /*! @method HasInput */
 584     bool                        HasInput(               AudioUnitElement                inElement) {
 585                                     AUInputElement *in = static_cast&lt;AUInputElement *&gt;(Inputs().GetElement(inElement));
 586                                     return in != NULL &amp;&amp; in-&gt;IsActive();
 587                                 }
 588                                     // says whether an input is connected or has a callback
 589 
 590     /*! @method PropertyChanged */
 591     virtual void                PropertyChanged(        AudioUnitPropertyID             inID,
 592                                                         AudioUnitScope                  inScope,
 593                                                         AudioUnitElement                inElement);
 594 
 595 #if !CA_NO_AU_UI_FEATURES
 596     // These calls can be used to call a Host&#39;s Callbacks. The method returns -1 if the host
 597     // hasn&#39;t supplied the callback. Any other result is returned by the host.
 598     // As in the API contract, for a parameter&#39;s value, you specify a pointer
 599     // to that data type. Specify NULL for a parameter that you are not interested
 600     // as this can save work in the host.
 601 
 602     /*! @method CallHostBeatAndTempo */
 603     OSStatus    CallHostBeatAndTempo (Float64               *outCurrentBeat,
 604                                         Float64             *outCurrentTempo)
 605     {
 606         return (mHostCallbackInfo.beatAndTempoProc
 607                         ? (*mHostCallbackInfo.beatAndTempoProc) (mHostCallbackInfo.hostUserData,
 608                                                                     outCurrentBeat,
 609                                                                     outCurrentTempo)
 610                         : -1);
 611     }
 612 
 613     /*! @method CallHostMusicalTimeLocation */
 614     OSStatus    CallHostMusicalTimeLocation (UInt32         *outDeltaSampleOffsetToNextBeat,
 615                                         Float32             *outTimeSig_Numerator,
 616                                         UInt32              *outTimeSig_Denominator,
 617                                         Float64             *outCurrentMeasureDownBeat)
 618     {
 619         return (mHostCallbackInfo.musicalTimeLocationProc
 620                         ? (*mHostCallbackInfo.musicalTimeLocationProc) (mHostCallbackInfo.hostUserData,
 621                                                                             outDeltaSampleOffsetToNextBeat,
 622                                                                             outTimeSig_Numerator,
 623                                                                             outTimeSig_Denominator,
 624                                                                             outCurrentMeasureDownBeat)
 625                         : -1);
 626     }
 627 
 628     /*! @method CallHostTransportState */
 629     OSStatus    CallHostTransportState (Boolean             *outIsPlaying,
 630                                         Boolean             *outTransportStateChanged,
 631                                         Float64             *outCurrentSampleInTimeLine,
 632                                         Boolean             *outIsCycling,
 633                                         Float64             *outCycleStartBeat,
 634                                         Float64             *outCycleEndBeat)
 635     {
 636         return (mHostCallbackInfo.transportStateProc
 637                         ? (*mHostCallbackInfo.transportStateProc) (mHostCallbackInfo.hostUserData,
 638                                                                         outIsPlaying,
 639                                                                         outTransportStateChanged,
 640                                                                         outCurrentSampleInTimeLine,
 641                                                                         outIsCycling,
 642                                                                         outCycleStartBeat,
 643                                                                         outCycleEndBeat)
 644                         : -1);
 645     }
 646 #endif
 647 
 648     char*                       GetLoggingString () const;
 649 
 650     CAMutex*                    GetMutex() { return mAUMutex; }
 651 
 652     // ________________________________________________________________________
 653     /*! @method CreateElement */
 654     virtual AUElement *         CreateElement(          AudioUnitScope                  scope,
 655                                                         AudioUnitElement                element);
 656 
 657 #pragma mark -
 658 #pragma mark AU Output Base Dispatch
 659     // ________________________________________________________________________
 660     // ________________________________________________________________________
 661     // ________________________________________________________________________
 662     // output unit methods
 663     /*! @method Start */
 664     virtual OSStatus    Start() { return kAudio_UnimplementedError; }
 665     /*! @method Stop */
 666     virtual OSStatus    Stop() { return kAudio_UnimplementedError; }
 667 
 668 #if !CA_BASIC_AU_FEATURES
 669 #pragma mark -
 670 #pragma mark AU Music Base Dispatch
 671 
 672 #if !TARGET_OS_IPHONE
 673 // these methods are deprecated, so we don&#39;t include them except for compatability
 674     /*! @method PrepareInstrument */
 675     virtual OSStatus            PrepareInstrument(MusicDeviceInstrumentID inInstrument) { return kAudio_UnimplementedError; }
 676 
 677     /*! @method PrepareInstrument */
 678     virtual OSStatus            ReleaseInstrument(MusicDeviceInstrumentID inInstrument) { return kAudio_UnimplementedError; }
 679 #endif
 680 
 681     // ________________________________________________________________________
 682     // ________________________________________________________________________
 683     // ________________________________________________________________________
 684     // music device/music effect methods -- incomplete
 685     /*! @method MIDIEvent */
 686     virtual OSStatus    MIDIEvent(      UInt32                      inStatus,
 687                                         UInt32                      inData1,
 688                                         UInt32                      inData2,
 689                                         UInt32                      inOffsetSampleFrame) { return kAudio_UnimplementedError; }
 690 
 691     /*! @method SysEx */
 692     virtual OSStatus    SysEx(          const UInt8 *               inData,
 693                                         UInt32                      inLength) { return kAudio_UnimplementedError;}
 694 
 695     /*! @method StartNote */
 696     virtual OSStatus    StartNote(      MusicDeviceInstrumentID     inInstrument,
 697                                         MusicDeviceGroupID          inGroupID,
 698                                         NoteInstanceID *            outNoteInstanceID,
 699                                         UInt32                      inOffsetSampleFrame,
 700                                         const MusicDeviceNoteParams &amp;inParams) { return kAudio_UnimplementedError; }
 701 
 702     /*! @method StopNote */
 703     virtual OSStatus    StopNote(       MusicDeviceGroupID          inGroupID,
 704                                         NoteInstanceID              inNoteInstanceID,
 705                                         UInt32                      inOffsetSampleFrame) { return kAudio_UnimplementedError; }
 706 #endif
 707 
 708     // ________________________________________________________________________
 709     // ________________________________________________________________________
 710     // ________________________________________________________________________
 711 
 712 protected:
 713 #pragma mark -
 714 #pragma mark Implementation methods
 715 
 716     /*! @method ReallocateBuffers */
 717     virtual void                ReallocateBuffers();
 718                                     // needs to be called when mMaxFramesPerSlice changes
 719     virtual void                DeallocateIOBuffers();
 720 
 721     /*! @method FillInParameterName */
 722     static void                 FillInParameterName (AudioUnitParameterInfo&amp; ioInfo, CFStringRef inName, bool inShouldRelease)
 723     {
 724         ioInfo.cfNameString = inName;
 725         ioInfo.flags |= kAudioUnitParameterFlag_HasCFNameString;
 726         if (inShouldRelease)
 727             ioInfo.flags |= kAudioUnitParameterFlag_CFNameRelease;
 728         CFStringGetCString (inName, ioInfo.name, offsetof (AudioUnitParameterInfo, clumpID), kCFStringEncodingUTF8);
 729     }
 730 
 731     static void                 HasClump (AudioUnitParameterInfo&amp; ioInfo, UInt32 inClumpID)
 732     {
 733         ioInfo.clumpID = inClumpID;
 734         ioInfo.flags |= kAudioUnitParameterFlag_HasClump;
 735     }
 736 
 737     /*! @method SetMaxFramesPerSlice */
 738     virtual void                SetMaxFramesPerSlice(UInt32 nFrames);
 739 
 740     /*! @method CanSetMaxFrames */
 741     virtual OSStatus            CanSetMaxFrames() const;
 742 
 743     /*! @method WantsRenderThreadID */
 744     bool                        WantsRenderThreadID () const { return mWantsRenderThreadID; }
 745 
 746     /*! @method SetWantsRenderThreadID */
 747     void                        SetWantsRenderThreadID (bool inFlag);
 748 
 749     /*! @method SetRenderError */
 750     OSStatus                    SetRenderError (OSStatus inErr)
 751     {
 752         if (inErr &amp;&amp; mLastRenderError == 0) {
 753             mLastRenderError = inErr;
 754             PropertyChanged(kAudioUnitProperty_LastRenderError, kAudioUnitScope_Global, 0);
 755         }
 756         return inErr;
 757     }
 758 
 759 private:
 760     /*! @method DoRenderBus */
 761     // shared between Render and RenderSlice, inlined to minimize function call overhead
 762     OSStatus                    DoRenderBus(            AudioUnitRenderActionFlags &amp;    ioActionFlags,
 763                                                         const AudioTimeStamp &amp;          inTimeStamp,
 764                                                         UInt32                          inBusNumber,
 765                                                         AUOutputElement *               theOutput,
 766                                                         UInt32                          inNumberFrames,
 767                                                         AudioBufferList &amp;               ioData)
 768     {
 769         if (ioData.mBuffers[0].mData == NULL || (theOutput-&gt;WillAllocateBuffer() &amp;&amp; Outputs().GetNumberOfElements() &gt; 1))
 770             // will render into cache buffer
 771             theOutput-&gt;PrepareBuffer(inNumberFrames);
 772         else
 773             // will render into caller&#39;s buffer
 774             theOutput-&gt;SetBufferList(ioData);
 775         OSStatus result = RenderBus(ioActionFlags, inTimeStamp, inBusNumber, inNumberFrames);
 776         if (result == noErr) {
 777             if (ioData.mBuffers[0].mData == NULL) {
 778                 theOutput-&gt;CopyBufferListTo(ioData);
 779                 AUTRACE(kCATrace_AUBaseDoRenderBus, mComponentInstance, inNumberFrames, (intptr_t)theOutput-&gt;GetBufferList().mBuffers[0].mData, 0, *(UInt32 *)ioData.mBuffers[0].mData);
 780             } else {
 781                 theOutput-&gt;CopyBufferContentsTo(ioData);
 782                 AUTRACE(kCATrace_AUBaseDoRenderBus, mComponentInstance, inNumberFrames, (intptr_t)theOutput-&gt;GetBufferList().mBuffers[0].mData, (intptr_t)ioData.mBuffers[0].mData, *(UInt32 *)ioData.mBuffers[0].mData);
 783                 theOutput-&gt;InvalidateBufferList();
 784             }
 785         }
 786         return result;
 787     }
 788 
 789     /*! @method HasIcon */
 790     bool                        HasIcon ();
 791 
 792     /*! @method ResetRenderTime */
 793     void                        ResetRenderTime ()
 794                                 {
 795                                     memset (&amp;mCurrentRenderTime, 0, sizeof(mCurrentRenderTime));
 796                                     mCurrentRenderTime.mSampleTime = kNoLastRenderedSampleTime;
 797                                 }
 798 
 799 protected:
 800     /*! @method GetAudioChannelLayout */
 801     virtual UInt32              GetChannelLayoutTags(   AudioUnitScope              scope,
 802                                                         AudioUnitElement            element,
 803                                                         AudioChannelLayoutTag *     outLayoutTags);
 804 
 805     /*! @method GetAudioChannelLayout */
 806     virtual UInt32              GetAudioChannelLayout(  AudioUnitScope              scope,
 807                                                         AudioUnitElement            element,
 808                                                         AudioChannelLayout *        outLayoutPtr,
 809                                                         Boolean &amp;                   outWritable);
 810 
 811     /*! @method SetAudioChannelLayout */
 812     virtual OSStatus            SetAudioChannelLayout(  AudioUnitScope              scope,
 813                                                         AudioUnitElement            element,
 814                                                         const AudioChannelLayout *  inLayout);
 815 
 816     /*! @method RemoveAudioChannelLayout */
 817     virtual OSStatus            RemoveAudioChannelLayout(AudioUnitScope scope, AudioUnitElement element);
 818 
 819     /*! @method NeedsToRender */
 820     bool                        NeedsToRender(          const AudioTimeStamp &amp;      inTimeStamp)
 821                                 {
 822                                     bool needsToRender = fnotequal(inTimeStamp.mSampleTime, mCurrentRenderTime.mSampleTime);
 823                                     if (needsToRender)  // only copy this if we need to render
 824                                         mCurrentRenderTime = inTimeStamp;
 825                                     return needsToRender;
 826                                 }
 827 
 828     // Scheduled parameter implementation:
 829 
 830     typedef std::vector&lt;AudioUnitParameterEvent&gt; ParameterEventList;
 831 
 832     // Usually, you won&#39;t override this method.  You only need to call this if your DSP code
 833     // is prepared to handle scheduled immediate and ramped parameter changes.
 834     // Before calling this method, it is assumed you have already called PullInput() on the input busses
 835     // for which the DSP code depends.  ProcessForScheduledParams() will call (potentially repeatedly)
 836     // virtual method ProcessScheduledSlice() to perform the actual DSP for a given sub-division of
 837     // the buffer.  The job of ProcessForScheduledParams() is to sub-divide the buffer into smaller
 838     // pieces according to the scheduled times found in the ParameterEventList (usually coming
 839     // directly from a previous call to ScheduleParameter() ), setting the appropriate immediate or
 840     // ramped parameter values for the corresponding scopes and elements, then calling ProcessScheduledSlice()
 841     // to do the actual DSP for each of these divisions.
 842     virtual OSStatus    ProcessForScheduledParams(  ParameterEventList      &amp;inParamList,
 843                                                             UInt32                  inFramesToProcess,
 844                                                             void                    *inUserData );
 845 
 846     //  This method is called (potentially repeatedly) by ProcessForScheduledParams()
 847     //  in order to perform the actual DSP required for this portion of the entire buffer
 848     //  being processed.  The entire buffer can be divided up into smaller &quot;slices&quot;
 849     //  according to the timestamps on the scheduled parameters...
 850     //
 851     //  sub-classes wishing to handle scheduled parameter changes should override this method
 852     //  in order to do the appropriate DSP.  AUEffectBase already overrides this for standard
 853     //  effect AudioUnits.
 854     virtual OSStatus            ProcessScheduledSlice(  void                *inUserData,
 855                                                         UInt32              inStartFrameInBuffer,
 856                                                         UInt32              inSliceFramesToProcess,
 857                                                         UInt32              inTotalBufferFrames ) {return noErr;};  // default impl does nothing...
 858 
 859 
 860     /*! @method CurrentRenderTime */
 861     const AudioTimeStamp &amp;      CurrentRenderTime () const { return mCurrentRenderTime; }
 862 
 863     // ________________________________________________________________________
 864     //  Private data members to discourage hacking in subclasses
 865 private:
 866     struct RenderCallback {
 867         RenderCallback(AURenderCallback proc, void *ref) :
 868             mRenderNotify(proc),
 869             mRenderNotifyRefCon(ref)
 870         { }
 871 
 872         AURenderCallback            mRenderNotify;
 873         void *                      mRenderNotifyRefCon;
 874 
 875         bool operator == (const RenderCallback &amp;other) {
 876             return this-&gt;mRenderNotify == other.mRenderNotify &amp;&amp;
 877                     this-&gt;mRenderNotifyRefCon == other.mRenderNotifyRefCon;
 878         }
 879     };
 880     typedef TThreadSafeList&lt;RenderCallback&gt; RenderCallbackList;
 881 
 882 protected:
 883 #if !CA_BASIC_AU_FEATURES
 884     enum { kNumScopes = 4 };
 885 #else
 886     enum { kNumScopes = 3 };
 887 #endif
 888 
 889 private:
 890     /*! @var mElementsCreated */
 891     bool                        mElementsCreated;
 892 protected:
 893     /*! @var mInitialized */
 894     bool                        mInitialized;
 895     /*! @var mHasBegunInitializing */
 896     bool                        mHasBegunInitializing;
 897 private:
 898     /*! @var mAudioUnitAPIVersion */
 899     UInt8                       mAudioUnitAPIVersion;
 900 
 901     /*! @var mInitNumInputEls */
 902     const UInt32                mInitNumInputEls;
 903     /*! @var mInitNumOutputEls */
 904     const UInt32                mInitNumOutputEls;
 905 #if !CA_BASIC_AU_FEATURES
 906     /*! @var mInitNumGroupEls */
 907     const UInt32                mInitNumGroupEls;
 908 #endif
 909     /*! @var mScopes */
 910     AUScope                     mScopes[kNumScopes];
 911 
 912     /*! @var mRenderCallbacks */
 913     RenderCallbackList          mRenderCallbacks;
 914     bool                        mRenderCallbacksTouched;
 915 
 916     /*! @var mRenderThreadID */
 917 #if TARGET_OS_MAC
 918     pthread_t                   mRenderThreadID;
 919 #elif TARGET_OS_WIN32
 920     UInt32                      mRenderThreadID;
 921 #endif
 922 
 923     /*! @var mWantsRenderThreadID */
 924     bool                        mWantsRenderThreadID;
 925 
 926     /*! @var mCurrentRenderTime */
 927     AudioTimeStamp              mCurrentRenderTime;
 928 
 929     /*! @var mMaxFramesPerSlice */
 930     UInt32                      mMaxFramesPerSlice;
 931 
 932     /*! @var mLastRenderError */
 933     OSStatus                    mLastRenderError;
 934     /*! @var mCurrentPreset */
 935     AUPreset                    mCurrentPreset;
 936 
 937 protected:
 938     /*! @var mUsesFixedBlockSize */
 939     bool                        mUsesFixedBlockSize;
 940 
 941     struct PropertyListener {
 942         AudioUnitPropertyID             propertyID;
 943         AudioUnitPropertyListenerProc   listenerProc;
 944         void *                          listenerRefCon;
 945     };
 946     typedef std::vector&lt;PropertyListener&gt;   PropertyListeners;
 947 
 948     /*! @var mParamList */
 949     ParameterEventList          mParamList;
 950     /*! @var mPropertyListeners */
 951     PropertyListeners           mPropertyListeners;
 952 
 953     /*! @var mBuffersAllocated */
 954     bool                        mBuffersAllocated;
 955 
 956     /*! @var mLogString */
 957     // if this is NOT null, it will contain identifying info about this AU.
 958     char*                       mLogString;
 959 
 960     /*! @var mNickName */
 961     CFStringRef                 mNickName;
 962 
 963     /*! @var mAUMutex */
 964     CAMutex *                   mAUMutex;
 965 
 966 private:
 967     /*! @var sVectorUnitType */
 968     static SInt32   sVectorUnitType;
 969 
 970 #if !CA_NO_AU_HOST_CALLBACKS
 971 protected:
 972     /*! @var mHostCallbackInfo */
 973     HostCallbackInfo            mHostCallbackInfo;
 974 
 975 #endif
 976 #if !CA_NO_AU_UI_FEATURES
 977 protected:
 978     /*! @var mContextInfo */
 979     CFStringRef                 mContextName;
 980 #endif
 981 };
 982 
 983 inline  OSStatus    AUInputElement::PullInputWithBufferList(
 984                                                 AudioUnitRenderActionFlags &amp;    ioActionFlags,
 985                                                 const AudioTimeStamp &amp;          inTimeStamp,
 986                                                 AudioUnitElement                inElement,
 987                                                 UInt32                          nFrames,
 988                                                 AudioBufferList *               inBufferList)
 989 {
 990     OSStatus theResult;
 991 
 992     if (HasConnection()) {
 993             // only support connections for V2 audio units
 994 #if !CA_USE_AUDIO_PLUGIN_ONLY
 995         if (mConnRenderProc != NULL)
 996             theResult = reinterpret_cast&lt;AudioUnitRenderProc&gt;(mConnRenderProc)(
 997                             mConnInstanceStorage, &amp;ioActionFlags, &amp;inTimeStamp, mConnection.sourceOutputNumber, nFrames, inBufferList);
 998         else
 999 #endif
1000             theResult = AudioUnitRender(
1001                             mConnection.sourceAudioUnit, &amp;ioActionFlags, &amp;inTimeStamp, mConnection.sourceOutputNumber, nFrames, inBufferList);
1002     } else {
1003         // kFromCallback:
1004             theResult = (mInputProc)(
1005                             mInputProcRefCon, &amp;ioActionFlags, &amp;inTimeStamp, inElement, nFrames, inBufferList);
1006     }
1007 
1008     if (mInputType == kNoInput) // defense: the guy upstream could have disconnected
1009                                 // it&#39;s a horrible thing to do, but may happen!
1010         return kAudioUnitErr_NoConnection;
1011 
1012 
1013     return theResult;
1014 }
1015 
1016 #endif // __AUBase_h__
    </pre>
  </body>
</html>