<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames modules/javafx.web/src/main/native/Tools/DumpRenderTree/TestRunner.cpp</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>   1 /*
   2  * Copyright (C) 2007-2016 Apple Inc. All rights reserved.
   3  * Copyright (C) 2010 Joone Hur &lt;joone@kldp.org&gt;
   4  *
   5  * Redistribution and use in source and binary forms, with or without
   6  * modification, are permitted provided that the following conditions
   7  * are met:
   8  *
   9  * 1.  Redistributions of source code must retain the above copyright
  10  *     notice, this list of conditions and the following disclaimer.
  11  * 2.  Redistributions in binary form must reproduce the above copyright
  12  *     notice, this list of conditions and the following disclaimer in the
  13  *     documentation and/or other materials provided with the distribution.
  14  * 3.  Neither the name of Apple Inc. (&quot;Apple&quot;) nor the names of
  15  *     its contributors may be used to endorse or promote products derived
  16  *     from this software without specific prior written permission.
  17  *
  18  * THIS SOFTWARE IS PROVIDED BY APPLE AND ITS CONTRIBUTORS &quot;AS IS&quot; AND ANY
  19  * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
  20  * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
  21  * DISCLAIMED. IN NO EVENT SHALL APPLE OR ITS CONTRIBUTORS BE LIABLE FOR ANY
  22  * DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
  23  * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
  24  * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
  25  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
  26  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF
  27  * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
  28  */
  29 
  30 #include &quot;config.h&quot;
  31 #include &quot;TestRunner.h&quot;
  32 
  33 #include &quot;WebCoreTestSupport.h&quot;
  34 #include &quot;WorkQueue.h&quot;
  35 #include &quot;WorkQueueItem.h&quot;
  36 #include &lt;JavaScriptCore/APICast.h&gt;
  37 #include &lt;JavaScriptCore/ArrayBufferView.h&gt;
  38 #include &lt;JavaScriptCore/HeapInlines.h&gt;
  39 #include &lt;JavaScriptCore/JSArrayBufferView.h&gt;
  40 #include &lt;JavaScriptCore/JSCTestRunnerUtils.h&gt;
  41 #include &lt;JavaScriptCore/JSContextRef.h&gt;
  42 #include &lt;JavaScriptCore/JSObjectRef.h&gt;
  43 #include &lt;JavaScriptCore/JSRetainPtr.h&gt;
  44 #include &lt;JavaScriptCore/TypedArrayInlines.h&gt;
  45 #include &lt;JavaScriptCore/VMInlines.h&gt;
  46 #include &lt;WebCore/LogInitialization.h&gt;
  47 #include &lt;cstring&gt;
  48 #include &lt;locale.h&gt;
  49 #include &lt;stdio.h&gt;
  50 #include &lt;wtf/Assertions.h&gt;
  51 #include &lt;wtf/LoggingAccumulator.h&gt;
  52 #include &lt;wtf/MathExtras.h&gt;
  53 #include &lt;wtf/RefPtr.h&gt;
  54 #include &lt;wtf/RunLoop.h&gt;
  55 #include &lt;wtf/StdLibExtras.h&gt;
<a name="1" id="anc1"></a><span class="line-added">  56 #include &lt;wtf/UniqueArray.h&gt;</span>
  57 #include &lt;wtf/WallTime.h&gt;
  58 #include &lt;wtf/text/WTFString.h&gt;
  59 
  60 #if PLATFORM(IOS_FAMILY)
  61 #include &lt;WebCore/WebCoreThreadRun.h&gt;
  62 #include &lt;wtf/BlockPtr.h&gt;
  63 #endif
  64 
  65 #if PLATFORM(MAC) &amp;&amp; !PLATFORM(IOS_FAMILY)
  66 #include &lt;Carbon/Carbon.h&gt;
  67 #endif
  68 
  69 FILE* testResult = stdout;
  70 
  71 const unsigned TestRunner::viewWidth = 800;
  72 const unsigned TestRunner::viewHeight = 600;
  73 
  74 const unsigned TestRunner::w3cSVGViewWidth = 480;
  75 const unsigned TestRunner::w3cSVGViewHeight = 360;
  76 
  77 TestRunner::TestRunner(const std::string&amp; testURL, const std::string&amp; expectedPixelHash)
<a name="2" id="anc2"></a><span class="line-modified">  78     : m_testURL(testURL)</span>



















































  79     , m_expectedPixelHash(expectedPixelHash)
  80     , m_titleTextDirection(&quot;ltr&quot;)
<a name="3" id="anc3"></a>
  81 {
  82 }
  83 
  84 Ref&lt;TestRunner&gt; TestRunner::create(const std::string&amp; testURL, const std::string&amp; expectedPixelHash)
  85 {
  86     return adoptRef(*new TestRunner(testURL, expectedPixelHash));
  87 }
  88 
  89 // Static Functions
  90 
  91 static JSValueRef disallowIncreaseForApplicationCacheQuotaCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
  92 {
  93     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
  94     controller-&gt;setDisallowIncreaseForApplicationCacheQuota(true);
  95     return JSValueMakeUndefined(context);
  96 }
  97 
  98 static JSValueRef dumpApplicationCacheDelegateCallbacksCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
  99 {
 100     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 101     controller-&gt;setDumpApplicationCacheDelegateCallbacks(true);
 102     return JSValueMakeUndefined(context);
 103 }
 104 
 105 static JSValueRef dumpAsPDFCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 106 {
 107     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 108     controller-&gt;setDumpAsPDF(true);
 109     return JSValueMakeUndefined(context);
 110 }
 111 
<a name="4" id="anc4"></a><span class="line-added"> 112 static JSValueRef setRenderTreeDumpOptionsCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)</span>
<span class="line-added"> 113 {</span>
<span class="line-added"> 114     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));</span>
<span class="line-added"> 115 </span>
<span class="line-added"> 116     double options = JSValueToNumber(context, arguments[0], exception);</span>
<span class="line-added"> 117     ASSERT(!*exception);</span>
<span class="line-added"> 118 </span>
<span class="line-added"> 119     controller-&gt;setRenderTreeDumpOptions(static_cast&lt;unsigned&gt;(options));</span>
<span class="line-added"> 120     return JSValueMakeUndefined(context);</span>
<span class="line-added"> 121 }</span>
<span class="line-added"> 122 </span>
 123 static JSValueRef dumpAsTextCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 124 {
 125     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 126     controller-&gt;setDumpAsText(true);
 127 
 128     // Optional paramater, describing whether it&#39;s allowed to dump pixel results in dumpAsText mode.
 129     controller-&gt;setGeneratePixelResults(argumentCount &gt; 0 ? JSValueToBoolean(context, arguments[0]) : false);
 130 
 131     return JSValueMakeUndefined(context);
 132 }
 133 
 134 static JSValueRef dumpBackForwardListCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 135 {
 136     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 137     controller-&gt;setDumpBackForwardList(true);
 138     return JSValueMakeUndefined(context);
 139 }
 140 
 141 static JSValueRef dumpChildFramesAsTextCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 142 {
 143     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 144     controller-&gt;setDumpChildFramesAsText(true);
 145     return JSValueMakeUndefined(context);
 146 }
 147 
 148 static JSValueRef dumpChildFrameScrollPositionsCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 149 {
 150     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 151     controller-&gt;setDumpChildFrameScrollPositions(true);
 152     return JSValueMakeUndefined(context);
 153 }
 154 
 155 static JSValueRef dumpDatabaseCallbacksCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 156 {
 157     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 158     controller-&gt;setDumpDatabaseCallbacks(true);
 159     return JSValueMakeUndefined(context);
 160 }
 161 
 162 static JSValueRef dumpDOMAsWebArchiveCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 163 {
 164     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 165     controller-&gt;setDumpDOMAsWebArchive(true);
 166     return JSValueMakeUndefined(context);
 167 }
 168 
 169 static JSValueRef dumpEditingCallbacksCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 170 {
 171     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 172     controller-&gt;setDumpEditingCallbacks(true);
 173     return JSValueMakeUndefined(context);
 174 }
 175 
 176 static JSValueRef dumpFrameLoadCallbacksCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 177 {
 178     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 179     controller-&gt;setDumpFrameLoadCallbacks(true);
 180     return JSValueMakeUndefined(context);
 181 }
 182 
 183 static JSValueRef dumpProgressFinishedCallbackCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 184 {
 185     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 186     controller-&gt;setDumpProgressFinishedCallback(true);
 187     return JSValueMakeUndefined(context);
 188 }
 189 
 190 static JSValueRef dumpUserGestureInFrameLoadCallbacksCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 191 {
 192     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 193     controller-&gt;setDumpUserGestureInFrameLoadCallbacks(true);
 194     return JSValueMakeUndefined(context);
 195 }
 196 
 197 static JSValueRef dumpResourceLoadCallbacksCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 198 {
 199     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 200     controller-&gt;setDumpResourceLoadCallbacks(true);
 201     return JSValueMakeUndefined(context);
 202 }
 203 
 204 static JSValueRef dumpResourceResponseMIMETypesCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 205 {
 206     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 207     controller-&gt;setDumpResourceResponseMIMETypes(true);
 208     return JSValueMakeUndefined(context);
 209 }
 210 
 211 static JSValueRef dumpSelectionRectCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 212 {
 213     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 214     controller-&gt;setDumpSelectionRect(true);
 215     return JSValueMakeUndefined(context);
 216 }
 217 
 218 static JSValueRef dumpSourceAsWebArchiveCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 219 {
 220     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 221     controller-&gt;setDumpSourceAsWebArchive(true);
 222     return JSValueMakeUndefined(context);
 223 }
 224 
 225 static JSValueRef dumpStatusCallbacksCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 226 {
 227     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 228     controller-&gt;setDumpStatusCallbacks(true);
 229     return JSValueMakeUndefined(context);
 230 }
 231 
 232 static JSValueRef dumpTitleChangesCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 233 {
 234     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 235     controller-&gt;setDumpTitleChanges(true);
 236     return JSValueMakeUndefined(context);
 237 }
 238 
 239 static JSValueRef dumpWillCacheResponseCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 240 {
 241     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 242     controller-&gt;setDumpWillCacheResponse(true);
 243     return JSValueMakeUndefined(context);
 244 }
 245 
 246 static JSValueRef pathToLocalResourceCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 247 {
 248     if (argumentCount &lt; 1)
 249         return JSValueMakeUndefined(context);
 250 
 251     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 252     auto localPath = adopt(JSValueToStringCopy(context, arguments[0], exception));
 253     ASSERT(!*exception);
 254 
 255     auto convertedPath = controller-&gt;pathToLocalResource(context, localPath.get());
 256     if (!convertedPath)
 257         return JSValueMakeUndefined(context);
 258 
 259     return JSValueMakeString(context, convertedPath.get());
 260 }
 261 
 262 static JSValueRef removeAllVisitedLinksCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 263 {
 264     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 265     controller-&gt;setDumpVisitedLinksCallback(true);
 266     controller-&gt;removeAllVisitedLinks();
 267     return JSValueMakeUndefined(context);
 268 }
 269 
 270 static JSValueRef repaintSweepHorizontallyCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 271 {
 272     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 273     controller-&gt;setTestRepaintSweepHorizontally(true);
 274     return JSValueMakeUndefined(context);
 275 }
 276 
 277 static JSValueRef setCallCloseOnWebViewsCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 278 {
 279     if (argumentCount &lt; 1)
 280         return JSValueMakeUndefined(context);
 281 
 282     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 283     controller-&gt;setCallCloseOnWebViews(JSValueToBoolean(context, arguments[0]));
 284     return JSValueMakeUndefined(context);
 285 }
 286 
 287 static JSValueRef setCanOpenWindowsCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 288 {
 289     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 290     controller-&gt;setCanOpenWindows(true);
 291     return JSValueMakeUndefined(context);
 292 }
 293 
 294 static JSValueRef setCloseRemainingWindowsWhenCompleteCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 295 {
 296     if (argumentCount &lt; 1)
 297         return JSValueMakeUndefined(context);
 298 
 299     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 300     controller-&gt;setCloseRemainingWindowsWhenComplete(JSValueToBoolean(context, arguments[0]));
 301     return JSValueMakeUndefined(context);
 302 }
 303 
 304 static JSValueRef setAudioResultCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 305 {
 306     if (argumentCount &lt; 1)
 307         return JSValueMakeUndefined(context);
 308 
 309 #if !PLATFORM(JAVA)
 310     // FIXME (123058): Use a JSC API to get buffer contents once such is exposed.
 311     JSC::VM&amp; vm = toJS(context)-&gt;vm();
 312     JSC::JSLockHolder lock(vm);
 313 
 314     JSC::JSArrayBufferView* jsBufferView = JSC::jsDynamicCast&lt;JSC::JSArrayBufferView*&gt;(vm, toJS(toJS(context), arguments[0]));
 315     ASSERT(jsBufferView);
 316     RefPtr&lt;JSC::ArrayBufferView&gt; bufferView = jsBufferView-&gt;unsharedImpl();
 317     const char* buffer = static_cast&lt;const char*&gt;(bufferView-&gt;baseAddress());
 318     std::vector&lt;char&gt; audioData(buffer, buffer + bufferView-&gt;byteLength());
 319 
 320     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 321     controller-&gt;setAudioResult(audioData);
 322     controller-&gt;setDumpAsAudio(true);
 323 #endif
 324 
 325     return JSValueMakeUndefined(context);
 326 }
 327 
 328 static JSValueRef testOnscreenCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 329 {
 330     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 331     controller-&gt;setTestOnscreen(true);
 332     return JSValueMakeUndefined(context);
 333 }
 334 
 335 static JSValueRef testRepaintCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 336 {
 337     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 338     controller-&gt;setTestRepaint(true);
 339     return JSValueMakeUndefined(context);
 340 }
 341 
 342 static JSValueRef addDisallowedURLCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 343 {
 344     // Has mac implementation
 345     if (argumentCount &lt; 1)
 346         return JSValueMakeUndefined(context);
 347 
 348     auto url = adopt(JSValueToStringCopy(context, arguments[0], exception));
 349     ASSERT(!*exception);
 350 
 351     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 352     controller-&gt;addDisallowedURL(url.get());
 353 
 354     return JSValueMakeUndefined(context);
 355 }
 356 
 357 static JSValueRef addURLToRedirectCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 358 {
 359     if (argumentCount &lt; 2)
 360         return JSValueMakeUndefined(context);
 361 
 362     auto origin = adopt(JSValueToStringCopy(context, arguments[0], exception));
 363     ASSERT(!*exception);
 364 
 365     auto destination = adopt(JSValueToStringCopy(context, arguments[1], exception));
 366     ASSERT(!*exception);
 367 
 368     size_t maxLength = JSStringGetMaximumUTF8CStringSize(origin.get());
<a name="5" id="anc5"></a><span class="line-modified"> 369     auto originBuffer = makeUniqueArray&lt;char&gt;(maxLength + 1);</span>
 370     JSStringGetUTF8CString(origin.get(), originBuffer.get(), maxLength + 1);
 371 
 372     maxLength = JSStringGetMaximumUTF8CStringSize(destination.get());
<a name="6" id="anc6"></a><span class="line-modified"> 373     auto destinationBuffer = makeUniqueArray&lt;char&gt;(maxLength + 1);</span>
 374     JSStringGetUTF8CString(destination.get(), destinationBuffer.get(), maxLength + 1);
 375 
 376     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 377     controller-&gt;addURLToRedirect(originBuffer.get(), destinationBuffer.get());
 378 
 379     return JSValueMakeUndefined(context);
 380 }
 381 
 382 static JSValueRef callShouldCloseOnWebViewCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 383 {
 384     // Has mac &amp; windows implementation
 385     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 386 
 387     return JSValueMakeBoolean(context, controller-&gt;callShouldCloseOnWebView());
 388 }
 389 
 390 static JSValueRef clearAllApplicationCachesCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 391 {
 392     // Has mac implementation
 393     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 394     controller-&gt;clearAllApplicationCaches();
 395 
 396     return JSValueMakeUndefined(context);
 397 }
 398 
 399 static JSValueRef clearApplicationCacheForOriginCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 400 {
 401     if (argumentCount &lt; 1)
 402         return JSValueMakeUndefined(context);
 403 
 404     auto originURL = adopt(JSValueToStringCopy(context, arguments[0], exception));
 405     ASSERT(!*exception);
 406 
 407     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 408     controller-&gt;clearApplicationCacheForOrigin(originURL.get());
 409 
 410     return JSValueMakeUndefined(context);
 411 }
 412 
 413 static JSValueRef applicationCacheDiskUsageForOriginCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 414 {
 415     if (argumentCount &lt; 1)
 416         return JSValueMakeUndefined(context);
 417 
 418     auto originURL = adopt(JSValueToStringCopy(context, arguments[0], exception));
 419     ASSERT(!*exception);
 420 
 421     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 422 
 423     return JSValueMakeNumber(context, controller-&gt;applicationCacheDiskUsageForOrigin(originURL.get()));
 424 }
 425 
 426 static JSValueRef originsWithApplicationCacheCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 427 {
 428     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 429     return controller-&gt;originsWithApplicationCache(context);
 430 }
 431 
 432 static JSValueRef clearAllDatabasesCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 433 {
 434     // Has mac &amp; windows implementation
 435     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 436     controller-&gt;clearAllDatabases();
 437 
 438     return JSValueMakeUndefined(context);
 439 }
 440 
 441 static JSValueRef clearBackForwardListCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 442 {
 443     // Has mac &amp; windows implementation
 444     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 445     controller-&gt;clearBackForwardList();
 446 
 447     return JSValueMakeUndefined(context);
 448 }
 449 
 450 static JSValueRef clearPersistentUserStyleSheetCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 451 {
 452     // Has mac &amp; windows implementation
 453     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 454     controller-&gt;clearPersistentUserStyleSheet();
 455 
 456     return JSValueMakeUndefined(context);
 457 }
 458 
 459 static JSValueRef decodeHostNameCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 460 {
 461     // Has mac implementation
 462     if (argumentCount &lt; 1)
 463         return JSValueMakeUndefined(context);
 464 
 465     auto name = adopt(JSValueToStringCopy(context, arguments[0], exception));
 466     ASSERT(!*exception);
 467 
 468     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 469     auto decodedHostName = controller-&gt;copyDecodedHostName(name.get());
 470     return JSValueMakeString(context, decodedHostName.get());
 471 }
 472 
 473 static JSValueRef dispatchPendingLoadRequestsCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 474 {
 475     // Has mac implementation, needs windows implementation
 476     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 477     controller-&gt;dispatchPendingLoadRequests();
 478 
 479     return JSValueMakeUndefined(context);
 480 }
 481 
 482 static JSValueRef displayCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 483 {
 484     // Has mac &amp; windows implementation
 485     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 486     controller-&gt;display();
 487 
 488     return JSValueMakeUndefined(context);
 489 }
 490 
 491 static JSValueRef displayAndTrackRepaintsCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 492 {
 493     // Has mac &amp; windows implementation
 494     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 495     controller-&gt;displayAndTrackRepaints();
 496 
 497     return JSValueMakeUndefined(context);
 498 }
 499 
 500 static JSValueRef encodeHostNameCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 501 {
 502     // Has mac implementation
 503     if (argumentCount &lt; 1)
 504         return JSValueMakeUndefined(context);
 505 
 506     auto name = adopt(JSValueToStringCopy(context, arguments[0], exception));
 507     ASSERT(!*exception);
 508 
 509     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 510     auto encodedHostName = controller-&gt;copyEncodedHostName(name.get());
 511     return JSValueMakeString(context, encodedHostName.get());
 512 }
 513 
 514 static JSValueRef execCommandCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 515 {
 516     // Has Mac &amp; Windows implementations.
 517     if (argumentCount &lt; 1)
 518         return JSValueMakeUndefined(context);
 519 
 520     auto name = adopt(JSValueToStringCopy(context, arguments[0], exception));
 521     ASSERT(!*exception);
 522 
 523     // Ignoring the second parameter (userInterface), as this command emulates a manual action.
 524 
 525     JSRetainPtr&lt;JSStringRef&gt; value;
 526     if (argumentCount &gt;= 3) {
 527         value = adopt(JSValueToStringCopy(context, arguments[2], exception));
 528         ASSERT(!*exception);
 529     } else
 530         value = adopt(JSStringCreateWithUTF8CString(&quot;&quot;));
 531 
 532 
 533     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 534     controller-&gt;execCommand(name.get(), value.get());
 535 
 536     return JSValueMakeUndefined(context);
 537 }
 538 
 539 static JSValueRef findStringCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 540 {
 541     // Has Mac implementation.
 542     if (argumentCount &lt; 2)
 543         return JSValueMakeUndefined(context);
 544 
 545     auto target = adopt(JSValueToStringCopy(context, arguments[0], exception));
 546     ASSERT(!*exception);
 547 
 548     JSObjectRef options = JSValueToObject(context, arguments[1], exception);
 549     ASSERT(!*exception);
 550 
 551     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 552     return JSValueMakeBoolean(context, controller-&gt;findString(context, target.get(), options));
 553 }
 554 
 555 static JSValueRef goBackCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 556 {
 557     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 558     controller-&gt;goBack();
 559 
 560     return JSValueMakeUndefined(context);
 561 }
 562 
 563 static JSValueRef isCommandEnabledCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 564 {
 565     // Has Mac implementation.
 566 
 567     if (argumentCount &lt; 1)
 568         return JSValueMakeUndefined(context);
 569 
 570     auto name = adopt(JSValueToStringCopy(context, arguments[0], exception));
 571     ASSERT(!*exception);
 572 
 573     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 574 
 575     return JSValueMakeBoolean(context, controller-&gt;isCommandEnabled(name.get()));
 576 }
 577 
 578 static JSValueRef overridePreferenceCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 579 {
 580     if (argumentCount &lt; 2)
 581         return JSValueMakeUndefined(context);
 582 
 583     auto key = adopt(JSValueToStringCopy(context, arguments[0], exception));
 584     ASSERT(!*exception);
 585     auto value = adopt(JSValueToStringCopy(context, arguments[1], exception));
 586     ASSERT(!*exception);
 587 
 588     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 589     controller-&gt;overridePreference(key.get(), value.get());
 590 
 591     return JSValueMakeUndefined(context);
 592 }
 593 
 594 static JSValueRef keepWebHistoryCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 595 {
 596     // Has mac implementation
 597     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 598     controller-&gt;keepWebHistory();
 599 
 600     return JSValueMakeUndefined(context);
 601 }
 602 
 603 static JSValueRef notifyDoneCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 604 {
 605     // Has mac &amp; windows implementation
 606     // May be able to be made platform independant by using shared WorkQueue
 607     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 608     controller-&gt;notifyDone();
 609     return JSValueMakeUndefined(context);
 610 }
 611 
 612 static JSValueRef numberOfPendingGeolocationPermissionRequestsCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 613 {
 614     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 615     return JSValueMakeNumber(context, controller-&gt;numberOfPendingGeolocationPermissionRequests());
 616 }
 617 
 618 static JSValueRef isGeolocationProviderActiveCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 619 {
 620     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 621     return JSValueMakeBoolean(context, controller-&gt;isGeolocationProviderActive());
 622 }
 623 
 624 static JSValueRef queueBackNavigationCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 625 {
 626     // Has mac &amp; windows implementation
 627     // May be able to be made platform independant by using shared WorkQueue
 628     if (argumentCount &lt; 1)
 629         return JSValueMakeUndefined(context);
 630 
 631     double howFarBackDouble = JSValueToNumber(context, arguments[0], exception);
 632     ASSERT(!*exception);
 633 
 634     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 635     controller-&gt;queueBackNavigation(static_cast&lt;int&gt;(howFarBackDouble));
 636 
 637     return JSValueMakeUndefined(context);
 638 }
 639 
 640 static JSValueRef queueForwardNavigationCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 641 {
 642     // Has mac &amp; windows implementation
 643     // May be able to be made platform independant by using shared WorkQueue
 644     if (argumentCount &lt; 1)
 645         return JSValueMakeUndefined(context);
 646 
 647     double howFarForwardDouble = JSValueToNumber(context, arguments[0], exception);
 648     ASSERT(!*exception);
 649 
 650     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 651     controller-&gt;queueForwardNavigation(static_cast&lt;int&gt;(howFarForwardDouble));
 652 
 653     return JSValueMakeUndefined(context);
 654 }
 655 
 656 static JSValueRef queueLoadCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 657 {
 658     // Has mac &amp; windows implementation
 659     // May be able to be made platform independant by using shared WorkQueue
 660     if (argumentCount &lt; 1)
 661         return JSValueMakeUndefined(context);
 662 
 663     auto url = adopt(JSValueToStringCopy(context, arguments[0], exception));
 664     ASSERT(!*exception);
 665 
 666     JSRetainPtr&lt;JSStringRef&gt; target;
 667     if (argumentCount &gt;= 2) {
 668         target = adopt(JSValueToStringCopy(context, arguments[1], exception));
 669         ASSERT(!*exception);
 670     } else
 671         target = adopt(JSStringCreateWithUTF8CString(&quot;&quot;));
 672 
 673     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 674     controller-&gt;queueLoad(url.get(), target.get());
 675 
 676     return JSValueMakeUndefined(context);
 677 }
 678 
 679 static JSValueRef queueLoadHTMLStringCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 680 {
 681     // Has Mac &amp; Windows implementation
 682     if (argumentCount &lt; 1)
 683         return JSValueMakeUndefined(context);
 684 
 685     auto content = adopt(JSValueToStringCopy(context, arguments[0], exception));
 686     ASSERT(!*exception);
 687 
 688     JSRetainPtr&lt;JSStringRef&gt; baseURL;
 689     if (argumentCount &gt;= 2) {
 690         baseURL = adopt(JSValueToStringCopy(context, arguments[1], exception));
 691         ASSERT(!*exception);
 692     } else
 693         baseURL = adopt(JSStringCreateWithUTF8CString(&quot;&quot;));
 694 
 695     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 696 
 697     if (argumentCount &gt;= 3) {
 698         auto unreachableURL = adopt(JSValueToStringCopy(context, arguments[2], exception));
 699         ASSERT(!*exception);
 700         controller-&gt;queueLoadAlternateHTMLString(content.get(), baseURL.get(), unreachableURL.get());
 701         return JSValueMakeUndefined(context);
 702     }
 703 
 704     controller-&gt;queueLoadHTMLString(content.get(), baseURL.get());
 705     return JSValueMakeUndefined(context);
 706 }
 707 
 708 static JSValueRef queueReloadCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 709 {
 710     // Has mac &amp; windows implementation
 711     // May be able to be made platform independant by using shared WorkQueue
 712 
 713     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 714     controller-&gt;queueReload();
 715 
 716     return JSValueMakeUndefined(context);
 717 }
 718 
 719 static JSValueRef queueLoadingScriptCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 720 {
 721     // Has mac &amp; windows implementation
 722     // May be able to be made platform independant by using shared WorkQueue
 723     if (argumentCount &lt; 1)
 724         return JSValueMakeUndefined(context);
 725 
 726     auto script = adopt(JSValueToStringCopy(context, arguments[0], exception));
 727     ASSERT(!*exception);
 728 
 729     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 730     controller-&gt;queueLoadingScript(script.get());
 731 
 732     return JSValueMakeUndefined(context);
 733 }
 734 
 735 static JSValueRef queueNonLoadingScriptCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 736 {
 737     // Has mac &amp; windows implementation
 738     // May be able to be made platform independant by using shared WorkQueue
 739     if (argumentCount &lt; 1)
 740         return JSValueMakeUndefined(context);
 741 
 742     auto script = adopt(JSValueToStringCopy(context, arguments[0], exception));
 743     ASSERT(!*exception);
 744 
 745     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 746     controller-&gt;queueNonLoadingScript(script.get());
 747 
 748     return JSValueMakeUndefined(context);
 749 }
 750 
 751 static JSValueRef setAcceptsEditingCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 752 {
 753     // Has mac &amp; windows implementation
 754     if (argumentCount &lt; 1)
 755         return JSValueMakeUndefined(context);
 756 
 757     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 758     controller-&gt;setAcceptsEditing(JSValueToBoolean(context, arguments[0]));
 759 
 760     return JSValueMakeUndefined(context);
 761 }
 762 
 763 static JSValueRef setAlwaysAcceptCookiesCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 764 {
 765     // Has mac &amp; windows implementation
 766     if (argumentCount &lt; 1)
 767         return JSValueMakeUndefined(context);
 768 
 769     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 770     controller-&gt;setAlwaysAcceptCookies(JSValueToBoolean(context, arguments[0]));
 771 
 772     return JSValueMakeUndefined(context);
 773 }
 774 
 775 static JSValueRef setOnlyAcceptFirstPartyCookiesCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 776 {
 777     if (argumentCount &lt; 1)
 778         return JSValueMakeUndefined(context);
 779 
 780     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 781     controller-&gt;setOnlyAcceptFirstPartyCookies(JSValueToBoolean(context, arguments[0]));
 782 
 783     return JSValueMakeUndefined(context);
 784 }
 785 
 786 static JSValueRef setAppCacheMaximumSizeCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 787 {
 788     // Has mac implementation
 789     if (argumentCount &lt; 1)
 790         return JSValueMakeUndefined(context);
 791 
 792     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 793 
 794     double size = JSValueToNumber(context, arguments[0], NULL);
 795     if (!std::isnan(size))
 796         controller-&gt;setAppCacheMaximumSize(static_cast&lt;unsigned long long&gt;(size));
 797 
 798     return JSValueMakeUndefined(context);
 799 }
 800 
 801 static JSValueRef setAuthenticationPasswordCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 802 {
 803     // Has mac &amp; windows implementation
 804     if (argumentCount &lt; 1)
 805         return JSValueMakeUndefined(context);
 806 
 807     auto password = adopt(JSValueToStringCopy(context, arguments[0], exception));
 808     ASSERT(!*exception);
 809 
 810     size_t maxLength = JSStringGetMaximumUTF8CStringSize(password.get());
 811     char* passwordBuffer = new char[maxLength + 1];
 812     JSStringGetUTF8CString(password.get(), passwordBuffer, maxLength + 1);
 813 
 814     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 815     controller-&gt;setAuthenticationPassword(passwordBuffer);
 816     delete[] passwordBuffer;
 817 
 818     return JSValueMakeUndefined(context);
 819 }
 820 
 821 static JSValueRef setAuthenticationUsernameCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 822 {
 823     // Has mac &amp; windows implementation
 824     if (argumentCount &lt; 1)
 825         return JSValueMakeUndefined(context);
 826 
 827     auto username = adopt(JSValueToStringCopy(context, arguments[0], exception));
 828     ASSERT(!*exception);
 829 
 830     size_t maxLength = JSStringGetMaximumUTF8CStringSize(username.get());
 831     char* usernameBuffer = new char[maxLength + 1];
 832     JSStringGetUTF8CString(username.get(), usernameBuffer, maxLength + 1);
 833 
 834     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 835     controller-&gt;setAuthenticationUsername(usernameBuffer);
 836     delete[] usernameBuffer;
 837 
 838     return JSValueMakeUndefined(context);
 839 }
 840 
 841 static JSValueRef setAuthorAndUserStylesEnabledCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 842 {
 843     // Has mac &amp; windows implementation
 844     if (argumentCount &lt; 1)
 845         return JSValueMakeUndefined(context);
 846 
 847     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 848     controller-&gt;setAuthorAndUserStylesEnabled(JSValueToBoolean(context, arguments[0]));
 849 
 850     return JSValueMakeUndefined(context);
 851 }
 852 
 853 static JSValueRef setCacheModelCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 854 {
 855     // Has Mac implementation.
 856     if (argumentCount &lt; 1)
 857         return JSValueMakeUndefined(context);
 858 
 859     int cacheModel = JSValueToNumber(context, arguments[0], exception);
 860     ASSERT(!*exception);
 861 
 862     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 863     controller-&gt;setCacheModel(cacheModel);
 864 
 865     return JSValueMakeUndefined(context);
 866 }
 867 
 868 static JSValueRef setCustomPolicyDelegateCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 869 {
 870     // Has mac implementation
 871     if (argumentCount &lt; 1)
 872         return JSValueMakeUndefined(context);
 873 
 874     bool permissive = false;
 875     if (argumentCount &gt;= 2)
 876         permissive = JSValueToBoolean(context, arguments[1]);
 877 
 878     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 879     controller-&gt;setCustomPolicyDelegate(JSValueToBoolean(context, arguments[0]), permissive);
 880 
 881     return JSValueMakeUndefined(context);
 882 }
 883 
 884 static JSValueRef setDatabaseQuotaCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 885 {
 886     // Has mac implementation
 887     if (argumentCount &lt; 1)
 888         return JSValueMakeUndefined(context);
 889 
 890     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 891 
 892     double quota = JSValueToNumber(context, arguments[0], NULL);
 893     if (!std::isnan(quota))
 894         controller-&gt;setDatabaseQuota(static_cast&lt;unsigned long long&gt;(quota));
 895 
 896     return JSValueMakeUndefined(context);
 897 }
 898 
<a name="7" id="anc7"></a>













 899 static JSValueRef setDefersLoadingCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 900 {
 901     if (argumentCount &lt; 1)
 902         return JSValueMakeUndefined(context);
 903 
 904     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 905     controller-&gt;setDefersLoading(JSValueToBoolean(context, arguments[0]));
 906 
 907     return JSValueMakeUndefined(context);
 908 }
 909 
 910 static JSValueRef setUseDeferredFrameLoadingCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 911 {
 912     if (argumentCount &lt; 1)
 913         return JSValueMakeUndefined(context);
 914 
 915     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 916     controller-&gt;setUseDeferredFrameLoading(JSValueToBoolean(context, arguments[0]));
 917 
 918     return JSValueMakeUndefined(context);
 919 }
 920 
 921 static JSValueRef setDomainRelaxationForbiddenForURLSchemeCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 922 {
 923     // Has Mac and Windows implementation
 924     if (argumentCount &lt; 2)
 925         return JSValueMakeUndefined(context);
 926 
 927     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 928 
 929     bool forbidden = JSValueToBoolean(context, arguments[0]);
 930     auto scheme = adopt(JSValueToStringCopy(context, arguments[1], 0));
 931     controller-&gt;setDomainRelaxationForbiddenForURLScheme(forbidden, scheme.get());
 932 
 933     return JSValueMakeUndefined(context);
 934 }
 935 
 936 static JSValueRef setMockDeviceOrientationCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 937 {
 938     if (argumentCount &lt; 6)
 939         return JSValueMakeUndefined(context);
 940 
 941     bool canProvideAlpha = JSValueToBoolean(context, arguments[0]);
 942     double alpha = JSValueToNumber(context, arguments[1], exception);
 943     ASSERT(!*exception);
 944     bool canProvideBeta = JSValueToBoolean(context, arguments[2]);
 945     double beta = JSValueToNumber(context, arguments[3], exception);
 946     ASSERT(!*exception);
 947     bool canProvideGamma = JSValueToBoolean(context, arguments[4]);
 948     double gamma = JSValueToNumber(context, arguments[5], exception);
 949     ASSERT(!*exception);
 950 
 951     TestRunner* controller = reinterpret_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 952     controller-&gt;setMockDeviceOrientation(canProvideAlpha, alpha, canProvideBeta, beta, canProvideGamma, gamma);
 953 
 954     return JSValueMakeUndefined(context);
 955 }
 956 
 957 static JSValueRef setMockGeolocationPositionCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 958 {
 959     if (argumentCount &lt; 3)
 960         return JSValueMakeUndefined(context);
 961 
 962     double latitude = JSValueToNumber(context, arguments[0], 0);
 963     double longitude = JSValueToNumber(context, arguments[1], 0);
 964     double accuracy = JSValueToNumber(context, arguments[2], 0);
 965 
 966     bool canProvideAltitude = false;
 967     double altitude = 0.;
 968     if (argumentCount &gt; 3 &amp;&amp; !JSValueIsUndefined(context, arguments[3])) {
 969         canProvideAltitude = true;
 970         altitude = JSValueToNumber(context, arguments[3], 0);
 971     }
 972 
 973     bool canProvideAltitudeAccuracy = false;
 974     double altitudeAccuracy = 0.;
 975     if (argumentCount &gt; 4 &amp;&amp; !JSValueIsUndefined(context, arguments[4])) {
 976         canProvideAltitudeAccuracy = true;
 977         altitudeAccuracy = JSValueToNumber(context, arguments[4], 0);
 978     }
 979 
 980     bool canProvideHeading = false;
 981     double heading = 0.;
 982     if (argumentCount &gt; 5 &amp;&amp; !JSValueIsUndefined(context, arguments[5])) {
 983         canProvideHeading = true;
 984         heading = JSValueToNumber(context, arguments[5], 0);
 985     }
 986 
 987     bool canProvideSpeed = false;
 988     double speed = 0.;
 989     if (argumentCount &gt; 6 &amp;&amp; !JSValueIsUndefined(context, arguments[6])) {
 990         canProvideSpeed = true;
 991         speed = JSValueToNumber(context, arguments[6], 0);
 992     }
 993 
 994     bool canProvideFloorLevel = false;
 995     double floorLevel = 0.;
 996     if (argumentCount &gt; 7 &amp;&amp; !JSValueIsUndefined(context, arguments[7])) {
 997         canProvideFloorLevel = true;
 998         floorLevel = JSValueToNumber(context, arguments[7], 0);
 999     }
1000 
1001     TestRunner* controller = reinterpret_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1002     controller-&gt;setMockGeolocationPosition(latitude, longitude, accuracy, canProvideAltitude, altitude, canProvideAltitudeAccuracy, altitudeAccuracy, canProvideHeading, heading, canProvideSpeed, speed, canProvideFloorLevel, floorLevel);
1003 
1004     return JSValueMakeUndefined(context);
1005 }
1006 
1007 static JSValueRef setMockGeolocationPositionUnavailableErrorCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1008 {
1009     if (argumentCount != 1)
1010         return JSValueMakeUndefined(context);
1011 
1012     auto message = adopt(JSValueToStringCopy(context, arguments[0], exception));
1013     ASSERT(!*exception);
1014 
1015     TestRunner* controller = reinterpret_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1016     controller-&gt;setMockGeolocationPositionUnavailableError(message.get());
1017 
1018     return JSValueMakeUndefined(context);
1019 }
1020 
1021 static JSValueRef setNewWindowsCopyBackForwardListCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1022 {
1023     // Has mac implementation
1024     if (argumentCount &lt; 1)
1025         return JSValueMakeUndefined(context);
1026 
1027     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1028     controller-&gt;setNewWindowsCopyBackForwardList(JSValueToBoolean(context, arguments[0]));
1029 
1030     return JSValueMakeUndefined(context);
1031 }
1032 
1033 static JSValueRef setGeolocationPermissionCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1034 {
1035     // Has mac implementation
1036     if (argumentCount &lt; 1)
1037         return JSValueMakeUndefined(context);
1038 
1039     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1040     controller-&gt;setGeolocationPermission(JSValueToBoolean(context, arguments[0]));
1041 
1042     return JSValueMakeUndefined(context);
1043 }
1044 
1045 static JSValueRef setRejectsProtectionSpaceAndContinueForAuthenticationChallengesCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1046 {
1047     // Has mac &amp; windows implementation
1048     if (argumentCount &lt; 1)
1049         return JSValueMakeUndefined(context);
1050 
1051     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1052     controller-&gt;setRejectsProtectionSpaceAndContinueForAuthenticationChallenges(JSValueToBoolean(context, arguments[0]));
1053 
1054     return JSValueMakeUndefined(context);
1055 }
1056 
1057 static JSValueRef setHandlesAuthenticationChallengesCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1058 {
1059     // Has mac &amp; windows implementation
1060     if (argumentCount &lt; 1)
1061         return JSValueMakeUndefined(context);
1062 
1063     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1064     controller-&gt;setHandlesAuthenticationChallenges(JSValueToBoolean(context, arguments[0]));
1065 
1066     return JSValueMakeUndefined(context);
1067 }
1068 
1069 static JSValueRef setPOSIXLocaleCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1070 {
1071     if (argumentCount &lt; 1)
1072         return JSValueMakeUndefined(context);
1073 
1074     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1075     auto locale = adopt(JSValueToStringCopy(context, arguments[0], exception));
1076     ASSERT(!*exception);
1077     controller-&gt;setPOSIXLocale(locale.get());
1078 
1079     return JSValueMakeUndefined(context);
1080 }
1081 
1082 static JSValueRef setIconDatabaseEnabledCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1083 {
1084     // Has mac &amp; windows implementation
1085     if (argumentCount &lt; 1)
1086         return JSValueMakeUndefined(context);
1087 
1088     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1089     controller-&gt;setIconDatabaseEnabled(JSValueToBoolean(context, arguments[0]));
1090 
1091     return JSValueMakeUndefined(context);
1092 }
1093 
1094 static JSValueRef setMainFrameIsFirstResponderCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1095 {
1096     // Has mac implementation
1097     if (argumentCount &lt; 1)
1098         return JSValueMakeUndefined(context);
1099 
1100     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1101     controller-&gt;setMainFrameIsFirstResponder(JSValueToBoolean(context, arguments[0]));
1102 
1103     return JSValueMakeUndefined(context);
1104 }
1105 
1106 static JSValueRef setPersistentUserStyleSheetLocationCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1107 {
1108     // Has mac implementation
1109     if (argumentCount &lt; 1)
1110         return JSValueMakeUndefined(context);
1111 
1112     auto path = adopt(JSValueToStringCopy(context, arguments[0], exception));
1113     ASSERT(!*exception);
1114 
1115     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1116     controller-&gt;setPersistentUserStyleSheetLocation(path.get());
1117 
1118     return JSValueMakeUndefined(context);
1119 }
1120 
1121 static JSValueRef setPrivateBrowsingEnabledCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1122 {
1123     // Has mac &amp; windows implementation
1124     if (argumentCount &lt; 1)
1125         return JSValueMakeUndefined(context);
1126 
1127     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1128     controller-&gt;setPrivateBrowsingEnabled(JSValueToBoolean(context, arguments[0]));
1129 
1130     return JSValueMakeUndefined(context);
1131 }
1132 
1133 static JSValueRef setJavaScriptCanAccessClipboardCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1134 {
1135     // Has mac &amp; windows implementation
1136     if (argumentCount &lt; 1)
1137         return JSValueMakeUndefined(context);
1138 
1139     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1140     controller-&gt;setJavaScriptCanAccessClipboard(JSValueToBoolean(context, arguments[0]));
1141 
1142     return JSValueMakeUndefined(context);
1143 }
1144 
1145 static JSValueRef setXSSAuditorEnabledCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1146 {
1147     // Has mac &amp; windows implementation
1148     if (argumentCount &lt; 1)
1149         return JSValueMakeUndefined(context);
1150 
1151     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1152     controller-&gt;setXSSAuditorEnabled(JSValueToBoolean(context, arguments[0]));
1153 
1154     return JSValueMakeUndefined(context);
1155 }
1156 
1157 static JSValueRef setSpatialNavigationEnabledCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1158 {
1159     // Has mac &amp; windows implementation.
1160     if (argumentCount &lt; 1)
1161         return JSValueMakeUndefined(context);
1162 
1163     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1164     controller-&gt;setSpatialNavigationEnabled(JSValueToBoolean(context, arguments[0]));
1165 
1166     return JSValueMakeUndefined(context);
1167 }
1168 
1169 static JSValueRef setPrintingCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1170 {
1171     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1172     controller-&gt;setIsPrinting(true);
1173     return JSValueMakeUndefined(context);
1174 }
1175 
1176 static JSValueRef setAllowsAnySSLCertificateCallback(JSContextRef context, JSObjectRef, JSObjectRef, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1177 {
1178     bool allowAnyCertificate = false;
1179     if (argumentCount == 1)
1180         allowAnyCertificate = JSValueToBoolean(context, arguments[0]);
1181 
1182     TestRunner::setAllowsAnySSLCertificate(allowAnyCertificate);
1183     return JSValueMakeUndefined(context);
1184 }
1185 
1186 static JSValueRef setAllowUniversalAccessFromFileURLsCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1187 {
1188     // Has mac &amp; windows implementation
1189     if (argumentCount &lt; 1)
1190         return JSValueMakeUndefined(context);
1191 
1192     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1193     controller-&gt;setAllowUniversalAccessFromFileURLs(JSValueToBoolean(context, arguments[0]));
1194 
1195     return JSValueMakeUndefined(context);
1196 }
1197 
1198 static JSValueRef setAllowFileAccessFromFileURLsCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1199 {
1200     // Has mac &amp; windows implementation
1201     if (argumentCount &lt; 1)
1202         return JSValueMakeUndefined(context);
1203 
1204     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1205     controller-&gt;setAllowFileAccessFromFileURLs(JSValueToBoolean(context, arguments[0]));
1206 
1207     return JSValueMakeUndefined(context);
1208 }
1209 
1210 static JSValueRef setNeedsStorageAccessFromFileURLsQuirkCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1211 {
1212     // Has mac &amp; windows implementation
1213     if (argumentCount &lt; 1)
1214         return JSValueMakeUndefined(context);
1215 
1216     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1217     controller-&gt;setNeedsStorageAccessFromFileURLsQuirk(JSValueToBoolean(context, arguments[0]));
1218 
1219     return JSValueMakeUndefined(context);
1220 }
1221 
1222 static JSValueRef setTabKeyCyclesThroughElementsCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1223 {
1224     // Has mac &amp; windows implementation
1225     if (argumentCount &lt; 1)
1226         return JSValueMakeUndefined(context);
1227 
1228     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1229     controller-&gt;setTabKeyCyclesThroughElements(JSValueToBoolean(context, arguments[0]));
1230 
1231     return JSValueMakeUndefined(context);
1232 }
1233 
1234 #if PLATFORM(IOS_FAMILY)
1235 static JSValueRef setTelephoneNumberParsingEnabledCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1236 {
1237     if (argumentCount &lt; 1)
1238         return JSValueMakeUndefined(context);
1239 
1240     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1241     controller-&gt;setTelephoneNumberParsingEnabled(JSValueToBoolean(context, arguments[0]));
1242 
1243     return JSValueMakeUndefined(context);
1244 }
1245 
1246 static JSValueRef setPagePausedCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1247 {
1248     if (argumentCount &lt; 1)
1249         return JSValueMakeUndefined(context);
1250 
1251     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1252     controller-&gt;setPagePaused(JSValueToBoolean(context, arguments[0]));
1253 
1254     return JSValueMakeUndefined(context);
1255 }
1256 #endif
1257 
<a name="8" id="anc8"></a>











1258 static JSValueRef setUserStyleSheetEnabledCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1259 {
1260     // Has mac implementation
1261     if (argumentCount &lt; 1)
1262         return JSValueMakeUndefined(context);
1263 
1264     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1265     controller-&gt;setUserStyleSheetEnabled(JSValueToBoolean(context, arguments[0]));
1266 
1267     return JSValueMakeUndefined(context);
1268 }
1269 
1270 static JSValueRef setUserStyleSheetLocationCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1271 {
1272     // Has mac implementation
1273     if (argumentCount &lt; 1)
1274         return JSValueMakeUndefined(context);
1275 
1276     auto path = adopt(JSValueToStringCopy(context, arguments[0], exception));
1277     ASSERT(!*exception);
1278 
1279     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1280     controller-&gt;setUserStyleSheetLocation(path.get());
1281 
1282     return JSValueMakeUndefined(context);
1283 }
1284 
1285 static JSValueRef setValueForUserCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1286 {
1287     // Has mac implementation
1288     if (argumentCount != 2)
1289         return JSValueMakeUndefined(context);
1290 
1291     auto value = adopt(JSValueToStringCopy(context, arguments[1], exception));
1292     ASSERT(!*exception);
1293 
1294     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1295     controller-&gt;setValueForUser(context, arguments[0], value.get());
1296 
1297     return JSValueMakeUndefined(context);
1298 }
1299 
1300 static JSValueRef setWillSendRequestClearHeaderCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1301 {
1302     // Has mac &amp; windows implementation
1303     if (argumentCount &lt; 1)
1304         return JSValueMakeUndefined(context);
1305 
1306     auto header = adopt(JSValueToStringCopy(context, arguments[0], exception));
1307     ASSERT(!*exception);
1308 
1309     size_t maxLength = JSStringGetMaximumUTF8CStringSize(header.get());
<a name="9" id="anc9"></a><span class="line-modified">1310     auto headerBuffer = makeUniqueArray&lt;char&gt;(maxLength + 1);</span>
1311     JSStringGetUTF8CString(header.get(), headerBuffer.get(), maxLength + 1);
1312 
1313     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1314     controller-&gt;setWillSendRequestClearHeader(headerBuffer.get());
1315 
1316     return JSValueMakeUndefined(context);
1317 }
1318 
1319 static JSValueRef setWillSendRequestReturnsNullCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1320 {
1321     // Has cross-platform implementation
1322     if (argumentCount &lt; 1)
1323         return JSValueMakeUndefined(context);
1324 
1325     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1326     controller-&gt;setWillSendRequestReturnsNull(JSValueToBoolean(context, arguments[0]));
1327 
1328     return JSValueMakeUndefined(context);
1329 }
1330 
1331 static JSValueRef setWillSendRequestReturnsNullOnRedirectCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1332 {
1333     // Has cross-platform implementation
1334     if (argumentCount &lt; 1)
1335         return JSValueMakeUndefined(context);
1336 
1337     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1338     controller-&gt;setWillSendRequestReturnsNullOnRedirect(JSValueToBoolean(context, arguments[0]));
1339 
1340     return JSValueMakeUndefined(context);
1341 }
1342 
1343 static JSValueRef setWindowIsKeyCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1344 {
1345     // Has mac implementation
1346     if (argumentCount &lt; 1)
1347         return JSValueMakeUndefined(context);
1348 
1349     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1350     controller-&gt;setWindowIsKey(JSValueToBoolean(context, arguments[0]));
1351 
1352     return JSValueMakeUndefined(context);
1353 }
1354 
1355 static JSValueRef setViewSizeCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1356 {
1357     if (argumentCount &lt; 2)
1358         return JSValueMakeUndefined(context);
1359 
1360     double width = JSValueToNumber(context, arguments[0], exception);
1361     ASSERT(!*exception);
1362     double height = JSValueToNumber(context, arguments[1], exception);
1363     ASSERT(!*exception);
1364 
1365     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1366     controller-&gt;setViewSize(width, height);
1367 
1368     return JSValueMakeUndefined(context);
1369 }
1370 
1371 static JSValueRef waitUntilDoneCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1372 {
1373     // Has mac &amp; windows implementation
1374     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1375     controller-&gt;setWaitToDump(true);
1376 
1377     return JSValueMakeUndefined(context);
1378 }
1379 
1380 static JSValueRef windowCountCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1381 {
1382     // Has mac implementation
1383     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1384     int windows = controller-&gt;windowCount();
1385     return JSValueMakeNumber(context, windows);
1386 }
1387 
1388 static JSValueRef setPopupBlockingEnabledCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1389 {
1390     // Has mac &amp; windows implementation
1391     if (argumentCount &lt; 1)
1392         return JSValueMakeUndefined(context);
1393 
1394     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1395     controller-&gt;setPopupBlockingEnabled(JSValueToBoolean(context, arguments[0]));
1396 
1397     return JSValueMakeUndefined(context);
1398 }
1399 
1400 static JSValueRef setPluginsEnabledCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1401 {
1402     // Has mac &amp; windows implementation
1403     if (argumentCount &lt; 1)
1404         return JSValueMakeUndefined(context);
1405 
1406     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1407     controller-&gt;setPluginsEnabled(JSValueToBoolean(context, arguments[0]));
1408 
1409     return JSValueMakeUndefined(context);
1410 }
1411 
1412 static JSValueRef setPageVisibilityCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1413 {
1414     // Has mac &amp; windows implementation
1415     if (argumentCount &lt; 1)
1416         return JSValueMakeUndefined(context);
1417 
1418     auto visibility = adopt(JSValueToStringCopy(context, arguments[0], exception));
1419     ASSERT(!*exception);
1420 
1421     size_t maxLength = JSStringGetMaximumUTF8CStringSize(visibility.get());
1422     char* visibilityBuffer = new char[maxLength + 1];
1423     JSStringGetUTF8CString(visibility.get(), visibilityBuffer, maxLength + 1);
1424 
1425     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1426     controller-&gt;setPageVisibility(visibilityBuffer);
1427     delete[] visibilityBuffer;
1428 
1429     return JSValueMakeUndefined(context);
1430 }
1431 
1432 static JSValueRef resetPageVisibilityCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1433 {
1434     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1435     controller-&gt;resetPageVisibility();
1436     return JSValueMakeUndefined(context);
1437 }
1438 
1439 static JSValueRef setAutomaticLinkDetectionEnabledCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1440 {
1441     if (argumentCount &lt; 1)
1442         return JSValueMakeUndefined(context);
1443 
1444     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1445     controller-&gt;setAutomaticLinkDetectionEnabled(JSValueToBoolean(context, arguments[0]));
1446     return JSValueMakeUndefined(context);
1447 }
1448 
1449 static JSValueRef setStopProvisionalFrameLoadsCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1450 {
1451     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1452     controller-&gt;setStopProvisionalFrameLoads(true);
1453     return JSValueMakeUndefined(context);
1454 }
1455 
1456 static JSValueRef showWebInspectorCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1457 {
1458     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1459     controller-&gt;showWebInspector();
1460     return JSValueMakeUndefined(context);
1461 }
1462 
1463 static JSValueRef closeWebInspectorCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1464 {
1465     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1466     controller-&gt;closeWebInspector();
1467     return JSValueMakeUndefined(context);
1468 }
1469 
1470 static JSValueRef evaluateInWebInspectorCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1471 {
1472     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1473     auto script = adopt(JSValueToStringCopy(context, arguments[0], exception));
1474     ASSERT(!*exception);
1475 
1476     controller-&gt;evaluateInWebInspector(script.get());
1477     return JSValueMakeUndefined(context);
1478 }
1479 
1480 static JSValueRef evaluateScriptInIsolatedWorldCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1481 {
1482     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1483     double worldID = JSValueToNumber(context, arguments[0], exception);
1484     ASSERT(!*exception);
1485     auto script = adopt(JSValueToStringCopy(context, arguments[1], exception));
1486     ASSERT(!*exception);
1487 
1488     controller-&gt;evaluateScriptInIsolatedWorld(static_cast&lt;unsigned&gt;(worldID), JSContextGetGlobalObject(context), script.get());
1489     return JSValueMakeUndefined(context);
1490 }
1491 
1492 static JSValueRef evaluateScriptInIsolatedWorldAndReturnValueCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1493 {
1494     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1495     double worldID = JSValueToNumber(context, arguments[0], exception);
1496     ASSERT(!*exception);
1497     auto script = adopt(JSValueToStringCopy(context, arguments[1], exception));
1498     ASSERT(!*exception);
1499 
1500     controller-&gt;evaluateScriptInIsolatedWorldAndReturnValue(static_cast&lt;unsigned&gt;(worldID), JSContextGetGlobalObject(context), script.get());
1501     return JSValueMakeUndefined(context);
1502 }
1503 
1504 static JSValueRef waitForPolicyDelegateCallback(JSContextRef context, JSObjectRef, JSObjectRef thisObject, size_t, const JSValueRef[], JSValueRef*)
1505 {
1506     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1507     controller-&gt;waitForPolicyDelegate();
1508     return JSValueMakeUndefined(context);
1509 }
1510 
1511 static JSValueRef addOriginAccessWhitelistEntryCallback(JSContextRef context, JSObjectRef, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1512 {
1513     if (argumentCount != 4)
1514         return JSValueMakeUndefined(context);
1515 
1516     auto sourceOrigin = adopt(JSValueToStringCopy(context, arguments[0], exception));
1517     ASSERT(!*exception);
1518     auto destinationProtocol = adopt(JSValueToStringCopy(context, arguments[1], exception));
1519     ASSERT(!*exception);
1520     auto destinationHost = adopt(JSValueToStringCopy(context, arguments[2], exception));
1521     ASSERT(!*exception);
1522     bool allowDestinationSubdomains = JSValueToBoolean(context, arguments[3]);
1523 
1524     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1525     controller-&gt;addOriginAccessWhitelistEntry(sourceOrigin.get(), destinationProtocol.get(), destinationHost.get(), allowDestinationSubdomains);
1526     return JSValueMakeUndefined(context);
1527 }
1528 
1529 static JSValueRef removeOriginAccessWhitelistEntryCallback(JSContextRef context, JSObjectRef, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1530 {
1531     if (argumentCount != 4)
1532         return JSValueMakeUndefined(context);
1533 
1534     auto sourceOrigin = adopt(JSValueToStringCopy(context, arguments[0], exception));
1535     ASSERT(!*exception);
1536     auto destinationProtocol = adopt(JSValueToStringCopy(context, arguments[1], exception));
1537     ASSERT(!*exception);
1538     auto destinationHost = adopt(JSValueToStringCopy(context, arguments[2], exception));
1539     ASSERT(!*exception);
1540     bool allowDestinationSubdomains = JSValueToBoolean(context, arguments[3]);
1541 
1542     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1543     controller-&gt;removeOriginAccessWhitelistEntry(sourceOrigin.get(), destinationProtocol.get(), destinationHost.get(), allowDestinationSubdomains);
1544     return JSValueMakeUndefined(context);
1545 }
1546 
1547 static JSValueRef setScrollbarPolicyCallback(JSContextRef context, JSObjectRef, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1548 {
1549     if (argumentCount != 2)
1550         return JSValueMakeUndefined(context);
1551 
1552     auto orientation = adopt(JSValueToStringCopy(context, arguments[0], exception));
1553     ASSERT(!*exception);
1554     auto policy = adopt(JSValueToStringCopy(context, arguments[1], exception));
1555     ASSERT(!*exception);
1556 
1557     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1558     controller-&gt;setScrollbarPolicy(orientation.get(), policy.get());
1559     return JSValueMakeUndefined(context);
1560 }
1561 
1562 static JSValueRef addUserScriptCallback(JSContextRef context, JSObjectRef, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1563 {
1564     if (argumentCount != 3)
1565         return JSValueMakeUndefined(context);
1566 
1567     auto source = adopt(JSValueToStringCopy(context, arguments[0], exception));
1568     ASSERT(!*exception);
1569     bool runAtStart = JSValueToBoolean(context, arguments[1]);
1570     bool allFrames = JSValueToBoolean(context, arguments[2]);
1571 
1572     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1573     controller-&gt;addUserScript(source.get(), runAtStart, allFrames);
1574     return JSValueMakeUndefined(context);
1575 }
1576 
1577 static JSValueRef addUserStyleSheetCallback(JSContextRef context, JSObjectRef, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1578 {
1579     if (argumentCount != 2)
1580         return JSValueMakeUndefined(context);
1581 
1582     auto source = adopt(JSValueToStringCopy(context, arguments[0], exception));
1583     ASSERT(!*exception);
1584     bool allFrames = JSValueToBoolean(context, arguments[1]);
1585 
1586     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1587     controller-&gt;addUserStyleSheet(source.get(), allFrames);
1588     return JSValueMakeUndefined(context);
1589 }
1590 
1591 static JSValueRef setShouldPaintBrokenImageCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1592 {
1593     // Has Mac implementation
1594     if (argumentCount &lt; 1)
1595         return JSValueMakeUndefined(context);
1596 
1597     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1598     controller-&gt;setShouldPaintBrokenImage(JSValueToBoolean(context, arguments[0]));
1599 
1600     return JSValueMakeUndefined(context);
1601 }
1602 
1603 static JSValueRef apiTestNewWindowDataLoadBaseURLCallback(JSContextRef context, JSObjectRef, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1604 {
1605     if (argumentCount != 2)
1606         return JSValueMakeUndefined(context);
1607 
1608     auto utf8Data = adopt(JSValueToStringCopy(context, arguments[0], exception));
1609     ASSERT(!*exception);
1610 
1611     auto baseURL = adopt(JSValueToStringCopy(context, arguments[1], exception));
1612     ASSERT(!*exception);
1613 
1614     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1615     controller-&gt;apiTestNewWindowDataLoadBaseURL(utf8Data.get(), baseURL.get());
1616     return JSValueMakeUndefined(context);
1617 }
1618 
1619 static JSValueRef apiTestGoToCurrentBackForwardItemCallback(JSContextRef context, JSObjectRef, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1620 {
1621     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1622     controller-&gt;apiTestGoToCurrentBackForwardItem();
1623     return JSValueMakeUndefined(context);
1624 }
1625 
1626 static JSValueRef setWebViewEditableCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1627 {
1628     // Has Mac implementation
1629     if (argumentCount &lt; 1)
1630         return JSValueMakeUndefined(context);
1631 
1632     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1633     controller-&gt;setWebViewEditable(JSValueToBoolean(context, arguments[0]));
1634 
1635     return JSValueMakeUndefined(context);
1636 }
1637 
1638 static JSValueRef abortModalCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1639 {
1640     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1641     controller-&gt;abortModal();
1642     return JSValueMakeUndefined(context);
1643 }
1644 
1645 static JSValueRef authenticateSessionCallback(JSContextRef context, JSObjectRef, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1646 {
1647     // authenticateSession(url, username, password)
1648     if (argumentCount != 3)
1649         return JSValueMakeUndefined(context);
1650 
1651     auto url = adopt(JSValueToStringCopy(context, arguments[0], exception));
1652     ASSERT(!*exception);
1653     auto username = adopt(JSValueToStringCopy(context, arguments[1], exception));
1654     ASSERT(!*exception);
1655     auto password = adopt(JSValueToStringCopy(context, arguments[2], exception));
1656     ASSERT(!*exception);
1657 
1658     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1659     controller-&gt;authenticateSession(url.get(), username.get(), password.get());
1660     return JSValueMakeUndefined(context);
1661 }
1662 
1663 static JSValueRef setSerializeHTTPLoadsCallback(JSContextRef context, JSObjectRef, JSObjectRef, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1664 {
1665     bool serialize = true;
1666     if (argumentCount == 1)
1667         serialize = JSValueToBoolean(context, arguments[0]);
1668 
1669     TestRunner::setSerializeHTTPLoads(serialize);
1670     return JSValueMakeUndefined(context);
1671 }
1672 
1673 static JSValueRef setShouldStayOnPageAfterHandlingBeforeUnloadCallback(JSContextRef context, JSObjectRef, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1674 {
1675     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1676 
1677     if (argumentCount == 1)
1678         controller-&gt;setShouldStayOnPageAfterHandlingBeforeUnload(JSValueToBoolean(context, arguments[0]));
1679 
1680     return JSValueMakeUndefined(context);
1681 }
1682 
1683 static JSValueRef addChromeInputFieldCallback(JSContextRef context, JSObjectRef, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1684 {
1685     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1686     controller-&gt;addChromeInputField();
1687     // the first argument is a callback that is called once the input field has been added
1688     if (argumentCount == 1)
1689         JSObjectCallAsFunction(context, JSValueToObject(context, arguments[0], 0), thisObject, 0, 0, 0);
1690     return JSValueMakeUndefined(context);
1691 }
1692 
1693 static JSValueRef removeChromeInputFieldCallback(JSContextRef context, JSObjectRef, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1694 {
1695     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1696     controller-&gt;removeChromeInputField();
1697     // the first argument is a callback that is called once the input field has been added
1698     if (argumentCount == 1)
1699         JSObjectCallAsFunction(context, JSValueToObject(context, arguments[0], 0), thisObject, 0, 0, 0);
1700     return JSValueMakeUndefined(context);
1701 }
1702 
1703 static JSValueRef focusWebViewCallback(JSContextRef context, JSObjectRef, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1704 {
1705     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1706     controller-&gt;focusWebView();
1707     // the first argument is a callback that is called once the input field has been added
1708     if (argumentCount == 1)
1709         JSObjectCallAsFunction(context, JSValueToObject(context, arguments[0], 0), thisObject, 0, 0, 0);
1710     return JSValueMakeUndefined(context);
1711 }
1712 
1713 static JSValueRef setBackingScaleFactorCallback(JSContextRef context, JSObjectRef, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1714 {
1715     if (argumentCount != 2)
1716         return JSValueMakeUndefined(context);
1717 
1718     double backingScaleFactor = JSValueToNumber(context, arguments[0], exception);
1719     ASSERT(!*exception);
1720 
1721     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1722     controller-&gt;setBackingScaleFactor(backingScaleFactor);
1723 
1724     // The second argument is a callback that is called once the backing scale factor has been set.
1725     JSObjectCallAsFunction(context, JSValueToObject(context, arguments[1], 0), thisObject, 0, 0, 0);
1726     return JSValueMakeUndefined(context);
1727 }
1728 
1729 static JSValueRef preciseTimeCallback(JSContextRef context, JSObjectRef, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1730 {
1731     return JSValueMakeNumber(context, WallTime::now().secondsSinceEpoch().seconds());
1732 }
1733 
1734 static JSValueRef imageCountInGeneralPasteboardCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1735 {
1736     // Has mac &amp; windows implementation
1737     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1738 
1739     return JSValueMakeNumber(context, controller-&gt;imageCountInGeneralPasteboard());
1740 }
1741 
1742 static JSValueRef setSpellCheckerLoggingEnabledCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1743 {
1744     if (argumentCount &lt; 1)
1745         return JSValueMakeUndefined(context);
1746     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1747     controller-&gt;setSpellCheckerLoggingEnabled(JSValueToBoolean(context, arguments[0]));
1748     return JSValueMakeUndefined(context);
1749 }
1750 
1751 static JSValueRef setSpellCheckerResultsCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1752 {
1753     if (argumentCount &lt; 1)
1754         return JSValueMakeUndefined(context);
1755 
1756     auto* runner = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1757     runner-&gt;setSpellCheckerResults(context, JSValueToObject(context, arguments[0], nullptr));
1758     return JSValueMakeUndefined(context);
1759 }
1760 
1761 static JSValueRef setOpenPanelFilesCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1762 {
1763     if (argumentCount == 1)
1764         static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject))-&gt;setOpenPanelFiles(context, arguments[0]);
1765     return JSValueMakeUndefined(context);
1766 }
1767 
<a name="10" id="anc10"></a><span class="line-added">1768 #if PLATFORM(IOS_FAMILY)</span>
<span class="line-added">1769 static JSValueRef SetOpenPanelFilesMediaIconCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)</span>
<span class="line-added">1770 {</span>
<span class="line-added">1771     if (argumentCount == 1)</span>
<span class="line-added">1772         static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject))-&gt;setOpenPanelFilesMediaIcon(context, arguments[0]);</span>
<span class="line-added">1773     return JSValueMakeUndefined(context);</span>
<span class="line-added">1774 }</span>
<span class="line-added">1775 #endif</span>
<span class="line-added">1776 </span>
1777 // Static Values
1778 
1779 static JSValueRef getTimeoutCallback(JSContextRef context, JSObjectRef thisObject, JSStringRef propertyName, JSValueRef* exception)
1780 {
1781     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1782     return JSValueMakeNumber(context, controller-&gt;timeout());
1783 }
1784 
1785 static JSValueRef getGlobalFlagCallback(JSContextRef context, JSObjectRef thisObject, JSStringRef propertyName, JSValueRef* exception)
1786 {
1787     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1788     return JSValueMakeBoolean(context, controller-&gt;globalFlag());
1789 }
1790 
1791 static JSValueRef getDidCancelClientRedirect(JSContextRef context, JSObjectRef thisObject, JSStringRef propertyName, JSValueRef* exception)
1792 {
1793     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1794     return JSValueMakeBoolean(context, controller-&gt;didCancelClientRedirect());
1795 }
1796 
1797 static JSValueRef getDatabaseDefaultQuotaCallback(JSContextRef context, JSObjectRef thisObject, JSStringRef propertyName, JSValueRef* exception)
1798 {
1799     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1800     return JSValueMakeNumber(context, controller-&gt;databaseDefaultQuota());
1801 }
1802 
1803 static JSValueRef getDatabaseMaxQuotaCallback(JSContextRef context, JSObjectRef thisObject, JSStringRef propertyName, JSValueRef* exception)
1804 {
1805     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1806     return JSValueMakeNumber(context, controller-&gt;databaseMaxQuota());
1807 }
1808 
1809 static JSValueRef getWebHistoryItemCountCallback(JSContextRef context, JSObjectRef thisObject, JSStringRef propertyName, JSValueRef* exception)
1810 {
1811     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1812     return JSValueMakeNumber(context, controller-&gt;webHistoryItemCount());
1813 }
1814 
1815 static JSValueRef getSecureEventInputIsEnabledCallback(JSContextRef context, JSObjectRef thisObject, JSStringRef propertyName, JSValueRef* exception)
1816 {
1817 #if PLATFORM(MAC) &amp;&amp; !PLATFORM(IOS_FAMILY)
1818     return JSValueMakeBoolean(context, IsSecureEventInputEnabled());
1819 #else
1820     return JSValueMakeBoolean(context, false);
1821 #endif
1822 }
1823 
1824 static JSValueRef getTitleTextDirectionCallback(JSContextRef context, JSObjectRef thisObject, JSStringRef propertyName, JSValueRef* exception)
1825 {
1826     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1827     auto titleDirection = adopt(JSStringCreateWithUTF8CString(controller-&gt;titleTextDirection().c_str()));
1828     return JSValueMakeString(context, titleDirection.get());
1829 }
1830 
1831 static JSValueRef getInspectorTestStubURLCallback(JSContextRef context, JSObjectRef thisObject, JSStringRef propertyName, JSValueRef* exception)
1832 {
1833     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1834     auto url = controller-&gt;inspectorTestStubURL();
1835     return JSValueMakeString(context, url.get());
1836 }
1837 
1838 static bool setGlobalFlagCallback(JSContextRef context, JSObjectRef thisObject, JSStringRef propertyName, JSValueRef value, JSValueRef* exception)
1839 {
1840     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1841     controller-&gt;setGlobalFlag(JSValueToBoolean(context, value));
1842     return true;
1843 }
1844 
1845 static bool setDatabaseDefaultQuotaCallback(JSContextRef context, JSObjectRef thisObject, JSStringRef propertyName, JSValueRef value, JSValueRef* exception)
1846 {
1847     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1848     controller-&gt;setDatabaseDefaultQuota(JSValueToNumber(context, value, exception));
1849     ASSERT(!*exception);
1850     return true;
1851 }
1852 
1853 static bool setDatabaseMaxQuotaCallback(JSContextRef context, JSObjectRef thisObject, JSStringRef propertyName, JSValueRef value, JSValueRef* exception)
1854 {
1855     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1856     controller-&gt;setDatabaseMaxQuota(JSValueToNumber(context, value, exception));
1857     ASSERT(!*exception);
1858     return true;
1859 }
1860 
1861 static JSValueRef ignoreLegacyWebNotificationPermissionRequestsCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1862 {
1863     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1864     controller-&gt;ignoreLegacyWebNotificationPermissionRequests();
1865     return JSValueMakeUndefined(context);
1866 }
1867 
1868 static JSValueRef simulateLegacyWebNotificationClickCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1869 {
1870     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1871     auto title = adopt(JSValueToStringCopy(context, arguments[0], exception));
1872     controller-&gt;simulateLegacyWebNotificationClick(title.get());
1873     return JSValueMakeUndefined(context);
1874 }
1875 
1876 static JSValueRef setTextDirectionCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1877 {
1878     if (argumentCount == 1) {
1879         auto direction = adopt(JSValueToStringCopy(context, arguments[0], exception));
1880         TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1881         controller-&gt;setTextDirection(direction.get());
1882     }
1883 
1884     return JSValueMakeUndefined(context);
1885 
1886 }
1887 
1888 static JSValueRef setHasCustomFullScreenBehaviorCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1889 {
1890     if (argumentCount == 1) {
1891         bool hasCustomBehavior = JSValueToBoolean(context, arguments[0]);
1892         TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1893         controller-&gt;setHasCustomFullScreenBehavior(hasCustomBehavior);
1894     }
1895 
1896     return JSValueMakeUndefined(context);
1897 }
1898 
1899 static JSValueRef setStorageDatabaseIdleIntervalCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1900 {
1901     if (argumentCount != 1)
1902         return JSValueMakeUndefined(context);
1903 
1904     double interval = JSValueToNumber(context, arguments[0], exception);
1905     ASSERT(!*exception);
1906 
1907     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1908     controller-&gt;setStorageDatabaseIdleInterval(interval);
1909 
1910     return JSValueMakeUndefined(context);
1911 }
1912 
1913 static JSValueRef closeIdleLocalStorageDatabasesCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1914 {
1915     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1916     controller-&gt;closeIdleLocalStorageDatabases();
1917 
1918     return JSValueMakeUndefined(context);
1919 }
1920 
1921 static JSValueRef grantWebNotificationPermissionCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1922 {
1923     if (argumentCount &lt; 1)
1924         return JSValueMakeUndefined(context);
1925 
1926     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1927 
1928     auto origin = adopt(JSValueToStringCopy(context, arguments[0], exception));
1929     ASSERT(!*exception);
1930     controller-&gt;grantWebNotificationPermission(origin.get());
1931 
1932     return JSValueMakeUndefined(context);
1933 }
1934 
1935 
1936 static JSValueRef denyWebNotificationPermissionCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1937 {
1938     if (argumentCount &lt; 1)
1939         return JSValueMakeUndefined(context);
1940 
1941     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1942 
1943     auto origin = adopt(JSValueToStringCopy(context, arguments[0], exception));
1944     ASSERT(!*exception);
1945     controller-&gt;denyWebNotificationPermission(origin.get());
1946 
1947     return JSValueMakeUndefined(context);
1948 }
1949 
1950 
1951 static JSValueRef removeAllWebNotificationPermissionsCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1952 {
1953     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1954 
1955     controller-&gt;removeAllWebNotificationPermissions();
1956 
1957     return JSValueMakeUndefined(context);
1958 }
1959 
1960 
1961 static JSValueRef simulateWebNotificationClickCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1962 {
1963     // Has Windows implementation
1964     if (argumentCount &lt; 1)
1965         return JSValueMakeUndefined(context);
1966 
1967     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1968 
1969     controller-&gt;simulateWebNotificationClick(arguments[0]);
1970 
1971     return JSValueMakeUndefined(context);
1972 }
1973 
1974 static JSValueRef forceImmediateCompletionCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1975 {
1976     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1977     controller-&gt;forceImmediateCompletion();
1978     return JSValueMakeUndefined(context);
1979 }
1980 
1981 static JSValueRef failNextNewCodeBlock(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1982 {
1983     if (argumentCount &lt; 1)
1984         return JSValueMakeUndefined(context);
1985 
1986     return JSC::failNextNewCodeBlock(context);
1987 }
1988 
1989 static JSValueRef numberOfDFGCompiles(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1990 {
1991     return JSC::numberOfDFGCompiles(context, arguments[0]);
1992 }
1993 
1994 static JSValueRef neverInlineFunction(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1995 {
1996     if (argumentCount &lt; 1)
1997         return JSValueMakeUndefined(context);
1998 
1999     return JSC::setNeverInline(context, arguments[0]);
2000 }
2001 
2002 static JSValueRef accummulateLogsForChannel(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
2003 {
2004     if (argumentCount &lt; 1)
2005         return JSValueMakeUndefined(context);
2006 
2007     auto channel = adopt(JSValueToStringCopy(context, arguments[0], exception));
2008     ASSERT(!*exception);
2009 
2010     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
<a name="11" id="anc11"></a><span class="line-added">2011 #if OS(WINDOWS) &amp;&amp; PLATFORM(JAVA)</span>
<span class="line-added">2012     // FIXME : error LNK2019: unresolved external symbol</span>
<span class="line-added">2013     // controller-&gt;setAccummulateLogsForChannel(channel.get());</span>
<span class="line-added">2014 #else</span>
2015     controller-&gt;setAccummulateLogsForChannel(channel.get());
<a name="12" id="anc12"></a><span class="line-modified">2016 #endif</span>
2017     return JSValueMakeUndefined(context);
2018 }
2019 
2020 static JSValueRef runUIScriptCallback(JSContextRef context, JSObjectRef, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
2021 {
2022     if (argumentCount &lt; 1)
2023         return JSValueMakeUndefined(context);
2024 
2025     auto script = argumentCount &gt; 0 ? adopt(JSValueToStringCopy(context, arguments[0], 0)) : JSRetainPtr&lt;JSStringRef&gt;();
2026     JSValueRef callback = argumentCount &gt; 1 ? arguments[1] : JSValueMakeUndefined(context);
2027 
2028     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
2029     controller-&gt;runUIScript(context, script.get(), callback);
2030 
2031     return JSValueMakeUndefined(context);
2032 }
2033 
2034 static void testRunnerObjectFinalize(JSObjectRef object)
2035 {
2036     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(object));
2037     controller-&gt;deref();
2038 }
2039 
2040 // Object Creation
2041 
2042 void TestRunner::makeWindowObject(JSContextRef context, JSObjectRef windowObject, JSValueRef* exception)
2043 {
2044     auto testRunnerStr = adopt(JSStringCreateWithUTF8CString(&quot;testRunner&quot;));
2045     ref();
2046 
2047     JSClassRef classRef = getJSClass();
2048     JSValueRef layoutTestContollerObject = JSObjectMake(context, classRef, this);
2049     JSClassRelease(classRef);
2050 
2051     JSObjectSetProperty(context, windowObject, testRunnerStr.get(), layoutTestContollerObject, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete, exception);
2052 }
2053 
2054 JSClassRef TestRunner::getJSClass()
2055 {
2056     static JSStaticValue* staticValues = TestRunner::staticValues();
2057     static JSStaticFunction* staticFunctions = TestRunner::staticFunctions();
2058     static JSClassDefinition classDefinition = {
2059         0, kJSClassAttributeNone, &quot;TestRunner&quot;, 0, staticValues, staticFunctions,
2060         0, testRunnerObjectFinalize, 0, 0, 0, 0, 0, 0, 0, 0, 0
2061     };
2062 
2063     return JSClassCreate(&amp;classDefinition);
2064 }
2065 
<a name="13" id="anc13"></a><span class="line-added">2066 // Constants</span>
<span class="line-added">2067 </span>
<span class="line-added">2068 static JSValueRef getRENDER_TREE_SHOW_ALL_LAYERS(JSContextRef context, JSObjectRef, JSStringRef, JSValueRef*)</span>
<span class="line-added">2069 {</span>
<span class="line-added">2070     return JSValueMakeNumber(context, 1);</span>
<span class="line-added">2071 }</span>
<span class="line-added">2072 </span>
<span class="line-added">2073 static JSValueRef getRENDER_TREE_SHOW_LAYER_NESTING(JSContextRef context, JSObjectRef, JSStringRef, JSValueRef*)</span>
<span class="line-added">2074 {</span>
<span class="line-added">2075     return JSValueMakeNumber(context, 2);</span>
<span class="line-added">2076 }</span>
<span class="line-added">2077 </span>
<span class="line-added">2078 static JSValueRef getRENDER_TREE_SHOW_COMPOSITED_LAYERS(JSContextRef context, JSObjectRef, JSStringRef, JSValueRef*)</span>
<span class="line-added">2079 {</span>
<span class="line-added">2080     return JSValueMakeNumber(context, 4);</span>
<span class="line-added">2081 }</span>
<span class="line-added">2082 </span>
<span class="line-added">2083 static JSValueRef getRENDER_TREE_SHOW_OVERFLOW(JSContextRef context, JSObjectRef, JSStringRef, JSValueRef*)</span>
<span class="line-added">2084 {</span>
<span class="line-added">2085     return JSValueMakeNumber(context, 8);</span>
<span class="line-added">2086 }</span>
<span class="line-added">2087 </span>
<span class="line-added">2088 static JSValueRef getRENDER_TREE_SHOW_SVG_GEOMETRY(JSContextRef context, JSObjectRef, JSStringRef, JSValueRef*)</span>
<span class="line-added">2089 {</span>
<span class="line-added">2090     return JSValueMakeNumber(context, 16);</span>
<span class="line-added">2091 }</span>
<span class="line-added">2092 </span>
<span class="line-added">2093 static JSValueRef getRENDER_TREE_SHOW_LAYER_FRAGMENTS(JSContextRef context, JSObjectRef, JSStringRef, JSValueRef*)</span>
<span class="line-added">2094 {</span>
<span class="line-added">2095     return JSValueMakeNumber(context, 32);</span>
<span class="line-added">2096 }</span>
<span class="line-added">2097 </span>
2098 JSStaticValue* TestRunner::staticValues()
2099 {
2100     static JSStaticValue staticValues[] = {
2101         { &quot;didCancelClientRedirect&quot;, getDidCancelClientRedirect, 0, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2102         { &quot;timeout&quot;, getTimeoutCallback, 0, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2103         { &quot;globalFlag&quot;, getGlobalFlagCallback, setGlobalFlagCallback, kJSPropertyAttributeNone },
2104         { &quot;webHistoryItemCount&quot;, getWebHistoryItemCountCallback, 0, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2105         { &quot;secureEventInputIsEnabled&quot;, getSecureEventInputIsEnabledCallback, 0, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2106         { &quot;titleTextDirection&quot;, getTitleTextDirectionCallback, 0, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2107         { &quot;databaseDefaultQuota&quot;, getDatabaseDefaultQuotaCallback, setDatabaseDefaultQuotaCallback, kJSPropertyAttributeNone },
2108         { &quot;databaseMaxQuota&quot;, getDatabaseMaxQuotaCallback, setDatabaseMaxQuotaCallback, kJSPropertyAttributeNone },
2109         { &quot;inspectorTestStubURL&quot;, getInspectorTestStubURLCallback, 0, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
<a name="14" id="anc14"></a><span class="line-added">2110         { &quot;RENDER_TREE_SHOW_ALL_LAYERS&quot;, getRENDER_TREE_SHOW_ALL_LAYERS, 0, kJSPropertyAttributeDontDelete | kJSPropertyAttributeReadOnly },</span>
<span class="line-added">2111         { &quot;RENDER_TREE_SHOW_LAYER_NESTING&quot;, getRENDER_TREE_SHOW_LAYER_NESTING, 0, kJSPropertyAttributeDontDelete | kJSPropertyAttributeReadOnly },</span>
<span class="line-added">2112         { &quot;RENDER_TREE_SHOW_COMPOSITED_LAYERS&quot;, getRENDER_TREE_SHOW_COMPOSITED_LAYERS, 0, kJSPropertyAttributeDontDelete | kJSPropertyAttributeReadOnly },</span>
<span class="line-added">2113         { &quot;RENDER_TREE_SHOW_OVERFLOW&quot;, getRENDER_TREE_SHOW_OVERFLOW, 0, kJSPropertyAttributeDontDelete | kJSPropertyAttributeReadOnly },</span>
<span class="line-added">2114         { &quot;RENDER_TREE_SHOW_SVG_GEOMETRY&quot;, getRENDER_TREE_SHOW_SVG_GEOMETRY, 0, kJSPropertyAttributeDontDelete | kJSPropertyAttributeReadOnly },</span>
<span class="line-added">2115         { &quot;RENDER_TREE_SHOW_LAYER_FRAGMENTS&quot;, getRENDER_TREE_SHOW_LAYER_FRAGMENTS, 0, kJSPropertyAttributeDontDelete | kJSPropertyAttributeReadOnly },</span>
2116         { 0, 0, 0, 0 }
2117     };
2118     return staticValues;
2119 }
2120 
2121 JSStaticFunction* TestRunner::staticFunctions()
2122 {
2123     static JSStaticFunction staticFunctions[] = {
2124         { &quot;abortModal&quot;, abortModalCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2125         { &quot;addDisallowedURL&quot;, addDisallowedURLCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2126         { &quot;addURLToRedirect&quot;, addURLToRedirectCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2127         { &quot;addUserScript&quot;, addUserScriptCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2128         { &quot;addUserStyleSheet&quot;, addUserStyleSheetCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2129         { &quot;apiTestNewWindowDataLoadBaseURL&quot;, apiTestNewWindowDataLoadBaseURLCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2130         { &quot;apiTestGoToCurrentBackForwardItem&quot;, apiTestGoToCurrentBackForwardItemCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2131         { &quot;applicationCacheDiskUsageForOrigin&quot;, applicationCacheDiskUsageForOriginCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2132         { &quot;callShouldCloseOnWebView&quot;, callShouldCloseOnWebViewCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2133         { &quot;clearAllApplicationCaches&quot;, clearAllApplicationCachesCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2134         { &quot;clearAllDatabases&quot;, clearAllDatabasesCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2135         { &quot;clearApplicationCacheForOrigin&quot;, clearApplicationCacheForOriginCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2136         { &quot;clearBackForwardList&quot;, clearBackForwardListCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2137         { &quot;clearPersistentUserStyleSheet&quot;, clearPersistentUserStyleSheetCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2138         { &quot;closeWebInspector&quot;, closeWebInspectorCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2139         { &quot;decodeHostName&quot;, decodeHostNameCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2140         { &quot;disallowIncreaseForApplicationCacheQuota&quot;, disallowIncreaseForApplicationCacheQuotaCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2141         { &quot;dispatchPendingLoadRequests&quot;, dispatchPendingLoadRequestsCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2142         { &quot;display&quot;, displayCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2143         { &quot;displayAndTrackRepaints&quot;, displayAndTrackRepaintsCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2144         { &quot;dumpApplicationCacheDelegateCallbacks&quot;, dumpApplicationCacheDelegateCallbacksCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
<a name="15" id="anc15"></a><span class="line-added">2145         { &quot;setRenderTreeDumpOptions&quot;, setRenderTreeDumpOptionsCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },</span>
2146         { &quot;dumpAsText&quot;, dumpAsTextCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2147         { &quot;dumpBackForwardList&quot;, dumpBackForwardListCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2148         { &quot;dumpChildFrameScrollPositions&quot;, dumpChildFrameScrollPositionsCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2149         { &quot;dumpChildFramesAsText&quot;, dumpChildFramesAsTextCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2150         { &quot;dumpDOMAsWebArchive&quot;, dumpDOMAsWebArchiveCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2151         { &quot;dumpDatabaseCallbacks&quot;, dumpDatabaseCallbacksCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2152         { &quot;dumpEditingCallbacks&quot;, dumpEditingCallbacksCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2153         { &quot;dumpFrameLoadCallbacks&quot;, dumpFrameLoadCallbacksCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2154         { &quot;dumpProgressFinishedCallback&quot;, dumpProgressFinishedCallbackCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2155         { &quot;dumpUserGestureInFrameLoadCallbacks&quot;, dumpUserGestureInFrameLoadCallbacksCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2156         { &quot;dumpResourceLoadCallbacks&quot;, dumpResourceLoadCallbacksCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2157         { &quot;dumpResourceResponseMIMETypes&quot;, dumpResourceResponseMIMETypesCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2158         { &quot;dumpSelectionRect&quot;, dumpSelectionRectCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2159         { &quot;dumpSourceAsWebArchive&quot;, dumpSourceAsWebArchiveCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2160         { &quot;dumpStatusCallbacks&quot;, dumpStatusCallbacksCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2161         { &quot;dumpTitleChanges&quot;, dumpTitleChangesCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2162         { &quot;dumpWillCacheResponse&quot;, dumpWillCacheResponseCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2163         { &quot;encodeHostName&quot;, encodeHostNameCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2164         { &quot;evaluateInWebInspector&quot;, evaluateInWebInspectorCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2165         { &quot;evaluateScriptInIsolatedWorldAndReturnValue&quot;, evaluateScriptInIsolatedWorldAndReturnValueCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2166         { &quot;evaluateScriptInIsolatedWorld&quot;, evaluateScriptInIsolatedWorldCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2167         { &quot;execCommand&quot;, execCommandCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2168         { &quot;findString&quot;, findStringCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2169         { &quot;originsWithApplicationCache&quot;, originsWithApplicationCacheCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2170         { &quot;goBack&quot;, goBackCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2171         { &quot;ignoreLegacyWebNotificationPermissionRequests&quot;, ignoreLegacyWebNotificationPermissionRequestsCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2172         { &quot;isGeolocationProviderActive&quot;, isGeolocationProviderActiveCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2173         { &quot;isCommandEnabled&quot;, isCommandEnabledCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2174         { &quot;keepWebHistory&quot;, keepWebHistoryCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2175         { &quot;numberOfPendingGeolocationPermissionRequests&quot;, numberOfPendingGeolocationPermissionRequestsCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2176         { &quot;notifyDone&quot;, notifyDoneCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2177         { &quot;overridePreference&quot;, overridePreferenceCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2178         { &quot;pathToLocalResource&quot;, pathToLocalResourceCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2179         { &quot;printToPDF&quot;, dumpAsPDFCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2180         { &quot;queueBackNavigation&quot;, queueBackNavigationCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2181         { &quot;queueForwardNavigation&quot;, queueForwardNavigationCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2182         { &quot;queueLoad&quot;, queueLoadCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2183         { &quot;queueLoadHTMLString&quot;, queueLoadHTMLStringCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2184         { &quot;queueLoadingScript&quot;, queueLoadingScriptCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2185         { &quot;queueNonLoadingScript&quot;, queueNonLoadingScriptCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2186         { &quot;queueReload&quot;, queueReloadCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2187         { &quot;removeAllVisitedLinks&quot;, removeAllVisitedLinksCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2188         { &quot;removeOriginAccessWhitelistEntry&quot;, removeOriginAccessWhitelistEntryCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2189         { &quot;repaintSweepHorizontally&quot;, repaintSweepHorizontallyCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2190         { &quot;resetPageVisibility&quot;, resetPageVisibilityCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2191         { &quot;setAcceptsEditing&quot;, setAcceptsEditingCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2192         { &quot;setAllowUniversalAccessFromFileURLs&quot;, setAllowUniversalAccessFromFileURLsCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2193         { &quot;setAllowFileAccessFromFileURLs&quot;, setAllowFileAccessFromFileURLsCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2194         { &quot;setNeedsStorageAccessFromFileURLsQuirk&quot;, setNeedsStorageAccessFromFileURLsQuirkCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2195         { &quot;setAllowsAnySSLCertificate&quot;, setAllowsAnySSLCertificateCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2196         { &quot;setAlwaysAcceptCookies&quot;, setAlwaysAcceptCookiesCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2197         { &quot;setOnlyAcceptFirstPartyCookies&quot;, setOnlyAcceptFirstPartyCookiesCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2198         { &quot;setAppCacheMaximumSize&quot;, setAppCacheMaximumSizeCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2199         { &quot;setAudioResult&quot;, setAudioResultCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2200         { &quot;setAuthenticationPassword&quot;, setAuthenticationPasswordCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2201         { &quot;setAuthenticationUsername&quot;, setAuthenticationUsernameCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2202         { &quot;setAuthorAndUserStylesEnabled&quot;, setAuthorAndUserStylesEnabledCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2203         { &quot;setCacheModel&quot;, setCacheModelCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2204         { &quot;setCallCloseOnWebViews&quot;, setCallCloseOnWebViewsCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2205         { &quot;setCanOpenWindows&quot;, setCanOpenWindowsCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2206         { &quot;setCloseRemainingWindowsWhenComplete&quot;, setCloseRemainingWindowsWhenCompleteCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2207         { &quot;setCustomPolicyDelegate&quot;, setCustomPolicyDelegateCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2208         { &quot;setDatabaseQuota&quot;, setDatabaseQuotaCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2209         { &quot;setDefersLoading&quot;, setDefersLoadingCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2210         { &quot;setUseDeferredFrameLoading&quot;, setUseDeferredFrameLoadingCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2211         { &quot;setDomainRelaxationForbiddenForURLScheme&quot;, setDomainRelaxationForbiddenForURLSchemeCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2212         { &quot;setGeolocationPermission&quot;, setGeolocationPermissionCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2213         { &quot;setRejectsProtectionSpaceAndContinueForAuthenticationChallenges&quot;, setRejectsProtectionSpaceAndContinueForAuthenticationChallengesCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2214         { &quot;setHandlesAuthenticationChallenges&quot;, setHandlesAuthenticationChallengesCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2215         { &quot;setIconDatabaseEnabled&quot;, setIconDatabaseEnabledCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
<a name="16" id="anc16"></a>
2216         { &quot;setAutomaticLinkDetectionEnabled&quot;, setAutomaticLinkDetectionEnabledCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2217         { &quot;setMainFrameIsFirstResponder&quot;, setMainFrameIsFirstResponderCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2218         { &quot;setMockDeviceOrientation&quot;, setMockDeviceOrientationCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2219         { &quot;setMockGeolocationPositionUnavailableError&quot;, setMockGeolocationPositionUnavailableErrorCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2220         { &quot;setMockGeolocationPosition&quot;, setMockGeolocationPositionCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2221         { &quot;setNewWindowsCopyBackForwardList&quot;, setNewWindowsCopyBackForwardListCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2222         { &quot;setPageVisibility&quot;, setPageVisibilityCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2223         { &quot;setPOSIXLocale&quot;, setPOSIXLocaleCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2224         { &quot;setPersistentUserStyleSheetLocation&quot;, setPersistentUserStyleSheetLocationCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2225         { &quot;setPopupBlockingEnabled&quot;, setPopupBlockingEnabledCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2226         { &quot;setPluginsEnabled&quot;, setPluginsEnabledCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2227         { &quot;setPrinting&quot;, setPrintingCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2228         { &quot;setPrivateBrowsingEnabled&quot;, setPrivateBrowsingEnabledCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2229         { &quot;setSerializeHTTPLoads&quot;, setSerializeHTTPLoadsCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2230         { &quot;setSpatialNavigationEnabled&quot;, setSpatialNavigationEnabledCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2231         { &quot;setStopProvisionalFrameLoads&quot;, setStopProvisionalFrameLoadsCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2232         { &quot;setTabKeyCyclesThroughElements&quot;, setTabKeyCyclesThroughElementsCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2233 #if PLATFORM(IOS_FAMILY)
2234         { &quot;setTelephoneNumberParsingEnabled&quot;, setTelephoneNumberParsingEnabledCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2235         { &quot;setPagePaused&quot;, setPagePausedCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2236 #endif
<a name="17" id="anc17"></a>
2237         { &quot;setUserStyleSheetEnabled&quot;, setUserStyleSheetEnabledCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2238         { &quot;setUserStyleSheetLocation&quot;, setUserStyleSheetLocationCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2239         { &quot;setValueForUser&quot;, setValueForUserCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2240         { &quot;setWebViewEditable&quot;, setWebViewEditableCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2241         { &quot;setWillSendRequestClearHeader&quot;, setWillSendRequestClearHeaderCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2242         { &quot;setWillSendRequestReturnsNull&quot;, setWillSendRequestReturnsNullCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2243         { &quot;setWillSendRequestReturnsNullOnRedirect&quot;, setWillSendRequestReturnsNullOnRedirectCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2244         { &quot;setWindowIsKey&quot;, setWindowIsKeyCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2245         { &quot;setViewSize&quot;, setViewSizeCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2246         { &quot;setJavaScriptCanAccessClipboard&quot;, setJavaScriptCanAccessClipboardCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2247         { &quot;setXSSAuditorEnabled&quot;, setXSSAuditorEnabledCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2248         { &quot;showWebInspector&quot;, showWebInspectorCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2249         { &quot;simulateLegacyWebNotificationClick&quot;, simulateLegacyWebNotificationClickCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2250         { &quot;testOnscreen&quot;, testOnscreenCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2251         { &quot;testRepaint&quot;, testRepaintCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2252         { &quot;waitForPolicyDelegate&quot;, waitForPolicyDelegateCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2253         { &quot;waitUntilDone&quot;, waitUntilDoneCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2254         { &quot;windowCount&quot;, windowCountCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2255         { &quot;addOriginAccessWhitelistEntry&quot;, addOriginAccessWhitelistEntryCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2256         { &quot;setScrollbarPolicy&quot;, setScrollbarPolicyCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2257         { &quot;authenticateSession&quot;, authenticateSessionCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2258         { &quot;setShouldPaintBrokenImage&quot;, setShouldPaintBrokenImageCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2259         { &quot;setTextDirection&quot;, setTextDirectionCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2260         { &quot;setShouldStayOnPageAfterHandlingBeforeUnload&quot;, setShouldStayOnPageAfterHandlingBeforeUnloadCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2261         { &quot;addChromeInputField&quot;, addChromeInputFieldCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2262         { &quot;removeChromeInputField&quot;, removeChromeInputFieldCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2263         { &quot;focusWebView&quot;, focusWebViewCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2264         { &quot;setBackingScaleFactor&quot;, setBackingScaleFactorCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2265         { &quot;preciseTime&quot;, preciseTimeCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2266         { &quot;setHasCustomFullScreenBehavior&quot;, setHasCustomFullScreenBehaviorCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2267         { &quot;setStorageDatabaseIdleInterval&quot;, setStorageDatabaseIdleIntervalCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2268         { &quot;closeIdleLocalStorageDatabases&quot;, closeIdleLocalStorageDatabasesCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2269         { &quot;grantWebNotificationPermission&quot;, grantWebNotificationPermissionCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2270         { &quot;denyWebNotificationPermission&quot;, denyWebNotificationPermissionCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2271         { &quot;removeAllWebNotificationPermissions&quot;, removeAllWebNotificationPermissionsCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2272         { &quot;simulateWebNotificationClick&quot;, simulateWebNotificationClickCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2273         { &quot;failNextNewCodeBlock&quot;, failNextNewCodeBlock, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2274         { &quot;numberOfDFGCompiles&quot;, numberOfDFGCompiles, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2275         { &quot;neverInlineFunction&quot;, neverInlineFunction, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2276         { &quot;accummulateLogsForChannel&quot;, accummulateLogsForChannel, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2277         { &quot;runUIScript&quot;, runUIScriptCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2278         { &quot;imageCountInGeneralPasteboard&quot;, imageCountInGeneralPasteboardCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2279         { &quot;setSpellCheckerLoggingEnabled&quot;, setSpellCheckerLoggingEnabledCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2280         { &quot;setSpellCheckerResults&quot;, setSpellCheckerResultsCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2281         { &quot;setOpenPanelFiles&quot;, setOpenPanelFilesCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
<a name="18" id="anc18"></a><span class="line-added">2282 #if PLATFORM(IOS_FAMILY)</span>
<span class="line-added">2283         { &quot;setOpenPanelFilesMediaIcon&quot;, SetOpenPanelFilesMediaIconCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },</span>
<span class="line-added">2284 #endif</span>
2285         { &quot;forceImmediateCompletion&quot;, forceImmediateCompletionCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2286         { 0, 0, 0 }
2287     };
2288 
2289     return staticFunctions;
2290 }
2291 
2292 void TestRunner::queueLoadHTMLString(JSStringRef content, JSStringRef baseURL)
2293 {
2294     DRT::WorkQueue::singleton().queue(new LoadHTMLStringItem(content, baseURL));
2295 }
2296 
2297 void TestRunner::queueLoadAlternateHTMLString(JSStringRef content, JSStringRef baseURL, JSStringRef unreachableURL)
2298 {
2299     DRT::WorkQueue::singleton().queue(new LoadHTMLStringItem(content, baseURL, unreachableURL));
2300 }
2301 
2302 void TestRunner::queueBackNavigation(int howFarBack)
2303 {
2304     DRT::WorkQueue::singleton().queue(new BackItem(howFarBack));
2305 }
2306 
2307 void TestRunner::queueForwardNavigation(int howFarForward)
2308 {
2309     DRT::WorkQueue::singleton().queue(new ForwardItem(howFarForward));
2310 }
2311 
2312 void TestRunner::queueLoadingScript(JSStringRef script)
2313 {
2314     DRT::WorkQueue::singleton().queue(new LoadingScriptItem(script));
2315 }
2316 
2317 void TestRunner::queueNonLoadingScript(JSStringRef script)
2318 {
2319     DRT::WorkQueue::singleton().queue(new NonLoadingScriptItem(script));
2320 }
2321 
2322 void TestRunner::queueReload()
2323 {
2324     DRT::WorkQueue::singleton().queue(new ReloadItem);
2325 }
2326 
2327 void TestRunner::ignoreLegacyWebNotificationPermissionRequests()
2328 {
2329     m_areLegacyWebNotificationPermissionRequestsIgnored = false;
2330 }
2331 
2332 void TestRunner::waitToDumpWatchdogTimerFired()
2333 {
2334     const char* message = &quot;FAIL: Timed out waiting for notifyDone to be called\n&quot;;
2335     fprintf(testResult, &quot;%s&quot;, message);
2336 
2337     auto accumulatedLogs = getAndResetAccumulatedLogs();
2338     if (!accumulatedLogs.isEmpty()) {
2339         const char* message = &quot;Logs accumulated during test run:\n&quot;;
2340         fprintf(testResult, &quot;%s%s\n&quot;, message, accumulatedLogs.utf8().data());
2341     }
2342 
2343     notifyDone();
2344 }
2345 
2346 void TestRunner::setGeolocationPermissionCommon(bool allow)
2347 {
2348     m_isGeolocationPermissionSet = true;
2349     m_geolocationPermission = allow;
2350 }
2351 
2352 void TestRunner::setPOSIXLocale(JSStringRef locale)
2353 {
2354     char localeBuf[32];
2355     JSStringGetUTF8CString(locale, localeBuf, sizeof(localeBuf));
2356     setlocale(LC_ALL, localeBuf);
2357 }
2358 
2359 void TestRunner::addURLToRedirect(std::string origin, std::string destination)
2360 {
2361     m_URLsToRedirect[origin] = destination;
2362 }
2363 
2364 const char* TestRunner::redirectionDestinationForURL(const char* origin)
2365 {
2366     if (!origin)
2367         return nullptr;
2368 
2369     auto iterator = m_URLsToRedirect.find(origin);
2370     if (iterator == m_URLsToRedirect.end())
2371         return nullptr;
2372 
2373     return iterator-&gt;second.data();
2374 }
2375 
<a name="19" id="anc19"></a><span class="line-added">2376 void TestRunner::setRenderTreeDumpOptions(unsigned options)</span>
<span class="line-added">2377 {</span>
<span class="line-added">2378     m_renderTreeDumpOptions = options;</span>
<span class="line-added">2379 }</span>
<span class="line-added">2380 </span>
2381 void TestRunner::setShouldPaintBrokenImage(bool shouldPaintBrokenImage)
2382 {
2383     m_shouldPaintBrokenImage = shouldPaintBrokenImage;
2384 }
2385 
2386 void TestRunner::setAccummulateLogsForChannel(JSStringRef channel)
2387 {
2388     size_t maxLength = JSStringGetMaximumUTF8CStringSize(channel);
<a name="20" id="anc20"></a><span class="line-modified">2389     auto buffer = makeUniqueArray&lt;char&gt;(maxLength + 1);</span>
2390     JSStringGetUTF8CString(channel, buffer.get(), maxLength + 1);
2391 
<a name="21" id="anc21"></a><span class="line-added">2392 #if OS(WINDOWS) &amp;&amp; PLATFORM(JAVA)</span>
<span class="line-added">2393     // FIXME : error LNK2019: unresolved external symbol</span>
<span class="line-added">2394     // WebCoreTestSupport::setLogChannelToAccumulate({ buffer.get() });</span>
<span class="line-added">2395 #else</span>
2396     WebCoreTestSupport::setLogChannelToAccumulate({ buffer.get() });
<a name="22" id="anc22"></a><span class="line-added">2397 #endif</span>
2398 }
2399 
2400 typedef WTF::HashMap&lt;unsigned, JSValueRef&gt; CallbackMap;
2401 static CallbackMap&amp; callbackMap()
2402 {
2403     static CallbackMap&amp; map = *new CallbackMap;
2404     return map;
2405 }
2406 
2407 void TestRunner::cacheTestRunnerCallback(unsigned index, JSValueRef callback)
2408 {
2409     if (!callback)
2410         return;
2411 
2412     if (callbackMap().contains(index)) {
2413         fprintf(stderr, &quot;FAIL: Tried to install a second TestRunner callback for the same event (id %d)\n&quot;, index);
2414         return;
2415     }
2416 
2417     JSContextRef context = mainFrameJSContext();
2418     JSValueProtect(context, callback);
2419     callbackMap().add(index, callback);
2420 }
2421 
2422 void TestRunner::callTestRunnerCallback(unsigned index, size_t argumentCount, const JSValueRef arguments[])
2423 {
2424     if (!callbackMap().contains(index))
2425         return;
2426 
2427     JSContextRef context = mainFrameJSContext();
2428     if (JSObjectRef callback = JSValueToObject(context, callbackMap().take(index), 0)) {
2429         JSObjectCallAsFunction(context, callback, JSContextGetGlobalObject(context), argumentCount, arguments, 0);
2430         JSValueUnprotect(context, callback);
2431     }
2432 }
2433 
2434 void TestRunner::clearTestRunnerCallbacks()
2435 {
2436     JSContextRef context = mainFrameJSContext();
2437 
2438     for (auto&amp; iter : callbackMap()) {
2439         if (JSObjectRef callback = JSValueToObject(context, iter.value, 0))
2440             JSValueUnprotect(context, callback);
2441     }
2442 
2443     callbackMap().clear();
2444 }
2445 
2446 enum {
2447     FirstUIScriptCallbackID = 100
2448 };
2449 
2450 static unsigned nextUIScriptCallbackID()
2451 {
2452     static unsigned callbackID = FirstUIScriptCallbackID;
2453     return callbackID++;
2454 }
2455 
2456 void TestRunner::runUIScript(JSContextRef context, JSStringRef script, JSValueRef callback)
2457 {
2458     m_pendingUIScriptInvocationData = nullptr;
2459 
2460     unsigned callbackID = nextUIScriptCallbackID();
2461     cacheTestRunnerCallback(callbackID, callback);
2462 
2463     if (!m_UIScriptContext)
<a name="23" id="anc23"></a><span class="line-modified">2464         m_UIScriptContext = makeUniqueWithoutFastMallocCheck&lt;WTR::UIScriptContext&gt;(*this);</span>
2465 
2466     String scriptString(JSStringGetCharactersPtr(script), JSStringGetLength(script));
2467     m_UIScriptContext-&gt;runUIScript(scriptString, callbackID);
2468 }
2469 
2470 void TestRunner::callUIScriptCallback(unsigned callbackID, JSStringRef result)
2471 {
2472     JSRetainPtr&lt;JSStringRef&gt; protectedResult(result);
2473 #if !PLATFORM(IOS_FAMILY)
2474     RunLoop::main().dispatch([protectedThis = makeRef(*this), callbackID, protectedResult]() mutable {
2475         JSContextRef context = protectedThis-&gt;mainFrameJSContext();
2476         JSValueRef resultValue = JSValueMakeString(context, protectedResult.get());
2477         protectedThis-&gt;callTestRunnerCallback(callbackID, 1, &amp;resultValue);
2478     });
2479 #else
2480     WebThreadRun(
2481         makeBlockPtr([protectedThis = makeRef(*this), callbackID, protectedResult] {
2482             JSContextRef context = protectedThis-&gt;mainFrameJSContext();
2483             JSValueRef resultValue = JSValueMakeString(context, protectedResult.get());
2484             protectedThis-&gt;callTestRunnerCallback(callbackID, 1, &amp;resultValue);
2485         }).get()
2486     );
2487 #endif
2488 }
2489 
2490 void TestRunner::uiScriptDidComplete(const String&amp; result, unsigned callbackID)
2491 {
2492     auto stringRef = adopt(JSStringCreateWithUTF8CString(result.utf8().data()));
2493     callUIScriptCallback(callbackID, stringRef.get());
2494 }
2495 
2496 void TestRunner::setAllowsAnySSLCertificate(bool allowsAnySSLCertificate)
2497 {
<a name="24" id="anc24"></a><span class="line-added">2498 #if OS(WINDOWS) &amp;&amp; PLATFORM(JAVA)</span>
<span class="line-added">2499     // FIXME : error LNK2019: unresolved external symbol</span>
<span class="line-added">2500     // WebCoreTestSupport::setAllowsAnySSLCertificate(allowsAnySSLCertificate);</span>
<span class="line-added">2501 #else</span>
2502     WebCoreTestSupport::setAllowsAnySSLCertificate(allowsAnySSLCertificate);
<a name="25" id="anc25"></a><span class="line-added">2503 #endif</span>
2504 }
2505 
2506 void TestRunner::setOpenPanelFiles(JSContextRef context, JSValueRef filesValue)
2507 {
2508     if (!JSValueIsArray(context, filesValue))
2509         return;
2510 
2511     JSObjectRef files = JSValueToObject(context, filesValue, nullptr);
2512     static auto lengthProperty = adopt(JSStringCreateWithUTF8CString(&quot;length&quot;));
2513     JSValueRef filesLengthValue = JSObjectGetProperty(context, files, lengthProperty.get(), nullptr);
2514     if (!JSValueIsNumber(context, filesLengthValue))
2515         return;
2516 
2517     m_openPanelFiles.clear();
2518     auto filesLength = static_cast&lt;size_t&gt;(JSValueToNumber(context, filesLengthValue, nullptr));
2519     for (size_t i = 0; i &lt; filesLength; ++i) {
2520         JSValueRef fileValue = JSObjectGetPropertyAtIndex(context, files, i, nullptr);
2521         if (!JSValueIsString(context, fileValue))
2522             continue;
2523 
2524         auto file = adopt(JSValueToStringCopy(context, fileValue, nullptr));
2525         size_t fileBufferSize = JSStringGetMaximumUTF8CStringSize(file.get()) + 1;
<a name="26" id="anc26"></a><span class="line-modified">2526         auto fileBuffer = makeUniqueArray&lt;char&gt;(fileBufferSize);</span>
2527         JSStringGetUTF8CString(file.get(), fileBuffer.get(), fileBufferSize);
2528 
2529         m_openPanelFiles.push_back(fileBuffer.get());
2530     }
2531 }
2532 
<a name="27" id="anc27"></a><span class="line-added">2533 #if PLATFORM(IOS_FAMILY)</span>
<span class="line-added">2534 void TestRunner::setOpenPanelFilesMediaIcon(JSContextRef context, JSValueRef mediaIcon)</span>
<span class="line-added">2535 {</span>
<span class="line-added">2536     // FIXME (123058): Use a JSC API to get buffer contents once such is exposed.</span>
<span class="line-added">2537     JSC::VM&amp; vm = toJS(context)-&gt;vm();</span>
<span class="line-added">2538     JSC::JSLockHolder lock(vm);</span>
<span class="line-added">2539 </span>
<span class="line-added">2540     JSC::JSArrayBufferView* jsBufferView = JSC::jsDynamicCast&lt;JSC::JSArrayBufferView*&gt;(vm, toJS(toJS(context), mediaIcon));</span>
<span class="line-added">2541     ASSERT(jsBufferView);</span>
<span class="line-added">2542     RefPtr&lt;JSC::ArrayBufferView&gt; bufferView = jsBufferView-&gt;unsharedImpl();</span>
<span class="line-added">2543     const char* buffer = static_cast&lt;const char*&gt;(bufferView-&gt;baseAddress());</span>
<span class="line-added">2544     std::vector&lt;char&gt; mediaIconData(buffer, buffer + bufferView-&gt;byteLength());</span>
<span class="line-added">2545 </span>
<span class="line-added">2546     m_openPanelFilesMediaIcon = mediaIconData;</span>
<span class="line-added">2547 }</span>
<span class="line-added">2548 #endif</span>
<span class="line-added">2549 </span>
2550 void TestRunner::cleanup()
2551 {
2552     clearTestRunnerCallbacks();
2553 }
<a name="28" id="anc28"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="28" type="hidden" />
</body>
</html>