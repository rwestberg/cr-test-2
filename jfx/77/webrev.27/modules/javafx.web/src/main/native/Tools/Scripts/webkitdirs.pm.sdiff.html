<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff modules/javafx.web/src/main/native/Tools/Scripts/webkitdirs.pm</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="build-webkit.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="webkitperl/FeatureList.pm.sdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Tools/Scripts/webkitdirs.pm</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  71        &amp;executableProductDir
  72        &amp;extractNonHostConfiguration
  73        &amp;findOrCreateSimulatorForIOSDevice
  74        &amp;iosSimulatorDeviceByName
  75        &amp;iosVersion
  76        &amp;nmPath
  77        &amp;passedConfiguration
  78        &amp;prependToEnvironmentVariableList
  79        &amp;printHelpAndExitForRunAndDebugWebKitAppIfNeeded
  80        &amp;productDir
  81        &amp;quitIOSSimulator
  82        &amp;relaunchIOSSimulator
  83        &amp;restartIOSSimulatorDevice
  84        &amp;runIOSWebKitApp
  85        &amp;runMacWebKitApp
  86        &amp;safariPath
  87        &amp;sdkDirectory
  88        &amp;sdkPlatformDirectory
  89        &amp;setConfiguration
  90        &amp;setupMacWebKitEnvironment

  91        &amp;sharedCommandLineOptions
  92        &amp;sharedCommandLineOptionsUsage
  93        &amp;shutDownIOSSimulatorDevice
  94        &amp;willUseIOSDeviceSDK
  95        &amp;willUseIOSSimulatorSDK
  96        DO_NOT_USE_OPEN_COMMAND
  97        SIMULATOR_DEVICE_SUFFIX_FOR_WEBKIT_DEVELOPMENT
  98        USE_OPEN_COMMAND
  99    );
 100    %EXPORT_TAGS = ( );
 101    @EXPORT_OK   = ();
 102 }
 103 
 104 # Ports
 105 use constant {
 106     AppleWin    =&gt; &quot;AppleWin&quot;,
 107     GTK         =&gt; &quot;GTK&quot;,
 108     iOS         =&gt; &quot;iOS&quot;,
 109     tvOS        =&gt; &quot;tvOS&quot;,
 110     watchOS     =&gt; &quot;watchOS&quot;,
 111     Mac         =&gt; &quot;Mac&quot;,

 112     JSCOnly     =&gt; &quot;JSCOnly&quot;,
 113     PlayStation =&gt; &quot;PlayStation&quot;,
 114     WinCairo    =&gt; &quot;WinCairo&quot;,
 115     Java     =&gt; &quot;Java&quot;,
 116     WPE         =&gt; &quot;WPE&quot;,
 117     Unknown     =&gt; &quot;Unknown&quot;
 118 };
 119 
 120 use constant USE_OPEN_COMMAND =&gt; 1; # Used in runMacWebKitApp().
 121 use constant DO_NOT_USE_OPEN_COMMAND =&gt; 2;
 122 use constant SIMULATOR_DEVICE_STATE_SHUTDOWN =&gt; &quot;1&quot;;
 123 use constant SIMULATOR_DEVICE_STATE_BOOTED =&gt; &quot;3&quot;;
 124 use constant SIMULATOR_DEVICE_SUFFIX_FOR_WEBKIT_DEVELOPMENT  =&gt; &quot;For WebKit Development&quot;;
 125 
 126 # See table &quot;Certificate types and names&quot; on &lt;https://developer.apple.com/library/ios/documentation/IDEs/Conceptual/AppDistributionGuide/MaintainingCertificates/MaintainingCertificates.html#//apple_ref/doc/uid/TP40012582-CH31-SW41&gt;.
 127 use constant IOS_DEVELOPMENT_CERTIFICATE_NAME_PREFIX =&gt; &quot;iPhone Developer: &quot;;
 128 
 129 our @EXPORT_OK;
 130 
 131 my $architecture;
</pre>
<hr />
<pre>
 145 my $nmPath;
 146 my $osXVersion;
 147 my $iosVersion;
 148 my $generateDsym;
 149 my $isCMakeBuild;
 150 my $isGenerateProjectOnly;
 151 my $shouldBuild32Bit;
 152 my $isWin64;
 153 my $isInspectorFrontend;
 154 my $portName;
 155 my $shouldUseGuardMalloc;
 156 my $shouldNotUseNinja;
 157 my $xcodeVersion;
 158 my $isJava;
 159 my $is32bit;
 160 
 161 my $unknownPortProhibited = 0;
 162 
 163 # Variables for Win32 support
 164 my $programFilesPath;
<span class="line-modified"> 165 my $vcBuildPath;</span>
 166 my $vsInstallDir;
<span class="line-removed"> 167 my $msBuildInstallDir;</span>
 168 my $vsVersion;
 169 my $windowsSourceDir;
 170 my $winVersion;
<span class="line-removed"> 171 my $vsWhereFoundInstallation;</span>
 172 
 173 # Defined in VCSUtils.
 174 sub exitStatus($);
 175 
 176 sub findMatchingArguments($$);
 177 sub hasArgument($$);
 178 
 179 sub sdkDirectory($)
 180 {
 181     my ($sdkName) = @_;
 182     chomp(my $sdkDirectory = `xcrun --sdk &#39;$sdkName&#39; --show-sdk-path`);
 183     die &quot;Failed to get SDK path from xcrun: $!&quot; if exitStatus($?);
 184     return $sdkDirectory;
 185 }
 186 
 187 sub sdkPlatformDirectory($)
 188 {
 189     my ($sdkName) = @_;
 190     chomp(my $sdkPlatformDirectory = `xcrun --sdk &#39;$sdkName&#39; --show-sdk-platform-path`);
 191     die &quot;Failed to get SDK platform path from xcrun: $!&quot; if exitStatus($?);
</pre>
<hr />
<pre>
 455     } elsif (isDarwin() || isBSD()) {
 456         chomp($numberOfCPUs = `sysctl -n hw.ncpu`);
 457     } else {
 458         $numberOfCPUs = 1;
 459     }
 460 }
 461 
 462 sub determineMaxCPULoad
 463 {
 464     return if defined $maxCPULoad;
 465     if (defined($ENV{MAX_CPU_LOAD})) {
 466         $maxCPULoad = $ENV{MAX_CPU_LOAD};
 467     }
 468 }
 469 
 470 sub jscPath($)
 471 {
 472     my ($productDir) = @_;
 473     my $jscName = &quot;jsc&quot;;
 474     $jscName .= &quot;_debug&quot;  if configuration() eq &quot;Debug_All&quot;;
<span class="line-modified"> 475     $jscName .= &quot;.exe&quot; if (isAnyWindows());</span>




 476     return &quot;$productDir/$jscName&quot; if -e &quot;$productDir/$jscName&quot;;
 477     return &quot;$productDir/JavaScriptCore.framework/Resources/$jscName&quot;;
 478 }
 479 
 480 sub argumentsForConfiguration()
 481 {
 482     determineConfiguration();
 483     determineArchitecture();
 484     determineXcodeSDK();
 485 
 486     my @args = ();
 487     # FIXME: Is it necessary to pass --debug, --release, --32-bit or --64-bit?
 488     # These are determined automatically from stored configuration.
 489     push(@args, &#39;--debug&#39;) if ($configuration =~ &quot;^Debug&quot;);
 490     push(@args, &#39;--release&#39;) if ($configuration =~ &quot;^Release&quot;);
 491     push(@args, &#39;--ios-device&#39;) if (defined $xcodeSDK &amp;&amp; $xcodeSDK =~ /^iphoneos/);
 492     push(@args, &#39;--ios-simulator&#39;) if (defined $xcodeSDK &amp;&amp; $xcodeSDK =~ /^iphonesimulator/);

 493     push(@args, &#39;--32-bit&#39;) if ($architecture eq &quot;x86&quot; and !isWin64());
 494     push(@args, &#39;--64-bit&#39;) if (isWin64());
 495     push(@args, &#39;--gtk&#39;) if isGtk();
 496     push(@args, &#39;--java&#39;) if isJava();
 497     push(@args, &#39;--wpe&#39;) if isWPE();
 498     push(@args, &#39;--jsc-only&#39;) if isJSCOnly();
 499     push(@args, &#39;--wincairo&#39;) if isWinCairo();
 500     push(@args, &#39;--playstation&#39;) if isPlayStation();
 501     return @args;
 502 }
 503 
 504 sub extractNonMacOSHostConfiguration
 505 {
 506     my @args = ();
 507     my @extract = (&#39;--device&#39;, &#39;--gtk&#39;, &#39;--ios&#39;, &#39;--platform&#39;, &#39;--sdk&#39;, &#39;--simulator&#39;, &#39;--wincairo&#39;, &#39;SDKROOT&#39;, &#39;ARCHS&#39;);
 508     foreach (@{$_[0]}) {
 509         my $line = $_;
 510         my $flag = 0;
 511         foreach (@extract) {
 512             if (length($line) &gt;= length($_) &amp;&amp; substr($line, 0, length($_)) eq $_
</pre>
<hr />
<pre>
 559         return;
 560     }
 561     if (checkForArgumentAndRemoveFromARGV(&quot;--device&quot;) || checkForArgumentAndRemoveFromARGV(&quot;--ios-device&quot;)) {
 562         $xcodeSDK ||= &quot;iphoneos&quot;;
 563     }
 564     if (checkForArgumentAndRemoveFromARGV(&quot;--simulator&quot;) || checkForArgumentAndRemoveFromARGV(&quot;--ios-simulator&quot;)) {
 565         $xcodeSDK ||= &#39;iphonesimulator&#39;;
 566     }
 567     if (checkForArgumentAndRemoveFromARGV(&quot;--tvos-device&quot;)) {
 568         $xcodeSDK ||=  &quot;appletvos&quot;;
 569     }
 570     if (checkForArgumentAndRemoveFromARGV(&quot;--tvos-simulator&quot;)) {
 571         $xcodeSDK ||= &quot;appletvsimulator&quot;;
 572     }
 573     if (checkForArgumentAndRemoveFromARGV(&quot;--watchos-device&quot;)) {
 574         $xcodeSDK ||=  &quot;watchos&quot;;
 575     }
 576     if (checkForArgumentAndRemoveFromARGV(&quot;--watchos-simulator&quot;)) {
 577         $xcodeSDK ||= &quot;watchsimulator&quot;;
 578     }



 579     return if !defined $xcodeSDK;
 580     
 581     # Prefer the internal version of an sdk, if it exists.
 582     my @availableSDKs = availableXcodeSDKs();
 583 
 584     foreach my $sdk (@availableSDKs) {
 585         next if $sdk ne &quot;$xcodeSDK.internal&quot;;
 586         $xcodeSDK = $sdk;
 587         last;
 588     }
 589 }
 590 
 591 sub xcodeSDK
 592 {
 593     determineXcodeSDK();
 594     return $xcodeSDK;
 595 }
 596 
 597 sub setXcodeSDK($)
 598 {
 599     ($xcodeSDK) = @_;
 600 }
 601 
 602 
 603 sub xcodeSDKPlatformName()
 604 {
 605     determineXcodeSDK();
 606     return &quot;&quot; if !defined $xcodeSDK;
 607     return &quot;appletvos&quot; if $xcodeSDK =~ /appletvos/i;
 608     return &quot;appletvsimulator&quot; if $xcodeSDK =~ /appletvsimulator/i;
 609     return &quot;iphoneos&quot; if $xcodeSDK =~ /iphoneos/i;
 610     return &quot;iphonesimulator&quot; if $xcodeSDK =~ /iphonesimulator/i;
 611     return &quot;macosx&quot; if $xcodeSDK =~ /macosx/i;
 612     return &quot;watchos&quot; if $xcodeSDK =~ /watchos/i;
 613     return &quot;watchsimulator&quot; if $xcodeSDK =~ /watchsimulator/i;

 614     die &quot;Couldn&#39;t determine platform name from Xcode SDK&quot;;
 615 }
 616 
 617 sub XcodeSDKPath
 618 {
 619     determineXcodeSDK();
 620 
 621     die &quot;Can&#39;t find the SDK path because no Xcode SDK was specified&quot; if not $xcodeSDK;
 622     return sdkDirectory($xcodeSDK);
 623 }
 624 
 625 sub xcodeSDKVersion
 626 {
 627     determineXcodeSDK();
 628 
 629     die &quot;Can&#39;t find the SDK version because no Xcode SDK was specified&quot; if !$xcodeSDK;
 630 
 631     chomp(my $sdkVersion = `xcrun --sdk $xcodeSDK --show-sdk-version`);
 632     die &quot;Failed to get SDK version from xcrun&quot; if exitStatus($?);
 633 
 634     return $sdkVersion;
 635 }
 636 
 637 sub programFilesPath
 638 {
 639     return $programFilesPath if defined $programFilesPath;
 640 
 641     $programFilesPath = $ENV{&#39;PROGRAMFILES(X86)&#39;} || $ENV{&#39;PROGRAMFILES&#39;} || &quot;C:\\Program Files&quot;;
 642 
 643     return $programFilesPath;
 644 }
 645 
 646 sub programFilesPathX86
 647 {
 648     my $programFilesPathX86 = $ENV{&#39;PROGRAMFILES(X86)&#39;} || &quot;C:\\Program Files (x86)&quot;;
 649 
 650     return $programFilesPathX86;
 651 }
 652 
<span class="line-modified"> 653 sub requireModulesForVSWhere</span>
 654 {
<span class="line-modified"> 655     require Encode;</span>
<span class="line-modified"> 656     require Encode::Locale;</span>
<span class="line-modified"> 657     require JSON::PP;</span>
<span class="line-modified"> 658 }</span>
<span class="line-modified"> 659 </span>
<span class="line-modified"> 660 sub pickCurrentVisualStudioInstallation</span>
<span class="line-removed"> 661 {</span>
<span class="line-removed"> 662     return $vsWhereFoundInstallation if defined $vsWhereFoundInstallation;</span>
<span class="line-removed"> 663 </span>
<span class="line-removed"> 664     requireModulesForVSWhere();</span>
<span class="line-removed"> 665     determineSourceDir();</span>
<span class="line-removed"> 666 </span>
<span class="line-removed"> 667     # Prefer Enterprise, then Professional, then Community, then</span>
<span class="line-removed"> 668     # anything else that provides MSBuild.</span>
<span class="line-removed"> 669     foreach my $productType ((</span>
<span class="line-removed"> 670         &#39;Microsoft.VisualStudio.Product.Enterprise&#39;,</span>
<span class="line-removed"> 671         &#39;Microsoft.VisualStudio.Product.Professional&#39;,</span>
<span class="line-removed"> 672         &#39;Microsoft.VisualStudio.Product.Community&#39;,</span>
<span class="line-removed"> 673         undef</span>
<span class="line-removed"> 674     )) {</span>
<span class="line-removed"> 675         my $command = &quot;$sourceDir/WebKitLibraries/win/tools/vswhere -nologo -latest -format json -requires Microsoft.Component.MSBuild&quot;;</span>
<span class="line-removed"> 676         if (defined $productType) {</span>
<span class="line-removed"> 677             $command .= &quot; -products $productType&quot;;</span>
<span class="line-removed"> 678         }</span>
<span class="line-removed"> 679         my $vsWhereOut = `$command`;</span>
<span class="line-removed"> 680         my $installations = [];</span>
<span class="line-removed"> 681         eval {</span>
<span class="line-removed"> 682             $installations = JSON::PP::decode_json(Encode::encode(&#39;UTF-8&#39; =&gt; Encode::decode(console_in =&gt; $vsWhereOut)));</span>
<span class="line-removed"> 683         };</span>
<span class="line-removed"> 684         print &quot;Error getting Visual Studio Location: $@\n&quot; if $@;</span>
<span class="line-removed"> 685         undef $@;</span>
<span class="line-removed"> 686 </span>
<span class="line-removed"> 687         if (scalar @$installations) {</span>
<span class="line-removed"> 688             my $installation = $installations-&gt;[0];</span>
<span class="line-removed"> 689             $vsWhereFoundInstallation = $installation;</span>
<span class="line-removed"> 690             return $installation;</span>
<span class="line-removed"> 691         }</span>
<span class="line-removed"> 692     }</span>
<span class="line-removed"> 693     return undef;</span>
 694 }
 695 
 696 sub visualStudioInstallDir
 697 {
 698     return $vsInstallDir if defined $vsInstallDir;
 699 
 700     if ($ENV{&#39;VSINSTALLDIR&#39;}) {
 701         $vsInstallDir = $ENV{&#39;VSINSTALLDIR&#39;};
 702         $vsInstallDir =~ s|[\\/]$||;
 703     } else {
 704         $vsInstallDir = visualStudioInstallDirVSWhere();
<span class="line-modified"> 705         if (not -e $vsInstallDir) {</span>
<span class="line-removed"> 706             $vsInstallDir = visualStudioInstallDirFallback();</span>
<span class="line-removed"> 707         }</span>
 708     }
 709     chomp($vsInstallDir = `cygpath &quot;$vsInstallDir&quot;`) if isCygwin();
 710 
 711     print &quot;Using Visual Studio: $vsInstallDir\n&quot;;
 712     return $vsInstallDir;
 713 }
 714 
<span class="line-modified"> 715 sub visualStudioInstallDirVSWhere</span>
 716 {
<span class="line-removed"> 717     pickCurrentVisualStudioInstallation();</span>
<span class="line-removed"> 718     if (defined($vsWhereFoundInstallation)) {</span>
<span class="line-removed"> 719         return $vsWhereFoundInstallation-&gt;{installationPath};</span>
<span class="line-removed"> 720     }</span>
<span class="line-removed"> 721     return undef;</span>
<span class="line-removed"> 722 }</span>
<span class="line-removed"> 723 </span>
<span class="line-removed"> 724 sub visualStudioInstallDirFallback</span>
<span class="line-removed"> 725 {</span>
<span class="line-removed"> 726     foreach my $productType ((</span>
<span class="line-removed"> 727         &#39;Enterprise&#39;,</span>
<span class="line-removed"> 728         &#39;Professional&#39;,</span>
<span class="line-removed"> 729         &#39;Community&#39;,</span>
<span class="line-removed"> 730     )) {</span>
<span class="line-removed"> 731         my $installdir = File::Spec-&gt;catdir(programFilesPathX86(),</span>
<span class="line-removed"> 732             &quot;Microsoft Visual Studio&quot;, &quot;2017&quot;, $productType);</span>
<span class="line-removed"> 733         my $msbuilddir = File::Spec-&gt;catdir($installdir,</span>
<span class="line-removed"> 734             &quot;MSBuild&quot;, &quot;15.0&quot;, &quot;bin&quot;);</span>
<span class="line-removed"> 735         if (-e $installdir &amp;&amp; -e $msbuilddir) {</span>
<span class="line-removed"> 736             return $installdir;</span>
<span class="line-removed"> 737         }</span>
<span class="line-removed"> 738     }</span>
<span class="line-removed"> 739     return undef;</span>
<span class="line-removed"> 740 }</span>
<span class="line-removed"> 741 </span>
<span class="line-removed"> 742 sub msBuildInstallDir</span>
<span class="line-removed"> 743 {</span>
<span class="line-removed"> 744     return $msBuildInstallDir if defined $msBuildInstallDir;</span>
<span class="line-removed"> 745 </span>
 746     my $installDir = visualStudioInstallDir();
<span class="line-removed"> 747     $msBuildInstallDir = File::Spec-&gt;catdir($installDir,</span>
<span class="line-removed"> 748         &quot;MSBuild&quot;, &quot;15.0&quot;, &quot;bin&quot;);</span>
 749 
<span class="line-modified"> 750     chomp($msBuildInstallDir = `cygpath &quot;$msBuildInstallDir&quot;`) if isCygwin();</span>




 751 
<span class="line-modified"> 752     print &quot;Using MSBuild: $msBuildInstallDir\n&quot;;</span>
<span class="line-modified"> 753     return $msBuildInstallDir;</span>


 754 }
 755 
 756 sub determineConfigurationForVisualStudio
 757 {
 758     return if defined $configurationForVisualStudio;
 759     determineConfiguration();
 760     # FIXME: We should detect when Debug_All or Production has been chosen.
 761     $configurationForVisualStudio = &quot;/p:Configuration=&quot; . $configuration;
 762 }
 763 
 764 sub usesPerConfigurationBuildDirectory
 765 {
 766     # [Gtk] We don&#39;t have Release/Debug configurations in straight
 767     # autotool builds (non build-webkit). In this case and if
 768     # WEBKIT_OUTPUTDIR exist, use that as our configuration dir. This will
 769     # allows us to run run-webkit-tests without using build-webkit.
 770     return ($ENV{&quot;WEBKIT_OUTPUTDIR&quot;} &amp;&amp; isGtk()) || isAppleWinWebKit() || isJava();
 771 }
 772 
 773 sub determineConfigurationProductDir
 774 {
 775     return if defined $configurationProductDir;
 776     determineBaseProductDir();
 777     determineConfiguration();
 778     if (isAppleWinWebKit() || isWinCairo() || isPlayStation()) {
 779         $configurationProductDir = File::Spec-&gt;catdir($baseProductDir, $configuration);
 780     } else {
 781         if (usesPerConfigurationBuildDirectory()) {
 782             $configurationProductDir = &quot;$baseProductDir&quot;;
 783         } else {
 784             $configurationProductDir = &quot;$baseProductDir/$configuration&quot;;
<span class="line-modified"> 785             $configurationProductDir .= &quot;-&quot; . xcodeSDKPlatformName() if isEmbeddedWebKit();</span>
 786         }
 787     }
 788 }
 789 
 790 sub setConfigurationProductDir($)
 791 {
 792     ($configurationProductDir) = @_;
 793 }
 794 
 795 sub determineCurrentSVNRevision
 796 {
 797     # We always update the current SVN revision here, and leave the caching
 798     # to currentSVNRevision(), so that changes to the SVN revision while the
 799     # script is running can be picked up by calling this function again.
 800     determineSourceDir();
 801     $currentSVNRevision = svnRevisionForDirectory($sourceDir);
 802     return $currentSVNRevision;
 803 }
 804 
 805 
</pre>
<hr />
<pre>
 815     return $baseProductDir;
 816 }
 817 
 818 sub sourceDir
 819 {
 820     determineSourceDir();
 821     return $sourceDir;
 822 }
 823 
 824 sub productDir
 825 {
 826     determineConfigurationProductDir();
 827     return $configurationProductDir;
 828 }
 829 
 830 sub executableProductDir
 831 {
 832     my $productDirectory = productDir();
 833 
 834     my $binaryDirectory;
<span class="line-modified"> 835     if (isAnyWindows()) {</span>
 836         $binaryDirectory = isWin64() ? &quot;bin64&quot; : &quot;bin32&quot;;
<span class="line-modified"> 837     } elsif (isGtk() || isJSCOnly() || isWPE()) {</span>
 838         $binaryDirectory = &quot;bin&quot;;
 839     } else {
 840         return $productDirectory;
 841     }
 842 
 843     return File::Spec-&gt;catdir($productDirectory, $binaryDirectory);
 844 }
 845 
 846 sub jscProductDir
 847 {
 848     return executableProductDir();
 849 }
 850 
 851 sub configuration()
 852 {
 853     determineConfiguration();
 854     return $configuration;
 855 }
 856 
 857 sub asanIsEnabled()
</pre>
<hr />
<pre>
 895     return !exitStatus(system(&quot;security find-identity -p codesigning | grep &#39;&quot; . IOS_DEVELOPMENT_CERTIFICATE_NAME_PREFIX . &quot;&#39; &gt; /dev/null 2&gt;&amp;1&quot;));
 896 }
 897 
 898 sub argumentsForXcode()
 899 {
 900     my @args = ();
 901     push @args, &quot;DEBUG_INFORMATION_FORMAT=dwarf-with-dsym&quot; if generateDsym();
 902     return @args;
 903 }
 904 
 905 sub XcodeOptions
 906 {
 907     determineBaseProductDir();
 908     determineConfiguration();
 909     determineArchitecture();
 910     determineASanIsEnabled();
 911     determineLTOMode();
 912     determineXcodeSDK();
 913 
 914     my @options;
<span class="line-removed"> 915     push @options, &quot;-UseNewBuildSystem=NO&quot;;</span>
 916     push @options, &quot;-UseSanitizedBuildSystemEnvironment=YES&quot;;

 917     push @options, (&quot;-configuration&quot;, $configuration);
 918     push @options, (&quot;-xcconfig&quot;, sourceDir() . &quot;/Tools/asan/asan.xcconfig&quot;, &quot;ASAN_IGNORE=&quot; . sourceDir() . &quot;/Tools/asan/webkit-asan-ignore.txt&quot;) if $asanIsEnabled;
 919     push @options, &quot;WK_LTO_MODE=$ltoMode&quot; if $ltoMode;
 920     push @options, @baseProductDirOption;
 921     push @options, &quot;ARCHS=$architecture&quot; if $architecture;
 922     push @options, &quot;SDKROOT=$xcodeSDK&quot; if $xcodeSDK;
 923     if (willUseIOSDeviceSDK()) {
 924         push @options, &quot;ENABLE_BITCODE=NO&quot;;
 925         if (hasIOSDevelopmentCertificate()) {
 926             # FIXME: May match more than one installed development certificate.
 927             push @options, &quot;CODE_SIGN_IDENTITY=&quot; . IOS_DEVELOPMENT_CERTIFICATE_NAME_PREFIX;
 928         } else {
 929             push @options, &quot;CODE_SIGN_IDENTITY=&quot;; # No identity
 930             push @options, &quot;CODE_SIGNING_REQUIRED=NO&quot;;
 931         }
 932     }
 933     push @options, argumentsForXcode();
 934     return @options;
 935 }
 936 
</pre>
<hr />
<pre>
 940 }
 941 
 942 sub XcodeOptionStringNoConfig
 943 {
 944     return join &quot; &quot;, @baseProductDirOption;
 945 }
 946 
 947 sub XcodeCoverageSupportOptions()
 948 {
 949     my @coverageSupportOptions = ();
 950     push @coverageSupportOptions, &quot;GCC_GENERATE_TEST_COVERAGE_FILES=YES&quot;;
 951     push @coverageSupportOptions, &quot;GCC_INSTRUMENT_PROGRAM_FLOW_ARCS=YES&quot;;
 952     return @coverageSupportOptions;
 953 }
 954 
 955 sub XcodeStaticAnalyzerOption()
 956 {
 957     return &quot;RUN_CLANG_STATIC_ANALYZER=YES&quot;;
 958 }
 959 









 960 my $passedConfiguration;
 961 my $searchedForPassedConfiguration;
 962 sub determinePassedConfiguration
 963 {
 964     return if $searchedForPassedConfiguration;
 965     $searchedForPassedConfiguration = 1;
 966     $passedConfiguration = undef;
 967 
 968     if (checkForArgumentAndRemoveFromARGV(&quot;--debug&quot;)) {
 969         $passedConfiguration = &quot;Debug&quot;;
 970     } elsif(checkForArgumentAndRemoveFromARGV(&quot;--release&quot;)) {
 971         $passedConfiguration = &quot;Release&quot;;
 972     } elsif (checkForArgumentAndRemoveFromARGV(&quot;--profile&quot;) || checkForArgumentAndRemoveFromARGV(&quot;--profiling&quot;)) {
 973         $passedConfiguration = &quot;Profiling&quot;;
 974     }
 975 }
 976 
 977 sub passedConfiguration
 978 {
 979     determinePassedConfiguration();
</pre>
<hr />
<pre>
1087         return &quot;$configurationProductDir/lib/libwebkit2gtk-4.0&quot; . $extension;
1088     }
1089     if (isIOSWebKit()) {
1090         return &quot;$configurationProductDir/$libraryName.framework/$libraryName&quot;;
1091     }
1092     if (isAppleCocoaWebKit()) {
1093         return &quot;$configurationProductDir/$libraryName.framework/Versions/A/$libraryName&quot;;
1094     }
1095     if (isAppleWinWebKit()) {
1096         if ($libraryName eq &quot;JavaScriptCore&quot;) {
1097             return &quot;$baseProductDir/lib/$libraryName.lib&quot;;
1098         } else {
1099             return &quot;$baseProductDir/$libraryName.intermediate/$configuration/$libraryName.intermediate/$libraryName.lib&quot;;
1100         }
1101     }
1102     if (isJava()) {
1103         my $extension = isDarwin() ? &quot;.dylib&quot; : &quot;.so&quot;;
1104         return &quot;$configurationProductDir/lib/libjfxwebkit&quot; . $extension;
1105     }
1106     if (isWPE()) {
<span class="line-modified">1107         return &quot;$configurationProductDir/lib/libWPEWebKit-0.1.so&quot;;</span>
1108     }
1109 
1110     die &quot;Unsupported platform, can&#39;t determine built library locations.\nTry `build-webkit --help` for more information.\n&quot;;
1111 }
1112 
1113 # Check to see that all the frameworks are built.
1114 sub checkFrameworks # FIXME: This is a poor name since only the Mac calls built WebCore a Framework.
1115 {
1116     return if isAnyWindows() || isJava();
1117     my @frameworks = (&quot;JavaScriptCore&quot;, &quot;WebCore&quot;);
1118     push(@frameworks, &quot;WebKit&quot;) if isAppleCocoaWebKit(); # FIXME: This seems wrong, all ports should have a WebKit these days.
1119     for my $framework (@frameworks) {
1120         my $path = builtDylibPathForName($framework);
1121         die &quot;Can&#39;t find built framework at \&quot;$path\&quot;.\n&quot; unless -e $path;
1122     }
1123 }
1124 
1125 sub isInspectorFrontend()
1126 {
1127     determineIsInspectorFrontend();
</pre>
<hr />
<pre>
1232                 if defined $portName;
1233 
1234             $portName = $argToPortName{$arg};
1235         }
1236     }
1237 
1238     return if defined $portName;
1239 
1240     # Port was not selected via command line, use appropriate default value
1241 
1242     if (isAnyWindows()) {
1243         $portName = AppleWin;
1244     } elsif (isDarwin()) {
1245         determineXcodeSDK();
1246         if (willUseIOSDeviceSDK() || willUseIOSSimulatorSDK()) {
1247             $portName = iOS;
1248         } elsif (willUseAppleTVDeviceSDK() || willUseAppleTVSimulatorSDK()) {
1249             $portName = tvOS;
1250         } elsif (willUseWatchDeviceSDK() || willUseWatchSimulatorSDK()) {
1251             $portName = watchOS;


1252         } else {
1253             $portName = Mac;
1254         }
1255     } else {
1256         if ($unknownPortProhibited) {
1257             my $portsChoice = join &quot;\n\t&quot;, qw(
1258                 --gtk
1259                 --jsc-only
1260                 --wpe
1261             );
1262             die &quot;Please specify which WebKit port to build using one of the following options:&quot;
1263                 . &quot;\n\t$portsChoice\n&quot;;
1264         }
1265 
1266         # If script is run without arguments we cannot determine port
1267         # TODO: This state should be outlawed
1268         $portName = Unknown;
1269     }
1270 }
1271 
</pre>
<hr />
<pre>
1472 sub isWatchOSWebKit()
1473 {
1474     return portName() eq watchOS;
1475 }
1476 
1477 sub isEmbeddedWebKit()
1478 {
1479     return isIOSWebKit() || isTVOSWebKit() || isWatchOSWebKit();
1480 }
1481 
1482 sub isAppleWebKit()
1483 {
1484     return !isJava() &amp;&amp; (isAppleCocoaWebKit() || isAppleWinWebKit());
1485 }
1486 
1487 sub isAppleMacWebKit()
1488 {
1489     return portName() eq Mac;
1490 }
1491 





1492 sub isAppleCocoaWebKit()
1493 {
<span class="line-modified">1494     return isAppleMacWebKit() || isEmbeddedWebKit();</span>
1495 }
1496 
1497 sub isAppleWinWebKit()
1498 {
1499     return portName() eq AppleWin;
1500 }
1501 
1502 sub iOSSimulatorDevicesPath
1503 {
1504     return &quot;$ENV{HOME}/Library/Developer/CoreSimulator/Devices&quot;;
1505 }
1506 
1507 sub iOSSimulatorDevices
1508 {
1509     eval &quot;require Foundation&quot;;
1510     my $devicesPath = iOSSimulatorDevicesPath();
1511     opendir(DEVICES, $devicesPath);
1512     my @udids = grep {
1513         $_ =~ m/^[0-9A-F]{8}-([0-9A-F]{4}-){3}[0-9A-F]{12}$/;
1514     } readdir(DEVICES);
</pre>
<hr />
<pre>
1560 sub willUseAppleTVDeviceSDK()
1561 {
1562     return xcodeSDKPlatformName() eq &quot;appletvos&quot;;
1563 }
1564 
1565 sub willUseAppleTVSimulatorSDK()
1566 {
1567     return xcodeSDKPlatformName() eq &quot;appletvsimulator&quot;;
1568 }
1569 
1570 sub willUseWatchDeviceSDK()
1571 {
1572     return xcodeSDKPlatformName() eq &quot;watchos&quot;;
1573 }
1574 
1575 sub willUseWatchSimulatorSDK()
1576 {
1577     return xcodeSDKPlatformName() eq &quot;watchsimulator&quot;;
1578 }
1579 





1580 sub determineNmPath()
1581 {
1582     return if $nmPath;
1583 
1584     if (isAppleCocoaWebKit()) {
1585         $nmPath = `xcrun -find nm`;
1586         chomp $nmPath;
1587     }
1588     $nmPath = &quot;nm&quot; if !$nmPath;
1589 }
1590 
1591 sub nmPath()
1592 {
1593     determineNmPath();
1594     return $nmPath;
1595 }
1596 
1597 sub splitVersionString
1598 {
1599     my $versionString = shift;
</pre>
<hr />
<pre>
1893         }
1894         if (!defined $ENV{&#39;WEBKIT_OUTPUTDIR&#39;} || !$ENV{&#39;WEBKIT_OUTPUTDIR&#39;}) {
1895             print &quot;Warning: You must set the &#39;WebKit_OutputDir&#39; environment variable\n&quot;;
1896             print &quot;         to be able build WebKit from within Visual Studio 2017 and newer.\n\n&quot;;
1897         }
1898         if (!defined $ENV{&#39;MSBUILDDISABLENODEREUSE&#39;} || !$ENV{&#39;MSBUILDDISABLENODEREUSE&#39;}) {
1899             print &quot;Warning: You should set the &#39;MSBUILDDISABLENODEREUSE&#39; environment variable to &#39;1&#39;\n&quot;;
1900             print &quot;         to avoid periodic locked log files when building.\n\n&quot;;
1901         }
1902     }
1903     # FIXME (125180): Remove the following temporary 64-bit support once official support is available.
1904     if (isWin64() and !$ENV{&#39;WEBKIT_64_SUPPORT&#39;}) {
1905         print &quot;Warning: You must set the &#39;WEBKIT_64_SUPPORT&#39; environment variable\n&quot;;
1906         print &quot;         to be able run WebKit or JavaScriptCore tests.\n\n&quot;;
1907     }
1908 }
1909 
1910 sub setupCygwinEnv()
1911 {
1912     return if !isAnyWindows();
<span class="line-modified">1913     return if $vcBuildPath;</span>
1914 
1915     my $programFilesPath = programFilesPath();
<span class="line-removed">1916     my $visualStudioPath = File::Spec-&gt;catfile(visualStudioInstallDir(), qw(Common7 IDE devenv.com));</span>
1917 
1918     print &quot;Building results into: &quot;, baseProductDir(), &quot;\n&quot;;
1919     print &quot;WEBKIT_OUTPUTDIR is set to: &quot;, $ENV{&quot;WEBKIT_OUTPUTDIR&quot;}, &quot;\n&quot;;
1920     print &quot;WEBKIT_LIBRARIES is set to: &quot;, $ENV{&quot;WEBKIT_LIBRARIES&quot;}, &quot;\n&quot;;
1921     # FIXME (125180): Remove the following temporary 64-bit support once official support is available.
1922     print &quot;WEBKIT_64_SUPPORT is set to: &quot;, $ENV{&quot;WEBKIT_64_SUPPORT&quot;}, &quot;\n&quot; if isWin64();
1923 
1924     # We will actually use MSBuild to build WebKit, but we need to find the Visual Studio install (above) to make
1925     # sure we use the right options.
<span class="line-modified">1926     $vcBuildPath = File::Spec-&gt;catfile(msBuildInstallDir(), qw(MSBuild.exe));</span>
<span class="line-modified">1927     if (! -e $vcBuildPath) {</span>
1928         print &quot;*************************************************************\n&quot;;
<span class="line-modified">1929         print &quot;Cannot find &#39;$vcBuildPath&#39;\n&quot;;</span>
1930         print &quot;Please make sure execute that the Microsoft .NET Framework SDK\n&quot;;
1931         print &quot;is installed on this machine.\n&quot;;
1932         print &quot;*************************************************************\n&quot;;
1933         die;
1934     }
1935 }
1936 
1937 sub buildXCodeProject($$@)
1938 {
1939     my ($project, $clean, @extraOptions) = @_;
1940 
1941     if ($clean) {
1942         push(@extraOptions, &quot;-alltargets&quot;);
1943         push(@extraOptions, &quot;clean&quot;);
1944     }
1945 
1946     chomp($ENV{DSYMUTIL_NUM_THREADS} = `sysctl -n hw.activecpu`);
1947     return system &quot;xcodebuild&quot;, &quot;-project&quot;, &quot;$project.xcodeproj&quot;, @extraOptions;
1948 }
1949 
<span class="line-modified">1950 sub getMSBuildPlatformArgument()</span>
1951 {
1952     if (isPlayStation()) {
1953         return &quot;&quot;;
1954     } elsif (isWin64()) {
<span class="line-modified">1955         return &quot;/p:Platform=x64&quot;;</span>
1956     } else {
<span class="line-modified">1957         return &quot;/p:Platform=Win32&quot;;</span>

















1958     }

1959 }
1960 
1961 sub buildVisualStudioProject
1962 {
1963     my ($project, $clean) = @_;
1964     setupCygwinEnv();
1965 
1966     my $config = configurationForVisualStudio();
1967 
1968     chomp($project = `cygpath -w &quot;$project&quot;`) if isCygwin();
1969 
1970     my $action = &quot;/t:build&quot;;
1971     if ($clean) {
1972         $action = &quot;/t:clean&quot;;
1973     }
1974 
1975     my $platform = getMSBuildPlatformArgument();
1976     my $logPath = File::Spec-&gt;catdir($baseProductDir, $configuration);
1977     make_path($logPath) unless -d $logPath or $logPath eq &quot;.&quot;;
1978 
1979     my $errorLogFile = File::Spec-&gt;catfile($logPath, &quot;webkit_errors.log&quot;);
1980     chomp($errorLogFile = `cygpath -w &quot;$errorLogFile&quot;`) if isCygwin();
1981     my $errorLogging = &quot;/flp:LogFile=&quot; . $errorLogFile . &quot;;ErrorsOnly&quot;;
1982 
1983     my $warningLogFile = File::Spec-&gt;catfile($logPath, &quot;webkit_warnings.log&quot;);
1984     chomp($warningLogFile = `cygpath -w &quot;$warningLogFile&quot;`) if isCygwin();
1985     my $warningLogging = &quot;/flp1:LogFile=&quot; . $warningLogFile . &quot;;WarningsOnly&quot;;
1986 
1987     my $maxCPUCount = &#39;/maxcpucount:&#39; . numberOfCPUs();
1988 
<span class="line-modified">1989     my @command = ($vcBuildPath, &quot;/verbosity:minimal&quot;, $project, $action, $config, $platform, &quot;/fl&quot;, $errorLogging, &quot;/fl1&quot;, $warningLogging, $maxCPUCount);</span>
1990     print join(&quot; &quot;, @command), &quot;\n&quot;;
1991     return system @command;
1992 }
1993 
1994 sub getJhbuildPath()
1995 {
1996     my @jhbuildPath = File::Spec-&gt;splitdir(baseProductDir());
1997     if (isGit() &amp;&amp; isGitBranchBuild() &amp;&amp; gitBranch()) {
1998         pop(@jhbuildPath);
1999     }
2000     if (isGtk()) {
2001         push(@jhbuildPath, &quot;DependenciesGTK&quot;);
2002     } elsif (isJava()) {
2003         push(@jhbuildPath, &quot;DependenciesJava&quot;);
2004     } elsif (isWPE()) {
2005         push(@jhbuildPath, &quot;DependenciesWPE&quot;);
2006     } else {
2007         die &quot;Cannot get JHBuild path for platform that isn&#39;t GTK+ or WPE.\n&quot;;
2008     }
2009     return File::Spec-&gt;catdir(@jhbuildPath);
</pre>
<hr />
<pre>
2076 
2077     if (! -e getFlatpakPath()) {
2078         return 0;
2079     }
2080 
2081     runInFlatpak(@_)
2082 }
2083 
2084 sub wrapperPrefixIfNeeded()
2085 {
2086     if (isJava()) {
2087         return ();
2088     }
2089 
2090     if (isAnyWindows() || isJSCOnly() || isPlayStation()) {
2091         return ();
2092     }
2093     if (isAppleCocoaWebKit()) {
2094         return (&quot;xcrun&quot;);
2095     }
<span class="line-modified">2096     if (-e getJhbuildPath()) {</span>
2097         my @prefix = (File::Spec-&gt;catfile(sourceDir(), &quot;Tools&quot;, &quot;jhbuild&quot;, &quot;jhbuild-wrapper&quot;));
2098         if (isGtk()) {
2099             push(@prefix, &quot;--gtk&quot;);
2100         } elsif (isWPE()) {
2101             push(@prefix, &quot;--wpe&quot;);
2102         }
2103         push(@prefix, &quot;run&quot;);
2104 
2105         return @prefix;
2106     }
2107 
2108     return ();
2109 }
2110 
2111 sub shouldUseJhbuild()
2112 {
2113     return ((isGtk() or isWPE()) and -e getJhbuildPath());
2114 }
2115 
2116 sub shouldUseFlatpak()
</pre>
<hr />
<pre>
2166     # delete the images subdirectory would not be here. Directory mtime does not
2167     # percolate upwards when files are added or removed from subdirectories.
2168     my $inspectorUserInterfaceDirectory = File::Spec-&gt;catdir(sourceDir(), &quot;Source&quot;, &quot;WebInspectorUI&quot;, &quot;UserInterface&quot;);
2169     if ($cacheFileModifiedTime &lt; stat($inspectorUserInterfaceDirectory)-&gt;mtime) {
2170         return 1;
2171     }
2172 
2173     my $inspectorImageDirectory = File::Spec-&gt;catdir(sourceDir(), &quot;Source&quot;, &quot;WebInspectorUI&quot;, &quot;UserInterface&quot;, &quot;Images&quot;);
2174     if ($cacheFileModifiedTime &lt; stat($inspectorImageDirectory)-&gt;mtime) {
2175         return 1;
2176     }
2177     }
2178 
2179     if(isAnyWindows()) {
2180         my $winConfiguration = File::Spec-&gt;catdir(sourceDir(), &quot;Source&quot;, &quot;cmake&quot;, &quot;OptionsWin.cmake&quot;);
2181         if ($cacheFileModifiedTime &lt; stat($winConfiguration)-&gt;mtime) {
2182             return 1;
2183         }
2184     }
2185 









2186     return 0;
2187 }
2188 
2189 sub removeCMakeCache(@)
2190 {
2191     my (@buildArgs) = @_;
2192     if (shouldRemoveCMakeCache(@buildArgs)) {
2193         my $cmakeCache = cmakeCachePath();
2194         my $cmakeFiles = cmakeFilesPath();
2195         unlink($cmakeCache) if -e $cmakeCache;
2196         rmtree($cmakeFiles) if -d $cmakeFiles;
2197     }
2198 }
2199 
2200 sub canUseNinja(@)
2201 {
2202     if (!defined($shouldNotUseNinja)) {
2203         $shouldNotUseNinja = checkForArgumentAndRemoveFromARGV(&quot;--no-ninja&quot;);
2204     }
2205 
</pre>
<hr />
<pre>
2218     return commandExists(&quot;ninja&quot;) || commandExists(&quot;ninja-build&quot;);
2219 }
2220 
2221 sub canUseEclipseNinjaGenerator(@)
2222 {
2223     # Check that eclipse and eclipse Ninja generator is installed
2224     my $devnull = File::Spec-&gt;devnull();
2225     return commandExists(&quot;eclipse&quot;) &amp;&amp; exitStatus(system(&quot;cmake -N -G &#39;Eclipse CDT4 - Ninja&#39; &gt;$devnull 2&gt;&amp;1&quot;)) == 0;
2226 }
2227 
2228 sub cmakeGeneratedBuildfile(@)
2229 {
2230     my ($willUseNinja) = @_;
2231     if ($willUseNinja) {
2232         return File::Spec-&gt;catfile(baseProductDir(), configuration(), &quot;build.ninja&quot;)
2233     } elsif (isAnyWindows()) {
2234         return File::Spec-&gt;catfile(baseProductDir(), configuration(), &quot;WebKit.sln&quot;)
2235     } else {
2236         return File::Spec-&gt;catfile(baseProductDir(), configuration(), &quot;Makefile&quot;)
2237     }
<span class="line-removed">2238     return 0;</span>
2239 }
2240 
2241 sub generateBuildSystemFromCMakeProject
2242 {
2243     my ($prefixPath, @cmakeArgs) = @_;
2244     my $config = configuration();
2245     my $port = cmakeBasedPortName();
2246     my $buildPath = File::Spec-&gt;catdir(baseProductDir(), $config);
2247     File::Path::mkpath($buildPath) unless -d $buildPath;
2248     my $originalWorkingDirectory = getcwd();
2249     chdir($buildPath) or die;
2250 
2251     # We try to be smart about when to rerun cmake, so that we can have faster incremental builds.
2252     my $willUseNinja = canUseNinja();
2253     if (-e cmakeCachePath() &amp;&amp; -e cmakeGeneratedBuildfile($willUseNinja)) {
2254         return 0;
2255     }
2256 
2257     my @args;
2258     push @args, &quot;-DPORT=\&quot;$port\&quot;&quot;;
2259     push @args, &quot;-DCMAKE_INSTALL_PREFIX=\&quot;$prefixPath\&quot;&quot; if $prefixPath;
2260     push @args, &quot;-DCMAKE_EXPORT_COMPILE_COMMANDS=ON&quot;;
2261     if ($config =~ /release/i) {
2262         push @args, &quot;-DCMAKE_BUILD_TYPE=Release&quot;;
2263     } elsif ($config =~ /debug/i) {
2264         push @args, &quot;-DCMAKE_BUILD_TYPE=Debug&quot;;
2265     }
2266 
<span class="line-modified">2267     push @args, &quot;-DENABLE_ADDRESS_SANITIZER=ON&quot; if asanIsEnabled();</span>


2268 
2269     push @args, &#39;-DCMAKE_TOOLCHAIN_FILE=Platform/PlayStation&#39; if isPlayStation();
2270 
2271     if ($willUseNinja) {
2272         push @args, &quot;-G&quot;;
2273         if (canUseEclipseNinjaGenerator()) {
2274             push @args, &quot;&#39;Eclipse CDT4 - Ninja&#39;&quot;;
2275         } else {
2276             push @args, &quot;Ninja&quot;;
2277         }
2278         push @args, &quot;-DUSE_THIN_ARCHIVES=OFF&quot; if isPlayStation();
2279     } elsif (isJava() &amp;&amp; isAnyWindows()) {
2280         push @args, &quot;-G&quot;;
2281         if (isWin64()) {
2282             push @args, &#39;&quot;Visual Studio 15 2017 Win64&quot;&#39;;
2283             push @args, &#39;-DCMAKE_GENERATOR_TOOLSET=&quot;host=x64&quot;&#39;;
2284         } else {
2285             push @args, &#39;&quot;Visual Studio 15 2017&quot;&#39;;
2286         }
<span class="line-modified">2287     } elsif (isAnyWindows() &amp;&amp; isWin64()) {</span>
<span class="line-modified">2288         push @args, &#39;-G &quot;Visual Studio 15 2017 Win64&quot;&#39;;</span>
<span class="line-modified">2289         push @args, &#39;-DCMAKE_GENERATOR_TOOLSET=&quot;host=x64&quot;&#39;;</span>
<span class="line-modified">2290     } elsif (isPlayStation()) {</span>
<span class="line-modified">2291         push @args, &#39;-G &quot;Visual Studio 15&quot;&#39;;</span>



2292     }
2293 
2294     # Do not show progress of generating bindings in interactive Ninja build not to leave noisy lines on tty
2295     push @args, &#39;-DSHOW_BINDINGS_GENERATION_PROGRESS=1&#39; unless ($willUseNinja &amp;&amp; -t STDOUT);
2296 
2297     # Some ports have production mode, but build-webkit should always use developer mode.
2298     push @args, &quot;-DDEVELOPER_MODE=ON&quot; if isGtk() || isJSCOnly() || isWPE() || isWinCairo();
2299 










2300     push @args, @cmakeArgs if @cmakeArgs;
2301 
2302     my $cmakeSourceDir = isCygwin() ? windowsSourceDir() : sourceDir();
2303     push @args, &#39;&quot;&#39; . $cmakeSourceDir . &#39;&quot;&#39;;
2304 
2305     # We call system(&quot;cmake @args&quot;) instead of system(&quot;cmake&quot;, @args) so that @args is
2306     # parsed for shell metacharacters.
2307     my $wrapper = join(&quot; &quot;, wrapperPrefixIfNeeded()) . &quot; &quot;;
2308     my $returnCode = systemVerbose($wrapper . &quot;cmake @args&quot;);
2309 
2310     chdir($originalWorkingDirectory);
2311     return $returnCode;
2312 }
2313 
2314 sub buildCMakeGeneratedProject($)
2315 {
2316     my (@makeArgs) = @_;
2317     my $config = configuration();
2318     my $buildPath = File::Spec-&gt;catdir(baseProductDir(), $config);
2319     if (! -d $buildPath) {
2320         die &quot;Must call generateBuildSystemFromCMakeProject() before building CMake project.&quot;;
2321     }
2322 
2323     if ($ENV{VERBOSE} &amp;&amp; canUseNinja()) {
2324         push @makeArgs, &quot;-v&quot;;
2325         push @makeArgs, &quot;-d keeprsp&quot; if (version-&gt;parse(determineNinjaVersion()) &gt;= version-&gt;parse(&quot;1.4.0&quot;));
2326     }
2327 
<span class="line-removed">2328     chomp($buildPath = `cygpath -m &#39;$buildPath&#39;`) if isCygwin();</span>
<span class="line-removed">2329 </span>
2330     my $command = &quot;cmake&quot;;
2331     my @args = (&quot;--build&quot;, $buildPath, &quot;--config&quot;, $config);
2332     push @args, (&quot;--&quot;, @makeArgs) if @makeArgs;
2333 
2334     # GTK and JSCOnly can use a build script to preserve colors and pretty-printing.
2335     if ((isGtk() || isJSCOnly()) &amp;&amp; -e &quot;$buildPath/build.sh&quot;) {
2336         chdir &quot;$buildPath&quot; or die;
2337         $command = &quot;$buildPath/build.sh&quot;;
2338         @args = (@makeArgs);
2339     }
2340 
2341     # We call system(&quot;cmake @args&quot;) instead of system(&quot;cmake&quot;, @args) so that @args is
2342     # parsed for shell metacharacters. In particular, @makeArgs may contain such metacharacters.
2343     my $wrapper = join(&quot; &quot;, wrapperPrefixIfNeeded()) . &quot; &quot;;
2344     return systemVerbose($wrapper . &quot;$command @args&quot;);
2345 }
2346 
2347 sub cleanCMakeGeneratedProject()
2348 {
2349     my $config = configuration();
</pre>
<hr />
<pre>
2505     unshift @args, @ARGV;
2506 
2507     return @args;
2508 }
2509 
2510 sub setupMacWebKitEnvironment($)
2511 {
2512     my ($dyldFrameworkPath) = @_;
2513 
2514     $dyldFrameworkPath = File::Spec-&gt;rel2abs($dyldFrameworkPath);
2515 
2516     prependToEnvironmentVariableList(&quot;DYLD_FRAMEWORK_PATH&quot;, $dyldFrameworkPath);
2517     prependToEnvironmentVariableList(&quot;__XPC_DYLD_FRAMEWORK_PATH&quot;, $dyldFrameworkPath);
2518     prependToEnvironmentVariableList(&quot;DYLD_LIBRARY_PATH&quot;, $dyldFrameworkPath);
2519     prependToEnvironmentVariableList(&quot;__XPC_DYLD_LIBRARY_PATH&quot;, $dyldFrameworkPath);
2520     $ENV{WEBKIT_UNSET_DYLD_FRAMEWORK_PATH} = &quot;YES&quot;;
2521 
2522     setUpGuardMallocIfNeeded();
2523 }
2524 








2525 sub setupIOSWebKitEnvironment($)
2526 {
2527     my ($dyldFrameworkPath) = @_;
2528     $dyldFrameworkPath = File::Spec-&gt;rel2abs($dyldFrameworkPath);
2529 
2530     prependToEnvironmentVariableList(&quot;DYLD_FRAMEWORK_PATH&quot;, $dyldFrameworkPath);
2531     prependToEnvironmentVariableList(&quot;DYLD_LIBRARY_PATH&quot;, $dyldFrameworkPath);
2532 
2533     setUpGuardMallocIfNeeded();
2534 }
2535 
2536 sub iosSimulatorApplicationsPath()
2537 {
2538     # FIXME: We should ask simctl for this information, instead of guessing from available runtimes.
2539     my $runtimePath = File::Spec-&gt;catdir(sdkPlatformDirectory(&quot;iphoneos&quot;), &quot;Developer&quot;, &quot;Library&quot;, &quot;CoreSimulator&quot;, &quot;Profiles&quot;, &quot;Runtimes&quot;);
2540     opendir(RUNTIMES, $runtimePath);
2541     my @runtimes = grep {/.*\.simruntime/} readdir(RUNTIMES);
2542     close(RUNTIMES);
2543     my $sult = File::Spec-&gt;catdir($runtimePath, @runtimes ? $runtimes[0] : &quot;iOS.simruntime&quot;, &quot;Contents&quot;, &quot;Resources&quot;, &quot;RuntimeRoot&quot;, &quot;Applications&quot;);
2544     return $sult;
</pre>
<hr />
<pre>
2848 }
2849 
2850 sub execMacWebKitAppForDebugging($)
2851 {
2852     my ($appPath) = @_;
2853     my $architectureSwitch = &quot;--arch&quot;;
2854     my $argumentsSeparator = &quot;--&quot;;
2855 
2856     my $debuggerPath = `xcrun -find lldb`;
2857     chomp $debuggerPath;
2858     die &quot;Can&#39;t find the lldb executable.\n&quot; unless -x $debuggerPath;
2859 
2860     my $productDir = productDir();
2861     setupMacWebKitEnvironment($productDir);
2862 
2863     my @architectureFlags = ($architectureSwitch, architecture());
2864     print &quot;Starting @{[basename($appPath)]} under lldb with DYLD_FRAMEWORK_PATH set to point to built WebKit in $productDir.\n&quot;;
2865     exec { $debuggerPath } $debuggerPath, @architectureFlags, $argumentsSeparator, $appPath, argumentsForRunAndDebugMacWebKitApp() or die;
2866 }
2867 


















2868 sub debugSafari
2869 {
2870     if (isAppleMacWebKit()) {
2871         checkFrameworks();
2872         execMacWebKitAppForDebugging(safariPath());
2873     }
2874 
2875     return 1; # Unsupported platform; can&#39;t debug Safari on this platform.
2876 }
2877 
2878 sub runSafari
2879 {
2880     if (isIOSWebKit()) {
2881         return runIOSWebKitApp(mobileSafariBundle());
2882     }
2883 
2884     if (isAppleMacWebKit()) {
2885         return runMacWebKitApp(safariPath());
2886     }
2887 
</pre>
<hr />
<pre>
2911     if (isAppleMacWebKit()) {
2912         execMacWebKitAppForDebugging(File::Spec-&gt;catfile(productDir(), &quot;MiniBrowser.app&quot;, &quot;Contents&quot;, &quot;MacOS&quot;, &quot;MiniBrowser&quot;));
2913     }
2914     
2915     return 1;
2916 }
2917 
2918 sub runWebKitTestRunner
2919 {
2920     if (isAppleMacWebKit()) {
2921         return runMacWebKitApp(File::Spec-&gt;catfile(productDir(), &quot;WebKitTestRunner&quot;));
2922     }
2923 
2924     return 1;
2925 }
2926 
2927 sub debugWebKitTestRunner
2928 {
2929     if (isAppleMacWebKit()) {
2930         execMacWebKitAppForDebugging(File::Spec-&gt;catfile(productDir(), &quot;WebKitTestRunner&quot;));


2931     }
2932 
2933     return 1;
2934 }
2935 
2936 sub readRegistryString
2937 {
2938     my ($valueName) = @_;
2939     chomp(my $string = `regtool --wow32 get &quot;$valueName&quot;`);
2940     return $string;
2941 }
2942 
2943 sub writeRegistryString
2944 {
2945     my ($valueName, $string) = @_;
2946 
2947     my $error = system &quot;regtool&quot;, &quot;--wow32&quot;, &quot;set&quot;, &quot;-s&quot;, $valueName, $string;
2948 
2949     # On Windows Vista/7 with UAC enabled, regtool will fail to modify the registry, but will still
2950     # return a successful exit code. So we double-check here that the value we tried to write to the
</pre>
</td>
<td>
<hr />
<pre>
  71        &amp;executableProductDir
  72        &amp;extractNonHostConfiguration
  73        &amp;findOrCreateSimulatorForIOSDevice
  74        &amp;iosSimulatorDeviceByName
  75        &amp;iosVersion
  76        &amp;nmPath
  77        &amp;passedConfiguration
  78        &amp;prependToEnvironmentVariableList
  79        &amp;printHelpAndExitForRunAndDebugWebKitAppIfNeeded
  80        &amp;productDir
  81        &amp;quitIOSSimulator
  82        &amp;relaunchIOSSimulator
  83        &amp;restartIOSSimulatorDevice
  84        &amp;runIOSWebKitApp
  85        &amp;runMacWebKitApp
  86        &amp;safariPath
  87        &amp;sdkDirectory
  88        &amp;sdkPlatformDirectory
  89        &amp;setConfiguration
  90        &amp;setupMacWebKitEnvironment
<span class="line-added">  91        &amp;setupUnixWebKitEnvironment</span>
  92        &amp;sharedCommandLineOptions
  93        &amp;sharedCommandLineOptionsUsage
  94        &amp;shutDownIOSSimulatorDevice
  95        &amp;willUseIOSDeviceSDK
  96        &amp;willUseIOSSimulatorSDK
  97        DO_NOT_USE_OPEN_COMMAND
  98        SIMULATOR_DEVICE_SUFFIX_FOR_WEBKIT_DEVELOPMENT
  99        USE_OPEN_COMMAND
 100    );
 101    %EXPORT_TAGS = ( );
 102    @EXPORT_OK   = ();
 103 }
 104 
 105 # Ports
 106 use constant {
 107     AppleWin    =&gt; &quot;AppleWin&quot;,
 108     GTK         =&gt; &quot;GTK&quot;,
 109     iOS         =&gt; &quot;iOS&quot;,
 110     tvOS        =&gt; &quot;tvOS&quot;,
 111     watchOS     =&gt; &quot;watchOS&quot;,
 112     Mac         =&gt; &quot;Mac&quot;,
<span class="line-added"> 113     MacCatalyst =&gt; &quot;MacCatalyst&quot;,</span>
 114     JSCOnly     =&gt; &quot;JSCOnly&quot;,
 115     PlayStation =&gt; &quot;PlayStation&quot;,
 116     WinCairo    =&gt; &quot;WinCairo&quot;,
 117     Java     =&gt; &quot;Java&quot;,
 118     WPE         =&gt; &quot;WPE&quot;,
 119     Unknown     =&gt; &quot;Unknown&quot;
 120 };
 121 
 122 use constant USE_OPEN_COMMAND =&gt; 1; # Used in runMacWebKitApp().
 123 use constant DO_NOT_USE_OPEN_COMMAND =&gt; 2;
 124 use constant SIMULATOR_DEVICE_STATE_SHUTDOWN =&gt; &quot;1&quot;;
 125 use constant SIMULATOR_DEVICE_STATE_BOOTED =&gt; &quot;3&quot;;
 126 use constant SIMULATOR_DEVICE_SUFFIX_FOR_WEBKIT_DEVELOPMENT  =&gt; &quot;For WebKit Development&quot;;
 127 
 128 # See table &quot;Certificate types and names&quot; on &lt;https://developer.apple.com/library/ios/documentation/IDEs/Conceptual/AppDistributionGuide/MaintainingCertificates/MaintainingCertificates.html#//apple_ref/doc/uid/TP40012582-CH31-SW41&gt;.
 129 use constant IOS_DEVELOPMENT_CERTIFICATE_NAME_PREFIX =&gt; &quot;iPhone Developer: &quot;;
 130 
 131 our @EXPORT_OK;
 132 
 133 my $architecture;
</pre>
<hr />
<pre>
 147 my $nmPath;
 148 my $osXVersion;
 149 my $iosVersion;
 150 my $generateDsym;
 151 my $isCMakeBuild;
 152 my $isGenerateProjectOnly;
 153 my $shouldBuild32Bit;
 154 my $isWin64;
 155 my $isInspectorFrontend;
 156 my $portName;
 157 my $shouldUseGuardMalloc;
 158 my $shouldNotUseNinja;
 159 my $xcodeVersion;
 160 my $isJava;
 161 my $is32bit;
 162 
 163 my $unknownPortProhibited = 0;
 164 
 165 # Variables for Win32 support
 166 my $programFilesPath;
<span class="line-modified"> 167 my $msBuildPath;</span>
 168 my $vsInstallDir;

 169 my $vsVersion;
 170 my $windowsSourceDir;
 171 my $winVersion;

 172 
 173 # Defined in VCSUtils.
 174 sub exitStatus($);
 175 
 176 sub findMatchingArguments($$);
 177 sub hasArgument($$);
 178 
 179 sub sdkDirectory($)
 180 {
 181     my ($sdkName) = @_;
 182     chomp(my $sdkDirectory = `xcrun --sdk &#39;$sdkName&#39; --show-sdk-path`);
 183     die &quot;Failed to get SDK path from xcrun: $!&quot; if exitStatus($?);
 184     return $sdkDirectory;
 185 }
 186 
 187 sub sdkPlatformDirectory($)
 188 {
 189     my ($sdkName) = @_;
 190     chomp(my $sdkPlatformDirectory = `xcrun --sdk &#39;$sdkName&#39; --show-sdk-platform-path`);
 191     die &quot;Failed to get SDK platform path from xcrun: $!&quot; if exitStatus($?);
</pre>
<hr />
<pre>
 455     } elsif (isDarwin() || isBSD()) {
 456         chomp($numberOfCPUs = `sysctl -n hw.ncpu`);
 457     } else {
 458         $numberOfCPUs = 1;
 459     }
 460 }
 461 
 462 sub determineMaxCPULoad
 463 {
 464     return if defined $maxCPULoad;
 465     if (defined($ENV{MAX_CPU_LOAD})) {
 466         $maxCPULoad = $ENV{MAX_CPU_LOAD};
 467     }
 468 }
 469 
 470 sub jscPath($)
 471 {
 472     my ($productDir) = @_;
 473     my $jscName = &quot;jsc&quot;;
 474     $jscName .= &quot;_debug&quot;  if configuration() eq &quot;Debug_All&quot;;
<span class="line-modified"> 475     if (isPlayStation()) {</span>
<span class="line-added"> 476         $jscName .= &quot;.elf&quot;;</span>
<span class="line-added"> 477     } elsif (isAnyWindows()) {</span>
<span class="line-added"> 478         $jscName .= &quot;.exe&quot;;</span>
<span class="line-added"> 479     }</span>
 480     return &quot;$productDir/$jscName&quot; if -e &quot;$productDir/$jscName&quot;;
 481     return &quot;$productDir/JavaScriptCore.framework/Resources/$jscName&quot;;
 482 }
 483 
 484 sub argumentsForConfiguration()
 485 {
 486     determineConfiguration();
 487     determineArchitecture();
 488     determineXcodeSDK();
 489 
 490     my @args = ();
 491     # FIXME: Is it necessary to pass --debug, --release, --32-bit or --64-bit?
 492     # These are determined automatically from stored configuration.
 493     push(@args, &#39;--debug&#39;) if ($configuration =~ &quot;^Debug&quot;);
 494     push(@args, &#39;--release&#39;) if ($configuration =~ &quot;^Release&quot;);
 495     push(@args, &#39;--ios-device&#39;) if (defined $xcodeSDK &amp;&amp; $xcodeSDK =~ /^iphoneos/);
 496     push(@args, &#39;--ios-simulator&#39;) if (defined $xcodeSDK &amp;&amp; $xcodeSDK =~ /^iphonesimulator/);
<span class="line-added"> 497     push(@args, &#39;--maccatalyst&#39;) if (defined $xcodeSDK &amp;&amp; $xcodeSDK =~ /^maccatalyst/);</span>
 498     push(@args, &#39;--32-bit&#39;) if ($architecture eq &quot;x86&quot; and !isWin64());
 499     push(@args, &#39;--64-bit&#39;) if (isWin64());
 500     push(@args, &#39;--gtk&#39;) if isGtk();
 501     push(@args, &#39;--java&#39;) if isJava();
 502     push(@args, &#39;--wpe&#39;) if isWPE();
 503     push(@args, &#39;--jsc-only&#39;) if isJSCOnly();
 504     push(@args, &#39;--wincairo&#39;) if isWinCairo();
 505     push(@args, &#39;--playstation&#39;) if isPlayStation();
 506     return @args;
 507 }
 508 
 509 sub extractNonMacOSHostConfiguration
 510 {
 511     my @args = ();
 512     my @extract = (&#39;--device&#39;, &#39;--gtk&#39;, &#39;--ios&#39;, &#39;--platform&#39;, &#39;--sdk&#39;, &#39;--simulator&#39;, &#39;--wincairo&#39;, &#39;SDKROOT&#39;, &#39;ARCHS&#39;);
 513     foreach (@{$_[0]}) {
 514         my $line = $_;
 515         my $flag = 0;
 516         foreach (@extract) {
 517             if (length($line) &gt;= length($_) &amp;&amp; substr($line, 0, length($_)) eq $_
</pre>
<hr />
<pre>
 564         return;
 565     }
 566     if (checkForArgumentAndRemoveFromARGV(&quot;--device&quot;) || checkForArgumentAndRemoveFromARGV(&quot;--ios-device&quot;)) {
 567         $xcodeSDK ||= &quot;iphoneos&quot;;
 568     }
 569     if (checkForArgumentAndRemoveFromARGV(&quot;--simulator&quot;) || checkForArgumentAndRemoveFromARGV(&quot;--ios-simulator&quot;)) {
 570         $xcodeSDK ||= &#39;iphonesimulator&#39;;
 571     }
 572     if (checkForArgumentAndRemoveFromARGV(&quot;--tvos-device&quot;)) {
 573         $xcodeSDK ||=  &quot;appletvos&quot;;
 574     }
 575     if (checkForArgumentAndRemoveFromARGV(&quot;--tvos-simulator&quot;)) {
 576         $xcodeSDK ||= &quot;appletvsimulator&quot;;
 577     }
 578     if (checkForArgumentAndRemoveFromARGV(&quot;--watchos-device&quot;)) {
 579         $xcodeSDK ||=  &quot;watchos&quot;;
 580     }
 581     if (checkForArgumentAndRemoveFromARGV(&quot;--watchos-simulator&quot;)) {
 582         $xcodeSDK ||= &quot;watchsimulator&quot;;
 583     }
<span class="line-added"> 584     if (checkForArgumentAndRemoveFromARGV(&quot;--maccatalyst&quot;)) {</span>
<span class="line-added"> 585         $xcodeSDK ||= &quot;maccatalyst&quot;;</span>
<span class="line-added"> 586     }</span>
 587     return if !defined $xcodeSDK;
 588     
 589     # Prefer the internal version of an sdk, if it exists.
 590     my @availableSDKs = availableXcodeSDKs();
 591 
 592     foreach my $sdk (@availableSDKs) {
 593         next if $sdk ne &quot;$xcodeSDK.internal&quot;;
 594         $xcodeSDK = $sdk;
 595         last;
 596     }
 597 }
 598 
 599 sub xcodeSDK
 600 {
 601     determineXcodeSDK();
 602     return $xcodeSDK;
 603 }
 604 
 605 sub setXcodeSDK($)
 606 {
 607     ($xcodeSDK) = @_;
 608 }
 609 
 610 
 611 sub xcodeSDKPlatformName()
 612 {
 613     determineXcodeSDK();
 614     return &quot;&quot; if !defined $xcodeSDK;
 615     return &quot;appletvos&quot; if $xcodeSDK =~ /appletvos/i;
 616     return &quot;appletvsimulator&quot; if $xcodeSDK =~ /appletvsimulator/i;
 617     return &quot;iphoneos&quot; if $xcodeSDK =~ /iphoneos/i;
 618     return &quot;iphonesimulator&quot; if $xcodeSDK =~ /iphonesimulator/i;
 619     return &quot;macosx&quot; if $xcodeSDK =~ /macosx/i;
 620     return &quot;watchos&quot; if $xcodeSDK =~ /watchos/i;
 621     return &quot;watchsimulator&quot; if $xcodeSDK =~ /watchsimulator/i;
<span class="line-added"> 622     return &quot;maccatalyst&quot; if $xcodeSDK =~ /maccatalyst/i;</span>
 623     die &quot;Couldn&#39;t determine platform name from Xcode SDK&quot;;
 624 }
 625 
 626 sub XcodeSDKPath
 627 {
 628     determineXcodeSDK();
 629 
 630     die &quot;Can&#39;t find the SDK path because no Xcode SDK was specified&quot; if not $xcodeSDK;
 631     return sdkDirectory($xcodeSDK);
 632 }
 633 
 634 sub xcodeSDKVersion
 635 {
 636     determineXcodeSDK();
 637 
 638     die &quot;Can&#39;t find the SDK version because no Xcode SDK was specified&quot; if !$xcodeSDK;
 639 
 640     chomp(my $sdkVersion = `xcrun --sdk $xcodeSDK --show-sdk-version`);
 641     die &quot;Failed to get SDK version from xcrun&quot; if exitStatus($?);
 642 
 643     return $sdkVersion;
 644 }
 645 
 646 sub programFilesPath
 647 {
 648     return $programFilesPath if defined $programFilesPath;
 649 
 650     $programFilesPath = $ENV{&#39;PROGRAMFILES(X86)&#39;} || $ENV{&#39;PROGRAMFILES&#39;} || &quot;C:\\Program Files&quot;;
 651 
 652     return $programFilesPath;
 653 }
 654 
 655 sub programFilesPathX86
 656 {
 657     my $programFilesPathX86 = $ENV{&#39;PROGRAMFILES(X86)&#39;} || &quot;C:\\Program Files (x86)&quot;;
 658 
 659     return $programFilesPathX86;
 660 }
 661 
<span class="line-modified"> 662 sub visualStudioInstallDirVSWhere</span>
 663 {
<span class="line-modified"> 664     my $vswhere = File::Spec-&gt;catdir(programFilesPathX86(), &quot;Microsoft Visual Studio&quot;, &quot;Installer&quot;, &quot;vswhere.exe&quot;);</span>
<span class="line-modified"> 665     return unless -e $vswhere;</span>
<span class="line-modified"> 666     open(my $handle, &quot;-|&quot;, $vswhere, qw(-nologo -latest -requires Microsoft.Component.MSBuild -property installationPath)) || return;</span>
<span class="line-modified"> 667     my $vsWhereOut = &lt;$handle&gt;;</span>
<span class="line-modified"> 668     $vsWhereOut =~ s/\r?\n//;</span>
<span class="line-modified"> 669     return $vsWhereOut;</span>

































 670 }
 671 
 672 sub visualStudioInstallDir
 673 {
 674     return $vsInstallDir if defined $vsInstallDir;
 675 
 676     if ($ENV{&#39;VSINSTALLDIR&#39;}) {
 677         $vsInstallDir = $ENV{&#39;VSINSTALLDIR&#39;};
 678         $vsInstallDir =~ s|[\\/]$||;
 679     } else {
 680         $vsInstallDir = visualStudioInstallDirVSWhere();
<span class="line-modified"> 681         return unless defined $vsInstallDir;</span>


 682     }
 683     chomp($vsInstallDir = `cygpath &quot;$vsInstallDir&quot;`) if isCygwin();
 684 
 685     print &quot;Using Visual Studio: $vsInstallDir\n&quot;;
 686     return $vsInstallDir;
 687 }
 688 
<span class="line-modified"> 689 sub msBuildPath</span>
 690 {





























 691     my $installDir = visualStudioInstallDir();


 692 
<span class="line-modified"> 693     # FIXME: vswhere.exe should be used to find msbuild.exe after AppleWin will get vswhere with -find switch.</span>
<span class="line-added"> 694     # &lt;https://github.com/Microsoft/vswhere/wiki/Find-MSBuild&gt;</span>
<span class="line-added"> 695     # &lt;https://github.com/Microsoft/vswhere/releases/tag/2.6.6%2Bd9dbe79db3&gt;</span>
<span class="line-added"> 696     my $path = File::Spec-&gt;catdir($installDir, &quot;MSBuild&quot;, &quot;Current&quot;, &quot;bin&quot;, &quot;MSBuild.exe&quot;);</span>
<span class="line-added"> 697     $path = File::Spec-&gt;catdir($installDir, &quot;MSBuild&quot;, &quot;15.0&quot;, &quot;bin&quot;, &quot;MSBuild.exe&quot;) unless -e $path;</span>
 698 
<span class="line-modified"> 699     chomp($path = `cygpath &quot;$path&quot;`) if isCygwin();</span>
<span class="line-modified"> 700 </span>
<span class="line-added"> 701     print &quot;Using MSBuild: $path\n&quot;;</span>
<span class="line-added"> 702     return $path;</span>
 703 }
 704 
 705 sub determineConfigurationForVisualStudio
 706 {
 707     return if defined $configurationForVisualStudio;
 708     determineConfiguration();
 709     # FIXME: We should detect when Debug_All or Production has been chosen.
 710     $configurationForVisualStudio = &quot;/p:Configuration=&quot; . $configuration;
 711 }
 712 
 713 sub usesPerConfigurationBuildDirectory
 714 {
 715     # [Gtk] We don&#39;t have Release/Debug configurations in straight
 716     # autotool builds (non build-webkit). In this case and if
 717     # WEBKIT_OUTPUTDIR exist, use that as our configuration dir. This will
 718     # allows us to run run-webkit-tests without using build-webkit.
 719     return ($ENV{&quot;WEBKIT_OUTPUTDIR&quot;} &amp;&amp; isGtk()) || isAppleWinWebKit() || isJava();
 720 }
 721 
 722 sub determineConfigurationProductDir
 723 {
 724     return if defined $configurationProductDir;
 725     determineBaseProductDir();
 726     determineConfiguration();
 727     if (isAppleWinWebKit() || isWinCairo() || isPlayStation()) {
 728         $configurationProductDir = File::Spec-&gt;catdir($baseProductDir, $configuration);
 729     } else {
 730         if (usesPerConfigurationBuildDirectory()) {
 731             $configurationProductDir = &quot;$baseProductDir&quot;;
 732         } else {
 733             $configurationProductDir = &quot;$baseProductDir/$configuration&quot;;
<span class="line-modified"> 734             $configurationProductDir .= &quot;-&quot; . xcodeSDKPlatformName() if isEmbeddedWebKit() || isMacCatalystWebKit();</span>
 735         }
 736     }
 737 }
 738 
 739 sub setConfigurationProductDir($)
 740 {
 741     ($configurationProductDir) = @_;
 742 }
 743 
 744 sub determineCurrentSVNRevision
 745 {
 746     # We always update the current SVN revision here, and leave the caching
 747     # to currentSVNRevision(), so that changes to the SVN revision while the
 748     # script is running can be picked up by calling this function again.
 749     determineSourceDir();
 750     $currentSVNRevision = svnRevisionForDirectory($sourceDir);
 751     return $currentSVNRevision;
 752 }
 753 
 754 
</pre>
<hr />
<pre>
 764     return $baseProductDir;
 765 }
 766 
 767 sub sourceDir
 768 {
 769     determineSourceDir();
 770     return $sourceDir;
 771 }
 772 
 773 sub productDir
 774 {
 775     determineConfigurationProductDir();
 776     return $configurationProductDir;
 777 }
 778 
 779 sub executableProductDir
 780 {
 781     my $productDirectory = productDir();
 782 
 783     my $binaryDirectory;
<span class="line-modified"> 784     if (isAnyWindows() &amp;&amp; !isPlayStation()) {</span>
 785         $binaryDirectory = isWin64() ? &quot;bin64&quot; : &quot;bin32&quot;;
<span class="line-modified"> 786     } elsif (isGtk() || isJSCOnly() || isWPE() || isPlayStation()) {</span>
 787         $binaryDirectory = &quot;bin&quot;;
 788     } else {
 789         return $productDirectory;
 790     }
 791 
 792     return File::Spec-&gt;catdir($productDirectory, $binaryDirectory);
 793 }
 794 
 795 sub jscProductDir
 796 {
 797     return executableProductDir();
 798 }
 799 
 800 sub configuration()
 801 {
 802     determineConfiguration();
 803     return $configuration;
 804 }
 805 
 806 sub asanIsEnabled()
</pre>
<hr />
<pre>
 844     return !exitStatus(system(&quot;security find-identity -p codesigning | grep &#39;&quot; . IOS_DEVELOPMENT_CERTIFICATE_NAME_PREFIX . &quot;&#39; &gt; /dev/null 2&gt;&amp;1&quot;));
 845 }
 846 
 847 sub argumentsForXcode()
 848 {
 849     my @args = ();
 850     push @args, &quot;DEBUG_INFORMATION_FORMAT=dwarf-with-dsym&quot; if generateDsym();
 851     return @args;
 852 }
 853 
 854 sub XcodeOptions
 855 {
 856     determineBaseProductDir();
 857     determineConfiguration();
 858     determineArchitecture();
 859     determineASanIsEnabled();
 860     determineLTOMode();
 861     determineXcodeSDK();
 862 
 863     my @options;

 864     push @options, &quot;-UseSanitizedBuildSystemEnvironment=YES&quot;;
<span class="line-added"> 865     push @options, &quot;-ShowBuildOperationDuration=YES&quot;;</span>
 866     push @options, (&quot;-configuration&quot;, $configuration);
 867     push @options, (&quot;-xcconfig&quot;, sourceDir() . &quot;/Tools/asan/asan.xcconfig&quot;, &quot;ASAN_IGNORE=&quot; . sourceDir() . &quot;/Tools/asan/webkit-asan-ignore.txt&quot;) if $asanIsEnabled;
 868     push @options, &quot;WK_LTO_MODE=$ltoMode&quot; if $ltoMode;
 869     push @options, @baseProductDirOption;
 870     push @options, &quot;ARCHS=$architecture&quot; if $architecture;
 871     push @options, &quot;SDKROOT=$xcodeSDK&quot; if $xcodeSDK;
 872     if (willUseIOSDeviceSDK()) {
 873         push @options, &quot;ENABLE_BITCODE=NO&quot;;
 874         if (hasIOSDevelopmentCertificate()) {
 875             # FIXME: May match more than one installed development certificate.
 876             push @options, &quot;CODE_SIGN_IDENTITY=&quot; . IOS_DEVELOPMENT_CERTIFICATE_NAME_PREFIX;
 877         } else {
 878             push @options, &quot;CODE_SIGN_IDENTITY=&quot;; # No identity
 879             push @options, &quot;CODE_SIGNING_REQUIRED=NO&quot;;
 880         }
 881     }
 882     push @options, argumentsForXcode();
 883     return @options;
 884 }
 885 
</pre>
<hr />
<pre>
 889 }
 890 
 891 sub XcodeOptionStringNoConfig
 892 {
 893     return join &quot; &quot;, @baseProductDirOption;
 894 }
 895 
 896 sub XcodeCoverageSupportOptions()
 897 {
 898     my @coverageSupportOptions = ();
 899     push @coverageSupportOptions, &quot;GCC_GENERATE_TEST_COVERAGE_FILES=YES&quot;;
 900     push @coverageSupportOptions, &quot;GCC_INSTRUMENT_PROGRAM_FLOW_ARCS=YES&quot;;
 901     return @coverageSupportOptions;
 902 }
 903 
 904 sub XcodeStaticAnalyzerOption()
 905 {
 906     return &quot;RUN_CLANG_STATIC_ANALYZER=YES&quot;;
 907 }
 908 
<span class="line-added"> 909 sub canUseXCBuild()</span>
<span class="line-added"> 910 {</span>
<span class="line-added"> 911     # if (`xcodebuild -version | grep &quot;Build version&quot;` =~ /Build version (\d+)([a-zA-Z])(\d+)([a-zA-Z]?)/) {</span>
<span class="line-added"> 912     #     return $1 &gt;= 11;</span>
<span class="line-added"> 913     # }</span>
<span class="line-added"> 914 </span>
<span class="line-added"> 915     return 0;</span>
<span class="line-added"> 916 }</span>
<span class="line-added"> 917 </span>
 918 my $passedConfiguration;
 919 my $searchedForPassedConfiguration;
 920 sub determinePassedConfiguration
 921 {
 922     return if $searchedForPassedConfiguration;
 923     $searchedForPassedConfiguration = 1;
 924     $passedConfiguration = undef;
 925 
 926     if (checkForArgumentAndRemoveFromARGV(&quot;--debug&quot;)) {
 927         $passedConfiguration = &quot;Debug&quot;;
 928     } elsif(checkForArgumentAndRemoveFromARGV(&quot;--release&quot;)) {
 929         $passedConfiguration = &quot;Release&quot;;
 930     } elsif (checkForArgumentAndRemoveFromARGV(&quot;--profile&quot;) || checkForArgumentAndRemoveFromARGV(&quot;--profiling&quot;)) {
 931         $passedConfiguration = &quot;Profiling&quot;;
 932     }
 933 }
 934 
 935 sub passedConfiguration
 936 {
 937     determinePassedConfiguration();
</pre>
<hr />
<pre>
1045         return &quot;$configurationProductDir/lib/libwebkit2gtk-4.0&quot; . $extension;
1046     }
1047     if (isIOSWebKit()) {
1048         return &quot;$configurationProductDir/$libraryName.framework/$libraryName&quot;;
1049     }
1050     if (isAppleCocoaWebKit()) {
1051         return &quot;$configurationProductDir/$libraryName.framework/Versions/A/$libraryName&quot;;
1052     }
1053     if (isAppleWinWebKit()) {
1054         if ($libraryName eq &quot;JavaScriptCore&quot;) {
1055             return &quot;$baseProductDir/lib/$libraryName.lib&quot;;
1056         } else {
1057             return &quot;$baseProductDir/$libraryName.intermediate/$configuration/$libraryName.intermediate/$libraryName.lib&quot;;
1058         }
1059     }
1060     if (isJava()) {
1061         my $extension = isDarwin() ? &quot;.dylib&quot; : &quot;.so&quot;;
1062         return &quot;$configurationProductDir/lib/libjfxwebkit&quot; . $extension;
1063     }
1064     if (isWPE()) {
<span class="line-modified">1065         return &quot;$configurationProductDir/lib/libWPEWebKit-1.0.so&quot;;</span>
1066     }
1067 
1068     die &quot;Unsupported platform, can&#39;t determine built library locations.\nTry `build-webkit --help` for more information.\n&quot;;
1069 }
1070 
1071 # Check to see that all the frameworks are built.
1072 sub checkFrameworks # FIXME: This is a poor name since only the Mac calls built WebCore a Framework.
1073 {
1074     return if isAnyWindows() || isJava();
1075     my @frameworks = (&quot;JavaScriptCore&quot;, &quot;WebCore&quot;);
1076     push(@frameworks, &quot;WebKit&quot;) if isAppleCocoaWebKit(); # FIXME: This seems wrong, all ports should have a WebKit these days.
1077     for my $framework (@frameworks) {
1078         my $path = builtDylibPathForName($framework);
1079         die &quot;Can&#39;t find built framework at \&quot;$path\&quot;.\n&quot; unless -e $path;
1080     }
1081 }
1082 
1083 sub isInspectorFrontend()
1084 {
1085     determineIsInspectorFrontend();
</pre>
<hr />
<pre>
1190                 if defined $portName;
1191 
1192             $portName = $argToPortName{$arg};
1193         }
1194     }
1195 
1196     return if defined $portName;
1197 
1198     # Port was not selected via command line, use appropriate default value
1199 
1200     if (isAnyWindows()) {
1201         $portName = AppleWin;
1202     } elsif (isDarwin()) {
1203         determineXcodeSDK();
1204         if (willUseIOSDeviceSDK() || willUseIOSSimulatorSDK()) {
1205             $portName = iOS;
1206         } elsif (willUseAppleTVDeviceSDK() || willUseAppleTVSimulatorSDK()) {
1207             $portName = tvOS;
1208         } elsif (willUseWatchDeviceSDK() || willUseWatchSimulatorSDK()) {
1209             $portName = watchOS;
<span class="line-added">1210         } elsif (willUseMacCatalystSDK()) {</span>
<span class="line-added">1211             $portName = MacCatalyst;</span>
1212         } else {
1213             $portName = Mac;
1214         }
1215     } else {
1216         if ($unknownPortProhibited) {
1217             my $portsChoice = join &quot;\n\t&quot;, qw(
1218                 --gtk
1219                 --jsc-only
1220                 --wpe
1221             );
1222             die &quot;Please specify which WebKit port to build using one of the following options:&quot;
1223                 . &quot;\n\t$portsChoice\n&quot;;
1224         }
1225 
1226         # If script is run without arguments we cannot determine port
1227         # TODO: This state should be outlawed
1228         $portName = Unknown;
1229     }
1230 }
1231 
</pre>
<hr />
<pre>
1432 sub isWatchOSWebKit()
1433 {
1434     return portName() eq watchOS;
1435 }
1436 
1437 sub isEmbeddedWebKit()
1438 {
1439     return isIOSWebKit() || isTVOSWebKit() || isWatchOSWebKit();
1440 }
1441 
1442 sub isAppleWebKit()
1443 {
1444     return !isJava() &amp;&amp; (isAppleCocoaWebKit() || isAppleWinWebKit());
1445 }
1446 
1447 sub isAppleMacWebKit()
1448 {
1449     return portName() eq Mac;
1450 }
1451 
<span class="line-added">1452 sub isMacCatalystWebKit()</span>
<span class="line-added">1453 {</span>
<span class="line-added">1454     return portName() eq MacCatalyst;</span>
<span class="line-added">1455 }</span>
<span class="line-added">1456 </span>
1457 sub isAppleCocoaWebKit()
1458 {
<span class="line-modified">1459     return isAppleMacWebKit() || isEmbeddedWebKit() || isMacCatalystWebKit();</span>
1460 }
1461 
1462 sub isAppleWinWebKit()
1463 {
1464     return portName() eq AppleWin;
1465 }
1466 
1467 sub iOSSimulatorDevicesPath
1468 {
1469     return &quot;$ENV{HOME}/Library/Developer/CoreSimulator/Devices&quot;;
1470 }
1471 
1472 sub iOSSimulatorDevices
1473 {
1474     eval &quot;require Foundation&quot;;
1475     my $devicesPath = iOSSimulatorDevicesPath();
1476     opendir(DEVICES, $devicesPath);
1477     my @udids = grep {
1478         $_ =~ m/^[0-9A-F]{8}-([0-9A-F]{4}-){3}[0-9A-F]{12}$/;
1479     } readdir(DEVICES);
</pre>
<hr />
<pre>
1525 sub willUseAppleTVDeviceSDK()
1526 {
1527     return xcodeSDKPlatformName() eq &quot;appletvos&quot;;
1528 }
1529 
1530 sub willUseAppleTVSimulatorSDK()
1531 {
1532     return xcodeSDKPlatformName() eq &quot;appletvsimulator&quot;;
1533 }
1534 
1535 sub willUseWatchDeviceSDK()
1536 {
1537     return xcodeSDKPlatformName() eq &quot;watchos&quot;;
1538 }
1539 
1540 sub willUseWatchSimulatorSDK()
1541 {
1542     return xcodeSDKPlatformName() eq &quot;watchsimulator&quot;;
1543 }
1544 
<span class="line-added">1545 sub willUseMacCatalystSDK()</span>
<span class="line-added">1546 {</span>
<span class="line-added">1547     return xcodeSDKPlatformName() eq &quot;maccatalyst&quot;;</span>
<span class="line-added">1548 }</span>
<span class="line-added">1549 </span>
1550 sub determineNmPath()
1551 {
1552     return if $nmPath;
1553 
1554     if (isAppleCocoaWebKit()) {
1555         $nmPath = `xcrun -find nm`;
1556         chomp $nmPath;
1557     }
1558     $nmPath = &quot;nm&quot; if !$nmPath;
1559 }
1560 
1561 sub nmPath()
1562 {
1563     determineNmPath();
1564     return $nmPath;
1565 }
1566 
1567 sub splitVersionString
1568 {
1569     my $versionString = shift;
</pre>
<hr />
<pre>
1863         }
1864         if (!defined $ENV{&#39;WEBKIT_OUTPUTDIR&#39;} || !$ENV{&#39;WEBKIT_OUTPUTDIR&#39;}) {
1865             print &quot;Warning: You must set the &#39;WebKit_OutputDir&#39; environment variable\n&quot;;
1866             print &quot;         to be able build WebKit from within Visual Studio 2017 and newer.\n\n&quot;;
1867         }
1868         if (!defined $ENV{&#39;MSBUILDDISABLENODEREUSE&#39;} || !$ENV{&#39;MSBUILDDISABLENODEREUSE&#39;}) {
1869             print &quot;Warning: You should set the &#39;MSBUILDDISABLENODEREUSE&#39; environment variable to &#39;1&#39;\n&quot;;
1870             print &quot;         to avoid periodic locked log files when building.\n\n&quot;;
1871         }
1872     }
1873     # FIXME (125180): Remove the following temporary 64-bit support once official support is available.
1874     if (isWin64() and !$ENV{&#39;WEBKIT_64_SUPPORT&#39;}) {
1875         print &quot;Warning: You must set the &#39;WEBKIT_64_SUPPORT&#39; environment variable\n&quot;;
1876         print &quot;         to be able run WebKit or JavaScriptCore tests.\n\n&quot;;
1877     }
1878 }
1879 
1880 sub setupCygwinEnv()
1881 {
1882     return if !isAnyWindows();
<span class="line-modified">1883     return if $msBuildPath;</span>
1884 
1885     my $programFilesPath = programFilesPath();

1886 
1887     print &quot;Building results into: &quot;, baseProductDir(), &quot;\n&quot;;
1888     print &quot;WEBKIT_OUTPUTDIR is set to: &quot;, $ENV{&quot;WEBKIT_OUTPUTDIR&quot;}, &quot;\n&quot;;
1889     print &quot;WEBKIT_LIBRARIES is set to: &quot;, $ENV{&quot;WEBKIT_LIBRARIES&quot;}, &quot;\n&quot;;
1890     # FIXME (125180): Remove the following temporary 64-bit support once official support is available.
1891     print &quot;WEBKIT_64_SUPPORT is set to: &quot;, $ENV{&quot;WEBKIT_64_SUPPORT&quot;}, &quot;\n&quot; if isWin64();
1892 
1893     # We will actually use MSBuild to build WebKit, but we need to find the Visual Studio install (above) to make
1894     # sure we use the right options.
<span class="line-modified">1895     $msBuildPath = msBuildPath();</span>
<span class="line-modified">1896     if (! -e $msBuildPath) {</span>
1897         print &quot;*************************************************************\n&quot;;
<span class="line-modified">1898         print &quot;Cannot find &#39;$msBuildPath&#39;\n&quot;;</span>
1899         print &quot;Please make sure execute that the Microsoft .NET Framework SDK\n&quot;;
1900         print &quot;is installed on this machine.\n&quot;;
1901         print &quot;*************************************************************\n&quot;;
1902         die;
1903     }
1904 }
1905 
1906 sub buildXCodeProject($$@)
1907 {
1908     my ($project, $clean, @extraOptions) = @_;
1909 
1910     if ($clean) {
1911         push(@extraOptions, &quot;-alltargets&quot;);
1912         push(@extraOptions, &quot;clean&quot;);
1913     }
1914 
1915     chomp($ENV{DSYMUTIL_NUM_THREADS} = `sysctl -n hw.activecpu`);
1916     return system &quot;xcodebuild&quot;, &quot;-project&quot;, &quot;$project.xcodeproj&quot;, @extraOptions;
1917 }
1918 
<span class="line-modified">1919 sub getVisualStudioToolset()</span>
1920 {
1921     if (isPlayStation()) {
1922         return &quot;&quot;;
1923     } elsif (isWin64()) {
<span class="line-modified">1924         return &quot;x64&quot;;</span>
1925     } else {
<span class="line-modified">1926         return &quot;Win32&quot;;</span>
<span class="line-added">1927     }</span>
<span class="line-added">1928 }</span>
<span class="line-added">1929 </span>
<span class="line-added">1930 sub getMSBuildPlatformArgument()</span>
<span class="line-added">1931 {</span>
<span class="line-added">1932     my $toolset = getVisualStudioToolset();</span>
<span class="line-added">1933     if (defined($toolset) &amp;&amp; length($toolset)) {</span>
<span class="line-added">1934         return &quot;/p:Platform=$toolset&quot;;</span>
<span class="line-added">1935     }</span>
<span class="line-added">1936     return &quot;&quot;;</span>
<span class="line-added">1937 }</span>
<span class="line-added">1938 </span>
<span class="line-added">1939 sub getCMakeWindowsToolsetArgument()</span>
<span class="line-added">1940 {</span>
<span class="line-added">1941     my $toolset = getVisualStudioToolset();</span>
<span class="line-added">1942     if (defined($toolset) &amp;&amp; length($toolset)) {</span>
<span class="line-added">1943         return &quot;-A $toolset&quot;;</span>
1944     }
<span class="line-added">1945     return &quot;&quot;;</span>
1946 }
1947 
1948 sub buildVisualStudioProject
1949 {
1950     my ($project, $clean) = @_;
1951     setupCygwinEnv();
1952 
1953     my $config = configurationForVisualStudio();
1954 
1955     chomp($project = `cygpath -w &quot;$project&quot;`) if isCygwin();
1956 
1957     my $action = &quot;/t:build&quot;;
1958     if ($clean) {
1959         $action = &quot;/t:clean&quot;;
1960     }
1961 
1962     my $platform = getMSBuildPlatformArgument();
1963     my $logPath = File::Spec-&gt;catdir($baseProductDir, $configuration);
1964     make_path($logPath) unless -d $logPath or $logPath eq &quot;.&quot;;
1965 
1966     my $errorLogFile = File::Spec-&gt;catfile($logPath, &quot;webkit_errors.log&quot;);
1967     chomp($errorLogFile = `cygpath -w &quot;$errorLogFile&quot;`) if isCygwin();
1968     my $errorLogging = &quot;/flp:LogFile=&quot; . $errorLogFile . &quot;;ErrorsOnly&quot;;
1969 
1970     my $warningLogFile = File::Spec-&gt;catfile($logPath, &quot;webkit_warnings.log&quot;);
1971     chomp($warningLogFile = `cygpath -w &quot;$warningLogFile&quot;`) if isCygwin();
1972     my $warningLogging = &quot;/flp1:LogFile=&quot; . $warningLogFile . &quot;;WarningsOnly&quot;;
1973 
1974     my $maxCPUCount = &#39;/maxcpucount:&#39; . numberOfCPUs();
1975 
<span class="line-modified">1976     my @command = ($msBuildPath, &quot;/verbosity:minimal&quot;, $project, $action, $config, $platform, &quot;/fl&quot;, $errorLogging, &quot;/fl1&quot;, $warningLogging, $maxCPUCount);</span>
1977     print join(&quot; &quot;, @command), &quot;\n&quot;;
1978     return system @command;
1979 }
1980 
1981 sub getJhbuildPath()
1982 {
1983     my @jhbuildPath = File::Spec-&gt;splitdir(baseProductDir());
1984     if (isGit() &amp;&amp; isGitBranchBuild() &amp;&amp; gitBranch()) {
1985         pop(@jhbuildPath);
1986     }
1987     if (isGtk()) {
1988         push(@jhbuildPath, &quot;DependenciesGTK&quot;);
1989     } elsif (isJava()) {
1990         push(@jhbuildPath, &quot;DependenciesJava&quot;);
1991     } elsif (isWPE()) {
1992         push(@jhbuildPath, &quot;DependenciesWPE&quot;);
1993     } else {
1994         die &quot;Cannot get JHBuild path for platform that isn&#39;t GTK+ or WPE.\n&quot;;
1995     }
1996     return File::Spec-&gt;catdir(@jhbuildPath);
</pre>
<hr />
<pre>
2063 
2064     if (! -e getFlatpakPath()) {
2065         return 0;
2066     }
2067 
2068     runInFlatpak(@_)
2069 }
2070 
2071 sub wrapperPrefixIfNeeded()
2072 {
2073     if (isJava()) {
2074         return ();
2075     }
2076 
2077     if (isAnyWindows() || isJSCOnly() || isPlayStation()) {
2078         return ();
2079     }
2080     if (isAppleCocoaWebKit()) {
2081         return (&quot;xcrun&quot;);
2082     }
<span class="line-modified">2083     if (shouldUseJhbuild() and ! shouldUseFlatpak()) {</span>
2084         my @prefix = (File::Spec-&gt;catfile(sourceDir(), &quot;Tools&quot;, &quot;jhbuild&quot;, &quot;jhbuild-wrapper&quot;));
2085         if (isGtk()) {
2086             push(@prefix, &quot;--gtk&quot;);
2087         } elsif (isWPE()) {
2088             push(@prefix, &quot;--wpe&quot;);
2089         }
2090         push(@prefix, &quot;run&quot;);
2091 
2092         return @prefix;
2093     }
2094 
2095     return ();
2096 }
2097 
2098 sub shouldUseJhbuild()
2099 {
2100     return ((isGtk() or isWPE()) and -e getJhbuildPath());
2101 }
2102 
2103 sub shouldUseFlatpak()
</pre>
<hr />
<pre>
2153     # delete the images subdirectory would not be here. Directory mtime does not
2154     # percolate upwards when files are added or removed from subdirectories.
2155     my $inspectorUserInterfaceDirectory = File::Spec-&gt;catdir(sourceDir(), &quot;Source&quot;, &quot;WebInspectorUI&quot;, &quot;UserInterface&quot;);
2156     if ($cacheFileModifiedTime &lt; stat($inspectorUserInterfaceDirectory)-&gt;mtime) {
2157         return 1;
2158     }
2159 
2160     my $inspectorImageDirectory = File::Spec-&gt;catdir(sourceDir(), &quot;Source&quot;, &quot;WebInspectorUI&quot;, &quot;UserInterface&quot;, &quot;Images&quot;);
2161     if ($cacheFileModifiedTime &lt; stat($inspectorImageDirectory)-&gt;mtime) {
2162         return 1;
2163     }
2164     }
2165 
2166     if(isAnyWindows()) {
2167         my $winConfiguration = File::Spec-&gt;catdir(sourceDir(), &quot;Source&quot;, &quot;cmake&quot;, &quot;OptionsWin.cmake&quot;);
2168         if ($cacheFileModifiedTime &lt; stat($winConfiguration)-&gt;mtime) {
2169             return 1;
2170         }
2171     }
2172 
<span class="line-added">2173     # If a change on the JHBuild moduleset has been done, we need to clean the cache as well.</span>
<span class="line-added">2174     if (isGtk() || isWPE()) {</span>
<span class="line-added">2175         my $jhbuildRootDirectory = File::Spec-&gt;catdir(getJhbuildPath(), &quot;Root&quot;);</span>
<span class="line-added">2176         # The script update-webkit-libs-jhbuild shall re-generate $jhbuildRootDirectory if the moduleset changed.</span>
<span class="line-added">2177         if (-d $jhbuildRootDirectory &amp;&amp; $cacheFileModifiedTime &lt; stat($jhbuildRootDirectory)-&gt;mtime) {</span>
<span class="line-added">2178             return 1;</span>
<span class="line-added">2179         }</span>
<span class="line-added">2180     }</span>
<span class="line-added">2181 </span>
2182     return 0;
2183 }
2184 
2185 sub removeCMakeCache(@)
2186 {
2187     my (@buildArgs) = @_;
2188     if (shouldRemoveCMakeCache(@buildArgs)) {
2189         my $cmakeCache = cmakeCachePath();
2190         my $cmakeFiles = cmakeFilesPath();
2191         unlink($cmakeCache) if -e $cmakeCache;
2192         rmtree($cmakeFiles) if -d $cmakeFiles;
2193     }
2194 }
2195 
2196 sub canUseNinja(@)
2197 {
2198     if (!defined($shouldNotUseNinja)) {
2199         $shouldNotUseNinja = checkForArgumentAndRemoveFromARGV(&quot;--no-ninja&quot;);
2200     }
2201 
</pre>
<hr />
<pre>
2214     return commandExists(&quot;ninja&quot;) || commandExists(&quot;ninja-build&quot;);
2215 }
2216 
2217 sub canUseEclipseNinjaGenerator(@)
2218 {
2219     # Check that eclipse and eclipse Ninja generator is installed
2220     my $devnull = File::Spec-&gt;devnull();
2221     return commandExists(&quot;eclipse&quot;) &amp;&amp; exitStatus(system(&quot;cmake -N -G &#39;Eclipse CDT4 - Ninja&#39; &gt;$devnull 2&gt;&amp;1&quot;)) == 0;
2222 }
2223 
2224 sub cmakeGeneratedBuildfile(@)
2225 {
2226     my ($willUseNinja) = @_;
2227     if ($willUseNinja) {
2228         return File::Spec-&gt;catfile(baseProductDir(), configuration(), &quot;build.ninja&quot;)
2229     } elsif (isAnyWindows()) {
2230         return File::Spec-&gt;catfile(baseProductDir(), configuration(), &quot;WebKit.sln&quot;)
2231     } else {
2232         return File::Spec-&gt;catfile(baseProductDir(), configuration(), &quot;Makefile&quot;)
2233     }

2234 }
2235 
2236 sub generateBuildSystemFromCMakeProject
2237 {
2238     my ($prefixPath, @cmakeArgs) = @_;
2239     my $config = configuration();
2240     my $port = cmakeBasedPortName();
2241     my $buildPath = File::Spec-&gt;catdir(baseProductDir(), $config);
2242     File::Path::mkpath($buildPath) unless -d $buildPath;
2243     my $originalWorkingDirectory = getcwd();
2244     chdir($buildPath) or die;
2245 
2246     # We try to be smart about when to rerun cmake, so that we can have faster incremental builds.
2247     my $willUseNinja = canUseNinja();
2248     if (-e cmakeCachePath() &amp;&amp; -e cmakeGeneratedBuildfile($willUseNinja)) {
2249         return 0;
2250     }
2251 
2252     my @args;
2253     push @args, &quot;-DPORT=\&quot;$port\&quot;&quot;;
2254     push @args, &quot;-DCMAKE_INSTALL_PREFIX=\&quot;$prefixPath\&quot;&quot; if $prefixPath;
2255     push @args, &quot;-DCMAKE_EXPORT_COMPILE_COMMANDS=ON&quot;;
2256     if ($config =~ /release/i) {
2257         push @args, &quot;-DCMAKE_BUILD_TYPE=Release&quot;;
2258     } elsif ($config =~ /debug/i) {
2259         push @args, &quot;-DCMAKE_BUILD_TYPE=Debug&quot;;
2260     }
2261 
<span class="line-modified">2262     push @args, &quot;-DENABLE_SANITIZERS=address&quot; if asanIsEnabled();</span>
<span class="line-added">2263 </span>
<span class="line-added">2264     push @args, &quot;-DLTO_MODE=$ltoMode&quot; if ltoMode();</span>
2265 
2266     push @args, &#39;-DCMAKE_TOOLCHAIN_FILE=Platform/PlayStation&#39; if isPlayStation();
2267 
2268     if ($willUseNinja) {
2269         push @args, &quot;-G&quot;;
2270         if (canUseEclipseNinjaGenerator()) {
2271             push @args, &quot;&#39;Eclipse CDT4 - Ninja&#39;&quot;;
2272         } else {
2273             push @args, &quot;Ninja&quot;;
2274         }
2275         push @args, &quot;-DUSE_THIN_ARCHIVES=OFF&quot; if isPlayStation();
2276     } elsif (isJava() &amp;&amp; isAnyWindows()) {
2277         push @args, &quot;-G&quot;;
2278         if (isWin64()) {
2279             push @args, &#39;&quot;Visual Studio 15 2017 Win64&quot;&#39;;
2280             push @args, &#39;-DCMAKE_GENERATOR_TOOLSET=&quot;host=x64&quot;&#39;;
2281         } else {
2282             push @args, &#39;&quot;Visual Studio 15 2017&quot;&#39;;
2283         }
<span class="line-modified">2284     } else {</span>
<span class="line-modified">2285         if (isAnyWindows()) {</span>
<span class="line-modified">2286             push @args, getCMakeWindowsToolsetArgument();</span>
<span class="line-modified">2287         }</span>
<span class="line-modified">2288         if ((isAnyWindows() || isPlayStation()) &amp;&amp; defined $ENV{VisualStudioVersion}) {</span>
<span class="line-added">2289             my $var = int($ENV{VisualStudioVersion});</span>
<span class="line-added">2290             push @args, qq(-G &quot;Visual Studio $var&quot;);</span>
<span class="line-added">2291         }</span>
2292     }
2293 
2294     # Do not show progress of generating bindings in interactive Ninja build not to leave noisy lines on tty
2295     push @args, &#39;-DSHOW_BINDINGS_GENERATION_PROGRESS=1&#39; unless ($willUseNinja &amp;&amp; -t STDOUT);
2296 
2297     # Some ports have production mode, but build-webkit should always use developer mode.
2298     push @args, &quot;-DDEVELOPER_MODE=ON&quot; if isGtk() || isJSCOnly() || isWPE() || isWinCairo();
2299 
<span class="line-added">2300     if (architecture() eq &quot;x86_64&quot; &amp;&amp; shouldBuild32Bit() &amp;&amp; !(isJava() &amp;&amp; isCygwin())) {</span>
<span class="line-added">2301         # CMAKE_LIBRARY_ARCHITECTURE is needed to get the right .pc</span>
<span class="line-added">2302         # files in Debian-based systems, for the others</span>
<span class="line-added">2303         # CMAKE_PREFIX_PATH will get us /usr/lib, which should be the</span>
<span class="line-added">2304         # right path for 32bit. See FindPkgConfig.cmake.</span>
<span class="line-added">2305         push @cmakeArgs, &#39;-DFORCE_32BIT=ON -DCMAKE_PREFIX_PATH=&quot;/usr&quot; -DCMAKE_LIBRARY_ARCHITECTURE=x86&#39;;</span>
<span class="line-added">2306         $ENV{&quot;CFLAGS&quot;} =  &quot;-m32&quot; . ($ENV{&quot;CFLAGS&quot;} || &quot;&quot;);</span>
<span class="line-added">2307         $ENV{&quot;CXXFLAGS&quot;} = &quot;-m32&quot; . ($ENV{&quot;CXXFLAGS&quot;} || &quot;&quot;);</span>
<span class="line-added">2308         $ENV{&quot;LDFLAGS&quot;} = &quot;-m32&quot; . ($ENV{&quot;LDFLAGS&quot;} || &quot;&quot;);</span>
<span class="line-added">2309     }</span>
2310     push @args, @cmakeArgs if @cmakeArgs;
2311 
2312     my $cmakeSourceDir = isCygwin() ? windowsSourceDir() : sourceDir();
2313     push @args, &#39;&quot;&#39; . $cmakeSourceDir . &#39;&quot;&#39;;
2314 
2315     # We call system(&quot;cmake @args&quot;) instead of system(&quot;cmake&quot;, @args) so that @args is
2316     # parsed for shell metacharacters.
2317     my $wrapper = join(&quot; &quot;, wrapperPrefixIfNeeded()) . &quot; &quot;;
2318     my $returnCode = systemVerbose($wrapper . &quot;cmake @args&quot;);
2319 
2320     chdir($originalWorkingDirectory);
2321     return $returnCode;
2322 }
2323 
2324 sub buildCMakeGeneratedProject($)
2325 {
2326     my (@makeArgs) = @_;
2327     my $config = configuration();
2328     my $buildPath = File::Spec-&gt;catdir(baseProductDir(), $config);
2329     if (! -d $buildPath) {
2330         die &quot;Must call generateBuildSystemFromCMakeProject() before building CMake project.&quot;;
2331     }
2332 
2333     if ($ENV{VERBOSE} &amp;&amp; canUseNinja()) {
2334         push @makeArgs, &quot;-v&quot;;
2335         push @makeArgs, &quot;-d keeprsp&quot; if (version-&gt;parse(determineNinjaVersion()) &gt;= version-&gt;parse(&quot;1.4.0&quot;));
2336     }
2337 


2338     my $command = &quot;cmake&quot;;
2339     my @args = (&quot;--build&quot;, $buildPath, &quot;--config&quot;, $config);
2340     push @args, (&quot;--&quot;, @makeArgs) if @makeArgs;
2341 
2342     # GTK and JSCOnly can use a build script to preserve colors and pretty-printing.
2343     if ((isGtk() || isJSCOnly()) &amp;&amp; -e &quot;$buildPath/build.sh&quot;) {
2344         chdir &quot;$buildPath&quot; or die;
2345         $command = &quot;$buildPath/build.sh&quot;;
2346         @args = (@makeArgs);
2347     }
2348 
2349     # We call system(&quot;cmake @args&quot;) instead of system(&quot;cmake&quot;, @args) so that @args is
2350     # parsed for shell metacharacters. In particular, @makeArgs may contain such metacharacters.
2351     my $wrapper = join(&quot; &quot;, wrapperPrefixIfNeeded()) . &quot; &quot;;
2352     return systemVerbose($wrapper . &quot;$command @args&quot;);
2353 }
2354 
2355 sub cleanCMakeGeneratedProject()
2356 {
2357     my $config = configuration();
</pre>
<hr />
<pre>
2513     unshift @args, @ARGV;
2514 
2515     return @args;
2516 }
2517 
2518 sub setupMacWebKitEnvironment($)
2519 {
2520     my ($dyldFrameworkPath) = @_;
2521 
2522     $dyldFrameworkPath = File::Spec-&gt;rel2abs($dyldFrameworkPath);
2523 
2524     prependToEnvironmentVariableList(&quot;DYLD_FRAMEWORK_PATH&quot;, $dyldFrameworkPath);
2525     prependToEnvironmentVariableList(&quot;__XPC_DYLD_FRAMEWORK_PATH&quot;, $dyldFrameworkPath);
2526     prependToEnvironmentVariableList(&quot;DYLD_LIBRARY_PATH&quot;, $dyldFrameworkPath);
2527     prependToEnvironmentVariableList(&quot;__XPC_DYLD_LIBRARY_PATH&quot;, $dyldFrameworkPath);
2528     $ENV{WEBKIT_UNSET_DYLD_FRAMEWORK_PATH} = &quot;YES&quot;;
2529 
2530     setUpGuardMallocIfNeeded();
2531 }
2532 
<span class="line-added">2533 sub setupUnixWebKitEnvironment($)</span>
<span class="line-added">2534 {</span>
<span class="line-added">2535     my ($productDir) = @_;</span>
<span class="line-added">2536 </span>
<span class="line-added">2537     $ENV{TEST_RUNNER_INJECTED_BUNDLE_FILENAME} = File::Spec-&gt;catfile($productDir, &quot;lib&quot;, &quot;libTestRunnerInjectedBundle.so&quot;);</span>
<span class="line-added">2538     $ENV{TEST_RUNNER_TEST_PLUGIN_PATH} = File::Spec-&gt;catdir($productDir, &quot;lib&quot;, &quot;plugins&quot;);</span>
<span class="line-added">2539 }</span>
<span class="line-added">2540 </span>
2541 sub setupIOSWebKitEnvironment($)
2542 {
2543     my ($dyldFrameworkPath) = @_;
2544     $dyldFrameworkPath = File::Spec-&gt;rel2abs($dyldFrameworkPath);
2545 
2546     prependToEnvironmentVariableList(&quot;DYLD_FRAMEWORK_PATH&quot;, $dyldFrameworkPath);
2547     prependToEnvironmentVariableList(&quot;DYLD_LIBRARY_PATH&quot;, $dyldFrameworkPath);
2548 
2549     setUpGuardMallocIfNeeded();
2550 }
2551 
2552 sub iosSimulatorApplicationsPath()
2553 {
2554     # FIXME: We should ask simctl for this information, instead of guessing from available runtimes.
2555     my $runtimePath = File::Spec-&gt;catdir(sdkPlatformDirectory(&quot;iphoneos&quot;), &quot;Developer&quot;, &quot;Library&quot;, &quot;CoreSimulator&quot;, &quot;Profiles&quot;, &quot;Runtimes&quot;);
2556     opendir(RUNTIMES, $runtimePath);
2557     my @runtimes = grep {/.*\.simruntime/} readdir(RUNTIMES);
2558     close(RUNTIMES);
2559     my $sult = File::Spec-&gt;catdir($runtimePath, @runtimes ? $runtimes[0] : &quot;iOS.simruntime&quot;, &quot;Contents&quot;, &quot;Resources&quot;, &quot;RuntimeRoot&quot;, &quot;Applications&quot;);
2560     return $sult;
</pre>
<hr />
<pre>
2864 }
2865 
2866 sub execMacWebKitAppForDebugging($)
2867 {
2868     my ($appPath) = @_;
2869     my $architectureSwitch = &quot;--arch&quot;;
2870     my $argumentsSeparator = &quot;--&quot;;
2871 
2872     my $debuggerPath = `xcrun -find lldb`;
2873     chomp $debuggerPath;
2874     die &quot;Can&#39;t find the lldb executable.\n&quot; unless -x $debuggerPath;
2875 
2876     my $productDir = productDir();
2877     setupMacWebKitEnvironment($productDir);
2878 
2879     my @architectureFlags = ($architectureSwitch, architecture());
2880     print &quot;Starting @{[basename($appPath)]} under lldb with DYLD_FRAMEWORK_PATH set to point to built WebKit in $productDir.\n&quot;;
2881     exec { $debuggerPath } $debuggerPath, @architectureFlags, $argumentsSeparator, $appPath, argumentsForRunAndDebugMacWebKitApp() or die;
2882 }
2883 
<span class="line-added">2884 sub execUnixAppForDebugging($)</span>
<span class="line-added">2885 {</span>
<span class="line-added">2886     my ($appPath) = @_;</span>
<span class="line-added">2887 </span>
<span class="line-added">2888     my $debuggerPath = `which gdb | head -1`;</span>
<span class="line-added">2889     chomp $debuggerPath;</span>
<span class="line-added">2890     die &quot;Can&#39;t find the gdb executable.\n&quot; unless -x $debuggerPath;</span>
<span class="line-added">2891 </span>
<span class="line-added">2892     my $productDir = productDir();</span>
<span class="line-added">2893     setupUnixWebKitEnvironment($productDir);</span>
<span class="line-added">2894 </span>
<span class="line-added">2895     my @cmdline = wrapperPrefixIfNeeded();</span>
<span class="line-added">2896     push @cmdline, $debuggerPath, &quot;--args&quot;, $appPath;</span>
<span class="line-added">2897 </span>
<span class="line-added">2898     print &quot;Starting @{[basename($appPath)]} under gdb with build WebKit in $productDir.\n&quot;;</span>
<span class="line-added">2899     exec @cmdline, @ARGV or die;</span>
<span class="line-added">2900 }</span>
<span class="line-added">2901 </span>
2902 sub debugSafari
2903 {
2904     if (isAppleMacWebKit()) {
2905         checkFrameworks();
2906         execMacWebKitAppForDebugging(safariPath());
2907     }
2908 
2909     return 1; # Unsupported platform; can&#39;t debug Safari on this platform.
2910 }
2911 
2912 sub runSafari
2913 {
2914     if (isIOSWebKit()) {
2915         return runIOSWebKitApp(mobileSafariBundle());
2916     }
2917 
2918     if (isAppleMacWebKit()) {
2919         return runMacWebKitApp(safariPath());
2920     }
2921 
</pre>
<hr />
<pre>
2945     if (isAppleMacWebKit()) {
2946         execMacWebKitAppForDebugging(File::Spec-&gt;catfile(productDir(), &quot;MiniBrowser.app&quot;, &quot;Contents&quot;, &quot;MacOS&quot;, &quot;MiniBrowser&quot;));
2947     }
2948     
2949     return 1;
2950 }
2951 
2952 sub runWebKitTestRunner
2953 {
2954     if (isAppleMacWebKit()) {
2955         return runMacWebKitApp(File::Spec-&gt;catfile(productDir(), &quot;WebKitTestRunner&quot;));
2956     }
2957 
2958     return 1;
2959 }
2960 
2961 sub debugWebKitTestRunner
2962 {
2963     if (isAppleMacWebKit()) {
2964         execMacWebKitAppForDebugging(File::Spec-&gt;catfile(productDir(), &quot;WebKitTestRunner&quot;));
<span class="line-added">2965     } elsif (isGtk() or isWPE()) {</span>
<span class="line-added">2966         execUnixAppForDebugging(File::Spec-&gt;catfile(productDir(), &quot;bin&quot;, &quot;WebKitTestRunner&quot;));</span>
2967     }
2968 
2969     return 1;
2970 }
2971 
2972 sub readRegistryString
2973 {
2974     my ($valueName) = @_;
2975     chomp(my $string = `regtool --wow32 get &quot;$valueName&quot;`);
2976     return $string;
2977 }
2978 
2979 sub writeRegistryString
2980 {
2981     my ($valueName, $string) = @_;
2982 
2983     my $error = system &quot;regtool&quot;, &quot;--wow32&quot;, &quot;set&quot;, &quot;-s&quot;, $valueName, $string;
2984 
2985     # On Windows Vista/7 with UAC enabled, regtool will fail to modify the registry, but will still
2986     # return a successful exit code. So we double-check here that the value we tried to write to the
</pre>
</td>
</tr>
</table>
<center><a href="build-webkit.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="webkitperl/FeatureList.pm.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>