<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff modules/javafx.web/src/main/native/Source/WebCore/platform/graphics/MediaPlayer.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="LegacyCDMSession.h.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="MediaPlayer.h.cdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/platform/graphics/MediaPlayer.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 103,75 ***</span>
  }
  #endif
  
  // a null player to make MediaPlayer logic simpler
  
<span class="line-modified">! class NullMediaPlayerPrivate : public MediaPlayerPrivateInterface {</span>
  public:
      explicit NullMediaPlayerPrivate(MediaPlayer*) { }
  
<span class="line-modified">!     void load(const String&amp;) override { }</span>
  #if ENABLE(MEDIA_SOURCE)
<span class="line-modified">!     void load(const String&amp;, MediaSourcePrivateClient*) override { }</span>
  #endif
  #if ENABLE(MEDIA_STREAM)
<span class="line-modified">!     void load(MediaStreamPrivate&amp;) override { }</span>
  #endif
<span class="line-modified">!     void cancelLoad() override { }</span>
  
<span class="line-modified">!     void prepareToPlay() override { }</span>
<span class="line-modified">!     void play() override { }</span>
<span class="line-modified">!     void pause() override { }</span>
  
<span class="line-modified">!     PlatformLayer* platformLayer() const override { return 0; }</span>
  
<span class="line-modified">!     FloatSize naturalSize() const override { return FloatSize(); }</span>
  
<span class="line-modified">!     bool hasVideo() const override { return false; }</span>
<span class="line-modified">!     bool hasAudio() const override { return false; }</span>
  
<span class="line-modified">!     void setVisible(bool) override { }</span>
  
<span class="line-modified">!     double durationDouble() const override { return 0; }</span>
  
<span class="line-modified">!     double currentTimeDouble() const override { return 0; }</span>
<span class="line-modified">!     void seekDouble(double) override { }</span>
<span class="line-modified">!     bool seeking() const override { return false; }</span>
  
<span class="line-modified">!     void setRateDouble(double) override { }</span>
<span class="line-modified">!     void setPreservesPitch(bool) override { }</span>
<span class="line-modified">!     bool paused() const override { return true; }</span>
  
<span class="line-modified">!     void setVolumeDouble(double) override { }</span>
  
<span class="line-modified">!     bool supportsMuting() const override { return false; }</span>
<span class="line-removed">-     void setMuted(bool) override { }</span>
  
<span class="line-modified">!     bool hasClosedCaptions() const override { return false; }</span>
<span class="line-modified">!     void setClosedCaptionsVisible(bool) override { };</span>
  
<span class="line-modified">!     MediaPlayer::NetworkState networkState() const override { return MediaPlayer::Empty; }</span>
<span class="line-modified">!     MediaPlayer::ReadyState readyState() const override { return MediaPlayer::HaveNothing; }</span>
  
<span class="line-modified">!     float maxTimeSeekable() const override { return 0; }</span>
<span class="line-modified">!     double minTimeSeekable() const override { return 0; }</span>
<span class="line-modified">!     std::unique_ptr&lt;PlatformTimeRanges&gt; buffered() const override { return std::make_unique&lt;PlatformTimeRanges&gt;(); }</span>
  
<span class="line-modified">!     double seekableTimeRangesLastModifiedTime() const override { return 0; }</span>
<span class="line-modified">!     double liveUpdateInterval() const override { return 0; }</span>
  
<span class="line-modified">!     unsigned long long totalBytes() const override { return 0; }</span>
<span class="line-modified">!     bool didLoadingProgress() const override { return false; }</span>
  
<span class="line-modified">!     void setSize(const IntSize&amp;) override { }</span>
  
<span class="line-modified">!     void paint(GraphicsContext&amp;, const FloatRect&amp;) override { }</span>
  
<span class="line-modified">!     bool canLoadPoster() const override { return false; }</span>
<span class="line-modified">!     void setPoster(const String&amp;) override { }</span>
  
<span class="line-modified">!     bool hasSingleSecurityOrigin() const override { return true; }</span>
  };
  
  class NullMediaPlayerClient : public MediaPlayerClient {
  public:
  #if !RELEASE_LOG_DISABLED
<span class="line-new-header">--- 103,74 ---</span>
  }
  #endif
  
  // a null player to make MediaPlayer logic simpler
  
<span class="line-modified">! class NullMediaPlayerPrivate final : public MediaPlayerPrivateInterface {</span>
  public:
      explicit NullMediaPlayerPrivate(MediaPlayer*) { }
  
<span class="line-modified">!     void load(const String&amp;) final { }</span>
  #if ENABLE(MEDIA_SOURCE)
<span class="line-modified">!     void load(const String&amp;, MediaSourcePrivateClient*) final { }</span>
  #endif
  #if ENABLE(MEDIA_STREAM)
<span class="line-modified">!     void load(MediaStreamPrivate&amp;) final { }</span>
  #endif
<span class="line-modified">!     void cancelLoad() final { }</span>
  
<span class="line-modified">!     void prepareToPlay() final { }</span>
<span class="line-modified">!     void play() final { }</span>
<span class="line-modified">!     void pause() final { }</span>
  
<span class="line-modified">!     PlatformLayer* platformLayer() const final { return 0; }</span>
  
<span class="line-modified">!     FloatSize naturalSize() const final { return FloatSize(); }</span>
  
<span class="line-modified">!     bool hasVideo() const final { return false; }</span>
<span class="line-modified">!     bool hasAudio() const final { return false; }</span>
  
<span class="line-modified">!     void setVisible(bool) final { }</span>
  
<span class="line-modified">!     double durationDouble() const final { return 0; }</span>
  
<span class="line-modified">!     double currentTimeDouble() const final { return 0; }</span>
<span class="line-modified">!     void seekDouble(double) final { }</span>
<span class="line-modified">!     bool seeking() const final { return false; }</span>
  
<span class="line-modified">!     void setRateDouble(double) final { }</span>
<span class="line-modified">!     void setPreservesPitch(bool) final { }</span>
<span class="line-modified">!     bool paused() const final { return true; }</span>
  
<span class="line-modified">!     void setVolumeDouble(double) final { }</span>
  
<span class="line-modified">!     void setMuted(bool) final { }</span>
  
<span class="line-modified">!     bool hasClosedCaptions() const final { return false; }</span>
<span class="line-modified">!     void setClosedCaptionsVisible(bool) final { };</span>
  
<span class="line-modified">!     MediaPlayer::NetworkState networkState() const final { return MediaPlayer::Empty; }</span>
<span class="line-modified">!     MediaPlayer::ReadyState readyState() const final { return MediaPlayer::HaveNothing; }</span>
  
<span class="line-modified">!     float maxTimeSeekable() const final { return 0; }</span>
<span class="line-modified">!     double minTimeSeekable() const final { return 0; }</span>
<span class="line-modified">!     std::unique_ptr&lt;PlatformTimeRanges&gt; buffered() const final { return makeUnique&lt;PlatformTimeRanges&gt;(); }</span>
  
<span class="line-modified">!     double seekableTimeRangesLastModifiedTime() const final { return 0; }</span>
<span class="line-modified">!     double liveUpdateInterval() const final { return 0; }</span>
  
<span class="line-modified">!     unsigned long long totalBytes() const final { return 0; }</span>
<span class="line-modified">!     bool didLoadingProgress() const final { return false; }</span>
  
<span class="line-modified">!     void setSize(const IntSize&amp;) final { }</span>
  
<span class="line-modified">!     void paint(GraphicsContext&amp;, const FloatRect&amp;) final { }</span>
  
<span class="line-modified">!     bool canLoadPoster() const final { return false; }</span>
<span class="line-modified">!     void setPoster(const String&amp;) final { }</span>
  
<span class="line-modified">!     bool hasSingleSecurityOrigin() const final { return true; }</span>
  };
  
  class NullMediaPlayerClient : public MediaPlayerClient {
  public:
  #if !RELEASE_LOG_DISABLED
</pre>
<hr />
<pre>
<span class="line-old-header">*** 290,19 ***</span>
      ASSERT(supportsType);
  
      mutableInstalledMediaEnginesVector().append(MediaPlayerFactory { WTFMove(constructor), getSupportedTypes, supportsType, originsInMediaCache, clearMediaCache, clearMediaCacheForOrigins, supportsKeySystem });
  }
  
<span class="line-modified">! static const AtomicString&amp; applicationOctetStream()</span>
  {
<span class="line-modified">!     static NeverDestroyed&lt;const AtomicString&gt; applicationOctetStream(&quot;application/octet-stream&quot;, AtomicString::ConstructFromLiteral);</span>
      return applicationOctetStream;
  }
  
<span class="line-modified">! static const AtomicString&amp; textPlain()</span>
  {
<span class="line-modified">!     static NeverDestroyed&lt;const AtomicString&gt; textPlain(&quot;text/plain&quot;, AtomicString::ConstructFromLiteral);</span>
      return textPlain;
  }
  
  static const MediaPlayerFactory* bestMediaEngineForSupportParameters(const MediaEngineSupportParameters&amp; parameters, const MediaPlayerFactory* current = nullptr)
  {
<span class="line-new-header">--- 289,19 ---</span>
      ASSERT(supportsType);
  
      mutableInstalledMediaEnginesVector().append(MediaPlayerFactory { WTFMove(constructor), getSupportedTypes, supportsType, originsInMediaCache, clearMediaCache, clearMediaCacheForOrigins, supportsKeySystem });
  }
  
<span class="line-modified">! static const AtomString&amp; applicationOctetStream()</span>
  {
<span class="line-modified">!     static NeverDestroyed&lt;const AtomString&gt; applicationOctetStream(&quot;application/octet-stream&quot;, AtomString::ConstructFromLiteral);</span>
      return applicationOctetStream;
  }
  
<span class="line-modified">! static const AtomString&amp; textPlain()</span>
  {
<span class="line-modified">!     static NeverDestroyed&lt;const AtomString&gt; textPlain(&quot;text/plain&quot;, AtomString::ConstructFromLiteral);</span>
      return textPlain;
  }
  
  static const MediaPlayerFactory* bestMediaEngineForSupportParameters(const MediaEngineSupportParameters&amp; parameters, const MediaPlayerFactory* current = nullptr)
  {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 359,11 ***</span>
  }
  
  MediaPlayer::MediaPlayer(MediaPlayerClient&amp; client)
      : m_client(&amp;client)
      , m_reloadTimer(*this, &amp;MediaPlayer::reloadTimerFired)
<span class="line-modified">!     , m_private(std::make_unique&lt;NullMediaPlayerPrivate&gt;(this))</span>
  {
  }
  
  MediaPlayer::~MediaPlayer()
  {
<span class="line-new-header">--- 358,11 ---</span>
  }
  
  MediaPlayer::MediaPlayer(MediaPlayerClient&amp; client)
      : m_client(&amp;client)
      , m_reloadTimer(*this, &amp;MediaPlayer::reloadTimerFired)
<span class="line-modified">!     , m_private(makeUnique&lt;NullMediaPlayerPrivate&gt;(this))</span>
  {
  }
  
  MediaPlayer::~MediaPlayer()
  {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 393,11 ***</span>
  #if ENABLE(MEDIA_STREAM)
      m_mediaStream = nullptr;
  #endif
  
      // If the MIME type is missing or is not meaningful, try to figure it out from the URL.
<span class="line-modified">!     AtomicString containerType = m_contentType.containerType();</span>
      if (containerType.isEmpty() || containerType == applicationOctetStream() || containerType == textPlain()) {
          if (m_url.protocolIsData())
              m_contentType = ContentType(mimeTypeFromDataURL(m_url.string()));
          else {
              String lastPathComponent = url.lastPathComponent();
<span class="line-new-header">--- 392,11 ---</span>
  #if ENABLE(MEDIA_STREAM)
      m_mediaStream = nullptr;
  #endif
  
      // If the MIME type is missing or is not meaningful, try to figure it out from the URL.
<span class="line-modified">!     AtomString containerType = m_contentType.containerType();</span>
      if (containerType.isEmpty() || containerType == applicationOctetStream() || containerType == textPlain()) {
          if (m_url.protocolIsData())
              m_contentType = ContentType(mimeTypeFromDataURL(m_url.string()));
          else {
              String lastPathComponent = url.lastPathComponent();
</pre>
<hr />
<pre>
<span class="line-old-header">*** 515,11 ***</span>
              m_private-&gt;load(*m_mediaStream);
          else
  #endif
          m_private-&gt;load(m_url.string());
      } else {
<span class="line-modified">!         m_private = std::make_unique&lt;NullMediaPlayerPrivate&gt;(this);</span>
          client().mediaPlayerEngineUpdated(this);
          client().mediaPlayerResourceNotSupported(this);
      }
  
      m_initializingMediaEngine = false;
<span class="line-new-header">--- 514,11 ---</span>
              m_private-&gt;load(*m_mediaStream);
          else
  #endif
          m_private-&gt;load(m_url.string());
      } else {
<span class="line-modified">!         m_private = makeUnique&lt;NullMediaPlayerPrivate&gt;(this);</span>
          client().mediaPlayerEngineUpdated(this);
          client().mediaPlayerResourceNotSupported(this);
      }
  
      m_initializingMediaEngine = false;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 566,13 ***</span>
  void MediaPlayer::pause()
  {
      m_private-&gt;pause();
  }
  
<span class="line-modified">! void MediaPlayer::setShouldBufferData(bool shouldBuffer)</span>
  {
<span class="line-modified">!     m_private-&gt;setShouldBufferData(shouldBuffer);</span>
  }
  
  #if ENABLE(LEGACY_ENCRYPTED_MEDIA)
  
  std::unique_ptr&lt;LegacyCDMSession&gt; MediaPlayer::createSession(const String&amp; keySystem, LegacyCDMSessionClient* client)
<span class="line-new-header">--- 565,13 ---</span>
  void MediaPlayer::pause()
  {
      m_private-&gt;pause();
  }
  
<span class="line-modified">! void MediaPlayer::setBufferingPolicy(BufferingPolicy policy)</span>
  {
<span class="line-modified">!     m_private-&gt;setBufferingPolicy(policy);</span>
  }
  
  #if ENABLE(LEGACY_ENCRYPTED_MEDIA)
  
  std::unique_ptr&lt;LegacyCDMSession&gt; MediaPlayer::createSession(const String&amp; keySystem, LegacyCDMSessionClient* client)
</pre>
<hr />
<pre>
<span class="line-old-header">*** 780,13 ***</span>
  }
  
  void MediaPlayer::setVolume(double volume)
  {
      m_volume = volume;
<span class="line-modified">! </span>
<span class="line-removed">-     if (m_private-&gt;supportsMuting() || !m_muted)</span>
<span class="line-removed">-         m_private-&gt;setVolumeDouble(volume);</span>
  }
  
  bool MediaPlayer::muted() const
  {
      return m_muted;
<span class="line-new-header">--- 779,11 ---</span>
  }
  
  void MediaPlayer::setVolume(double volume)
  {
      m_volume = volume;
<span class="line-modified">!     m_private-&gt;setVolumeDouble(volume);</span>
  }
  
  bool MediaPlayer::muted() const
  {
      return m_muted;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 794,14 ***</span>
  
  void MediaPlayer::setMuted(bool muted)
  {
      m_muted = muted;
  
<span class="line-modified">!     if (m_private-&gt;supportsMuting())</span>
<span class="line-removed">-         m_private-&gt;setMuted(muted);</span>
<span class="line-removed">-     else</span>
<span class="line-removed">-         m_private-&gt;setVolume(muted ? 0 : m_volume);</span>
  }
  
  bool MediaPlayer::hasClosedCaptions() const
  {
      return m_private-&gt;hasClosedCaptions();
<span class="line-new-header">--- 791,11 ---</span>
  
  void MediaPlayer::setMuted(bool muted)
  {
      m_muted = muted;
  
<span class="line-modified">!     m_private-&gt;setMuted(muted);</span>
  }
  
  bool MediaPlayer::hasClosedCaptions() const
  {
      return m_private-&gt;hasClosedCaptions();
</pre>
<hr />
<pre>
<span class="line-old-header">*** 923,11 ***</span>
  
  MediaPlayer::SupportsType MediaPlayer::supportsType(const MediaEngineSupportParameters&amp; parameters)
  {
      // 4.8.10.3 MIME types - The canPlayType(type) method must return the empty string if type is a type that the
      // user agent knows it cannot render or is the type &quot;application/octet-stream&quot;
<span class="line-modified">!     AtomicString containerType = parameters.type.containerType();</span>
      if (containerType == applicationOctetStream())
          return IsNotSupported;
  
      const MediaPlayerFactory* engine = bestMediaEngineForSupportParameters(parameters);
      if (!engine)
<span class="line-new-header">--- 917,11 ---</span>
  
  MediaPlayer::SupportsType MediaPlayer::supportsType(const MediaEngineSupportParameters&amp; parameters)
  {
      // 4.8.10.3 MIME types - The canPlayType(type) method must return the empty string if type is a type that the
      // user agent knows it cannot render or is the type &quot;application/octet-stream&quot;
<span class="line-modified">!     AtomString containerType = parameters.type.containerType();</span>
      if (containerType == applicationOctetStream())
          return IsNotSupported;
  
      const MediaPlayerFactory* engine = bestMediaEngineForSupportParameters(parameters);
      if (!engine)
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1501,11 ***</span>
  void MediaPlayerFactorySupport::callRegisterMediaEngine(MediaEngineRegister registerMediaEngine)
  {
      registerMediaEngine(addMediaEngine);
  }
  
<span class="line-modified">! bool MediaPlayer::doesHaveAttribute(const AtomicString&amp; attribute, AtomicString* value) const</span>
  {
      return client().doesHaveAttribute(attribute, value);
  }
  
  #if PLATFORM(IOS_FAMILY)
<span class="line-new-header">--- 1495,11 ---</span>
  void MediaPlayerFactorySupport::callRegisterMediaEngine(MediaEngineRegister registerMediaEngine)
  {
      registerMediaEngine(addMediaEngine);
  }
  
<span class="line-modified">! bool MediaPlayer::doesHaveAttribute(const AtomString&amp; attribute, AtomString* value) const</span>
  {
      return client().doesHaveAttribute(attribute, value);
  }
  
  #if PLATFORM(IOS_FAMILY)
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1643,8 ***</span>
<span class="line-new-header">--- 1637,24 ---</span>
      static_assert(static_cast&lt;size_t&gt;(MediaPlayerEnums::MayBeSupported) == 2, &quot;MediaPlayerEnums::MayBeSupported is not 2 as expected&quot;);
      ASSERT(static_cast&lt;size_t&gt;(enumerationValue) &lt; WTF_ARRAY_LENGTH(values));
      return values[static_cast&lt;size_t&gt;(enumerationValue)];
  }
  
<span class="line-added">+ String convertEnumerationToString(MediaPlayerEnums::BufferingPolicy enumerationValue)</span>
<span class="line-added">+ {</span>
<span class="line-added">+     static const NeverDestroyed&lt;String&gt; values[] = {</span>
<span class="line-added">+         MAKE_STATIC_STRING_IMPL(&quot;Default&quot;),</span>
<span class="line-added">+         MAKE_STATIC_STRING_IMPL(&quot;LimitReadAhead&quot;),</span>
<span class="line-added">+         MAKE_STATIC_STRING_IMPL(&quot;MakeResourcesPurgeable&quot;),</span>
<span class="line-added">+         MAKE_STATIC_STRING_IMPL(&quot;PurgeResources&quot;),</span>
<span class="line-added">+     };</span>
<span class="line-added">+     static_assert(!static_cast&lt;size_t&gt;(MediaPlayerEnums::BufferingPolicy::Default), &quot;MediaPlayerEnums::Default is not 0 as expected&quot;);</span>
<span class="line-added">+     static_assert(static_cast&lt;size_t&gt;(MediaPlayerEnums::BufferingPolicy::LimitReadAhead) == 1, &quot;MediaPlayerEnums::LimitReadAhead is not 1 as expected&quot;);</span>
<span class="line-added">+     static_assert(static_cast&lt;size_t&gt;(MediaPlayerEnums::BufferingPolicy::MakeResourcesPurgeable) == 2, &quot;MediaPlayerEnums::MakeResourcesPurgeable is not 2 as expected&quot;);</span>
<span class="line-added">+     static_assert(static_cast&lt;size_t&gt;(MediaPlayerEnums::BufferingPolicy::PurgeResources) == 3, &quot;MediaPlayerEnums::PurgeResources is not 3 as expected&quot;);</span>
<span class="line-added">+     ASSERT(static_cast&lt;size_t&gt;(enumerationValue) &lt; WTF_ARRAY_LENGTH(values));</span>
<span class="line-added">+     return values[static_cast&lt;size_t&gt;(enumerationValue)];</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
  }
  
  #endif
</pre>
<center><a href="LegacyCDMSession.h.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="MediaPlayer.h.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>