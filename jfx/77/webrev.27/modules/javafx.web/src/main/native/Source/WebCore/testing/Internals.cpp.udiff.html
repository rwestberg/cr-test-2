<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff modules/javafx.web/src/main/native/Source/WebCore/testing/Internals.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="InternalSettings.idl.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="Internals.h.udiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/testing/Internals.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -45,37 +45,43 @@</span>
  #include &quot;CacheStorageProvider.h&quot;
  #include &quot;CachedImage.h&quot;
  #include &quot;CachedResourceLoader.h&quot;
  #include &quot;CertificateInfo.h&quot;
  #include &quot;Chrome.h&quot;
<span class="udiff-line-added">+ #include &quot;ChromeClient.h&quot;</span>
  #include &quot;ClientOrigin.h&quot;
  #include &quot;ComposedTreeIterator.h&quot;
  #include &quot;CookieJar.h&quot;
  #include &quot;Cursor.h&quot;
<span class="udiff-line-added">+ #include &quot;CustomHeaderFields.h&quot;</span>
  #include &quot;DOMRect.h&quot;
  #include &quot;DOMRectList.h&quot;
  #include &quot;DOMStringList.h&quot;
  #include &quot;DOMWindow.h&quot;
  #include &quot;DeprecatedGlobalSettings.h&quot;
<span class="udiff-line-added">+ #include &quot;DiagnosticLoggingClient.h&quot;</span>
  #include &quot;DisabledAdaptations.h&quot;
  #include &quot;DisplayList.h&quot;
  #include &quot;Document.h&quot;
  #include &quot;DocumentLoader.h&quot;
  #include &quot;DocumentMarkerController.h&quot;
  #include &quot;DocumentTimeline.h&quot;
  #include &quot;Editor.h&quot;
  #include &quot;Element.h&quot;
  #include &quot;EventHandler.h&quot;
<span class="udiff-line-added">+ #include &quot;EventListener.h&quot;</span>
<span class="udiff-line-added">+ #include &quot;EventNames.h&quot;</span>
  #include &quot;ExtendableEvent.h&quot;
  #include &quot;ExtensionStyleSheets.h&quot;
  #include &quot;FetchResponse.h&quot;
  #include &quot;File.h&quot;
  #include &quot;FontCache.h&quot;
  #include &quot;FormController.h&quot;
  #include &quot;Frame.h&quot;
  #include &quot;FrameLoader.h&quot;
  #include &quot;FrameView.h&quot;
<span class="udiff-line-added">+ #include &quot;FullscreenManager.h&quot;</span>
  #include &quot;GCObservation.h&quot;
  #include &quot;GridPosition.h&quot;
  #include &quot;HEVCUtilities.h&quot;
  #include &quot;HTMLAnchorElement.h&quot;
  #include &quot;HTMLCanvasElement.h&quot;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -91,12 +97,10 @@</span>
  #include &quot;HTMLTextAreaElement.h&quot;
  #include &quot;HTMLVideoElement.h&quot;
  #include &quot;HistoryController.h&quot;
  #include &quot;HistoryItem.h&quot;
  #include &quot;HitTestResult.h&quot;
<span class="udiff-line-removed">- #include &quot;IDBRequest.h&quot;</span>
<span class="udiff-line-removed">- #include &quot;IDBTransaction.h&quot;</span>
  #include &quot;InspectorClient.h&quot;
  #include &quot;InspectorController.h&quot;
  #include &quot;InspectorFrontendClientLocal.h&quot;
  #include &quot;InspectorOverlay.h&quot;
  #include &quot;InstrumentingAgents.h&quot;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -104,20 +108,22 @@</span>
  #include &quot;InternalSettings.h&quot;
  #include &quot;JSImageData.h&quot;
  #include &quot;LibWebRTCProvider.h&quot;
  #include &quot;LoaderStrategy.h&quot;
  #include &quot;MallocStatistics.h&quot;
<span class="udiff-line-added">+ #include &quot;MediaDevices.h&quot;</span>
  #include &quot;MediaEngineConfigurationFactory.h&quot;
  #include &quot;MediaPlayer.h&quot;
  #include &quot;MediaProducer.h&quot;
  #include &quot;MediaResourceLoader.h&quot;
  #include &quot;MediaStreamTrack.h&quot;
  #include &quot;MemoryCache.h&quot;
  #include &quot;MemoryInfo.h&quot;
  #include &quot;MockLibWebRTCPeerConnection.h&quot;
  #include &quot;MockPageOverlay.h&quot;
  #include &quot;MockPageOverlayClient.h&quot;
<span class="udiff-line-added">+ #include &quot;NavigatorMediaDevices.h&quot;</span>
  #include &quot;NetworkLoadInformation.h&quot;
  #include &quot;Page.h&quot;
  #include &quot;PageCache.h&quot;
  #include &quot;PageOverlay.h&quot;
  #include &quot;PathUtilities.h&quot;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -211,10 +217,11 @@</span>
  #endif
  
  #if ENABLE(VIDEO_TRACK)
  #include &quot;CaptionUserPreferences.h&quot;
  #include &quot;PageGroup.h&quot;
<span class="udiff-line-added">+ #include &quot;TextTrackCueGeneric.h&quot;</span>
  #endif
  
  #if ENABLE(VIDEO)
  #include &quot;HTMLMediaElement.h&quot;
  #include &quot;TimeRanges.h&quot;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -264,10 +271,15 @@</span>
  
  #if ENABLE(POINTER_LOCK)
  #include &quot;PointerLockController.h&quot;
  #endif
  
<span class="udiff-line-added">+ #if ENABLE(INDEXED_DATABASE)</span>
<span class="udiff-line-added">+ #include &quot;IDBRequest.h&quot;</span>
<span class="udiff-line-added">+ #include &quot;IDBTransaction.h&quot;</span>
<span class="udiff-line-added">+ #endif</span>
<span class="udiff-line-added">+ </span>
  #if USE(QUICK_LOOK)
  #include &quot;MockPreviewLoaderClient.h&quot;
  #include &quot;PreviewLoader.h&quot;
  #endif
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -318,34 +330,25 @@</span>
      String localizedStringsURL() final { return String(); }
      void inspectedURLChanged(const String&amp;) final { }
      void showCertificate(const CertificateInfo&amp;) final { }
      void setAttachedWindowHeight(unsigned) final { }
      void setAttachedWindowWidth(unsigned) final { }
<span class="udiff-line-added">+     void setSheetRect(const FloatRect&amp;) final { }</span>
  
      void sendMessageToFrontend(const String&amp; message) final;
      ConnectionType connectionType() const final { return ConnectionType::Local; }
  
<span class="udiff-line-removed">-     Page* frontendPage() const</span>
<span class="udiff-line-removed">-     {</span>
<span class="udiff-line-removed">-         if (!m_frontendWindow || !m_frontendWindow-&gt;document())</span>
<span class="udiff-line-removed">-             return nullptr;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-         return m_frontendWindow-&gt;document()-&gt;page();</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
      RefPtr&lt;DOMWindow&gt; m_frontendWindow;
<span class="udiff-line-removed">-     InspectorController&amp; m_frontendController;</span>
  };
  
  InspectorStubFrontend::InspectorStubFrontend(Page&amp; inspectedPage, RefPtr&lt;DOMWindow&gt;&amp;&amp; frontendWindow)
<span class="udiff-line-modified-removed">-     : InspectorFrontendClientLocal(&amp;inspectedPage.inspectorController(), frontendWindow-&gt;document()-&gt;page(), std::make_unique&lt;InspectorFrontendClientLocal::Settings&gt;())</span>
<span class="udiff-line-modified-added">+     : InspectorFrontendClientLocal(&amp;inspectedPage.inspectorController(), frontendWindow-&gt;document()-&gt;page(), makeUnique&lt;InspectorFrontendClientLocal::Settings&gt;())</span>
      , m_frontendWindow(frontendWindow.copyRef())
<span class="udiff-line-removed">-     , m_frontendController(frontendPage()-&gt;inspectorController())</span>
  {
      ASSERT_ARG(frontendWindow, frontendWindow);
  
<span class="udiff-line-modified-removed">-     m_frontendController.setInspectorFrontendClient(this);</span>
<span class="udiff-line-modified-added">+     frontendPage()-&gt;inspectorController().setInspectorFrontendClient(this);</span>
      inspectedPage.inspectorController().connectFrontend(*this);
  }
  
  InspectorStubFrontend::~InspectorStubFrontend()
  {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -355,22 +358,20 @@</span>
  void InspectorStubFrontend::closeWindow()
  {
      if (!m_frontendWindow)
          return;
  
<span class="udiff-line-modified-removed">-     m_frontendController.setInspectorFrontendClient(nullptr);</span>
<span class="udiff-line-modified-added">+     frontendPage()-&gt;inspectorController().setInspectorFrontendClient(nullptr);</span>
      inspectedPage()-&gt;inspectorController().disconnectFrontend(*this);
  
      m_frontendWindow-&gt;close();
      m_frontendWindow = nullptr;
  }
  
  void InspectorStubFrontend::sendMessageToFrontend(const String&amp; message)
  {
<span class="udiff-line-modified-removed">-     ASSERT_ARG(message, !message.isEmpty());</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     InspectorClient::doDispatchMessageOnFrontendPage(frontendPage(), message);</span>
<span class="udiff-line-modified-added">+     dispatchMessageAsync(message);</span>
  }
  
  static bool markerTypeFrom(const String&amp; markerType, DocumentMarker::MarkerType&amp; result)
  {
      if (equalLettersIgnoringASCIICase(markerType, &quot;spelling&quot;))
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -446,19 +447,20 @@</span>
  
      page.setDefersLoading(false);
  
      page.mainFrame().setTextZoomFactor(1.0f);
  
<span class="udiff-line-modified-removed">-     page.setCompositingPolicyOverride(WTF::nullopt);</span>
<span class="udiff-line-modified-added">+     page.setCompositingPolicyOverride(WebCore::CompositingPolicy::Normal);</span>
  
      FrameView* mainFrameView = page.mainFrame().view();
      if (mainFrameView) {
          page.setHeaderHeight(0);
          page.setFooterHeight(0);
          page.setTopContentInset(0);
          mainFrameView-&gt;setUseFixedLayout(false);
          mainFrameView-&gt;setFixedLayoutSize(IntSize());
<span class="udiff-line-added">+         mainFrameView-&gt;enableAutoSizeMode(false, { });</span>
  #if USE(COORDINATED_GRAPHICS)
          mainFrameView-&gt;setFixedVisibleContentRect(IntRect());
  #endif
          if (auto* backing = mainFrameView-&gt;tiledBacking())
              backing-&gt;setTileSizeUpdateDelayDisabledForTesting(false);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -481,11 +483,12 @@</span>
      page.applicationCacheStorage().setDefaultOriginQuota(ApplicationCacheStorage::noQuota());
  #if ENABLE(VIDEO)
      PlatformMediaSessionManager::sharedManager().resetRestrictions();
      PlatformMediaSessionManager::sharedManager().setWillIgnoreSystemInterruptions(true);
  #endif
<span class="udiff-line-modified-removed">- #if HAVE(ACCESSIBILITY)</span>
<span class="udiff-line-modified-added">+     PlatformMediaSessionManager::sharedManager().setIsPlayingToAutomotiveHeadUnit(false);</span>
<span class="udiff-line-added">+ #if ENABLE(ACCESSIBILITY)</span>
      AXObjectCache::setEnhancedUserInterfaceAccessibility(false);
      AXObjectCache::disableAccessibility();
  #endif
  
      MockPageOverlayClient::singleton().uninstallAllOverlays();
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -512,18 +515,23 @@</span>
  #if USE(LIBWEBRTC)
      auto&amp; rtcProvider = page.libWebRTCProvider();
      WebCore::useRealRTCPeerConnectionFactory(rtcProvider);
      rtcProvider.disableNonLocalhostConnections();
      RuntimeEnabledFeatures::sharedFeatures().setWebRTCVP8CodecEnabled(true);
<span class="udiff-line-added">+     page.settings().setWebRTCEncryptionEnabled(true);</span>
  #endif
  
      page.settings().setStorageAccessAPIEnabled(false);
      page.setFullscreenAutoHideDuration(0_s);
      page.setFullscreenInsets({ });
      page.setFullscreenControlsHidden(false);
  
      MediaEngineConfigurationFactory::disableMock();
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ #if ENABLE(MEDIA_STREAM)</span>
<span class="udiff-line-added">+     RuntimeEnabledFeatures::sharedFeatures().setInterruptAudioOnPageVisibilityChangeEnabled(false);</span>
<span class="udiff-line-added">+ #endif</span>
  }
  
  Internals::Internals(Document&amp; document)
      : ContextDestructionObserver(&amp;document)
  #if ENABLE(MEDIA_STREAM)
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -557,11 +565,11 @@</span>
  
  #if ENABLE(APPLE_PAY)
      auto* frame = document.frame();
      if (frame &amp;&amp; frame-&gt;page() &amp;&amp; frame-&gt;isMainFrame()) {
          auto mockPaymentCoordinator = new MockPaymentCoordinator(*frame-&gt;page());
<span class="udiff-line-modified-removed">-         frame-&gt;page()-&gt;setPaymentCoordinator(std::make_unique&lt;PaymentCoordinator&gt;(*mockPaymentCoordinator));</span>
<span class="udiff-line-modified-added">+         frame-&gt;page()-&gt;setPaymentCoordinator(makeUnique&lt;PaymentCoordinator&gt;(*mockPaymentCoordinator));</span>
      }
  #endif
  }
  
  Document* Internals::contextDocument() const
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -826,10 +834,22 @@</span>
  {
      auto* bitmapImage = bitmapImageFromImageElement(element);
      return bitmapImage ? bitmapImage-&gt;currentFrame() : 0;
  }
  
<span class="udiff-line-added">+ unsigned Internals::imageFrameCount(HTMLImageElement&amp; element)</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     auto* bitmapImage = bitmapImageFromImageElement(element);</span>
<span class="udiff-line-added">+     return bitmapImage ? bitmapImage-&gt;frameCount() : 0;</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ float Internals::imageFrameDurationAtIndex(HTMLImageElement&amp; element, unsigned index)</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     auto* bitmapImage = bitmapImageFromImageElement(element);</span>
<span class="udiff-line-added">+     return bitmapImage ? bitmapImage-&gt;frameDurationAtIndex(index).value() : 0;</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
  void Internals::setImageFrameDecodingDuration(HTMLImageElement&amp; element, float duration)
  {
      if (auto* bitmapImage = bitmapImageFromImageElement(element))
          bitmapImage-&gt;setFrameDecodingDurationForTesting(Seconds { duration });
  }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -844,10 +864,15 @@</span>
  {
      auto* image = imageFromImageElement(element);
      return image &amp;&amp; (image-&gt;isAnimating() || image-&gt;animationPending());
  }
  
<span class="udiff-line-added">+ unsigned Internals::imagePendingDecodePromisesCountForTesting(HTMLImageElement&amp; element)</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     return element.pendingDecodePromisesCountForTesting();</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
  void Internals::setClearDecoderAfterAsyncFrameRequestForTesting(HTMLImageElement&amp; element, bool enabled)
  {
      if (auto* bitmapImage = bitmapImageFromImageElement(element))
          bitmapImage-&gt;setClearDecoderAfterAsyncFrameRequestForTesting(enabled);
  }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1025,11 +1050,11 @@</span>
  
  ExceptionOr&lt;bool&gt; Internals::pauseAnimationAtTimeOnElement(const String&amp; animationName, double pauseTime, Element&amp; element)
  {
      if (pauseTime &lt; 0)
          return Exception { InvalidAccessError };
<span class="udiff-line-modified-removed">-     return frame()-&gt;animation().pauseAnimationAtTime(element, AtomicString(animationName), pauseTime);</span>
<span class="udiff-line-modified-added">+     return frame()-&gt;animation().pauseAnimationAtTime(element, AtomString(animationName), pauseTime);</span>
  }
  
  ExceptionOr&lt;bool&gt; Internals::pauseAnimationAtTimeOnPseudoElement(const String&amp; animationName, double pauseTime, Element&amp; element, const String&amp; pseudoId)
  {
      if (pauseTime &lt; 0)
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1040,11 +1065,11 @@</span>
  
      PseudoElement* pseudoElement = pseudoId == &quot;before&quot; ? element.beforePseudoElement() : element.afterPseudoElement();
      if (!pseudoElement)
          return Exception { InvalidAccessError };
  
<span class="udiff-line-modified-removed">-     return frame()-&gt;animation().pauseAnimationAtTime(*pseudoElement, AtomicString(animationName), pauseTime);</span>
<span class="udiff-line-modified-added">+     return frame()-&gt;animation().pauseAnimationAtTime(*pseudoElement, AtomString(animationName), pauseTime);</span>
  }
  
  ExceptionOr&lt;bool&gt; Internals::pauseTransitionAtTimeOnElement(const String&amp; propertyName, double pauseTime, Element&amp; element)
  {
      if (pauseTime &lt; 0)
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1099,11 +1124,11 @@</span>
  
      String representation = externalRepresentation(&amp;element);
      if (representation.isEmpty())
          return Exception { InvalidAccessError };
  
<span class="udiff-line-modified-removed">-     return WTFMove(representation);</span>
<span class="udiff-line-modified-added">+     return representation;</span>
  }
  
  bool Internals::hasPausedImageAnimations(Element&amp; element)
  {
      return element.renderer() &amp;&amp; element.renderer()-&gt;hasPausedImageAnimations();
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1395,11 +1420,11 @@</span>
          return;
      SpeechSynthesis* synthesis = DOMWindowSpeechSynthesis::speechSynthesis(*document-&gt;domWindow());
      if (!synthesis)
          return;
  
<span class="udiff-line-modified-removed">-     synthesis-&gt;setPlatformSynthesizer(std::make_unique&lt;PlatformSpeechSynthesizerMock&gt;(synthesis));</span>
<span class="udiff-line-modified-added">+     synthesis-&gt;setPlatformSynthesizer(makeUnique&lt;PlatformSpeechSynthesizerMock&gt;(synthesis));</span>
  }
  
  #endif
  
  #if ENABLE(WEB_RTC)
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1412,13 +1437,11 @@</span>
      connection.emulatePlatformEvent(action);
  }
  
  void Internals::useMockRTCPeerConnectionFactory(const String&amp; testCase)
  {
<span class="udiff-line-modified-removed">-     // FIXME: We should upgrade mocks to support unified plan APIs, until then use plan B in tests using mock.</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     ASSERT(!RuntimeEnabledFeatures::sharedFeatures().webRTCUnifiedPlanEnabled());</span>
<span class="udiff-line-modified-added">+     ASSERT(RuntimeEnabledFeatures::sharedFeatures().webRTCUnifiedPlanEnabled());</span>
      if (!LibWebRTCProvider::webRTCAvailable())
          return;
  
  #if USE(LIBWEBRTC)
      Document* document = contextDocument();
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1475,13 +1498,25 @@</span>
  
  void Internals::applyRotationForOutgoingVideoSources(RTCPeerConnection&amp; connection)
  {
      connection.applyRotationForOutgoingVideoSources();
  }
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ void Internals::setEnableWebRTCEncryption(bool value)</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+ #if USE(LIBWEBRTC)</span>
<span class="udiff-line-added">+     if (auto* page = contextDocument()-&gt;page())</span>
<span class="udiff-line-added">+         page-&gt;settings().setWebRTCEncryptionEnabled(value);</span>
<span class="udiff-line-added">+ #endif</span>
<span class="udiff-line-added">+ }</span>
  #endif
  
  #if ENABLE(MEDIA_STREAM)
<span class="udiff-line-added">+ void Internals::setShouldInterruptAudioOnPageVisibilityChange(bool shouldInterrupt)</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     RuntimeEnabledFeatures::sharedFeatures().setInterruptAudioOnPageVisibilityChangeEnabled(shouldInterrupt);</span>
<span class="udiff-line-added">+ }</span>
  
  void Internals::setMockMediaCaptureDevicesEnabled(bool enabled)
  {
      Document* document = contextDocument();
      if (auto* page = document-&gt;page())
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1543,19 +1578,10 @@</span>
      Highlight highlight;
      document-&gt;page()-&gt;inspectorController().getHighlight(highlight, InspectorOverlay::CoordinateSystem::View);
      return DOMRectList::create(highlight.quads);
  }
  
<span class="udiff-line-removed">- ExceptionOr&lt;String&gt; Internals::inspectorHighlightObject()</span>
<span class="udiff-line-removed">- {</span>
<span class="udiff-line-removed">-     Document* document = contextDocument();</span>
<span class="udiff-line-removed">-     if (!document || !document-&gt;page())</span>
<span class="udiff-line-removed">-         return Exception { InvalidAccessError };</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     return document-&gt;page()-&gt;inspectorController().buildObjectForHighlightedNodes()-&gt;toJSONString();</span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-removed">- </span>
  ExceptionOr&lt;unsigned&gt; Internals::markerCountForNode(Node&amp; node, const String&amp; markerType)
  {
      OptionSet&lt;DocumentMarker::MarkerType&gt; markerTypes;
      if (!markerTypesFrom(markerType, markerTypes))
          return Exception { SyntaxError };
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1613,17 +1639,17 @@</span>
  
      StringBuilder rectString;
      rectString.appendLiteral(&quot;marker rects: &quot;);
      for (const auto&amp; rect : rects) {
          rectString.append(&#39;(&#39;);
<span class="udiff-line-modified-removed">-         rectString.appendNumber(rect.x());</span>
<span class="udiff-line-modified-added">+         rectString.appendFixedPrecisionNumber(rect.x());</span>
          rectString.appendLiteral(&quot;, &quot;);
<span class="udiff-line-modified-removed">-         rectString.appendNumber(rect.y());</span>
<span class="udiff-line-modified-added">+         rectString.appendFixedPrecisionNumber(rect.y());</span>
          rectString.appendLiteral(&quot;, &quot;);
<span class="udiff-line-modified-removed">-         rectString.appendNumber(rect.width());</span>
<span class="udiff-line-modified-added">+         rectString.appendFixedPrecisionNumber(rect.width());</span>
          rectString.appendLiteral(&quot;, &quot;);
<span class="udiff-line-modified-removed">-         rectString.appendNumber(rect.height());</span>
<span class="udiff-line-modified-added">+         rectString.appendFixedPrecisionNumber(rect.height());</span>
          rectString.appendLiteral(&quot;) &quot;);
      }
      return rectString.toString();
  }
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1826,10 +1852,15 @@</span>
  void Internals::setAutofilled(HTMLInputElement&amp; element, bool enabled)
  {
      element.setAutoFilled(enabled);
  }
  
<span class="udiff-line-added">+ void Internals::setAutoFilledAndViewable(HTMLInputElement&amp; element, bool enabled)</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     element.setAutoFilledAndViewable(enabled);</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
  static AutoFillButtonType toAutoFillButtonType(Internals::AutoFillButtonType type)
  {
      switch (type) {
      case Internals::AutoFillButtonType::None:
          return AutoFillButtonType::None;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1930,10 +1961,15 @@</span>
  String Internals::rangeAsText(const Range&amp; range)
  {
      return range.text();
  }
  
<span class="udiff-line-added">+ String Internals::rangeAsTextUsingBackwardsTextIterator(const Range&amp; range)</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     return plainTextUsingBackwardsTextIteratorForTesting(range);</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
  Ref&lt;Range&gt; Internals::subrange(Range&amp; range, int rangeLocation, int rangeLength)
  {
      return TextIterator::subrange(range, rangeLocation, rangeLength);
  }
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -2142,11 +2178,11 @@</span>
  
      StringBuilder result;
  
      if (executable-&gt;isFunctionExecutable()) {
          FunctionExecutable* funcExecutable = reinterpret_cast&lt;FunctionExecutable*&gt;(executable);
<span class="udiff-line-modified-removed">-         String inferredName = funcExecutable-&gt;inferredName().string();</span>
<span class="udiff-line-modified-added">+         String inferredName = funcExecutable-&gt;ecmaName().string();</span>
          result.appendLiteral(&quot;function \&quot;&quot;);
          result.append(inferredName);
          result.append(&#39;&quot;&#39;);
      } else if (executable-&gt;isEvalExecutable())
          result.appendLiteral(&quot;eval&quot;);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -2233,10 +2269,17 @@</span>
  #else
      UNUSED_PARAM(enabled);
  #endif
  }
  
<span class="udiff-line-added">+ bool Internals::testProcessIncomingSyncMessagesWhenWaitingForSyncReply()</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     ASSERT(contextDocument());</span>
<span class="udiff-line-added">+     ASSERT(contextDocument()-&gt;page());</span>
<span class="udiff-line-added">+     return contextDocument()-&gt;page()-&gt;chrome().client().testProcessIncomingSyncMessagesWhenWaitingForSyncReply();</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
  void Internals::setAutomaticDashSubstitutionEnabled(bool enabled)
  {
      if (!contextDocument() || !contextDocument()-&gt;frame())
          return;
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -2338,11 +2381,11 @@</span>
              }
          }
          if (!found)
              return Exception { SyntaxError };
      }
<span class="udiff-line-modified-removed">-     return WTFMove(result);</span>
<span class="udiff-line-modified-added">+     return result;</span>
  }
  
  ExceptionOr&lt;RefPtr&lt;Range&gt;&gt; Internals::rangeOfString(const String&amp; text, RefPtr&lt;Range&gt;&amp;&amp; referenceRange, const Vector&lt;String&gt;&amp; findOptions)
  {
      Document* document = contextDocument();
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -2381,18 +2424,16 @@</span>
          return parsedOptions.releaseException();
  
      return document-&gt;page()-&gt;countFindMatches(text, parsedOptions.releaseReturnValue(), 1000);
  }
  
<span class="udiff-line-added">+ #if ENABLE(INDEXED_DATABASE)</span>
  unsigned Internals::numberOfIDBTransactions() const
  {
<span class="udiff-line-removed">- #if ENABLE(INDEXED_DATABASE)</span>
      return IDBTransaction::numberOfIDBTransactions;
<span class="udiff-line-removed">- #else</span>
<span class="udiff-line-removed">-     return 0;</span>
<span class="udiff-line-removed">- #endif</span>
  }
<span class="udiff-line-added">+ #endif</span>
  
  unsigned Internals::numberOfLiveNodes() const
  {
      unsigned nodeCount = 0;
      for (auto* document : Document::allDocuments())
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -2449,11 +2490,11 @@</span>
  RefPtr&lt;WindowProxy&gt; Internals::openDummyInspectorFrontend(const String&amp; url)
  {
      auto* inspectedPage = contextDocument()-&gt;frame()-&gt;page();
      auto* window = inspectedPage-&gt;mainFrame().document()-&gt;domWindow();
      auto frontendWindowProxy = window-&gt;open(*window, *window, url, &quot;&quot;, &quot;&quot;).releaseReturnValue();
<span class="udiff-line-modified-removed">-     m_inspectorFrontend = std::make_unique&lt;InspectorStubFrontend&gt;(*inspectedPage, downcast&lt;DOMWindow&gt;(frontendWindowProxy-&gt;window()));</span>
<span class="udiff-line-modified-added">+     m_inspectorFrontend = makeUnique&lt;InspectorStubFrontend&gt;(*inspectedPage, downcast&lt;DOMWindow&gt;(frontendWindowProxy-&gt;window()));</span>
      return frontendWindowProxy;
  }
  
  void Internals::closeDummyInspectorFrontend()
  {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -2520,14 +2561,18 @@</span>
          layerTreeFlags |= LayerTreeFlagsIncludePaintingPhases;
      if (flags &amp; Internals::LAYER_TREE_INCLUDES_CONTENT_LAYERS)
          layerTreeFlags |= LayerTreeFlagsIncludeContentLayers;
      if (flags &amp; Internals::LAYER_TREE_INCLUDES_ACCELERATES_DRAWING)
          layerTreeFlags |= LayerTreeFlagsIncludeAcceleratesDrawing;
<span class="udiff-line-added">+     if (flags &amp; Internals::LAYER_TREE_INCLUDES_CLIPPING)</span>
<span class="udiff-line-added">+         layerTreeFlags |= LayerTreeFlagsIncludeClipping;</span>
      if (flags &amp; Internals::LAYER_TREE_INCLUDES_BACKING_STORE_ATTACHED)
          layerTreeFlags |= LayerTreeFlagsIncludeBackingStoreAttached;
      if (flags &amp; Internals::LAYER_TREE_INCLUDES_ROOT_LAYER_PROPERTIES)
          layerTreeFlags |= LayerTreeFlagsIncludeRootLayerProperties;
<span class="udiff-line-added">+     if (flags &amp; Internals::LAYER_TREE_INCLUDES_EVENT_REGION)</span>
<span class="udiff-line-added">+         layerTreeFlags |= LayerTreeFlagsIncludeEventRegion;</span>
  
      return layerTreeFlags;
  }
  
  // FIXME: Remove the document argument. It is almost always the same as
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -2965,11 +3010,11 @@</span>
      return { };
  }
  
  void Internals::setPrinting(int width, int height)
  {
<span class="udiff-line-modified-removed">-     printContextForTesting() = std::make_unique&lt;PrintContext&gt;(frame());</span>
<span class="udiff-line-modified-added">+     printContextForTesting() = makeUnique&lt;PrintContext&gt;(frame());</span>
      printContextForTesting()-&gt;begin(width, height);
  }
  
  void Internals::setHeaderHeight(float height)
  {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -3003,43 +3048,43 @@</span>
  void Internals::webkitWillEnterFullScreenForElement(Element&amp; element)
  {
      Document* document = contextDocument();
      if (!document)
          return;
<span class="udiff-line-modified-removed">-     document-&gt;webkitWillEnterFullScreen(element);</span>
<span class="udiff-line-modified-added">+     document-&gt;fullscreenManager().willEnterFullscreen(element);</span>
  }
  
  void Internals::webkitDidEnterFullScreenForElement(Element&amp;)
  {
      Document* document = contextDocument();
      if (!document)
          return;
<span class="udiff-line-modified-removed">-     document-&gt;webkitDidEnterFullScreen();</span>
<span class="udiff-line-modified-added">+     document-&gt;fullscreenManager().didEnterFullscreen();</span>
  }
  
  void Internals::webkitWillExitFullScreenForElement(Element&amp;)
  {
      Document* document = contextDocument();
      if (!document)
          return;
<span class="udiff-line-modified-removed">-     document-&gt;webkitWillExitFullScreen();</span>
<span class="udiff-line-modified-added">+     document-&gt;fullscreenManager().willExitFullscreen();</span>
  }
  
  void Internals::webkitDidExitFullScreenForElement(Element&amp;)
  {
      Document* document = contextDocument();
      if (!document)
          return;
<span class="udiff-line-modified-removed">-     document-&gt;webkitDidExitFullScreen();</span>
<span class="udiff-line-modified-added">+     document-&gt;fullscreenManager().didExitFullscreen();</span>
  }
  
  bool Internals::isAnimatingFullScreen() const
  {
      Document* document = contextDocument();
      if (!document)
          return false;
<span class="udiff-line-modified-removed">-     return document-&gt;isAnimatingFullScreen();</span>
<span class="udiff-line-modified-added">+     return document-&gt;fullscreenManager().isAnimatingFullscreen();</span>
  }
  
  #endif
  
  void Internals::setFullscreenInsets(FullscreenInsets insets)
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -3334,18 +3379,18 @@</span>
      result.append(&#39;,&#39;);
      result.appendNumber(cursor.hotSpot().y());
      if (cursor.image()) {
          FloatSize size = cursor.image()-&gt;size();
          result.appendLiteral(&quot; image=&quot;);
<span class="udiff-line-modified-removed">-         result.appendNumber(size.width());</span>
<span class="udiff-line-modified-added">+         result.appendFixedPrecisionNumber(size.width());</span>
          result.append(&#39;x&#39;);
<span class="udiff-line-modified-removed">-         result.appendNumber(size.height());</span>
<span class="udiff-line-modified-added">+         result.appendFixedPrecisionNumber(size.height());</span>
      }
  #if ENABLE(MOUSE_CURSOR_SCALE)
      if (cursor.imageScaleFactor() != 1) {
          result.appendLiteral(&quot; scale=&quot;);
<span class="udiff-line-modified-removed">-         result.appendNumber(cursor.imageScaleFactor(), 8);</span>
<span class="udiff-line-modified-added">+         result.appendFixedPrecisionNumber(cursor.imageScaleFactor(), 8);</span>
      }
  #endif
      return result.toString();
  #else
      return &quot;FAIL: Cursor details not available on this platform.&quot;_str;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -3392,23 +3437,23 @@</span>
  void Internals::reloadExpiredOnly()
  {
      frame()-&gt;loader().reload(ReloadOption::ExpiredOnly);
  }
  
<span class="udiff-line-modified-removed">- void Internals::enableAutoSizeMode(bool enabled, int minimumWidth, int minimumHeight, int maximumWidth, int maximumHeight)</span>
<span class="udiff-line-modified-added">+ void Internals::enableAutoSizeMode(bool enabled, int width, int height)</span>
  {
      auto* document = contextDocument();
      if (!document || !document-&gt;view())
          return;
<span class="udiff-line-modified-removed">-     document-&gt;view()-&gt;enableAutoSizeMode(enabled, IntSize(minimumWidth, minimumHeight), IntSize(maximumWidth, maximumHeight));</span>
<span class="udiff-line-modified-added">+     document-&gt;view()-&gt;enableAutoSizeMode(enabled, { width, height });</span>
  }
  
  #if ENABLE(LEGACY_ENCRYPTED_MEDIA)
  
  void Internals::initializeMockCDM()
  {
<span class="udiff-line-modified-removed">-     LegacyCDM::registerCDMFactory([] (LegacyCDM* cdm) { return std::make_unique&lt;LegacyMockCDM&gt;(cdm); },</span>
<span class="udiff-line-modified-added">+     LegacyCDM::registerCDMFactory([] (LegacyCDM* cdm) { return makeUnique&lt;LegacyMockCDM&gt;(cdm); },</span>
          LegacyMockCDM::supportsKeySystem, LegacyMockCDM::supportsKeySystemAndMimeType);
  }
  
  #endif
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -3498,13 +3543,29 @@</span>
          player-&gt;endSimulatedHDCPError();
  }
  
  bool Internals::elementShouldBufferData(HTMLMediaElement&amp; element)
  {
<span class="udiff-line-modified-removed">-     return element.shouldBufferData();</span>
<span class="udiff-line-modified-added">+     return element.bufferingPolicy() &lt; MediaPlayer::BufferingPolicy::LimitReadAhead;</span>
  }
  
<span class="udiff-line-added">+ String Internals::elementBufferingPolicy(HTMLMediaElement&amp; element)</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     switch (element.bufferingPolicy()) {</span>
<span class="udiff-line-added">+     case MediaPlayer::BufferingPolicy::Default:</span>
<span class="udiff-line-added">+         return &quot;Default&quot;;</span>
<span class="udiff-line-added">+     case MediaPlayer::BufferingPolicy::LimitReadAhead:</span>
<span class="udiff-line-added">+         return &quot;LimitReadAhead&quot;;</span>
<span class="udiff-line-added">+     case MediaPlayer::BufferingPolicy::MakeResourcesPurgeable:</span>
<span class="udiff-line-added">+         return &quot;MakeResourcesPurgeable&quot;;</span>
<span class="udiff-line-added">+     case MediaPlayer::BufferingPolicy::PurgeResources:</span>
<span class="udiff-line-added">+         return &quot;PurgeResources&quot;;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     ASSERT_NOT_REACHED();</span>
<span class="udiff-line-added">+     return &quot;UNKNOWN&quot;;</span>
<span class="udiff-line-added">+ }</span>
  #endif
  
  bool Internals::isSelectPopupVisible(HTMLSelectElement&amp; element)
  {
      element.document().updateLayoutIgnorePendingStylesheets();
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -3584,10 +3645,20 @@</span>
      UNUSED_PARAM(mode);
  #endif
      return { };
  }
  
<span class="udiff-line-added">+ #if ENABLE(VIDEO_TRACK)</span>
<span class="udiff-line-added">+ RefPtr&lt;TextTrackCueGeneric&gt; Internals::createGenericCue(double startTime, double endTime, String text)</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     Document* document = contextDocument();</span>
<span class="udiff-line-added">+     if (!document || !document-&gt;page())</span>
<span class="udiff-line-added">+         return nullptr;</span>
<span class="udiff-line-added">+     return TextTrackCueGeneric::create(*document, MediaTime::createWithDouble(startTime), MediaTime::createWithDouble(endTime), text);</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ #endif</span>
<span class="udiff-line-added">+ </span>
  #if ENABLE(VIDEO)
  
  Ref&lt;TimeRanges&gt; Internals::createTimeRanges(Float32Array&amp; startTimes, Float32Array&amp; endTimes)
  {
      ASSERT(startTimes.length() == endTimes.length());
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -3645,10 +3716,15 @@</span>
  bool Internals::isPluginSnapshotted(Element&amp; element)
  {
      return is&lt;HTMLPlugInElement&gt;(element) &amp;&amp; downcast&lt;HTMLPlugInElement&gt;(element).displayState() &lt;= HTMLPlugInElement::DisplayingSnapshot;
  }
  
<span class="udiff-line-added">+ bool Internals::pluginIsBelowSizeThreshold(Element&amp; element)</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     return is&lt;HTMLPlugInElement&gt;(element) &amp;&amp; downcast&lt;HTMLPlugInElement&gt;(element).isBelowSizeThreshold();</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
  #if ENABLE(MEDIA_SOURCE)
  
  void Internals::initializeMockMediaSource()
  {
  #if USE(AVFOUNDATION)
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -3658,25 +3734,35 @@</span>
      WebCore::DeprecatedGlobalSettings::setGStreamerEnabled(false);
  #endif
      MediaPlayerFactorySupport::callRegisterMediaEngine(MockMediaPlayerMediaSource::registerMediaEngine);
  }
  
<span class="udiff-line-modified-removed">- Vector&lt;String&gt; Internals::bufferedSamplesForTrackID(SourceBuffer&amp; buffer, const AtomicString&amp; trackID)</span>
<span class="udiff-line-modified-added">+ Vector&lt;String&gt; Internals::bufferedSamplesForTrackID(SourceBuffer&amp; buffer, const AtomString&amp; trackID)</span>
  {
      return buffer.bufferedSamplesForTrackID(trackID);
  }
  
<span class="udiff-line-modified-removed">- Vector&lt;String&gt; Internals::enqueuedSamplesForTrackID(SourceBuffer&amp; buffer, const AtomicString&amp; trackID)</span>
<span class="udiff-line-modified-added">+ Vector&lt;String&gt; Internals::enqueuedSamplesForTrackID(SourceBuffer&amp; buffer, const AtomString&amp; trackID)</span>
  {
      return buffer.enqueuedSamplesForTrackID(trackID);
  }
  
<span class="udiff-line-added">+ double Internals::minimumUpcomingPresentationTimeForTrackID(SourceBuffer&amp; buffer, const AtomString&amp; trackID)</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     return buffer.minimumUpcomingPresentationTimeForTrackID(trackID).toDouble();</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
  void Internals::setShouldGenerateTimestamps(SourceBuffer&amp; buffer, bool flag)
  {
      buffer.setShouldGenerateTimestamps(flag);
  }
  
<span class="udiff-line-added">+ void Internals::setMaximumQueueDepthForTrackID(SourceBuffer&amp; buffer, const AtomString&amp; trackID, size_t maxQueueDepth)</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     buffer.setMaximumQueueDepthForTrackID(trackID, maxQueueDepth);</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
  #endif
  
  void Internals::enableMockMediaCapabilities()
  {
      MediaEngineConfigurationFactory::enableMock();
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -3835,12 +3921,10 @@</span>
          if (equalLettersIgnoringASCIICase(restrictionString, &quot;wirelessvideoplaybackdisabled&quot;))
              restrictions |= MediaElementSession::WirelessVideoPlaybackDisabled;
  #endif
          if (equalLettersIgnoringASCIICase(restrictionString, &quot;requireusergestureforaudioratechange&quot;))
              restrictions |= MediaElementSession::RequireUserGestureForAudioRateChange;
<span class="udiff-line-removed">-         if (equalLettersIgnoringASCIICase(restrictionString, &quot;metadatapreloadingnotpermitted&quot;))</span>
<span class="udiff-line-removed">-             restrictions |= MediaElementSession::MetadataPreloadingNotPermitted;</span>
          if (equalLettersIgnoringASCIICase(restrictionString, &quot;autopreloadingnotpermitted&quot;))
              restrictions |= MediaElementSession::AutoPreloadingNotPermitted;
          if (equalLettersIgnoringASCIICase(restrictionString, &quot;invisibleautoplaynotpermitted&quot;))
              restrictions |= MediaElementSession::InvisibleAutoplayNotPermitted;
          if (equalLettersIgnoringASCIICase(restrictionString, &quot;overrideusergesturerequirementformaincontent&quot;))
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -4058,11 +4142,13 @@</span>
      WebCore::MediaProducer::MutedStateFlags state = MediaProducer::NoneMuted;
      for (StringView stateString : statesString.split(&#39;,&#39;)) {
          if (equalLettersIgnoringASCIICase(stateString, &quot;audio&quot;))
              state |= MediaProducer::AudioIsMuted;
          if (equalLettersIgnoringASCIICase(stateString, &quot;capturedevices&quot;))
<span class="udiff-line-modified-removed">-             state |= MediaProducer::CaptureDevicesAreMuted;</span>
<span class="udiff-line-modified-added">+             state |= MediaProducer::AudioAndVideoCaptureIsMuted;</span>
<span class="udiff-line-added">+         if (equalLettersIgnoringASCIICase(stateString, &quot;screencapture&quot;))</span>
<span class="udiff-line-added">+             state |= MediaProducer::ScreenCaptureIsMuted;</span>
      }
  
      if (Page* page = document-&gt;page())
          page-&gt;setMuted(state);
  }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -4147,20 +4233,20 @@</span>
  
      URL url = document-&gt;completeURL(path);
      if (!url.isLocalFile())
          return nullptr;
  
<span class="udiff-line-modified-removed">-     return File::create(url.fileSystemPath());</span>
<span class="udiff-line-modified-added">+     return File::create(document-&gt;sessionID(), url.fileSystemPath());</span>
  }
  
  void Internals::queueMicroTask(int testNumber)
  {
      Document* document = contextDocument();
      if (!document)
          return;
  
<span class="udiff-line-modified-removed">-     auto microtask = std::make_unique&lt;ActiveDOMCallbackMicrotask&gt;(MicrotaskQueue::mainThreadQueue(), *document, [document, testNumber]() {</span>
<span class="udiff-line-modified-added">+     auto microtask = makeUnique&lt;ActiveDOMCallbackMicrotask&gt;(MicrotaskQueue::mainThreadQueue(), *document, [document, testNumber]() {</span>
          document-&gt;addConsoleMessage(MessageSource::JS, MessageLevel::Debug, makeString(&quot;MicroTask #&quot;, testNumber, &quot; has run.&quot;));
      });
  
      MicrotaskQueue::mainThreadQueue().append(WTFMove(microtask));
  }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -4349,29 +4435,24 @@</span>
      return JSC::call(&amp;state, function, callType, callData, JSC::jsUndefined(), arguments);
  }
  
  #endif
  
<span class="udiff-line-modified-removed">- String Internals::resourceLoadStatisticsForOrigin(const String&amp; origin)</span>
<span class="udiff-line-modified-added">+ String Internals::resourceLoadStatisticsForURL(const DOMURL&amp; url)</span>
  {
<span class="udiff-line-modified-removed">-     return ResourceLoadObserver::shared().statisticsForOrigin(origin);</span>
<span class="udiff-line-modified-added">+     auto* document = contextDocument();</span>
<span class="udiff-line-added">+     if (!document)</span>
<span class="udiff-line-added">+         return emptyString();</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     return ResourceLoadObserver::shared().statisticsForURL(document-&gt;sessionID(), url.href());</span>
  }
  
  void Internals::setResourceLoadStatisticsEnabled(bool enable)
  {
      DeprecatedGlobalSettings::setResourceLoadStatisticsEnabled(enable);
  }
  
<span class="udiff-line-removed">- void Internals::setUserGrantsStorageAccess(bool value)</span>
<span class="udiff-line-removed">- {</span>
<span class="udiff-line-removed">-     Document* document = contextDocument();</span>
<span class="udiff-line-removed">-     if (!document)</span>
<span class="udiff-line-removed">-         return;</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     document-&gt;setUserGrantsStorageAccessOverride(value);</span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-removed">- </span>
  String Internals::composedTreeAsText(Node&amp; node)
  {
      if (!is&lt;ContainerNode&gt;(node))
          return emptyString();
      return WebCore::composedTreeAsText(downcast&lt;ContainerNode&gt;(node));
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -4386,10 +4467,19 @@</span>
  {
      UserGestureIndicator gestureIndicator(ProcessingUserGesture, contextDocument());
      callback-&gt;handleEvent();
  }
  
<span class="udiff-line-added">+ bool Internals::userIsInteracting()</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     if (auto* document = contextDocument()) {</span>
<span class="udiff-line-added">+         if (auto* page = document-&gt;page())</span>
<span class="udiff-line-added">+             return page-&gt;chrome().client().userIsInteracting();</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+     return false;</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
  double Internals::lastHandledUserGestureTimestamp()
  {
      Document* document = contextDocument();
      if (!document)
          return 0;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -4422,10 +4512,17 @@</span>
  bool Internals::userPrefersReducedMotion() const
  {
      return false;
  }
  
<span class="udiff-line-added">+ #if ENABLE(VIDEO)</span>
<span class="udiff-line-added">+ double Internals::privatePlayerVolume(const HTMLMediaElement&amp;)</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     return 0;</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ #endif</span>
<span class="udiff-line-added">+ </span>
  #endif
  
  void Internals::reportBacktrace()
  {
      WTFReportBacktrace();
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -4542,12 +4639,19 @@</span>
  #endif
  }
  
  void Internals::setAsRunningUserScripts(Document&amp; document)
  {
<span class="udiff-line-modified-removed">-     document.topDocument().setAsRunningUserScripts();</span>
<span class="udiff-line-modified-added">+     document.setAsRunningUserScripts();</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ #if ENABLE(APPLE_PAY)</span>
<span class="udiff-line-added">+ void Internals::setApplePayIsActive(Document&amp; document)</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     document.setApplePayIsActive();</span>
  }
<span class="udiff-line-added">+ #endif</span>
  
  #if ENABLE(WEBGL)
  void Internals::simulateWebGLContextChanged(WebGLRenderingContext&amp; context)
  {
      context.simulateContextChanged();
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -4609,10 +4713,17 @@</span>
      document-&gt;page()-&gt;libWebRTCProvider().setH264HardwareEncoderAllowed(allowed);
  }
  #endif
  
  #if ENABLE(MEDIA_STREAM)
<span class="udiff-line-added">+ void Internals::setMockAudioTrackChannelNumber(MediaStreamTrack&amp; track, unsigned short channelNumber)</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     auto&amp; source = track.source();</span>
<span class="udiff-line-added">+     if (!is&lt;MockRealtimeAudioSource&gt;(source))</span>
<span class="udiff-line-added">+         return;</span>
<span class="udiff-line-added">+     downcast&lt;MockRealtimeAudioSource&gt;(source).setChannelCount(channelNumber);</span>
<span class="udiff-line-added">+ }</span>
  
  void Internals::setCameraMediaStreamTrackOrientation(MediaStreamTrack&amp; track, int orientation)
  {
      auto&amp; source = track.source();
      if (!source.isCaptureSource())
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -4682,10 +4793,19 @@</span>
  void Internals::setMediaStreamSourceInterrupted(MediaStreamTrack&amp; track, bool interrupted)
  {
      track.source().setInterruptedForTesting(interrupted);
  }
  
<span class="udiff-line-added">+ void Internals::setDisableGetDisplayMediaUserGestureConstraint(bool value)</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     Document* document = contextDocument();</span>
<span class="udiff-line-added">+     if (!document || !document-&gt;domWindow())</span>
<span class="udiff-line-added">+         return;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     if (auto* mediaDevices = NavigatorMediaDevices::mediaDevices(document-&gt;domWindow()-&gt;navigator()))</span>
<span class="udiff-line-added">+         mediaDevices-&gt;setDisableGetDisplayMediaUserGestureConstraint(value);</span>
<span class="udiff-line-added">+ }</span>
  #endif
  
  String Internals::audioSessionCategory() const
  {
  #if USE(AUDIO_SESSION)
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -4723,10 +4843,25 @@</span>
      return AudioSession::sharedSession().isActive();
  #endif
      return false;
  }
  
<span class="udiff-line-added">+ void Internals::storeRegistrationsOnDisk(DOMPromiseDeferred&lt;void&gt;&amp;&amp; promise)</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+ #if ENABLE(SERVICE_WORKER)</span>
<span class="udiff-line-added">+     if (!contextDocument())</span>
<span class="udiff-line-added">+         return;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     auto&amp; connection = ServiceWorkerProvider::singleton().serviceWorkerConnectionForSession(contextDocument()-&gt;sessionID());</span>
<span class="udiff-line-added">+     connection.storeRegistrationsOnDiskForTesting([promise = WTFMove(promise)]() mutable {</span>
<span class="udiff-line-added">+         promise.resolve();</span>
<span class="udiff-line-added">+     });</span>
<span class="udiff-line-added">+ #else</span>
<span class="udiff-line-added">+     promise.resolve();</span>
<span class="udiff-line-added">+ #endif</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
  void Internals::clearCacheStorageMemoryRepresentation(DOMPromiseDeferred&lt;void&gt;&amp;&amp; promise)
  {
      auto* document = contextDocument();
      if (!document)
          return;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -4758,10 +4893,26 @@</span>
      m_cacheStorageConnection-&gt;engineRepresentation([promise = WTFMove(promise)](const String&amp; result) mutable {
          promise.resolve(result);
      });
  }
  
<span class="udiff-line-added">+ void Internals::updateQuotaBasedOnSpaceUsage()</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     auto* document = contextDocument();</span>
<span class="udiff-line-added">+     if (!document)</span>
<span class="udiff-line-added">+         return;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     if (!m_cacheStorageConnection) {</span>
<span class="udiff-line-added">+         if (auto* page = contextDocument()-&gt;page())</span>
<span class="udiff-line-added">+             m_cacheStorageConnection = page-&gt;cacheStorageProvider().createCacheStorageConnection(page-&gt;sessionID());</span>
<span class="udiff-line-added">+         if (!m_cacheStorageConnection)</span>
<span class="udiff-line-added">+             return;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     m_cacheStorageConnection-&gt;updateQuotaBasedOnSpaceUsage(ClientOrigin { document-&gt;topOrigin().data(), document-&gt;securityOrigin().data() });</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
  void Internals::setConsoleMessageListener(RefPtr&lt;StringCallback&gt;&amp;&amp; listener)
  {
      if (!contextDocument())
          return;
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -4865,11 +5016,11 @@</span>
              builder.append(&#39;,&#39;);
  
          builder.append(&#39;[&#39;);
  
          for (auto&amp; info : platformStrategies()-&gt;loaderStrategy()-&gt;intermediateLoadInformationFromResourceLoadIdentifier(identifier))
<span class="udiff-line-modified-removed">-             builder.append(makeString(&quot;[&quot;, (int)info.type, &quot;,\&quot;&quot;, info.request.url().string(), &quot;\&quot;,\&quot;&quot;, info.request.httpMethod(), &quot;\&quot;,&quot;, info.response.httpStatusCode(), &quot;]&quot;));</span>
<span class="udiff-line-modified-added">+             builder.append(&#39;[&#39;, (int)info.type, &quot;,\&quot;&quot;, info.request.url().string(), &quot;\&quot;,\&quot;&quot;, info.request.httpMethod(), &quot;\&quot;,&quot;, info.response.httpStatusCode(), &#39;]&#39;);</span>
  
          builder.append(&#39;]&#39;);
      }
      builder.append(&#39;]&#39;);
      return builder.toString();
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -4896,11 +5047,11 @@</span>
      return contextDocument()-&gt;page()-&gt;pluginData().webVisiblePlugins().size();
  }
  
  void Internals::notifyResourceLoadObserver()
  {
<span class="udiff-line-modified-removed">-     ResourceLoadObserver::shared().notifyObserver();</span>
<span class="udiff-line-modified-added">+     ResourceLoadObserver::shared().updateCentralStatisticsStore();</span>
  }
  
  unsigned Internals::primaryScreenDisplayID()
  {
  #if PLATFORM(MAC)
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -4916,11 +5067,11 @@</span>
  }
  
  bool Internals::supportsVCPEncoder()
  {
  #if defined(ENABLE_VCP_ENCODER)
<span class="udiff-line-modified-removed">-     return ENABLE_VCP_ENCODER;</span>
<span class="udiff-line-modified-added">+     return ENABLE_VCP_ENCODER || ENABLE_VCP_VTB_ENCODER;</span>
  #else
      return false;
  #endif
  }
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -4952,6 +5103,70 @@</span>
      if (!localFrame)
          return;
      localFrame-&gt;loader().setAlwaysAllowLocalWebarchive(alwaysAllowLocalWebarchive);
  }
  
<span class="udiff-line-added">+ void Internals::processWillSuspend()</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     PlatformMediaSessionManager::sharedManager().processWillSuspend();</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ void Internals::processDidResume()</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     PlatformMediaSessionManager::sharedManager().processDidResume();</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ void Internals::testDictionaryLogging()</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     auto* document = contextDocument();</span>
<span class="udiff-line-added">+     if (!document)</span>
<span class="udiff-line-added">+         return;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     auto* page = document-&gt;page();</span>
<span class="udiff-line-added">+     if (!page)</span>
<span class="udiff-line-added">+         return;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     DiagnosticLoggingClient::ValueDictionary dictionary;</span>
<span class="udiff-line-added">+     dictionary.set(&quot;stringKey&quot;_s, String(&quot;stringValue&quot;));</span>
<span class="udiff-line-added">+     dictionary.set(&quot;uint64Key&quot;_s, std::numeric_limits&lt;uint64_t&gt;::max());</span>
<span class="udiff-line-added">+     dictionary.set(&quot;int64Key&quot;_s, std::numeric_limits&lt;int64_t&gt;::min());</span>
<span class="udiff-line-added">+     dictionary.set(&quot;boolKey&quot;_s, true);</span>
<span class="udiff-line-added">+     dictionary.set(&quot;doubleKey&quot;_s, 2.7182818284590452353602874);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     page-&gt;diagnosticLoggingClient().logDiagnosticMessageWithValueDictionary(&quot;testMessage&quot;_s, &quot;testDescription&quot;_s, dictionary, ShouldSample::No);</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ void Internals::setXHRMaximumIntervalForUserGestureForwarding(XMLHttpRequest&amp; request, double interval)</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     request.setMaximumIntervalForUserGestureForwarding(interval);</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ void Internals::setIsPlayingToAutomotiveHeadUnit(bool isPlaying)</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     PlatformMediaSessionManager::sharedManager().setIsPlayingToAutomotiveHeadUnit(isPlaying);</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ Internals::TextIndicatorInfo::TextIndicatorInfo()</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ Internals::TextIndicatorInfo::TextIndicatorInfo(const WebCore::TextIndicatorData&amp; data)</span>
<span class="udiff-line-added">+     : textBoundingRectInRootViewCoordinates(DOMRect::create(data.textBoundingRectInRootViewCoordinates))</span>
<span class="udiff-line-added">+     , textRectsInBoundingRectCoordinates(DOMRectList::create(data.textRectsInBoundingRectCoordinates))</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ Internals::TextIndicatorInfo::~TextIndicatorInfo() = default;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ Internals::TextIndicatorInfo Internals::textIndicatorForRange(const Range&amp; range, TextIndicatorOptions options)</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     auto indicator = TextIndicator::createWithRange(range, options.core(), TextIndicatorPresentationTransition::None);</span>
<span class="udiff-line-added">+     return indicator-&gt;data();</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ void Internals::addPrefetchLoadEventListener(HTMLLinkElement&amp; link, RefPtr&lt;EventListener&gt;&amp;&amp; listener)</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     if (RuntimeEnabledFeatures::sharedFeatures().linkPrefetchEnabled() &amp;&amp; equalLettersIgnoringASCIICase(link.rel(), &quot;prefetch&quot;))</span>
<span class="udiff-line-added">+         link.addEventListener(eventNames().loadEvent, listener.releaseNonNull(), false);</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
  } // namespace WebCore
</pre>
<center><a href="InternalSettings.idl.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="Internals.h.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>