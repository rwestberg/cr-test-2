<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames modules/javafx.web/src/main/native/Source/WebCore/css/StyleProperties.h</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
  2  * (C) 1999-2003 Lars Knoll (knoll@kde.org)
  3  * Copyright (C) 2004, 2005, 2006, 2008, 2012, 2013 Apple Inc. All rights reserved.
  4  * Copyright (C) 2013 Intel Corporation. All rights reserved.
  5  *
  6  * This library is free software; you can redistribute it and/or
  7  * modify it under the terms of the GNU Library General Public
  8  * License as published by the Free Software Foundation; either
  9  * version 2 of the License, or (at your option) any later version.
 10  *
 11  * This library is distributed in the hope that it will be useful,
 12  * but WITHOUT ANY WARRANTY; without even the implied warranty of
 13  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 14  * Library General Public License for more details.
 15  *
 16  * You should have received a copy of the GNU Library General Public License
 17  * along with this library; see the file COPYING.LIB.  If not, write to
 18  * the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor,
 19  * Boston, MA 02110-1301, USA.
 20  */
 21 
 22 #pragma once
 23 
 24 #include &quot;CSSParserContext.h&quot;
 25 #include &quot;CSSParserTokenRange.h&quot;
 26 #include &quot;CSSProperty.h&quot;
 27 #include &quot;CSSValueKeywords.h&quot;
 28 #include &lt;memory&gt;
 29 #include &lt;wtf/Function.h&gt;
 30 #include &lt;wtf/TypeCasts.h&gt;
 31 #include &lt;wtf/Vector.h&gt;
 32 #include &lt;wtf/text/WTFString.h&gt;
 33 
 34 namespace WebCore {
 35 
 36 class CSSDeferredParser;
 37 class CSSStyleDeclaration;
 38 class CachedResource;
 39 class Color;
 40 class ImmutableStyleProperties;
 41 class MutableStyleProperties;
 42 class PropertySetCSSStyleDeclaration;
 43 class StyledElement;
 44 class StylePropertyShorthand;
 45 class StyleSheetContents;
 46 
 47 enum StylePropertiesType { ImmutablePropertiesType, MutablePropertiesType, DeferredPropertiesType };
 48 
 49 class StylePropertiesBase : public RefCounted&lt;StylePropertiesBase&gt; {
 50 public:
 51     // Override RefCounted&#39;s deref() to ensure operator delete is called on
 52     // the appropriate subclass type.
 53     void deref();
 54 
 55     StylePropertiesType type() const { return static_cast&lt;StylePropertiesType&gt;(m_type); }
 56 
 57     CSSParserMode cssParserMode() const { return static_cast&lt;CSSParserMode&gt;(m_cssParserMode); }
 58 
 59 protected:
 60     StylePropertiesBase(CSSParserMode cssParserMode, StylePropertiesType type)
 61         : m_cssParserMode(cssParserMode)
 62         , m_type(type)
 63         , m_arraySize(0)
 64     { }
 65 
 66     StylePropertiesBase(CSSParserMode cssParserMode, unsigned immutableArraySize)
 67         : m_cssParserMode(cssParserMode)
 68         , m_type(ImmutablePropertiesType)
 69         , m_arraySize(immutableArraySize)
 70     { }
 71 
 72     unsigned m_cssParserMode : 3;
 73     mutable unsigned m_type : 2;
 74     unsigned m_arraySize : 27;
 75 };
 76 
 77 class StyleProperties : public StylePropertiesBase {
 78     friend class PropertyReference;
 79 public:
 80     class PropertyReference {
 81     public:
 82         PropertyReference(const StylePropertyMetadata&amp; metadata, const CSSValue* value)
 83             : m_metadata(metadata)
 84             , m_value(value)
 85         { }
 86 
 87         CSSPropertyID id() const { return static_cast&lt;CSSPropertyID&gt;(m_metadata.m_propertyID); }
 88         CSSPropertyID shorthandID() const { return m_metadata.shorthandID(); }
 89 
 90         bool isImportant() const { return m_metadata.m_important; }
 91         bool isInherited() const { return m_metadata.m_inherited; }
 92         bool isImplicit() const { return m_metadata.m_implicit; }
 93 
 94         String cssName() const;
 95         String cssText() const;
 96 
 97         const CSSValue* value() const { return m_value; }
 98         // FIXME: We should try to remove this mutable overload.
 99         CSSValue* value() { return const_cast&lt;CSSValue*&gt;(m_value); }
100 
101         // FIXME: Remove this.
102         CSSProperty toCSSProperty() const { return CSSProperty(id(), const_cast&lt;CSSValue*&gt;(m_value), isImportant(), m_metadata.m_isSetFromShorthand, m_metadata.m_indexInShorthandsVector, isImplicit()); }
103 
104     private:
105         const StylePropertyMetadata&amp; m_metadata;
106         const CSSValue* m_value;
107     };
108 
109     unsigned propertyCount() const;
110     bool isEmpty() const { return !propertyCount(); }
111     PropertyReference propertyAt(unsigned) const;
112 
113     WEBCORE_EXPORT RefPtr&lt;CSSValue&gt; getPropertyCSSValue(CSSPropertyID) const;
114     WEBCORE_EXPORT String getPropertyValue(CSSPropertyID) const;
115 
116     WEBCORE_EXPORT Optional&lt;Color&gt; propertyAsColor(CSSPropertyID) const;
117     WEBCORE_EXPORT CSSValueID propertyAsValueID(CSSPropertyID) const;
118 
119     bool propertyIsImportant(CSSPropertyID) const;
120     String getPropertyShorthand(CSSPropertyID) const;
121     bool isPropertyImplicit(CSSPropertyID) const;
122 
123     RefPtr&lt;CSSValue&gt; getCustomPropertyCSSValue(const String&amp; propertyName) const;
124     String getCustomPropertyValue(const String&amp; propertyName) const;
125     bool customPropertyIsImportant(const String&amp; propertyName) const;
126 
127     Ref&lt;MutableStyleProperties&gt; copyBlockProperties() const;
128 
129     WEBCORE_EXPORT Ref&lt;MutableStyleProperties&gt; mutableCopy() const;
130     Ref&lt;ImmutableStyleProperties&gt; immutableCopyIfNeeded() const;
131 
132     Ref&lt;MutableStyleProperties&gt; copyPropertiesInSet(const CSSPropertyID* set, unsigned length) const;
133 
134     String asText() const;
135 
136     bool hasCSSOMWrapper() const;
137     bool isMutable() const { return type() == MutablePropertiesType; }
138 
139     bool traverseSubresources(const WTF::Function&lt;bool (const CachedResource&amp;)&gt;&amp; handler) const;
140 
141     static unsigned averageSizeInBytes();
142 
143 #ifndef NDEBUG
144     void showStyle();
145 #endif
146 
147     bool propertyMatches(CSSPropertyID, const CSSValue*) const;
148 
149 protected:
150     StyleProperties(CSSParserMode cssParserMode, StylePropertiesType type)
151         : StylePropertiesBase(cssParserMode, type)
152     { }
153 
154     StyleProperties(CSSParserMode cssParserMode, unsigned immutableArraySize)
155         : StylePropertiesBase(cssParserMode, immutableArraySize)
156     { }
157 
158     int findPropertyIndex(CSSPropertyID) const;
159     int findCustomPropertyIndex(const String&amp; propertyName) const;
160 
161 private:
162     String getShorthandValue(const StylePropertyShorthand&amp;) const;
163     String getCommonValue(const StylePropertyShorthand&amp;) const;
164     String getAlignmentShorthandValue(const StylePropertyShorthand&amp;) const;
165     String borderPropertyValue(const StylePropertyShorthand&amp;, const StylePropertyShorthand&amp;, const StylePropertyShorthand&amp;) const;
<a name="1" id="anc1"></a><span class="line-added">166     String pageBreakPropertyValue(const StylePropertyShorthand&amp;) const;</span>
167     String getLayeredShorthandValue(const StylePropertyShorthand&amp;) const;
168     String get2Values(const StylePropertyShorthand&amp;) const;
169     String get4Values(const StylePropertyShorthand&amp;) const;
170     String borderSpacingValue(const StylePropertyShorthand&amp;) const;
171     String fontValue() const;
172     void appendFontLonghandValueIfExplicit(CSSPropertyID, StringBuilder&amp; result, String&amp; value) const;
173 
174     RefPtr&lt;CSSValue&gt; getPropertyCSSValueInternal(CSSPropertyID) const;
175 
176     friend class PropertySetCSSStyleDeclaration;
177 };
178 
179 class ImmutableStyleProperties final : public StyleProperties {
180 public:
181     WEBCORE_EXPORT ~ImmutableStyleProperties();
182     static Ref&lt;ImmutableStyleProperties&gt; create(const CSSProperty* properties, unsigned count, CSSParserMode);
183 
184     unsigned propertyCount() const { return m_arraySize; }
185     bool isEmpty() const { return !propertyCount(); }
186     PropertyReference propertyAt(unsigned index) const;
187 
188     const CSSValue** valueArray() const;
189     const StylePropertyMetadata* metadataArray() const;
190     int findPropertyIndex(CSSPropertyID) const;
191     int findCustomPropertyIndex(const String&amp; propertyName) const;
192 
193     void* m_storage;
194 
195 private:
196     ImmutableStyleProperties(const CSSProperty*, unsigned count, CSSParserMode);
197 };
198 
199 inline const CSSValue** ImmutableStyleProperties::valueArray() const
200 {
201     return reinterpret_cast&lt;const CSSValue**&gt;(const_cast&lt;const void**&gt;((&amp;(this-&gt;m_storage))));
202 }
203 
204 inline const StylePropertyMetadata* ImmutableStyleProperties::metadataArray() const
205 {
206     return reinterpret_cast_ptr&lt;const StylePropertyMetadata*&gt;(&amp;reinterpret_cast_ptr&lt;const char*&gt;(&amp;(this-&gt;m_storage))[m_arraySize * sizeof(CSSValue*)]);
207 }
208 
209 class MutableStyleProperties final : public StyleProperties {
210 public:
211     WEBCORE_EXPORT static Ref&lt;MutableStyleProperties&gt; create(CSSParserMode = HTMLQuirksMode);
212     static Ref&lt;MutableStyleProperties&gt; create(const CSSProperty* properties, unsigned count);
213 
214     WEBCORE_EXPORT ~MutableStyleProperties();
215 
216     unsigned propertyCount() const { return m_propertyVector.size(); }
217     bool isEmpty() const { return !propertyCount(); }
218     PropertyReference propertyAt(unsigned index) const;
219 
220     PropertySetCSSStyleDeclaration* cssStyleDeclaration();
221 
222     bool addParsedProperties(const ParsedPropertyVector&amp;);
223     bool addParsedProperty(const CSSProperty&amp;);
224 
225     // These expand shorthand properties into multiple properties.
226     bool setProperty(CSSPropertyID, const String&amp; value, bool important, CSSParserContext);
227     bool setProperty(CSSPropertyID, const String&amp; value, bool important = false);
228     void setProperty(CSSPropertyID, RefPtr&lt;CSSValue&gt;&amp;&amp;, bool important = false);
229 
230     // These do not. FIXME: This is too messy, we can do better.
231     bool setProperty(CSSPropertyID, CSSValueID identifier, bool important = false);
232     bool setProperty(CSSPropertyID, CSSPropertyID identifier, bool important = false);
233     bool setProperty(const CSSProperty&amp;, CSSProperty* slot = nullptr);
234 
235     bool removeProperty(CSSPropertyID, String* returnText = nullptr);
236     void removeBlockProperties();
237     bool removePropertiesInSet(const CSSPropertyID* set, unsigned length);
238 
239     void mergeAndOverrideOnConflict(const StyleProperties&amp;);
240 
241     void clear();
242     bool parseDeclaration(const String&amp; styleDeclaration, CSSParserContext);
243 
244     WEBCORE_EXPORT CSSStyleDeclaration&amp; ensureCSSStyleDeclaration();
245     CSSStyleDeclaration&amp; ensureInlineCSSStyleDeclaration(StyledElement&amp; parentElement);
246 
247     int findPropertyIndex(CSSPropertyID) const;
248     int findCustomPropertyIndex(const String&amp; propertyName) const;
249 
250     Vector&lt;CSSProperty, 4&gt; m_propertyVector;
251 
252     // Methods for querying and altering CSS custom properties.
253     bool setCustomProperty(const Document*, const String&amp; propertyName, const String&amp; value, bool important, CSSParserContext);
254     bool removeCustomProperty(const String&amp; propertyName, String* returnText = nullptr);
255 
256 private:
257     explicit MutableStyleProperties(CSSParserMode);
258     explicit MutableStyleProperties(const StyleProperties&amp;);
259     MutableStyleProperties(const CSSProperty* properties, unsigned count);
260 
261     bool removeShorthandProperty(CSSPropertyID);
262     CSSProperty* findCSSPropertyWithID(CSSPropertyID);
263     CSSProperty* findCustomCSSPropertyWithName(const String&amp;);
264     std::unique_ptr&lt;PropertySetCSSStyleDeclaration&gt; m_cssomWrapper;
265 
266     friend class StyleProperties;
267 };
268 
269 class DeferredStyleProperties final : public StylePropertiesBase {
270 public:
271     WEBCORE_EXPORT ~DeferredStyleProperties();
272     static Ref&lt;DeferredStyleProperties&gt; create(const CSSParserTokenRange&amp;, CSSDeferredParser&amp;);
273 
274     Ref&lt;ImmutableStyleProperties&gt; parseDeferredProperties();
275 
276 private:
277     DeferredStyleProperties(const CSSParserTokenRange&amp;, CSSDeferredParser&amp;);
278 
279     Vector&lt;CSSParserToken&gt; m_tokens;
280     Ref&lt;CSSDeferredParser&gt; m_parser;
281 };
282 
283 inline ImmutableStyleProperties::PropertyReference ImmutableStyleProperties::propertyAt(unsigned index) const
284 {
285     return PropertyReference(metadataArray()[index], valueArray()[index]);
286 }
287 
288 inline MutableStyleProperties::PropertyReference MutableStyleProperties::propertyAt(unsigned index) const
289 {
290     const CSSProperty&amp; property = m_propertyVector[index];
291     return PropertyReference(property.metadata(), property.value());
292 }
293 
294 inline StyleProperties::PropertyReference StyleProperties::propertyAt(unsigned index) const
295 {
296     if (is&lt;MutableStyleProperties&gt;(*this))
297         return downcast&lt;MutableStyleProperties&gt;(*this).propertyAt(index);
298     return downcast&lt;ImmutableStyleProperties&gt;(*this).propertyAt(index);
299 }
300 
301 inline unsigned StyleProperties::propertyCount() const
302 {
303     if (is&lt;MutableStyleProperties&gt;(*this))
304         return downcast&lt;MutableStyleProperties&gt;(*this).propertyCount();
305     return downcast&lt;ImmutableStyleProperties&gt;(*this).propertyCount();
306 }
307 
308 inline void StylePropertiesBase::deref()
309 {
310     if (!derefBase())
311         return;
312 
313     if (is&lt;MutableStyleProperties&gt;(*this))
314         delete downcast&lt;MutableStyleProperties&gt;(this);
315     else if (is&lt;ImmutableStyleProperties&gt;(*this))
316         delete downcast&lt;ImmutableStyleProperties&gt;(this);
317     else
318         delete downcast&lt;DeferredStyleProperties&gt;(this);
319 }
320 
321 inline int StyleProperties::findPropertyIndex(CSSPropertyID propertyID) const
322 {
323     if (is&lt;MutableStyleProperties&gt;(*this))
324         return downcast&lt;MutableStyleProperties&gt;(*this).findPropertyIndex(propertyID);
325     return downcast&lt;ImmutableStyleProperties&gt;(*this).findPropertyIndex(propertyID);
326 }
327 
328 inline int StyleProperties::findCustomPropertyIndex(const String&amp; propertyName) const
329 {
330     if (is&lt;MutableStyleProperties&gt;(*this))
331         return downcast&lt;MutableStyleProperties&gt;(*this).findCustomPropertyIndex(propertyName);
332     return downcast&lt;ImmutableStyleProperties&gt;(*this).findCustomPropertyIndex(propertyName);
333 }
334 
335 } // namespace WebCore
336 
337 SPECIALIZE_TYPE_TRAITS_BEGIN(WebCore::StyleProperties)
338     static bool isType(const WebCore::StylePropertiesBase&amp; set) { return set.type() != WebCore::DeferredPropertiesType; }
339 SPECIALIZE_TYPE_TRAITS_END()
340 
341 SPECIALIZE_TYPE_TRAITS_BEGIN(WebCore::MutableStyleProperties)
342     static bool isType(const WebCore::StylePropertiesBase&amp; set) { return set.type() == WebCore::MutablePropertiesType; }
343 SPECIALIZE_TYPE_TRAITS_END()
344 
345 SPECIALIZE_TYPE_TRAITS_BEGIN(WebCore::ImmutableStyleProperties)
346     static bool isType(const WebCore::StylePropertiesBase&amp; set) { return set.type() == WebCore::ImmutablePropertiesType; }
347 SPECIALIZE_TYPE_TRAITS_END()
348 
349 SPECIALIZE_TYPE_TRAITS_BEGIN(WebCore::DeferredStyleProperties)
350     static bool isType(const WebCore::StylePropertiesBase&amp; set) { return set.type() == WebCore::DeferredPropertiesType; }
351 SPECIALIZE_TYPE_TRAITS_END()
<a name="2" id="anc2"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="2" type="hidden" />
</body>
</html>