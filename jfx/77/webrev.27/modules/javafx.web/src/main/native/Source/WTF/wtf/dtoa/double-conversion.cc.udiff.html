<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff modules/javafx.web/src/main/native/Source/WTF/wtf/dtoa/double-conversion.cc</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="diy-fp.h.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="double-conversion.h.udiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WTF/wtf/dtoa/double-conversion.cc</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -42,381 +42,381 @@</span>
  
  #include &lt;wtf/ASCIICType.h&gt;
  
  namespace WTF {
  namespace double_conversion {
<span class="udiff-line-modified-removed">-     </span>
<span class="udiff-line-modified-added">+ </span>
  const DoubleToStringConverter&amp; DoubleToStringConverter::EcmaScriptConverter() {
<span class="udiff-line-modified-removed">-         int flags = UNIQUE_ZERO | EMIT_POSITIVE_EXPONENT_SIGN;</span>
<span class="udiff-line-modified-removed">-         static DoubleToStringConverter converter(flags,</span>
<span class="udiff-line-modified-removed">-                                                  &quot;Infinity&quot;,</span>
<span class="udiff-line-modified-removed">-                                                  &quot;NaN&quot;,</span>
<span class="udiff-line-modified-removed">-                                                  &#39;e&#39;,</span>
<span class="udiff-line-modified-removed">-                                                  -6, 21,</span>
<span class="udiff-line-modified-removed">-                                                  6, 0);</span>
<span class="udiff-line-modified-removed">-         return converter;</span>
<span class="udiff-line-modified-added">+   int flags = UNIQUE_ZERO | EMIT_POSITIVE_EXPONENT_SIGN;</span>
<span class="udiff-line-modified-added">+   static DoubleToStringConverter converter(flags,</span>
<span class="udiff-line-modified-added">+                                            &quot;Infinity&quot;,</span>
<span class="udiff-line-modified-added">+                                            &quot;NaN&quot;,</span>
<span class="udiff-line-modified-added">+                                            &#39;e&#39;,</span>
<span class="udiff-line-modified-added">+                                            -6, 21,</span>
<span class="udiff-line-modified-added">+                                            6, 0);</span>
<span class="udiff-line-modified-added">+   return converter;</span>
  }
<span class="udiff-line-modified-removed">-     </span>
<span class="udiff-line-modified-removed">-     </span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+ </span>
  bool DoubleToStringConverter::HandleSpecialValues(
<span class="udiff-line-modified-removed">-                                                       double value,</span>
<span class="udiff-line-modified-removed">-                                                       StringBuilder* result_builder) const {</span>
<span class="udiff-line-modified-removed">-         Double double_inspect(value);</span>
<span class="udiff-line-modified-removed">-         if (double_inspect.IsInfinite()) {</span>
<span class="udiff-line-modified-removed">-             if (infinity_symbol_ == NULL) return false;</span>
<span class="udiff-line-modified-removed">-             if (value &lt; 0) {</span>
<span class="udiff-line-modified-removed">-                 result_builder-&gt;AddCharacter(&#39;-&#39;);</span>
<span class="udiff-line-modified-removed">-             }</span>
<span class="udiff-line-modified-removed">-             result_builder-&gt;AddString(infinity_symbol_);</span>
<span class="udiff-line-modified-removed">-             return true;</span>
<span class="udiff-line-modified-removed">-         }</span>
<span class="udiff-line-modified-removed">-         if (double_inspect.IsNan()) {</span>
<span class="udiff-line-modified-removed">-             if (nan_symbol_ == NULL) return false;</span>
<span class="udiff-line-modified-removed">-             result_builder-&gt;AddString(nan_symbol_);</span>
<span class="udiff-line-modified-removed">-             return true;</span>
<span class="udiff-line-modified-removed">-         }</span>
<span class="udiff-line-modified-removed">-         return false;</span>
<span class="udiff-line-modified-added">+     double value,</span>
<span class="udiff-line-modified-added">+     StringBuilder* result_builder) const {</span>
<span class="udiff-line-modified-added">+   Double double_inspect(value);</span>
<span class="udiff-line-modified-added">+   if (double_inspect.IsInfinite()) {</span>
<span class="udiff-line-modified-added">+     if (infinity_symbol_ == NULL) return false;</span>
<span class="udiff-line-modified-added">+     if (value &lt; 0) {</span>
<span class="udiff-line-modified-added">+       result_builder-&gt;AddCharacter(&#39;-&#39;);</span>
<span class="udiff-line-modified-added">+     }</span>
<span class="udiff-line-modified-added">+     result_builder-&gt;AddString(infinity_symbol_);</span>
<span class="udiff-line-modified-added">+     return true;</span>
<span class="udiff-line-modified-added">+   }</span>
<span class="udiff-line-modified-added">+   if (double_inspect.IsNan()) {</span>
<span class="udiff-line-modified-added">+     if (nan_symbol_ == NULL) return false;</span>
<span class="udiff-line-modified-added">+     result_builder-&gt;AddString(nan_symbol_);</span>
<span class="udiff-line-modified-added">+     return true;</span>
<span class="udiff-line-modified-added">+   }</span>
<span class="udiff-line-modified-added">+   return false;</span>
  }
<span class="udiff-line-modified-removed">-     </span>
<span class="udiff-line-modified-removed">-     </span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+ </span>
  void DoubleToStringConverter::CreateExponentialRepresentation(
<span class="udiff-line-modified-removed">-                                                                   const char* decimal_digits,</span>
<span class="udiff-line-modified-removed">-                                                                   int length,</span>
<span class="udiff-line-modified-removed">-                                                                   int exponent,</span>
<span class="udiff-line-modified-removed">-                                                                   StringBuilder* result_builder) const {</span>
<span class="udiff-line-modified-removed">-         ASSERT(length != 0);</span>
<span class="udiff-line-modified-removed">-         result_builder-&gt;AddCharacter(decimal_digits[0]);</span>
<span class="udiff-line-modified-removed">-         if (length != 1) {</span>
<span class="udiff-line-modified-removed">-             result_builder-&gt;AddCharacter(&#39;.&#39;);</span>
<span class="udiff-line-modified-removed">-             result_builder-&gt;AddSubstring(&amp;decimal_digits[1], length-1);</span>
<span class="udiff-line-modified-removed">-         }</span>
<span class="udiff-line-modified-removed">-         result_builder-&gt;AddCharacter(exponent_character_);</span>
<span class="udiff-line-modified-removed">-         if (exponent &lt; 0) {</span>
<span class="udiff-line-modified-removed">-             result_builder-&gt;AddCharacter(&#39;-&#39;);</span>
<span class="udiff-line-modified-removed">-             exponent = -exponent;</span>
<span class="udiff-line-modified-removed">-         } else {</span>
<span class="udiff-line-modified-removed">-             if ((flags_ &amp; EMIT_POSITIVE_EXPONENT_SIGN) != 0) {</span>
<span class="udiff-line-modified-removed">-                 result_builder-&gt;AddCharacter(&#39;+&#39;);</span>
<span class="udiff-line-modified-removed">-             }</span>
<span class="udiff-line-modified-removed">-         }</span>
<span class="udiff-line-modified-removed">-         if (exponent == 0) {</span>
<span class="udiff-line-modified-removed">-             result_builder-&gt;AddCharacter(&#39;0&#39;);</span>
<span class="udiff-line-modified-removed">-             return;</span>
<span class="udiff-line-modified-removed">-         }</span>
<span class="udiff-line-modified-removed">-         ASSERT(exponent &lt; 1e4);</span>
<span class="udiff-line-modified-removed">-         const int kMaxExponentLength = 5;</span>
<span class="udiff-line-modified-removed">-         char buffer[kMaxExponentLength + 1];</span>
<span class="udiff-line-modified-added">+     const char* decimal_digits,</span>
<span class="udiff-line-modified-added">+     int length,</span>
<span class="udiff-line-modified-added">+     int exponent,</span>
<span class="udiff-line-modified-added">+     StringBuilder* result_builder) const {</span>
<span class="udiff-line-modified-added">+   ASSERT(length != 0);</span>
<span class="udiff-line-modified-added">+   result_builder-&gt;AddCharacter(decimal_digits[0]);</span>
<span class="udiff-line-modified-added">+   if (length != 1) {</span>
<span class="udiff-line-modified-added">+     result_builder-&gt;AddCharacter(&#39;.&#39;);</span>
<span class="udiff-line-modified-added">+     result_builder-&gt;AddSubstring(&amp;decimal_digits[1], length-1);</span>
<span class="udiff-line-modified-added">+   }</span>
<span class="udiff-line-modified-added">+   result_builder-&gt;AddCharacter(exponent_character_);</span>
<span class="udiff-line-modified-added">+   if (exponent &lt; 0) {</span>
<span class="udiff-line-modified-added">+     result_builder-&gt;AddCharacter(&#39;-&#39;);</span>
<span class="udiff-line-modified-added">+     exponent = -exponent;</span>
<span class="udiff-line-modified-added">+   } else {</span>
<span class="udiff-line-modified-added">+     if ((flags_ &amp; EMIT_POSITIVE_EXPONENT_SIGN) != 0) {</span>
<span class="udiff-line-modified-added">+       result_builder-&gt;AddCharacter(&#39;+&#39;);</span>
<span class="udiff-line-modified-added">+     }</span>
<span class="udiff-line-modified-added">+   }</span>
<span class="udiff-line-modified-added">+   if (exponent == 0) {</span>
<span class="udiff-line-modified-added">+     result_builder-&gt;AddCharacter(&#39;0&#39;);</span>
<span class="udiff-line-modified-added">+     return;</span>
<span class="udiff-line-modified-added">+   }</span>
<span class="udiff-line-modified-added">+   ASSERT(exponent &lt; 1e4);</span>
<span class="udiff-line-modified-added">+   const int kMaxExponentLength = 5;</span>
<span class="udiff-line-modified-added">+   char buffer[kMaxExponentLength + 1];</span>
    buffer[kMaxExponentLength] = &#39;\0&#39;;
<span class="udiff-line-modified-removed">-         int first_char_pos = kMaxExponentLength;</span>
<span class="udiff-line-modified-removed">-         while (exponent &gt; 0) {</span>
<span class="udiff-line-modified-removed">-             buffer[--first_char_pos] = &#39;0&#39; + (exponent % 10);</span>
<span class="udiff-line-modified-removed">-             exponent /= 10;</span>
<span class="udiff-line-modified-removed">-         }</span>
<span class="udiff-line-modified-removed">-         result_builder-&gt;AddSubstring(&amp;buffer[first_char_pos],</span>
<span class="udiff-line-modified-removed">-                                      kMaxExponentLength - first_char_pos);</span>
<span class="udiff-line-modified-added">+   int first_char_pos = kMaxExponentLength;</span>
<span class="udiff-line-modified-added">+   while (exponent &gt; 0) {</span>
<span class="udiff-line-modified-added">+     buffer[--first_char_pos] = &#39;0&#39; + (exponent % 10);</span>
<span class="udiff-line-modified-added">+     exponent /= 10;</span>
<span class="udiff-line-modified-added">+   }</span>
<span class="udiff-line-modified-added">+   result_builder-&gt;AddSubstring(&amp;buffer[first_char_pos],</span>
<span class="udiff-line-modified-added">+                                kMaxExponentLength - first_char_pos);</span>
  }
<span class="udiff-line-modified-removed">-     </span>
<span class="udiff-line-modified-removed">-     </span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+ </span>
  void DoubleToStringConverter::CreateDecimalRepresentation(
<span class="udiff-line-modified-removed">-                                                               const char* decimal_digits,</span>
<span class="udiff-line-modified-removed">-                                                               int length,</span>
<span class="udiff-line-modified-removed">-                                                               int decimal_point,</span>
<span class="udiff-line-modified-removed">-                                                               int digits_after_point,</span>
<span class="udiff-line-modified-removed">-                                                               StringBuilder* result_builder) const {</span>
<span class="udiff-line-modified-removed">-         // Create a representation that is padded with zeros if needed.</span>
<span class="udiff-line-modified-removed">-         if (decimal_point &lt;= 0) {</span>
<span class="udiff-line-modified-added">+     const char* decimal_digits,</span>
<span class="udiff-line-modified-added">+     int length,</span>
<span class="udiff-line-modified-added">+     int decimal_point,</span>
<span class="udiff-line-modified-added">+     int digits_after_point,</span>
<span class="udiff-line-modified-added">+     StringBuilder* result_builder) const {</span>
<span class="udiff-line-modified-added">+   // Create a representation that is padded with zeros if needed.</span>
<span class="udiff-line-modified-added">+   if (decimal_point &lt;= 0) {</span>
        // &quot;0.00000decimal_rep&quot; or &quot;0.000decimal_rep00&quot;.
<span class="udiff-line-modified-removed">-             result_builder-&gt;AddCharacter(&#39;0&#39;);</span>
<span class="udiff-line-modified-removed">-             if (digits_after_point &gt; 0) {</span>
<span class="udiff-line-modified-removed">-                 result_builder-&gt;AddCharacter(&#39;.&#39;);</span>
<span class="udiff-line-modified-removed">-                 result_builder-&gt;AddPadding(&#39;0&#39;, -decimal_point);</span>
<span class="udiff-line-modified-removed">-                 ASSERT(length &lt;= digits_after_point - (-decimal_point));</span>
<span class="udiff-line-modified-removed">-                 result_builder-&gt;AddSubstring(decimal_digits, length);</span>
<span class="udiff-line-modified-removed">-                 int remaining_digits = digits_after_point - (-decimal_point) - length;</span>
<span class="udiff-line-modified-removed">-                 result_builder-&gt;AddPadding(&#39;0&#39;, remaining_digits);</span>
<span class="udiff-line-modified-removed">-             }</span>
<span class="udiff-line-modified-removed">-         } else if (decimal_point &gt;= length) {</span>
<span class="udiff-line-modified-added">+     result_builder-&gt;AddCharacter(&#39;0&#39;);</span>
<span class="udiff-line-modified-added">+     if (digits_after_point &gt; 0) {</span>
<span class="udiff-line-modified-added">+       result_builder-&gt;AddCharacter(&#39;.&#39;);</span>
<span class="udiff-line-modified-added">+       result_builder-&gt;AddPadding(&#39;0&#39;, -decimal_point);</span>
<span class="udiff-line-modified-added">+       ASSERT(length &lt;= digits_after_point - (-decimal_point));</span>
<span class="udiff-line-modified-added">+       result_builder-&gt;AddSubstring(decimal_digits, length);</span>
<span class="udiff-line-modified-added">+       int remaining_digits = digits_after_point - (-decimal_point) - length;</span>
<span class="udiff-line-modified-added">+       result_builder-&gt;AddPadding(&#39;0&#39;, remaining_digits);</span>
<span class="udiff-line-modified-added">+     }</span>
<span class="udiff-line-modified-added">+   } else if (decimal_point &gt;= length) {</span>
      // &quot;decimal_rep0000.00000&quot; or &quot;decimal_rep.0000&quot;.
<span class="udiff-line-modified-removed">-             result_builder-&gt;AddSubstring(decimal_digits, length);</span>
<span class="udiff-line-modified-removed">-             result_builder-&gt;AddPadding(&#39;0&#39;, decimal_point - length);</span>
<span class="udiff-line-modified-removed">-             if (digits_after_point &gt; 0) {</span>
<span class="udiff-line-modified-removed">-                 result_builder-&gt;AddCharacter(&#39;.&#39;);</span>
<span class="udiff-line-modified-removed">-                 result_builder-&gt;AddPadding(&#39;0&#39;, digits_after_point);</span>
<span class="udiff-line-modified-removed">-             }</span>
<span class="udiff-line-modified-removed">-         } else {</span>
<span class="udiff-line-modified-added">+     result_builder-&gt;AddSubstring(decimal_digits, length);</span>
<span class="udiff-line-modified-added">+     result_builder-&gt;AddPadding(&#39;0&#39;, decimal_point - length);</span>
<span class="udiff-line-modified-added">+     if (digits_after_point &gt; 0) {</span>
<span class="udiff-line-modified-added">+       result_builder-&gt;AddCharacter(&#39;.&#39;);</span>
<span class="udiff-line-modified-added">+       result_builder-&gt;AddPadding(&#39;0&#39;, digits_after_point);</span>
<span class="udiff-line-modified-added">+     }</span>
<span class="udiff-line-modified-added">+   } else {</span>
      // &quot;decima.l_rep000&quot;.
<span class="udiff-line-modified-removed">-             ASSERT(digits_after_point &gt; 0);</span>
<span class="udiff-line-modified-removed">-             result_builder-&gt;AddSubstring(decimal_digits, decimal_point);</span>
<span class="udiff-line-modified-removed">-             result_builder-&gt;AddCharacter(&#39;.&#39;);</span>
<span class="udiff-line-modified-removed">-             ASSERT(length - decimal_point &lt;= digits_after_point);</span>
<span class="udiff-line-modified-removed">-             result_builder-&gt;AddSubstring(&amp;decimal_digits[decimal_point],</span>
<span class="udiff-line-modified-removed">-                                          length - decimal_point);</span>
<span class="udiff-line-modified-removed">-             int remaining_digits = digits_after_point - (length - decimal_point);</span>
<span class="udiff-line-modified-removed">-             result_builder-&gt;AddPadding(&#39;0&#39;, remaining_digits);</span>
<span class="udiff-line-modified-removed">-         }</span>
<span class="udiff-line-modified-removed">-         if (digits_after_point == 0) {</span>
<span class="udiff-line-modified-removed">-             if ((flags_ &amp; EMIT_TRAILING_DECIMAL_POINT) != 0) {</span>
<span class="udiff-line-modified-removed">-                 result_builder-&gt;AddCharacter(&#39;.&#39;);</span>
<span class="udiff-line-modified-removed">-             }</span>
<span class="udiff-line-modified-removed">-             if ((flags_ &amp; EMIT_TRAILING_ZERO_AFTER_POINT) != 0) {</span>
<span class="udiff-line-modified-removed">-                 result_builder-&gt;AddCharacter(&#39;0&#39;);</span>
<span class="udiff-line-modified-removed">-             }</span>
<span class="udiff-line-modified-removed">-         }</span>
<span class="udiff-line-modified-added">+     ASSERT(digits_after_point &gt; 0);</span>
<span class="udiff-line-modified-added">+     result_builder-&gt;AddSubstring(decimal_digits, decimal_point);</span>
<span class="udiff-line-modified-added">+     result_builder-&gt;AddCharacter(&#39;.&#39;);</span>
<span class="udiff-line-modified-added">+     ASSERT(length - decimal_point &lt;= digits_after_point);</span>
<span class="udiff-line-modified-added">+     result_builder-&gt;AddSubstring(&amp;decimal_digits[decimal_point],</span>
<span class="udiff-line-modified-added">+                                  length - decimal_point);</span>
<span class="udiff-line-modified-added">+     int remaining_digits = digits_after_point - (length - decimal_point);</span>
<span class="udiff-line-modified-added">+     result_builder-&gt;AddPadding(&#39;0&#39;, remaining_digits);</span>
<span class="udiff-line-modified-added">+   }</span>
<span class="udiff-line-modified-added">+   if (digits_after_point == 0) {</span>
<span class="udiff-line-modified-added">+     if ((flags_ &amp; EMIT_TRAILING_DECIMAL_POINT) != 0) {</span>
<span class="udiff-line-modified-added">+       result_builder-&gt;AddCharacter(&#39;.&#39;);</span>
<span class="udiff-line-modified-added">+     }</span>
<span class="udiff-line-modified-added">+     if ((flags_ &amp; EMIT_TRAILING_ZERO_AFTER_POINT) != 0) {</span>
<span class="udiff-line-modified-added">+       result_builder-&gt;AddCharacter(&#39;0&#39;);</span>
<span class="udiff-line-modified-added">+     }</span>
<span class="udiff-line-modified-added">+   }</span>
  }
<span class="udiff-line-modified-removed">-     </span>
<span class="udiff-line-modified-removed">-     </span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+ </span>
  bool DoubleToStringConverter::ToShortestIeeeNumber(
      double value,
      StringBuilder* result_builder,
      DoubleToStringConverter::DtoaMode mode) const {
    ASSERT(mode == SHORTEST || mode == SHORTEST_SINGLE);
<span class="udiff-line-modified-removed">-         if (Double(value).IsSpecial()) {</span>
<span class="udiff-line-modified-removed">-             return HandleSpecialValues(value, result_builder);</span>
<span class="udiff-line-modified-removed">-         }</span>
<span class="udiff-line-modified-removed">-         </span>
<span class="udiff-line-modified-removed">-         int decimal_point;</span>
<span class="udiff-line-modified-removed">-         bool sign;</span>
<span class="udiff-line-modified-removed">-         const int kDecimalRepCapacity = kBase10MaximalLength + 1;</span>
<span class="udiff-line-modified-removed">-         char decimal_rep[kDecimalRepCapacity];</span>
<span class="udiff-line-modified-removed">-         int decimal_rep_length;</span>
<span class="udiff-line-modified-removed">-         </span>
<span class="udiff-line-modified-added">+   if (Double(value).IsSpecial()) {</span>
<span class="udiff-line-modified-added">+     return HandleSpecialValues(value, result_builder);</span>
<span class="udiff-line-modified-added">+   }</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+   int decimal_point;</span>
<span class="udiff-line-modified-added">+   bool sign;</span>
<span class="udiff-line-modified-added">+   const int kDecimalRepCapacity = kBase10MaximalLength + 1;</span>
<span class="udiff-line-modified-added">+   char decimal_rep[kDecimalRepCapacity];</span>
<span class="udiff-line-modified-added">+   int decimal_rep_length;</span>
<span class="udiff-line-modified-added">+ </span>
    DoubleToAscii(value, mode, 0, decimal_rep, kDecimalRepCapacity,
<span class="udiff-line-modified-removed">-                       &amp;sign, &amp;decimal_rep_length, &amp;decimal_point);</span>
<span class="udiff-line-modified-removed">-         </span>
<span class="udiff-line-modified-removed">-         bool unique_zero = (flags_ &amp; UNIQUE_ZERO) != 0;</span>
<span class="udiff-line-modified-removed">-         if (sign &amp;&amp; (value != 0.0 || !unique_zero)) {</span>
<span class="udiff-line-modified-removed">-             result_builder-&gt;AddCharacter(&#39;-&#39;);</span>
<span class="udiff-line-modified-removed">-         }</span>
<span class="udiff-line-modified-removed">-         </span>
<span class="udiff-line-modified-removed">-         int exponent = decimal_point - 1;</span>
<span class="udiff-line-modified-removed">-         if ((decimal_in_shortest_low_ &lt;= exponent) &amp;&amp;</span>
<span class="udiff-line-modified-removed">-             (exponent &lt; decimal_in_shortest_high_)) {</span>
<span class="udiff-line-modified-removed">-             CreateDecimalRepresentation(decimal_rep, decimal_rep_length,</span>
<span class="udiff-line-modified-removed">-                                         decimal_point,</span>
<span class="udiff-line-modified-removed">-                                         Max(0, decimal_rep_length - decimal_point),</span>
<span class="udiff-line-modified-removed">-                                         result_builder);</span>
<span class="udiff-line-modified-removed">-         } else {</span>
<span class="udiff-line-modified-removed">-             CreateExponentialRepresentation(decimal_rep, decimal_rep_length, exponent,</span>
<span class="udiff-line-modified-removed">-                                             result_builder);</span>
<span class="udiff-line-modified-removed">-         }</span>
<span class="udiff-line-modified-removed">-         return true;</span>
<span class="udiff-line-modified-added">+                 &amp;sign, &amp;decimal_rep_length, &amp;decimal_point);</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+   bool unique_zero = (flags_ &amp; UNIQUE_ZERO) != 0;</span>
<span class="udiff-line-modified-added">+   if (sign &amp;&amp; (value != 0.0 || !unique_zero)) {</span>
<span class="udiff-line-modified-added">+     result_builder-&gt;AddCharacter(&#39;-&#39;);</span>
<span class="udiff-line-modified-added">+   }</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+   int exponent = decimal_point - 1;</span>
<span class="udiff-line-modified-added">+   if ((decimal_in_shortest_low_ &lt;= exponent) &amp;&amp;</span>
<span class="udiff-line-modified-added">+       (exponent &lt; decimal_in_shortest_high_)) {</span>
<span class="udiff-line-modified-added">+     CreateDecimalRepresentation(decimal_rep, decimal_rep_length,</span>
<span class="udiff-line-modified-added">+                                 decimal_point,</span>
<span class="udiff-line-modified-added">+                                 Max(0, decimal_rep_length - decimal_point),</span>
<span class="udiff-line-modified-added">+                                 result_builder);</span>
<span class="udiff-line-modified-added">+   } else {</span>
<span class="udiff-line-modified-added">+     CreateExponentialRepresentation(decimal_rep, decimal_rep_length, exponent,</span>
<span class="udiff-line-modified-added">+                                     result_builder);</span>
<span class="udiff-line-modified-added">+   }</span>
<span class="udiff-line-modified-added">+   return true;</span>
  }
<span class="udiff-line-modified-removed">-     </span>
<span class="udiff-line-modified-removed">-     </span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+ </span>
  bool DoubleToStringConverter::ToFixed(double value,
<span class="udiff-line-modified-removed">-                                           int requested_digits,</span>
<span class="udiff-line-modified-removed">-                                           StringBuilder* result_builder) const {</span>
<span class="udiff-line-modified-removed">-         ASSERT(kMaxFixedDigitsBeforePoint == 60);</span>
<span class="udiff-line-modified-removed">-         const double kFirstNonFixed = 1e60;</span>
<span class="udiff-line-modified-removed">-         </span>
<span class="udiff-line-modified-removed">-         if (Double(value).IsSpecial()) {</span>
<span class="udiff-line-modified-removed">-             return HandleSpecialValues(value, result_builder);</span>
<span class="udiff-line-modified-removed">-         }</span>
<span class="udiff-line-modified-removed">-         </span>
<span class="udiff-line-modified-removed">-         if (requested_digits &gt; kMaxFixedDigitsAfterPoint) return false;</span>
<span class="udiff-line-modified-removed">-         if (value &gt;= kFirstNonFixed || value &lt;= -kFirstNonFixed) return false;</span>
<span class="udiff-line-modified-removed">-         </span>
<span class="udiff-line-modified-removed">-         // Find a sufficiently precise decimal representation of n.</span>
<span class="udiff-line-modified-removed">-         int decimal_point;</span>
<span class="udiff-line-modified-removed">-         bool sign;</span>
<span class="udiff-line-modified-removed">-         // Add space for the &#39;\0&#39; byte.</span>
<span class="udiff-line-modified-removed">-         const int kDecimalRepCapacity =</span>
<span class="udiff-line-modified-removed">-         kMaxFixedDigitsBeforePoint + kMaxFixedDigitsAfterPoint + 1;</span>
<span class="udiff-line-modified-removed">-         char decimal_rep[kDecimalRepCapacity];</span>
<span class="udiff-line-modified-removed">-         int decimal_rep_length;</span>
<span class="udiff-line-modified-removed">-         DoubleToAscii(value, FIXED, requested_digits,</span>
<span class="udiff-line-modified-removed">-                       decimal_rep, kDecimalRepCapacity,</span>
<span class="udiff-line-modified-removed">-                       &amp;sign, &amp;decimal_rep_length, &amp;decimal_point);</span>
<span class="udiff-line-modified-removed">-         </span>
<span class="udiff-line-modified-removed">-         bool unique_zero = ((flags_ &amp; UNIQUE_ZERO) != 0);</span>
<span class="udiff-line-modified-removed">-         if (sign &amp;&amp; (value != 0.0 || !unique_zero)) {</span>
<span class="udiff-line-modified-removed">-             result_builder-&gt;AddCharacter(&#39;-&#39;);</span>
<span class="udiff-line-modified-removed">-         }</span>
<span class="udiff-line-modified-removed">-         </span>
<span class="udiff-line-modified-removed">-         CreateDecimalRepresentation(decimal_rep, decimal_rep_length, decimal_point,</span>
<span class="udiff-line-modified-removed">-                                     requested_digits, result_builder);</span>
<span class="udiff-line-modified-removed">-         return true;</span>
<span class="udiff-line-modified-added">+                                       int requested_digits,</span>
<span class="udiff-line-modified-added">+                                       StringBuilder* result_builder) const {</span>
<span class="udiff-line-modified-added">+   ASSERT(kMaxFixedDigitsBeforePoint == 60);</span>
<span class="udiff-line-modified-added">+   const double kFirstNonFixed = 1e60;</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+   if (Double(value).IsSpecial()) {</span>
<span class="udiff-line-modified-added">+     return HandleSpecialValues(value, result_builder);</span>
<span class="udiff-line-modified-added">+   }</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+   if (requested_digits &gt; kMaxFixedDigitsAfterPoint) return false;</span>
<span class="udiff-line-modified-added">+   if (value &gt;= kFirstNonFixed || value &lt;= -kFirstNonFixed) return false;</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+   // Find a sufficiently precise decimal representation of n.</span>
<span class="udiff-line-modified-added">+   int decimal_point;</span>
<span class="udiff-line-modified-added">+   bool sign;</span>
<span class="udiff-line-modified-added">+   // Add space for the &#39;\0&#39; byte.</span>
<span class="udiff-line-modified-added">+   const int kDecimalRepCapacity =</span>
<span class="udiff-line-modified-added">+       kMaxFixedDigitsBeforePoint + kMaxFixedDigitsAfterPoint + 1;</span>
<span class="udiff-line-modified-added">+   char decimal_rep[kDecimalRepCapacity];</span>
<span class="udiff-line-modified-added">+   int decimal_rep_length;</span>
<span class="udiff-line-modified-added">+   DoubleToAscii(value, FIXED, requested_digits,</span>
<span class="udiff-line-modified-added">+                 decimal_rep, kDecimalRepCapacity,</span>
<span class="udiff-line-modified-added">+                 &amp;sign, &amp;decimal_rep_length, &amp;decimal_point);</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+   bool unique_zero = ((flags_ &amp; UNIQUE_ZERO) != 0);</span>
<span class="udiff-line-modified-added">+   if (sign &amp;&amp; (value != 0.0 || !unique_zero)) {</span>
<span class="udiff-line-modified-added">+     result_builder-&gt;AddCharacter(&#39;-&#39;);</span>
<span class="udiff-line-modified-added">+   }</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+   CreateDecimalRepresentation(decimal_rep, decimal_rep_length, decimal_point,</span>
<span class="udiff-line-modified-added">+                               requested_digits, result_builder);</span>
<span class="udiff-line-modified-added">+   return true;</span>
  }
<span class="udiff-line-modified-removed">-     </span>
<span class="udiff-line-modified-removed">-     </span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+ </span>
  bool DoubleToStringConverter::ToExponential(
<span class="udiff-line-modified-removed">-                                                 double value,</span>
<span class="udiff-line-modified-removed">-                                                 int requested_digits,</span>
<span class="udiff-line-modified-removed">-                                                 StringBuilder* result_builder) const {</span>
<span class="udiff-line-modified-removed">-         if (Double(value).IsSpecial()) {</span>
<span class="udiff-line-modified-removed">-             return HandleSpecialValues(value, result_builder);</span>
<span class="udiff-line-modified-removed">-         }</span>
<span class="udiff-line-modified-removed">-         </span>
<span class="udiff-line-modified-removed">-         if (requested_digits &lt; -1) return false;</span>
<span class="udiff-line-modified-removed">-         if (requested_digits &gt; kMaxExponentialDigits) return false;</span>
<span class="udiff-line-modified-removed">-         </span>
<span class="udiff-line-modified-removed">-         int decimal_point;</span>
<span class="udiff-line-modified-removed">-         bool sign;</span>
<span class="udiff-line-modified-removed">-         // Add space for digit before the decimal point and the &#39;\0&#39; character.</span>
<span class="udiff-line-modified-removed">-         const int kDecimalRepCapacity = kMaxExponentialDigits + 2;</span>
<span class="udiff-line-modified-removed">-         ASSERT(kDecimalRepCapacity &gt; kBase10MaximalLength);</span>
<span class="udiff-line-modified-removed">-         char decimal_rep[kDecimalRepCapacity];</span>
<span class="udiff-line-modified-removed">-         int decimal_rep_length;</span>
<span class="udiff-line-modified-removed">-         </span>
<span class="udiff-line-modified-removed">-         if (requested_digits == -1) {</span>
<span class="udiff-line-modified-removed">-             DoubleToAscii(value, SHORTEST, 0,</span>
<span class="udiff-line-modified-removed">-                           decimal_rep, kDecimalRepCapacity,</span>
<span class="udiff-line-modified-removed">-                           &amp;sign, &amp;decimal_rep_length, &amp;decimal_point);</span>
<span class="udiff-line-modified-removed">-         } else {</span>
<span class="udiff-line-modified-removed">-             DoubleToAscii(value, PRECISION, requested_digits + 1,</span>
<span class="udiff-line-modified-removed">-                           decimal_rep, kDecimalRepCapacity,</span>
<span class="udiff-line-modified-removed">-                           &amp;sign, &amp;decimal_rep_length, &amp;decimal_point);</span>
<span class="udiff-line-modified-removed">-             ASSERT(decimal_rep_length &lt;= requested_digits + 1);</span>
<span class="udiff-line-modified-removed">-             </span>
<span class="udiff-line-modified-removed">-             for (int i = decimal_rep_length; i &lt; requested_digits + 1; ++i) {</span>
<span class="udiff-line-modified-removed">-                 decimal_rep[i] = &#39;0&#39;;</span>
<span class="udiff-line-modified-removed">-             }</span>
<span class="udiff-line-modified-removed">-             decimal_rep_length = requested_digits + 1;</span>
<span class="udiff-line-modified-removed">-         }</span>
<span class="udiff-line-modified-removed">-         </span>
<span class="udiff-line-modified-removed">-         bool unique_zero = ((flags_ &amp; UNIQUE_ZERO) != 0);</span>
<span class="udiff-line-modified-removed">-         if (sign &amp;&amp; (value != 0.0 || !unique_zero)) {</span>
<span class="udiff-line-modified-removed">-             result_builder-&gt;AddCharacter(&#39;-&#39;);</span>
<span class="udiff-line-modified-removed">-         }</span>
<span class="udiff-line-modified-removed">-         </span>
<span class="udiff-line-modified-removed">-         int exponent = decimal_point - 1;</span>
<span class="udiff-line-modified-removed">-         CreateExponentialRepresentation(decimal_rep,</span>
<span class="udiff-line-modified-removed">-                                         decimal_rep_length,</span>
<span class="udiff-line-modified-removed">-                                         exponent,</span>
<span class="udiff-line-modified-removed">-                                         result_builder);</span>
<span class="udiff-line-modified-removed">-         return true;</span>
<span class="udiff-line-modified-added">+     double value,</span>
<span class="udiff-line-modified-added">+     int requested_digits,</span>
<span class="udiff-line-modified-added">+     StringBuilder* result_builder) const {</span>
<span class="udiff-line-modified-added">+   if (Double(value).IsSpecial()) {</span>
<span class="udiff-line-modified-added">+     return HandleSpecialValues(value, result_builder);</span>
<span class="udiff-line-modified-added">+   }</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+   if (requested_digits &lt; -1) return false;</span>
<span class="udiff-line-modified-added">+   if (requested_digits &gt; kMaxExponentialDigits) return false;</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+   int decimal_point;</span>
<span class="udiff-line-modified-added">+   bool sign;</span>
<span class="udiff-line-modified-added">+   // Add space for digit before the decimal point and the &#39;\0&#39; character.</span>
<span class="udiff-line-modified-added">+   const int kDecimalRepCapacity = kMaxExponentialDigits + 2;</span>
<span class="udiff-line-modified-added">+   ASSERT(kDecimalRepCapacity &gt; kBase10MaximalLength);</span>
<span class="udiff-line-modified-added">+   char decimal_rep[kDecimalRepCapacity];</span>
<span class="udiff-line-modified-added">+   int decimal_rep_length;</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+   if (requested_digits == -1) {</span>
<span class="udiff-line-modified-added">+     DoubleToAscii(value, SHORTEST, 0,</span>
<span class="udiff-line-modified-added">+                   decimal_rep, kDecimalRepCapacity,</span>
<span class="udiff-line-modified-added">+                   &amp;sign, &amp;decimal_rep_length, &amp;decimal_point);</span>
<span class="udiff-line-modified-added">+   } else {</span>
<span class="udiff-line-modified-added">+     DoubleToAscii(value, PRECISION, requested_digits + 1,</span>
<span class="udiff-line-modified-added">+                   decimal_rep, kDecimalRepCapacity,</span>
<span class="udiff-line-modified-added">+                   &amp;sign, &amp;decimal_rep_length, &amp;decimal_point);</span>
<span class="udiff-line-modified-added">+     ASSERT(decimal_rep_length &lt;= requested_digits + 1);</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+     for (int i = decimal_rep_length; i &lt; requested_digits + 1; ++i) {</span>
<span class="udiff-line-modified-added">+       decimal_rep[i] = &#39;0&#39;;</span>
<span class="udiff-line-modified-added">+     }</span>
<span class="udiff-line-modified-added">+     decimal_rep_length = requested_digits + 1;</span>
<span class="udiff-line-modified-added">+   }</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+   bool unique_zero = ((flags_ &amp; UNIQUE_ZERO) != 0);</span>
<span class="udiff-line-modified-added">+   if (sign &amp;&amp; (value != 0.0 || !unique_zero)) {</span>
<span class="udiff-line-modified-added">+     result_builder-&gt;AddCharacter(&#39;-&#39;);</span>
<span class="udiff-line-modified-added">+   }</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+   int exponent = decimal_point - 1;</span>
<span class="udiff-line-modified-added">+   CreateExponentialRepresentation(decimal_rep,</span>
<span class="udiff-line-modified-added">+                                   decimal_rep_length,</span>
<span class="udiff-line-modified-added">+                                   exponent,</span>
<span class="udiff-line-modified-added">+                                   result_builder);</span>
<span class="udiff-line-modified-added">+   return true;</span>
  }
<span class="udiff-line-modified-removed">-     </span>
<span class="udiff-line-modified-removed">-     </span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+ </span>
  bool DoubleToStringConverter::ToPrecision(double value,
<span class="udiff-line-modified-removed">-                                               int precision,</span>
<span class="udiff-line-modified-removed">-                                               StringBuilder* result_builder) const {</span>
<span class="udiff-line-modified-removed">-         if (Double(value).IsSpecial()) {</span>
<span class="udiff-line-modified-removed">-             return HandleSpecialValues(value, result_builder);</span>
<span class="udiff-line-modified-removed">-         }</span>
<span class="udiff-line-modified-removed">-         </span>
<span class="udiff-line-modified-removed">-         if (precision &lt; kMinPrecisionDigits || precision &gt; kMaxPrecisionDigits) {</span>
<span class="udiff-line-modified-removed">-             return false;</span>
<span class="udiff-line-modified-removed">-         }</span>
<span class="udiff-line-modified-removed">-         </span>
<span class="udiff-line-modified-removed">-         // Find a sufficiently precise decimal representation of n.</span>
<span class="udiff-line-modified-removed">-         int decimal_point;</span>
<span class="udiff-line-modified-removed">-         bool sign;</span>
<span class="udiff-line-modified-removed">-         // Add one for the terminating null character.</span>
<span class="udiff-line-modified-removed">-         const int kDecimalRepCapacity = kMaxPrecisionDigits + 1;</span>
<span class="udiff-line-modified-removed">-         char decimal_rep[kDecimalRepCapacity];</span>
<span class="udiff-line-modified-removed">-         int decimal_rep_length;</span>
<span class="udiff-line-modified-removed">-         </span>
<span class="udiff-line-modified-removed">-         DoubleToAscii(value, PRECISION, precision,</span>
<span class="udiff-line-modified-removed">-                       decimal_rep, kDecimalRepCapacity,</span>
<span class="udiff-line-modified-removed">-                       &amp;sign, &amp;decimal_rep_length, &amp;decimal_point);</span>
<span class="udiff-line-modified-removed">-         ASSERT(decimal_rep_length &lt;= precision);</span>
<span class="udiff-line-modified-removed">-         </span>
<span class="udiff-line-modified-removed">-         bool unique_zero = ((flags_ &amp; UNIQUE_ZERO) != 0);</span>
<span class="udiff-line-modified-removed">-         if (sign &amp;&amp; (value != 0.0 || !unique_zero)) {</span>
<span class="udiff-line-modified-removed">-             result_builder-&gt;AddCharacter(&#39;-&#39;);</span>
<span class="udiff-line-modified-removed">-         }</span>
<span class="udiff-line-modified-removed">-         </span>
<span class="udiff-line-modified-removed">-         // The exponent if we print the number as x.xxeyyy. That is with the</span>
<span class="udiff-line-modified-removed">-         // decimal point after the first digit.</span>
<span class="udiff-line-modified-removed">-         int exponent = decimal_point - 1;</span>
<span class="udiff-line-modified-removed">-         </span>
<span class="udiff-line-modified-removed">-         int extra_zero = ((flags_ &amp; EMIT_TRAILING_ZERO_AFTER_POINT) != 0) ? 1 : 0;</span>
<span class="udiff-line-modified-removed">-         if ((-decimal_point + 1 &gt; max_leading_padding_zeroes_in_precision_mode_) ||</span>
<span class="udiff-line-modified-removed">-             (decimal_point - precision + extra_zero &gt;</span>
<span class="udiff-line-modified-removed">-              max_trailing_padding_zeroes_in_precision_mode_)) {</span>
<span class="udiff-line-modified-removed">-                 // Fill buffer to contain &#39;precision&#39; digits.</span>
<span class="udiff-line-modified-removed">-                 // Usually the buffer is already at the correct length, but &#39;DoubleToAscii&#39;</span>
<span class="udiff-line-modified-removed">-                 // is allowed to return less characters.</span>
<span class="udiff-line-modified-removed">-                 for (int i = decimal_rep_length; i &lt; precision; ++i) {</span>
<span class="udiff-line-modified-removed">-                     decimal_rep[i] = &#39;0&#39;;</span>
<span class="udiff-line-modified-removed">-                 }</span>
<span class="udiff-line-modified-removed">-                 </span>
<span class="udiff-line-modified-removed">-                 CreateExponentialRepresentation(decimal_rep,</span>
<span class="udiff-line-modified-removed">-                                                 precision,</span>
<span class="udiff-line-modified-removed">-                                                 exponent,</span>
<span class="udiff-line-modified-removed">-                                                 result_builder);</span>
<span class="udiff-line-modified-removed">-             } else {</span>
<span class="udiff-line-modified-removed">-                 CreateDecimalRepresentation(decimal_rep, decimal_rep_length, decimal_point,</span>
<span class="udiff-line-modified-removed">-                                             Max(0, precision - decimal_point),</span>
<span class="udiff-line-modified-removed">-                                             result_builder);</span>
<span class="udiff-line-modified-removed">-             }</span>
<span class="udiff-line-modified-removed">-         return true;</span>
<span class="udiff-line-modified-added">+                                           int precision,</span>
<span class="udiff-line-modified-added">+                                           StringBuilder* result_builder) const {</span>
<span class="udiff-line-modified-added">+   if (Double(value).IsSpecial()) {</span>
<span class="udiff-line-modified-added">+     return HandleSpecialValues(value, result_builder);</span>
<span class="udiff-line-modified-added">+   }</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+   if (precision &lt; kMinPrecisionDigits || precision &gt; kMaxPrecisionDigits) {</span>
<span class="udiff-line-modified-added">+     return false;</span>
<span class="udiff-line-modified-added">+   }</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+   // Find a sufficiently precise decimal representation of n.</span>
<span class="udiff-line-modified-added">+   int decimal_point;</span>
<span class="udiff-line-modified-added">+   bool sign;</span>
<span class="udiff-line-modified-added">+   // Add one for the terminating null character.</span>
<span class="udiff-line-modified-added">+   const int kDecimalRepCapacity = kMaxPrecisionDigits + 1;</span>
<span class="udiff-line-modified-added">+   char decimal_rep[kDecimalRepCapacity];</span>
<span class="udiff-line-modified-added">+   int decimal_rep_length;</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+   DoubleToAscii(value, PRECISION, precision,</span>
<span class="udiff-line-modified-added">+                 decimal_rep, kDecimalRepCapacity,</span>
<span class="udiff-line-modified-added">+                 &amp;sign, &amp;decimal_rep_length, &amp;decimal_point);</span>
<span class="udiff-line-modified-added">+   ASSERT(decimal_rep_length &lt;= precision);</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+   bool unique_zero = ((flags_ &amp; UNIQUE_ZERO) != 0);</span>
<span class="udiff-line-modified-added">+   if (sign &amp;&amp; (value != 0.0 || !unique_zero)) {</span>
<span class="udiff-line-modified-added">+     result_builder-&gt;AddCharacter(&#39;-&#39;);</span>
<span class="udiff-line-modified-added">+   }</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+   // The exponent if we print the number as x.xxeyyy. That is with the</span>
<span class="udiff-line-modified-added">+   // decimal point after the first digit.</span>
<span class="udiff-line-modified-added">+   int exponent = decimal_point - 1;</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+   int extra_zero = ((flags_ &amp; EMIT_TRAILING_ZERO_AFTER_POINT) != 0) ? 1 : 0;</span>
<span class="udiff-line-modified-added">+   if ((-decimal_point + 1 &gt; max_leading_padding_zeroes_in_precision_mode_) ||</span>
<span class="udiff-line-modified-added">+       (decimal_point - precision + extra_zero &gt;</span>
<span class="udiff-line-modified-added">+        max_trailing_padding_zeroes_in_precision_mode_)) {</span>
<span class="udiff-line-modified-added">+     // Fill buffer to contain &#39;precision&#39; digits.</span>
<span class="udiff-line-modified-added">+     // Usually the buffer is already at the correct length, but &#39;DoubleToAscii&#39;</span>
<span class="udiff-line-modified-added">+     // is allowed to return less characters.</span>
<span class="udiff-line-modified-added">+     for (int i = decimal_rep_length; i &lt; precision; ++i) {</span>
<span class="udiff-line-modified-added">+       decimal_rep[i] = &#39;0&#39;;</span>
<span class="udiff-line-modified-added">+     }</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+     CreateExponentialRepresentation(decimal_rep,</span>
<span class="udiff-line-modified-added">+                                     precision,</span>
<span class="udiff-line-modified-added">+                                     exponent,</span>
<span class="udiff-line-modified-added">+                                     result_builder);</span>
<span class="udiff-line-modified-added">+   } else {</span>
<span class="udiff-line-modified-added">+     CreateDecimalRepresentation(decimal_rep, decimal_rep_length, decimal_point,</span>
<span class="udiff-line-modified-added">+                                 Max(0, precision - decimal_point),</span>
<span class="udiff-line-modified-added">+                                 result_builder);</span>
<span class="udiff-line-modified-added">+   }</span>
<span class="udiff-line-modified-added">+   return true;</span>
  }
<span class="udiff-line-modified-removed">-     </span>
<span class="udiff-line-modified-removed">-     </span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+ </span>
  static BignumDtoaMode DtoaToBignumDtoaMode(
<span class="udiff-line-modified-removed">-                                                DoubleToStringConverter::DtoaMode dtoa_mode) {</span>
<span class="udiff-line-modified-removed">-         switch (dtoa_mode) {</span>
<span class="udiff-line-modified-removed">-             case DoubleToStringConverter::SHORTEST:  return BIGNUM_DTOA_SHORTEST;</span>
<span class="udiff-line-modified-added">+     DoubleToStringConverter::DtoaMode dtoa_mode) {</span>
<span class="udiff-line-modified-added">+   switch (dtoa_mode) {</span>
<span class="udiff-line-modified-added">+     case DoubleToStringConverter::SHORTEST:  return BIGNUM_DTOA_SHORTEST;</span>
      case DoubleToStringConverter::SHORTEST_SINGLE:
          return BIGNUM_DTOA_SHORTEST_SINGLE;
<span class="udiff-line-modified-removed">-             case DoubleToStringConverter::FIXED:     return BIGNUM_DTOA_FIXED;</span>
<span class="udiff-line-modified-removed">-             case DoubleToStringConverter::PRECISION: return BIGNUM_DTOA_PRECISION;</span>
<span class="udiff-line-modified-removed">-             default:</span>
<span class="udiff-line-modified-removed">-                 UNREACHABLE();</span>
<span class="udiff-line-modified-removed">-     }</span>
<span class="udiff-line-modified-added">+     case DoubleToStringConverter::FIXED:     return BIGNUM_DTOA_FIXED;</span>
<span class="udiff-line-modified-added">+     case DoubleToStringConverter::PRECISION: return BIGNUM_DTOA_PRECISION;</span>
<span class="udiff-line-modified-added">+     default:</span>
<span class="udiff-line-modified-added">+       UNREACHABLE();</span>
<span class="udiff-line-modified-added">+   }</span>
  }
<span class="udiff-line-modified-removed">-     </span>
<span class="udiff-line-modified-removed">-     </span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+ </span>
  void DoubleToStringConverter::DoubleToAscii(double v,
<span class="udiff-line-modified-removed">-                                                 DtoaMode mode,</span>
<span class="udiff-line-modified-removed">-                                                 int requested_digits,</span>
<span class="udiff-line-modified-removed">-                                                 char* buffer,</span>
<span class="udiff-line-modified-removed">-                                                 int buffer_length,</span>
<span class="udiff-line-modified-removed">-                                                 bool* sign,</span>
<span class="udiff-line-modified-removed">-                                                 int* length,</span>
<span class="udiff-line-modified-removed">-                                                 int* point) {</span>
<span class="udiff-line-modified-added">+                                             DtoaMode mode,</span>
<span class="udiff-line-modified-added">+                                             int requested_digits,</span>
<span class="udiff-line-modified-added">+                                             char* buffer,</span>
<span class="udiff-line-modified-added">+                                             int buffer_length,</span>
<span class="udiff-line-modified-added">+                                             bool* sign,</span>
<span class="udiff-line-modified-added">+                                             int* length,</span>
<span class="udiff-line-modified-added">+                                             int* point) {</span>
    BufferReference&lt;char&gt; bufferReference(buffer, buffer_length);
<span class="udiff-line-modified-removed">-         ASSERT(!Double(v).IsSpecial());</span>
<span class="udiff-line-modified-added">+   ASSERT(!Double(v).IsSpecial());</span>
    ASSERT(mode == SHORTEST || mode == SHORTEST_SINGLE || requested_digits &gt;= 0);
<span class="udiff-line-modified-removed">-         </span>
<span class="udiff-line-modified-removed">-         if (Double(v).Sign() &lt; 0) {</span>
<span class="udiff-line-modified-removed">-             *sign = true;</span>
<span class="udiff-line-modified-removed">-             v = -v;</span>
<span class="udiff-line-modified-removed">-         } else {</span>
<span class="udiff-line-modified-removed">-             *sign = false;</span>
<span class="udiff-line-modified-removed">-         }</span>
<span class="udiff-line-modified-removed">-         </span>
<span class="udiff-line-modified-removed">-         if (mode == PRECISION &amp;&amp; requested_digits == 0) {</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+   if (Double(v).Sign() &lt; 0) {</span>
<span class="udiff-line-modified-added">+     *sign = true;</span>
<span class="udiff-line-modified-added">+     v = -v;</span>
<span class="udiff-line-modified-added">+   } else {</span>
<span class="udiff-line-modified-added">+     *sign = false;</span>
<span class="udiff-line-modified-added">+   }</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+   if (mode == PRECISION &amp;&amp; requested_digits == 0) {</span>
      bufferReference[0] = &#39;\0&#39;;
<span class="udiff-line-modified-removed">-             *length = 0;</span>
<span class="udiff-line-modified-removed">-             return;</span>
<span class="udiff-line-modified-removed">-         }</span>
<span class="udiff-line-modified-removed">-         </span>
<span class="udiff-line-modified-removed">-         if (v == 0) {</span>
<span class="udiff-line-modified-added">+     *length = 0;</span>
<span class="udiff-line-modified-added">+     return;</span>
<span class="udiff-line-modified-added">+   }</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+   if (v == 0) {</span>
      bufferReference[0] = &#39;0&#39;;
      bufferReference[1] = &#39;\0&#39;;
<span class="udiff-line-modified-removed">-             *length = 1;</span>
<span class="udiff-line-modified-removed">-             *point = 1;</span>
<span class="udiff-line-modified-removed">-             return;</span>
<span class="udiff-line-modified-removed">-         }</span>
<span class="udiff-line-modified-removed">-         </span>
<span class="udiff-line-modified-removed">-         bool fast_worked;</span>
<span class="udiff-line-modified-removed">-         switch (mode) {</span>
<span class="udiff-line-modified-removed">-             case SHORTEST:</span>
<span class="udiff-line-modified-added">+     *length = 1;</span>
<span class="udiff-line-modified-added">+     *point = 1;</span>
<span class="udiff-line-modified-added">+     return;</span>
<span class="udiff-line-modified-added">+   }</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+   bool fast_worked;</span>
<span class="udiff-line-modified-added">+   switch (mode) {</span>
<span class="udiff-line-modified-added">+     case SHORTEST:</span>
        fast_worked = FastDtoa(v, FAST_DTOA_SHORTEST, 0, bufferReference, length, point);
        break;
      case SHORTEST_SINGLE:
        fast_worked = FastDtoa(v, FAST_DTOA_SHORTEST_SINGLE, 0,
                               bufferReference, length, point);
<span class="udiff-line-modified-removed">-                 break;</span>
<span class="udiff-line-modified-removed">-             case FIXED:</span>
<span class="udiff-line-modified-added">+       break;</span>
<span class="udiff-line-modified-added">+     case FIXED:</span>
        fast_worked = FastFixedDtoa(v, requested_digits, bufferReference, length, point);
<span class="udiff-line-modified-removed">-                 break;</span>
<span class="udiff-line-modified-removed">-             case PRECISION:</span>
<span class="udiff-line-modified-removed">-                 fast_worked = FastDtoa(v, FAST_DTOA_PRECISION, requested_digits,</span>
<span class="udiff-line-modified-added">+       break;</span>
<span class="udiff-line-modified-added">+     case PRECISION:</span>
<span class="udiff-line-modified-added">+       fast_worked = FastDtoa(v, FAST_DTOA_PRECISION, requested_digits,</span>
                               bufferReference, length, point);
<span class="udiff-line-modified-removed">-                 break;</span>
<span class="udiff-line-modified-removed">-             default:</span>
<span class="udiff-line-modified-removed">-                 fast_worked = false;</span>
<span class="udiff-line-modified-added">+       break;</span>
<span class="udiff-line-modified-added">+     default:</span>
<span class="udiff-line-modified-added">+       fast_worked = false;</span>
        UNREACHABLE();
<span class="udiff-line-modified-removed">-         }</span>
<span class="udiff-line-modified-removed">-         if (fast_worked) return;</span>
<span class="udiff-line-modified-removed">-         </span>
<span class="udiff-line-modified-removed">-         // If the fast dtoa didn&#39;t succeed use the slower bignum version.</span>
<span class="udiff-line-modified-removed">-         BignumDtoaMode bignum_mode = DtoaToBignumDtoaMode(mode);</span>
<span class="udiff-line-modified-added">+   }</span>
<span class="udiff-line-modified-added">+   if (fast_worked) return;</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+   // If the fast dtoa didn&#39;t succeed use the slower bignum version.</span>
<span class="udiff-line-modified-added">+   BignumDtoaMode bignum_mode = DtoaToBignumDtoaMode(mode);</span>
    BignumDtoa(v, bignum_mode, requested_digits, bufferReference, length, point);
    bufferReference[*length] = &#39;\0&#39;;
  }
  
  // Maximum number of significant digits in decimal representation.
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -425,17 +425,17 @@</span>
  // (768 digits). If we parse a number whose first digits are equal to a
  // mean of 2 adjacent doubles (that could have up to 769 digits) the result
  // must be rounded to the bigger one unless the tail consists of zeros, so
  // we don&#39;t need to preserve all the digits.
  const int kMaxSignificantDigits = 772;
<span class="udiff-line-modified-removed">-     </span>
<span class="udiff-line-modified-removed">-     </span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+ </span>
  static double SignedZero(bool sign) {
<span class="udiff-line-modified-removed">-         return sign ? -0.0 : 0.0;</span>
<span class="udiff-line-modified-added">+   return sign ? -0.0 : 0.0;</span>
  }
<span class="udiff-line-modified-removed">-     </span>
<span class="udiff-line-modified-removed">-     </span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+ </span>
  // Returns true, when the iterator is equal to end.
  template&lt;class Iterator&gt;
  static inline bool Advance(Iterator* it, Iterator&amp; end) {
    ++(*it);
    return *it == end;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -455,190 +455,190 @@</span>
  }
  
  template &lt;typename FloatingPointType, class Iterator&gt;
  static FloatingPointType StringToIeee(
      Iterator input,
<span class="udiff-line-modified-removed">-                                                    size_t length,</span>
<span class="udiff-line-modified-removed">-                                                    size_t* processed_characters_count) {</span>
<span class="udiff-line-modified-added">+     size_t length,</span>
<span class="udiff-line-modified-added">+     size_t* processed_characters_count) {</span>
    static_assert(std::is_floating_point&lt;FloatingPointType&gt;::value, &quot;Only floating point types are allowed.&quot;);
  
    Iterator current = input;
    Iterator end = input + length;
<span class="udiff-line-modified-removed">-         </span>
<span class="udiff-line-modified-removed">-         *processed_characters_count = 0;</span>
<span class="udiff-line-modified-removed">-         </span>
<span class="udiff-line-modified-removed">-         // To make sure that iterator dereferencing is valid the following</span>
<span class="udiff-line-modified-removed">-         // convention is used:</span>
<span class="udiff-line-modified-removed">-         // 1. Each &#39;++current&#39; statement is followed by check for equality to &#39;end&#39;.</span>
<span class="udiff-line-modified-removed">-         // 3. If &#39;current&#39; becomes equal to &#39;end&#39; the function returns or goes to</span>
<span class="udiff-line-modified-removed">-         // &#39;parsing_done&#39;.</span>
<span class="udiff-line-modified-removed">-         // 4. &#39;current&#39; is not dereferenced after the &#39;parsing_done&#39; label.</span>
<span class="udiff-line-modified-removed">-         // 5. Code before &#39;parsing_done&#39; may rely on &#39;current != end&#39;.</span>
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-modified-removed">-         if (current == end) return 0.0;</span>
<span class="udiff-line-modified-removed">-         </span>
<span class="udiff-line-modified-removed">-         // The longest form of simplified number is: &quot;-&lt;significant digits&gt;.1eXXX\0&quot;.</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+   *processed_characters_count = 0;</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+   // To make sure that iterator dereferencing is valid the following</span>
<span class="udiff-line-modified-added">+   // convention is used:</span>
<span class="udiff-line-modified-added">+   // 1. Each &#39;++current&#39; statement is followed by check for equality to &#39;end&#39;.</span>
<span class="udiff-line-modified-added">+   // 3. If &#39;current&#39; becomes equal to &#39;end&#39; the function returns or goes to</span>
<span class="udiff-line-modified-added">+   // &#39;parsing_done&#39;.</span>
<span class="udiff-line-modified-added">+   // 4. &#39;current&#39; is not dereferenced after the &#39;parsing_done&#39; label.</span>
<span class="udiff-line-modified-added">+   // 5. Code before &#39;parsing_done&#39; may rely on &#39;current != end&#39;.</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+   if (current == end) return 0.0;</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+   // The longest form of simplified number is: &quot;-&lt;significant digits&gt;.1eXXX\0&quot;.</span>
    const int kBufferSize = kMaxSignificantDigits + 10;
<span class="udiff-line-modified-removed">-         char buffer[kBufferSize];  // NOLINT: size is known at compile time.</span>
<span class="udiff-line-modified-added">+   char buffer[kBufferSize];  // NOLINT: size is known at compile time.</span>
    int buffer_pos = 0;
<span class="udiff-line-modified-removed">-         </span>
<span class="udiff-line-modified-removed">-         // Exponent will be adjusted if insignificant digits of the integer part</span>
<span class="udiff-line-modified-removed">-         // or insignificant leading zeros of the fractional part are dropped.</span>
<span class="udiff-line-modified-removed">-         int exponent = 0;</span>
<span class="udiff-line-modified-removed">-         int significant_digits = 0;</span>
<span class="udiff-line-modified-removed">-         int insignificant_digits = 0;</span>
<span class="udiff-line-modified-removed">-         bool nonzero_digit_dropped = false;</span>
<span class="udiff-line-modified-removed">- </span>
<span class="udiff-line-modified-removed">-         bool sign = false;</span>
<span class="udiff-line-modified-removed">-         </span>
<span class="udiff-line-modified-removed">-         if (*current == &#39;+&#39; || *current == &#39;-&#39;) {</span>
<span class="udiff-line-modified-removed">-             sign = (*current == &#39;-&#39;);</span>
<span class="udiff-line-modified-removed">-             ++current;</span>
<span class="udiff-line-modified-removed">-             if (current == end) return 0.0;</span>
<span class="udiff-line-modified-removed">-         }</span>
<span class="udiff-line-modified-removed">-         </span>
<span class="udiff-line-modified-removed">-         bool leading_zero = false;</span>
<span class="udiff-line-modified-removed">-         if (*current == &#39;0&#39;) {</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+   // Exponent will be adjusted if insignificant digits of the integer part</span>
<span class="udiff-line-modified-added">+   // or insignificant leading zeros of the fractional part are dropped.</span>
<span class="udiff-line-modified-added">+   int exponent = 0;</span>
<span class="udiff-line-modified-added">+   int significant_digits = 0;</span>
<span class="udiff-line-modified-added">+   int insignificant_digits = 0;</span>
<span class="udiff-line-modified-added">+   bool nonzero_digit_dropped = false;</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+   bool sign = false;</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+   if (*current == &#39;+&#39; || *current == &#39;-&#39;) {</span>
<span class="udiff-line-modified-added">+     sign = (*current == &#39;-&#39;);</span>
<span class="udiff-line-modified-added">+     ++current;</span>
<span class="udiff-line-modified-added">+     if (current == end) return 0.0;</span>
<span class="udiff-line-modified-added">+   }</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+   bool leading_zero = false;</span>
<span class="udiff-line-modified-added">+   if (*current == &#39;0&#39;) {</span>
      if (Advance(&amp;current, end)) {
        *processed_characters_count = static_cast&lt;size_t&gt;(current - input);
<span class="udiff-line-modified-removed">-                 return SignedZero(sign);</span>
<span class="udiff-line-modified-removed">-             }</span>
<span class="udiff-line-modified-removed">-             </span>
<span class="udiff-line-modified-removed">-             leading_zero = true;</span>
<span class="udiff-line-modified-removed">-             </span>
<span class="udiff-line-modified-removed">-             // Ignore leading zeros in the integer part.</span>
<span class="udiff-line-modified-removed">-             while (*current == &#39;0&#39;) {</span>
<span class="udiff-line-modified-added">+       return SignedZero(sign);</span>
<span class="udiff-line-modified-added">+     }</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+     leading_zero = true;</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+     // Ignore leading zeros in the integer part.</span>
<span class="udiff-line-modified-added">+     while (*current == &#39;0&#39;) {</span>
        if (Advance(&amp;current, end)) {
          *processed_characters_count = static_cast&lt;size_t&gt;(current - input);
<span class="udiff-line-modified-removed">-                     return SignedZero(sign);</span>
<span class="udiff-line-modified-removed">-                 }</span>
<span class="udiff-line-modified-removed">-             }</span>
<span class="udiff-line-modified-removed">-         }</span>
<span class="udiff-line-modified-removed">-         </span>
<span class="udiff-line-modified-removed">-         // Copy significant digits of the integer part (if any) to the buffer.</span>
<span class="udiff-line-modified-removed">-         while (isASCIIDigit(*current)) {</span>
<span class="udiff-line-modified-removed">-             if (significant_digits &lt; kMaxSignificantDigits) {</span>
<span class="udiff-line-modified-removed">-                 ASSERT(buffer_pos &lt; kBufferSize);</span>
<span class="udiff-line-modified-removed">-                 buffer[buffer_pos++] = static_cast&lt;char&gt;(*current);</span>
<span class="udiff-line-modified-removed">-                 significant_digits++;</span>
<span class="udiff-line-modified-removed">-             } else {</span>
<span class="udiff-line-modified-removed">-                 insignificant_digits++;  // Move the digit into the exponential part.</span>
<span class="udiff-line-modified-removed">-                 nonzero_digit_dropped = nonzero_digit_dropped || *current != &#39;0&#39;;</span>
<span class="udiff-line-modified-removed">-             }</span>
<span class="udiff-line-modified-added">+         return SignedZero(sign);</span>
<span class="udiff-line-modified-added">+       }</span>
<span class="udiff-line-modified-added">+     }</span>
<span class="udiff-line-modified-added">+   }</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+   // Copy significant digits of the integer part (if any) to the buffer.</span>
<span class="udiff-line-modified-added">+   while (isASCIIDigit(*current)) {</span>
<span class="udiff-line-modified-added">+     if (significant_digits &lt; kMaxSignificantDigits) {</span>
<span class="udiff-line-modified-added">+       ASSERT(buffer_pos &lt; kBufferSize);</span>
<span class="udiff-line-modified-added">+       buffer[buffer_pos++] = static_cast&lt;char&gt;(*current);</span>
<span class="udiff-line-modified-added">+       significant_digits++;</span>
<span class="udiff-line-modified-added">+     } else {</span>
<span class="udiff-line-modified-added">+       insignificant_digits++;  // Move the digit into the exponential part.</span>
<span class="udiff-line-modified-added">+       nonzero_digit_dropped = nonzero_digit_dropped || *current != &#39;0&#39;;</span>
<span class="udiff-line-modified-added">+     }</span>
      if (Advance(&amp;current, end)) goto parsing_done;
<span class="udiff-line-modified-removed">-         }</span>
<span class="udiff-line-modified-removed">-         </span>
<span class="udiff-line-modified-removed">-         if (*current == &#39;.&#39;) {</span>
<span class="udiff-line-modified-added">+   }</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+   if (*current == &#39;.&#39;) {</span>
      if (Advance(&amp;current, end)) {
<span class="udiff-line-modified-removed">-                 if (significant_digits == 0 &amp;&amp; !leading_zero) {</span>
<span class="udiff-line-modified-removed">-                     return 0.0;</span>
<span class="udiff-line-modified-removed">-                 } else {</span>
<span class="udiff-line-modified-removed">-                     goto parsing_done;</span>
<span class="udiff-line-modified-removed">-                 }</span>
<span class="udiff-line-modified-removed">-             }</span>
<span class="udiff-line-modified-removed">-             </span>
<span class="udiff-line-modified-removed">-             if (significant_digits == 0) {</span>
<span class="udiff-line-modified-removed">-                 // Integer part consists of 0 or is absent. Significant digits start after</span>
<span class="udiff-line-modified-removed">-                 // leading zeros (if any).</span>
<span class="udiff-line-modified-removed">-                 while (*current == &#39;0&#39;) {</span>
<span class="udiff-line-modified-added">+       if (significant_digits == 0 &amp;&amp; !leading_zero) {</span>
<span class="udiff-line-modified-added">+         return 0.0;</span>
<span class="udiff-line-modified-added">+       } else {</span>
<span class="udiff-line-modified-added">+         goto parsing_done;</span>
<span class="udiff-line-modified-added">+       }</span>
<span class="udiff-line-modified-added">+     }</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+     if (significant_digits == 0) {</span>
<span class="udiff-line-modified-added">+       // Integer part consists of 0 or is absent. Significant digits start after</span>
<span class="udiff-line-modified-added">+       // leading zeros (if any).</span>
<span class="udiff-line-modified-added">+       while (*current == &#39;0&#39;) {</span>
          if (Advance(&amp;current, end)) {
            *processed_characters_count = static_cast&lt;size_t&gt;(current - input);
<span class="udiff-line-modified-removed">-                         return SignedZero(sign);</span>
<span class="udiff-line-modified-removed">-                     }</span>
<span class="udiff-line-modified-removed">-                     exponent--;  // Move this 0 into the exponent.</span>
<span class="udiff-line-modified-removed">-                 }</span>
<span class="udiff-line-modified-removed">-             }</span>
<span class="udiff-line-modified-added">+           return SignedZero(sign);</span>
<span class="udiff-line-modified-added">+         }</span>
<span class="udiff-line-modified-added">+         exponent--;  // Move this 0 into the exponent.</span>
<span class="udiff-line-modified-added">+       }</span>
<span class="udiff-line-modified-added">+     }</span>
  
<span class="udiff-line-modified-removed">-             // There is a fractional part.</span>
<span class="udiff-line-modified-added">+     // There is a fractional part.</span>
      // We don&#39;t emit a &#39;.&#39;, but adjust the exponent instead.
<span class="udiff-line-modified-removed">-             while (isASCIIDigit(*current)) {</span>
<span class="udiff-line-modified-removed">-                 if (significant_digits &lt; kMaxSignificantDigits) {</span>
<span class="udiff-line-modified-removed">-                     ASSERT(buffer_pos &lt; kBufferSize);</span>
<span class="udiff-line-modified-removed">-                     buffer[buffer_pos++] = static_cast&lt;char&gt;(*current);</span>
<span class="udiff-line-modified-removed">-                     significant_digits++;</span>
<span class="udiff-line-modified-removed">-                     exponent--;</span>
<span class="udiff-line-modified-removed">-                 } else {</span>
<span class="udiff-line-modified-removed">-                     // Ignore insignificant digits in the fractional part.</span>
<span class="udiff-line-modified-removed">-                     nonzero_digit_dropped = nonzero_digit_dropped || *current != &#39;0&#39;;</span>
<span class="udiff-line-modified-removed">-                 }</span>
<span class="udiff-line-modified-added">+     while (isASCIIDigit(*current)) {</span>
<span class="udiff-line-modified-added">+       if (significant_digits &lt; kMaxSignificantDigits) {</span>
<span class="udiff-line-modified-added">+         ASSERT(buffer_pos &lt; kBufferSize);</span>
<span class="udiff-line-modified-added">+         buffer[buffer_pos++] = static_cast&lt;char&gt;(*current);</span>
<span class="udiff-line-modified-added">+         significant_digits++;</span>
<span class="udiff-line-modified-added">+         exponent--;</span>
<span class="udiff-line-modified-added">+       } else {</span>
<span class="udiff-line-modified-added">+         // Ignore insignificant digits in the fractional part.</span>
<span class="udiff-line-modified-added">+         nonzero_digit_dropped = nonzero_digit_dropped || *current != &#39;0&#39;;</span>
<span class="udiff-line-modified-added">+       }</span>
        if (Advance(&amp;current, end)) goto parsing_done;
<span class="udiff-line-modified-removed">-             }</span>
<span class="udiff-line-modified-removed">-         }</span>
<span class="udiff-line-modified-removed">-         </span>
<span class="udiff-line-modified-removed">-         if (!leading_zero &amp;&amp; exponent == 0 &amp;&amp; significant_digits == 0) {</span>
<span class="udiff-line-modified-removed">-             // If leading_zeros is true then the string contains zeros.</span>
<span class="udiff-line-modified-removed">-             // If exponent &lt; 0 then string was [+-]\.0*...</span>
<span class="udiff-line-modified-removed">-             // If significant_digits != 0 the string is not equal to 0.</span>
<span class="udiff-line-modified-removed">-             // Otherwise there are no digits in the string.</span>
<span class="udiff-line-modified-removed">-             return 0.0;</span>
<span class="udiff-line-modified-removed">-         }</span>
<span class="udiff-line-modified-removed">-         </span>
<span class="udiff-line-modified-removed">-         // Parse exponential part.</span>
<span class="udiff-line-modified-removed">-         if (*current == &#39;e&#39; || *current == &#39;E&#39;) {</span>
<span class="udiff-line-modified-removed">-             ++current;</span>
<span class="udiff-line-modified-removed">-             if (current == end) {</span>
<span class="udiff-line-modified-removed">-                 --current;</span>
<span class="udiff-line-modified-removed">-                 goto parsing_done;</span>
<span class="udiff-line-modified-removed">-             }</span>
<span class="udiff-line-modified-added">+     }</span>
<span class="udiff-line-modified-added">+   }</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+   if (!leading_zero &amp;&amp; exponent == 0 &amp;&amp; significant_digits == 0) {</span>
<span class="udiff-line-modified-added">+     // If leading_zeros is true then the string contains zeros.</span>
<span class="udiff-line-modified-added">+     // If exponent &lt; 0 then string was [+-]\.0*...</span>
<span class="udiff-line-modified-added">+     // If significant_digits != 0 the string is not equal to 0.</span>
<span class="udiff-line-modified-added">+     // Otherwise there are no digits in the string.</span>
<span class="udiff-line-modified-added">+     return 0.0;</span>
<span class="udiff-line-modified-added">+   }</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+   // Parse exponential part.</span>
<span class="udiff-line-modified-added">+   if (*current == &#39;e&#39; || *current == &#39;E&#39;) {</span>
<span class="udiff-line-modified-added">+     ++current;</span>
<span class="udiff-line-modified-added">+     if (current == end) {</span>
<span class="udiff-line-modified-added">+       --current;</span>
<span class="udiff-line-modified-added">+       goto parsing_done;</span>
<span class="udiff-line-modified-added">+     }</span>
      char exponen_sign = 0;
<span class="udiff-line-modified-removed">-             if (*current == &#39;+&#39; || *current == &#39;-&#39;) {</span>
<span class="udiff-line-modified-added">+     if (*current == &#39;+&#39; || *current == &#39;-&#39;) {</span>
        exponen_sign = static_cast&lt;char&gt;(*current);
<span class="udiff-line-modified-removed">-                 ++current;</span>
<span class="udiff-line-modified-removed">-                 if (current == end) {</span>
<span class="udiff-line-modified-removed">-                     current -= 2;</span>
<span class="udiff-line-modified-removed">-                     goto parsing_done;</span>
<span class="udiff-line-modified-removed">-                 }</span>
<span class="udiff-line-modified-removed">-             }</span>
<span class="udiff-line-modified-removed">-             </span>
<span class="udiff-line-modified-removed">-             if (*current &lt; &#39;0&#39; || *current &gt; &#39;9&#39;) {</span>
<span class="udiff-line-modified-added">+       ++current;</span>
<span class="udiff-line-modified-added">+       if (current == end) {</span>
<span class="udiff-line-modified-added">+         current -= 2;</span>
<span class="udiff-line-modified-added">+         goto parsing_done;</span>
<span class="udiff-line-modified-added">+       }</span>
<span class="udiff-line-modified-added">+     }</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+     if (*current &lt; &#39;0&#39; || *current &gt; &#39;9&#39;) {</span>
        if (exponen_sign)
<span class="udiff-line-modified-removed">-                     --current;</span>
<span class="udiff-line-modified-removed">-                 --current;</span>
<span class="udiff-line-modified-removed">-                 goto parsing_done;</span>
<span class="udiff-line-modified-removed">-             }</span>
<span class="udiff-line-modified-removed">-             </span>
<span class="udiff-line-modified-removed">-             const int max_exponent = INT_MAX / 2;</span>
<span class="udiff-line-modified-removed">-             ASSERT(-max_exponent / 2 &lt;= exponent &amp;&amp; exponent &lt;= max_exponent / 2);</span>
<span class="udiff-line-modified-removed">-             int num = 0;</span>
<span class="udiff-line-modified-removed">-             do {</span>
<span class="udiff-line-modified-removed">-                 // Check overflow.</span>
<span class="udiff-line-modified-removed">-                 int digit = *current - &#39;0&#39;;</span>
<span class="udiff-line-modified-removed">-                 if (num &gt;= max_exponent / 10</span>
<span class="udiff-line-modified-removed">-                     &amp;&amp; !(num == max_exponent / 10 &amp;&amp; digit &lt;= max_exponent % 10)) {</span>
<span class="udiff-line-modified-removed">-                     num = max_exponent;</span>
<span class="udiff-line-modified-removed">-                 } else {</span>
<span class="udiff-line-modified-removed">-                     num = num * 10 + digit;</span>
<span class="udiff-line-modified-removed">-                 }</span>
<span class="udiff-line-modified-removed">-                 ++current;</span>
<span class="udiff-line-modified-removed">-             } while (current != end &amp;&amp; isASCIIDigit(*current));</span>
<span class="udiff-line-modified-removed">-             </span>
<span class="udiff-line-modified-added">+         --current;</span>
<span class="udiff-line-modified-added">+       --current;</span>
<span class="udiff-line-modified-added">+       goto parsing_done;</span>
<span class="udiff-line-modified-added">+     }</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+     const int max_exponent = INT_MAX / 2;</span>
<span class="udiff-line-modified-added">+     ASSERT(-max_exponent / 2 &lt;= exponent &amp;&amp; exponent &lt;= max_exponent / 2);</span>
<span class="udiff-line-modified-added">+     int num = 0;</span>
<span class="udiff-line-modified-added">+     do {</span>
<span class="udiff-line-modified-added">+       // Check overflow.</span>
<span class="udiff-line-modified-added">+       int digit = *current - &#39;0&#39;;</span>
<span class="udiff-line-modified-added">+       if (num &gt;= max_exponent / 10</span>
<span class="udiff-line-modified-added">+           &amp;&amp; !(num == max_exponent / 10 &amp;&amp; digit &lt;= max_exponent % 10)) {</span>
<span class="udiff-line-modified-added">+         num = max_exponent;</span>
<span class="udiff-line-modified-added">+       } else {</span>
<span class="udiff-line-modified-added">+         num = num * 10 + digit;</span>
<span class="udiff-line-modified-added">+       }</span>
<span class="udiff-line-modified-added">+       ++current;</span>
<span class="udiff-line-modified-added">+     } while (current != end &amp;&amp; isASCIIDigit(*current));</span>
<span class="udiff-line-modified-added">+ </span>
      exponent += (exponen_sign == &#39;-&#39; ? -num : num);
<span class="udiff-line-modified-removed">-         }</span>
<span class="udiff-line-modified-removed">-         </span>
<span class="udiff-line-modified-removed">-     parsing_done:</span>
<span class="udiff-line-modified-removed">-         exponent += insignificant_digits;</span>
<span class="udiff-line-modified-removed">-         </span>
<span class="udiff-line-modified-removed">-         if (nonzero_digit_dropped) {</span>
<span class="udiff-line-modified-removed">-             buffer[buffer_pos++] = &#39;1&#39;;</span>
<span class="udiff-line-modified-removed">-             exponent--;</span>
<span class="udiff-line-modified-removed">-         }</span>
<span class="udiff-line-modified-removed">-         </span>
<span class="udiff-line-modified-removed">-         ASSERT(buffer_pos &lt; kBufferSize);</span>
<span class="udiff-line-modified-removed">-         buffer[buffer_pos] = &#39;\0&#39;;</span>
<span class="udiff-line-modified-removed">-         </span>
<span class="udiff-line-modified-added">+   }</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+   parsing_done:</span>
<span class="udiff-line-modified-added">+   exponent += insignificant_digits;</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+   if (nonzero_digit_dropped) {</span>
<span class="udiff-line-modified-added">+     buffer[buffer_pos++] = &#39;1&#39;;</span>
<span class="udiff-line-modified-added">+     exponent--;</span>
<span class="udiff-line-modified-added">+   }</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+   ASSERT(buffer_pos &lt; kBufferSize);</span>
<span class="udiff-line-modified-added">+   buffer[buffer_pos] = &#39;\0&#39;;</span>
<span class="udiff-line-modified-added">+ </span>
    auto converted = StringToFloatingPointType&lt;FloatingPointType&gt;(BufferReference&lt;const char&gt;(buffer, buffer_pos), exponent);
    *processed_characters_count = static_cast&lt;size_t&gt;(current - input);
<span class="udiff-line-modified-removed">-         return sign? -converted: converted;</span>
<span class="udiff-line-modified-added">+   return sign? -converted: converted;</span>
  }
  
  double StringToDoubleConverter::StringToDouble(
      const char* buffer,
      size_t length,
      size_t* processed_characters_count) {
    return StringToIeee&lt;double&gt;(buffer, length, processed_characters_count);
  }
<span class="udiff-line-modified-removed">-     </span>
<span class="udiff-line-modified-added">+ </span>
  
  double StringToDoubleConverter::StringToDouble(
      const uc16* buffer,
      size_t length,
      size_t* processed_characters_count) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -660,6 +660,6 @@</span>
      size_t* processed_characters_count) {
    return StringToIeee&lt;float&gt;(buffer, length, processed_characters_count);
  }
  
  }  // namespace double_conversion
<span class="udiff-line-modified-removed">- } // namespace WTF</span>
<span class="udiff-line-modified-added">+ }  // namespace WTF</span>
</pre>
<center><a href="diy-fp.h.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="double-conversion.h.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>