<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames modules/javafx.web/src/main/native/Source/WebKitLegacy/java/WebCoreSupport/WebPage.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>   1 /*
   2  * Copyright (c) 2011, 2019, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.  Oracle designates this
   8  * particular file as subject to the &quot;Classpath&quot; exception as provided
   9  * by Oracle in the LICENSE file that accompanied this code.
  10  *
  11  * This code is distributed in the hope that it will be useful, but WITHOUT
  12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  14  * version 2 for more details (a copy is included in the LICENSE file that
  15  * accompanied this code).
  16  *
  17  * You should have received a copy of the GNU General Public License version
  18  * 2 along with this work; if not, write to the Free Software Foundation,
  19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  20  *
  21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  22  * or visit www.oracle.com if you need additional information or have any
  23  * questions.
  24  */
  25 
  26 
  27 #if COMPILER(GCC) || COMPILER(CLANG)
  28 #pragma GCC diagnostic ignored &quot;-Wunused-parameter&quot;
  29 #endif
  30 
  31 #include &quot;WebPage.h&quot;
  32 
  33 #include &quot;BackForwardList.h&quot;
  34 #include &quot;ChromeClientJava.h&quot;
  35 #include &quot;ContextMenuClientJava.h&quot;
  36 #include &quot;ContextMenuJava.h&quot;
  37 #include &quot;DragClientJava.h&quot;
  38 #include &quot;EditorClientJava.h&quot;
  39 #include &quot;FrameLoaderClientJava.h&quot;
  40 #include &quot;InspectorClientJava.h&quot;
  41 #include &quot;PageStorageSessionProvider.h&quot;
  42 #include &quot;PlatformStrategiesJava.h&quot;
  43 #include &quot;ProgressTrackerClientJava.h&quot;
  44 #include &quot;VisitedLinkStoreJava.h&quot;
  45 #include &quot;WebKitLegacy/Storage/StorageNamespaceImpl.h&quot;
  46 #include &quot;WebKitLegacy/Storage/WebDatabaseProvider.h&quot;
  47 #include &quot;WebKitVersion.h&quot; //generated
  48 #include &quot;WebPageConfig.h&quot;
<a name="1" id="anc1"></a><span class="line-removed">  49 #include &quot;WebKitLogging.h&quot;</span>
  50 #include &lt;WebCore/WebCoreTestSupport.h&gt;
  51 #include &lt;JavaScriptCore/APICast.h&gt;
  52 #include &lt;JavaScriptCore/InitializeThreading.h&gt;
  53 #include &lt;JavaScriptCore/JSContextRef.h&gt;
  54 #include &lt;JavaScriptCore/JSContextRefPrivate.h&gt;
  55 #include &lt;JavaScriptCore/JSStringRef.h&gt;
  56 #include &lt;JavaScriptCore/Options.h&gt;
  57 #include &lt;WebCore/BackForwardController.h&gt;
  58 #include &lt;WebCore/BridgeUtils.h&gt;
  59 #include &lt;WebCore/CharacterData.h&gt;
  60 #include &lt;WebCore/Chrome.h&gt;
  61 #include &lt;WebCore/ContextMenu.h&gt;
  62 #include &lt;WebCore/ContextMenuController.h&gt;
  63 #include &lt;WebCore/CookieJar.h&gt;
  64 #include &lt;WebCore/DeprecatedGlobalSettings.h&gt;
  65 #include &lt;WebCore/Document.h&gt;
  66 #include &lt;WebCore/DragController.h&gt;
  67 #include &lt;WebCore/DragData.h&gt;
  68 #include &lt;WebCore/Editor.h&gt;
  69 #include &lt;WebCore/EmptyClients.h&gt;
  70 #include &lt;WebCore/EventHandler.h&gt;
  71 #include &lt;WebCore/FloatRect.h&gt;
  72 #include &lt;WebCore/FloatSize.h&gt;
  73 #include &lt;WebCore/FocusController.h&gt;
  74 #include &lt;WebCore/Frame.h&gt;
  75 #include &lt;WebCore/FrameLoadRequest.h&gt;
  76 #include &lt;WebCore/FrameTree.h&gt;
  77 #include &lt;WebCore/FrameView.h&gt;
  78 #include &lt;WebCore/GCController.h&gt;
  79 #include &lt;WebCore/GeolocationClientMock.h&gt;
  80 #include &lt;WebCore/GraphicsContext.h&gt;
  81 #include &lt;WebCore/GraphicsLayerTextureMapper.h&gt;
  82 #include &lt;WebCore/InspectorController.h&gt;
  83 #include &lt;WebCore/KeyboardEvent.h&gt;
  84 #include &lt;WebCore/NodeTraversal.h&gt;
  85 #include &lt;WebCore/Page.h&gt;
  86 #include &lt;WebCore/PageConfiguration.h&gt;
  87 #include &lt;WebCore/PageSupplementJava.h&gt;
  88 #include &lt;WebCore/PlatformContextJava.h&gt;
  89 #include &lt;WebCore/PlatformJavaClasses.h&gt;
  90 #include &lt;WebCore/PlatformKeyboardEvent.h&gt;
  91 #include &lt;WebCore/PlatformMouseEvent.h&gt;
  92 #include &lt;WebCore/PlatformTouchEvent.h&gt;
  93 #include &lt;WebCore/PlatformWheelEvent.h&gt;
  94 #include &lt;WebCore/RenderTreeAsText.h&gt;
  95 #include &lt;WebCore/RenderView.h&gt;
  96 #include &lt;WebCore/ResourceRequest.h&gt;
  97 #include &lt;WebCore/RuntimeEnabledFeatures.h&gt;
  98 #include &lt;WebCore/ScriptController.h&gt;
  99 #include &lt;WebCore/SecurityPolicy.h&gt;
 100 #include &lt;WebCore/Settings.h&gt;
 101 #include &lt;WebCore/StorageNamespaceProvider.h&gt;
 102 #include &lt;WebCore/TextIterator.h&gt;
 103 #include &lt;WebCore/TextureMapperJava.h&gt;
 104 #include &lt;WebCore/TextureMapperLayer.h&gt;
 105 #include &lt;WebCore/WorkerThread.h&gt;
 106 #include &lt;wtf/Ref.h&gt;
 107 #include &lt;wtf/RunLoop.h&gt;
 108 #include &lt;wtf/java/JavaRef.h&gt;
 109 #include &lt;wtf/text/WTFString.h&gt;
 110 
 111 // FIXME: Move dependency of runtime_root to BridgeUtils
 112 #include &lt;WebCore/runtime_root.h&gt;
 113 #if OS(UNIX)
 114 #include &lt;sys/utsname.h&gt;
 115 #endif
 116 #if OS(WINDOWS)
 117 #include &lt;WebCore/SystemInfo.h&gt;
 118 #endif
 119 
 120 
 121 #include &quot;com_sun_webkit_WebPage.h&quot;
 122 #include &quot;com_sun_webkit_event_WCFocusEvent.h&quot;
 123 #include &quot;com_sun_webkit_event_WCKeyEvent.h&quot;
 124 #include &quot;com_sun_webkit_event_WCMouseEvent.h&quot;
 125 
 126 #if ENABLE(NOTIFICATIONS) || ENABLE(LEGACY_NOTIFICATIONS)
 127 #include &lt;WebCore/NotificationController.h&gt;
 128 #include &quot;NotificationClientJava.h&quot;
 129 #endif
 130 
 131 namespace WebCore {
 132 
 133 WebPage::WebPage(std::unique_ptr&lt;Page&gt; page)
 134     : m_page(WTFMove(page))
 135 {
 136 #if ENABLE(NOTIFICATIONS) || ENABLE(LEGACY_NOTIFICATIONS)
 137     if(!NotificationController::from(m_page.get())) {
 138         provideNotification(m_page.get(), NotificationClientJava::instance());
 139     }
 140 #endif
 141 }
 142 
 143 WebPage::~WebPage()
 144 {
 145     debugEnded();
 146 }
 147 
 148 WebPage* WebPage::webPageFromJObject(const JLObject&amp; oWebPage)
 149 {
 150     JNIEnv* env = WTF::GetJavaEnv();
 151 
 152     static jmethodID midGetPageMethod = env-&gt;GetMethodID(
 153         PG_GetWebPageClass(env),
 154         &quot;getPage&quot;,
 155         &quot;()J&quot;);
 156     ASSERT(midGetPageMethod);
 157 
 158     jlong p = env-&gt;CallLongMethod(oWebPage, midGetPageMethod);
 159     WTF::CheckAndClearException(env);
 160 
 161     return webPageFromJLong(p);
 162 }
 163 
 164 JLObject WebPage::jobjectFromPage(Page* page)
 165 {
 166     if (!page)
 167         return nullptr;
 168 
 169     auto pageSupplement = PageSupplementJava::from(page);
 170     return pageSupplement ? pageSupplement-&gt;jWebPage() : nullptr;
 171 }
 172 
 173 void WebPage::setSize(const IntSize&amp; size)
 174 {
 175     Frame* mainFrame = (Frame*)&amp;m_page-&gt;mainFrame();
 176 
 177     FrameView* frameView = mainFrame-&gt;view();
 178     if (!frameView) {
 179         return;
 180     }
 181 
 182     frameView-&gt;resize(size);
 183     frameView-&gt;layoutContext().scheduleLayout();
 184 
 185     if (m_rootLayer) {
 186         m_rootLayer-&gt;setSize(size);
 187         m_rootLayer-&gt;setNeedsDisplay();
 188     }
 189 }
 190 
 191 static void drawDebugLed(GraphicsContext&amp; context,
 192                          const IntRect&amp; rect,
 193                          const Color&amp; color)
 194 {
 195     const int w = 50;
 196     const int h = 50;
 197     FloatRect ledRect(
 198             rect.x() + rect.width() / 2 - w / 2,
 199             rect.y() + rect.height() / 2 - h / 2,
 200             w,
 201             h);
 202     context.fillRect(ledRect, color);
 203 }
 204 
 205 static void drawDebugBorder(GraphicsContext&amp; context,
 206                             const IntRect&amp; rect,
 207                             const Color&amp; color,
 208                             int width)
 209 {
 210     int x = rect.x();
 211     int y = rect.y();
 212     int w = rect.width();
 213     int h = rect.height();
 214     context.fillRect(FloatRect(x, y, w, width));
 215     context.fillRect(FloatRect(x, y + h - width, w, width), color);
 216     context.fillRect(FloatRect(x, y, width, h), color);
 217     context.fillRect(FloatRect(x + w - width, y, width, h), color);
 218 }
 219 
 220 void WebPage::prePaint() {
 221     if (m_rootLayer) {
 222         if (m_syncLayers) {
 223             m_syncLayers = false;
 224             syncLayers();
 225         }
 226         return;
 227     }
 228 
 229     Frame* mainFrame = (Frame*)&amp;m_page-&gt;mainFrame();
 230     FrameView* frameView = mainFrame-&gt;view();
 231     if (frameView) {
 232         // Updating layout &amp; styles precedes normal painting.
 233         frameView-&gt;updateLayoutAndStyleIfNeededRecursive();
 234     }
 235 }
 236 
 237 RefPtr&lt;RQRef&gt; WebPage::jRenderTheme()
 238 {
 239     if (!m_jRenderTheme) {
 240         JNIEnv* env = WTF::GetJavaEnv();
 241         m_jRenderTheme = RQRef::create(PG_GetRenderThemeObjectFromPage(env, jobjectFromPage(m_page.get())));
 242     }
 243     return m_jRenderTheme;
 244 }
 245 
 246 void WebPage::paint(jobject rq, jint x, jint y, jint w, jint h)
 247 {
 248     if (m_rootLayer) {
 249         return;
 250     }
 251 
 252     DBG_CHECKPOINTEX(&quot;twkUpdateContent&quot;, 15, 100);
 253 
 254     RefPtr&lt;Frame&gt; mainFrame((Frame*)&amp;m_page-&gt;mainFrame());
 255     RefPtr&lt;FrameView&gt; frameView(mainFrame-&gt;view());
 256     if (!frameView) {
 257         return;
 258     }
 259 
 260     // Will be deleted by GraphicsContext destructor
 261     PlatformContextJava* ppgc = new PlatformContextJava(rq, jRenderTheme());
 262     GraphicsContext gc(ppgc);
 263 
 264     // TODO: Following JS synchronization is not necessary for single thread model
 265     JSGlobalContextRef globalContext = toGlobalRef(mainFrame-&gt;script().globalObject(mainThreadNormalWorld())-&gt;globalExec());
 266     JSC::JSLockHolder sw(toJS(globalContext)); // TODO-java: was JSC::APIEntryShim sw( toJS(globalContext) );
 267 
 268     frameView-&gt;paint(gc, IntRect(x, y, w, h));
 269     if (m_page-&gt;settings().showDebugBorders()) {
 270         drawDebugLed(gc, IntRect(x, y, w, h), Color(0, 0, 255, 128));
 271     }
 272 
 273     gc.platformContext()-&gt;rq().flushBuffer();
 274 }
 275 
 276 void WebPage::postPaint(jobject rq, jint x, jint y, jint w, jint h)
 277 {
 278     if (!m_page-&gt;inspectorController().highlightedNode()
 279             &amp;&amp; !m_rootLayer
 280     ) {
 281         return;
 282     }
 283 
 284     // Will be deleted by GraphicsContext destructor
 285     PlatformContextJava* ppgc = new PlatformContextJava(rq, jRenderTheme());
 286     GraphicsContext gc(ppgc);
 287 
 288     if (m_rootLayer) {
 289         if (m_syncLayers) {
 290             m_syncLayers = false;
 291             syncLayers();
 292         }
 293         renderCompositedLayers(gc, IntRect(x, y, w, h));
 294         if (m_page-&gt;settings().showDebugBorders()) {
 295             drawDebugLed(gc, IntRect(x, y, w, h), Color(0, 192, 0, 128));
 296         }
 297         if (downcast&lt;GraphicsLayerTextureMapper&gt;(m_rootLayer.get())-&gt;layer().descendantsOrSelfHaveRunningAnimations()) {
 298             requestJavaRepaint(pageRect());
 299         }
 300     }
 301 
 302     if (m_page-&gt;inspectorController().highlightedNode()) {
 303         m_page-&gt;inspectorController().drawHighlight(gc);
 304     }
 305 
 306     gc.platformContext()-&gt;rq().flushBuffer();
 307 }
 308 
 309 void WebPage::scroll(const IntSize&amp; scrollDelta,
 310                      const IntRect&amp; rectToScroll,
 311                      const IntRect&amp; clipRect)
 312 {
 313     if (m_rootLayer) {
 314         m_rootLayer-&gt;setNeedsDisplayInRect(rectToScroll);
 315         return;
 316     }
 317 
 318     JNIEnv* env = WTF::GetJavaEnv();
 319 
 320     static jmethodID mid = env-&gt;GetMethodID(
 321             PG_GetWebPageClass(env),
 322             &quot;fwkScroll&quot;,
 323             &quot;(IIIIII)V&quot;);
 324     ASSERT(mid);
 325 
 326     env-&gt;CallVoidMethod(
 327             jobjectFromPage(m_page.get()),
 328             mid,
 329             rectToScroll.x(),
 330             rectToScroll.y(),
 331             rectToScroll.width(),
 332             rectToScroll.height(),
 333             scrollDelta.width(),
 334             scrollDelta.height());
 335     WTF::CheckAndClearException(env);
 336 }
 337 
 338 void WebPage::repaint(const IntRect&amp; rect)
 339 {
 340     if (m_rootLayer) {
 341         m_rootLayer-&gt;setNeedsDisplayInRect(rect);
 342     }
 343     requestJavaRepaint(rect);
 344 }
 345 
 346 void WebPage::requestJavaRepaint(const IntRect&amp; rect)
 347 {
 348     JNIEnv* env = WTF::GetJavaEnv();
 349 
 350     static jmethodID mid = env-&gt;GetMethodID(
 351             PG_GetWebPageClass(env),
 352             &quot;fwkRepaint&quot;,
 353             &quot;(IIII)V&quot;);
 354     ASSERT(mid);
 355 
 356     env-&gt;CallVoidMethod(
 357             jobjectFromPage(m_page.get()),
 358             mid,
 359             rect.x(),
 360             rect.y(),
 361             rect.width(),
 362             rect.height());
 363     WTF::CheckAndClearException(env);
 364 }
 365 
 366 void WebPage::setRootChildLayer(GraphicsLayer* layer)
 367 {
 368     if (layer) {
 369         m_rootLayer = GraphicsLayer::create(nullptr, *this);
 370         m_rootLayer-&gt;setDrawsContent(true);
 371         m_rootLayer-&gt;setContentsOpaque(true);
 372         m_rootLayer-&gt;setSize(pageRect().size());
 373         m_rootLayer-&gt;setNeedsDisplay();
 374         m_rootLayer-&gt;addChild(*layer);
 375 
 376         m_textureMapper = TextureMapper::create();
 377         downcast&lt;GraphicsLayerTextureMapper&gt;(m_rootLayer.get())-&gt;layer()
 378                 .setTextureMapper(m_textureMapper.get());
 379     } else {
 380         m_rootLayer = nullptr;
 381         m_textureMapper.reset();
 382     }
 383 }
 384 
 385 void WebPage::setNeedsOneShotDrawingSynchronization()
 386 {
 387 }
 388 
 389 void WebPage::scheduleCompositingLayerSync()
 390 {
 391     markForSync();
 392 }
 393 
 394 void WebPage::markForSync()
 395 {
 396     if (!m_rootLayer) {
 397         return;
 398     }
 399     m_syncLayers = true;
 400     requestJavaRepaint(pageRect());
 401 }
 402 
 403 void WebPage::syncLayers()
 404 {
 405     if (!m_rootLayer) {
 406         return;
 407     }
 408 
 409     FrameView* frameView = m_page-&gt;mainFrame().view();
 410     if (!m_page-&gt;mainFrame().contentRenderer() || !frameView)
 411         return;
 412 
 413     frameView-&gt;updateLayoutAndStyleIfNeededRecursive();
 414     // Updating layout might have taken us out of compositing mode
 415     if (m_rootLayer) {
 416         m_rootLayer-&gt;flushCompositingStateForThisLayerOnly();
 417     }
 418 
 419     if (!frameView-&gt;flushCompositingStateIncludingSubframes())
 420         return;
 421 }
 422 
 423 IntRect WebPage::pageRect()
 424 {
 425     ChromeClient&amp; client = m_page-&gt;chrome().client();
 426     return IntRect(client.pageRect());
 427 }
 428 
 429 void WebPage::renderCompositedLayers(GraphicsContext&amp; context, const IntRect&amp; clip)
 430 {
 431     ASSERT(m_rootLayer);
 432     ASSERT(m_textureMapper);
 433 
 434     TextureMapperLayer&amp; rootTextureMapperLayer = downcast&lt;GraphicsLayerTextureMapper&gt;(*m_rootLayer).layer();
 435 
 436     static_cast&lt;TextureMapperJava&amp;&gt;(*m_textureMapper).setGraphicsContext(&amp;context);
 437     TransformationMatrix matrix;
 438     m_textureMapper-&gt;beginPainting();
 439     m_textureMapper-&gt;beginClip(matrix, clip);
 440     rootTextureMapperLayer.applyAnimationsRecursively(MonotonicTime::now());
 441     downcast&lt;GraphicsLayerTextureMapper&gt;(*m_rootLayer).updateBackingStoreIncludingSubLayers();
 442     rootTextureMapperLayer.paint();
 443     m_textureMapper-&gt;endClip();
 444     m_textureMapper-&gt;endPainting();
 445 }
 446 
 447 void WebPage::notifyAnimationStarted(const GraphicsLayer*, const String&amp; /*animationKey*/, MonotonicTime /*time*/)
 448 {
 449     ASSERT_NOT_REACHED();
 450 }
 451 
 452 void WebPage::notifyFlushRequired(const GraphicsLayer*)
 453 {
 454     markForSync();
 455 }
 456 
 457 void WebPage::paintContents(const GraphicsLayer*,
<a name="2" id="anc2"></a><span class="line-modified"> 458                             GraphicsContext&amp; context,</span>
<span class="line-modified"> 459                             GraphicsLayerPaintingPhase,</span>
<span class="line-modified"> 460                             const FloatRect&amp; inClip,</span>
<span class="line-modified"> 461                             GraphicsLayerPaintBehavior)</span>
 462 {
 463     context.save();
 464     context.clip(inClip);
 465     m_page-&gt;mainFrame().view()-&gt;paint(context, enclosingIntRect(inClip));
 466     if (m_page-&gt;settings().showDebugBorders()) {
 467         drawDebugBorder(context, roundedIntRect(inClip), Color(0, 192, 0), 20);
 468     }
 469     context.restore();
 470 }
 471 
 472 bool WebPage::processKeyEvent(const PlatformKeyboardEvent&amp; event)
 473 {
 474     return event.type() == PlatformKeyboardEvent::Char
 475         ? charEvent(event)
 476         : keyEvent(event);
 477 }
 478 
 479 //
 480 // The below keyboard event handling code was adapted from
 481 // WebKit/chromium/src/WebViewImpl.cpp
 482 //
 483 
 484 static const int VKEY_PRIOR = com_sun_webkit_event_WCKeyEvent_VK_PRIOR;
 485 static const int VKEY_NEXT = com_sun_webkit_event_WCKeyEvent_VK_NEXT;
 486 static const int VKEY_END = com_sun_webkit_event_WCKeyEvent_VK_END;
 487 static const int VKEY_HOME = com_sun_webkit_event_WCKeyEvent_VK_HOME;
 488 static const int VKEY_LEFT = com_sun_webkit_event_WCKeyEvent_VK_LEFT;
 489 static const int VKEY_UP = com_sun_webkit_event_WCKeyEvent_VK_UP;
 490 static const int VKEY_RIGHT = com_sun_webkit_event_WCKeyEvent_VK_RIGHT;
 491 static const int VKEY_DOWN = com_sun_webkit_event_WCKeyEvent_VK_DOWN;
 492 
 493 bool WebPage::keyEvent(const PlatformKeyboardEvent&amp; event)
 494 {
 495     ASSERT((event.type() == PlatformKeyboardEvent::RawKeyDown)
 496         || (event.type() == PlatformKeyboardEvent::KeyDown)
 497         || (event.type() == PlatformKeyboardEvent::KeyUp));
 498 
 499     // Please refer to the comments explaining the m_suppressNextKeypressEvent
 500     // member.
 501     // The m_suppressNextKeypressEvent is set if the KeyDown is handled by
 502     // Webkit. A keyDown event is typically associated with a keyPress(char)
 503     // event and a keyUp event. We reset this flag here as this is a new keyDown
 504     // event.
 505     m_suppressNextKeypressEvent = false;
 506 
 507     RefPtr&lt;Frame&gt; frame = focusedWebCoreFrame();
 508     if (!frame)
 509         return false;
 510 
 511     EventHandler&amp; handler = frame-&gt;eventHandler();
 512 
 513     if (handler.keyEvent(event)) {
 514         if (event.type() == PlatformKeyboardEvent::RawKeyDown) {
 515             // Suppress the next keypress event unless the focused node
 516             // is a plug-in node. (Flash needs these keypress events to
 517             // handle non-US keyboards.)
 518             Node* node = focusedWebCoreNode();
 519             if (!node || !node-&gt;renderer()
 520                     || !node-&gt;renderer()-&gt;isEmbeddedObject())
 521                 m_suppressNextKeypressEvent = true;
 522         }
 523         return true;
 524     }
 525 
 526     return keyEventDefault(event);
 527 }
 528 
 529 bool WebPage::charEvent(const PlatformKeyboardEvent&amp; event)
 530 {
 531     ASSERT(event.type() == PlatformKeyboardEvent::Char);
 532 
 533     // Please refer to the comments explaining the m_suppressNextKeypressEvent
 534     // member.  The m_suppressNextKeypressEvent is set if the KeyDown is
 535     // handled by Webkit. A keyDown event is typically associated with a
 536     // keyPress(char) event and a keyUp event. We reset this flag here as it
 537     // only applies to the current keyPress event.
 538     bool suppress = m_suppressNextKeypressEvent;
 539     m_suppressNextKeypressEvent = false;
 540 
 541     Frame* frame = focusedWebCoreFrame();
 542     if (!frame)
 543         return suppress;
 544 
 545     EventHandler&amp; handler = frame-&gt;eventHandler();
 546 
 547     if (!suppress &amp;&amp; !handler.keyEvent(event))
 548         return keyEventDefault(event);
 549 
 550     return true;
 551 }
 552 
 553 bool WebPage::keyEventDefault(const PlatformKeyboardEvent&amp; event)
 554 {
 555     Frame* frame = focusedWebCoreFrame();
 556     if (!frame)
 557         return false;
 558 
 559     switch (event.type()) {
 560     case PlatformKeyboardEvent::RawKeyDown:
 561         if (event.modifiers() == PlatformKeyboardEvent::Modifier::ControlKey) {
 562             switch (event.windowsVirtualKeyCode()) {
 563             // Match FF behavior in the sense that Ctrl+home/end are the only
 564             // Ctrl // key combinations which affect scrolling. Safari is buggy
 565             // in the sense that it scrolls the page for all Ctrl+scrolling key
 566             // combinations. For e.g. Ctrl+pgup/pgdn/up/down, etc.
 567             case VKEY_HOME:
 568             case VKEY_END:
 569                 break;
 570             default:
 571                 return false;
 572             }
 573         }
 574         if (!event.shiftKey())
 575             return scrollViewWithKeyboard(event.windowsVirtualKeyCode(), event);
 576         break;
 577     default:
 578         break;
 579     }
 580     return false;
 581 }
 582 
 583 bool WebPage::scrollViewWithKeyboard(int keyCode, const PlatformKeyboardEvent&amp; event)
 584 {
 585     ScrollDirection scrollDirection;
 586     ScrollGranularity scrollGranularity;
 587 #if OS(DARWIN)
 588     if (event.metaKey()) {
 589         if (keyCode == VKEY_UP)
 590             keyCode = VKEY_HOME;
 591         else if (keyCode == VKEY_DOWN)
 592             keyCode = VKEY_END;
 593     }
 594     if (event.altKey()) {
 595         if (keyCode == VKEY_UP)
 596             keyCode = VKEY_PRIOR;
 597         else if (keyCode == VKEY_DOWN)
 598             keyCode = VKEY_NEXT;
 599     }
 600 #endif
 601     if (!mapKeyCodeForScroll(keyCode, &amp;scrollDirection, &amp;scrollGranularity))
 602         return false;
 603     return propagateScroll(scrollDirection, scrollGranularity);
 604 }
 605 
 606 bool WebPage::mapKeyCodeForScroll(int keyCode,
 607                                   ScrollDirection* scrollDirection,
 608                                   ScrollGranularity* scrollGranularity)
 609 {
 610     switch (keyCode) {
 611     case VKEY_LEFT:
 612         *scrollDirection = ScrollLeft;
 613         *scrollGranularity = ScrollByLine;
 614         break;
 615     case VKEY_RIGHT:
 616         *scrollDirection = ScrollRight;
 617         *scrollGranularity = ScrollByLine;
 618         break;
 619     case VKEY_UP:
 620         *scrollDirection = ScrollUp;
 621         *scrollGranularity = ScrollByLine;
 622         break;
 623     case VKEY_DOWN:
 624         *scrollDirection = ScrollDown;
 625         *scrollGranularity = ScrollByLine;
 626         break;
 627     case VKEY_HOME:
 628         *scrollDirection = ScrollUp;
 629         *scrollGranularity = ScrollByDocument;
 630         break;
 631     case VKEY_END:
 632         *scrollDirection = ScrollDown;
 633         *scrollGranularity = ScrollByDocument;
 634         break;
 635     case VKEY_PRIOR:  // page up
 636         *scrollDirection = ScrollUp;
 637         *scrollGranularity = ScrollByPage;
 638         break;
 639     case VKEY_NEXT:  // page down
 640         *scrollDirection = ScrollDown;
 641         *scrollGranularity = ScrollByPage;
 642         break;
 643     default:
 644         return false;
 645     }
 646 
 647     return true;
 648 }
 649 
 650 bool WebPage::propagateScroll(ScrollDirection scrollDirection,
 651                               ScrollGranularity scrollGranularity)
 652 {
 653     Frame* frame = focusedWebCoreFrame();
 654     if (!frame)
 655         return false;
 656 
 657     bool scrollHandled = frame-&gt;eventHandler().scrollOverflow(
 658             scrollDirection,
 659             scrollGranularity);
 660     Frame* currentFrame = frame;
 661     while (!scrollHandled &amp;&amp; currentFrame) {
 662         scrollHandled = currentFrame-&gt;view()-&gt;scroll(scrollDirection,
 663                                                      scrollGranularity);
 664         currentFrame = currentFrame-&gt;tree().parent();
 665     }
 666     return scrollHandled;
 667 }
 668 
 669 Frame* WebPage::focusedWebCoreFrame()
 670 {
 671     return &amp;m_page-&gt;focusController().focusedOrMainFrame();
 672 }
 673 
 674 Node* WebPage::focusedWebCoreNode()
 675 {
 676     Frame* frame = m_page-&gt;focusController().focusedFrame();
 677     if (!frame)
 678         return 0;
 679 
 680     Document* document = frame-&gt;document();
 681     if (!document)
 682         return 0;
 683 
 684     return (Node*)document-&gt;focusedElement();
 685 }
 686 
 687 //implemented in customized WebCore/page/java/DragControllerJava.cpp
 688 void setCopyKeyState(bool _copyKeyIsDown);
 689 
 690 static String agentOS()
 691 {
 692 #if OS(DARWIN)
 693 #if CPU(X86) || CPU(X86_64)
 694     return &quot;Macintosh; Intel Mac OS X&quot;;
 695 #else
 696     return &quot;Macintosh; PPC Mac OS X&quot;;
 697 #endif
 698 #elif OS(UNIX)
 699     struct utsname name;
 700     if (uname(&amp;name) != -1)
 701         return makeString(name.sysname, &#39; &#39;, name.machine);
 702 #elif OS(WINDOWS)
 703     return windowsVersionForUAString();
 704 #else
 705     notImplemented();
 706 #endif
 707     return &quot;Unknown&quot;;
 708 }
 709 
 710 static String defaultUserAgent()
 711 {
 712     static const auto userAgentString = makeNeverDestroyed([] {
 713         String wkVersion = makeString(
 714                               WEBKIT_MAJOR_VERSION, &quot;.&quot;, WEBKIT_MINOR_VERSION,
 715                               &quot; (KHTML, like Gecko) JavaFX/&quot;, JAVAFX_RELEASE_VERSION,
 716                               &quot; Safari/&quot;, WEBKIT_MAJOR_VERSION, &quot;.&quot;,  WEBKIT_MINOR_VERSION);
 717         return makeString(&quot;Mozilla/5.0 (&quot;, agentOS(), &quot;) AppleWebKit/&quot;, wkVersion);
 718     }());
 719     return userAgentString;
 720 }
 721 
 722 int WebPage::beginPrinting(float width, float height)
 723 {
 724     Frame* frame = (Frame*)&amp;m_page-&gt;mainFrame();
 725     if (!frame-&gt;document() || !frame-&gt;view())
 726         return 0;
 727     frame-&gt;document()-&gt;updateLayout();
 728 
 729     ASSERT(!m_printContext);
 730     m_printContext = std::unique_ptr&lt;PrintContext&gt;(new PrintContext(frame));
 731     m_printContext-&gt;begin(width, height);
 732     m_printContext-&gt;computePageRects(FloatRect(0, 0, width, height), 0, 0, 1, height);
 733     return m_printContext-&gt;pageCount();
 734 }
 735 
 736 void WebPage::endPrinting()
 737 {
 738     ASSERT(m_printContext);
 739     if (!m_printContext)
 740         return;
 741 
 742     m_printContext-&gt;end();
 743     m_printContext.reset();
 744 }
 745 
 746 void WebPage::print(GraphicsContext&amp; gc, int pageIndex, float pageWidth)
 747 {
 748     ASSERT(m_printContext);
 749     ASSERT(pageIndex &gt;= 0 &amp;&amp; pageIndex &lt; m_printContext-&gt;pageCount());
 750 
 751     if (!m_printContext || pageIndex &lt; 0 || pageIndex &gt;= (int)m_printContext-&gt;pageCount())
 752         return;
 753 
 754     gc.save();
 755     gc.translate(0, 0);
 756     m_printContext-&gt;spoolPage(gc, pageIndex, pageWidth);
 757     gc.restore();
 758     gc.platformContext()-&gt;rq().flushBuffer();
 759 }
 760 
 761 int WebPage::globalDebugSessionCounter = 0;
 762 
 763 void WebPage::debugStarted() {
 764     if (!m_isDebugging) {
 765         m_isDebugging = true;
 766         globalDebugSessionCounter++;
 767 
 768         disableWatchdog();
 769     }
 770 }
 771 void WebPage::debugEnded() {
 772     if (m_isDebugging) {
 773         m_isDebugging = false;
 774         globalDebugSessionCounter--;
 775 
 776         enableWatchdog();
 777     }
 778 }
 779 void WebPage::enableWatchdog() {
 780     if (globalDebugSessionCounter == 0) {
 781         JSContextGroupRef contextGroup = toRef(&amp;mainThreadNormalWorld().vm());
 782         JSContextGroupSetExecutionTimeLimit(contextGroup, 10, 0, 0);
 783     }
 784 }
 785 
 786 void WebPage::disableWatchdog() {
 787     if (globalDebugSessionCounter &gt; 0) {
 788         JSContextGroupRef contextGroup = toRef(&amp;(mainThreadNormalWorld().vm()));
 789         JSContextGroupClearExecutionTimeLimit(contextGroup);
 790     }
 791 }
 792 
 793 } // namespace WebCore
 794 
 795 using namespace WebCore;
 796 using namespace WTF;
 797 
 798 class WebStorageNamespaceProviderJava final : public WebCore::StorageNamespaceProvider {
 799 public:
 800     void setLocalStorageDatabasePath(const String&amp; path) {
 801         m_localStorageDatabasePath = path;
 802     }
 803 private:
 804     String m_localStorageDatabasePath;
 805 
<a name="3" id="anc3"></a><span class="line-modified"> 806     Ref&lt;StorageNamespace&gt; createSessionStorageNamespace(Page&amp;, unsigned quota) override</span>
 807     {
<a name="4" id="anc4"></a><span class="line-modified"> 808         return WebKit::StorageNamespaceImpl::createSessionStorageNamespace(quota);</span>
 809     }
 810 
<a name="5" id="anc5"></a><span class="line-modified"> 811     Ref&lt;StorageNamespace&gt; createLocalStorageNamespace(unsigned quota) override</span>
 812     {
<a name="6" id="anc6"></a><span class="line-modified"> 813         return WebKit::StorageNamespaceImpl::getOrCreateLocalStorageNamespace(m_localStorageDatabasePath, quota);</span>
 814     }
 815 
<a name="7" id="anc7"></a><span class="line-modified"> 816     Ref&lt;StorageNamespace&gt; createTransientLocalStorageNamespace(SecurityOrigin&amp;, unsigned quota) override</span>
 817     {
 818         // FIXME: A smarter implementation would create a special namespace type instead of just piggy-backing off
 819         // SessionStorageNamespace here.
<a name="8" id="anc8"></a><span class="line-modified"> 820         return WebKit::StorageNamespaceImpl::createSessionStorageNamespace(quota);</span>
<span class="line-removed"> 821     }</span>
<span class="line-removed"> 822 </span>
<span class="line-removed"> 823     Ref&lt;StorageNamespace&gt; createEphemeralLocalStorageNamespace(Page&amp;, unsigned quota) override</span>
<span class="line-removed"> 824     {</span>
<span class="line-removed"> 825         return WebKit::StorageNamespaceImpl::createEphemeralLocalStorageNamespace(quota);</span>
 826     }
 827 };
 828 
 829 namespace {
 830 
 831 bool s_useJIT;
 832 bool s_useDFGJIT;
 833 bool s_useCSS3D;
 834 
 835 }  // namespace
 836 
 837 extern &quot;C&quot; {
 838 
 839 JNIEXPORT void JNICALL Java_com_sun_webkit_WebPage_twkInitWebCore
 840     (JNIEnv* env, jclass self, jboolean useJIT, jboolean useDFGJIT, jboolean useCSS3D) {
 841     s_useJIT = useJIT;
 842     s_useDFGJIT = useDFGJIT;
 843     s_useCSS3D = useCSS3D;
 844 }
 845 
 846 JNIEXPORT jlong JNICALL Java_com_sun_webkit_WebPage_twkCreatePage
 847     (JNIEnv* env, jobject self, jboolean editable)
 848 {
 849     // FIXME-java(JDK-8169950): Refactor the following WebCore module
 850     // initialization flow.
 851     JSC::initializeThreading();
 852     WTF::initializeMainThread();
 853     RunLoop::initializeMainRunLoop();
 854     // RT-17330: Allow local loads for substitute data, that is,
 855     // for content loaded with twkLoad
 856     WebCore::SecurityPolicy::setLocalLoadPolicy(
 857             WebCore::SecurityPolicy::AllowLocalLoadsForLocalAndSubstituteData);
 858 
 859     //DBG_CHECKPOINTEX(&quot;twkCreatePage&quot;, 3, 5);
 860 
 861     VisitedLinkStoreJava::setShouldTrackVisitedLinks(true);
 862 
 863 #if !LOG_DISABLED
 864     WebKitInitializeLogChannelsIfNecessary();
 865 #endif
 866     WebCore::PlatformStrategiesJava::initialize();
 867 
 868     static std::once_flag initializeJSCOptions;
 869     std::call_once(initializeJSCOptions, [] {
 870         JSC::Options::useJIT() = s_useJIT;
 871         // Enable DFG only if JIT is enabled.
 872         JSC::Options::useDFGJIT() = s_useJIT &amp;&amp; s_useDFGJIT;
 873     });
 874 
 875     JLObject jlself(self, true);
 876 
 877     //utaTODO: history agent implementation
 878 
 879     auto pc = pageConfigurationWithEmptyClients();
 880     auto pageStorageSessionProvider = PageStorageSessionProvider::create();
 881     pc.cookieJar = CookieJar::create(pageStorageSessionProvider.copyRef());
 882     pc.chromeClient = new ChromeClientJava(jlself);
 883     pc.contextMenuClient = new ContextMenuClientJava(jlself);
 884     pc.editorClient = makeUniqueRef&lt;EditorClientJava&gt;(jlself);
 885     pc.dragClient = new DragClientJava(jlself);
 886     pc.inspectorClient = new InspectorClientJava(jlself);
 887     pc.databaseProvider = &amp;WebDatabaseProvider::singleton();
 888     pc.storageNamespaceProvider = adoptRef(new WebStorageNamespaceProviderJava());
 889     pc.visitedLinkStore = VisitedLinkStoreJava::create();
 890 
 891     pc.loaderClientForMainFrame = new FrameLoaderClientJava(jlself);
 892     pc.progressTrackerClient = new ProgressTrackerClientJava(jlself);
 893 
 894     pc.backForwardClient = BackForwardList::create();
 895     auto page = std::make_unique&lt;Page&gt;(WTFMove(pc));
 896     // Associate PageSupplementJava instance which has WebPage java object.
 897     page-&gt;provideSupplement(PageSupplementJava::supplementName(), std::make_unique&lt;PageSupplementJava&gt;(self));
 898     pageStorageSessionProvider-&gt;setPage(*page);
 899 #if ENABLE(GEOLOCATION)
 900     WebCore::provideGeolocationTo(page.get(), *new GeolocationClientMock());
 901 #endif
 902     return ptr_to_jlong(new WebPage(WTFMove(page)));
 903 }
 904 
 905 JNIEXPORT void JNICALL Java_com_sun_webkit_WebPage_twkInit
 906     (JNIEnv* env, jobject self, jlong pPage, jboolean usePlugins, jfloat devicePixelScale)
 907 {
 908     Page* page = WebPage::pageFromJLong(pPage);
 909 
 910     /* Initialization of the default settings */
 911     Settings&amp; settings = page-&gt;settings();
 912     settings.setTextAreasAreResizable(true);
 913     settings.setLoadsImagesAutomatically(true);
 914     settings.setMinimumFontSize(0);
 915     settings.setMinimumLogicalFontSize(5);
 916     settings.setAcceleratedCompositingEnabled(s_useCSS3D);
 917     settings.setScriptEnabled(true);
 918     settings.setJavaScriptCanOpenWindowsAutomatically(true);
 919     settings.setPluginsEnabled(usePlugins);
 920     settings.setDefaultFixedFontSize(13);
 921     settings.setDefaultFontSize(16);
 922     settings.setContextMenuEnabled(true);
 923     settings.setUserAgent(defaultUserAgent());
 924     settings.setMaximumHTMLParserDOMTreeDepth(180);
 925     settings.setXSSAuditorEnabled(true);
 926     settings.setInteractiveFormValidationEnabled(true);
 927 
 928     /* Using java logical fonts as defaults */
 929     settings.setSerifFontFamily(&quot;Serif&quot;);
 930     settings.setSansSerifFontFamily(&quot;SansSerif&quot;);
 931     settings.setFixedFontFamily(&quot;Monospaced&quot;);
 932     page-&gt;setDeviceScaleFactor(devicePixelScale);
 933 
 934     RuntimeEnabledFeatures::sharedFeatures().setLinkPrefetchEnabled(true);
 935     RuntimeEnabledFeatures::sharedFeatures().setInputTypeColorEnabled(true);
 936     static_cast&lt;FrameLoaderClientJava&amp;&gt;(page-&gt;mainFrame().loader().client())
 937                                             .setFrame(&amp;page-&gt;mainFrame());
 938 
 939     page-&gt;mainFrame().init();
 940 
 941     JSContextGroupRef contextGroup = toRef(&amp;(mainThreadNormalWorld().vm()));
 942     JSContextGroupSetExecutionTimeLimit(contextGroup, 10, 0, 0);
 943 
 944     WebPage::webPageFromJLong(pPage)-&gt;enableWatchdog();
 945 }
 946 
 947 JNIEXPORT void JNICALL Java_com_sun_webkit_WebPage_twkDestroyPage
 948     (JNIEnv* env, jobject self, jlong pPage)
 949 {
 950     WebPage* webPage = WebPage::webPageFromJLong(pPage);
 951     if (!webPage) {
 952         return;
 953     }
 954 
 955     Frame* mainFrame = (Frame*)&amp;webPage-&gt;page()-&gt;mainFrame();
 956     if (mainFrame) {
 957         mainFrame-&gt;loader().stopAllLoaders();
 958         mainFrame-&gt;loader().detachFromParent();
 959     }
 960 
 961     delete webPage;
 962 }
 963 
 964 JNIEXPORT jlong JNICALL Java_com_sun_webkit_WebPage_twkGetMainFrame
 965     (JNIEnv* env, jobject self, jlong pPage)
 966 {
 967     Page* page = WebPage::pageFromJLong(pPage);
 968     if (!page) {
 969         return 0;
 970     }
 971     Frame* mainFrame = (Frame*)&amp;page-&gt;mainFrame();
 972     if (!mainFrame) {
 973         return 0;
 974     }
 975     return ptr_to_jlong(mainFrame);
 976 }
 977 
 978 JNIEXPORT jlong JNICALL Java_com_sun_webkit_WebPage_twkGetParentFrame
 979     (JNIEnv* env, jobject self, jlong pFrame)
 980 {
 981     Frame* frame = static_cast&lt;Frame*&gt;(jlong_to_ptr(pFrame));
 982     if (!frame) {
 983         return 0;
 984     }
 985     Frame* parentFrame = frame-&gt;tree().parent();
 986     if (!parentFrame) {
 987         return 0;
 988     }
 989     return ptr_to_jlong(parentFrame);
 990 }
 991 
 992 JNIEXPORT jlongArray JNICALL Java_com_sun_webkit_WebPage_twkGetChildFrames
 993     (JNIEnv* env, jobject self, jlong pFrame)
 994 {
 995     Frame* frame = static_cast&lt;Frame*&gt;(jlong_to_ptr(pFrame));
 996     if (!frame) {
 997         return 0;
 998     }
 999 
1000     FrameTree&amp; tree = frame-&gt;tree();
1001 
1002     jlongArray jArray = env-&gt;NewLongArray(tree.childCount());
1003     jlong *arr = env-&gt;GetLongArrayElements(jArray, 0);
1004     int i = 0;
1005     for (Frame* child = tree.firstChild(); child; child = child-&gt;tree().nextSibling()) {
1006         arr[i++] = ptr_to_jlong(child);
1007     }
1008     env-&gt;ReleaseLongArrayElements(jArray, arr, 0);
1009 
1010     return jArray;
1011 }
1012 
1013 JNIEXPORT jstring JNICALL Java_com_sun_webkit_WebPage_twkGetName
1014     (JNIEnv* env, jobject self, jlong pFrame)
1015 {
1016     Frame* frame = static_cast&lt;Frame*&gt;(jlong_to_ptr(pFrame));
1017     if (!frame) {
1018         return 0;
1019     }
1020     return frame-&gt;tree().uniqueName().string().toJavaString(env).releaseLocal();
1021 }
1022 
1023 JNIEXPORT jstring JNICALL Java_com_sun_webkit_WebPage_twkGetURL
1024     (JNIEnv* env, jobject self, jlong pFrame)
1025 {
1026     Frame* frame = static_cast&lt;Frame*&gt;(jlong_to_ptr(pFrame));
1027     if (!frame || !frame-&gt;document()) {
1028         return 0;
1029     }
1030     Document* doc = frame-&gt;document();
1031     if (!doc) {
1032         return 0;
1033     }
1034     return doc-&gt;url().string().toJavaString(env).releaseLocal();
1035 }
1036 
1037 JNIEXPORT jstring JNICALL Java_com_sun_webkit_WebPage_twkGetInnerText
1038     (JNIEnv* env, jobject self, jlong pFrame)
1039 {
1040     Frame* frame = static_cast&lt;Frame*&gt;(jlong_to_ptr(pFrame));
1041     if (!frame) {
1042         return 0;
1043     }
1044 
1045     Document* document = frame-&gt;document();
1046     if (!document) {
1047         return 0;
1048     }
1049 
1050     Element* documentElement = document-&gt;documentElement();
1051     if (!documentElement) {
1052         return 0;
1053     }
1054 
1055     FrameView* frameView = frame-&gt;view();
1056     if (frameView &amp;&amp; frameView-&gt;layoutContext().isLayoutPending()) {
1057         frameView-&gt;layoutContext().layout();
1058     }
1059 
1060     return documentElement-&gt;innerText().toJavaString(env).releaseLocal();
1061 }
1062 
1063 JNIEXPORT jstring JNICALL Java_com_sun_webkit_WebPage_twkGetRenderTree
1064     (JNIEnv* env, jobject self, jlong pFrame)
1065 {
1066     Frame* frame = static_cast&lt;Frame*&gt;(jlong_to_ptr(pFrame));
1067     if (!frame || !frame-&gt;contentRenderer()) {
1068         return 0;
1069     }
1070 
1071     FrameView* frameView = frame-&gt;view();
1072     if (frameView &amp;&amp; frameView-&gt;layoutContext().isLayoutPending()) {
1073         frameView-&gt;layoutContext().layout();
1074     }
1075 
1076     return externalRepresentation(frame).toJavaString(env).releaseLocal();
1077 }
1078 
1079 JNIEXPORT jstring JNICALL Java_com_sun_webkit_WebPage_twkGetContentType
1080     (JNIEnv* env, jobject self, jlong pFrame)
1081 {
1082     Frame* frame = static_cast&lt;Frame*&gt;(jlong_to_ptr(pFrame));
1083     if (!frame || !frame-&gt;loader().documentLoader()) {
1084         return 0;
1085     }
1086     return frame-&gt;loader().documentLoader()-&gt;responseMIMEType().toJavaString(env).releaseLocal();
1087 }
1088 
1089 JNIEXPORT jstring JNICALL Java_com_sun_webkit_WebPage_twkGetTitle
1090     (JNIEnv* env, jobject self, jlong pFrame)
1091 {
1092     Frame* frame = static_cast&lt;Frame*&gt;(jlong_to_ptr(pFrame));
1093     if (!frame || !frame-&gt;document()) {
1094         return 0;
1095     }
1096     return frame-&gt;document()-&gt;title().toJavaString(env).releaseLocal();
1097 }
1098 
1099 JNIEXPORT jstring JNICALL Java_com_sun_webkit_WebPage_twkGetIconURL
1100     (JNIEnv* env, jobject self, jlong pFrame)
1101 {
1102     Frame* frame = static_cast&lt;Frame*&gt;(jlong_to_ptr(pFrame));
1103     if (!frame) {
1104         return 0;
1105     }
1106 #if ENABLE(ICONDATABASE)
1107     return frame-&gt;loader()-&gt;icon()-&gt;url().string().toJavaString(env).releaseLocal();
1108 #else
1109     return 0;
1110 #endif
1111 }
1112 
1113 JNIEXPORT void JNICALL Java_com_sun_webkit_WebPage_twkOpen
1114     (JNIEnv* env, jobject self, jlong pFrame, jstring url)
1115 {
1116     Frame* frame = static_cast&lt;Frame*&gt;(jlong_to_ptr(pFrame));
1117     if (!frame) {
1118         return;
1119     }
1120 
1121     static const URL emptyParent;
1122 
1123     frame-&gt;loader().load(FrameLoadRequest(
1124         *frame,
1125         ResourceRequest(URL(emptyParent, String(env, url))),
1126         ShouldOpenExternalURLsPolicy::ShouldNotAllow // TODO-java: recheck policy value
1127     ));
1128 }
1129 
1130 JNIEXPORT void JNICALL Java_com_sun_webkit_WebPage_twkLoad
1131     (JNIEnv* env, jobject self, jlong pFrame, jstring text, jstring contentType)
1132 {
1133     Frame* frame = static_cast&lt;Frame*&gt;(jlong_to_ptr(pFrame));
1134     if (!frame) {
1135         return;
1136     }
1137 
1138     const char* stringChars = env-&gt;GetStringUTFChars(text, JNI_FALSE);
1139     size_t stringLen = (size_t)env-&gt;GetStringUTFLength(text);
1140     RefPtr&lt;SharedBuffer&gt; buffer = SharedBuffer::create(stringChars, (int)stringLen);
1141 
1142     static const URL emptyUrl({ }, &quot;&quot;);
1143     ResourceResponse response(URL(), String(env, contentType), stringLen, &quot;UTF-8&quot;);
1144     frame-&gt;loader().load(FrameLoadRequest(
1145         *frame,
1146         ResourceRequest(emptyUrl),
1147         ShouldOpenExternalURLsPolicy::ShouldNotAllow, // TODO-java: recheck policy value
1148         SubstituteData(
1149             WTFMove(buffer),
1150             URL(),
1151             response,
1152             SubstituteData::SessionHistoryVisibility::Visible) // TODO-java: or Hidden?
1153     ));
1154 
1155     env-&gt;ReleaseStringUTFChars(text, stringChars);
1156 }
1157 
1158 JNIEXPORT jboolean JNICALL Java_com_sun_webkit_WebPage_twkIsLoading
1159     (JNIEnv* env, jobject self, jlong pFrame)
1160 {
1161     Frame* frame = static_cast&lt;Frame*&gt;(jlong_to_ptr(pFrame));
1162 
1163     return bool_to_jbool(frame &amp;&amp; frame-&gt;loader().isLoading());
1164 }
1165 
1166 JNIEXPORT void JNICALL Java_com_sun_webkit_WebPage_twkStop
1167     (JNIEnv* env, jobject self, jlong pFrame)
1168 {
1169     Frame* frame = static_cast&lt;Frame*&gt;(jlong_to_ptr(pFrame));
1170     if (!frame) {
1171         return;
1172     }
1173 
1174     frame-&gt;loader().stopAllLoaders();
1175 }
1176 
1177 JNIEXPORT void JNICALL Java_com_sun_webkit_WebPage_twkStopAll
1178     (JNIEnv* env, jobject self, jlong pPage)
1179 {
1180     Page* page = WebPage::pageFromJLong(pPage);
1181     if (!page) {
1182         return;
1183     }
1184 
1185     page-&gt;mainFrame().loader().stopAllLoaders();
1186 }
1187 
1188 JNIEXPORT void JNICALL Java_com_sun_webkit_WebPage_twkRefresh
1189     (JNIEnv* env, jobject self, jlong pFrame)
1190 {
1191     Frame* frame = static_cast&lt;Frame*&gt;(jlong_to_ptr(pFrame));
1192     if (!frame) {
1193         return;
1194     }
1195 
1196     frame-&gt;loader().reload(ReloadOption::FromOrigin);
1197 }
1198 
1199 JNIEXPORT jboolean JNICALL Java_com_sun_webkit_WebPage_twkGoBackForward
1200     (JNIEnv* env, jobject self, jlong pPage, jint distance)
1201 {
1202     Page* page = WebPage::pageFromJLong(pPage);
1203     if (!page) {
1204         return JNI_FALSE;
1205     }
1206 
1207     if (page-&gt;backForward().canGoBackOrForward(distance)) {
1208         page-&gt;backForward().goBackOrForward(distance);
1209         return JNI_TRUE;
1210     }
1211 
1212     return JNI_FALSE;
1213 }
1214 
1215 JNIEXPORT jboolean JNICALL Java_com_sun_webkit_WebPage_twkCopy
1216     (JNIEnv* env, jobject self, jlong pFrame)
1217 {
1218     Frame* frame = static_cast&lt;Frame*&gt;(jlong_to_ptr(pFrame));
1219     if (!frame) {
1220         return JNI_FALSE;
1221     }
1222 
1223     if (frame-&gt;editor().canCopy()) {
1224         frame-&gt;editor().copy();
1225         return JNI_TRUE;
1226     }
1227 
1228     return JNI_FALSE;
1229 }
1230 
1231 
1232 JNIEXPORT jboolean JNICALL Java_com_sun_webkit_WebPage_twkFindInPage
1233     (JNIEnv* env, jobject self, jlong pPage,
1234      jstring toFind, jboolean forward, jboolean wrap, jboolean matchCase)
1235 {
1236     Page* page = WebPage::pageFromJLong(pPage);
1237     if (page) {
1238         FindOptions opts;
1239         if (!matchCase)
1240             opts.add(CaseInsensitive);
1241         if (!forward)
1242             opts.add(Backwards);
1243         if (wrap)
1244             opts.add(WrapAround);
1245         return bool_to_jbool(page-&gt;findString(String(env, toFind), opts));
1246     }
1247     return JNI_FALSE;
1248 }
1249 
1250 JNIEXPORT jboolean JNICALL Java_com_sun_webkit_WebPage_twkFindInFrame
1251     (JNIEnv* env, jobject self, jlong pFrame,
1252      jstring toFind, jboolean forward, jboolean wrap, jboolean matchCase)
1253 {
1254     Frame* frame = static_cast&lt;Frame*&gt;(jlong_to_ptr(pFrame));
1255     if (frame) {
1256         //utatodo: support for the rest of FindOptionFlag
1257         FindOptions opts;
1258         if (!matchCase)
1259             opts.add(CaseInsensitive);
1260         if (!forward)
1261             opts.add(Backwards);
1262         if (wrap)
1263             opts.add(WrapAround);
1264         return bool_to_jbool(frame-&gt;page()-&gt;findString(
1265             String(env, toFind), opts | StartInSelection));
1266     }
1267     return JNI_FALSE;
1268 }
1269 
1270 JNIEXPORT void JNICALL Java_com_sun_webkit_WebPage_twkOverridePreference
1271     (JNIEnv* env, jobject self, jlong pPage, jstring propertyName, jstring propertyValue)
1272 {
1273     Page* page = WebPage::pageFromJLong(pPage);
1274     if (!page) {
1275         return;
1276     }
1277 
1278     Settings&amp; settings = page-&gt;settings();
1279     String nativePropertyName(env, propertyName);
1280     String nativePropertyValue(env, propertyValue);
1281 
1282     if (nativePropertyName == &quot;WebKitTextAreasAreResizable&quot;) {
1283         settings.setTextAreasAreResizable(nativePropertyValue.toInt());
1284     } else if (nativePropertyName == &quot;WebKitLoadsImagesAutomatically&quot;) {
1285         settings.setLoadsImagesAutomatically(nativePropertyValue.toInt());
1286     } else if (nativePropertyName == &quot;WebKitMinimumFontSize&quot;) {
1287         settings.setMinimumFontSize(nativePropertyValue.toInt());
1288     } else if (nativePropertyName == &quot;WebKitMinimumLogicalFontSize&quot;) {
1289         settings.setMinimumLogicalFontSize(nativePropertyValue.toInt());
1290     } else if (nativePropertyName == &quot;WebKitAcceleratedCompositingEnabled&quot;) {
1291         settings.setAcceleratedCompositingEnabled(nativePropertyValue.toInt());
1292     } else if (nativePropertyName == &quot;WebKitScriptEnabled&quot;) {
1293         settings.setScriptEnabled(nativePropertyValue.toInt());
1294     } else if (nativePropertyName == &quot;WebKitJavaScriptCanOpenWindowsAutomatically&quot;) {
1295         settings.setJavaScriptCanOpenWindowsAutomatically(nativePropertyValue.toInt());
1296     } else if (nativePropertyName == &quot;WebKitPluginsEnabled&quot;) {
1297         settings.setPluginsEnabled(nativePropertyValue.toInt());
1298     } else if (nativePropertyName == &quot;WebKitDefaultFixedFontSize&quot;) {
1299         settings.setDefaultFixedFontSize(nativePropertyValue.toInt());
1300     } else if (nativePropertyName == &quot;WebKitContextMenuEnabled&quot;) {
1301         settings.setContextMenuEnabled(nativePropertyValue.toInt());
1302     } else if (nativePropertyName == &quot;WebKitUserAgent&quot;) {
1303         settings.setUserAgent(nativePropertyValue);
1304     } else if (nativePropertyName == &quot;WebKitMaximumHTMLParserDOMTreeDepth&quot;) {
1305         settings.setMaximumHTMLParserDOMTreeDepth(nativePropertyValue.toUInt());
1306     } else if (nativePropertyName == &quot;WebKitXSSAuditorEnabled&quot;)  {
1307         settings.setXSSAuditorEnabled(nativePropertyValue.toInt());
1308     } else if (nativePropertyName == &quot;WebKitSerifFontFamily&quot;) {
1309         settings.setSerifFontFamily(nativePropertyValue);
1310     } else if (nativePropertyName == &quot;WebKitSansSerifFontFamily&quot;) {
1311         settings.setSansSerifFontFamily(nativePropertyValue);
1312     } else if (nativePropertyName == &quot;WebKitFixedFontFamily&quot;) {
1313         settings.setFixedFontFamily(nativePropertyValue);
1314     } else if (nativePropertyName == &quot;WebKitShowsURLsInToolTips&quot;) {
1315         settings.setShowsURLsInToolTips(nativePropertyValue.toInt());
1316     } else if (nativePropertyName == &quot;WebKitUsesPageCachePreferenceKey&quot;) {
1317         settings.setUsesPageCache(nativePropertyValue.toInt() != 0);
1318     } else if (nativePropertyName == &quot;WebKitJavaScriptCanAccessClipboardPreferenceKey&quot;) {
1319         settings.setJavaScriptCanAccessClipboard(nativePropertyValue.toInt() != 0);
1320     } else if (nativePropertyName == &quot;enableColorFilter&quot;) {
1321         settings.setColorFilterEnabled(nativePropertyValue == &quot;true&quot;);
<a name="9" id="anc9"></a>



1322     } else if (nativePropertyName == &quot;experimental:WebAnimationsCSSIntegrationEnabled&quot;) {
1323         RuntimeEnabledFeatures::sharedFeatures().setWebAnimationsCSSIntegrationEnabled(nativePropertyValue == &quot;true&quot;);
1324     } else if (nativePropertyName == &quot;enableIntersectionObserver&quot;) {
1325 #if ENABLE(INTERSECTION_OBSERVER)
1326         RuntimeEnabledFeatures::sharedFeatures().setIntersectionObserverEnabled(nativePropertyValue == &quot;true&quot;);
1327 #endif
1328     } else if(nativePropertyName == &quot;jscOptions&quot; &amp;&amp; !nativePropertyValue.isEmpty()) {
1329         JSC::Options::setOptions(nativePropertyValue.utf8().data());
1330     } else if(nativePropertyName == &quot;experimental:CSSCustomPropertiesAndValuesEnabled&quot;) {
1331         RuntimeEnabledFeatures::sharedFeatures().setCSSCustomPropertiesAndValuesEnabled(nativePropertyValue == &quot;true&quot;);
1332     }
1333 }
1334 
1335 JNIEXPORT void JNICALL Java_com_sun_webkit_WebPage_twkResetToConsistentStateBeforeTesting
1336     (JNIEnv* env, jobject self, jlong pPage)
1337 {
1338     Page* page = WebPage::pageFromJLong(pPage);
1339     if (!page) {
1340         return;
1341     }
1342 
1343     Settings&amp; settings = page-&gt;settings();
1344 
1345     settings.setAllowUniversalAccessFromFileURLs(true);
1346     settings.setAllowFileAccessFromFileURLs(true);
1347     // settings.setStandardFontFamily(standardFamily);
1348     // settings.setFixedFontFamily(fixedFamily);
1349     // settings.setSerifFontFamily(standardFamily);
1350     // settings.setSansSerifFontFamily(sansSerifFamily);
1351     // settings.setCursiveFontFamily(cursiveFamily);
1352     // settings.setFantasyFontFamily(fantasyFamily);
1353     // settings.setPictographFontFamily(pictographFamily);
1354     settings.setDefaultFontSize(16);
1355     settings.setDefaultFixedFontSize(13);
1356     settings.setMinimumFontSize(0);
1357     settings.setDefaultTextEncodingName(&quot;ISO-8859-1&quot;);
1358     settings.setJavaEnabled(false);
1359     settings.setFullScreenEnabled(true);
1360     settings.setScriptEnabled(true);
1361     settings.setEditableLinkBehavior(EditableLinkOnlyLiveWithShiftKey);
1362     // settings.setTabsToLinks(false);
1363     settings.setDOMPasteAllowed(true);
1364     settings.setShouldPrintBackgrounds(true);
1365     // settings.setCacheModel(WebCacheModelDocumentBrowser);
1366     settings.setXSSAuditorEnabled(false);
1367     settings.setExperimentalNotificationsEnabled(false);
1368     settings.setPluginsEnabled(true);
1369     settings.setTextAreasAreResizable(true);
1370     settings.setUsesPageCache(false);
1371     settings.setCSSOMViewScrollingAPIEnabled(true);
1372 
1373     // settings.setPrivateBrowsingEnabled(false);
1374     settings.setAuthorAndUserStylesEnabled(true);
1375     // Shrinks standalone images to fit: YES
1376     settings.setJavaScriptCanOpenWindowsAutomatically(true);
1377     settings.setJavaScriptCanAccessClipboard(true);
1378     settings.setOfflineWebApplicationCacheEnabled(true);
1379     // settings.setDeveloperExtrasEnabled(false);
1380     settings.setJavaScriptRuntimeFlags(JSC::RuntimeFlags(0));
1381     // Set JS experiments enabled: YES
1382     settings.setLoadsImagesAutomatically(true);
1383     settings.setLoadsSiteIconsIgnoringImageLoadingSetting(false);
1384     settings.setFrameFlattening(FrameFlattening::Disabled);
1385     settings.setFontRenderingMode(FontRenderingMode::Normal);
1386     // Doesn&#39;t work well with DRT
1387     settings.setScrollAnimatorEnabled(false);
1388     // Set spatial navigation enabled: NO
1389 
1390     // Set WebGL Enabled: NO
1391     // settings.setCSSRegionsEnabled(true);
1392     // Set uses HTML5 parser quirks: NO
1393     // Async spellcheck: NO
1394     DeprecatedGlobalSettings::setMockScrollbarsEnabled(true);
1395 
1396 
1397     RuntimeEnabledFeatures::sharedFeatures().setFetchAPIEnabled(true);
1398     RuntimeEnabledFeatures::sharedFeatures().setShadowDOMEnabled(true);
1399     RuntimeEnabledFeatures::sharedFeatures().setCustomElementsEnabled(true);
1400     RuntimeEnabledFeatures::sharedFeatures().setModernMediaControlsEnabled(false);
1401     RuntimeEnabledFeatures::sharedFeatures().setResourceTimingEnabled(true);
1402     RuntimeEnabledFeatures::sharedFeatures().setUserTimingEnabled(true);
1403     RuntimeEnabledFeatures::sharedFeatures().setDataTransferItemsEnabled(true);
1404     RuntimeEnabledFeatures::sharedFeatures().setInspectorAdditionsEnabled(true);
1405     RuntimeEnabledFeatures::sharedFeatures().setWebAnimationsEnabled(true);
1406     // RuntimeEnabledFeatures::sharedFeatures().clearNetworkLoaderSession();
1407 
1408     Frame&amp; coreFrame = page-&gt;mainFrame();
1409     auto globalContext = toGlobalRef(coreFrame.script().globalObject(mainThreadNormalWorld())-&gt;globalExec());
1410     WebCoreTestSupport::resetInternalsObject(globalContext);
1411 }
1412 
1413 JNIEXPORT jfloat JNICALL Java_com_sun_webkit_WebPage_twkGetZoomFactor
1414     (JNIEnv* env, jobject self, jlong pFrame, jboolean textOnly)
1415 {
1416     Frame* frame = static_cast&lt;Frame*&gt;(jlong_to_ptr(pFrame));
1417     ASSERT(frame);
1418     if (!frame) {
1419         return 1.0;
1420     }
1421     return textOnly
1422         ? frame-&gt;textZoomFactor()
1423         : frame-&gt;pageZoomFactor();
1424 }
1425 
1426 JNIEXPORT void JNICALL Java_com_sun_webkit_WebPage_twkSetZoomFactor
1427     (JNIEnv* env, jobject self, jlong pFrame, jfloat zoomFactor, jboolean textOnly)
1428 {
1429     Frame* frame = static_cast&lt;Frame*&gt;(jlong_to_ptr(pFrame));
1430     ASSERT(frame);
1431     if (!frame) {
1432         return;
1433     }
1434     if (textOnly) {
1435         frame-&gt;setTextZoomFactor(zoomFactor);
1436     } else {
1437         frame-&gt;setPageZoomFactor(zoomFactor);
1438     }
1439 }
1440 
1441 JNIEXPORT jobject JNICALL Java_com_sun_webkit_WebPage_twkExecuteScript
1442     (JNIEnv* env, jobject self, jlong pFrame, jstring script)
1443 {
1444     Frame* frame = static_cast&lt;Frame*&gt;(jlong_to_ptr(pFrame));
1445     if (!frame) {
1446         return nullptr;
1447     }
1448     JSGlobalContextRef globalContext = getGlobalContext(&amp;frame-&gt;script());
1449     RefPtr&lt;JSC::Bindings::RootObject&gt; rootObject(frame-&gt;script().createRootObject(frame));
1450     return WebCore::executeScript(
1451         env,
1452         nullptr,
1453         globalContext,
1454         rootObject.get(),
1455         script);
1456 }
1457 
1458 JNIEXPORT void JNICALL Java_com_sun_webkit_WebPage_twkAddJavaScriptBinding
1459     (JNIEnv* env, jobject self, jlong pFrame, jstring name, jobject value, jobject accessControlContext)
1460 {
1461     Frame* frame = static_cast&lt;Frame*&gt;(jlong_to_ptr(pFrame));
1462     if (!frame) {
1463         return;
1464     }
1465     JSGlobalContextRef globalContext = getGlobalContext(&amp;frame-&gt;script());
1466     JSObjectRef window = JSContextGetGlobalObject(globalContext);
1467     RefPtr&lt;JSC::Bindings::RootObject&gt; rootObject(frame-&gt;script().createRootObject(frame));
1468 
1469     JSValueRef jsval = WebCore::Java_Object_to_JSValue(
1470         env,
1471         globalContext,
1472         rootObject.get(),
1473         value, accessControlContext);
1474 
1475     JSStringRef jsname = asJSStringRef(env, name);
1476     JSValueRef exception;
1477     if (JSValueIsUndefined(globalContext, jsval)) {
1478         JSObjectDeleteProperty(globalContext, window, jsname, &amp;exception);
1479     } else {
1480         JSPropertyAttributes attributes = 0;
1481         JSObjectSetProperty(globalContext, window, jsname, jsval, attributes, &amp;exception);
1482     }
1483     JSStringRelease(jsname);
1484 }
1485 
1486 JNIEXPORT void JNICALL Java_com_sun_webkit_WebPage_twkReset
1487     (JNIEnv* env, jobject self, jlong pFrame)
1488 {
1489     Frame* frame = static_cast&lt;Frame*&gt;(jlong_to_ptr(pFrame));
1490     if (!frame) {
1491         return;
1492     }
1493 
1494     frame-&gt;tree().clearName();
1495 }
1496 
1497 JNIEXPORT jint JNICALL Java_com_sun_webkit_WebPage_twkBeginPrinting
1498     (JNIEnv* env, jobject self, jlong pPage, jfloat width, jfloat height)
1499 {
1500     return WebPage::webPageFromJLong(pPage)-&gt;beginPrinting(width, height);
1501 }
1502 
1503 JNIEXPORT void JNICALL Java_com_sun_webkit_WebPage_twkEndPrinting
1504     (JNIEnv* env, jobject self, jlong pPage)
1505 {
1506     return WebPage::webPageFromJLong(pPage)-&gt;endPrinting();
1507 }
1508 
1509 JNIEXPORT void JNICALL Java_com_sun_webkit_WebPage_twkPrint
1510     (JNIEnv* env, jobject self, jlong pPage, jobject rq, jint pageIndex, jfloat width)
1511 {
1512     auto webPage = WebPage::webPageFromJLong(pPage);
1513     PlatformContextJava* ppgc = new PlatformContextJava(rq, webPage-&gt;jRenderTheme());
1514     GraphicsContext gc(ppgc);
1515     webPage-&gt;print(gc, pageIndex, width);
1516 }
1517 
1518 JNIEXPORT jint JNICALL Java_com_sun_webkit_WebPage_twkGetFrameHeight
1519     (JNIEnv* env, jobject self, jlong pFrame)
1520 {
1521     Frame* frame = static_cast&lt;Frame*&gt;(jlong_to_ptr(pFrame));
1522     if (!frame || !frame-&gt;contentRenderer()) {
1523         return 0;
1524     }
1525 
1526     return frame-&gt;contentRenderer()-&gt;viewLogicalHeight();
1527 /*
1528     bool isFrameSet = frame-&gt;document() &amp;&amp; frame-&gt;document()-&gt;isFrameSet();
1529     if (isFrameSet) {
1530         RenderView* root = static_cast&lt;RenderView*&gt;(frame-&gt;document()-&gt;renderer());
1531         return root-&gt;bottomLayoutOverflow();
1532     } else {
1533         return frame-&gt;contentRenderer()-&gt;bottomLayoutOverflow();
1534     }
1535 */
1536 }
1537 
1538 JNIEXPORT jfloat JNICALL Java_com_sun_webkit_WebPage_twkAdjustFrameHeight
1539     (JNIEnv* env, jobject self, jlong pFrame,
1540      jfloat oldTop, jfloat oldBottom, jfloat bottomLimit)
1541 {
1542     Frame* frame = static_cast&lt;Frame*&gt;(jlong_to_ptr(pFrame));
1543     if (!frame || !frame-&gt;view()) {
1544         return oldBottom;
1545     }
1546 
1547     float result;
1548     frame-&gt;view()-&gt;adjustPageHeightDeprecated(&amp;result, oldTop, oldBottom, bottomLimit);
1549     return result;
1550 }
1551 
1552 JNIEXPORT void JNICALL Java_com_sun_webkit_WebPage_twkSetBounds
1553     (JNIEnv* env, jobject self, jlong pPage, jint x, jint y, jint w, jint h)
1554 {
1555     WebPage::webPageFromJLong(pPage)-&gt;setSize(IntSize(w, h));
1556 }
1557 
1558 JNIEXPORT jintArray JNICALL Java_com_sun_webkit_WebPage_twkGetVisibleRect
1559     (JNIEnv* env, jobject self, jlong pFrame)
1560 {
1561     Frame* frame = static_cast&lt;Frame*&gt;(jlong_to_ptr(pFrame));
1562     if (!frame || !frame-&gt;view()) {
1563         return nullptr;
1564     }
1565     IntRect rect = frame-&gt;view()-&gt;visibleContentRect();
1566 
1567     jintArray result = env-&gt;NewIntArray(4);
1568     WTF::CheckAndClearException(env);
1569 
1570     jint* arr = (jint*)env-&gt;GetPrimitiveArrayCritical(result, nullptr);
1571     arr[0] = rect.x();
1572     arr[1] = rect.y();
1573     arr[2] = rect.width();
1574     arr[3] = rect.height();
1575     env-&gt;ReleasePrimitiveArrayCritical(result, arr, 0);
1576 
1577     return result;
1578 }
1579 
1580 JNIEXPORT void JNICALL Java_com_sun_webkit_WebPage_twkScrollToPosition
1581     (JNIEnv* env, jobject self, jlong pFrame, jint x, jint y)
1582 {
1583     Frame* frame = static_cast&lt;Frame*&gt;(jlong_to_ptr(pFrame));
1584     if (!frame || !frame-&gt;view()) {
1585         return;
1586     }
1587     frame-&gt;view()-&gt;setScrollPosition(IntPoint(x, y));
1588 }
1589 
1590 JNIEXPORT jintArray JNICALL Java_com_sun_webkit_WebPage_twkGetContentSize
1591     (JNIEnv* env, jobject self, jlong pFrame)
1592 {
1593     Frame* frame = static_cast&lt;Frame*&gt;(jlong_to_ptr(pFrame));
1594     if (!frame || !frame-&gt;view()) {
1595         return nullptr;
1596     }
1597     IntSize size = frame-&gt;view()-&gt;contentsSize();
1598 
1599     jintArray result = env-&gt;NewIntArray(2);
1600     WTF::CheckAndClearException(env);
1601 
1602     jint* arr = (jint*)env-&gt;GetPrimitiveArrayCritical(result, nullptr);
1603     arr[0] = size.width();
1604     arr[1] = size.height();
1605     env-&gt;ReleasePrimitiveArrayCritical(result, arr, 0);
1606 
1607     return result;
1608 }
1609 
1610 JNIEXPORT void JNICALL Java_com_sun_webkit_WebPage_twkSetTransparent
1611 (JNIEnv* env, jobject self, jlong pFrame, jboolean isTransparent)
1612 {
1613     Frame* frame = static_cast&lt;Frame*&gt;(jlong_to_ptr(pFrame));
1614     if (!frame || !frame-&gt;view()) {
1615         return;
1616     }
1617     frame-&gt;view()-&gt;setTransparent(isTransparent);
1618 }
1619 
1620 JNIEXPORT void JNICALL Java_com_sun_webkit_WebPage_twkSetBackgroundColor
1621 (JNIEnv* env, jobject self, jlong pFrame, jint backgroundColor)
1622 {
1623     Frame* frame = static_cast&lt;Frame*&gt;(jlong_to_ptr(pFrame));
1624     if (!frame || !frame-&gt;view()) {
1625         return;
1626     }
1627     frame-&gt;view()-&gt;setBaseBackgroundColor(Color(RGBA32(backgroundColor)));
1628 }
1629 
1630 JNIEXPORT void JNICALL Java_com_sun_webkit_WebPage_twkPrePaint
1631   (JNIEnv*, jobject, jlong pPage)
1632 {
1633     WebPage::webPageFromJLong(pPage)-&gt;prePaint();
1634 }
1635 
1636 JNIEXPORT void JNICALL Java_com_sun_webkit_WebPage_twkUpdateContent
1637     (JNIEnv* env, jobject self, jlong pPage, jobject rq, jint x, jint y, jint w, jint h)
1638 {
1639     WebPage::webPageFromJLong(pPage)-&gt;paint(rq, x, y, w, h);
1640 }
1641 
1642 JNIEXPORT void JNICALL Java_com_sun_webkit_WebPage_twkPostPaint
1643   (JNIEnv*, jobject, jlong pPage, jobject rq, jint x, jint y, jint w, jint h)
1644 {
1645     WebPage::webPageFromJLong(pPage)-&gt;postPaint(rq, x, y, w, h);
1646 }
1647 
1648 JNIEXPORT jstring JNICALL Java_com_sun_webkit_WebPage_twkGetEncoding
1649     (JNIEnv* env, jobject self, jlong pPage)
1650 {
1651     Page* p = WebPage::pageFromJLong(pPage);
1652     ASSERT(p);
1653     Frame* mainFrame = (Frame*)&amp;p-&gt;mainFrame();
1654     ASSERT(mainFrame);
1655 
1656     return mainFrame-&gt;document()-&gt;charset().toJavaString(env).releaseLocal();
1657 }
1658 
1659 JNIEXPORT void JNICALL Java_com_sun_webkit_WebPage_twkSetEncoding
1660     (JNIEnv* env, jobject self, jlong pPage, jstring encoding)
1661 {
1662     Page* p = WebPage::pageFromJLong(pPage);
1663     ASSERT(p);
1664     Frame* mainFrame = (Frame*)&amp;p-&gt;mainFrame();
1665     ASSERT(mainFrame);
1666 
1667     mainFrame-&gt;loader().reloadWithOverrideEncoding(String(env, encoding));
1668 }
1669 
1670 JNIEXPORT void JNICALL Java_com_sun_webkit_WebPage_twkProcessFocusEvent
1671     (JNIEnv* env, jobject self, jlong pPage,
1672      jint id, jint direction)
1673 {
1674     Page* page = WebPage::pageFromJLong(pPage);
1675     Frame* mainFrame = (Frame*)&amp;page-&gt;mainFrame();
1676 
1677     FocusController&amp; focusController = page-&gt;focusController();
1678 
1679     Frame* focusedFrame = focusController.focusedFrame();
1680     switch (id) {
1681         case com_sun_webkit_event_WCFocusEvent_FOCUS_GAINED:
1682             focusController.setActive(true); // window activation
1683             focusController.setFocused(true); // focus gained
1684             if (!focusedFrame) {
1685                 focusController.setFocusedFrame(mainFrame);
1686                 focusedFrame = mainFrame;
1687             }
1688             if (direction == com_sun_webkit_event_WCFocusEvent_FORWARD) {
1689                 // comment out the following line to get focus to the last
1690                 // focused node instead of the first focusable one
1691                 focusedFrame-&gt;document()-&gt;setFocusedElement(0);
1692                 focusController.advanceFocus(FocusDirectionForward, nullptr);
1693             } else if (direction == com_sun_webkit_event_WCFocusEvent_BACKWARD) {
1694                 // comment out the following line to get focus to the last
1695                 // focused node instead of the last focusable one
1696                 focusedFrame-&gt;document()-&gt;setFocusedElement(0);
1697                 focusController.advanceFocus(FocusDirectionBackward, nullptr);
1698             }
1699             break;
1700         case com_sun_webkit_event_WCFocusEvent_FOCUS_LOST:
1701             focusController.setFocused(false); // focus lost
1702             focusController.setActive(false); // window deactivation
1703             break;
1704     }
1705 }
1706 
1707 JNIEXPORT jboolean JNICALL Java_com_sun_webkit_WebPage_twkProcessKeyEvent
1708     (JNIEnv* env, jobject self, jlong pPage,
1709      jint type, jstring text, jstring keyIdentifier, jint windowsVirtualKeyCode,
1710      jboolean shift, jboolean ctrl, jboolean alt, jboolean meta, jdouble timestamp)
1711 {
1712     WebPage* webPage = WebPage::webPageFromJLong(pPage);
1713 
1714     PlatformKeyboardEvent event(type, text, keyIdentifier,
1715                                 windowsVirtualKeyCode,
1716                                 shift, ctrl, alt, meta, timestamp);
1717 
1718     return bool_to_jbool(webPage-&gt;processKeyEvent(event));
1719 }
1720 
1721 JNIEXPORT jboolean JNICALL Java_com_sun_webkit_WebPage_twkProcessMouseEvent
1722     (JNIEnv* env, jobject self, jlong pPage,
1723      jint id, jint button, jint clickCount,
1724      jint x, jint y, jint screenX, jint screenY,
1725      jboolean shift, jboolean ctrl, jboolean alt, jboolean meta,
1726      jboolean popupTrigger, jdouble timestamp)
1727 {
1728     Page* page = WebPage::pageFromJLong(pPage);
1729     Frame* frame = (Frame*)&amp;page-&gt;mainFrame();
1730 
1731     // Uncomment to debug mouse events
1732     // fprintf(stderr, &quot;twkProcessKeyEvent: &quot;
1733     //         &quot;id=%d button=%d clickCount=%d x=%d y=%d&quot;
1734     //         &quot;screenX=%d screenY=%d \n&quot;,
1735     //         id, button, clickCount, x, y, screenX, screenY);
1736 
1737     EventHandler&amp; eventHandler = frame-&gt;eventHandler();
1738 
1739     FrameView* frameView = frame-&gt;view();
1740     if (!frameView) {
1741         return false;
1742     }
1743 
1744     bool consumeEvent = false;
1745     IntPoint loc(x, y);
1746     PlatformMouseEvent mouseEvent = PlatformMouseEvent(loc,
1747                                                        IntPoint(screenX, screenY),
1748                                                        getWebCoreMouseButton(button),
1749                                                        getWebCoreMouseEventType(id),
1750                                                        clickCount,
1751                                                        shift, ctrl, alt, meta,
1752                                                        WallTime::fromRawSeconds(timestamp), ForceAtClick, NoTap); // TODO-java: handle force?
1753     switch (id) {
1754     case com_sun_webkit_event_WCMouseEvent_MOUSE_PRESSED:
1755         //frame-&gt;focusWindow();
1756         page-&gt;chrome().focus();
1757         consumeEvent = eventHandler.handleMousePressEvent(mouseEvent);
1758         break;
1759     case com_sun_webkit_event_WCMouseEvent_MOUSE_RELEASED:
1760         consumeEvent = eventHandler.handleMouseReleaseEvent(mouseEvent);
1761         break;
1762     case com_sun_webkit_event_WCMouseEvent_MOUSE_MOVED:
1763     case com_sun_webkit_event_WCMouseEvent_MOUSE_DRAGGED:
1764         consumeEvent = eventHandler.mouseMoved(mouseEvent);
1765         break;
1766     }
1767 
1768     if (popupTrigger &amp;&amp; page-&gt;settings().isContextMenuEnabled()) {
1769         ContextMenuController&amp; cmc = page-&gt;contextMenuController();
1770         cmc.clearContextMenu();
1771         bool handleEvent = eventHandler.sendContextMenuEvent(mouseEvent);
1772         if (!handleEvent) {
1773             return consumeEvent;
1774         }
1775 
1776         ContextMenu* contextMenu = cmc.contextMenu();
1777         // right-click in disabled text area (and probably many other
1778         // scenarios) result in nullptr contextMenu here
1779         if (!contextMenu) {
1780             return consumeEvent;
1781         }
1782 
1783         Node* node = cmc.hitTestResult().innerNonSharedNode();
1784         if (!node) {
1785             return consumeEvent;
1786         }
1787 
1788         Frame* frame = node-&gt;document().frame();
1789         // we do not want to show context menu for frameset (see 6648628)
1790         if (frame &amp;&amp; !frame-&gt;document()-&gt;isFrameSet()) {
1791             ContextMenuJava(contextMenu-&gt;items()).show(&amp;cmc, self, loc);
1792         }
1793         return JNI_TRUE;
1794     }
1795 
1796     return bool_to_jbool(consumeEvent);
1797 }
1798 
1799 JNIEXPORT jboolean JNICALL Java_com_sun_webkit_WebPage_twkProcessMouseWheelEvent
1800     (JNIEnv* env, jobject self, jlong pPage,
1801      jint x, jint y, jint screenX, jint screenY,
1802      jfloat deltaX, jfloat deltaY,
1803      jboolean shift, jboolean ctrl, jboolean alt, jboolean meta,
1804      jdouble timestamp)
1805 {
1806     Page* page = WebPage::pageFromJLong(pPage);
1807     Frame* frame = (Frame*)&amp;page-&gt;mainFrame();
1808 
1809     PlatformWheelEvent wheelEvent = PlatformWheelEvent(IntPoint(x, y),
1810                                                        IntPoint(screenX, screenY),
1811                                                        deltaX, deltaY,
1812                                                        shift, ctrl, alt, meta);
1813     bool consumeEvent = frame-&gt;eventHandler().handleWheelEvent(wheelEvent);
1814 
1815     return bool_to_jbool(consumeEvent);
1816 }
1817 
1818 #if ENABLE(TOUCH_EVENTS)
1819 JNIEXPORT jboolean JNICALL Java_com_sun_webkit_WebPage_twkProcessTouchEvent
1820     (JNIEnv* env, jobject self, jlong pPage, jint id, jobject touchData,
1821      jboolean shift, jboolean ctrl, jboolean alt, jboolean meta, jfloat timestamp)
1822 {
1823     Page* page = WebPage::pageFromJLong(pPage);
1824     Frame* frame = page-&gt;mainFrame();
1825 
1826     ASSERT(frame-&gt;eventHandler());
1827     if (!frame-&gt;eventHandler()) {
1828         return JNI_FALSE;
1829     }
1830 
1831     PlatformTouchEvent ev(env, id, touchData, shift, ctrl, alt, meta, timestamp);
1832     bool consumeEvent = frame-&gt;eventHandler().handleTouchEvent(ev);
1833     return bool_to_jbool(consumeEvent);
1834 }
1835 #endif
1836 
1837 JNIEXPORT jboolean JNICALL Java_com_sun_webkit_WebPage_twkProcessInputTextChange
1838     (JNIEnv* env, jobject self, jlong pPage,
1839      jstring jcommitted, jstring jcomposed, jintArray jattributes, jint caretPosition)
1840 {
1841     Page* page = WebPage::pageFromJLong(pPage);
1842 
1843     Frame* frame = (Frame*)&amp;page-&gt;focusController().focusedOrMainFrame();
1844     ASSERT(frame);
1845 
1846     if (!frame || !frame-&gt;editor().canEdit()) {
1847         // There&#39;s no client to deliver the event. Consume the event
1848         // so that it won&#39;t be delivered to a wrong webkit client.
1849         return JNI_TRUE;
1850     }
1851 
1852     // Process committed text first
1853     if (env-&gt;GetStringLength(jcommitted) &gt; 0 ||
1854             // if both committed and composed are empty, confirm with an empty text
1855             (env-&gt;GetStringLength(jcomposed) == 0)) {
1856         String committed = String(env, jcommitted);
1857         frame-&gt;editor().confirmComposition(committed);
1858     }
1859 
1860     // Process composed (composition) text here
1861     if (env-&gt;GetStringLength(jcomposed) &gt; 0) {
1862         jsize length = env-&gt;GetArrayLength(jattributes);
1863         Vector&lt;CompositionUnderline&gt; underlines;
1864         underlines.resize(length / 3); // 3 members per element
1865         jint* attrs = env-&gt;GetIntArrayElements(jattributes, nullptr);
1866         if (attrs) {
1867             for (int i = 0; i &lt; length;) {
1868                 int x = i / 3;
1869                 underlines[x].startOffset = attrs[i++];
1870                 underlines[x].endOffset = attrs[i++];
1871                 underlines[x].thick = (attrs[i++] == 1);
1872                 underlines[x].color = Color(0, 0, 0);
1873             }
1874             env-&gt;ReleaseIntArrayElements(jattributes, attrs, JNI_ABORT);
1875         }
1876         String composed = String(env, jcomposed);
1877         frame-&gt;editor().setComposition(composed, underlines, caretPosition, 0);
1878     }
1879     return JNI_TRUE;
1880 }
1881 
1882 JNIEXPORT jboolean JNICALL Java_com_sun_webkit_WebPage_twkProcessCaretPositionChange
1883     (JNIEnv* env, jobject self, jlong pPage,
1884      jint caretPosition)
1885 {
1886     Page* page = WebPage::pageFromJLong(pPage);
1887 
1888     Frame* frame = (Frame*)&amp;page-&gt;focusController().focusedOrMainFrame();
1889 
1890     ASSERT(frame);
1891 
1892     Text* text = frame-&gt;editor().compositionNode();
1893     if (!text) {
1894         return JNI_FALSE;
1895     }
1896 
1897     // FIXME: the following code may not work with having committed text
1898     Position position(text, caretPosition);
1899     VisibleSelection selection(position, DOWNSTREAM);
1900     frame-&gt;selection().setSelection(selection /*, default is CharacterGranularity*/);//true, false, false
1901     return JNI_TRUE;
1902 }
1903 
1904 JNIEXPORT jintArray JNICALL Java_com_sun_webkit_WebPage_twkGetTextLocation
1905     (JNIEnv* env, jobject self, jlong pPage, jint charindex)
1906 {
1907     Page* page = WebPage::pageFromJLong(pPage);
1908     Frame&amp; frame = page-&gt;mainFrame();
1909 
1910     jintArray result = env-&gt;NewIntArray(4);
1911     WTF::CheckAndClearException(env); // OOME
1912 
1913     FrameView* frameView = frame.view();
1914     if (frameView) {
1915         IntRect caret = frame.selection().absoluteCaretBounds();
1916         caret = frameView-&gt;contentsToWindow(caret);
1917         jint* ints = (jint*) env-&gt;GetPrimitiveArrayCritical(result, nullptr);
1918         ints[0] = caret.x();
1919         ints[1] = caret.y();
1920         ints[2] = caret.width();
1921         ints[3] = caret.height();
1922         env-&gt;ReleasePrimitiveArrayCritical(result, ints, JNI_ABORT);
1923     }
1924 
1925     return result;
1926 }
1927 
1928 JNIEXPORT jint JNICALL Java_com_sun_webkit_WebPage_twkGetLocationOffset
1929     (JNIEnv* env, jobject self, jlong pPage, jint x, jint y)
1930 {
1931     // Returns -1 if there&#39;s no composition text or the given
1932     // coordinate is out of the composition text range.
1933 
1934     Page* page = WebPage::pageFromJLong(pPage);
1935     Frame* frame = (Frame*)&amp;page-&gt;mainFrame();
1936 
1937     FrameView* frameView = frame-&gt;view();
1938     if (!frameView) {
1939         return 0;
1940     }
1941 
1942     jint offset = -1;
1943     IntPoint point {x, y};
1944     point = frameView-&gt;windowToContents(point);
1945 
1946     Editor &amp;editor = frame-&gt;editor();
1947     if (editor.hasComposition()) {
1948         RefPtr&lt;Range&gt; range = editor.compositionRange();
1949         for (Node* node = &amp;range-&gt;startContainer(); node; node = NodeTraversal::next(*node)) {
1950             RenderObject* renderer = node-&gt;renderer();
1951             IntRect content = renderer-&gt;absoluteBoundingBoxRect();
1952             VisiblePosition targetPosition(renderer-&gt;positionForPoint(LayoutPoint(point.x() - content.x(),
1953                                                                             point.y() - content.y()), nullptr)); // TODO-java: recheck nullptr
1954             offset = targetPosition.deepEquivalent().offsetInContainerNode();
1955             if (offset &gt;= (jint)editor.compositionStart() &amp;&amp; offset &lt; (jint)editor.compositionEnd()) {
1956                 offset -= editor.compositionStart();
1957                 break;
1958             }
1959         }
1960     }
1961     return offset;
1962 }
1963 
1964 JNIEXPORT jint JNICALL Java_com_sun_webkit_WebPage_twkGetInsertPositionOffset
1965     (JNIEnv *env, jobject self, jlong pPage)
1966 {
1967     Page* page = WebPage::pageFromJLong(pPage);
1968     Frame* frame = (Frame*)&amp;page-&gt;mainFrame();
1969 
1970     jint position = 0;
1971     Editor &amp;editor = frame-&gt;editor();
1972     if (editor.canEdit()) {
1973         VisibleSelection selection = frame-&gt;selection().selection();
1974         if (selection.isCaret()) {
1975             VisiblePosition caret = selection.visibleStart();
1976             position = caret.deepEquivalent().offsetInContainerNode();
1977             if (editor.hasComposition()) {
1978                 int start = editor.compositionStart();
1979                 int end = editor.compositionEnd();
1980                 if (start &lt; position &amp;&amp; position &lt;= end) {
1981                     position = start;
1982                 } else if (position &gt; end) {
1983                     position -= end - start;
1984                 }
1985             }
1986         }
1987     }
1988     return position;
1989 }
1990 
1991 JNIEXPORT jint JNICALL Java_com_sun_webkit_WebPage_twkGetCommittedTextLength
1992     (JNIEnv *env, jobject self, jlong pPage)
1993 {
1994     Page* page = WebPage::pageFromJLong(pPage);
1995     Frame* frame = (Frame*)&amp;page-&gt;mainFrame();
1996 
1997     jint length = 0;
1998     Editor &amp;editor = frame-&gt;editor();
1999     if (editor.canEdit()) {
2000         RefPtr&lt;Range&gt; range = rangeOfContents(*(Node*)frame-&gt;selection().selection().start().element());
2001         // Code derived from Range::toString
2002         Node* pastLast = range.get()-&gt;pastLastNode();
2003         for (Node* n = range.get()-&gt;firstNode(); n != pastLast; n = NodeTraversal::next(*n)) {
2004             if (n-&gt;nodeType() == Node::TEXT_NODE || n-&gt;nodeType() == Node::CDATA_SECTION_NODE) {
2005                 length += static_cast&lt;CharacterData*&gt;(n)-&gt;data().length();
2006             }
2007         }
2008         // Exclude the composition part if any
2009         if (editor.hasComposition()) {
2010             int start = editor.compositionStart();
2011             int end = editor.compositionEnd();
2012             length -= end - start;
2013         }
2014     }
2015     return length;
2016 }
2017 
2018 JNIEXPORT jstring JNICALL Java_com_sun_webkit_WebPage_twkGetCommittedText
2019     (JNIEnv *env, jobject self, jlong pPage)
2020 {
2021     Page* page = WebPage::pageFromJLong(pPage);
2022     Frame* frame = (Frame*)&amp;page-&gt;mainFrame();
2023 
2024     jstring text = 0;
2025 
2026     Editor &amp;editor = frame-&gt;editor();
2027     if (editor.canEdit()) {
2028         RefPtr&lt;Range&gt; range = rangeOfContents(*(Node*)frame-&gt;selection().selection().start().element());
2029         if (range) {
2030             String t = plainText(range.get());
2031             // Exclude the composition text if any
2032             if (editor.hasComposition()) {
2033                 String s;
2034                 int start = editor.compositionStart();
2035                 int end = editor.compositionEnd();
2036                 unsigned int length = t.length() - (end - start);
2037                 if (start &gt; 0) {
2038                     s = t.substring(0, start);
2039                 }
2040                 if (s.length() == length) {
2041                     t = s;
2042                 } else {
2043                     t = s + t.substring(end, length - start);
2044                 }
2045             }
2046             text = t.toJavaString(env).releaseLocal();
2047             WTF::CheckAndClearException(env); // OOME
2048         }
2049     }
2050     return text;
2051 }
2052 
2053 JNIEXPORT jstring JNICALL Java_com_sun_webkit_WebPage_twkGetSelectedText
2054     (JNIEnv *env, jobject self, jlong pPage)
2055 {
2056     Page* page = WebPage::pageFromJLong(pPage);
2057     Frame* frame = (Frame*)&amp;page-&gt;mainFrame();
2058 
2059     jstring text = 0;
2060 
2061     String t = frame-&gt;editor().selectedText();
2062     text = t.toJavaString(env).releaseLocal();
2063     WTF::CheckAndClearException(env); // OOME
2064 
2065     return text;
2066 }
2067 
2068 //java.awt.dnd.DConstants
2069 enum JAVA_DND_ACTION {
2070     ACTION_NONE = 0x0,
2071     ACTION_COPY = 0x1,
2072     ACTION_MOVE = 0x2,
2073     ACTION_LINK = 0x40000000
2074 };
2075 
2076 static jint dragOperationToDragCursor(DragOperation op) {
2077     unsigned int res = ACTION_NONE;
2078     if (op &amp; DragOperationCopy)
2079         res = ACTION_COPY;
2080     else if (op &amp; DragOperationLink)
2081         res = ACTION_LINK;
2082     else if (op &amp; DragOperationMove)
2083         res = ACTION_MOVE;
2084     else if (op &amp; DragOperationGeneric)
2085         res = ACTION_MOVE; //This appears to be the Firefox behaviour
2086     return res;
2087 }
2088 
2089 static DragOperation keyStateToDragOperation(jint javaAction) {
2090     unsigned int action = DragOperationNone;
2091     if(javaAction &amp; ACTION_COPY)
2092         action = DragOperationCopy;
2093     else if(javaAction &amp; ACTION_LINK)
2094         action = DragOperationLink;
2095     else if(javaAction &amp; ACTION_MOVE)
2096         action = DragOperationMove;
2097     return static_cast&lt;DragOperation&gt;(action);
2098 }
2099 
2100 JNIEXPORT jint JNICALL Java_com_sun_webkit_WebPage_twkProcessDrag
2101 (JNIEnv* env,
2102  jobject self,
2103  jlong pPage,
2104  jint actionId,
2105  jobjectArray jMimes, jobjectArray jValues,
2106  jint x, jint y,
2107  jint screenX, jint screenY,
2108  jint javaAction) {
2109     if (jMimes) {
2110         //TRAGET
2111         RefPtr&lt;DataObjectJava&gt; pr = DataObjectJava::create();
2112         jint n = env-&gt;GetArrayLength(jMimes);
2113         for( jint j=0; j&lt;n; ++j ){
2114             jstring value = (jstring)env-&gt;GetObjectArrayElement(jValues, j);
2115             if(value){
2116                 pr-&gt;setData(
2117                     String(env, JLString((jstring)env-&gt;GetObjectArrayElement(jMimes, j))),
2118                     String(env, JLString(value)));
2119             }
2120         }
2121         DragData dragData(
2122             pr.get(),
2123             IntPoint(x, y),
2124             IntPoint(screenX, screenY),
2125             keyStateToDragOperation(javaAction));
2126         DragController&amp; dc = WebPage::pageFromJLong(pPage)-&gt;dragController();
2127 
2128         setCopyKeyState(ACTION_COPY == javaAction);
2129         switch(actionId){
2130         case com_sun_webkit_WebPage_DND_DST_EXIT:
2131             dc.dragExited(dragData);
2132             return 0;
2133         case com_sun_webkit_WebPage_DND_DST_ENTER:
2134             return dragOperationToDragCursor(dc.dragEntered(dragData));
2135         case com_sun_webkit_WebPage_DND_DST_OVER:
2136         case com_sun_webkit_WebPage_DND_DST_CHANGE:
2137             return dragOperationToDragCursor(dc.dragUpdated(dragData));
2138         case com_sun_webkit_WebPage_DND_DST_DROP:
2139             {
2140                 int ret = dc.performDragOperation(dragData) ? 1 : 0;
2141                 WebPage::pageFromJLong(pPage)-&gt;dragController().dragEnded();
2142                 return ret;
2143             }
2144         }
2145     } else {
2146         //SOURCE
2147         EventHandler&amp; eventHandler =
2148                 WebPage::pageFromJLong(pPage)-&gt;mainFrame().eventHandler();
2149         PlatformMouseEvent mouseEvent = PlatformMouseEvent(
2150             IntPoint(x, y),
2151             IntPoint(screenX, screenY),
2152             com_sun_webkit_WebPage_DND_SRC_DROP!=actionId
2153                 ? LeftButton
2154                 : NoButton,
2155             PlatformEvent::MouseMoved,
2156             0,
2157             false, false, false, false, WallTime {}, ForceAtClick, NoTap); // TODO-java: handle force?
2158         switch(actionId){
2159         case com_sun_webkit_WebPage_DND_SRC_EXIT:
2160         case com_sun_webkit_WebPage_DND_SRC_ENTER:
2161         case com_sun_webkit_WebPage_DND_SRC_OVER:
2162         case com_sun_webkit_WebPage_DND_SRC_CHANGE:
2163 //            The method has been removed. See the changeset #de77cc97972d for the details.
2164 //            eventHandler-&gt;dragSourceMovedTo(mouseEvent);
2165             break;
2166         case com_sun_webkit_WebPage_DND_SRC_DROP:
2167             eventHandler.dragSourceEndedAt(mouseEvent, keyStateToDragOperation(javaAction));
2168             break;
2169         }
2170     }
2171     return 0;
2172 }
2173 
2174 static Editor* getEditor(Page* page) {
2175     ASSERT(page);
2176     Frame&amp; frame = page-&gt;focusController().focusedOrMainFrame();
2177     return &amp;frame.editor();
2178 }
2179 
2180 JNIEXPORT jboolean JNICALL Java_com_sun_webkit_WebPage_twkExecuteCommand
2181     (JNIEnv* env, jobject self, jlong pPage, jstring command, jstring value)
2182 {
2183     Page* page = WebPage::pageFromJLong(pPage);
2184     ASSERT(page);
2185     Editor* editor = getEditor(page);
2186     if (!editor) {
2187         return JNI_FALSE;
2188     }
2189     Editor::Command cmd = editor-&gt;command(String(env, command));
2190     return bool_to_jbool(cmd.execute(value ? String(env, value) : String()));
2191 }
2192 
2193 JNIEXPORT jboolean JNICALL Java_com_sun_webkit_WebPage_twkQueryCommandEnabled
2194     (JNIEnv* env, jobject self, jlong pPage, jstring command)
2195 {
2196     Page* page = WebPage::pageFromJLong(pPage);
2197     ASSERT(page);
2198     Editor* editor = getEditor(page);
2199     if (!editor) {
2200         return JNI_FALSE;
2201     }
2202     Editor::Command cmd = editor-&gt;command(String(env, command));
2203     return bool_to_jbool(cmd.isEnabled());
2204 }
2205 
2206 JNIEXPORT jboolean JNICALL Java_com_sun_webkit_WebPage_twkQueryCommandState
2207     (JNIEnv* env, jobject self, jlong pPage, jstring command)
2208 {
2209     Page* page = WebPage::pageFromJLong(pPage);
2210     ASSERT(page);
2211     Editor* editor = getEditor(page);
2212     if (!editor) {
2213         return JNI_FALSE;
2214     }
2215     Editor::Command cmd = editor-&gt;command(String(env, command));
2216     return bool_to_jbool(cmd.state() == TrueTriState);
2217 }
2218 
2219 JNIEXPORT jstring JNICALL Java_com_sun_webkit_WebPage_twkQueryCommandValue
2220     (JNIEnv* env, jobject self, jlong pPage, jstring command)
2221 {
2222     Page* page = WebPage::pageFromJLong(pPage);
2223     ASSERT(page);
2224     Editor* editor = getEditor(page);
2225     if (!editor) {
2226         return nullptr;
2227     }
2228     Editor::Command cmd = editor-&gt;command(String(env, command));
2229     return cmd.value().toJavaString(env).releaseLocal();
2230 }
2231 
2232 JNIEXPORT jboolean JNICALL Java_com_sun_webkit_WebPage_twkIsEditable
2233     (JNIEnv* env, jobject self, jlong pPage)
2234 {
2235     Page* page = WebPage::pageFromJLong(pPage);
2236     ASSERT(page);
2237     if (!page) {
2238         return JNI_FALSE;
2239     }
2240     return bool_to_jbool(page-&gt;isEditable());
2241 }
2242 
2243 JNIEXPORT void JNICALL Java_com_sun_webkit_WebPage_twkSetEditable
2244     (JNIEnv* env, jobject self, jlong pPage, jboolean editable)
2245 {
2246     Page* page = WebPage::pageFromJLong(pPage);
2247     ASSERT(page);
2248     if (!page) {
2249         return;
2250     }
2251     page-&gt;setEditable(jbool_to_bool(editable));
2252 }
2253 
2254 JNIEXPORT jstring JNICALL Java_com_sun_webkit_WebPage_twkGetHtml
2255     (JNIEnv* env, jobject self, jlong pFrame)
2256 {
2257     Frame* frame = static_cast&lt;Frame*&gt;(jlong_to_ptr(pFrame));
2258     if (!frame) {
2259         return 0;
2260     }
2261 
2262     Document* document = frame-&gt;document();
2263     if (!document || !document-&gt;isHTMLDocument()) {
2264         return 0;
2265     }
2266 
2267     HTMLElement* documentElement =
2268             static_cast&lt;HTMLElement*&gt;(document-&gt;documentElement());
2269     if (!documentElement) {
2270         return 0;
2271     }
2272 
2273     return documentElement-&gt;outerHTML().toJavaString(env).releaseLocal();
2274 }
2275 
2276 JNIEXPORT jboolean JNICALL Java_com_sun_webkit_WebPage_twkGetUsePageCache
2277     (JNIEnv*, jobject, jlong pPage)
2278 {
2279     ASSERT(pPage);
2280     Page* page = WebPage::pageFromJLong(pPage);
2281     ASSERT(page);
2282     return bool_to_jbool(page-&gt;settings().usesPageCache());
2283 }
2284 
2285 JNIEXPORT void JNICALL Java_com_sun_webkit_WebPage_twkSetUsePageCache
2286     (JNIEnv*, jobject, jlong pPage, jboolean usePageCache)
2287 {
2288     ASSERT(pPage);
2289     Page* page = WebPage::pageFromJLong(pPage);
2290     ASSERT(page);
2291     page-&gt;settings().setUsesPageCache(jbool_to_bool(usePageCache));
2292 }
2293 
2294 JNIEXPORT jboolean JNICALL Java_com_sun_webkit_WebPage_twkIsJavaScriptEnabled
2295     (JNIEnv*, jobject, jlong pPage)
2296 {
2297     ASSERT(pPage);
2298     Page* page = WebPage::pageFromJLong(pPage);
2299     ASSERT(page);
2300     return bool_to_jbool(page-&gt;mainFrame().script().canExecuteScripts(NotAboutToExecuteScript));
2301 }
2302 
2303 JNIEXPORT void JNICALL Java_com_sun_webkit_WebPage_twkSetJavaScriptEnabled
2304     (JNIEnv*, jobject, jlong pPage, jboolean enable)
2305 {
2306     ASSERT(pPage);
2307     Page* page = WebPage::pageFromJLong(pPage);
2308     ASSERT(page);
2309     page-&gt;settings().setScriptEnabled(jbool_to_bool(enable));
2310 }
2311 
2312 JNIEXPORT jboolean JNICALL Java_com_sun_webkit_WebPage_twkIsContextMenuEnabled
2313     (JNIEnv*, jobject, jlong pPage)
2314 {
2315     ASSERT(pPage);
2316     Page* page = WebPage::pageFromJLong(pPage);
2317     ASSERT(page);
2318     return bool_to_jbool(page-&gt;settings().isContextMenuEnabled());
2319 }
2320 
2321 JNIEXPORT void JNICALL Java_com_sun_webkit_WebPage_twkSetContextMenuEnabled
2322     (JNIEnv*, jobject, jlong pPage, jboolean enable)
2323 {
2324     ASSERT(pPage);
2325     Page* page = WebPage::pageFromJLong(pPage);
2326     ASSERT(page);
2327     page-&gt;settings().setContextMenuEnabled(jbool_to_bool(enable));
2328 }
2329 
2330 JNIEXPORT void JNICALL Java_com_sun_webkit_WebPage_twkSetUserStyleSheetLocation
2331     (JNIEnv* env, jobject, jlong pPage, jstring url)
2332 {
2333     ASSERT(pPage);
2334     Page* page = WebPage::pageFromJLong(pPage);
2335     ASSERT(page);
2336     page-&gt;settings().setUserStyleSheetLocation(URL(URL(), String(env, url)));
2337 }
2338 
2339 JNIEXPORT jstring JNICALL Java_com_sun_webkit_WebPage_twkGetUserAgent
2340     (JNIEnv* env, jobject, jlong pPage)
2341 {
2342     ASSERT(pPage);
2343     Page* page = WebPage::pageFromJLong(pPage);
2344     ASSERT(page);
2345     return page-&gt;settings().userAgent().toJavaString(env).releaseLocal();
2346 }
2347 
2348 JNIEXPORT void JNICALL Java_com_sun_webkit_WebPage_twkSetUserAgent
2349     (JNIEnv* env, jobject, jlong pPage, jstring userAgent)
2350 {
2351     ASSERT(pPage);
2352     Page* page = WebPage::pageFromJLong(pPage);
2353     ASSERT(page);
2354     page-&gt;settings().setUserAgent(String(env, userAgent));
2355 }
2356 
2357 JNIEXPORT void JNICALL Java_com_sun_webkit_WebPage_twkSetLocalStorageDatabasePath
2358   (JNIEnv* env, jobject, jlong pPage, jstring path)
2359 {
2360     ASSERT(pPage);
2361     Page* page = WebPage::pageFromJLong(pPage);
2362     ASSERT(page);
2363     Settings&amp; settings = page-&gt;settings();
2364     settings.setLocalStorageDatabasePath(String(env, path));
2365     static_cast&lt;WebStorageNamespaceProviderJava*&gt;(
2366       &amp;page-&gt;storageNamespaceProvider())
2367         -&gt;setLocalStorageDatabasePath(settings.localStorageDatabasePath());
2368 }
2369 
2370 JNIEXPORT void JNICALL Java_com_sun_webkit_WebPage_twkSetLocalStorageEnabled
2371   (JNIEnv*, jobject, jlong pPage, jboolean enabled)
2372 {
2373     ASSERT(pPage);
2374     Page* page = WebPage::pageFromJLong(pPage);
2375     ASSERT(page);
2376     Settings&amp; settings = page-&gt;settings();
2377     settings.setLocalStorageEnabled(jbool_to_bool(enabled));
2378 }
2379 
2380 JNIEXPORT jboolean JNICALL Java_com_sun_webkit_WebPage_twkGetDeveloperExtrasEnabled
2381   (JNIEnv *, jobject, jlong pPage)
2382 {
2383     ASSERT(pPage);
2384     Page* page = WebPage::pageFromJLong(pPage);
2385     ASSERT(page);
2386     return bool_to_jbool(page-&gt;settings().developerExtrasEnabled());
2387 }
2388 
2389 JNIEXPORT void JNICALL Java_com_sun_webkit_WebPage_twkSetDeveloperExtrasEnabled
2390   (JNIEnv *, jobject, jlong pPage, jboolean enabled)
2391 {
2392     ASSERT(pPage);
2393     Page* page = WebPage::pageFromJLong(pPage);
2394     ASSERT(page);
2395     page-&gt;settings().setDeveloperExtrasEnabled(jbool_to_bool(enabled));
2396 }
2397 
2398 JNIEXPORT jint JNICALL Java_com_sun_webkit_WebPage_twkGetUnloadEventListenersCount
2399     (JNIEnv*, jobject, jlong pFrame)
2400 {
2401     ASSERT(pFrame);
2402     Frame* frame = static_cast&lt;Frame*&gt;(jlong_to_ptr(pFrame));
2403     ASSERT(frame);
2404     return (jint)frame-&gt;document()-&gt;domWindow()-&gt;pendingUnloadEventListeners();
2405 }
2406 
2407 JNIEXPORT void JNICALL Java_com_sun_webkit_WebPage_twkConnectInspectorFrontend
2408   (JNIEnv *, jobject, jlong pPage)
2409 {
2410     Page *page = WebPage::pageFromJLong(pPage);
2411     if (page) {
2412         InspectorController&amp; ic = page-&gt;inspectorController();
2413         InspectorClientJava* icj = static_cast&lt;InspectorClientJava*&gt;(ic.inspectorClient());
2414         if (icj) {
2415             ic.connectFrontend(*icj, false);
2416         }
2417 
2418     }
2419     WebPage::webPageFromJLong(pPage)-&gt;debugStarted();
2420 }
2421 
2422 JNIEXPORT void JNICALL Java_com_sun_webkit_WebPage_twkDisconnectInspectorFrontend
2423   (JNIEnv *, jobject, jlong pPage)
2424 {
2425     Page* page = WebPage::pageFromJLong(pPage);
2426     if (!page) {
2427         return;
2428     }
2429 
2430     InspectorController&amp; ic = page-&gt;inspectorController();
2431     InspectorClientJava* icj = static_cast&lt;InspectorClientJava*&gt;(ic.inspectorClient());
2432     if (icj) {
2433         ic.disconnectFrontend(*icj);
2434     }
2435 
2436     WebPage::webPageFromJLong(pPage)-&gt;debugEnded();
2437 }
2438 
2439 JNIEXPORT void JNICALL Java_com_sun_webkit_WebPage_twkDispatchInspectorMessageFromFrontend
2440   (JNIEnv* env, jobject, jlong pPage, jstring message)
2441 {
2442     Page* page = WebPage::pageFromJLong(pPage);
2443     if (!page) {
2444         return;
2445     }
2446     //utatodo: seems that RT-21428 will back again
2447     //JSDOMWindowBase::commonVM()-&gt;timeoutChecker.reset(); // RT-21428
2448     page-&gt;inspectorController().dispatchMessageFromFrontend(
2449             String(env, message));
2450 }
2451 
2452 JNIEXPORT jint JNICALL Java_com_sun_webkit_WebPage_twkWorkerThreadCount
2453   (JNIEnv* env, jclass)
2454 {
2455     return WorkerThread::workerThreadCount();
2456 }
2457 
2458 JNIEXPORT void JNICALL Java_com_sun_webkit_WebPage_twkDoJSCGarbageCollection
2459   (JNIEnv*, jclass)
2460 {
2461     GCController::singleton().garbageCollectNow();
2462 }
2463 
2464 }
<a name="10" id="anc10"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="10" type="hidden" />
</body>
</html>