<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames modules/javafx.web/src/main/native/Source/WebKitLegacy/java/WebCoreSupport/WebPage.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>   1 /*
   2  * Copyright (c) 2011, 2019, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.  Oracle designates this
   8  * particular file as subject to the &quot;Classpath&quot; exception as provided
   9  * by Oracle in the LICENSE file that accompanied this code.
  10  *
  11  * This code is distributed in the hope that it will be useful, but WITHOUT
  12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  14  * version 2 for more details (a copy is included in the LICENSE file that
  15  * accompanied this code).
  16  *
  17  * You should have received a copy of the GNU General Public License version
  18  * 2 along with this work; if not, write to the Free Software Foundation,
  19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  20  *
  21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  22  * or visit www.oracle.com if you need additional information or have any
  23  * questions.
  24  */
  25 
  26 
  27 #if COMPILER(GCC) || COMPILER(CLANG)
  28 #pragma GCC diagnostic ignored &quot;-Wunused-parameter&quot;
  29 #endif
  30 
  31 #include &quot;WebPage.h&quot;
  32 
  33 #include &quot;BackForwardList.h&quot;
  34 #include &quot;ChromeClientJava.h&quot;
  35 #include &quot;ContextMenuClientJava.h&quot;
  36 #include &quot;ContextMenuJava.h&quot;
  37 #include &quot;DragClientJava.h&quot;
  38 #include &quot;EditorClientJava.h&quot;
  39 #include &quot;FrameLoaderClientJava.h&quot;
  40 #include &quot;InspectorClientJava.h&quot;
  41 #include &quot;PageStorageSessionProvider.h&quot;
  42 #include &quot;PlatformStrategiesJava.h&quot;
  43 #include &quot;ProgressTrackerClientJava.h&quot;
  44 #include &quot;VisitedLinkStoreJava.h&quot;
  45 #include &quot;WebKitLegacy/Storage/StorageNamespaceImpl.h&quot;
  46 #include &quot;WebKitLegacy/Storage/WebDatabaseProvider.h&quot;
  47 #include &quot;WebKitVersion.h&quot; //generated
  48 #include &quot;WebPageConfig.h&quot;
<a name="1" id="anc1"></a>
  49 #include &lt;WebCore/WebCoreTestSupport.h&gt;
  50 #include &lt;JavaScriptCore/APICast.h&gt;
  51 #include &lt;JavaScriptCore/InitializeThreading.h&gt;
  52 #include &lt;JavaScriptCore/JSContextRef.h&gt;
  53 #include &lt;JavaScriptCore/JSContextRefPrivate.h&gt;
  54 #include &lt;JavaScriptCore/JSStringRef.h&gt;
  55 #include &lt;JavaScriptCore/Options.h&gt;
  56 #include &lt;WebCore/BackForwardController.h&gt;
  57 #include &lt;WebCore/BridgeUtils.h&gt;
  58 #include &lt;WebCore/CharacterData.h&gt;
  59 #include &lt;WebCore/Chrome.h&gt;
  60 #include &lt;WebCore/ContextMenu.h&gt;
  61 #include &lt;WebCore/ContextMenuController.h&gt;
  62 #include &lt;WebCore/CookieJar.h&gt;
  63 #include &lt;WebCore/DeprecatedGlobalSettings.h&gt;
  64 #include &lt;WebCore/Document.h&gt;
  65 #include &lt;WebCore/DragController.h&gt;
  66 #include &lt;WebCore/DragData.h&gt;
  67 #include &lt;WebCore/Editor.h&gt;
  68 #include &lt;WebCore/EmptyClients.h&gt;
  69 #include &lt;WebCore/EventHandler.h&gt;
  70 #include &lt;WebCore/FloatRect.h&gt;
  71 #include &lt;WebCore/FloatSize.h&gt;
  72 #include &lt;WebCore/FocusController.h&gt;
  73 #include &lt;WebCore/Frame.h&gt;
  74 #include &lt;WebCore/FrameLoadRequest.h&gt;
  75 #include &lt;WebCore/FrameTree.h&gt;
  76 #include &lt;WebCore/FrameView.h&gt;
  77 #include &lt;WebCore/GCController.h&gt;
  78 #include &lt;WebCore/GeolocationClientMock.h&gt;
  79 #include &lt;WebCore/GraphicsContext.h&gt;
  80 #include &lt;WebCore/GraphicsLayerTextureMapper.h&gt;
  81 #include &lt;WebCore/InspectorController.h&gt;
  82 #include &lt;WebCore/KeyboardEvent.h&gt;
  83 #include &lt;WebCore/NodeTraversal.h&gt;
  84 #include &lt;WebCore/Page.h&gt;
  85 #include &lt;WebCore/PageConfiguration.h&gt;
  86 #include &lt;WebCore/PageSupplementJava.h&gt;
  87 #include &lt;WebCore/PlatformContextJava.h&gt;
  88 #include &lt;WebCore/PlatformJavaClasses.h&gt;
  89 #include &lt;WebCore/PlatformKeyboardEvent.h&gt;
  90 #include &lt;WebCore/PlatformMouseEvent.h&gt;
  91 #include &lt;WebCore/PlatformTouchEvent.h&gt;
  92 #include &lt;WebCore/PlatformWheelEvent.h&gt;
  93 #include &lt;WebCore/RenderTreeAsText.h&gt;
  94 #include &lt;WebCore/RenderView.h&gt;
  95 #include &lt;WebCore/ResourceRequest.h&gt;
  96 #include &lt;WebCore/RuntimeEnabledFeatures.h&gt;
  97 #include &lt;WebCore/ScriptController.h&gt;
  98 #include &lt;WebCore/SecurityPolicy.h&gt;
  99 #include &lt;WebCore/Settings.h&gt;
 100 #include &lt;WebCore/StorageNamespaceProvider.h&gt;
 101 #include &lt;WebCore/TextIterator.h&gt;
 102 #include &lt;WebCore/TextureMapperJava.h&gt;
 103 #include &lt;WebCore/TextureMapperLayer.h&gt;
 104 #include &lt;WebCore/WorkerThread.h&gt;
 105 #include &lt;wtf/Ref.h&gt;
 106 #include &lt;wtf/RunLoop.h&gt;
 107 #include &lt;wtf/java/JavaRef.h&gt;
 108 #include &lt;wtf/text/WTFString.h&gt;
 109 
 110 // FIXME: Move dependency of runtime_root to BridgeUtils
 111 #include &lt;WebCore/runtime_root.h&gt;
 112 #if OS(UNIX)
 113 #include &lt;sys/utsname.h&gt;
 114 #endif
 115 #if OS(WINDOWS)
 116 #include &lt;WebCore/SystemInfo.h&gt;
 117 #endif
 118 
 119 
 120 #include &quot;com_sun_webkit_WebPage.h&quot;
 121 #include &quot;com_sun_webkit_event_WCFocusEvent.h&quot;
 122 #include &quot;com_sun_webkit_event_WCKeyEvent.h&quot;
 123 #include &quot;com_sun_webkit_event_WCMouseEvent.h&quot;
 124 
 125 #if ENABLE(NOTIFICATIONS) || ENABLE(LEGACY_NOTIFICATIONS)
 126 #include &lt;WebCore/NotificationController.h&gt;
 127 #include &quot;NotificationClientJava.h&quot;
 128 #endif
 129 
 130 namespace WebCore {
 131 
 132 WebPage::WebPage(std::unique_ptr&lt;Page&gt; page)
 133     : m_page(WTFMove(page))
 134 {
 135 #if ENABLE(NOTIFICATIONS) || ENABLE(LEGACY_NOTIFICATIONS)
 136     if(!NotificationController::from(m_page.get())) {
 137         provideNotification(m_page.get(), NotificationClientJava::instance());
 138     }
 139 #endif
 140 }
 141 
 142 WebPage::~WebPage()
 143 {
 144     debugEnded();
 145 }
 146 
 147 WebPage* WebPage::webPageFromJObject(const JLObject&amp; oWebPage)
 148 {
 149     JNIEnv* env = WTF::GetJavaEnv();
 150 
 151     static jmethodID midGetPageMethod = env-&gt;GetMethodID(
 152         PG_GetWebPageClass(env),
 153         &quot;getPage&quot;,
 154         &quot;()J&quot;);
 155     ASSERT(midGetPageMethod);
 156 
 157     jlong p = env-&gt;CallLongMethod(oWebPage, midGetPageMethod);
 158     WTF::CheckAndClearException(env);
 159 
 160     return webPageFromJLong(p);
 161 }
 162 
 163 JLObject WebPage::jobjectFromPage(Page* page)
 164 {
 165     if (!page)
 166         return nullptr;
 167 
 168     auto pageSupplement = PageSupplementJava::from(page);
 169     return pageSupplement ? pageSupplement-&gt;jWebPage() : nullptr;
 170 }
 171 
 172 void WebPage::setSize(const IntSize&amp; size)
 173 {
 174     Frame* mainFrame = (Frame*)&amp;m_page-&gt;mainFrame();
 175 
 176     FrameView* frameView = mainFrame-&gt;view();
 177     if (!frameView) {
 178         return;
 179     }
 180 
 181     frameView-&gt;resize(size);
 182     frameView-&gt;layoutContext().scheduleLayout();
 183 
 184     if (m_rootLayer) {
 185         m_rootLayer-&gt;setSize(size);
 186         m_rootLayer-&gt;setNeedsDisplay();
 187     }
 188 }
 189 
 190 static void drawDebugLed(GraphicsContext&amp; context,
 191                          const IntRect&amp; rect,
 192                          const Color&amp; color)
 193 {
 194     const int w = 50;
 195     const int h = 50;
 196     FloatRect ledRect(
 197             rect.x() + rect.width() / 2 - w / 2,
 198             rect.y() + rect.height() / 2 - h / 2,
 199             w,
 200             h);
 201     context.fillRect(ledRect, color);
 202 }
 203 
 204 static void drawDebugBorder(GraphicsContext&amp; context,
 205                             const IntRect&amp; rect,
 206                             const Color&amp; color,
 207                             int width)
 208 {
 209     int x = rect.x();
 210     int y = rect.y();
 211     int w = rect.width();
 212     int h = rect.height();
 213     context.fillRect(FloatRect(x, y, w, width));
 214     context.fillRect(FloatRect(x, y + h - width, w, width), color);
 215     context.fillRect(FloatRect(x, y, width, h), color);
 216     context.fillRect(FloatRect(x + w - width, y, width, h), color);
 217 }
 218 
 219 void WebPage::prePaint() {
 220     if (m_rootLayer) {
 221         if (m_syncLayers) {
 222             m_syncLayers = false;
 223             syncLayers();
 224         }
 225         return;
 226     }
 227 
 228     Frame* mainFrame = (Frame*)&amp;m_page-&gt;mainFrame();
 229     FrameView* frameView = mainFrame-&gt;view();
 230     if (frameView) {
 231         // Updating layout &amp; styles precedes normal painting.
 232         frameView-&gt;updateLayoutAndStyleIfNeededRecursive();
 233     }
 234 }
 235 
 236 RefPtr&lt;RQRef&gt; WebPage::jRenderTheme()
 237 {
 238     if (!m_jRenderTheme) {
 239         JNIEnv* env = WTF::GetJavaEnv();
 240         m_jRenderTheme = RQRef::create(PG_GetRenderThemeObjectFromPage(env, jobjectFromPage(m_page.get())));
 241     }
 242     return m_jRenderTheme;
 243 }
 244 
 245 void WebPage::paint(jobject rq, jint x, jint y, jint w, jint h)
 246 {
 247     if (m_rootLayer) {
 248         return;
 249     }
 250 
 251     DBG_CHECKPOINTEX(&quot;twkUpdateContent&quot;, 15, 100);
 252 
 253     RefPtr&lt;Frame&gt; mainFrame((Frame*)&amp;m_page-&gt;mainFrame());
 254     RefPtr&lt;FrameView&gt; frameView(mainFrame-&gt;view());
 255     if (!frameView) {
 256         return;
 257     }
 258 
 259     // Will be deleted by GraphicsContext destructor
 260     PlatformContextJava* ppgc = new PlatformContextJava(rq, jRenderTheme());
 261     GraphicsContext gc(ppgc);
 262 
 263     // TODO: Following JS synchronization is not necessary for single thread model
 264     JSGlobalContextRef globalContext = toGlobalRef(mainFrame-&gt;script().globalObject(mainThreadNormalWorld())-&gt;globalExec());
 265     JSC::JSLockHolder sw(toJS(globalContext)); // TODO-java: was JSC::APIEntryShim sw( toJS(globalContext) );
 266 
 267     frameView-&gt;paint(gc, IntRect(x, y, w, h));
 268     if (m_page-&gt;settings().showDebugBorders()) {
 269         drawDebugLed(gc, IntRect(x, y, w, h), Color(0, 0, 255, 128));
 270     }
 271 
 272     gc.platformContext()-&gt;rq().flushBuffer();
 273 }
 274 
 275 void WebPage::postPaint(jobject rq, jint x, jint y, jint w, jint h)
 276 {
 277     if (!m_page-&gt;inspectorController().highlightedNode()
 278             &amp;&amp; !m_rootLayer
 279     ) {
 280         return;
 281     }
 282 
 283     // Will be deleted by GraphicsContext destructor
 284     PlatformContextJava* ppgc = new PlatformContextJava(rq, jRenderTheme());
 285     GraphicsContext gc(ppgc);
 286 
 287     if (m_rootLayer) {
 288         if (m_syncLayers) {
 289             m_syncLayers = false;
 290             syncLayers();
 291         }
 292         renderCompositedLayers(gc, IntRect(x, y, w, h));
 293         if (m_page-&gt;settings().showDebugBorders()) {
 294             drawDebugLed(gc, IntRect(x, y, w, h), Color(0, 192, 0, 128));
 295         }
 296         if (downcast&lt;GraphicsLayerTextureMapper&gt;(m_rootLayer.get())-&gt;layer().descendantsOrSelfHaveRunningAnimations()) {
 297             requestJavaRepaint(pageRect());
 298         }
 299     }
 300 
 301     if (m_page-&gt;inspectorController().highlightedNode()) {
 302         m_page-&gt;inspectorController().drawHighlight(gc);
 303     }
 304 
 305     gc.platformContext()-&gt;rq().flushBuffer();
 306 }
 307 
 308 void WebPage::scroll(const IntSize&amp; scrollDelta,
 309                      const IntRect&amp; rectToScroll,
 310                      const IntRect&amp; clipRect)
 311 {
 312     if (m_rootLayer) {
 313         m_rootLayer-&gt;setNeedsDisplayInRect(rectToScroll);
 314         return;
 315     }
 316 
 317     JNIEnv* env = WTF::GetJavaEnv();
 318 
 319     static jmethodID mid = env-&gt;GetMethodID(
 320             PG_GetWebPageClass(env),
 321             &quot;fwkScroll&quot;,
 322             &quot;(IIIIII)V&quot;);
 323     ASSERT(mid);
 324 
 325     env-&gt;CallVoidMethod(
 326             jobjectFromPage(m_page.get()),
 327             mid,
 328             rectToScroll.x(),
 329             rectToScroll.y(),
 330             rectToScroll.width(),
 331             rectToScroll.height(),
 332             scrollDelta.width(),
 333             scrollDelta.height());
 334     WTF::CheckAndClearException(env);
 335 }
 336 
 337 void WebPage::repaint(const IntRect&amp; rect)
 338 {
 339     if (m_rootLayer) {
 340         m_rootLayer-&gt;setNeedsDisplayInRect(rect);
 341     }
 342     requestJavaRepaint(rect);
 343 }
 344 
 345 void WebPage::requestJavaRepaint(const IntRect&amp; rect)
 346 {
 347     JNIEnv* env = WTF::GetJavaEnv();
 348 
 349     static jmethodID mid = env-&gt;GetMethodID(
 350             PG_GetWebPageClass(env),
 351             &quot;fwkRepaint&quot;,
 352             &quot;(IIII)V&quot;);
 353     ASSERT(mid);
 354 
 355     env-&gt;CallVoidMethod(
 356             jobjectFromPage(m_page.get()),
 357             mid,
 358             rect.x(),
 359             rect.y(),
 360             rect.width(),
 361             rect.height());
 362     WTF::CheckAndClearException(env);
 363 }
 364 
 365 void WebPage::setRootChildLayer(GraphicsLayer* layer)
 366 {
 367     if (layer) {
 368         m_rootLayer = GraphicsLayer::create(nullptr, *this);
 369         m_rootLayer-&gt;setDrawsContent(true);
 370         m_rootLayer-&gt;setContentsOpaque(true);
 371         m_rootLayer-&gt;setSize(pageRect().size());
 372         m_rootLayer-&gt;setNeedsDisplay();
 373         m_rootLayer-&gt;addChild(*layer);
 374 
 375         m_textureMapper = TextureMapper::create();
 376         downcast&lt;GraphicsLayerTextureMapper&gt;(m_rootLayer.get())-&gt;layer()
 377                 .setTextureMapper(m_textureMapper.get());
 378     } else {
 379         m_rootLayer = nullptr;
 380         m_textureMapper.reset();
 381     }
 382 }
 383 
 384 void WebPage::setNeedsOneShotDrawingSynchronization()
 385 {
 386 }
 387 
 388 void WebPage::scheduleCompositingLayerSync()
 389 {
 390     markForSync();
 391 }
 392 
 393 void WebPage::markForSync()
 394 {
 395     if (!m_rootLayer) {
 396         return;
 397     }
 398     m_syncLayers = true;
 399     requestJavaRepaint(pageRect());
 400 }
 401 
 402 void WebPage::syncLayers()
 403 {
 404     if (!m_rootLayer) {
 405         return;
 406     }
 407 
 408     FrameView* frameView = m_page-&gt;mainFrame().view();
 409     if (!m_page-&gt;mainFrame().contentRenderer() || !frameView)
 410         return;
 411 
 412     frameView-&gt;updateLayoutAndStyleIfNeededRecursive();
 413     // Updating layout might have taken us out of compositing mode
 414     if (m_rootLayer) {
 415         m_rootLayer-&gt;flushCompositingStateForThisLayerOnly();
 416     }
 417 
 418     if (!frameView-&gt;flushCompositingStateIncludingSubframes())
 419         return;
 420 }
 421 
 422 IntRect WebPage::pageRect()
 423 {
 424     ChromeClient&amp; client = m_page-&gt;chrome().client();
 425     return IntRect(client.pageRect());
 426 }
 427 
 428 void WebPage::renderCompositedLayers(GraphicsContext&amp; context, const IntRect&amp; clip)
 429 {
 430     ASSERT(m_rootLayer);
 431     ASSERT(m_textureMapper);
 432 
 433     TextureMapperLayer&amp; rootTextureMapperLayer = downcast&lt;GraphicsLayerTextureMapper&gt;(*m_rootLayer).layer();
 434 
 435     static_cast&lt;TextureMapperJava&amp;&gt;(*m_textureMapper).setGraphicsContext(&amp;context);
 436     TransformationMatrix matrix;
 437     m_textureMapper-&gt;beginPainting();
 438     m_textureMapper-&gt;beginClip(matrix, clip);
 439     rootTextureMapperLayer.applyAnimationsRecursively(MonotonicTime::now());
 440     downcast&lt;GraphicsLayerTextureMapper&gt;(*m_rootLayer).updateBackingStoreIncludingSubLayers();
 441     rootTextureMapperLayer.paint();
 442     m_textureMapper-&gt;endClip();
 443     m_textureMapper-&gt;endPainting();
 444 }
 445 
 446 void WebPage::notifyAnimationStarted(const GraphicsLayer*, const String&amp; /*animationKey*/, MonotonicTime /*time*/)
 447 {
 448     ASSERT_NOT_REACHED();
 449 }
 450 
 451 void WebPage::notifyFlushRequired(const GraphicsLayer*)
 452 {
 453     markForSync();
 454 }
 455 
 456 void WebPage::paintContents(const GraphicsLayer*,
<a name="2" id="anc2"></a><span class="line-modified"> 457                    GraphicsContext&amp; context,</span>
<span class="line-modified"> 458                    OptionSet&lt;GraphicsLayerPaintingPhase&gt;,</span>
<span class="line-modified"> 459                    const FloatRect&amp; inClip,</span>
<span class="line-modified"> 460                    GraphicsLayerPaintBehavior)</span>
 461 {
 462     context.save();
 463     context.clip(inClip);
 464     m_page-&gt;mainFrame().view()-&gt;paint(context, enclosingIntRect(inClip));
 465     if (m_page-&gt;settings().showDebugBorders()) {
 466         drawDebugBorder(context, roundedIntRect(inClip), Color(0, 192, 0), 20);
 467     }
 468     context.restore();
 469 }
 470 
 471 bool WebPage::processKeyEvent(const PlatformKeyboardEvent&amp; event)
 472 {
 473     return event.type() == PlatformKeyboardEvent::Char
 474         ? charEvent(event)
 475         : keyEvent(event);
 476 }
 477 
 478 //
 479 // The below keyboard event handling code was adapted from
 480 // WebKit/chromium/src/WebViewImpl.cpp
 481 //
 482 
 483 static const int VKEY_PRIOR = com_sun_webkit_event_WCKeyEvent_VK_PRIOR;
 484 static const int VKEY_NEXT = com_sun_webkit_event_WCKeyEvent_VK_NEXT;
 485 static const int VKEY_END = com_sun_webkit_event_WCKeyEvent_VK_END;
 486 static const int VKEY_HOME = com_sun_webkit_event_WCKeyEvent_VK_HOME;
 487 static const int VKEY_LEFT = com_sun_webkit_event_WCKeyEvent_VK_LEFT;
 488 static const int VKEY_UP = com_sun_webkit_event_WCKeyEvent_VK_UP;
 489 static const int VKEY_RIGHT = com_sun_webkit_event_WCKeyEvent_VK_RIGHT;
 490 static const int VKEY_DOWN = com_sun_webkit_event_WCKeyEvent_VK_DOWN;
 491 
 492 bool WebPage::keyEvent(const PlatformKeyboardEvent&amp; event)
 493 {
 494     ASSERT((event.type() == PlatformKeyboardEvent::RawKeyDown)
 495         || (event.type() == PlatformKeyboardEvent::KeyDown)
 496         || (event.type() == PlatformKeyboardEvent::KeyUp));
 497 
 498     // Please refer to the comments explaining the m_suppressNextKeypressEvent
 499     // member.
 500     // The m_suppressNextKeypressEvent is set if the KeyDown is handled by
 501     // Webkit. A keyDown event is typically associated with a keyPress(char)
 502     // event and a keyUp event. We reset this flag here as this is a new keyDown
 503     // event.
 504     m_suppressNextKeypressEvent = false;
 505 
 506     RefPtr&lt;Frame&gt; frame = focusedWebCoreFrame();
 507     if (!frame)
 508         return false;
 509 
 510     EventHandler&amp; handler = frame-&gt;eventHandler();
 511 
 512     if (handler.keyEvent(event)) {
 513         if (event.type() == PlatformKeyboardEvent::RawKeyDown) {
 514             // Suppress the next keypress event unless the focused node
 515             // is a plug-in node. (Flash needs these keypress events to
 516             // handle non-US keyboards.)
 517             Node* node = focusedWebCoreNode();
 518             if (!node || !node-&gt;renderer()
 519                     || !node-&gt;renderer()-&gt;isEmbeddedObject())
 520                 m_suppressNextKeypressEvent = true;
 521         }
 522         return true;
 523     }
 524 
 525     return keyEventDefault(event);
 526 }
 527 
 528 bool WebPage::charEvent(const PlatformKeyboardEvent&amp; event)
 529 {
 530     ASSERT(event.type() == PlatformKeyboardEvent::Char);
 531 
 532     // Please refer to the comments explaining the m_suppressNextKeypressEvent
 533     // member.  The m_suppressNextKeypressEvent is set if the KeyDown is
 534     // handled by Webkit. A keyDown event is typically associated with a
 535     // keyPress(char) event and a keyUp event. We reset this flag here as it
 536     // only applies to the current keyPress event.
 537     bool suppress = m_suppressNextKeypressEvent;
 538     m_suppressNextKeypressEvent = false;
 539 
 540     Frame* frame = focusedWebCoreFrame();
 541     if (!frame)
 542         return suppress;
 543 
 544     EventHandler&amp; handler = frame-&gt;eventHandler();
 545 
 546     if (!suppress &amp;&amp; !handler.keyEvent(event))
 547         return keyEventDefault(event);
 548 
 549     return true;
 550 }
 551 
 552 bool WebPage::keyEventDefault(const PlatformKeyboardEvent&amp; event)
 553 {
 554     Frame* frame = focusedWebCoreFrame();
 555     if (!frame)
 556         return false;
 557 
 558     switch (event.type()) {
 559     case PlatformKeyboardEvent::RawKeyDown:
 560         if (event.modifiers() == PlatformKeyboardEvent::Modifier::ControlKey) {
 561             switch (event.windowsVirtualKeyCode()) {
 562             // Match FF behavior in the sense that Ctrl+home/end are the only
 563             // Ctrl // key combinations which affect scrolling. Safari is buggy
 564             // in the sense that it scrolls the page for all Ctrl+scrolling key
 565             // combinations. For e.g. Ctrl+pgup/pgdn/up/down, etc.
 566             case VKEY_HOME:
 567             case VKEY_END:
 568                 break;
 569             default:
 570                 return false;
 571             }
 572         }
 573         if (!event.shiftKey())
 574             return scrollViewWithKeyboard(event.windowsVirtualKeyCode(), event);
 575         break;
 576     default:
 577         break;
 578     }
 579     return false;
 580 }
 581 
 582 bool WebPage::scrollViewWithKeyboard(int keyCode, const PlatformKeyboardEvent&amp; event)
 583 {
 584     ScrollDirection scrollDirection;
 585     ScrollGranularity scrollGranularity;
 586 #if OS(DARWIN)
 587     if (event.metaKey()) {
 588         if (keyCode == VKEY_UP)
 589             keyCode = VKEY_HOME;
 590         else if (keyCode == VKEY_DOWN)
 591             keyCode = VKEY_END;
 592     }
 593     if (event.altKey()) {
 594         if (keyCode == VKEY_UP)
 595             keyCode = VKEY_PRIOR;
 596         else if (keyCode == VKEY_DOWN)
 597             keyCode = VKEY_NEXT;
 598     }
 599 #endif
 600     if (!mapKeyCodeForScroll(keyCode, &amp;scrollDirection, &amp;scrollGranularity))
 601         return false;
 602     return propagateScroll(scrollDirection, scrollGranularity);
 603 }
 604 
 605 bool WebPage::mapKeyCodeForScroll(int keyCode,
 606                                   ScrollDirection* scrollDirection,
 607                                   ScrollGranularity* scrollGranularity)
 608 {
 609     switch (keyCode) {
 610     case VKEY_LEFT:
 611         *scrollDirection = ScrollLeft;
 612         *scrollGranularity = ScrollByLine;
 613         break;
 614     case VKEY_RIGHT:
 615         *scrollDirection = ScrollRight;
 616         *scrollGranularity = ScrollByLine;
 617         break;
 618     case VKEY_UP:
 619         *scrollDirection = ScrollUp;
 620         *scrollGranularity = ScrollByLine;
 621         break;
 622     case VKEY_DOWN:
 623         *scrollDirection = ScrollDown;
 624         *scrollGranularity = ScrollByLine;
 625         break;
 626     case VKEY_HOME:
 627         *scrollDirection = ScrollUp;
 628         *scrollGranularity = ScrollByDocument;
 629         break;
 630     case VKEY_END:
 631         *scrollDirection = ScrollDown;
 632         *scrollGranularity = ScrollByDocument;
 633         break;
 634     case VKEY_PRIOR:  // page up
 635         *scrollDirection = ScrollUp;
 636         *scrollGranularity = ScrollByPage;
 637         break;
 638     case VKEY_NEXT:  // page down
 639         *scrollDirection = ScrollDown;
 640         *scrollGranularity = ScrollByPage;
 641         break;
 642     default:
 643         return false;
 644     }
 645 
 646     return true;
 647 }
 648 
 649 bool WebPage::propagateScroll(ScrollDirection scrollDirection,
 650                               ScrollGranularity scrollGranularity)
 651 {
 652     Frame* frame = focusedWebCoreFrame();
 653     if (!frame)
 654         return false;
 655 
 656     bool scrollHandled = frame-&gt;eventHandler().scrollOverflow(
 657             scrollDirection,
 658             scrollGranularity);
 659     Frame* currentFrame = frame;
 660     while (!scrollHandled &amp;&amp; currentFrame) {
 661         scrollHandled = currentFrame-&gt;view()-&gt;scroll(scrollDirection,
 662                                                      scrollGranularity);
 663         currentFrame = currentFrame-&gt;tree().parent();
 664     }
 665     return scrollHandled;
 666 }
 667 
 668 Frame* WebPage::focusedWebCoreFrame()
 669 {
 670     return &amp;m_page-&gt;focusController().focusedOrMainFrame();
 671 }
 672 
 673 Node* WebPage::focusedWebCoreNode()
 674 {
 675     Frame* frame = m_page-&gt;focusController().focusedFrame();
 676     if (!frame)
 677         return 0;
 678 
 679     Document* document = frame-&gt;document();
 680     if (!document)
 681         return 0;
 682 
 683     return (Node*)document-&gt;focusedElement();
 684 }
 685 
 686 //implemented in customized WebCore/page/java/DragControllerJava.cpp
 687 void setCopyKeyState(bool _copyKeyIsDown);
 688 
 689 static String agentOS()
 690 {
 691 #if OS(DARWIN)
 692 #if CPU(X86) || CPU(X86_64)
 693     return &quot;Macintosh; Intel Mac OS X&quot;;
 694 #else
 695     return &quot;Macintosh; PPC Mac OS X&quot;;
 696 #endif
 697 #elif OS(UNIX)
 698     struct utsname name;
 699     if (uname(&amp;name) != -1)
 700         return makeString(name.sysname, &#39; &#39;, name.machine);
 701 #elif OS(WINDOWS)
 702     return windowsVersionForUAString();
 703 #else
 704     notImplemented();
 705 #endif
 706     return &quot;Unknown&quot;;
 707 }
 708 
 709 static String defaultUserAgent()
 710 {
 711     static const auto userAgentString = makeNeverDestroyed([] {
 712         String wkVersion = makeString(
 713                               WEBKIT_MAJOR_VERSION, &quot;.&quot;, WEBKIT_MINOR_VERSION,
 714                               &quot; (KHTML, like Gecko) JavaFX/&quot;, JAVAFX_RELEASE_VERSION,
 715                               &quot; Safari/&quot;, WEBKIT_MAJOR_VERSION, &quot;.&quot;,  WEBKIT_MINOR_VERSION);
 716         return makeString(&quot;Mozilla/5.0 (&quot;, agentOS(), &quot;) AppleWebKit/&quot;, wkVersion);
 717     }());
 718     return userAgentString;
 719 }
 720 
 721 int WebPage::beginPrinting(float width, float height)
 722 {
 723     Frame* frame = (Frame*)&amp;m_page-&gt;mainFrame();
 724     if (!frame-&gt;document() || !frame-&gt;view())
 725         return 0;
 726     frame-&gt;document()-&gt;updateLayout();
 727 
 728     ASSERT(!m_printContext);
 729     m_printContext = std::unique_ptr&lt;PrintContext&gt;(new PrintContext(frame));
 730     m_printContext-&gt;begin(width, height);
 731     m_printContext-&gt;computePageRects(FloatRect(0, 0, width, height), 0, 0, 1, height);
 732     return m_printContext-&gt;pageCount();
 733 }
 734 
 735 void WebPage::endPrinting()
 736 {
 737     ASSERT(m_printContext);
 738     if (!m_printContext)
 739         return;
 740 
 741     m_printContext-&gt;end();
 742     m_printContext.reset();
 743 }
 744 
 745 void WebPage::print(GraphicsContext&amp; gc, int pageIndex, float pageWidth)
 746 {
 747     ASSERT(m_printContext);
 748     ASSERT(pageIndex &gt;= 0 &amp;&amp; pageIndex &lt; m_printContext-&gt;pageCount());
 749 
 750     if (!m_printContext || pageIndex &lt; 0 || pageIndex &gt;= (int)m_printContext-&gt;pageCount())
 751         return;
 752 
 753     gc.save();
 754     gc.translate(0, 0);
 755     m_printContext-&gt;spoolPage(gc, pageIndex, pageWidth);
 756     gc.restore();
 757     gc.platformContext()-&gt;rq().flushBuffer();
 758 }
 759 
 760 int WebPage::globalDebugSessionCounter = 0;
 761 
 762 void WebPage::debugStarted() {
 763     if (!m_isDebugging) {
 764         m_isDebugging = true;
 765         globalDebugSessionCounter++;
 766 
 767         disableWatchdog();
 768     }
 769 }
 770 void WebPage::debugEnded() {
 771     if (m_isDebugging) {
 772         m_isDebugging = false;
 773         globalDebugSessionCounter--;
 774 
 775         enableWatchdog();
 776     }
 777 }
 778 void WebPage::enableWatchdog() {
 779     if (globalDebugSessionCounter == 0) {
 780         JSContextGroupRef contextGroup = toRef(&amp;mainThreadNormalWorld().vm());
 781         JSContextGroupSetExecutionTimeLimit(contextGroup, 10, 0, 0);
 782     }
 783 }
 784 
 785 void WebPage::disableWatchdog() {
 786     if (globalDebugSessionCounter &gt; 0) {
 787         JSContextGroupRef contextGroup = toRef(&amp;(mainThreadNormalWorld().vm()));
 788         JSContextGroupClearExecutionTimeLimit(contextGroup);
 789     }
 790 }
 791 
 792 } // namespace WebCore
 793 
 794 using namespace WebCore;
 795 using namespace WTF;
 796 
 797 class WebStorageNamespaceProviderJava final : public WebCore::StorageNamespaceProvider {
 798 public:
 799     void setLocalStorageDatabasePath(const String&amp; path) {
 800         m_localStorageDatabasePath = path;
 801     }
 802 private:
 803     String m_localStorageDatabasePath;
 804 
<a name="3" id="anc3"></a><span class="line-modified"> 805     Ref&lt;StorageNamespace&gt; createSessionStorageNamespace(Page&amp; page, unsigned quota) override</span>
 806     {
<a name="4" id="anc4"></a><span class="line-modified"> 807         return WebKit::StorageNamespaceImpl::createSessionStorageNamespace(quota, page.sessionID());</span>
 808     }
 809 
<a name="5" id="anc5"></a><span class="line-modified"> 810     Ref&lt;StorageNamespace&gt; createLocalStorageNamespace(unsigned quota, PAL::SessionID sessionID) override</span>
 811     {
<a name="6" id="anc6"></a><span class="line-modified"> 812         return WebKit::StorageNamespaceImpl::getOrCreateLocalStorageNamespace(m_localStorageDatabasePath, quota, sessionID);</span>
 813     }
 814 
<a name="7" id="anc7"></a><span class="line-modified"> 815     Ref&lt;StorageNamespace&gt; createTransientLocalStorageNamespace(SecurityOrigin&amp;, unsigned quota, PAL::SessionID sessionID) override</span>
 816     {
 817         // FIXME: A smarter implementation would create a special namespace type instead of just piggy-backing off
 818         // SessionStorageNamespace here.
<a name="8" id="anc8"></a><span class="line-modified"> 819         return WebKit::StorageNamespaceImpl::createSessionStorageNamespace(quota, sessionID);</span>





 820     }
 821 };
 822 
 823 namespace {
 824 
 825 bool s_useJIT;
 826 bool s_useDFGJIT;
 827 bool s_useCSS3D;
 828 
 829 }  // namespace
 830 
 831 extern &quot;C&quot; {
 832 
 833 JNIEXPORT void JNICALL Java_com_sun_webkit_WebPage_twkInitWebCore
 834     (JNIEnv* env, jclass self, jboolean useJIT, jboolean useDFGJIT, jboolean useCSS3D) {
 835     s_useJIT = useJIT;
 836     s_useDFGJIT = useDFGJIT;
 837     s_useCSS3D = useCSS3D;
 838 }
 839 
 840 JNIEXPORT jlong JNICALL Java_com_sun_webkit_WebPage_twkCreatePage
 841     (JNIEnv* env, jobject self, jboolean editable)
 842 {
 843     // FIXME-java(JDK-8169950): Refactor the following WebCore module
 844     // initialization flow.
 845     JSC::initializeThreading();
 846     WTF::initializeMainThread();
 847     RunLoop::initializeMainRunLoop();
 848     // RT-17330: Allow local loads for substitute data, that is,
 849     // for content loaded with twkLoad
 850     WebCore::SecurityPolicy::setLocalLoadPolicy(
 851             WebCore::SecurityPolicy::AllowLocalLoadsForLocalAndSubstituteData);
 852 
 853     //DBG_CHECKPOINTEX(&quot;twkCreatePage&quot;, 3, 5);
 854 
 855     VisitedLinkStoreJava::setShouldTrackVisitedLinks(true);
 856 
 857 #if !LOG_DISABLED
 858     WebKitInitializeLogChannelsIfNecessary();
 859 #endif
 860     WebCore::PlatformStrategiesJava::initialize();
 861 
 862     static std::once_flag initializeJSCOptions;
 863     std::call_once(initializeJSCOptions, [] {
 864         JSC::Options::useJIT() = s_useJIT;
 865         // Enable DFG only if JIT is enabled.
 866         JSC::Options::useDFGJIT() = s_useJIT &amp;&amp; s_useDFGJIT;
 867     });
 868 
 869     JLObject jlself(self, true);
 870 
 871     //utaTODO: history agent implementation
 872 
 873     auto pc = pageConfigurationWithEmptyClients();
 874     auto pageStorageSessionProvider = PageStorageSessionProvider::create();
 875     pc.cookieJar = CookieJar::create(pageStorageSessionProvider.copyRef());
 876     pc.chromeClient = new ChromeClientJava(jlself);
 877     pc.contextMenuClient = new ContextMenuClientJava(jlself);
 878     pc.editorClient = makeUniqueRef&lt;EditorClientJava&gt;(jlself);
 879     pc.dragClient = new DragClientJava(jlself);
 880     pc.inspectorClient = new InspectorClientJava(jlself);
 881     pc.databaseProvider = &amp;WebDatabaseProvider::singleton();
 882     pc.storageNamespaceProvider = adoptRef(new WebStorageNamespaceProviderJava());
 883     pc.visitedLinkStore = VisitedLinkStoreJava::create();
 884 
 885     pc.loaderClientForMainFrame = new FrameLoaderClientJava(jlself);
 886     pc.progressTrackerClient = new ProgressTrackerClientJava(jlself);
 887 
 888     pc.backForwardClient = BackForwardList::create();
 889     auto page = std::make_unique&lt;Page&gt;(WTFMove(pc));
 890     // Associate PageSupplementJava instance which has WebPage java object.
 891     page-&gt;provideSupplement(PageSupplementJava::supplementName(), std::make_unique&lt;PageSupplementJava&gt;(self));
 892     pageStorageSessionProvider-&gt;setPage(*page);
 893 #if ENABLE(GEOLOCATION)
 894     WebCore::provideGeolocationTo(page.get(), *new GeolocationClientMock());
 895 #endif
 896     return ptr_to_jlong(new WebPage(WTFMove(page)));
 897 }
 898 
 899 JNIEXPORT void JNICALL Java_com_sun_webkit_WebPage_twkInit
 900     (JNIEnv* env, jobject self, jlong pPage, jboolean usePlugins, jfloat devicePixelScale)
 901 {
 902     Page* page = WebPage::pageFromJLong(pPage);
 903 
 904     /* Initialization of the default settings */
 905     Settings&amp; settings = page-&gt;settings();
 906     settings.setTextAreasAreResizable(true);
 907     settings.setLoadsImagesAutomatically(true);
 908     settings.setMinimumFontSize(0);
 909     settings.setMinimumLogicalFontSize(5);
 910     settings.setAcceleratedCompositingEnabled(s_useCSS3D);
 911     settings.setScriptEnabled(true);
 912     settings.setJavaScriptCanOpenWindowsAutomatically(true);
 913     settings.setPluginsEnabled(usePlugins);
 914     settings.setDefaultFixedFontSize(13);
 915     settings.setDefaultFontSize(16);
 916     settings.setContextMenuEnabled(true);
 917     settings.setUserAgent(defaultUserAgent());
 918     settings.setMaximumHTMLParserDOMTreeDepth(180);
 919     settings.setXSSAuditorEnabled(true);
 920     settings.setInteractiveFormValidationEnabled(true);
 921 
 922     /* Using java logical fonts as defaults */
 923     settings.setSerifFontFamily(&quot;Serif&quot;);
 924     settings.setSansSerifFontFamily(&quot;SansSerif&quot;);
 925     settings.setFixedFontFamily(&quot;Monospaced&quot;);
 926     page-&gt;setDeviceScaleFactor(devicePixelScale);
 927 
 928     RuntimeEnabledFeatures::sharedFeatures().setLinkPrefetchEnabled(true);
 929     RuntimeEnabledFeatures::sharedFeatures().setInputTypeColorEnabled(true);
 930     static_cast&lt;FrameLoaderClientJava&amp;&gt;(page-&gt;mainFrame().loader().client())
 931                                             .setFrame(&amp;page-&gt;mainFrame());
 932 
 933     page-&gt;mainFrame().init();
 934 
 935     JSContextGroupRef contextGroup = toRef(&amp;(mainThreadNormalWorld().vm()));
 936     JSContextGroupSetExecutionTimeLimit(contextGroup, 10, 0, 0);
 937 
 938     WebPage::webPageFromJLong(pPage)-&gt;enableWatchdog();
 939 }
 940 
 941 JNIEXPORT void JNICALL Java_com_sun_webkit_WebPage_twkDestroyPage
 942     (JNIEnv* env, jobject self, jlong pPage)
 943 {
 944     WebPage* webPage = WebPage::webPageFromJLong(pPage);
 945     if (!webPage) {
 946         return;
 947     }
 948 
 949     Frame* mainFrame = (Frame*)&amp;webPage-&gt;page()-&gt;mainFrame();
 950     if (mainFrame) {
 951         mainFrame-&gt;loader().stopAllLoaders();
 952         mainFrame-&gt;loader().detachFromParent();
 953     }
 954 
 955     delete webPage;
 956 }
 957 
 958 JNIEXPORT jlong JNICALL Java_com_sun_webkit_WebPage_twkGetMainFrame
 959     (JNIEnv* env, jobject self, jlong pPage)
 960 {
 961     Page* page = WebPage::pageFromJLong(pPage);
 962     if (!page) {
 963         return 0;
 964     }
 965     Frame* mainFrame = (Frame*)&amp;page-&gt;mainFrame();
 966     if (!mainFrame) {
 967         return 0;
 968     }
 969     return ptr_to_jlong(mainFrame);
 970 }
 971 
 972 JNIEXPORT jlong JNICALL Java_com_sun_webkit_WebPage_twkGetParentFrame
 973     (JNIEnv* env, jobject self, jlong pFrame)
 974 {
 975     Frame* frame = static_cast&lt;Frame*&gt;(jlong_to_ptr(pFrame));
 976     if (!frame) {
 977         return 0;
 978     }
 979     Frame* parentFrame = frame-&gt;tree().parent();
 980     if (!parentFrame) {
 981         return 0;
 982     }
 983     return ptr_to_jlong(parentFrame);
 984 }
 985 
 986 JNIEXPORT jlongArray JNICALL Java_com_sun_webkit_WebPage_twkGetChildFrames
 987     (JNIEnv* env, jobject self, jlong pFrame)
 988 {
 989     Frame* frame = static_cast&lt;Frame*&gt;(jlong_to_ptr(pFrame));
 990     if (!frame) {
 991         return 0;
 992     }
 993 
 994     FrameTree&amp; tree = frame-&gt;tree();
 995 
 996     jlongArray jArray = env-&gt;NewLongArray(tree.childCount());
 997     jlong *arr = env-&gt;GetLongArrayElements(jArray, 0);
 998     int i = 0;
 999     for (Frame* child = tree.firstChild(); child; child = child-&gt;tree().nextSibling()) {
1000         arr[i++] = ptr_to_jlong(child);
1001     }
1002     env-&gt;ReleaseLongArrayElements(jArray, arr, 0);
1003 
1004     return jArray;
1005 }
1006 
1007 JNIEXPORT jstring JNICALL Java_com_sun_webkit_WebPage_twkGetName
1008     (JNIEnv* env, jobject self, jlong pFrame)
1009 {
1010     Frame* frame = static_cast&lt;Frame*&gt;(jlong_to_ptr(pFrame));
1011     if (!frame) {
1012         return 0;
1013     }
1014     return frame-&gt;tree().uniqueName().string().toJavaString(env).releaseLocal();
1015 }
1016 
1017 JNIEXPORT jstring JNICALL Java_com_sun_webkit_WebPage_twkGetURL
1018     (JNIEnv* env, jobject self, jlong pFrame)
1019 {
1020     Frame* frame = static_cast&lt;Frame*&gt;(jlong_to_ptr(pFrame));
1021     if (!frame || !frame-&gt;document()) {
1022         return 0;
1023     }
1024     Document* doc = frame-&gt;document();
1025     if (!doc) {
1026         return 0;
1027     }
1028     return doc-&gt;url().string().toJavaString(env).releaseLocal();
1029 }
1030 
1031 JNIEXPORT jstring JNICALL Java_com_sun_webkit_WebPage_twkGetInnerText
1032     (JNIEnv* env, jobject self, jlong pFrame)
1033 {
1034     Frame* frame = static_cast&lt;Frame*&gt;(jlong_to_ptr(pFrame));
1035     if (!frame) {
1036         return 0;
1037     }
1038 
1039     Document* document = frame-&gt;document();
1040     if (!document) {
1041         return 0;
1042     }
1043 
1044     Element* documentElement = document-&gt;documentElement();
1045     if (!documentElement) {
1046         return 0;
1047     }
1048 
1049     FrameView* frameView = frame-&gt;view();
1050     if (frameView &amp;&amp; frameView-&gt;layoutContext().isLayoutPending()) {
1051         frameView-&gt;layoutContext().layout();
1052     }
1053 
1054     return documentElement-&gt;innerText().toJavaString(env).releaseLocal();
1055 }
1056 
1057 JNIEXPORT jstring JNICALL Java_com_sun_webkit_WebPage_twkGetRenderTree
1058     (JNIEnv* env, jobject self, jlong pFrame)
1059 {
1060     Frame* frame = static_cast&lt;Frame*&gt;(jlong_to_ptr(pFrame));
1061     if (!frame || !frame-&gt;contentRenderer()) {
1062         return 0;
1063     }
1064 
1065     FrameView* frameView = frame-&gt;view();
1066     if (frameView &amp;&amp; frameView-&gt;layoutContext().isLayoutPending()) {
1067         frameView-&gt;layoutContext().layout();
1068     }
1069 
1070     return externalRepresentation(frame).toJavaString(env).releaseLocal();
1071 }
1072 
1073 JNIEXPORT jstring JNICALL Java_com_sun_webkit_WebPage_twkGetContentType
1074     (JNIEnv* env, jobject self, jlong pFrame)
1075 {
1076     Frame* frame = static_cast&lt;Frame*&gt;(jlong_to_ptr(pFrame));
1077     if (!frame || !frame-&gt;loader().documentLoader()) {
1078         return 0;
1079     }
1080     return frame-&gt;loader().documentLoader()-&gt;responseMIMEType().toJavaString(env).releaseLocal();
1081 }
1082 
1083 JNIEXPORT jstring JNICALL Java_com_sun_webkit_WebPage_twkGetTitle
1084     (JNIEnv* env, jobject self, jlong pFrame)
1085 {
1086     Frame* frame = static_cast&lt;Frame*&gt;(jlong_to_ptr(pFrame));
1087     if (!frame || !frame-&gt;document()) {
1088         return 0;
1089     }
1090     return frame-&gt;document()-&gt;title().toJavaString(env).releaseLocal();
1091 }
1092 
1093 JNIEXPORT jstring JNICALL Java_com_sun_webkit_WebPage_twkGetIconURL
1094     (JNIEnv* env, jobject self, jlong pFrame)
1095 {
1096     Frame* frame = static_cast&lt;Frame*&gt;(jlong_to_ptr(pFrame));
1097     if (!frame) {
1098         return 0;
1099     }
1100 #if ENABLE(ICONDATABASE)
1101     return frame-&gt;loader()-&gt;icon()-&gt;url().string().toJavaString(env).releaseLocal();
1102 #else
1103     return 0;
1104 #endif
1105 }
1106 
1107 JNIEXPORT void JNICALL Java_com_sun_webkit_WebPage_twkOpen
1108     (JNIEnv* env, jobject self, jlong pFrame, jstring url)
1109 {
1110     Frame* frame = static_cast&lt;Frame*&gt;(jlong_to_ptr(pFrame));
1111     if (!frame) {
1112         return;
1113     }
1114 
1115     static const URL emptyParent;
1116 
1117     frame-&gt;loader().load(FrameLoadRequest(
1118         *frame,
1119         ResourceRequest(URL(emptyParent, String(env, url))),
1120         ShouldOpenExternalURLsPolicy::ShouldNotAllow // TODO-java: recheck policy value
1121     ));
1122 }
1123 
1124 JNIEXPORT void JNICALL Java_com_sun_webkit_WebPage_twkLoad
1125     (JNIEnv* env, jobject self, jlong pFrame, jstring text, jstring contentType)
1126 {
1127     Frame* frame = static_cast&lt;Frame*&gt;(jlong_to_ptr(pFrame));
1128     if (!frame) {
1129         return;
1130     }
1131 
1132     const char* stringChars = env-&gt;GetStringUTFChars(text, JNI_FALSE);
1133     size_t stringLen = (size_t)env-&gt;GetStringUTFLength(text);
1134     RefPtr&lt;SharedBuffer&gt; buffer = SharedBuffer::create(stringChars, (int)stringLen);
1135 
1136     static const URL emptyUrl({ }, &quot;&quot;);
1137     ResourceResponse response(URL(), String(env, contentType), stringLen, &quot;UTF-8&quot;);
1138     frame-&gt;loader().load(FrameLoadRequest(
1139         *frame,
1140         ResourceRequest(emptyUrl),
1141         ShouldOpenExternalURLsPolicy::ShouldNotAllow, // TODO-java: recheck policy value
1142         SubstituteData(
1143             WTFMove(buffer),
1144             URL(),
1145             response,
1146             SubstituteData::SessionHistoryVisibility::Visible) // TODO-java: or Hidden?
1147     ));
1148 
1149     env-&gt;ReleaseStringUTFChars(text, stringChars);
1150 }
1151 
1152 JNIEXPORT jboolean JNICALL Java_com_sun_webkit_WebPage_twkIsLoading
1153     (JNIEnv* env, jobject self, jlong pFrame)
1154 {
1155     Frame* frame = static_cast&lt;Frame*&gt;(jlong_to_ptr(pFrame));
1156 
1157     return bool_to_jbool(frame &amp;&amp; frame-&gt;loader().isLoading());
1158 }
1159 
1160 JNIEXPORT void JNICALL Java_com_sun_webkit_WebPage_twkStop
1161     (JNIEnv* env, jobject self, jlong pFrame)
1162 {
1163     Frame* frame = static_cast&lt;Frame*&gt;(jlong_to_ptr(pFrame));
1164     if (!frame) {
1165         return;
1166     }
1167 
1168     frame-&gt;loader().stopAllLoaders();
1169 }
1170 
1171 JNIEXPORT void JNICALL Java_com_sun_webkit_WebPage_twkStopAll
1172     (JNIEnv* env, jobject self, jlong pPage)
1173 {
1174     Page* page = WebPage::pageFromJLong(pPage);
1175     if (!page) {
1176         return;
1177     }
1178 
1179     page-&gt;mainFrame().loader().stopAllLoaders();
1180 }
1181 
1182 JNIEXPORT void JNICALL Java_com_sun_webkit_WebPage_twkRefresh
1183     (JNIEnv* env, jobject self, jlong pFrame)
1184 {
1185     Frame* frame = static_cast&lt;Frame*&gt;(jlong_to_ptr(pFrame));
1186     if (!frame) {
1187         return;
1188     }
1189 
1190     frame-&gt;loader().reload(ReloadOption::FromOrigin);
1191 }
1192 
1193 JNIEXPORT jboolean JNICALL Java_com_sun_webkit_WebPage_twkGoBackForward
1194     (JNIEnv* env, jobject self, jlong pPage, jint distance)
1195 {
1196     Page* page = WebPage::pageFromJLong(pPage);
1197     if (!page) {
1198         return JNI_FALSE;
1199     }
1200 
1201     if (page-&gt;backForward().canGoBackOrForward(distance)) {
1202         page-&gt;backForward().goBackOrForward(distance);
1203         return JNI_TRUE;
1204     }
1205 
1206     return JNI_FALSE;
1207 }
1208 
1209 JNIEXPORT jboolean JNICALL Java_com_sun_webkit_WebPage_twkCopy
1210     (JNIEnv* env, jobject self, jlong pFrame)
1211 {
1212     Frame* frame = static_cast&lt;Frame*&gt;(jlong_to_ptr(pFrame));
1213     if (!frame) {
1214         return JNI_FALSE;
1215     }
1216 
1217     if (frame-&gt;editor().canCopy()) {
1218         frame-&gt;editor().copy();
1219         return JNI_TRUE;
1220     }
1221 
1222     return JNI_FALSE;
1223 }
1224 
1225 
1226 JNIEXPORT jboolean JNICALL Java_com_sun_webkit_WebPage_twkFindInPage
1227     (JNIEnv* env, jobject self, jlong pPage,
1228      jstring toFind, jboolean forward, jboolean wrap, jboolean matchCase)
1229 {
1230     Page* page = WebPage::pageFromJLong(pPage);
1231     if (page) {
1232         FindOptions opts;
1233         if (!matchCase)
1234             opts.add(CaseInsensitive);
1235         if (!forward)
1236             opts.add(Backwards);
1237         if (wrap)
1238             opts.add(WrapAround);
1239         return bool_to_jbool(page-&gt;findString(String(env, toFind), opts));
1240     }
1241     return JNI_FALSE;
1242 }
1243 
1244 JNIEXPORT jboolean JNICALL Java_com_sun_webkit_WebPage_twkFindInFrame
1245     (JNIEnv* env, jobject self, jlong pFrame,
1246      jstring toFind, jboolean forward, jboolean wrap, jboolean matchCase)
1247 {
1248     Frame* frame = static_cast&lt;Frame*&gt;(jlong_to_ptr(pFrame));
1249     if (frame) {
1250         //utatodo: support for the rest of FindOptionFlag
1251         FindOptions opts;
1252         if (!matchCase)
1253             opts.add(CaseInsensitive);
1254         if (!forward)
1255             opts.add(Backwards);
1256         if (wrap)
1257             opts.add(WrapAround);
1258         return bool_to_jbool(frame-&gt;page()-&gt;findString(
1259             String(env, toFind), opts | StartInSelection));
1260     }
1261     return JNI_FALSE;
1262 }
1263 
1264 JNIEXPORT void JNICALL Java_com_sun_webkit_WebPage_twkOverridePreference
1265     (JNIEnv* env, jobject self, jlong pPage, jstring propertyName, jstring propertyValue)
1266 {
1267     Page* page = WebPage::pageFromJLong(pPage);
1268     if (!page) {
1269         return;
1270     }
1271 
1272     Settings&amp; settings = page-&gt;settings();
1273     String nativePropertyName(env, propertyName);
1274     String nativePropertyValue(env, propertyValue);
1275 
1276     if (nativePropertyName == &quot;WebKitTextAreasAreResizable&quot;) {
1277         settings.setTextAreasAreResizable(nativePropertyValue.toInt());
1278     } else if (nativePropertyName == &quot;WebKitLoadsImagesAutomatically&quot;) {
1279         settings.setLoadsImagesAutomatically(nativePropertyValue.toInt());
1280     } else if (nativePropertyName == &quot;WebKitMinimumFontSize&quot;) {
1281         settings.setMinimumFontSize(nativePropertyValue.toInt());
1282     } else if (nativePropertyName == &quot;WebKitMinimumLogicalFontSize&quot;) {
1283         settings.setMinimumLogicalFontSize(nativePropertyValue.toInt());
1284     } else if (nativePropertyName == &quot;WebKitAcceleratedCompositingEnabled&quot;) {
1285         settings.setAcceleratedCompositingEnabled(nativePropertyValue.toInt());
1286     } else if (nativePropertyName == &quot;WebKitScriptEnabled&quot;) {
1287         settings.setScriptEnabled(nativePropertyValue.toInt());
1288     } else if (nativePropertyName == &quot;WebKitJavaScriptCanOpenWindowsAutomatically&quot;) {
1289         settings.setJavaScriptCanOpenWindowsAutomatically(nativePropertyValue.toInt());
1290     } else if (nativePropertyName == &quot;WebKitPluginsEnabled&quot;) {
1291         settings.setPluginsEnabled(nativePropertyValue.toInt());
1292     } else if (nativePropertyName == &quot;WebKitDefaultFixedFontSize&quot;) {
1293         settings.setDefaultFixedFontSize(nativePropertyValue.toInt());
1294     } else if (nativePropertyName == &quot;WebKitContextMenuEnabled&quot;) {
1295         settings.setContextMenuEnabled(nativePropertyValue.toInt());
1296     } else if (nativePropertyName == &quot;WebKitUserAgent&quot;) {
1297         settings.setUserAgent(nativePropertyValue);
1298     } else if (nativePropertyName == &quot;WebKitMaximumHTMLParserDOMTreeDepth&quot;) {
1299         settings.setMaximumHTMLParserDOMTreeDepth(nativePropertyValue.toUInt());
1300     } else if (nativePropertyName == &quot;WebKitXSSAuditorEnabled&quot;)  {
1301         settings.setXSSAuditorEnabled(nativePropertyValue.toInt());
1302     } else if (nativePropertyName == &quot;WebKitSerifFontFamily&quot;) {
1303         settings.setSerifFontFamily(nativePropertyValue);
1304     } else if (nativePropertyName == &quot;WebKitSansSerifFontFamily&quot;) {
1305         settings.setSansSerifFontFamily(nativePropertyValue);
1306     } else if (nativePropertyName == &quot;WebKitFixedFontFamily&quot;) {
1307         settings.setFixedFontFamily(nativePropertyValue);
1308     } else if (nativePropertyName == &quot;WebKitShowsURLsInToolTips&quot;) {
1309         settings.setShowsURLsInToolTips(nativePropertyValue.toInt());
1310     } else if (nativePropertyName == &quot;WebKitUsesPageCachePreferenceKey&quot;) {
1311         settings.setUsesPageCache(nativePropertyValue.toInt() != 0);
1312     } else if (nativePropertyName == &quot;WebKitJavaScriptCanAccessClipboardPreferenceKey&quot;) {
1313         settings.setJavaScriptCanAccessClipboard(nativePropertyValue.toInt() != 0);
1314     } else if (nativePropertyName == &quot;enableColorFilter&quot;) {
1315         settings.setColorFilterEnabled(nativePropertyValue == &quot;true&quot;);
<a name="9" id="anc9"></a><span class="line-added">1316     } else if (nativePropertyName == &quot;enableKeygenElement&quot;) {</span>
<span class="line-added">1317         // removed from Chrome, Firefox, and the HTML specification in 2017.</span>
<span class="line-added">1318         // https://trac.webkit.org/changeset/248960/webkit</span>
<span class="line-added">1319         RuntimeEnabledFeatures::sharedFeatures().setKeygenElementEnabled(nativePropertyValue == &quot;true&quot;);</span>
1320     } else if (nativePropertyName == &quot;experimental:WebAnimationsCSSIntegrationEnabled&quot;) {
1321         RuntimeEnabledFeatures::sharedFeatures().setWebAnimationsCSSIntegrationEnabled(nativePropertyValue == &quot;true&quot;);
1322     } else if (nativePropertyName == &quot;enableIntersectionObserver&quot;) {
1323 #if ENABLE(INTERSECTION_OBSERVER)
1324         RuntimeEnabledFeatures::sharedFeatures().setIntersectionObserverEnabled(nativePropertyValue == &quot;true&quot;);
1325 #endif
1326     } else if(nativePropertyName == &quot;jscOptions&quot; &amp;&amp; !nativePropertyValue.isEmpty()) {
1327         JSC::Options::setOptions(nativePropertyValue.utf8().data());
1328     } else if(nativePropertyName == &quot;experimental:CSSCustomPropertiesAndValuesEnabled&quot;) {
1329         RuntimeEnabledFeatures::sharedFeatures().setCSSCustomPropertiesAndValuesEnabled(nativePropertyValue == &quot;true&quot;);
1330     }
1331 }
1332 
1333 JNIEXPORT void JNICALL Java_com_sun_webkit_WebPage_twkResetToConsistentStateBeforeTesting
1334     (JNIEnv* env, jobject self, jlong pPage)
1335 {
1336     Page* page = WebPage::pageFromJLong(pPage);
1337     if (!page) {
1338         return;
1339     }
1340 
1341     Settings&amp; settings = page-&gt;settings();
1342 
1343     settings.setAllowUniversalAccessFromFileURLs(true);
1344     settings.setAllowFileAccessFromFileURLs(true);
1345     // settings.setStandardFontFamily(standardFamily);
1346     // settings.setFixedFontFamily(fixedFamily);
1347     // settings.setSerifFontFamily(standardFamily);
1348     // settings.setSansSerifFontFamily(sansSerifFamily);
1349     // settings.setCursiveFontFamily(cursiveFamily);
1350     // settings.setFantasyFontFamily(fantasyFamily);
1351     // settings.setPictographFontFamily(pictographFamily);
1352     settings.setDefaultFontSize(16);
1353     settings.setDefaultFixedFontSize(13);
1354     settings.setMinimumFontSize(0);
1355     settings.setDefaultTextEncodingName(&quot;ISO-8859-1&quot;);
1356     settings.setJavaEnabled(false);
1357     settings.setFullScreenEnabled(true);
1358     settings.setScriptEnabled(true);
1359     settings.setEditableLinkBehavior(EditableLinkOnlyLiveWithShiftKey);
1360     // settings.setTabsToLinks(false);
1361     settings.setDOMPasteAllowed(true);
1362     settings.setShouldPrintBackgrounds(true);
1363     // settings.setCacheModel(WebCacheModelDocumentBrowser);
1364     settings.setXSSAuditorEnabled(false);
1365     settings.setExperimentalNotificationsEnabled(false);
1366     settings.setPluginsEnabled(true);
1367     settings.setTextAreasAreResizable(true);
1368     settings.setUsesPageCache(false);
1369     settings.setCSSOMViewScrollingAPIEnabled(true);
1370 
1371     // settings.setPrivateBrowsingEnabled(false);
1372     settings.setAuthorAndUserStylesEnabled(true);
1373     // Shrinks standalone images to fit: YES
1374     settings.setJavaScriptCanOpenWindowsAutomatically(true);
1375     settings.setJavaScriptCanAccessClipboard(true);
1376     settings.setOfflineWebApplicationCacheEnabled(true);
1377     // settings.setDeveloperExtrasEnabled(false);
1378     settings.setJavaScriptRuntimeFlags(JSC::RuntimeFlags(0));
1379     // Set JS experiments enabled: YES
1380     settings.setLoadsImagesAutomatically(true);
1381     settings.setLoadsSiteIconsIgnoringImageLoadingSetting(false);
1382     settings.setFrameFlattening(FrameFlattening::Disabled);
1383     settings.setFontRenderingMode(FontRenderingMode::Normal);
1384     // Doesn&#39;t work well with DRT
1385     settings.setScrollAnimatorEnabled(false);
1386     // Set spatial navigation enabled: NO
1387 
1388     // Set WebGL Enabled: NO
1389     // settings.setCSSRegionsEnabled(true);
1390     // Set uses HTML5 parser quirks: NO
1391     // Async spellcheck: NO
1392     DeprecatedGlobalSettings::setMockScrollbarsEnabled(true);
1393 
1394 
1395     RuntimeEnabledFeatures::sharedFeatures().setFetchAPIEnabled(true);
1396     RuntimeEnabledFeatures::sharedFeatures().setShadowDOMEnabled(true);
1397     RuntimeEnabledFeatures::sharedFeatures().setCustomElementsEnabled(true);
1398     RuntimeEnabledFeatures::sharedFeatures().setModernMediaControlsEnabled(false);
1399     RuntimeEnabledFeatures::sharedFeatures().setResourceTimingEnabled(true);
1400     RuntimeEnabledFeatures::sharedFeatures().setUserTimingEnabled(true);
1401     RuntimeEnabledFeatures::sharedFeatures().setDataTransferItemsEnabled(true);
1402     RuntimeEnabledFeatures::sharedFeatures().setInspectorAdditionsEnabled(true);
1403     RuntimeEnabledFeatures::sharedFeatures().setWebAnimationsEnabled(true);
1404     // RuntimeEnabledFeatures::sharedFeatures().clearNetworkLoaderSession();
1405 
1406     Frame&amp; coreFrame = page-&gt;mainFrame();
1407     auto globalContext = toGlobalRef(coreFrame.script().globalObject(mainThreadNormalWorld())-&gt;globalExec());
1408     WebCoreTestSupport::resetInternalsObject(globalContext);
1409 }
1410 
1411 JNIEXPORT jfloat JNICALL Java_com_sun_webkit_WebPage_twkGetZoomFactor
1412     (JNIEnv* env, jobject self, jlong pFrame, jboolean textOnly)
1413 {
1414     Frame* frame = static_cast&lt;Frame*&gt;(jlong_to_ptr(pFrame));
1415     ASSERT(frame);
1416     if (!frame) {
1417         return 1.0;
1418     }
1419     return textOnly
1420         ? frame-&gt;textZoomFactor()
1421         : frame-&gt;pageZoomFactor();
1422 }
1423 
1424 JNIEXPORT void JNICALL Java_com_sun_webkit_WebPage_twkSetZoomFactor
1425     (JNIEnv* env, jobject self, jlong pFrame, jfloat zoomFactor, jboolean textOnly)
1426 {
1427     Frame* frame = static_cast&lt;Frame*&gt;(jlong_to_ptr(pFrame));
1428     ASSERT(frame);
1429     if (!frame) {
1430         return;
1431     }
1432     if (textOnly) {
1433         frame-&gt;setTextZoomFactor(zoomFactor);
1434     } else {
1435         frame-&gt;setPageZoomFactor(zoomFactor);
1436     }
1437 }
1438 
1439 JNIEXPORT jobject JNICALL Java_com_sun_webkit_WebPage_twkExecuteScript
1440     (JNIEnv* env, jobject self, jlong pFrame, jstring script)
1441 {
1442     Frame* frame = static_cast&lt;Frame*&gt;(jlong_to_ptr(pFrame));
1443     if (!frame) {
1444         return nullptr;
1445     }
1446     JSGlobalContextRef globalContext = getGlobalContext(&amp;frame-&gt;script());
1447     RefPtr&lt;JSC::Bindings::RootObject&gt; rootObject(frame-&gt;script().createRootObject(frame));
1448     return WebCore::executeScript(
1449         env,
1450         nullptr,
1451         globalContext,
1452         rootObject.get(),
1453         script);
1454 }
1455 
1456 JNIEXPORT void JNICALL Java_com_sun_webkit_WebPage_twkAddJavaScriptBinding
1457     (JNIEnv* env, jobject self, jlong pFrame, jstring name, jobject value, jobject accessControlContext)
1458 {
1459     Frame* frame = static_cast&lt;Frame*&gt;(jlong_to_ptr(pFrame));
1460     if (!frame) {
1461         return;
1462     }
1463     JSGlobalContextRef globalContext = getGlobalContext(&amp;frame-&gt;script());
1464     JSObjectRef window = JSContextGetGlobalObject(globalContext);
1465     RefPtr&lt;JSC::Bindings::RootObject&gt; rootObject(frame-&gt;script().createRootObject(frame));
1466 
1467     JSValueRef jsval = WebCore::Java_Object_to_JSValue(
1468         env,
1469         globalContext,
1470         rootObject.get(),
1471         value, accessControlContext);
1472 
1473     JSStringRef jsname = asJSStringRef(env, name);
1474     JSValueRef exception;
1475     if (JSValueIsUndefined(globalContext, jsval)) {
1476         JSObjectDeleteProperty(globalContext, window, jsname, &amp;exception);
1477     } else {
1478         JSPropertyAttributes attributes = 0;
1479         JSObjectSetProperty(globalContext, window, jsname, jsval, attributes, &amp;exception);
1480     }
1481     JSStringRelease(jsname);
1482 }
1483 
1484 JNIEXPORT void JNICALL Java_com_sun_webkit_WebPage_twkReset
1485     (JNIEnv* env, jobject self, jlong pFrame)
1486 {
1487     Frame* frame = static_cast&lt;Frame*&gt;(jlong_to_ptr(pFrame));
1488     if (!frame) {
1489         return;
1490     }
1491 
1492     frame-&gt;tree().clearName();
1493 }
1494 
1495 JNIEXPORT jint JNICALL Java_com_sun_webkit_WebPage_twkBeginPrinting
1496     (JNIEnv* env, jobject self, jlong pPage, jfloat width, jfloat height)
1497 {
1498     return WebPage::webPageFromJLong(pPage)-&gt;beginPrinting(width, height);
1499 }
1500 
1501 JNIEXPORT void JNICALL Java_com_sun_webkit_WebPage_twkEndPrinting
1502     (JNIEnv* env, jobject self, jlong pPage)
1503 {
1504     return WebPage::webPageFromJLong(pPage)-&gt;endPrinting();
1505 }
1506 
1507 JNIEXPORT void JNICALL Java_com_sun_webkit_WebPage_twkPrint
1508     (JNIEnv* env, jobject self, jlong pPage, jobject rq, jint pageIndex, jfloat width)
1509 {
1510     auto webPage = WebPage::webPageFromJLong(pPage);
1511     PlatformContextJava* ppgc = new PlatformContextJava(rq, webPage-&gt;jRenderTheme());
1512     GraphicsContext gc(ppgc);
1513     webPage-&gt;print(gc, pageIndex, width);
1514 }
1515 
1516 JNIEXPORT jint JNICALL Java_com_sun_webkit_WebPage_twkGetFrameHeight
1517     (JNIEnv* env, jobject self, jlong pFrame)
1518 {
1519     Frame* frame = static_cast&lt;Frame*&gt;(jlong_to_ptr(pFrame));
1520     if (!frame || !frame-&gt;contentRenderer()) {
1521         return 0;
1522     }
1523 
1524     return frame-&gt;contentRenderer()-&gt;viewLogicalHeight();
1525 /*
1526     bool isFrameSet = frame-&gt;document() &amp;&amp; frame-&gt;document()-&gt;isFrameSet();
1527     if (isFrameSet) {
1528         RenderView* root = static_cast&lt;RenderView*&gt;(frame-&gt;document()-&gt;renderer());
1529         return root-&gt;bottomLayoutOverflow();
1530     } else {
1531         return frame-&gt;contentRenderer()-&gt;bottomLayoutOverflow();
1532     }
1533 */
1534 }
1535 
1536 JNIEXPORT jfloat JNICALL Java_com_sun_webkit_WebPage_twkAdjustFrameHeight
1537     (JNIEnv* env, jobject self, jlong pFrame,
1538      jfloat oldTop, jfloat oldBottom, jfloat bottomLimit)
1539 {
1540     Frame* frame = static_cast&lt;Frame*&gt;(jlong_to_ptr(pFrame));
1541     if (!frame || !frame-&gt;view()) {
1542         return oldBottom;
1543     }
1544 
1545     float result;
1546     frame-&gt;view()-&gt;adjustPageHeightDeprecated(&amp;result, oldTop, oldBottom, bottomLimit);
1547     return result;
1548 }
1549 
1550 JNIEXPORT void JNICALL Java_com_sun_webkit_WebPage_twkSetBounds
1551     (JNIEnv* env, jobject self, jlong pPage, jint x, jint y, jint w, jint h)
1552 {
1553     WebPage::webPageFromJLong(pPage)-&gt;setSize(IntSize(w, h));
1554 }
1555 
1556 JNIEXPORT jintArray JNICALL Java_com_sun_webkit_WebPage_twkGetVisibleRect
1557     (JNIEnv* env, jobject self, jlong pFrame)
1558 {
1559     Frame* frame = static_cast&lt;Frame*&gt;(jlong_to_ptr(pFrame));
1560     if (!frame || !frame-&gt;view()) {
1561         return nullptr;
1562     }
1563     IntRect rect = frame-&gt;view()-&gt;visibleContentRect();
1564 
1565     jintArray result = env-&gt;NewIntArray(4);
1566     WTF::CheckAndClearException(env);
1567 
1568     jint* arr = (jint*)env-&gt;GetPrimitiveArrayCritical(result, nullptr);
1569     arr[0] = rect.x();
1570     arr[1] = rect.y();
1571     arr[2] = rect.width();
1572     arr[3] = rect.height();
1573     env-&gt;ReleasePrimitiveArrayCritical(result, arr, 0);
1574 
1575     return result;
1576 }
1577 
1578 JNIEXPORT void JNICALL Java_com_sun_webkit_WebPage_twkScrollToPosition
1579     (JNIEnv* env, jobject self, jlong pFrame, jint x, jint y)
1580 {
1581     Frame* frame = static_cast&lt;Frame*&gt;(jlong_to_ptr(pFrame));
1582     if (!frame || !frame-&gt;view()) {
1583         return;
1584     }
1585     frame-&gt;view()-&gt;setScrollPosition(IntPoint(x, y));
1586 }
1587 
1588 JNIEXPORT jintArray JNICALL Java_com_sun_webkit_WebPage_twkGetContentSize
1589     (JNIEnv* env, jobject self, jlong pFrame)
1590 {
1591     Frame* frame = static_cast&lt;Frame*&gt;(jlong_to_ptr(pFrame));
1592     if (!frame || !frame-&gt;view()) {
1593         return nullptr;
1594     }
1595     IntSize size = frame-&gt;view()-&gt;contentsSize();
1596 
1597     jintArray result = env-&gt;NewIntArray(2);
1598     WTF::CheckAndClearException(env);
1599 
1600     jint* arr = (jint*)env-&gt;GetPrimitiveArrayCritical(result, nullptr);
1601     arr[0] = size.width();
1602     arr[1] = size.height();
1603     env-&gt;ReleasePrimitiveArrayCritical(result, arr, 0);
1604 
1605     return result;
1606 }
1607 
1608 JNIEXPORT void JNICALL Java_com_sun_webkit_WebPage_twkSetTransparent
1609 (JNIEnv* env, jobject self, jlong pFrame, jboolean isTransparent)
1610 {
1611     Frame* frame = static_cast&lt;Frame*&gt;(jlong_to_ptr(pFrame));
1612     if (!frame || !frame-&gt;view()) {
1613         return;
1614     }
1615     frame-&gt;view()-&gt;setTransparent(isTransparent);
1616 }
1617 
1618 JNIEXPORT void JNICALL Java_com_sun_webkit_WebPage_twkSetBackgroundColor
1619 (JNIEnv* env, jobject self, jlong pFrame, jint backgroundColor)
1620 {
1621     Frame* frame = static_cast&lt;Frame*&gt;(jlong_to_ptr(pFrame));
1622     if (!frame || !frame-&gt;view()) {
1623         return;
1624     }
1625     frame-&gt;view()-&gt;setBaseBackgroundColor(Color(RGBA32(backgroundColor)));
1626 }
1627 
1628 JNIEXPORT void JNICALL Java_com_sun_webkit_WebPage_twkPrePaint
1629   (JNIEnv*, jobject, jlong pPage)
1630 {
1631     WebPage::webPageFromJLong(pPage)-&gt;prePaint();
1632 }
1633 
1634 JNIEXPORT void JNICALL Java_com_sun_webkit_WebPage_twkUpdateContent
1635     (JNIEnv* env, jobject self, jlong pPage, jobject rq, jint x, jint y, jint w, jint h)
1636 {
1637     WebPage::webPageFromJLong(pPage)-&gt;paint(rq, x, y, w, h);
1638 }
1639 
1640 JNIEXPORT void JNICALL Java_com_sun_webkit_WebPage_twkPostPaint
1641   (JNIEnv*, jobject, jlong pPage, jobject rq, jint x, jint y, jint w, jint h)
1642 {
1643     WebPage::webPageFromJLong(pPage)-&gt;postPaint(rq, x, y, w, h);
1644 }
1645 
1646 JNIEXPORT jstring JNICALL Java_com_sun_webkit_WebPage_twkGetEncoding
1647     (JNIEnv* env, jobject self, jlong pPage)
1648 {
1649     Page* p = WebPage::pageFromJLong(pPage);
1650     ASSERT(p);
1651     Frame* mainFrame = (Frame*)&amp;p-&gt;mainFrame();
1652     ASSERT(mainFrame);
1653 
1654     return mainFrame-&gt;document()-&gt;charset().toJavaString(env).releaseLocal();
1655 }
1656 
1657 JNIEXPORT void JNICALL Java_com_sun_webkit_WebPage_twkSetEncoding
1658     (JNIEnv* env, jobject self, jlong pPage, jstring encoding)
1659 {
1660     Page* p = WebPage::pageFromJLong(pPage);
1661     ASSERT(p);
1662     Frame* mainFrame = (Frame*)&amp;p-&gt;mainFrame();
1663     ASSERT(mainFrame);
1664 
1665     mainFrame-&gt;loader().reloadWithOverrideEncoding(String(env, encoding));
1666 }
1667 
1668 JNIEXPORT void JNICALL Java_com_sun_webkit_WebPage_twkProcessFocusEvent
1669     (JNIEnv* env, jobject self, jlong pPage,
1670      jint id, jint direction)
1671 {
1672     Page* page = WebPage::pageFromJLong(pPage);
1673     Frame* mainFrame = (Frame*)&amp;page-&gt;mainFrame();
1674 
1675     FocusController&amp; focusController = page-&gt;focusController();
1676 
1677     Frame* focusedFrame = focusController.focusedFrame();
1678     switch (id) {
1679         case com_sun_webkit_event_WCFocusEvent_FOCUS_GAINED:
1680             focusController.setActive(true); // window activation
1681             focusController.setFocused(true); // focus gained
1682             if (!focusedFrame) {
1683                 focusController.setFocusedFrame(mainFrame);
1684                 focusedFrame = mainFrame;
1685             }
1686             if (direction == com_sun_webkit_event_WCFocusEvent_FORWARD) {
1687                 // comment out the following line to get focus to the last
1688                 // focused node instead of the first focusable one
1689                 focusedFrame-&gt;document()-&gt;setFocusedElement(0);
1690                 focusController.advanceFocus(FocusDirectionForward, nullptr);
1691             } else if (direction == com_sun_webkit_event_WCFocusEvent_BACKWARD) {
1692                 // comment out the following line to get focus to the last
1693                 // focused node instead of the last focusable one
1694                 focusedFrame-&gt;document()-&gt;setFocusedElement(0);
1695                 focusController.advanceFocus(FocusDirectionBackward, nullptr);
1696             }
1697             break;
1698         case com_sun_webkit_event_WCFocusEvent_FOCUS_LOST:
1699             focusController.setFocused(false); // focus lost
1700             focusController.setActive(false); // window deactivation
1701             break;
1702     }
1703 }
1704 
1705 JNIEXPORT jboolean JNICALL Java_com_sun_webkit_WebPage_twkProcessKeyEvent
1706     (JNIEnv* env, jobject self, jlong pPage,
1707      jint type, jstring text, jstring keyIdentifier, jint windowsVirtualKeyCode,
1708      jboolean shift, jboolean ctrl, jboolean alt, jboolean meta, jdouble timestamp)
1709 {
1710     WebPage* webPage = WebPage::webPageFromJLong(pPage);
1711 
1712     PlatformKeyboardEvent event(type, text, keyIdentifier,
1713                                 windowsVirtualKeyCode,
1714                                 shift, ctrl, alt, meta, timestamp);
1715 
1716     return bool_to_jbool(webPage-&gt;processKeyEvent(event));
1717 }
1718 
1719 JNIEXPORT jboolean JNICALL Java_com_sun_webkit_WebPage_twkProcessMouseEvent
1720     (JNIEnv* env, jobject self, jlong pPage,
1721      jint id, jint button, jint clickCount,
1722      jint x, jint y, jint screenX, jint screenY,
1723      jboolean shift, jboolean ctrl, jboolean alt, jboolean meta,
1724      jboolean popupTrigger, jdouble timestamp)
1725 {
1726     Page* page = WebPage::pageFromJLong(pPage);
1727     Frame* frame = (Frame*)&amp;page-&gt;mainFrame();
1728 
1729     // Uncomment to debug mouse events
1730     // fprintf(stderr, &quot;twkProcessKeyEvent: &quot;
1731     //         &quot;id=%d button=%d clickCount=%d x=%d y=%d&quot;
1732     //         &quot;screenX=%d screenY=%d \n&quot;,
1733     //         id, button, clickCount, x, y, screenX, screenY);
1734 
1735     EventHandler&amp; eventHandler = frame-&gt;eventHandler();
1736 
1737     FrameView* frameView = frame-&gt;view();
1738     if (!frameView) {
1739         return false;
1740     }
1741 
1742     bool consumeEvent = false;
1743     IntPoint loc(x, y);
1744     PlatformMouseEvent mouseEvent = PlatformMouseEvent(loc,
1745                                                        IntPoint(screenX, screenY),
1746                                                        getWebCoreMouseButton(button),
1747                                                        getWebCoreMouseEventType(id),
1748                                                        clickCount,
1749                                                        shift, ctrl, alt, meta,
1750                                                        WallTime::fromRawSeconds(timestamp), ForceAtClick, NoTap); // TODO-java: handle force?
1751     switch (id) {
1752     case com_sun_webkit_event_WCMouseEvent_MOUSE_PRESSED:
1753         //frame-&gt;focusWindow();
1754         page-&gt;chrome().focus();
1755         consumeEvent = eventHandler.handleMousePressEvent(mouseEvent);
1756         break;
1757     case com_sun_webkit_event_WCMouseEvent_MOUSE_RELEASED:
1758         consumeEvent = eventHandler.handleMouseReleaseEvent(mouseEvent);
1759         break;
1760     case com_sun_webkit_event_WCMouseEvent_MOUSE_MOVED:
1761     case com_sun_webkit_event_WCMouseEvent_MOUSE_DRAGGED:
1762         consumeEvent = eventHandler.mouseMoved(mouseEvent);
1763         break;
1764     }
1765 
1766     if (popupTrigger &amp;&amp; page-&gt;settings().isContextMenuEnabled()) {
1767         ContextMenuController&amp; cmc = page-&gt;contextMenuController();
1768         cmc.clearContextMenu();
1769         bool handleEvent = eventHandler.sendContextMenuEvent(mouseEvent);
1770         if (!handleEvent) {
1771             return consumeEvent;
1772         }
1773 
1774         ContextMenu* contextMenu = cmc.contextMenu();
1775         // right-click in disabled text area (and probably many other
1776         // scenarios) result in nullptr contextMenu here
1777         if (!contextMenu) {
1778             return consumeEvent;
1779         }
1780 
1781         Node* node = cmc.hitTestResult().innerNonSharedNode();
1782         if (!node) {
1783             return consumeEvent;
1784         }
1785 
1786         Frame* frame = node-&gt;document().frame();
1787         // we do not want to show context menu for frameset (see 6648628)
1788         if (frame &amp;&amp; !frame-&gt;document()-&gt;isFrameSet()) {
1789             ContextMenuJava(contextMenu-&gt;items()).show(&amp;cmc, self, loc);
1790         }
1791         return JNI_TRUE;
1792     }
1793 
1794     return bool_to_jbool(consumeEvent);
1795 }
1796 
1797 JNIEXPORT jboolean JNICALL Java_com_sun_webkit_WebPage_twkProcessMouseWheelEvent
1798     (JNIEnv* env, jobject self, jlong pPage,
1799      jint x, jint y, jint screenX, jint screenY,
1800      jfloat deltaX, jfloat deltaY,
1801      jboolean shift, jboolean ctrl, jboolean alt, jboolean meta,
1802      jdouble timestamp)
1803 {
1804     Page* page = WebPage::pageFromJLong(pPage);
1805     Frame* frame = (Frame*)&amp;page-&gt;mainFrame();
1806 
1807     PlatformWheelEvent wheelEvent = PlatformWheelEvent(IntPoint(x, y),
1808                                                        IntPoint(screenX, screenY),
1809                                                        deltaX, deltaY,
1810                                                        shift, ctrl, alt, meta);
1811     bool consumeEvent = frame-&gt;eventHandler().handleWheelEvent(wheelEvent);
1812 
1813     return bool_to_jbool(consumeEvent);
1814 }
1815 
1816 #if ENABLE(TOUCH_EVENTS)
1817 JNIEXPORT jboolean JNICALL Java_com_sun_webkit_WebPage_twkProcessTouchEvent
1818     (JNIEnv* env, jobject self, jlong pPage, jint id, jobject touchData,
1819      jboolean shift, jboolean ctrl, jboolean alt, jboolean meta, jfloat timestamp)
1820 {
1821     Page* page = WebPage::pageFromJLong(pPage);
1822     Frame* frame = page-&gt;mainFrame();
1823 
1824     ASSERT(frame-&gt;eventHandler());
1825     if (!frame-&gt;eventHandler()) {
1826         return JNI_FALSE;
1827     }
1828 
1829     PlatformTouchEvent ev(env, id, touchData, shift, ctrl, alt, meta, timestamp);
1830     bool consumeEvent = frame-&gt;eventHandler().handleTouchEvent(ev);
1831     return bool_to_jbool(consumeEvent);
1832 }
1833 #endif
1834 
1835 JNIEXPORT jboolean JNICALL Java_com_sun_webkit_WebPage_twkProcessInputTextChange
1836     (JNIEnv* env, jobject self, jlong pPage,
1837      jstring jcommitted, jstring jcomposed, jintArray jattributes, jint caretPosition)
1838 {
1839     Page* page = WebPage::pageFromJLong(pPage);
1840 
1841     Frame* frame = (Frame*)&amp;page-&gt;focusController().focusedOrMainFrame();
1842     ASSERT(frame);
1843 
1844     if (!frame || !frame-&gt;editor().canEdit()) {
1845         // There&#39;s no client to deliver the event. Consume the event
1846         // so that it won&#39;t be delivered to a wrong webkit client.
1847         return JNI_TRUE;
1848     }
1849 
1850     // Process committed text first
1851     if (env-&gt;GetStringLength(jcommitted) &gt; 0 ||
1852             // if both committed and composed are empty, confirm with an empty text
1853             (env-&gt;GetStringLength(jcomposed) == 0)) {
1854         String committed = String(env, jcommitted);
1855         frame-&gt;editor().confirmComposition(committed);
1856     }
1857 
1858     // Process composed (composition) text here
1859     if (env-&gt;GetStringLength(jcomposed) &gt; 0) {
1860         jsize length = env-&gt;GetArrayLength(jattributes);
1861         Vector&lt;CompositionUnderline&gt; underlines;
1862         underlines.resize(length / 3); // 3 members per element
1863         jint* attrs = env-&gt;GetIntArrayElements(jattributes, nullptr);
1864         if (attrs) {
1865             for (int i = 0; i &lt; length;) {
1866                 int x = i / 3;
1867                 underlines[x].startOffset = attrs[i++];
1868                 underlines[x].endOffset = attrs[i++];
1869                 underlines[x].thick = (attrs[i++] == 1);
1870                 underlines[x].color = Color(0, 0, 0);
1871             }
1872             env-&gt;ReleaseIntArrayElements(jattributes, attrs, JNI_ABORT);
1873         }
1874         String composed = String(env, jcomposed);
1875         frame-&gt;editor().setComposition(composed, underlines, caretPosition, 0);
1876     }
1877     return JNI_TRUE;
1878 }
1879 
1880 JNIEXPORT jboolean JNICALL Java_com_sun_webkit_WebPage_twkProcessCaretPositionChange
1881     (JNIEnv* env, jobject self, jlong pPage,
1882      jint caretPosition)
1883 {
1884     Page* page = WebPage::pageFromJLong(pPage);
1885 
1886     Frame* frame = (Frame*)&amp;page-&gt;focusController().focusedOrMainFrame();
1887 
1888     ASSERT(frame);
1889 
1890     Text* text = frame-&gt;editor().compositionNode();
1891     if (!text) {
1892         return JNI_FALSE;
1893     }
1894 
1895     // FIXME: the following code may not work with having committed text
1896     Position position(text, caretPosition);
1897     VisibleSelection selection(position, DOWNSTREAM);
1898     frame-&gt;selection().setSelection(selection /*, default is CharacterGranularity*/);//true, false, false
1899     return JNI_TRUE;
1900 }
1901 
1902 JNIEXPORT jintArray JNICALL Java_com_sun_webkit_WebPage_twkGetTextLocation
1903     (JNIEnv* env, jobject self, jlong pPage, jint charindex)
1904 {
1905     Page* page = WebPage::pageFromJLong(pPage);
1906     Frame&amp; frame = page-&gt;mainFrame();
1907 
1908     jintArray result = env-&gt;NewIntArray(4);
1909     WTF::CheckAndClearException(env); // OOME
1910 
1911     FrameView* frameView = frame.view();
1912     if (frameView) {
1913         IntRect caret = frame.selection().absoluteCaretBounds();
1914         caret = frameView-&gt;contentsToWindow(caret);
1915         jint* ints = (jint*) env-&gt;GetPrimitiveArrayCritical(result, nullptr);
1916         ints[0] = caret.x();
1917         ints[1] = caret.y();
1918         ints[2] = caret.width();
1919         ints[3] = caret.height();
1920         env-&gt;ReleasePrimitiveArrayCritical(result, ints, JNI_ABORT);
1921     }
1922 
1923     return result;
1924 }
1925 
1926 JNIEXPORT jint JNICALL Java_com_sun_webkit_WebPage_twkGetLocationOffset
1927     (JNIEnv* env, jobject self, jlong pPage, jint x, jint y)
1928 {
1929     // Returns -1 if there&#39;s no composition text or the given
1930     // coordinate is out of the composition text range.
1931 
1932     Page* page = WebPage::pageFromJLong(pPage);
1933     Frame* frame = (Frame*)&amp;page-&gt;mainFrame();
1934 
1935     FrameView* frameView = frame-&gt;view();
1936     if (!frameView) {
1937         return 0;
1938     }
1939 
1940     jint offset = -1;
1941     IntPoint point {x, y};
1942     point = frameView-&gt;windowToContents(point);
1943 
1944     Editor &amp;editor = frame-&gt;editor();
1945     if (editor.hasComposition()) {
1946         RefPtr&lt;Range&gt; range = editor.compositionRange();
1947         for (Node* node = &amp;range-&gt;startContainer(); node; node = NodeTraversal::next(*node)) {
1948             RenderObject* renderer = node-&gt;renderer();
1949             IntRect content = renderer-&gt;absoluteBoundingBoxRect();
1950             VisiblePosition targetPosition(renderer-&gt;positionForPoint(LayoutPoint(point.x() - content.x(),
1951                                                                             point.y() - content.y()), nullptr)); // TODO-java: recheck nullptr
1952             offset = targetPosition.deepEquivalent().offsetInContainerNode();
1953             if (offset &gt;= (jint)editor.compositionStart() &amp;&amp; offset &lt; (jint)editor.compositionEnd()) {
1954                 offset -= editor.compositionStart();
1955                 break;
1956             }
1957         }
1958     }
1959     return offset;
1960 }
1961 
1962 JNIEXPORT jint JNICALL Java_com_sun_webkit_WebPage_twkGetInsertPositionOffset
1963     (JNIEnv *env, jobject self, jlong pPage)
1964 {
1965     Page* page = WebPage::pageFromJLong(pPage);
1966     Frame* frame = (Frame*)&amp;page-&gt;mainFrame();
1967 
1968     jint position = 0;
1969     Editor &amp;editor = frame-&gt;editor();
1970     if (editor.canEdit()) {
1971         VisibleSelection selection = frame-&gt;selection().selection();
1972         if (selection.isCaret()) {
1973             VisiblePosition caret = selection.visibleStart();
1974             position = caret.deepEquivalent().offsetInContainerNode();
1975             if (editor.hasComposition()) {
1976                 int start = editor.compositionStart();
1977                 int end = editor.compositionEnd();
1978                 if (start &lt; position &amp;&amp; position &lt;= end) {
1979                     position = start;
1980                 } else if (position &gt; end) {
1981                     position -= end - start;
1982                 }
1983             }
1984         }
1985     }
1986     return position;
1987 }
1988 
1989 JNIEXPORT jint JNICALL Java_com_sun_webkit_WebPage_twkGetCommittedTextLength
1990     (JNIEnv *env, jobject self, jlong pPage)
1991 {
1992     Page* page = WebPage::pageFromJLong(pPage);
1993     Frame* frame = (Frame*)&amp;page-&gt;mainFrame();
1994 
1995     jint length = 0;
1996     Editor &amp;editor = frame-&gt;editor();
1997     if (editor.canEdit()) {
1998         RefPtr&lt;Range&gt; range = rangeOfContents(*(Node*)frame-&gt;selection().selection().start().element());
1999         // Code derived from Range::toString
2000         Node* pastLast = range.get()-&gt;pastLastNode();
2001         for (Node* n = range.get()-&gt;firstNode(); n != pastLast; n = NodeTraversal::next(*n)) {
2002             if (n-&gt;nodeType() == Node::TEXT_NODE || n-&gt;nodeType() == Node::CDATA_SECTION_NODE) {
2003                 length += static_cast&lt;CharacterData*&gt;(n)-&gt;data().length();
2004             }
2005         }
2006         // Exclude the composition part if any
2007         if (editor.hasComposition()) {
2008             int start = editor.compositionStart();
2009             int end = editor.compositionEnd();
2010             length -= end - start;
2011         }
2012     }
2013     return length;
2014 }
2015 
2016 JNIEXPORT jstring JNICALL Java_com_sun_webkit_WebPage_twkGetCommittedText
2017     (JNIEnv *env, jobject self, jlong pPage)
2018 {
2019     Page* page = WebPage::pageFromJLong(pPage);
2020     Frame* frame = (Frame*)&amp;page-&gt;mainFrame();
2021 
2022     jstring text = 0;
2023 
2024     Editor &amp;editor = frame-&gt;editor();
2025     if (editor.canEdit()) {
2026         RefPtr&lt;Range&gt; range = rangeOfContents(*(Node*)frame-&gt;selection().selection().start().element());
2027         if (range) {
2028             String t = plainText(range.get());
2029             // Exclude the composition text if any
2030             if (editor.hasComposition()) {
2031                 String s;
2032                 int start = editor.compositionStart();
2033                 int end = editor.compositionEnd();
2034                 unsigned int length = t.length() - (end - start);
2035                 if (start &gt; 0) {
2036                     s = t.substring(0, start);
2037                 }
2038                 if (s.length() == length) {
2039                     t = s;
2040                 } else {
2041                     t = s + t.substring(end, length - start);
2042                 }
2043             }
2044             text = t.toJavaString(env).releaseLocal();
2045             WTF::CheckAndClearException(env); // OOME
2046         }
2047     }
2048     return text;
2049 }
2050 
2051 JNIEXPORT jstring JNICALL Java_com_sun_webkit_WebPage_twkGetSelectedText
2052     (JNIEnv *env, jobject self, jlong pPage)
2053 {
2054     Page* page = WebPage::pageFromJLong(pPage);
2055     Frame* frame = (Frame*)&amp;page-&gt;mainFrame();
2056 
2057     jstring text = 0;
2058 
2059     String t = frame-&gt;editor().selectedText();
2060     text = t.toJavaString(env).releaseLocal();
2061     WTF::CheckAndClearException(env); // OOME
2062 
2063     return text;
2064 }
2065 
2066 //java.awt.dnd.DConstants
2067 enum JAVA_DND_ACTION {
2068     ACTION_NONE = 0x0,
2069     ACTION_COPY = 0x1,
2070     ACTION_MOVE = 0x2,
2071     ACTION_LINK = 0x40000000
2072 };
2073 
2074 static jint dragOperationToDragCursor(DragOperation op) {
2075     unsigned int res = ACTION_NONE;
2076     if (op &amp; DragOperationCopy)
2077         res = ACTION_COPY;
2078     else if (op &amp; DragOperationLink)
2079         res = ACTION_LINK;
2080     else if (op &amp; DragOperationMove)
2081         res = ACTION_MOVE;
2082     else if (op &amp; DragOperationGeneric)
2083         res = ACTION_MOVE; //This appears to be the Firefox behaviour
2084     return res;
2085 }
2086 
2087 static DragOperation keyStateToDragOperation(jint javaAction) {
2088     unsigned int action = DragOperationNone;
2089     if(javaAction &amp; ACTION_COPY)
2090         action = DragOperationCopy;
2091     else if(javaAction &amp; ACTION_LINK)
2092         action = DragOperationLink;
2093     else if(javaAction &amp; ACTION_MOVE)
2094         action = DragOperationMove;
2095     return static_cast&lt;DragOperation&gt;(action);
2096 }
2097 
2098 JNIEXPORT jint JNICALL Java_com_sun_webkit_WebPage_twkProcessDrag
2099 (JNIEnv* env,
2100  jobject self,
2101  jlong pPage,
2102  jint actionId,
2103  jobjectArray jMimes, jobjectArray jValues,
2104  jint x, jint y,
2105  jint screenX, jint screenY,
2106  jint javaAction) {
2107     if (jMimes) {
2108         //TRAGET
2109         RefPtr&lt;DataObjectJava&gt; pr = DataObjectJava::create();
2110         jint n = env-&gt;GetArrayLength(jMimes);
2111         for( jint j=0; j&lt;n; ++j ){
2112             jstring value = (jstring)env-&gt;GetObjectArrayElement(jValues, j);
2113             if(value){
2114                 pr-&gt;setData(
2115                     String(env, JLString((jstring)env-&gt;GetObjectArrayElement(jMimes, j))),
2116                     String(env, JLString(value)));
2117             }
2118         }
2119         DragData dragData(
2120             pr.get(),
2121             IntPoint(x, y),
2122             IntPoint(screenX, screenY),
2123             keyStateToDragOperation(javaAction));
2124         DragController&amp; dc = WebPage::pageFromJLong(pPage)-&gt;dragController();
2125 
2126         setCopyKeyState(ACTION_COPY == javaAction);
2127         switch(actionId){
2128         case com_sun_webkit_WebPage_DND_DST_EXIT:
2129             dc.dragExited(dragData);
2130             return 0;
2131         case com_sun_webkit_WebPage_DND_DST_ENTER:
2132             return dragOperationToDragCursor(dc.dragEntered(dragData));
2133         case com_sun_webkit_WebPage_DND_DST_OVER:
2134         case com_sun_webkit_WebPage_DND_DST_CHANGE:
2135             return dragOperationToDragCursor(dc.dragUpdated(dragData));
2136         case com_sun_webkit_WebPage_DND_DST_DROP:
2137             {
2138                 int ret = dc.performDragOperation(dragData) ? 1 : 0;
2139                 WebPage::pageFromJLong(pPage)-&gt;dragController().dragEnded();
2140                 return ret;
2141             }
2142         }
2143     } else {
2144         //SOURCE
2145         EventHandler&amp; eventHandler =
2146                 WebPage::pageFromJLong(pPage)-&gt;mainFrame().eventHandler();
2147         PlatformMouseEvent mouseEvent = PlatformMouseEvent(
2148             IntPoint(x, y),
2149             IntPoint(screenX, screenY),
2150             com_sun_webkit_WebPage_DND_SRC_DROP!=actionId
2151                 ? LeftButton
2152                 : NoButton,
2153             PlatformEvent::MouseMoved,
2154             0,
2155             false, false, false, false, WallTime {}, ForceAtClick, NoTap); // TODO-java: handle force?
2156         switch(actionId){
2157         case com_sun_webkit_WebPage_DND_SRC_EXIT:
2158         case com_sun_webkit_WebPage_DND_SRC_ENTER:
2159         case com_sun_webkit_WebPage_DND_SRC_OVER:
2160         case com_sun_webkit_WebPage_DND_SRC_CHANGE:
2161 //            The method has been removed. See the changeset #de77cc97972d for the details.
2162 //            eventHandler-&gt;dragSourceMovedTo(mouseEvent);
2163             break;
2164         case com_sun_webkit_WebPage_DND_SRC_DROP:
2165             eventHandler.dragSourceEndedAt(mouseEvent, keyStateToDragOperation(javaAction));
2166             break;
2167         }
2168     }
2169     return 0;
2170 }
2171 
2172 static Editor* getEditor(Page* page) {
2173     ASSERT(page);
2174     Frame&amp; frame = page-&gt;focusController().focusedOrMainFrame();
2175     return &amp;frame.editor();
2176 }
2177 
2178 JNIEXPORT jboolean JNICALL Java_com_sun_webkit_WebPage_twkExecuteCommand
2179     (JNIEnv* env, jobject self, jlong pPage, jstring command, jstring value)
2180 {
2181     Page* page = WebPage::pageFromJLong(pPage);
2182     ASSERT(page);
2183     Editor* editor = getEditor(page);
2184     if (!editor) {
2185         return JNI_FALSE;
2186     }
2187     Editor::Command cmd = editor-&gt;command(String(env, command));
2188     return bool_to_jbool(cmd.execute(value ? String(env, value) : String()));
2189 }
2190 
2191 JNIEXPORT jboolean JNICALL Java_com_sun_webkit_WebPage_twkQueryCommandEnabled
2192     (JNIEnv* env, jobject self, jlong pPage, jstring command)
2193 {
2194     Page* page = WebPage::pageFromJLong(pPage);
2195     ASSERT(page);
2196     Editor* editor = getEditor(page);
2197     if (!editor) {
2198         return JNI_FALSE;
2199     }
2200     Editor::Command cmd = editor-&gt;command(String(env, command));
2201     return bool_to_jbool(cmd.isEnabled());
2202 }
2203 
2204 JNIEXPORT jboolean JNICALL Java_com_sun_webkit_WebPage_twkQueryCommandState
2205     (JNIEnv* env, jobject self, jlong pPage, jstring command)
2206 {
2207     Page* page = WebPage::pageFromJLong(pPage);
2208     ASSERT(page);
2209     Editor* editor = getEditor(page);
2210     if (!editor) {
2211         return JNI_FALSE;
2212     }
2213     Editor::Command cmd = editor-&gt;command(String(env, command));
2214     return bool_to_jbool(cmd.state() == TrueTriState);
2215 }
2216 
2217 JNIEXPORT jstring JNICALL Java_com_sun_webkit_WebPage_twkQueryCommandValue
2218     (JNIEnv* env, jobject self, jlong pPage, jstring command)
2219 {
2220     Page* page = WebPage::pageFromJLong(pPage);
2221     ASSERT(page);
2222     Editor* editor = getEditor(page);
2223     if (!editor) {
2224         return nullptr;
2225     }
2226     Editor::Command cmd = editor-&gt;command(String(env, command));
2227     return cmd.value().toJavaString(env).releaseLocal();
2228 }
2229 
2230 JNIEXPORT jboolean JNICALL Java_com_sun_webkit_WebPage_twkIsEditable
2231     (JNIEnv* env, jobject self, jlong pPage)
2232 {
2233     Page* page = WebPage::pageFromJLong(pPage);
2234     ASSERT(page);
2235     if (!page) {
2236         return JNI_FALSE;
2237     }
2238     return bool_to_jbool(page-&gt;isEditable());
2239 }
2240 
2241 JNIEXPORT void JNICALL Java_com_sun_webkit_WebPage_twkSetEditable
2242     (JNIEnv* env, jobject self, jlong pPage, jboolean editable)
2243 {
2244     Page* page = WebPage::pageFromJLong(pPage);
2245     ASSERT(page);
2246     if (!page) {
2247         return;
2248     }
2249     page-&gt;setEditable(jbool_to_bool(editable));
2250 }
2251 
2252 JNIEXPORT jstring JNICALL Java_com_sun_webkit_WebPage_twkGetHtml
2253     (JNIEnv* env, jobject self, jlong pFrame)
2254 {
2255     Frame* frame = static_cast&lt;Frame*&gt;(jlong_to_ptr(pFrame));
2256     if (!frame) {
2257         return 0;
2258     }
2259 
2260     Document* document = frame-&gt;document();
2261     if (!document || !document-&gt;isHTMLDocument()) {
2262         return 0;
2263     }
2264 
2265     HTMLElement* documentElement =
2266             static_cast&lt;HTMLElement*&gt;(document-&gt;documentElement());
2267     if (!documentElement) {
2268         return 0;
2269     }
2270 
2271     return documentElement-&gt;outerHTML().toJavaString(env).releaseLocal();
2272 }
2273 
2274 JNIEXPORT jboolean JNICALL Java_com_sun_webkit_WebPage_twkGetUsePageCache
2275     (JNIEnv*, jobject, jlong pPage)
2276 {
2277     ASSERT(pPage);
2278     Page* page = WebPage::pageFromJLong(pPage);
2279     ASSERT(page);
2280     return bool_to_jbool(page-&gt;settings().usesPageCache());
2281 }
2282 
2283 JNIEXPORT void JNICALL Java_com_sun_webkit_WebPage_twkSetUsePageCache
2284     (JNIEnv*, jobject, jlong pPage, jboolean usePageCache)
2285 {
2286     ASSERT(pPage);
2287     Page* page = WebPage::pageFromJLong(pPage);
2288     ASSERT(page);
2289     page-&gt;settings().setUsesPageCache(jbool_to_bool(usePageCache));
2290 }
2291 
2292 JNIEXPORT jboolean JNICALL Java_com_sun_webkit_WebPage_twkIsJavaScriptEnabled
2293     (JNIEnv*, jobject, jlong pPage)
2294 {
2295     ASSERT(pPage);
2296     Page* page = WebPage::pageFromJLong(pPage);
2297     ASSERT(page);
2298     return bool_to_jbool(page-&gt;mainFrame().script().canExecuteScripts(NotAboutToExecuteScript));
2299 }
2300 
2301 JNIEXPORT void JNICALL Java_com_sun_webkit_WebPage_twkSetJavaScriptEnabled
2302     (JNIEnv*, jobject, jlong pPage, jboolean enable)
2303 {
2304     ASSERT(pPage);
2305     Page* page = WebPage::pageFromJLong(pPage);
2306     ASSERT(page);
2307     page-&gt;settings().setScriptEnabled(jbool_to_bool(enable));
2308 }
2309 
2310 JNIEXPORT jboolean JNICALL Java_com_sun_webkit_WebPage_twkIsContextMenuEnabled
2311     (JNIEnv*, jobject, jlong pPage)
2312 {
2313     ASSERT(pPage);
2314     Page* page = WebPage::pageFromJLong(pPage);
2315     ASSERT(page);
2316     return bool_to_jbool(page-&gt;settings().isContextMenuEnabled());
2317 }
2318 
2319 JNIEXPORT void JNICALL Java_com_sun_webkit_WebPage_twkSetContextMenuEnabled
2320     (JNIEnv*, jobject, jlong pPage, jboolean enable)
2321 {
2322     ASSERT(pPage);
2323     Page* page = WebPage::pageFromJLong(pPage);
2324     ASSERT(page);
2325     page-&gt;settings().setContextMenuEnabled(jbool_to_bool(enable));
2326 }
2327 
2328 JNIEXPORT void JNICALL Java_com_sun_webkit_WebPage_twkSetUserStyleSheetLocation
2329     (JNIEnv* env, jobject, jlong pPage, jstring url)
2330 {
2331     ASSERT(pPage);
2332     Page* page = WebPage::pageFromJLong(pPage);
2333     ASSERT(page);
2334     page-&gt;settings().setUserStyleSheetLocation(URL(URL(), String(env, url)));
2335 }
2336 
2337 JNIEXPORT jstring JNICALL Java_com_sun_webkit_WebPage_twkGetUserAgent
2338     (JNIEnv* env, jobject, jlong pPage)
2339 {
2340     ASSERT(pPage);
2341     Page* page = WebPage::pageFromJLong(pPage);
2342     ASSERT(page);
2343     return page-&gt;settings().userAgent().toJavaString(env).releaseLocal();
2344 }
2345 
2346 JNIEXPORT void JNICALL Java_com_sun_webkit_WebPage_twkSetUserAgent
2347     (JNIEnv* env, jobject, jlong pPage, jstring userAgent)
2348 {
2349     ASSERT(pPage);
2350     Page* page = WebPage::pageFromJLong(pPage);
2351     ASSERT(page);
2352     page-&gt;settings().setUserAgent(String(env, userAgent));
2353 }
2354 
2355 JNIEXPORT void JNICALL Java_com_sun_webkit_WebPage_twkSetLocalStorageDatabasePath
2356   (JNIEnv* env, jobject, jlong pPage, jstring path)
2357 {
2358     ASSERT(pPage);
2359     Page* page = WebPage::pageFromJLong(pPage);
2360     ASSERT(page);
2361     Settings&amp; settings = page-&gt;settings();
2362     settings.setLocalStorageDatabasePath(String(env, path));
2363     static_cast&lt;WebStorageNamespaceProviderJava*&gt;(
2364       &amp;page-&gt;storageNamespaceProvider())
2365         -&gt;setLocalStorageDatabasePath(settings.localStorageDatabasePath());
2366 }
2367 
2368 JNIEXPORT void JNICALL Java_com_sun_webkit_WebPage_twkSetLocalStorageEnabled
2369   (JNIEnv*, jobject, jlong pPage, jboolean enabled)
2370 {
2371     ASSERT(pPage);
2372     Page* page = WebPage::pageFromJLong(pPage);
2373     ASSERT(page);
2374     Settings&amp; settings = page-&gt;settings();
2375     settings.setLocalStorageEnabled(jbool_to_bool(enabled));
2376 }
2377 
2378 JNIEXPORT jboolean JNICALL Java_com_sun_webkit_WebPage_twkGetDeveloperExtrasEnabled
2379   (JNIEnv *, jobject, jlong pPage)
2380 {
2381     ASSERT(pPage);
2382     Page* page = WebPage::pageFromJLong(pPage);
2383     ASSERT(page);
2384     return bool_to_jbool(page-&gt;settings().developerExtrasEnabled());
2385 }
2386 
2387 JNIEXPORT void JNICALL Java_com_sun_webkit_WebPage_twkSetDeveloperExtrasEnabled
2388   (JNIEnv *, jobject, jlong pPage, jboolean enabled)
2389 {
2390     ASSERT(pPage);
2391     Page* page = WebPage::pageFromJLong(pPage);
2392     ASSERT(page);
2393     page-&gt;settings().setDeveloperExtrasEnabled(jbool_to_bool(enabled));
2394 }
2395 
2396 JNIEXPORT jint JNICALL Java_com_sun_webkit_WebPage_twkGetUnloadEventListenersCount
2397     (JNIEnv*, jobject, jlong pFrame)
2398 {
2399     ASSERT(pFrame);
2400     Frame* frame = static_cast&lt;Frame*&gt;(jlong_to_ptr(pFrame));
2401     ASSERT(frame);
2402     return (jint)frame-&gt;document()-&gt;domWindow()-&gt;pendingUnloadEventListeners();
2403 }
2404 
2405 JNIEXPORT void JNICALL Java_com_sun_webkit_WebPage_twkConnectInspectorFrontend
2406   (JNIEnv *, jobject, jlong pPage)
2407 {
2408     Page *page = WebPage::pageFromJLong(pPage);
2409     if (page) {
2410         InspectorController&amp; ic = page-&gt;inspectorController();
2411         InspectorClientJava* icj = static_cast&lt;InspectorClientJava*&gt;(ic.inspectorClient());
2412         if (icj) {
2413             ic.connectFrontend(*icj, false);
2414         }
2415 
2416     }
2417     WebPage::webPageFromJLong(pPage)-&gt;debugStarted();
2418 }
2419 
2420 JNIEXPORT void JNICALL Java_com_sun_webkit_WebPage_twkDisconnectInspectorFrontend
2421   (JNIEnv *, jobject, jlong pPage)
2422 {
2423     Page* page = WebPage::pageFromJLong(pPage);
2424     if (!page) {
2425         return;
2426     }
2427 
2428     InspectorController&amp; ic = page-&gt;inspectorController();
2429     InspectorClientJava* icj = static_cast&lt;InspectorClientJava*&gt;(ic.inspectorClient());
2430     if (icj) {
2431         ic.disconnectFrontend(*icj);
2432     }
2433 
2434     WebPage::webPageFromJLong(pPage)-&gt;debugEnded();
2435 }
2436 
2437 JNIEXPORT void JNICALL Java_com_sun_webkit_WebPage_twkDispatchInspectorMessageFromFrontend
2438   (JNIEnv* env, jobject, jlong pPage, jstring message)
2439 {
2440     Page* page = WebPage::pageFromJLong(pPage);
2441     if (!page) {
2442         return;
2443     }
2444     //utatodo: seems that RT-21428 will back again
2445     //JSDOMWindowBase::commonVM()-&gt;timeoutChecker.reset(); // RT-21428
2446     page-&gt;inspectorController().dispatchMessageFromFrontend(
2447             String(env, message));
2448 }
2449 
2450 JNIEXPORT jint JNICALL Java_com_sun_webkit_WebPage_twkWorkerThreadCount
2451   (JNIEnv* env, jclass)
2452 {
2453     return WorkerThread::workerThreadCount();
2454 }
2455 
2456 JNIEXPORT void JNICALL Java_com_sun_webkit_WebPage_twkDoJSCGarbageCollection
2457   (JNIEnv*, jclass)
2458 {
2459     GCController::singleton().garbageCollectNow();
2460 }
2461 
2462 }
<a name="10" id="anc10"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="10" type="hidden" />
</body>
</html>