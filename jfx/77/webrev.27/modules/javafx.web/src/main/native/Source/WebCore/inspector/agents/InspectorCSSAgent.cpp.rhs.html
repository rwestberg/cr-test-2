<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames modules/javafx.web/src/main/native/Source/WebCore/inspector/agents/InspectorCSSAgent.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>   1 /*
   2  * Copyright (C) 2010 Google Inc. All rights reserved.
   3  * Copyright (C) 2015-2017 Apple Inc. All rights reserved.
   4  *
   5  * Redistribution and use in source and binary forms, with or without
   6  * modification, are permitted provided that the following conditions
   7  * are met:
   8  * 1.  Redistributions of source code must retain the above copyright
   9  *     notice, this list of conditions and the following disclaimer.
  10  * 2.  Redistributions in binary form must reproduce the above copyright
  11  *     notice, this list of conditions and the following disclaimer in the
  12  *     documentation and/or other materials provided with the distribution.
  13  *
  14  * THIS SOFTWARE IS PROVIDED BY APPLE INC. AND ITS CONTRIBUTORS ``AS IS&#39;&#39; AND ANY
  15  * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
  16  * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
  17  * DISCLAIMED. IN NO EVENT SHALL APPLE INC. OR ITS CONTRIBUTORS BE LIABLE FOR ANY
  18  * DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
  19  * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
  20  * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON
  21  * ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
  22  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
  23  * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
  24  */
  25 
  26 #include &quot;config.h&quot;
  27 #include &quot;InspectorCSSAgent.h&quot;
  28 
  29 #include &quot;CSSComputedStyleDeclaration.h&quot;
  30 #include &quot;CSSImportRule.h&quot;
  31 #include &quot;CSSParserFastPaths.h&quot;
  32 #include &quot;CSSParserMode.h&quot;
  33 #include &quot;CSSPropertyNames.h&quot;
  34 #include &quot;CSSPropertySourceData.h&quot;
  35 #include &quot;CSSRule.h&quot;
  36 #include &quot;CSSRuleList.h&quot;
  37 #include &quot;CSSStyleRule.h&quot;
  38 #include &quot;CSSStyleSheet.h&quot;
  39 #include &quot;CSSValueKeywords.h&quot;
  40 #include &quot;ContentSecurityPolicy.h&quot;
  41 #include &quot;DOMWindow.h&quot;
  42 #include &quot;FontCache.h&quot;
  43 #include &quot;Frame.h&quot;
  44 #include &quot;HTMLHeadElement.h&quot;
  45 #include &quot;HTMLStyleElement.h&quot;
<a name="1" id="anc1"></a><span class="line-added">  46 #include &quot;InspectorDOMAgent.h&quot;</span>
  47 #include &quot;InspectorHistory.h&quot;
  48 #include &quot;InspectorPageAgent.h&quot;
  49 #include &quot;InstrumentingAgents.h&quot;
  50 #include &quot;Node.h&quot;
  51 #include &quot;NodeList.h&quot;
  52 #include &quot;PseudoElement.h&quot;
<a name="2" id="anc2"></a><span class="line-added">  53 #include &quot;RenderStyleConstants.h&quot;</span>
  54 #include &quot;SVGStyleElement.h&quot;
  55 #include &quot;SelectorChecker.h&quot;
  56 #include &quot;ShadowRoot.h&quot;
  57 #include &quot;StyleProperties.h&quot;
  58 #include &quot;StylePropertyShorthand.h&quot;
  59 #include &quot;StyleResolver.h&quot;
  60 #include &quot;StyleRule.h&quot;
  61 #include &quot;StyleScope.h&quot;
  62 #include &quot;StyleSheetList.h&quot;
  63 #include &lt;JavaScriptCore/InspectorProtocolObjects.h&gt;
<a name="3" id="anc3"></a><span class="line-added">  64 #include &lt;wtf/Optional.h&gt;</span>
  65 #include &lt;wtf/Ref.h&gt;
  66 #include &lt;wtf/Vector.h&gt;
  67 #include &lt;wtf/text/CString.h&gt;
  68 #include &lt;wtf/text/StringConcatenateNumbers.h&gt;
  69 
  70 namespace WebCore {
  71 
  72 using namespace Inspector;
  73 
  74 enum ForcePseudoClassFlags {
  75     PseudoClassNone = 0,
  76     PseudoClassHover = 1 &lt;&lt; 0,
  77     PseudoClassFocus = 1 &lt;&lt; 1,
  78     PseudoClassActive = 1 &lt;&lt; 2,
  79     PseudoClassVisited = 1 &lt;&lt; 3
  80 };
  81 
  82 static unsigned computePseudoClassMask(const JSON::Array&amp; pseudoClassArray)
  83 {
  84     static NeverDestroyed&lt;String&gt; active(MAKE_STATIC_STRING_IMPL(&quot;active&quot;));
  85     static NeverDestroyed&lt;String&gt; hover(MAKE_STATIC_STRING_IMPL(&quot;hover&quot;));
  86     static NeverDestroyed&lt;String&gt; focus(MAKE_STATIC_STRING_IMPL(&quot;focus&quot;));
  87     static NeverDestroyed&lt;String&gt; visited(MAKE_STATIC_STRING_IMPL(&quot;visited&quot;));
  88     if (!pseudoClassArray.length())
  89         return PseudoClassNone;
  90 
  91     unsigned result = PseudoClassNone;
  92     for (auto&amp; pseudoClassValue : pseudoClassArray) {
  93         String pseudoClass;
  94         bool success = pseudoClassValue-&gt;asString(pseudoClass);
  95         if (!success)
  96             continue;
  97         if (pseudoClass == active)
  98             result |= PseudoClassActive;
  99         else if (pseudoClass == hover)
 100             result |= PseudoClassHover;
 101         else if (pseudoClass == focus)
 102             result |= PseudoClassFocus;
 103         else if (pseudoClass == visited)
 104             result |= PseudoClassVisited;
 105     }
 106 
 107     return result;
 108 }
 109 
 110 class InspectorCSSAgent::StyleSheetAction : public InspectorHistory::Action {
 111     WTF_MAKE_NONCOPYABLE(StyleSheetAction);
 112 public:
 113     StyleSheetAction(InspectorStyleSheet* styleSheet)
 114         : InspectorHistory::Action()
 115         , m_styleSheet(styleSheet)
 116     {
 117     }
 118 
 119 protected:
 120     RefPtr&lt;InspectorStyleSheet&gt; m_styleSheet;
 121 };
 122 
 123 class InspectorCSSAgent::SetStyleSheetTextAction final : public InspectorCSSAgent::StyleSheetAction {
 124     WTF_MAKE_NONCOPYABLE(SetStyleSheetTextAction);
 125 public:
 126     SetStyleSheetTextAction(InspectorStyleSheet* styleSheet, const String&amp; text)
 127         : InspectorCSSAgent::StyleSheetAction(styleSheet)
 128         , m_text(text)
 129     {
 130     }
 131 
 132 private:
 133     ExceptionOr&lt;void&gt; perform() final
 134     {
 135         auto result = m_styleSheet-&gt;text();
 136         if (result.hasException())
 137             return result.releaseException();
 138         m_oldText = result.releaseReturnValue();
 139         return redo();
 140     }
 141 
 142     ExceptionOr&lt;void&gt; undo() final
 143     {
 144         auto result = m_styleSheet-&gt;setText(m_oldText);
 145         if (result.hasException())
 146             return result.releaseException();
 147         m_styleSheet-&gt;reparseStyleSheet(m_oldText);
 148         return { };
 149     }
 150 
 151     ExceptionOr&lt;void&gt; redo() final
 152     {
 153         auto result = m_styleSheet-&gt;setText(m_text);
 154         if (result.hasException())
 155             return result.releaseException();
 156         m_styleSheet-&gt;reparseStyleSheet(m_text);
 157         return { };
 158     }
 159 
 160     String mergeId() final
 161     {
 162         return &quot;SetStyleSheetText &quot; + m_styleSheet-&gt;id();
 163     }
 164 
 165     void merge(std::unique_ptr&lt;Action&gt; action) override
 166     {
 167         ASSERT(action-&gt;mergeId() == mergeId());
 168         m_text = static_cast&lt;SetStyleSheetTextAction&amp;&gt;(*action).m_text;
 169     }
 170 
 171     String m_text;
 172     String m_oldText;
 173 };
 174 
 175 class InspectorCSSAgent::SetStyleTextAction final : public InspectorCSSAgent::StyleSheetAction {
 176     WTF_MAKE_NONCOPYABLE(SetStyleTextAction);
 177 public:
 178     SetStyleTextAction(InspectorStyleSheet* styleSheet, const InspectorCSSId&amp; cssId, const String&amp; text)
 179         : InspectorCSSAgent::StyleSheetAction(styleSheet)
 180         , m_cssId(cssId)
 181         , m_text(text)
 182     {
 183     }
 184 
 185     ExceptionOr&lt;void&gt; perform() override
 186     {
 187         return redo();
 188     }
 189 
 190     ExceptionOr&lt;void&gt; undo() override
 191     {
 192         return m_styleSheet-&gt;setStyleText(m_cssId, m_oldText, nullptr);
 193     }
 194 
 195     ExceptionOr&lt;void&gt; redo() override
 196     {
 197         return m_styleSheet-&gt;setStyleText(m_cssId, m_text, &amp;m_oldText);
 198     }
 199 
 200     String mergeId() override
 201     {
 202         ASSERT(m_styleSheet-&gt;id() == m_cssId.styleSheetId());
 203         return makeString(&quot;SetStyleText &quot;, m_styleSheet-&gt;id(), &#39;:&#39;, m_cssId.ordinal());
 204     }
 205 
 206     void merge(std::unique_ptr&lt;Action&gt; action) override
 207     {
 208         ASSERT(action-&gt;mergeId() == mergeId());
 209 
 210         SetStyleTextAction* other = static_cast&lt;SetStyleTextAction*&gt;(action.get());
 211         m_text = other-&gt;m_text;
 212     }
 213 
 214 private:
 215     InspectorCSSId m_cssId;
 216     String m_text;
 217     String m_oldText;
 218 };
 219 
 220 class InspectorCSSAgent::SetRuleSelectorAction final : public InspectorCSSAgent::StyleSheetAction {
 221     WTF_MAKE_NONCOPYABLE(SetRuleSelectorAction);
 222 public:
 223     SetRuleSelectorAction(InspectorStyleSheet* styleSheet, const InspectorCSSId&amp; cssId, const String&amp; selector)
 224         : InspectorCSSAgent::StyleSheetAction(styleSheet)
 225         , m_cssId(cssId)
 226         , m_selector(selector)
 227     {
 228     }
 229 
 230 private:
 231     ExceptionOr&lt;void&gt; perform() final
 232     {
 233         auto result = m_styleSheet-&gt;ruleSelector(m_cssId);
 234         if (result.hasException())
 235             return result.releaseException();
 236         m_oldSelector = result.releaseReturnValue();
 237         return redo();
 238     }
 239 
 240     ExceptionOr&lt;void&gt; undo() final
 241     {
 242         return m_styleSheet-&gt;setRuleSelector(m_cssId, m_oldSelector);
 243     }
 244 
 245     ExceptionOr&lt;void&gt; redo() final
 246     {
 247         return m_styleSheet-&gt;setRuleSelector(m_cssId, m_selector);
 248     }
 249 
 250     InspectorCSSId m_cssId;
 251     String m_selector;
 252     String m_oldSelector;
 253 };
 254 
 255 class InspectorCSSAgent::AddRuleAction final : public InspectorCSSAgent::StyleSheetAction {
 256     WTF_MAKE_NONCOPYABLE(AddRuleAction);
 257 public:
 258     AddRuleAction(InspectorStyleSheet* styleSheet, const String&amp; selector)
 259         : InspectorCSSAgent::StyleSheetAction(styleSheet)
 260         , m_selector(selector)
 261     {
 262     }
 263 
 264     InspectorCSSId newRuleId() const { return m_newId; }
 265 
 266 private:
 267     ExceptionOr&lt;void&gt; perform() final
 268     {
 269         return redo();
 270     }
 271 
 272     ExceptionOr&lt;void&gt; undo() final
 273     {
 274         return m_styleSheet-&gt;deleteRule(m_newId);
 275     }
 276 
 277     ExceptionOr&lt;void&gt; redo() final
 278     {
 279         auto result = m_styleSheet-&gt;addRule(m_selector);
 280         if (result.hasException())
 281             return result.releaseException();
 282         m_newId = m_styleSheet-&gt;ruleId(result.releaseReturnValue());
 283         return { };
 284     }
 285 
 286     InspectorCSSId m_newId;
 287     String m_selector;
 288     String m_oldSelector;
 289 };
 290 
 291 CSSStyleRule* InspectorCSSAgent::asCSSStyleRule(CSSRule&amp; rule)
 292 {
 293     if (!is&lt;CSSStyleRule&gt;(rule))
 294         return nullptr;
 295     return downcast&lt;CSSStyleRule&gt;(&amp;rule);
 296 }
 297 
<a name="4" id="anc4"></a><span class="line-modified"> 298 InspectorCSSAgent::InspectorCSSAgent(WebAgentContext&amp; context)</span>
 299     : InspectorAgentBase(&quot;CSS&quot;_s, context)
<a name="5" id="anc5"></a><span class="line-modified"> 300     , m_frontendDispatcher(makeUnique&lt;CSSFrontendDispatcher&gt;(context.frontendRouter))</span>
 301     , m_backendDispatcher(CSSBackendDispatcher::create(context.backendDispatcher, this))
<a name="6" id="anc6"></a>
 302 {
<a name="7" id="anc7"></a>
 303 }
 304 
<a name="8" id="anc8"></a><span class="line-modified"> 305 InspectorCSSAgent::~InspectorCSSAgent() = default;</span>




 306 
 307 void InspectorCSSAgent::didCreateFrontendAndBackend(Inspector::FrontendRouter*, Inspector::BackendDispatcher*)
 308 {
 309 }
 310 
 311 void InspectorCSSAgent::willDestroyFrontendAndBackend(Inspector::DisconnectReason)
 312 {
<a name="9" id="anc9"></a>

 313     String unused;
 314     disable(unused);
 315 }
 316 
<a name="10" id="anc10"></a>





 317 void InspectorCSSAgent::reset()
 318 {
 319     // FIXME: Should we be resetting on main frame navigations?
 320     m_idToInspectorStyleSheet.clear();
 321     m_cssStyleSheetToInspectorStyleSheet.clear();
 322     m_nodeToInspectorStyleSheet.clear();
 323     m_documentToInspectorStyleSheet.clear();
 324     m_documentToKnownCSSStyleSheets.clear();
<a name="11" id="anc11"></a>




 325     resetPseudoStates();
 326 }
 327 
 328 void InspectorCSSAgent::enable(ErrorString&amp;)
 329 {
<a name="12" id="anc12"></a><span class="line-added"> 330     if (m_instrumentingAgents.inspectorCSSAgent() == this)</span>
<span class="line-added"> 331         return;</span>
<span class="line-added"> 332 </span>
 333     m_instrumentingAgents.setInspectorCSSAgent(this);
 334 
<a name="13" id="anc13"></a><span class="line-modified"> 335     if (auto* domAgent = m_instrumentingAgents.inspectorDOMAgent()) {</span>
<span class="line-modified"> 336         for (auto* document : domAgent-&gt;documents())</span>
<span class="line-added"> 337             activeStyleSheetsUpdated(*document);</span>
<span class="line-added"> 338     }</span>
 339 }
 340 
 341 void InspectorCSSAgent::disable(ErrorString&amp;)
 342 {
 343     m_instrumentingAgents.setInspectorCSSAgent(nullptr);
<a name="14" id="anc14"></a><span class="line-added"> 344 </span>
<span class="line-added"> 345     reset();</span>
 346 }
 347 
 348 void InspectorCSSAgent::documentDetached(Document&amp; document)
 349 {
 350     Vector&lt;CSSStyleSheet*&gt; emptyList;
 351     setActiveStyleSheetsForDocument(document, emptyList);
 352 
 353     m_documentToKnownCSSStyleSheets.remove(&amp;document);
 354     m_documentToInspectorStyleSheet.remove(&amp;document);
 355     m_documentsWithForcedPseudoStates.remove(&amp;document);
 356 }
 357 
 358 void InspectorCSSAgent::mediaQueryResultChanged()
 359 {
 360     m_frontendDispatcher-&gt;mediaQueryResultChanged();
 361 }
 362 
 363 void InspectorCSSAgent::activeStyleSheetsUpdated(Document&amp; document)
 364 {
 365     Vector&lt;CSSStyleSheet*&gt; cssStyleSheets;
 366     collectAllDocumentStyleSheets(document, cssStyleSheets);
 367 
 368     setActiveStyleSheetsForDocument(document, cssStyleSheets);
 369 }
 370 
 371 void InspectorCSSAgent::setActiveStyleSheetsForDocument(Document&amp; document, Vector&lt;CSSStyleSheet*&gt;&amp; activeStyleSheets)
 372 {
 373     HashSet&lt;CSSStyleSheet*&gt;&amp; previouslyKnownActiveStyleSheets = m_documentToKnownCSSStyleSheets.add(&amp;document, HashSet&lt;CSSStyleSheet*&gt;()).iterator-&gt;value;
 374 
 375     HashSet&lt;CSSStyleSheet*&gt; removedStyleSheets(previouslyKnownActiveStyleSheets);
 376     Vector&lt;CSSStyleSheet*&gt; addedStyleSheets;
 377     for (auto&amp; activeStyleSheet : activeStyleSheets) {
 378         if (removedStyleSheets.contains(activeStyleSheet))
 379             removedStyleSheets.remove(activeStyleSheet);
 380         else
 381             addedStyleSheets.append(activeStyleSheet);
 382     }
 383 
 384     for (auto* cssStyleSheet : removedStyleSheets) {
 385         previouslyKnownActiveStyleSheets.remove(cssStyleSheet);
 386         RefPtr&lt;InspectorStyleSheet&gt; inspectorStyleSheet = m_cssStyleSheetToInspectorStyleSheet.get(cssStyleSheet);
 387         if (m_idToInspectorStyleSheet.contains(inspectorStyleSheet-&gt;id())) {
 388             String id = unbindStyleSheet(inspectorStyleSheet.get());
 389             m_frontendDispatcher-&gt;styleSheetRemoved(id);
 390         }
 391     }
 392 
 393     for (auto* cssStyleSheet : addedStyleSheets) {
 394         previouslyKnownActiveStyleSheets.add(cssStyleSheet);
 395         if (!m_cssStyleSheetToInspectorStyleSheet.contains(cssStyleSheet)) {
 396             InspectorStyleSheet* inspectorStyleSheet = bindStyleSheet(cssStyleSheet);
 397             m_frontendDispatcher-&gt;styleSheetAdded(inspectorStyleSheet-&gt;buildObjectForStyleSheetInfo());
 398         }
 399     }
 400 }
 401 
 402 bool InspectorCSSAgent::forcePseudoState(const Element&amp; element, CSSSelector::PseudoClassType pseudoClassType)
 403 {
 404     if (m_nodeIdToForcedPseudoState.isEmpty())
 405         return false;
 406 
<a name="15" id="anc15"></a><span class="line-modified"> 407     auto* domAgent = m_instrumentingAgents.inspectorDOMAgent();</span>
<span class="line-added"> 408     if (!domAgent)</span>
<span class="line-added"> 409         return false;</span>
<span class="line-added"> 410 </span>
<span class="line-added"> 411     int nodeId = domAgent-&gt;boundNodeId(&amp;element);</span>
 412     if (!nodeId)
 413         return false;
 414 
 415     unsigned forcedPseudoState = m_nodeIdToForcedPseudoState.get(nodeId);
 416     switch (pseudoClassType) {
 417     case CSSSelector::PseudoClassActive:
 418         return forcedPseudoState &amp; PseudoClassActive;
 419     case CSSSelector::PseudoClassFocus:
 420         return forcedPseudoState &amp; PseudoClassFocus;
 421     case CSSSelector::PseudoClassHover:
 422         return forcedPseudoState &amp; PseudoClassHover;
 423     case CSSSelector::PseudoClassVisited:
 424         return forcedPseudoState &amp; PseudoClassVisited;
 425     default:
 426         return false;
 427     }
 428 }
 429 
<a name="16" id="anc16"></a><span class="line-added"> 430 static Optional&lt;Inspector::Protocol::CSS::PseudoId&gt; protocolValueForPseudoId(PseudoId pseudoId)</span>
<span class="line-added"> 431 {</span>
<span class="line-added"> 432     switch (pseudoId) {</span>
<span class="line-added"> 433     case PseudoId::FirstLine:</span>
<span class="line-added"> 434         return Inspector::Protocol::CSS::PseudoId::FirstLine;</span>
<span class="line-added"> 435     case PseudoId::FirstLetter:</span>
<span class="line-added"> 436         return Inspector::Protocol::CSS::PseudoId::FirstLetter;</span>
<span class="line-added"> 437     case PseudoId::Marker:</span>
<span class="line-added"> 438         return Inspector::Protocol::CSS::PseudoId::Marker;</span>
<span class="line-added"> 439     case PseudoId::Before:</span>
<span class="line-added"> 440         return Inspector::Protocol::CSS::PseudoId::Before;</span>
<span class="line-added"> 441     case PseudoId::After:</span>
<span class="line-added"> 442         return Inspector::Protocol::CSS::PseudoId::After;</span>
<span class="line-added"> 443     case PseudoId::Selection:</span>
<span class="line-added"> 444         return Inspector::Protocol::CSS::PseudoId::Selection;</span>
<span class="line-added"> 445     case PseudoId::Scrollbar:</span>
<span class="line-added"> 446         return Inspector::Protocol::CSS::PseudoId::Scrollbar;</span>
<span class="line-added"> 447     case PseudoId::ScrollbarThumb:</span>
<span class="line-added"> 448         return Inspector::Protocol::CSS::PseudoId::ScrollbarThumb;</span>
<span class="line-added"> 449     case PseudoId::ScrollbarButton:</span>
<span class="line-added"> 450         return Inspector::Protocol::CSS::PseudoId::ScrollbarButton;</span>
<span class="line-added"> 451     case PseudoId::ScrollbarTrack:</span>
<span class="line-added"> 452         return Inspector::Protocol::CSS::PseudoId::ScrollbarTrack;</span>
<span class="line-added"> 453     case PseudoId::ScrollbarTrackPiece:</span>
<span class="line-added"> 454         return Inspector::Protocol::CSS::PseudoId::ScrollbarTrackPiece;</span>
<span class="line-added"> 455     case PseudoId::ScrollbarCorner:</span>
<span class="line-added"> 456         return Inspector::Protocol::CSS::PseudoId::ScrollbarCorner;</span>
<span class="line-added"> 457     case PseudoId::Resizer:</span>
<span class="line-added"> 458         return Inspector::Protocol::CSS::PseudoId::Resizer;</span>
<span class="line-added"> 459 </span>
<span class="line-added"> 460     default:</span>
<span class="line-added"> 461         ASSERT_NOT_REACHED();</span>
<span class="line-added"> 462         return { };</span>
<span class="line-added"> 463     }</span>
<span class="line-added"> 464 }</span>
<span class="line-added"> 465 </span>
 466 void InspectorCSSAgent::getMatchedStylesForNode(ErrorString&amp; errorString, int nodeId, const bool* includePseudo, const bool* includeInherited, RefPtr&lt;JSON::ArrayOf&lt;Inspector::Protocol::CSS::RuleMatch&gt;&gt;&amp; matchedCSSRules, RefPtr&lt;JSON::ArrayOf&lt;Inspector::Protocol::CSS::PseudoIdMatches&gt;&gt;&amp; pseudoIdMatches, RefPtr&lt;JSON::ArrayOf&lt;Inspector::Protocol::CSS::InheritedStyleEntry&gt;&gt;&amp; inheritedEntries)
 467 {
 468     Element* element = elementForId(errorString, nodeId);
 469     if (!element)
 470         return;
 471 
 472     Element* originalElement = element;
 473     PseudoId elementPseudoId = element-&gt;pseudoId();
 474     if (elementPseudoId != PseudoId::None) {
 475         element = downcast&lt;PseudoElement&gt;(*element).hostElement();
 476         if (!element) {
<a name="17" id="anc17"></a><span class="line-modified"> 477             errorString = &quot;Missing parent of pseudo-element node for given nodeId&quot;_s;</span>
 478             return;
 479         }
 480     }
 481 
 482     // Matched rules.
 483     StyleResolver&amp; styleResolver = element-&gt;styleResolver();
 484     auto matchedRules = styleResolver.pseudoStyleRulesForElement(element, elementPseudoId, StyleResolver::AllCSSRules);
 485     matchedCSSRules = buildArrayForMatchedRuleList(matchedRules, styleResolver, *element, elementPseudoId);
 486 
 487     if (!originalElement-&gt;isPseudoElement()) {
 488         // Pseudo elements.
 489         if (!includePseudo || *includePseudo) {
 490             auto pseudoElements = JSON::ArrayOf&lt;Inspector::Protocol::CSS::PseudoIdMatches&gt;::create();
 491             for (PseudoId pseudoId = PseudoId::FirstPublicPseudoId; pseudoId &lt; PseudoId::AfterLastInternalPseudoId; pseudoId = static_cast&lt;PseudoId&gt;(static_cast&lt;unsigned&gt;(pseudoId) + 1)) {
<a name="18" id="anc18"></a><span class="line-modified"> 492                 if (auto protocolPseudoId = protocolValueForPseudoId(pseudoId)) {</span>
<span class="line-modified"> 493                     auto matchedRules = styleResolver.pseudoStyleRulesForElement(element, pseudoId, StyleResolver::AllCSSRules);</span>
<span class="line-modified"> 494                     if (!matchedRules.isEmpty()) {</span>
<span class="line-modified"> 495                         auto matches = Inspector::Protocol::CSS::PseudoIdMatches::create()</span>
<span class="line-modified"> 496                             .setPseudoId(protocolPseudoId.value())</span>
<span class="line-modified"> 497                             .setMatches(buildArrayForMatchedRuleList(matchedRules, styleResolver, *element, pseudoId))</span>
<span class="line-modified"> 498                             .release();</span>
<span class="line-added"> 499                         pseudoElements-&gt;addItem(WTFMove(matches));</span>
<span class="line-added"> 500                     }</span>
 501                 }
 502             }
 503 
 504             pseudoIdMatches = WTFMove(pseudoElements);
 505         }
 506 
 507         // Inherited styles.
 508         if (!includeInherited || *includeInherited) {
 509             auto entries = JSON::ArrayOf&lt;Inspector::Protocol::CSS::InheritedStyleEntry&gt;::create();
 510             Element* parentElement = element-&gt;parentElement();
 511             while (parentElement) {
 512                 StyleResolver&amp; parentStyleResolver = parentElement-&gt;styleResolver();
 513                 auto parentMatchedRules = parentStyleResolver.styleRulesForElement(parentElement, StyleResolver::AllCSSRules);
 514                 auto entry = Inspector::Protocol::CSS::InheritedStyleEntry::create()
 515                     .setMatchedCSSRules(buildArrayForMatchedRuleList(parentMatchedRules, styleResolver, *parentElement, PseudoId::None))
 516                     .release();
 517                 if (is&lt;StyledElement&gt;(*parentElement) &amp;&amp; downcast&lt;StyledElement&gt;(*parentElement).cssomStyle().length()) {
 518                     auto&amp; styleSheet = asInspectorStyleSheet(downcast&lt;StyledElement&gt;(*parentElement));
 519                     entry-&gt;setInlineStyle(styleSheet.buildObjectForStyle(styleSheet.styleForId(InspectorCSSId(styleSheet.id(), 0))));
 520                 }
 521 
 522                 entries-&gt;addItem(WTFMove(entry));
 523                 parentElement = parentElement-&gt;parentElement();
 524             }
 525 
 526             inheritedEntries = WTFMove(entries);
 527         }
 528     }
 529 }
 530 
 531 void InspectorCSSAgent::getInlineStylesForNode(ErrorString&amp; errorString, int nodeId, RefPtr&lt;Inspector::Protocol::CSS::CSSStyle&gt;&amp; inlineStyle, RefPtr&lt;Inspector::Protocol::CSS::CSSStyle&gt;&amp; attributesStyle)
 532 {
 533     auto* element = elementForId(errorString, nodeId);
 534     if (!is&lt;StyledElement&gt;(element))
 535         return;
 536 
 537     auto&amp; styledElement = downcast&lt;StyledElement&gt;(*element);
 538     auto&amp; styleSheet = asInspectorStyleSheet(styledElement);
 539     inlineStyle = styleSheet.buildObjectForStyle(&amp;styledElement.cssomStyle());
 540     if (auto attributes = buildObjectForAttributesStyle(styledElement))
 541         attributesStyle = WTFMove(attributes);
 542     else
 543         attributesStyle = nullptr;
 544 }
 545 
 546 void InspectorCSSAgent::getComputedStyleForNode(ErrorString&amp; errorString, int nodeId, RefPtr&lt;JSON::ArrayOf&lt;Inspector::Protocol::CSS::CSSComputedStyleProperty&gt;&gt;&amp; style)
 547 {
 548     auto* element = elementForId(errorString, nodeId);
 549     if (!element)
 550         return;
 551 
 552     auto computedStyleInfo = CSSComputedStyleDeclaration::create(*element, true);
 553     auto inspectorStyle = InspectorStyle::create(InspectorCSSId(), WTFMove(computedStyleInfo), nullptr);
 554     style = inspectorStyle-&gt;buildArrayForComputedStyle();
 555 }
 556 
 557 void InspectorCSSAgent::getAllStyleSheets(ErrorString&amp;, RefPtr&lt;JSON::ArrayOf&lt;Inspector::Protocol::CSS::CSSStyleSheetHeader&gt;&gt;&amp; styleInfos)
 558 {
 559     styleInfos = JSON::ArrayOf&lt;Inspector::Protocol::CSS::CSSStyleSheetHeader&gt;::create();
 560 
 561     Vector&lt;InspectorStyleSheet*&gt; inspectorStyleSheets;
 562     collectAllStyleSheets(inspectorStyleSheets);
 563     for (auto* inspectorStyleSheet : inspectorStyleSheets)
 564         styleInfos-&gt;addItem(inspectorStyleSheet-&gt;buildObjectForStyleSheetInfo());
 565 }
 566 
 567 void InspectorCSSAgent::collectAllStyleSheets(Vector&lt;InspectorStyleSheet*&gt;&amp; result)
 568 {
 569     Vector&lt;CSSStyleSheet*&gt; cssStyleSheets;
<a name="19" id="anc19"></a><span class="line-modified"> 570     if (auto* domAgent = m_instrumentingAgents.inspectorDOMAgent()) {</span>
<span class="line-modified"> 571         for (auto* document : domAgent-&gt;documents())</span>
<span class="line-added"> 572             collectAllDocumentStyleSheets(*document, cssStyleSheets);</span>
<span class="line-added"> 573     }</span>
 574 
 575     for (auto* cssStyleSheet : cssStyleSheets)
 576         result.append(bindStyleSheet(cssStyleSheet));
 577 }
 578 
 579 void InspectorCSSAgent::collectAllDocumentStyleSheets(Document&amp; document, Vector&lt;CSSStyleSheet*&gt;&amp; result)
 580 {
 581     auto cssStyleSheets = document.styleScope().activeStyleSheetsForInspector();
 582     for (auto&amp; cssStyleSheet : cssStyleSheets)
 583         collectStyleSheets(cssStyleSheet.get(), result);
 584 }
 585 
 586 void InspectorCSSAgent::collectStyleSheets(CSSStyleSheet* styleSheet, Vector&lt;CSSStyleSheet*&gt;&amp; result)
 587 {
 588     result.append(styleSheet);
 589 
 590     for (unsigned i = 0, size = styleSheet-&gt;length(); i &lt; size; ++i) {
 591         CSSRule* rule = styleSheet-&gt;item(i);
 592         if (is&lt;CSSImportRule&gt;(*rule)) {
 593             if (CSSStyleSheet* importedStyleSheet = downcast&lt;CSSImportRule&gt;(*rule).styleSheet())
 594                 collectStyleSheets(importedStyleSheet, result);
 595         }
 596     }
 597 }
 598 
 599 void InspectorCSSAgent::getStyleSheet(ErrorString&amp; errorString, const String&amp; styleSheetId, RefPtr&lt;Inspector::Protocol::CSS::CSSStyleSheetBody&gt;&amp; styleSheetObject)
 600 {
 601     InspectorStyleSheet* inspectorStyleSheet = assertStyleSheetForId(errorString, styleSheetId);
 602     if (!inspectorStyleSheet)
 603         return;
 604 
 605     styleSheetObject = inspectorStyleSheet-&gt;buildObjectForStyleSheet();
 606 }
 607 
 608 void InspectorCSSAgent::getStyleSheetText(ErrorString&amp; errorString, const String&amp; styleSheetId, String* result)
 609 {
 610     InspectorStyleSheet* inspectorStyleSheet = assertStyleSheetForId(errorString, styleSheetId);
 611     if (!inspectorStyleSheet)
 612         return;
 613 
 614     auto text = inspectorStyleSheet-&gt;text();
 615     if (!text.hasException())
 616         *result = text.releaseReturnValue();
 617 }
 618 
 619 void InspectorCSSAgent::setStyleSheetText(ErrorString&amp; errorString, const String&amp; styleSheetId, const String&amp; text)
 620 {
 621     InspectorStyleSheet* inspectorStyleSheet = assertStyleSheetForId(errorString, styleSheetId);
 622     if (!inspectorStyleSheet)
 623         return;
 624 
<a name="20" id="anc20"></a><span class="line-modified"> 625     auto* domAgent = m_instrumentingAgents.inspectorDOMAgent();</span>
<span class="line-added"> 626     if (!domAgent) {</span>
<span class="line-added"> 627         errorString = &quot;DOM domain must be enabled&quot;_s;</span>
<span class="line-added"> 628         return;</span>
<span class="line-added"> 629     }</span>
<span class="line-added"> 630 </span>
<span class="line-added"> 631     auto result = domAgent-&gt;history()-&gt;perform(makeUnique&lt;SetStyleSheetTextAction&gt;(inspectorStyleSheet, text));</span>
 632     if (result.hasException())
 633         errorString = InspectorDOMAgent::toErrorString(result.releaseException());
 634 }
 635 
 636 void InspectorCSSAgent::setStyleText(ErrorString&amp; errorString, const JSON::Object&amp; fullStyleId, const String&amp; text, RefPtr&lt;Inspector::Protocol::CSS::CSSStyle&gt;&amp; result)
 637 {
 638     InspectorCSSId compoundId(fullStyleId);
 639     ASSERT(!compoundId.isEmpty());
 640 
 641     InspectorStyleSheet* inspectorStyleSheet = assertStyleSheetForId(errorString, compoundId.styleSheetId());
 642     if (!inspectorStyleSheet)
 643         return;
 644 
<a name="21" id="anc21"></a><span class="line-modified"> 645     auto* domAgent = m_instrumentingAgents.inspectorDOMAgent();</span>
<span class="line-added"> 646     if (!domAgent) {</span>
<span class="line-added"> 647         errorString = &quot;DOM domain must be enabled&quot;_s;</span>
<span class="line-added"> 648         return;</span>
<span class="line-added"> 649     }</span>
<span class="line-added"> 650 </span>
<span class="line-added"> 651     auto performResult = domAgent-&gt;history()-&gt;perform(makeUnique&lt;SetStyleTextAction&gt;(inspectorStyleSheet, compoundId, text));</span>
 652     if (performResult.hasException()) {
 653         errorString = InspectorDOMAgent::toErrorString(performResult.releaseException());
 654         return;
 655     }
 656 
 657     result = inspectorStyleSheet-&gt;buildObjectForStyle(inspectorStyleSheet-&gt;styleForId(compoundId));
 658 }
 659 
 660 void InspectorCSSAgent::setRuleSelector(ErrorString&amp; errorString, const JSON::Object&amp; fullRuleId, const String&amp; selector, RefPtr&lt;Inspector::Protocol::CSS::CSSRule&gt;&amp; result)
 661 {
 662     InspectorCSSId compoundId(fullRuleId);
 663     ASSERT(!compoundId.isEmpty());
 664 
 665     InspectorStyleSheet* inspectorStyleSheet = assertStyleSheetForId(errorString, compoundId.styleSheetId());
 666     if (!inspectorStyleSheet)
 667         return;
 668 
<a name="22" id="anc22"></a><span class="line-modified"> 669     auto* domAgent = m_instrumentingAgents.inspectorDOMAgent();</span>
<span class="line-added"> 670     if (!domAgent) {</span>
<span class="line-added"> 671         errorString = &quot;DOM domain must be enabled&quot;_s;</span>
<span class="line-added"> 672         return;</span>
<span class="line-added"> 673     }</span>
<span class="line-added"> 674 </span>
<span class="line-added"> 675     auto performResult = domAgent-&gt;history()-&gt;perform(makeUnique&lt;SetRuleSelectorAction&gt;(inspectorStyleSheet, compoundId, selector));</span>
 676     if (performResult.hasException()) {
 677         errorString = InspectorDOMAgent::toErrorString(performResult.releaseException());
 678         return;
 679     }
 680 
 681     result = inspectorStyleSheet-&gt;buildObjectForRule(inspectorStyleSheet-&gt;ruleForId(compoundId), nullptr);
 682 }
 683 
 684 void InspectorCSSAgent::createStyleSheet(ErrorString&amp; errorString, const String&amp; frameId, String* styleSheetId)
 685 {
<a name="23" id="anc23"></a><span class="line-modified"> 686     auto* pageAgent = m_instrumentingAgents.inspectorPageAgent();</span>
<span class="line-modified"> 687     if (!pageAgent) {</span>
<span class="line-modified"> 688         errorString = &quot;Page domain must be enabled&quot;_s;</span>
 689         return;
 690     }
 691 
<a name="24" id="anc24"></a><span class="line-added"> 692     auto* frame = pageAgent-&gt;assertFrame(errorString, frameId);</span>
<span class="line-added"> 693     if (!frame)</span>
<span class="line-added"> 694         return;</span>
<span class="line-added"> 695 </span>
 696     Document* document = frame-&gt;document();
 697     if (!document) {
<a name="25" id="anc25"></a><span class="line-modified"> 698         errorString = &quot;Missing document of frame for given frameId&quot;_s;</span>
 699         return;
 700     }
 701 
 702     InspectorStyleSheet* inspectorStyleSheet = createInspectorStyleSheetForDocument(*document);
 703     if (!inspectorStyleSheet) {
<a name="26" id="anc26"></a><span class="line-modified"> 704         errorString = &quot;Could not create style sheet for document of frame for given frameId&quot;_s;</span>
 705         return;
 706     }
 707 
 708     *styleSheetId = inspectorStyleSheet-&gt;id();
 709 }
 710 
 711 InspectorStyleSheet* InspectorCSSAgent::createInspectorStyleSheetForDocument(Document&amp; document)
 712 {
 713     if (!document.isHTMLDocument() &amp;&amp; !document.isSVGDocument())
 714         return nullptr;
 715 
 716     auto styleElement = HTMLStyleElement::create(document);
<a name="27" id="anc27"></a><span class="line-modified"> 717     styleElement-&gt;setAttributeWithoutSynchronization(HTMLNames::typeAttr, AtomString(&quot;text/css&quot;, AtomString::ConstructFromLiteral));</span>
 718 
 719     ContainerNode* targetNode;
 720     // HEAD is absent in ImageDocuments, for example.
 721     if (auto* head = document.head())
 722         targetNode = head;
 723     else if (auto* body = document.bodyOrFrameset())
 724         targetNode = body;
 725     else
 726         return nullptr;
 727 
 728     // Inserting this &lt;style&gt; into the document will trigger activeStyleSheetsUpdated
 729     // and we will create an InspectorStyleSheet for this &lt;style&gt;&#39;s CSSStyleSheet.
 730     // Set this flag, so when we create it, we put it into the via inspector map.
 731     m_creatingViaInspectorStyleSheet = true;
 732     InlineStyleOverrideScope overrideScope(document);
 733     auto appendResult = targetNode-&gt;appendChild(styleElement);
 734     document.styleScope().flushPendingUpdate();
 735     m_creatingViaInspectorStyleSheet = false;
 736     if (appendResult.hasException())
 737         return nullptr;
 738 
 739     auto iterator = m_documentToInspectorStyleSheet.find(&amp;document);
 740     ASSERT(iterator != m_documentToInspectorStyleSheet.end());
 741     if (iterator == m_documentToInspectorStyleSheet.end())
 742         return nullptr;
 743 
 744     auto&amp; inspectorStyleSheetsForDocument = iterator-&gt;value;
 745     ASSERT(!inspectorStyleSheetsForDocument.isEmpty());
 746     if (inspectorStyleSheetsForDocument.isEmpty())
 747         return nullptr;
 748 
 749     return inspectorStyleSheetsForDocument.last().get();
 750 }
 751 
 752 void InspectorCSSAgent::addRule(ErrorString&amp; errorString, const String&amp; styleSheetId, const String&amp; selector, RefPtr&lt;Inspector::Protocol::CSS::CSSRule&gt;&amp; result)
 753 {
 754     InspectorStyleSheet* inspectorStyleSheet = assertStyleSheetForId(errorString, styleSheetId);
<a name="28" id="anc28"></a><span class="line-modified"> 755     if (!inspectorStyleSheet)</span>
<span class="line-modified"> 756         return;</span>
<span class="line-added"> 757 </span>
<span class="line-added"> 758     auto* domAgent = m_instrumentingAgents.inspectorDOMAgent();</span>
<span class="line-added"> 759     if (!domAgent) {</span>
<span class="line-added"> 760         errorString = &quot;DOM domain must be enabled&quot;_s;</span>
 761         return;
 762     }
 763 
<a name="29" id="anc29"></a><span class="line-modified"> 764     auto action = makeUnique&lt;AddRuleAction&gt;(inspectorStyleSheet, selector);</span>
 765     auto&amp; rawAction = *action;
<a name="30" id="anc30"></a><span class="line-modified"> 766     auto performResult = domAgent-&gt;history()-&gt;perform(WTFMove(action));</span>
 767     if (performResult.hasException()) {
 768         errorString = InspectorDOMAgent::toErrorString(performResult.releaseException());
 769         return;
 770     }
 771 
 772     InspectorCSSId ruleId = rawAction.newRuleId();
 773     CSSStyleRule* rule = inspectorStyleSheet-&gt;ruleForId(ruleId);
 774     result = inspectorStyleSheet-&gt;buildObjectForRule(rule, nullptr);
 775 }
 776 
 777 void InspectorCSSAgent::getSupportedCSSProperties(ErrorString&amp;, RefPtr&lt;JSON::ArrayOf&lt;Inspector::Protocol::CSS::CSSPropertyInfo&gt;&gt;&amp; cssProperties)
 778 {
 779     auto properties = JSON::ArrayOf&lt;Inspector::Protocol::CSS::CSSPropertyInfo&gt;::create();
 780     for (int i = firstCSSProperty; i &lt;= lastCSSProperty; ++i) {
 781         CSSPropertyID propertyID = convertToCSSPropertyID(i);
 782         if (isInternalCSSProperty(propertyID) || !isEnabledCSSProperty(propertyID))
 783             continue;
 784 
 785         auto property = Inspector::Protocol::CSS::CSSPropertyInfo::create()
 786             .setName(getPropertyNameString(propertyID))
 787             .release();
 788 
 789         auto aliases = CSSProperty::aliasesForProperty(propertyID);
 790         if (!aliases.isEmpty()) {
 791             auto aliasesArray = JSON::ArrayOf&lt;String&gt;::create();
 792             for (auto&amp; alias : aliases)
 793                 aliasesArray-&gt;addItem(alias);
 794             property-&gt;setAliases(WTFMove(aliasesArray));
 795         }
 796 
 797         const StylePropertyShorthand&amp; shorthand = shorthandForProperty(propertyID);
 798         if (shorthand.length()) {
 799             auto longhands = JSON::ArrayOf&lt;String&gt;::create();
 800             for (unsigned j = 0; j &lt; shorthand.length(); ++j) {
 801                 CSSPropertyID longhandID = shorthand.properties()[j];
 802                 if (isEnabledCSSProperty(longhandID))
 803                     longhands-&gt;addItem(getPropertyNameString(longhandID));
 804             }
 805             property-&gt;setLonghands(WTFMove(longhands));
 806         }
 807 
 808         if (CSSParserFastPaths::isKeywordPropertyID(propertyID)) {
 809             auto values = JSON::ArrayOf&lt;String&gt;::create();
 810             for (int j = firstCSSValueKeyword; j &lt;= lastCSSValueKeyword; ++j) {
 811                 CSSValueID valueID = convertToCSSValueID(j);
<a name="31" id="anc31"></a><span class="line-modified"> 812                 if (CSSParserFastPaths::isValidKeywordPropertyAndValue(propertyID, valueID, strictCSSParserContext()))</span>
 813                     values-&gt;addItem(getValueNameString(valueID));
 814             }
 815             if (values-&gt;length())
 816                 property-&gt;setValues(WTFMove(values));
 817         }
 818 
 819         if (CSSProperty::isInheritedProperty(propertyID))
 820             property-&gt;setInherited(true);
 821 
 822         properties-&gt;addItem(WTFMove(property));
 823     }
 824     cssProperties = WTFMove(properties);
 825 }
 826 
 827 void InspectorCSSAgent::getSupportedSystemFontFamilyNames(ErrorString&amp;, RefPtr&lt;JSON::ArrayOf&lt;String&gt;&gt;&amp; fontFamilyNames)
 828 {
 829     auto families = JSON::ArrayOf&lt;String&gt;::create();
 830 
 831     Vector&lt;String&gt; systemFontFamilies = FontCache::singleton().systemFontFamilies();
 832     for (const auto&amp; familyName : systemFontFamilies)
 833         families-&gt;addItem(familyName);
 834 
 835     fontFamilyNames = WTFMove(families);
 836 }
 837 
 838 void InspectorCSSAgent::forcePseudoState(ErrorString&amp; errorString, int nodeId, const JSON::Array&amp; forcedPseudoClasses)
 839 {
<a name="32" id="anc32"></a><span class="line-modified"> 840     auto* domAgent = m_instrumentingAgents.inspectorDOMAgent();</span>
<span class="line-added"> 841     if (!domAgent) {</span>
<span class="line-added"> 842         errorString = &quot;DOM domain must be enabled&quot;_s;</span>
<span class="line-added"> 843         return;</span>
<span class="line-added"> 844     }</span>
<span class="line-added"> 845 </span>
<span class="line-added"> 846     Element* element = domAgent-&gt;assertElement(errorString, nodeId);</span>
 847     if (!element)
 848         return;
 849 
 850     // Return early if the forced pseudo state was already set correctly.
 851     unsigned forcedPseudoState = computePseudoClassMask(forcedPseudoClasses);
 852     if (forcedPseudoState) {
 853         auto iterator = m_nodeIdToForcedPseudoState.add(nodeId, 0).iterator;
 854         if (forcedPseudoState == iterator-&gt;value)
 855             return;
 856         iterator-&gt;value = forcedPseudoState;
 857         m_documentsWithForcedPseudoStates.add(&amp;element-&gt;document());
 858     } else {
 859         if (!m_nodeIdToForcedPseudoState.remove(nodeId))
 860             return;
 861         if (m_nodeIdToForcedPseudoState.isEmpty())
 862             m_documentsWithForcedPseudoStates.clear();
 863     }
 864 
 865     element-&gt;document().styleScope().didChangeStyleSheetEnvironment();
 866 }
 867 
 868 InspectorStyleSheetForInlineStyle&amp; InspectorCSSAgent::asInspectorStyleSheet(StyledElement&amp; element)
 869 {
 870     return m_nodeToInspectorStyleSheet.ensure(&amp;element, [this, &amp;element] {
 871         String newStyleSheetId = String::number(m_lastStyleSheetId++);
<a name="33" id="anc33"></a><span class="line-modified"> 872         auto inspectorStyleSheet = InspectorStyleSheetForInlineStyle::create(m_instrumentingAgents.inspectorPageAgent(), newStyleSheetId, element, Inspector::Protocol::CSS::StyleSheetOrigin::Regular, this);</span>
 873         m_idToInspectorStyleSheet.set(newStyleSheetId, inspectorStyleSheet.copyRef());
 874         return inspectorStyleSheet;
 875     }).iterator-&gt;value;
 876 }
 877 
 878 Element* InspectorCSSAgent::elementForId(ErrorString&amp; errorString, int nodeId)
 879 {
<a name="34" id="anc34"></a><span class="line-modified"> 880     auto* domAgent = m_instrumentingAgents.inspectorDOMAgent();</span>
<span class="line-modified"> 881     if (!domAgent) {</span>
<span class="line-modified"> 882         errorString = &quot;DOM domain must be enabled&quot;_s;</span>




 883         return nullptr;
 884     }
<a name="35" id="anc35"></a><span class="line-modified"> 885 </span>
<span class="line-added"> 886     return domAgent-&gt;assertElement(errorString, nodeId);</span>
 887 }
 888 
 889 String InspectorCSSAgent::unbindStyleSheet(InspectorStyleSheet* inspectorStyleSheet)
 890 {
 891     String id = inspectorStyleSheet-&gt;id();
 892     m_idToInspectorStyleSheet.remove(id);
 893     if (inspectorStyleSheet-&gt;pageStyleSheet())
 894         m_cssStyleSheetToInspectorStyleSheet.remove(inspectorStyleSheet-&gt;pageStyleSheet());
 895     return id;
 896 }
 897 
 898 InspectorStyleSheet* InspectorCSSAgent::bindStyleSheet(CSSStyleSheet* styleSheet)
 899 {
 900     RefPtr&lt;InspectorStyleSheet&gt; inspectorStyleSheet = m_cssStyleSheetToInspectorStyleSheet.get(styleSheet);
 901     if (!inspectorStyleSheet) {
 902         String id = String::number(m_lastStyleSheetId++);
 903         Document* document = styleSheet-&gt;ownerDocument();
<a name="36" id="anc36"></a><span class="line-modified"> 904         inspectorStyleSheet = InspectorStyleSheet::create(m_instrumentingAgents.inspectorPageAgent(), id, styleSheet, detectOrigin(styleSheet, document), InspectorDOMAgent::documentURLString(document), this);</span>
 905         m_idToInspectorStyleSheet.set(id, inspectorStyleSheet);
 906         m_cssStyleSheetToInspectorStyleSheet.set(styleSheet, inspectorStyleSheet);
 907         if (m_creatingViaInspectorStyleSheet) {
 908             auto&amp; inspectorStyleSheetsForDocument = m_documentToInspectorStyleSheet.add(document, Vector&lt;RefPtr&lt;InspectorStyleSheet&gt;&gt;()).iterator-&gt;value;
 909             inspectorStyleSheetsForDocument.append(inspectorStyleSheet);
 910         }
 911     }
 912     return inspectorStyleSheet.get();
 913 }
 914 
 915 InspectorStyleSheet* InspectorCSSAgent::assertStyleSheetForId(ErrorString&amp; errorString, const String&amp; styleSheetId)
 916 {
 917     IdToInspectorStyleSheet::iterator it = m_idToInspectorStyleSheet.find(styleSheetId);
 918     if (it == m_idToInspectorStyleSheet.end()) {
<a name="37" id="anc37"></a><span class="line-modified"> 919         errorString = &quot;Missing style sheet for given styleSheetId&quot;_s;</span>
 920         return nullptr;
 921     }
 922     return it-&gt;value.get();
 923 }
 924 
 925 Inspector::Protocol::CSS::StyleSheetOrigin InspectorCSSAgent::detectOrigin(CSSStyleSheet* pageStyleSheet, Document* ownerDocument)
 926 {
 927     if (m_creatingViaInspectorStyleSheet)
 928         return Inspector::Protocol::CSS::StyleSheetOrigin::Inspector;
 929 
 930     if (pageStyleSheet &amp;&amp; !pageStyleSheet-&gt;ownerNode() &amp;&amp; pageStyleSheet-&gt;href().isEmpty())
 931         return Inspector::Protocol::CSS::StyleSheetOrigin::UserAgent;
 932 
 933     if (pageStyleSheet &amp;&amp; pageStyleSheet-&gt;ownerNode() &amp;&amp; pageStyleSheet-&gt;ownerNode()-&gt;nodeName() == &quot;#document&quot;)
 934         return Inspector::Protocol::CSS::StyleSheetOrigin::User;
 935 
 936     auto iterator = m_documentToInspectorStyleSheet.find(ownerDocument);
 937     if (iterator != m_documentToInspectorStyleSheet.end()) {
 938         for (auto&amp; inspectorStyleSheet : iterator-&gt;value) {
 939             if (pageStyleSheet == inspectorStyleSheet-&gt;pageStyleSheet())
 940                 return Inspector::Protocol::CSS::StyleSheetOrigin::Inspector;
 941         }
 942     }
 943 
 944     return Inspector::Protocol::CSS::StyleSheetOrigin::Regular;
 945 }
 946 
 947 RefPtr&lt;Inspector::Protocol::CSS::CSSRule&gt; InspectorCSSAgent::buildObjectForRule(StyleRule* styleRule, StyleResolver&amp; styleResolver, Element&amp; element)
 948 {
 949     if (!styleRule)
 950         return nullptr;
 951 
 952     // StyleRules returned by StyleResolver::styleRulesForElement lack parent pointers since that infomation is not cheaply available.
 953     // Since the inspector wants to walk the parent chain, we construct the full wrappers here.
 954     styleResolver.inspectorCSSOMWrappers().collectDocumentWrappers(styleResolver.document().extensionStyleSheets());
 955     styleResolver.inspectorCSSOMWrappers().collectScopeWrappers(Style::Scope::forNode(element));
 956 
 957     // Possiblity of :host styles if this element has a shadow root.
 958     if (ShadowRoot* shadowRoot = element.shadowRoot())
 959         styleResolver.inspectorCSSOMWrappers().collectScopeWrappers(shadowRoot-&gt;styleScope());
 960 
 961     CSSStyleRule* cssomWrapper = styleResolver.inspectorCSSOMWrappers().getWrapperForRuleInSheets(styleRule);
 962     if (!cssomWrapper)
 963         return nullptr;
 964 
 965     InspectorStyleSheet* inspectorStyleSheet = bindStyleSheet(cssomWrapper-&gt;parentStyleSheet());
 966     return inspectorStyleSheet ? inspectorStyleSheet-&gt;buildObjectForRule(cssomWrapper, &amp;element) : nullptr;
 967 }
 968 
 969 RefPtr&lt;Inspector::Protocol::CSS::CSSRule&gt; InspectorCSSAgent::buildObjectForRule(CSSStyleRule* rule)
 970 {
 971     if (!rule)
 972         return nullptr;
 973 
 974     ASSERT(rule-&gt;parentStyleSheet());
 975     InspectorStyleSheet* inspectorStyleSheet = bindStyleSheet(rule-&gt;parentStyleSheet());
 976     return inspectorStyleSheet ? inspectorStyleSheet-&gt;buildObjectForRule(rule, nullptr) : nullptr;
 977 }
 978 
 979 RefPtr&lt;JSON::ArrayOf&lt;Inspector::Protocol::CSS::RuleMatch&gt;&gt; InspectorCSSAgent::buildArrayForMatchedRuleList(const Vector&lt;RefPtr&lt;StyleRule&gt;&gt;&amp; matchedRules, StyleResolver&amp; styleResolver, Element&amp; element, PseudoId pseudoId)
 980 {
 981     auto result = JSON::ArrayOf&lt;Inspector::Protocol::CSS::RuleMatch&gt;::create();
 982 
 983     SelectorChecker::CheckingContext context(SelectorChecker::Mode::CollectingRules);
 984     context.pseudoId = pseudoId != PseudoId::None ? pseudoId : element.pseudoId();
 985     SelectorChecker selectorChecker(element.document());
 986 
 987     for (auto&amp; matchedRule : matchedRules) {
 988         RefPtr&lt;Inspector::Protocol::CSS::CSSRule&gt; ruleObject = buildObjectForRule(matchedRule.get(), styleResolver, element);
 989         if (!ruleObject)
 990             continue;
 991 
 992         auto matchingSelectors = JSON::ArrayOf&lt;int&gt;::create();
 993         const CSSSelectorList&amp; selectorList = matchedRule-&gt;selectorList();
 994         int index = 0;
 995         for (const CSSSelector* selector = selectorList.first(); selector; selector = CSSSelectorList::next(selector)) {
 996             unsigned ignoredSpecificity;
 997             bool matched = selectorChecker.match(*selector, element, context, ignoredSpecificity);
 998             if (matched)
 999                 matchingSelectors-&gt;addItem(index);
1000             ++index;
1001         }
1002 
1003         auto match = Inspector::Protocol::CSS::RuleMatch::create()
1004             .setRule(WTFMove(ruleObject))
1005             .setMatchingSelectors(WTFMove(matchingSelectors))
1006             .release();
1007         result-&gt;addItem(WTFMove(match));
1008     }
1009 
<a name="38" id="anc38"></a><span class="line-modified">1010     return result;</span>
1011 }
1012 
1013 RefPtr&lt;Inspector::Protocol::CSS::CSSStyle&gt; InspectorCSSAgent::buildObjectForAttributesStyle(StyledElement&amp; element)
1014 {
1015     // FIXME: Ugliness below.
1016     auto* attributeStyle = const_cast&lt;StyleProperties*&gt;(element.presentationAttributeStyle());
1017     if (!attributeStyle)
1018         return nullptr;
1019 
1020     auto&amp; mutableAttributeStyle = downcast&lt;MutableStyleProperties&gt;(*attributeStyle);
1021     auto inspectorStyle = InspectorStyle::create(InspectorCSSId(), mutableAttributeStyle.ensureCSSStyleDeclaration(), nullptr);
1022     return inspectorStyle-&gt;buildObjectForStyle();
1023 }
1024 
1025 void InspectorCSSAgent::didRemoveDOMNode(Node&amp; node, int nodeId)
1026 {
1027     m_nodeIdToForcedPseudoState.remove(nodeId);
1028 
1029     auto sheet = m_nodeToInspectorStyleSheet.take(&amp;node);
1030     if (!sheet)
1031         return;
1032     m_idToInspectorStyleSheet.remove(sheet.value()-&gt;id());
1033 }
1034 
1035 void InspectorCSSAgent::didModifyDOMAttr(Element&amp; element)
1036 {
1037     auto sheet = m_nodeToInspectorStyleSheet.get(&amp;element);
1038     if (!sheet)
1039         return;
1040     sheet-&gt;didModifyElementAttribute();
1041 }
1042 
1043 void InspectorCSSAgent::styleSheetChanged(InspectorStyleSheet* styleSheet)
1044 {
1045     m_frontendDispatcher-&gt;styleSheetChanged(styleSheet-&gt;id());
1046 }
1047 
1048 void InspectorCSSAgent::resetPseudoStates()
1049 {
1050     for (auto&amp; document : m_documentsWithForcedPseudoStates)
1051         document-&gt;styleScope().didChangeStyleSheetEnvironment();
1052 
1053     m_nodeIdToForcedPseudoState.clear();
1054     m_documentsWithForcedPseudoStates.clear();
1055 }
1056 
1057 } // namespace WebCore
<a name="39" id="anc39"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="39" type="hidden" />
</body>
</html>