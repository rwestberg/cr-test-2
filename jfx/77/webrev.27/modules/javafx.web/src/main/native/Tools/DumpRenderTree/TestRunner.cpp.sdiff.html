<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff modules/javafx.web/src/main/native/Tools/DumpRenderTree/TestRunner.cpp</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
  </head>
<body>
<center><a href="TestOptions.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="TestRunner.h.sdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Tools/DumpRenderTree/TestRunner.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  36 #include &lt;JavaScriptCore/APICast.h&gt;
  37 #include &lt;JavaScriptCore/ArrayBufferView.h&gt;
  38 #include &lt;JavaScriptCore/HeapInlines.h&gt;
  39 #include &lt;JavaScriptCore/JSArrayBufferView.h&gt;
  40 #include &lt;JavaScriptCore/JSCTestRunnerUtils.h&gt;
  41 #include &lt;JavaScriptCore/JSContextRef.h&gt;
  42 #include &lt;JavaScriptCore/JSObjectRef.h&gt;
  43 #include &lt;JavaScriptCore/JSRetainPtr.h&gt;
  44 #include &lt;JavaScriptCore/TypedArrayInlines.h&gt;
  45 #include &lt;JavaScriptCore/VMInlines.h&gt;
  46 #include &lt;WebCore/LogInitialization.h&gt;
  47 #include &lt;cstring&gt;
  48 #include &lt;locale.h&gt;
  49 #include &lt;stdio.h&gt;
  50 #include &lt;wtf/Assertions.h&gt;
  51 #include &lt;wtf/LoggingAccumulator.h&gt;
  52 #include &lt;wtf/MathExtras.h&gt;
  53 #include &lt;wtf/RefPtr.h&gt;
  54 #include &lt;wtf/RunLoop.h&gt;
  55 #include &lt;wtf/StdLibExtras.h&gt;

  56 #include &lt;wtf/WallTime.h&gt;
  57 #include &lt;wtf/text/WTFString.h&gt;
  58 
  59 #if PLATFORM(IOS_FAMILY)
  60 #include &lt;WebCore/WebCoreThreadRun.h&gt;
  61 #include &lt;wtf/BlockPtr.h&gt;
  62 #endif
  63 
  64 #if PLATFORM(MAC) &amp;&amp; !PLATFORM(IOS_FAMILY)
  65 #include &lt;Carbon/Carbon.h&gt;
  66 #endif
  67 
  68 FILE* testResult = stdout;
  69 
  70 const unsigned TestRunner::viewWidth = 800;
  71 const unsigned TestRunner::viewHeight = 600;
  72 
  73 const unsigned TestRunner::w3cSVGViewWidth = 480;
  74 const unsigned TestRunner::w3cSVGViewHeight = 360;
  75 
  76 TestRunner::TestRunner(const std::string&amp; testURL, const std::string&amp; expectedPixelHash)
<span class="line-modified">  77     : m_disallowIncreaseForApplicationCacheQuota(false)</span>
<span class="line-removed">  78     , m_dumpApplicationCacheDelegateCallbacks(false)</span>
<span class="line-removed">  79     , m_dumpAsAudio(false)</span>
<span class="line-removed">  80     , m_dumpAsPDF(false)</span>
<span class="line-removed">  81     , m_dumpAsText(false)</span>
<span class="line-removed">  82     , m_dumpBackForwardList(false)</span>
<span class="line-removed">  83     , m_dumpChildFrameScrollPositions(false)</span>
<span class="line-removed">  84     , m_dumpChildFramesAsText(false)</span>
<span class="line-removed">  85     , m_dumpDOMAsWebArchive(false)</span>
<span class="line-removed">  86     , m_dumpDatabaseCallbacks(false)</span>
<span class="line-removed">  87     , m_dumpEditingCallbacks(false)</span>
<span class="line-removed">  88     , m_dumpFrameLoadCallbacks(false)</span>
<span class="line-removed">  89     , m_dumpProgressFinishedCallback(false)</span>
<span class="line-removed">  90     , m_dumpUserGestureInFrameLoadCallbacks(false)</span>
<span class="line-removed">  91     , m_dumpHistoryDelegateCallbacks(false)</span>
<span class="line-removed">  92     , m_dumpResourceLoadCallbacks(false)</span>
<span class="line-removed">  93     , m_dumpResourceResponseMIMETypes(false)</span>
<span class="line-removed">  94     , m_dumpSelectionRect(false)</span>
<span class="line-removed">  95     , m_dumpSourceAsWebArchive(false)</span>
<span class="line-removed">  96     , m_dumpStatusCallbacks(false)</span>
<span class="line-removed">  97     , m_dumpTitleChanges(false)</span>
<span class="line-removed">  98     , m_dumpVisitedLinksCallback(false)</span>
<span class="line-removed">  99     , m_dumpWillCacheResponse(false)</span>
<span class="line-removed"> 100     , m_generatePixelResults(true)</span>
<span class="line-removed"> 101     , m_callCloseOnWebViews(true)</span>
<span class="line-removed"> 102     , m_canOpenWindows(false)</span>
<span class="line-removed"> 103     , m_closeRemainingWindowsWhenComplete(true)</span>
<span class="line-removed"> 104     , m_newWindowsCopyBackForwardList(false)</span>
<span class="line-removed"> 105     , m_stopProvisionalFrameLoads(false)</span>
<span class="line-removed"> 106     , m_testOnscreen(false)</span>
<span class="line-removed"> 107     , m_testRepaint(false)</span>
<span class="line-removed"> 108     , m_testRepaintSweepHorizontally(false)</span>
<span class="line-removed"> 109     , m_waitToDump(false)</span>
<span class="line-removed"> 110     , m_willSendRequestReturnsNull(false)</span>
<span class="line-removed"> 111     , m_willSendRequestReturnsNullOnRedirect(false)</span>
<span class="line-removed"> 112     , m_windowIsKey(true)</span>
<span class="line-removed"> 113     , m_alwaysAcceptCookies(false)</span>
<span class="line-removed"> 114     , m_globalFlag(false)</span>
<span class="line-removed"> 115     , m_isGeolocationPermissionSet(false)</span>
<span class="line-removed"> 116     , m_geolocationPermission(false)</span>
<span class="line-removed"> 117     , m_rejectsProtectionSpaceAndContinueForAuthenticationChallenges(false)</span>
<span class="line-removed"> 118     , m_handlesAuthenticationChallenges(false)</span>
<span class="line-removed"> 119     , m_isPrinting(false)</span>
<span class="line-removed"> 120     , m_useDeferredFrameLoading(false)</span>
<span class="line-removed"> 121     , m_shouldPaintBrokenImage(true)</span>
<span class="line-removed"> 122     , m_shouldStayOnPageAfterHandlingBeforeUnload(false)</span>
<span class="line-removed"> 123     , m_areLegacyWebNotificationPermissionRequestsIgnored(false)</span>
<span class="line-removed"> 124     , m_customFullScreenBehavior(false)</span>
<span class="line-removed"> 125     , m_hasPendingWebNotificationClick(false)</span>
<span class="line-removed"> 126     , m_databaseDefaultQuota(-1)</span>
<span class="line-removed"> 127     , m_databaseMaxQuota(-1)</span>
<span class="line-removed"> 128     , m_testURL(testURL)</span>
 129     , m_expectedPixelHash(expectedPixelHash)
 130     , m_titleTextDirection(&quot;ltr&quot;)
<span class="line-removed"> 131     , m_timeout(0)</span>
 132 {
 133 }
 134 
 135 Ref&lt;TestRunner&gt; TestRunner::create(const std::string&amp; testURL, const std::string&amp; expectedPixelHash)
 136 {
 137     return adoptRef(*new TestRunner(testURL, expectedPixelHash));
 138 }
 139 
 140 // Static Functions
 141 
 142 static JSValueRef disallowIncreaseForApplicationCacheQuotaCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 143 {
 144     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 145     controller-&gt;setDisallowIncreaseForApplicationCacheQuota(true);
 146     return JSValueMakeUndefined(context);
 147 }
 148 
 149 static JSValueRef dumpApplicationCacheDelegateCallbacksCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 150 {
 151     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 152     controller-&gt;setDumpApplicationCacheDelegateCallbacks(true);
 153     return JSValueMakeUndefined(context);
 154 }
 155 
 156 static JSValueRef dumpAsPDFCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 157 {
 158     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 159     controller-&gt;setDumpAsPDF(true);
 160     return JSValueMakeUndefined(context);
 161 }
 162 











 163 static JSValueRef dumpAsTextCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 164 {
 165     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 166     controller-&gt;setDumpAsText(true);
 167 
 168     // Optional paramater, describing whether it&#39;s allowed to dump pixel results in dumpAsText mode.
 169     controller-&gt;setGeneratePixelResults(argumentCount &gt; 0 ? JSValueToBoolean(context, arguments[0]) : false);
 170 
 171     return JSValueMakeUndefined(context);
 172 }
 173 
 174 static JSValueRef dumpBackForwardListCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 175 {
 176     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 177     controller-&gt;setDumpBackForwardList(true);
 178     return JSValueMakeUndefined(context);
 179 }
 180 
 181 static JSValueRef dumpChildFramesAsTextCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 182 {
</pre>
<hr />
<pre>
 389     ASSERT(!*exception);
 390 
 391     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 392     controller-&gt;addDisallowedURL(url.get());
 393 
 394     return JSValueMakeUndefined(context);
 395 }
 396 
 397 static JSValueRef addURLToRedirectCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 398 {
 399     if (argumentCount &lt; 2)
 400         return JSValueMakeUndefined(context);
 401 
 402     auto origin = adopt(JSValueToStringCopy(context, arguments[0], exception));
 403     ASSERT(!*exception);
 404 
 405     auto destination = adopt(JSValueToStringCopy(context, arguments[1], exception));
 406     ASSERT(!*exception);
 407 
 408     size_t maxLength = JSStringGetMaximumUTF8CStringSize(origin.get());
<span class="line-modified"> 409     auto originBuffer = std::make_unique&lt;char[]&gt;(maxLength + 1);</span>
 410     JSStringGetUTF8CString(origin.get(), originBuffer.get(), maxLength + 1);
 411 
 412     maxLength = JSStringGetMaximumUTF8CStringSize(destination.get());
<span class="line-modified"> 413     auto destinationBuffer = std::make_unique&lt;char[]&gt;(maxLength + 1);</span>
 414     JSStringGetUTF8CString(destination.get(), destinationBuffer.get(), maxLength + 1);
 415 
 416     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 417     controller-&gt;addURLToRedirect(originBuffer.get(), destinationBuffer.get());
 418 
 419     return JSValueMakeUndefined(context);
 420 }
 421 
 422 static JSValueRef callShouldCloseOnWebViewCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 423 {
 424     // Has mac &amp; windows implementation
 425     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 426 
 427     return JSValueMakeBoolean(context, controller-&gt;callShouldCloseOnWebView());
 428 }
 429 
 430 static JSValueRef clearAllApplicationCachesCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 431 {
 432     // Has mac implementation
 433     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
</pre>
<hr />
<pre>
 919     controller-&gt;setCustomPolicyDelegate(JSValueToBoolean(context, arguments[0]), permissive);
 920 
 921     return JSValueMakeUndefined(context);
 922 }
 923 
 924 static JSValueRef setDatabaseQuotaCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 925 {
 926     // Has mac implementation
 927     if (argumentCount &lt; 1)
 928         return JSValueMakeUndefined(context);
 929 
 930     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 931 
 932     double quota = JSValueToNumber(context, arguments[0], NULL);
 933     if (!std::isnan(quota))
 934         controller-&gt;setDatabaseQuota(static_cast&lt;unsigned long long&gt;(quota));
 935 
 936     return JSValueMakeUndefined(context);
 937 }
 938 
<span class="line-removed"> 939 static JSValueRef setIDBPerOriginQuotaCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)</span>
<span class="line-removed"> 940 {</span>
<span class="line-removed"> 941     if (argumentCount &lt; 1)</span>
<span class="line-removed"> 942         return JSValueMakeUndefined(context);</span>
<span class="line-removed"> 943 </span>
<span class="line-removed"> 944     auto* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));</span>
<span class="line-removed"> 945 </span>
<span class="line-removed"> 946     double quota = JSValueToNumber(context, arguments[0], nullptr);</span>
<span class="line-removed"> 947     if (!std::isnan(quota))</span>
<span class="line-removed"> 948         controller-&gt;setIDBPerOriginQuota(static_cast&lt;uint64_t&gt;(quota));</span>
<span class="line-removed"> 949 </span>
<span class="line-removed"> 950     return JSValueMakeUndefined(context);</span>
<span class="line-removed"> 951 }</span>
<span class="line-removed"> 952 </span>
 953 static JSValueRef setDefersLoadingCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 954 {
 955     if (argumentCount &lt; 1)
 956         return JSValueMakeUndefined(context);
 957 
 958     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 959     controller-&gt;setDefersLoading(JSValueToBoolean(context, arguments[0]));
 960 
 961     return JSValueMakeUndefined(context);
 962 }
 963 
 964 static JSValueRef setUseDeferredFrameLoadingCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 965 {
 966     if (argumentCount &lt; 1)
 967         return JSValueMakeUndefined(context);
 968 
 969     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 970     controller-&gt;setUseDeferredFrameLoading(JSValueToBoolean(context, arguments[0]));
 971 
 972     return JSValueMakeUndefined(context);
</pre>
<hr />
<pre>
1292         return JSValueMakeUndefined(context);
1293 
1294     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1295     controller-&gt;setTelephoneNumberParsingEnabled(JSValueToBoolean(context, arguments[0]));
1296 
1297     return JSValueMakeUndefined(context);
1298 }
1299 
1300 static JSValueRef setPagePausedCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1301 {
1302     if (argumentCount &lt; 1)
1303         return JSValueMakeUndefined(context);
1304 
1305     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1306     controller-&gt;setPagePaused(JSValueToBoolean(context, arguments[0]));
1307 
1308     return JSValueMakeUndefined(context);
1309 }
1310 #endif
1311 
<span class="line-removed">1312 static JSValueRef setUseDashboardCompatibilityModeCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)</span>
<span class="line-removed">1313 {</span>
<span class="line-removed">1314     // Has mac implementation</span>
<span class="line-removed">1315     if (argumentCount &lt; 1)</span>
<span class="line-removed">1316         return JSValueMakeUndefined(context);</span>
<span class="line-removed">1317 </span>
<span class="line-removed">1318     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));</span>
<span class="line-removed">1319     controller-&gt;setUseDashboardCompatibilityMode(JSValueToBoolean(context, arguments[0]));</span>
<span class="line-removed">1320 </span>
<span class="line-removed">1321     return JSValueMakeUndefined(context);</span>
<span class="line-removed">1322 }</span>
<span class="line-removed">1323 </span>
1324 static JSValueRef setUserStyleSheetEnabledCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1325 {
1326     // Has mac implementation
1327     if (argumentCount &lt; 1)
1328         return JSValueMakeUndefined(context);
1329 
1330     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1331     controller-&gt;setUserStyleSheetEnabled(JSValueToBoolean(context, arguments[0]));
1332 
1333     return JSValueMakeUndefined(context);
1334 }
1335 
1336 static JSValueRef setUserStyleSheetLocationCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1337 {
1338     // Has mac implementation
1339     if (argumentCount &lt; 1)
1340         return JSValueMakeUndefined(context);
1341 
1342     auto path = adopt(JSValueToStringCopy(context, arguments[0], exception));
1343     ASSERT(!*exception);
</pre>
<hr />
<pre>
1356 
1357     auto value = adopt(JSValueToStringCopy(context, arguments[1], exception));
1358     ASSERT(!*exception);
1359 
1360     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1361     controller-&gt;setValueForUser(context, arguments[0], value.get());
1362 
1363     return JSValueMakeUndefined(context);
1364 }
1365 
1366 static JSValueRef setWillSendRequestClearHeaderCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1367 {
1368     // Has mac &amp; windows implementation
1369     if (argumentCount &lt; 1)
1370         return JSValueMakeUndefined(context);
1371 
1372     auto header = adopt(JSValueToStringCopy(context, arguments[0], exception));
1373     ASSERT(!*exception);
1374 
1375     size_t maxLength = JSStringGetMaximumUTF8CStringSize(header.get());
<span class="line-modified">1376     auto headerBuffer = std::make_unique&lt;char[]&gt;(maxLength + 1);</span>
1377     JSStringGetUTF8CString(header.get(), headerBuffer.get(), maxLength + 1);
1378 
1379     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1380     controller-&gt;setWillSendRequestClearHeader(headerBuffer.get());
1381 
1382     return JSValueMakeUndefined(context);
1383 }
1384 
1385 static JSValueRef setWillSendRequestReturnsNullCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1386 {
1387     // Has cross-platform implementation
1388     if (argumentCount &lt; 1)
1389         return JSValueMakeUndefined(context);
1390 
1391     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1392     controller-&gt;setWillSendRequestReturnsNull(JSValueToBoolean(context, arguments[0]));
1393 
1394     return JSValueMakeUndefined(context);
1395 }
1396 
</pre>
<hr />
<pre>
1814     return JSValueMakeUndefined(context);
1815 }
1816 
1817 static JSValueRef setSpellCheckerResultsCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1818 {
1819     if (argumentCount &lt; 1)
1820         return JSValueMakeUndefined(context);
1821 
1822     auto* runner = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1823     runner-&gt;setSpellCheckerResults(context, JSValueToObject(context, arguments[0], nullptr));
1824     return JSValueMakeUndefined(context);
1825 }
1826 
1827 static JSValueRef setOpenPanelFilesCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1828 {
1829     if (argumentCount == 1)
1830         static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject))-&gt;setOpenPanelFiles(context, arguments[0]);
1831     return JSValueMakeUndefined(context);
1832 }
1833 









1834 // Static Values
1835 
1836 static JSValueRef getTimeoutCallback(JSContextRef context, JSObjectRef thisObject, JSStringRef propertyName, JSValueRef* exception)
1837 {
1838     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1839     return JSValueMakeNumber(context, controller-&gt;timeout());
1840 }
1841 
1842 static JSValueRef getGlobalFlagCallback(JSContextRef context, JSObjectRef thisObject, JSStringRef propertyName, JSValueRef* exception)
1843 {
1844     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1845     return JSValueMakeBoolean(context, controller-&gt;globalFlag());
1846 }
1847 
1848 static JSValueRef getDidCancelClientRedirect(JSContextRef context, JSObjectRef thisObject, JSStringRef propertyName, JSValueRef* exception)
1849 {
1850     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1851     return JSValueMakeBoolean(context, controller-&gt;didCancelClientRedirect());
1852 }
1853 
</pre>
<hr />
<pre>
2048     return JSC::numberOfDFGCompiles(context, arguments[0]);
2049 }
2050 
2051 static JSValueRef neverInlineFunction(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
2052 {
2053     if (argumentCount &lt; 1)
2054         return JSValueMakeUndefined(context);
2055 
2056     return JSC::setNeverInline(context, arguments[0]);
2057 }
2058 
2059 static JSValueRef accummulateLogsForChannel(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
2060 {
2061     if (argumentCount &lt; 1)
2062         return JSValueMakeUndefined(context);
2063 
2064     auto channel = adopt(JSValueToStringCopy(context, arguments[0], exception));
2065     ASSERT(!*exception);
2066 
2067     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));




2068     controller-&gt;setAccummulateLogsForChannel(channel.get());
<span class="line-modified">2069 </span>
2070     return JSValueMakeUndefined(context);
2071 }
2072 
2073 static JSValueRef runUIScriptCallback(JSContextRef context, JSObjectRef, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
2074 {
2075     if (argumentCount &lt; 1)
2076         return JSValueMakeUndefined(context);
2077 
2078     auto script = argumentCount &gt; 0 ? adopt(JSValueToStringCopy(context, arguments[0], 0)) : JSRetainPtr&lt;JSStringRef&gt;();
2079     JSValueRef callback = argumentCount &gt; 1 ? arguments[1] : JSValueMakeUndefined(context);
2080 
2081     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
2082     controller-&gt;runUIScript(context, script.get(), callback);
2083 
2084     return JSValueMakeUndefined(context);
2085 }
2086 
2087 static void testRunnerObjectFinalize(JSObjectRef object)
2088 {
2089     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(object));
</pre>
<hr />
<pre>
2099 
2100     JSClassRef classRef = getJSClass();
2101     JSValueRef layoutTestContollerObject = JSObjectMake(context, classRef, this);
2102     JSClassRelease(classRef);
2103 
2104     JSObjectSetProperty(context, windowObject, testRunnerStr.get(), layoutTestContollerObject, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete, exception);
2105 }
2106 
2107 JSClassRef TestRunner::getJSClass()
2108 {
2109     static JSStaticValue* staticValues = TestRunner::staticValues();
2110     static JSStaticFunction* staticFunctions = TestRunner::staticFunctions();
2111     static JSClassDefinition classDefinition = {
2112         0, kJSClassAttributeNone, &quot;TestRunner&quot;, 0, staticValues, staticFunctions,
2113         0, testRunnerObjectFinalize, 0, 0, 0, 0, 0, 0, 0, 0, 0
2114     };
2115 
2116     return JSClassCreate(&amp;classDefinition);
2117 }
2118 
































2119 JSStaticValue* TestRunner::staticValues()
2120 {
2121     static JSStaticValue staticValues[] = {
2122         { &quot;didCancelClientRedirect&quot;, getDidCancelClientRedirect, 0, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2123         { &quot;timeout&quot;, getTimeoutCallback, 0, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2124         { &quot;globalFlag&quot;, getGlobalFlagCallback, setGlobalFlagCallback, kJSPropertyAttributeNone },
2125         { &quot;webHistoryItemCount&quot;, getWebHistoryItemCountCallback, 0, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2126         { &quot;secureEventInputIsEnabled&quot;, getSecureEventInputIsEnabledCallback, 0, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2127         { &quot;titleTextDirection&quot;, getTitleTextDirectionCallback, 0, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2128         { &quot;databaseDefaultQuota&quot;, getDatabaseDefaultQuotaCallback, setDatabaseDefaultQuotaCallback, kJSPropertyAttributeNone },
2129         { &quot;databaseMaxQuota&quot;, getDatabaseMaxQuotaCallback, setDatabaseMaxQuotaCallback, kJSPropertyAttributeNone },
2130         { &quot;inspectorTestStubURL&quot;, getInspectorTestStubURLCallback, 0, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },






2131         { 0, 0, 0, 0 }
2132     };
2133     return staticValues;
2134 }
2135 
2136 JSStaticFunction* TestRunner::staticFunctions()
2137 {
2138     static JSStaticFunction staticFunctions[] = {
2139         { &quot;abortModal&quot;, abortModalCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2140         { &quot;addDisallowedURL&quot;, addDisallowedURLCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2141         { &quot;addURLToRedirect&quot;, addURLToRedirectCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2142         { &quot;addUserScript&quot;, addUserScriptCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2143         { &quot;addUserStyleSheet&quot;, addUserStyleSheetCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2144         { &quot;apiTestNewWindowDataLoadBaseURL&quot;, apiTestNewWindowDataLoadBaseURLCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2145         { &quot;apiTestGoToCurrentBackForwardItem&quot;, apiTestGoToCurrentBackForwardItemCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2146         { &quot;applicationCacheDiskUsageForOrigin&quot;, applicationCacheDiskUsageForOriginCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2147         { &quot;callShouldCloseOnWebView&quot;, callShouldCloseOnWebViewCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2148         { &quot;clearAllApplicationCaches&quot;, clearAllApplicationCachesCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2149         { &quot;clearAllDatabases&quot;, clearAllDatabasesCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2150         { &quot;clearApplicationCacheForOrigin&quot;, clearApplicationCacheForOriginCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2151         { &quot;clearBackForwardList&quot;, clearBackForwardListCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2152         { &quot;clearPersistentUserStyleSheet&quot;, clearPersistentUserStyleSheetCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2153         { &quot;closeWebInspector&quot;, closeWebInspectorCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2154         { &quot;decodeHostName&quot;, decodeHostNameCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2155         { &quot;disallowIncreaseForApplicationCacheQuota&quot;, disallowIncreaseForApplicationCacheQuotaCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2156         { &quot;dispatchPendingLoadRequests&quot;, dispatchPendingLoadRequestsCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2157         { &quot;display&quot;, displayCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2158         { &quot;displayAndTrackRepaints&quot;, displayAndTrackRepaintsCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2159         { &quot;dumpApplicationCacheDelegateCallbacks&quot;, dumpApplicationCacheDelegateCallbacksCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },

2160         { &quot;dumpAsText&quot;, dumpAsTextCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2161         { &quot;dumpBackForwardList&quot;, dumpBackForwardListCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2162         { &quot;dumpChildFrameScrollPositions&quot;, dumpChildFrameScrollPositionsCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2163         { &quot;dumpChildFramesAsText&quot;, dumpChildFramesAsTextCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2164         { &quot;dumpDOMAsWebArchive&quot;, dumpDOMAsWebArchiveCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2165         { &quot;dumpDatabaseCallbacks&quot;, dumpDatabaseCallbacksCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2166         { &quot;dumpEditingCallbacks&quot;, dumpEditingCallbacksCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2167         { &quot;dumpFrameLoadCallbacks&quot;, dumpFrameLoadCallbacksCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2168         { &quot;dumpProgressFinishedCallback&quot;, dumpProgressFinishedCallbackCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2169         { &quot;dumpUserGestureInFrameLoadCallbacks&quot;, dumpUserGestureInFrameLoadCallbacksCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2170         { &quot;dumpResourceLoadCallbacks&quot;, dumpResourceLoadCallbacksCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2171         { &quot;dumpResourceResponseMIMETypes&quot;, dumpResourceResponseMIMETypesCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2172         { &quot;dumpSelectionRect&quot;, dumpSelectionRectCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2173         { &quot;dumpSourceAsWebArchive&quot;, dumpSourceAsWebArchiveCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2174         { &quot;dumpStatusCallbacks&quot;, dumpStatusCallbacksCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2175         { &quot;dumpTitleChanges&quot;, dumpTitleChangesCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2176         { &quot;dumpWillCacheResponse&quot;, dumpWillCacheResponseCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2177         { &quot;encodeHostName&quot;, encodeHostNameCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2178         { &quot;evaluateInWebInspector&quot;, evaluateInWebInspectorCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2179         { &quot;evaluateScriptInIsolatedWorldAndReturnValue&quot;, evaluateScriptInIsolatedWorldAndReturnValueCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
</pre>
<hr />
<pre>
2210         { &quot;setAlwaysAcceptCookies&quot;, setAlwaysAcceptCookiesCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2211         { &quot;setOnlyAcceptFirstPartyCookies&quot;, setOnlyAcceptFirstPartyCookiesCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2212         { &quot;setAppCacheMaximumSize&quot;, setAppCacheMaximumSizeCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2213         { &quot;setAudioResult&quot;, setAudioResultCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2214         { &quot;setAuthenticationPassword&quot;, setAuthenticationPasswordCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2215         { &quot;setAuthenticationUsername&quot;, setAuthenticationUsernameCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2216         { &quot;setAuthorAndUserStylesEnabled&quot;, setAuthorAndUserStylesEnabledCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2217         { &quot;setCacheModel&quot;, setCacheModelCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2218         { &quot;setCallCloseOnWebViews&quot;, setCallCloseOnWebViewsCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2219         { &quot;setCanOpenWindows&quot;, setCanOpenWindowsCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2220         { &quot;setCloseRemainingWindowsWhenComplete&quot;, setCloseRemainingWindowsWhenCompleteCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2221         { &quot;setCustomPolicyDelegate&quot;, setCustomPolicyDelegateCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2222         { &quot;setDatabaseQuota&quot;, setDatabaseQuotaCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2223         { &quot;setDefersLoading&quot;, setDefersLoadingCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2224         { &quot;setUseDeferredFrameLoading&quot;, setUseDeferredFrameLoadingCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2225         { &quot;setDomainRelaxationForbiddenForURLScheme&quot;, setDomainRelaxationForbiddenForURLSchemeCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2226         { &quot;setGeolocationPermission&quot;, setGeolocationPermissionCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2227         { &quot;setRejectsProtectionSpaceAndContinueForAuthenticationChallenges&quot;, setRejectsProtectionSpaceAndContinueForAuthenticationChallengesCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2228         { &quot;setHandlesAuthenticationChallenges&quot;, setHandlesAuthenticationChallengesCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2229         { &quot;setIconDatabaseEnabled&quot;, setIconDatabaseEnabledCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
<span class="line-removed">2230         { &quot;setIDBPerOriginQuota&quot;, setIDBPerOriginQuotaCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },</span>
2231         { &quot;setAutomaticLinkDetectionEnabled&quot;, setAutomaticLinkDetectionEnabledCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2232         { &quot;setMainFrameIsFirstResponder&quot;, setMainFrameIsFirstResponderCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2233         { &quot;setMockDeviceOrientation&quot;, setMockDeviceOrientationCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2234         { &quot;setMockGeolocationPositionUnavailableError&quot;, setMockGeolocationPositionUnavailableErrorCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2235         { &quot;setMockGeolocationPosition&quot;, setMockGeolocationPositionCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2236         { &quot;setNewWindowsCopyBackForwardList&quot;, setNewWindowsCopyBackForwardListCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2237         { &quot;setPageVisibility&quot;, setPageVisibilityCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2238         { &quot;setPOSIXLocale&quot;, setPOSIXLocaleCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2239         { &quot;setPersistentUserStyleSheetLocation&quot;, setPersistentUserStyleSheetLocationCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2240         { &quot;setPopupBlockingEnabled&quot;, setPopupBlockingEnabledCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2241         { &quot;setPluginsEnabled&quot;, setPluginsEnabledCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2242         { &quot;setPrinting&quot;, setPrintingCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2243         { &quot;setPrivateBrowsingEnabled&quot;, setPrivateBrowsingEnabledCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2244         { &quot;setSerializeHTTPLoads&quot;, setSerializeHTTPLoadsCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2245         { &quot;setSpatialNavigationEnabled&quot;, setSpatialNavigationEnabledCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2246         { &quot;setStopProvisionalFrameLoads&quot;, setStopProvisionalFrameLoadsCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2247         { &quot;setTabKeyCyclesThroughElements&quot;, setTabKeyCyclesThroughElementsCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2248 #if PLATFORM(IOS_FAMILY)
2249         { &quot;setTelephoneNumberParsingEnabled&quot;, setTelephoneNumberParsingEnabledCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2250         { &quot;setPagePaused&quot;, setPagePausedCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2251 #endif
<span class="line-removed">2252         { &quot;setUseDashboardCompatibilityMode&quot;, setUseDashboardCompatibilityModeCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },</span>
2253         { &quot;setUserStyleSheetEnabled&quot;, setUserStyleSheetEnabledCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2254         { &quot;setUserStyleSheetLocation&quot;, setUserStyleSheetLocationCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2255         { &quot;setValueForUser&quot;, setValueForUserCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2256         { &quot;setWebViewEditable&quot;, setWebViewEditableCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2257         { &quot;setWillSendRequestClearHeader&quot;, setWillSendRequestClearHeaderCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2258         { &quot;setWillSendRequestReturnsNull&quot;, setWillSendRequestReturnsNullCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2259         { &quot;setWillSendRequestReturnsNullOnRedirect&quot;, setWillSendRequestReturnsNullOnRedirectCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2260         { &quot;setWindowIsKey&quot;, setWindowIsKeyCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2261         { &quot;setViewSize&quot;, setViewSizeCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2262         { &quot;setJavaScriptCanAccessClipboard&quot;, setJavaScriptCanAccessClipboardCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2263         { &quot;setXSSAuditorEnabled&quot;, setXSSAuditorEnabledCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2264         { &quot;showWebInspector&quot;, showWebInspectorCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2265         { &quot;simulateLegacyWebNotificationClick&quot;, simulateLegacyWebNotificationClickCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2266         { &quot;testOnscreen&quot;, testOnscreenCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2267         { &quot;testRepaint&quot;, testRepaintCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2268         { &quot;waitForPolicyDelegate&quot;, waitForPolicyDelegateCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2269         { &quot;waitUntilDone&quot;, waitUntilDoneCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2270         { &quot;windowCount&quot;, windowCountCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2271         { &quot;addOriginAccessWhitelistEntry&quot;, addOriginAccessWhitelistEntryCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2272         { &quot;setScrollbarPolicy&quot;, setScrollbarPolicyCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
</pre>
<hr />
<pre>
2278         { &quot;removeChromeInputField&quot;, removeChromeInputFieldCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2279         { &quot;focusWebView&quot;, focusWebViewCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2280         { &quot;setBackingScaleFactor&quot;, setBackingScaleFactorCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2281         { &quot;preciseTime&quot;, preciseTimeCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2282         { &quot;setHasCustomFullScreenBehavior&quot;, setHasCustomFullScreenBehaviorCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2283         { &quot;setStorageDatabaseIdleInterval&quot;, setStorageDatabaseIdleIntervalCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2284         { &quot;closeIdleLocalStorageDatabases&quot;, closeIdleLocalStorageDatabasesCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2285         { &quot;grantWebNotificationPermission&quot;, grantWebNotificationPermissionCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2286         { &quot;denyWebNotificationPermission&quot;, denyWebNotificationPermissionCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2287         { &quot;removeAllWebNotificationPermissions&quot;, removeAllWebNotificationPermissionsCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2288         { &quot;simulateWebNotificationClick&quot;, simulateWebNotificationClickCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2289         { &quot;failNextNewCodeBlock&quot;, failNextNewCodeBlock, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2290         { &quot;numberOfDFGCompiles&quot;, numberOfDFGCompiles, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2291         { &quot;neverInlineFunction&quot;, neverInlineFunction, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2292         { &quot;accummulateLogsForChannel&quot;, accummulateLogsForChannel, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2293         { &quot;runUIScript&quot;, runUIScriptCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2294         { &quot;imageCountInGeneralPasteboard&quot;, imageCountInGeneralPasteboardCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2295         { &quot;setSpellCheckerLoggingEnabled&quot;, setSpellCheckerLoggingEnabledCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2296         { &quot;setSpellCheckerResults&quot;, setSpellCheckerResultsCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2297         { &quot;setOpenPanelFiles&quot;, setOpenPanelFilesCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },



2298         { &quot;forceImmediateCompletion&quot;, forceImmediateCompletionCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2299         { 0, 0, 0 }
2300     };
2301 
2302     return staticFunctions;
2303 }
2304 
2305 void TestRunner::queueLoadHTMLString(JSStringRef content, JSStringRef baseURL)
2306 {
2307     DRT::WorkQueue::singleton().queue(new LoadHTMLStringItem(content, baseURL));
2308 }
2309 
2310 void TestRunner::queueLoadAlternateHTMLString(JSStringRef content, JSStringRef baseURL, JSStringRef unreachableURL)
2311 {
2312     DRT::WorkQueue::singleton().queue(new LoadHTMLStringItem(content, baseURL, unreachableURL));
2313 }
2314 
2315 void TestRunner::queueBackNavigation(int howFarBack)
2316 {
2317     DRT::WorkQueue::singleton().queue(new BackItem(howFarBack));
</pre>
<hr />
<pre>
2369     setlocale(LC_ALL, localeBuf);
2370 }
2371 
2372 void TestRunner::addURLToRedirect(std::string origin, std::string destination)
2373 {
2374     m_URLsToRedirect[origin] = destination;
2375 }
2376 
2377 const char* TestRunner::redirectionDestinationForURL(const char* origin)
2378 {
2379     if (!origin)
2380         return nullptr;
2381 
2382     auto iterator = m_URLsToRedirect.find(origin);
2383     if (iterator == m_URLsToRedirect.end())
2384         return nullptr;
2385 
2386     return iterator-&gt;second.data();
2387 }
2388 





2389 void TestRunner::setShouldPaintBrokenImage(bool shouldPaintBrokenImage)
2390 {
2391     m_shouldPaintBrokenImage = shouldPaintBrokenImage;
2392 }
2393 
2394 void TestRunner::setAccummulateLogsForChannel(JSStringRef channel)
2395 {
2396     size_t maxLength = JSStringGetMaximumUTF8CStringSize(channel);
<span class="line-modified">2397     auto buffer = std::make_unique&lt;char[]&gt;(maxLength + 1);</span>
2398     JSStringGetUTF8CString(channel, buffer.get(), maxLength + 1);
2399 




2400     WebCoreTestSupport::setLogChannelToAccumulate({ buffer.get() });

2401 }
2402 
2403 typedef WTF::HashMap&lt;unsigned, JSValueRef&gt; CallbackMap;
2404 static CallbackMap&amp; callbackMap()
2405 {
2406     static CallbackMap&amp; map = *new CallbackMap;
2407     return map;
2408 }
2409 
2410 void TestRunner::cacheTestRunnerCallback(unsigned index, JSValueRef callback)
2411 {
2412     if (!callback)
2413         return;
2414 
2415     if (callbackMap().contains(index)) {
2416         fprintf(stderr, &quot;FAIL: Tried to install a second TestRunner callback for the same event (id %d)\n&quot;, index);
2417         return;
2418     }
2419 
2420     JSContextRef context = mainFrameJSContext();
</pre>
<hr />
<pre>
2447 }
2448 
2449 enum {
2450     FirstUIScriptCallbackID = 100
2451 };
2452 
2453 static unsigned nextUIScriptCallbackID()
2454 {
2455     static unsigned callbackID = FirstUIScriptCallbackID;
2456     return callbackID++;
2457 }
2458 
2459 void TestRunner::runUIScript(JSContextRef context, JSStringRef script, JSValueRef callback)
2460 {
2461     m_pendingUIScriptInvocationData = nullptr;
2462 
2463     unsigned callbackID = nextUIScriptCallbackID();
2464     cacheTestRunnerCallback(callbackID, callback);
2465 
2466     if (!m_UIScriptContext)
<span class="line-modified">2467         m_UIScriptContext = std::make_unique&lt;WTR::UIScriptContext&gt;(*this);</span>
2468 
2469     String scriptString(JSStringGetCharactersPtr(script), JSStringGetLength(script));
2470     m_UIScriptContext-&gt;runUIScript(scriptString, callbackID);
2471 }
2472 
2473 void TestRunner::callUIScriptCallback(unsigned callbackID, JSStringRef result)
2474 {
2475     JSRetainPtr&lt;JSStringRef&gt; protectedResult(result);
2476 #if !PLATFORM(IOS_FAMILY)
2477     RunLoop::main().dispatch([protectedThis = makeRef(*this), callbackID, protectedResult]() mutable {
2478         JSContextRef context = protectedThis-&gt;mainFrameJSContext();
2479         JSValueRef resultValue = JSValueMakeString(context, protectedResult.get());
2480         protectedThis-&gt;callTestRunnerCallback(callbackID, 1, &amp;resultValue);
2481     });
2482 #else
2483     WebThreadRun(
2484         makeBlockPtr([protectedThis = makeRef(*this), callbackID, protectedResult] {
2485             JSContextRef context = protectedThis-&gt;mainFrameJSContext();
2486             JSValueRef resultValue = JSValueMakeString(context, protectedResult.get());
2487             protectedThis-&gt;callTestRunnerCallback(callbackID, 1, &amp;resultValue);
2488         }).get()
2489     );
2490 #endif
2491 }
2492 
2493 void TestRunner::uiScriptDidComplete(const String&amp; result, unsigned callbackID)
2494 {
2495     auto stringRef = adopt(JSStringCreateWithUTF8CString(result.utf8().data()));
2496     callUIScriptCallback(callbackID, stringRef.get());
2497 }
2498 
2499 void TestRunner::setAllowsAnySSLCertificate(bool allowsAnySSLCertificate)
2500 {




2501     WebCoreTestSupport::setAllowsAnySSLCertificate(allowsAnySSLCertificate);

2502 }
2503 
2504 void TestRunner::setOpenPanelFiles(JSContextRef context, JSValueRef filesValue)
2505 {
2506     if (!JSValueIsArray(context, filesValue))
2507         return;
2508 
2509     JSObjectRef files = JSValueToObject(context, filesValue, nullptr);
2510     static auto lengthProperty = adopt(JSStringCreateWithUTF8CString(&quot;length&quot;));
2511     JSValueRef filesLengthValue = JSObjectGetProperty(context, files, lengthProperty.get(), nullptr);
2512     if (!JSValueIsNumber(context, filesLengthValue))
2513         return;
2514 
2515     m_openPanelFiles.clear();
2516     auto filesLength = static_cast&lt;size_t&gt;(JSValueToNumber(context, filesLengthValue, nullptr));
2517     for (size_t i = 0; i &lt; filesLength; ++i) {
2518         JSValueRef fileValue = JSObjectGetPropertyAtIndex(context, files, i, nullptr);
2519         if (!JSValueIsString(context, fileValue))
2520             continue;
2521 
2522         auto file = adopt(JSValueToStringCopy(context, fileValue, nullptr));
2523         size_t fileBufferSize = JSStringGetMaximumUTF8CStringSize(file.get()) + 1;
<span class="line-modified">2524         auto fileBuffer = std::make_unique&lt;char[]&gt;(fileBufferSize);</span>
2525         JSStringGetUTF8CString(file.get(), fileBuffer.get(), fileBufferSize);
2526 
2527         m_openPanelFiles.push_back(fileBuffer.get());
2528     }
2529 }
2530 

















2531 void TestRunner::cleanup()
2532 {
2533     clearTestRunnerCallbacks();
2534 }
</pre>
</td>
<td>
<hr />
<pre>
  36 #include &lt;JavaScriptCore/APICast.h&gt;
  37 #include &lt;JavaScriptCore/ArrayBufferView.h&gt;
  38 #include &lt;JavaScriptCore/HeapInlines.h&gt;
  39 #include &lt;JavaScriptCore/JSArrayBufferView.h&gt;
  40 #include &lt;JavaScriptCore/JSCTestRunnerUtils.h&gt;
  41 #include &lt;JavaScriptCore/JSContextRef.h&gt;
  42 #include &lt;JavaScriptCore/JSObjectRef.h&gt;
  43 #include &lt;JavaScriptCore/JSRetainPtr.h&gt;
  44 #include &lt;JavaScriptCore/TypedArrayInlines.h&gt;
  45 #include &lt;JavaScriptCore/VMInlines.h&gt;
  46 #include &lt;WebCore/LogInitialization.h&gt;
  47 #include &lt;cstring&gt;
  48 #include &lt;locale.h&gt;
  49 #include &lt;stdio.h&gt;
  50 #include &lt;wtf/Assertions.h&gt;
  51 #include &lt;wtf/LoggingAccumulator.h&gt;
  52 #include &lt;wtf/MathExtras.h&gt;
  53 #include &lt;wtf/RefPtr.h&gt;
  54 #include &lt;wtf/RunLoop.h&gt;
  55 #include &lt;wtf/StdLibExtras.h&gt;
<span class="line-added">  56 #include &lt;wtf/UniqueArray.h&gt;</span>
  57 #include &lt;wtf/WallTime.h&gt;
  58 #include &lt;wtf/text/WTFString.h&gt;
  59 
  60 #if PLATFORM(IOS_FAMILY)
  61 #include &lt;WebCore/WebCoreThreadRun.h&gt;
  62 #include &lt;wtf/BlockPtr.h&gt;
  63 #endif
  64 
  65 #if PLATFORM(MAC) &amp;&amp; !PLATFORM(IOS_FAMILY)
  66 #include &lt;Carbon/Carbon.h&gt;
  67 #endif
  68 
  69 FILE* testResult = stdout;
  70 
  71 const unsigned TestRunner::viewWidth = 800;
  72 const unsigned TestRunner::viewHeight = 600;
  73 
  74 const unsigned TestRunner::w3cSVGViewWidth = 480;
  75 const unsigned TestRunner::w3cSVGViewHeight = 360;
  76 
  77 TestRunner::TestRunner(const std::string&amp; testURL, const std::string&amp; expectedPixelHash)
<span class="line-modified">  78     : m_testURL(testURL)</span>



















































  79     , m_expectedPixelHash(expectedPixelHash)
  80     , m_titleTextDirection(&quot;ltr&quot;)

  81 {
  82 }
  83 
  84 Ref&lt;TestRunner&gt; TestRunner::create(const std::string&amp; testURL, const std::string&amp; expectedPixelHash)
  85 {
  86     return adoptRef(*new TestRunner(testURL, expectedPixelHash));
  87 }
  88 
  89 // Static Functions
  90 
  91 static JSValueRef disallowIncreaseForApplicationCacheQuotaCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
  92 {
  93     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
  94     controller-&gt;setDisallowIncreaseForApplicationCacheQuota(true);
  95     return JSValueMakeUndefined(context);
  96 }
  97 
  98 static JSValueRef dumpApplicationCacheDelegateCallbacksCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
  99 {
 100     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 101     controller-&gt;setDumpApplicationCacheDelegateCallbacks(true);
 102     return JSValueMakeUndefined(context);
 103 }
 104 
 105 static JSValueRef dumpAsPDFCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 106 {
 107     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 108     controller-&gt;setDumpAsPDF(true);
 109     return JSValueMakeUndefined(context);
 110 }
 111 
<span class="line-added"> 112 static JSValueRef setRenderTreeDumpOptionsCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)</span>
<span class="line-added"> 113 {</span>
<span class="line-added"> 114     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));</span>
<span class="line-added"> 115 </span>
<span class="line-added"> 116     double options = JSValueToNumber(context, arguments[0], exception);</span>
<span class="line-added"> 117     ASSERT(!*exception);</span>
<span class="line-added"> 118 </span>
<span class="line-added"> 119     controller-&gt;setRenderTreeDumpOptions(static_cast&lt;unsigned&gt;(options));</span>
<span class="line-added"> 120     return JSValueMakeUndefined(context);</span>
<span class="line-added"> 121 }</span>
<span class="line-added"> 122 </span>
 123 static JSValueRef dumpAsTextCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 124 {
 125     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 126     controller-&gt;setDumpAsText(true);
 127 
 128     // Optional paramater, describing whether it&#39;s allowed to dump pixel results in dumpAsText mode.
 129     controller-&gt;setGeneratePixelResults(argumentCount &gt; 0 ? JSValueToBoolean(context, arguments[0]) : false);
 130 
 131     return JSValueMakeUndefined(context);
 132 }
 133 
 134 static JSValueRef dumpBackForwardListCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 135 {
 136     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 137     controller-&gt;setDumpBackForwardList(true);
 138     return JSValueMakeUndefined(context);
 139 }
 140 
 141 static JSValueRef dumpChildFramesAsTextCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 142 {
</pre>
<hr />
<pre>
 349     ASSERT(!*exception);
 350 
 351     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 352     controller-&gt;addDisallowedURL(url.get());
 353 
 354     return JSValueMakeUndefined(context);
 355 }
 356 
 357 static JSValueRef addURLToRedirectCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 358 {
 359     if (argumentCount &lt; 2)
 360         return JSValueMakeUndefined(context);
 361 
 362     auto origin = adopt(JSValueToStringCopy(context, arguments[0], exception));
 363     ASSERT(!*exception);
 364 
 365     auto destination = adopt(JSValueToStringCopy(context, arguments[1], exception));
 366     ASSERT(!*exception);
 367 
 368     size_t maxLength = JSStringGetMaximumUTF8CStringSize(origin.get());
<span class="line-modified"> 369     auto originBuffer = makeUniqueArray&lt;char&gt;(maxLength + 1);</span>
 370     JSStringGetUTF8CString(origin.get(), originBuffer.get(), maxLength + 1);
 371 
 372     maxLength = JSStringGetMaximumUTF8CStringSize(destination.get());
<span class="line-modified"> 373     auto destinationBuffer = makeUniqueArray&lt;char&gt;(maxLength + 1);</span>
 374     JSStringGetUTF8CString(destination.get(), destinationBuffer.get(), maxLength + 1);
 375 
 376     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 377     controller-&gt;addURLToRedirect(originBuffer.get(), destinationBuffer.get());
 378 
 379     return JSValueMakeUndefined(context);
 380 }
 381 
 382 static JSValueRef callShouldCloseOnWebViewCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 383 {
 384     // Has mac &amp; windows implementation
 385     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 386 
 387     return JSValueMakeBoolean(context, controller-&gt;callShouldCloseOnWebView());
 388 }
 389 
 390 static JSValueRef clearAllApplicationCachesCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 391 {
 392     // Has mac implementation
 393     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
</pre>
<hr />
<pre>
 879     controller-&gt;setCustomPolicyDelegate(JSValueToBoolean(context, arguments[0]), permissive);
 880 
 881     return JSValueMakeUndefined(context);
 882 }
 883 
 884 static JSValueRef setDatabaseQuotaCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 885 {
 886     // Has mac implementation
 887     if (argumentCount &lt; 1)
 888         return JSValueMakeUndefined(context);
 889 
 890     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 891 
 892     double quota = JSValueToNumber(context, arguments[0], NULL);
 893     if (!std::isnan(quota))
 894         controller-&gt;setDatabaseQuota(static_cast&lt;unsigned long long&gt;(quota));
 895 
 896     return JSValueMakeUndefined(context);
 897 }
 898 














 899 static JSValueRef setDefersLoadingCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 900 {
 901     if (argumentCount &lt; 1)
 902         return JSValueMakeUndefined(context);
 903 
 904     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 905     controller-&gt;setDefersLoading(JSValueToBoolean(context, arguments[0]));
 906 
 907     return JSValueMakeUndefined(context);
 908 }
 909 
 910 static JSValueRef setUseDeferredFrameLoadingCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 911 {
 912     if (argumentCount &lt; 1)
 913         return JSValueMakeUndefined(context);
 914 
 915     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 916     controller-&gt;setUseDeferredFrameLoading(JSValueToBoolean(context, arguments[0]));
 917 
 918     return JSValueMakeUndefined(context);
</pre>
<hr />
<pre>
1238         return JSValueMakeUndefined(context);
1239 
1240     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1241     controller-&gt;setTelephoneNumberParsingEnabled(JSValueToBoolean(context, arguments[0]));
1242 
1243     return JSValueMakeUndefined(context);
1244 }
1245 
1246 static JSValueRef setPagePausedCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1247 {
1248     if (argumentCount &lt; 1)
1249         return JSValueMakeUndefined(context);
1250 
1251     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1252     controller-&gt;setPagePaused(JSValueToBoolean(context, arguments[0]));
1253 
1254     return JSValueMakeUndefined(context);
1255 }
1256 #endif
1257 












1258 static JSValueRef setUserStyleSheetEnabledCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1259 {
1260     // Has mac implementation
1261     if (argumentCount &lt; 1)
1262         return JSValueMakeUndefined(context);
1263 
1264     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1265     controller-&gt;setUserStyleSheetEnabled(JSValueToBoolean(context, arguments[0]));
1266 
1267     return JSValueMakeUndefined(context);
1268 }
1269 
1270 static JSValueRef setUserStyleSheetLocationCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1271 {
1272     // Has mac implementation
1273     if (argumentCount &lt; 1)
1274         return JSValueMakeUndefined(context);
1275 
1276     auto path = adopt(JSValueToStringCopy(context, arguments[0], exception));
1277     ASSERT(!*exception);
</pre>
<hr />
<pre>
1290 
1291     auto value = adopt(JSValueToStringCopy(context, arguments[1], exception));
1292     ASSERT(!*exception);
1293 
1294     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1295     controller-&gt;setValueForUser(context, arguments[0], value.get());
1296 
1297     return JSValueMakeUndefined(context);
1298 }
1299 
1300 static JSValueRef setWillSendRequestClearHeaderCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1301 {
1302     // Has mac &amp; windows implementation
1303     if (argumentCount &lt; 1)
1304         return JSValueMakeUndefined(context);
1305 
1306     auto header = adopt(JSValueToStringCopy(context, arguments[0], exception));
1307     ASSERT(!*exception);
1308 
1309     size_t maxLength = JSStringGetMaximumUTF8CStringSize(header.get());
<span class="line-modified">1310     auto headerBuffer = makeUniqueArray&lt;char&gt;(maxLength + 1);</span>
1311     JSStringGetUTF8CString(header.get(), headerBuffer.get(), maxLength + 1);
1312 
1313     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1314     controller-&gt;setWillSendRequestClearHeader(headerBuffer.get());
1315 
1316     return JSValueMakeUndefined(context);
1317 }
1318 
1319 static JSValueRef setWillSendRequestReturnsNullCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1320 {
1321     // Has cross-platform implementation
1322     if (argumentCount &lt; 1)
1323         return JSValueMakeUndefined(context);
1324 
1325     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1326     controller-&gt;setWillSendRequestReturnsNull(JSValueToBoolean(context, arguments[0]));
1327 
1328     return JSValueMakeUndefined(context);
1329 }
1330 
</pre>
<hr />
<pre>
1748     return JSValueMakeUndefined(context);
1749 }
1750 
1751 static JSValueRef setSpellCheckerResultsCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1752 {
1753     if (argumentCount &lt; 1)
1754         return JSValueMakeUndefined(context);
1755 
1756     auto* runner = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1757     runner-&gt;setSpellCheckerResults(context, JSValueToObject(context, arguments[0], nullptr));
1758     return JSValueMakeUndefined(context);
1759 }
1760 
1761 static JSValueRef setOpenPanelFilesCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1762 {
1763     if (argumentCount == 1)
1764         static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject))-&gt;setOpenPanelFiles(context, arguments[0]);
1765     return JSValueMakeUndefined(context);
1766 }
1767 
<span class="line-added">1768 #if PLATFORM(IOS_FAMILY)</span>
<span class="line-added">1769 static JSValueRef SetOpenPanelFilesMediaIconCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)</span>
<span class="line-added">1770 {</span>
<span class="line-added">1771     if (argumentCount == 1)</span>
<span class="line-added">1772         static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject))-&gt;setOpenPanelFilesMediaIcon(context, arguments[0]);</span>
<span class="line-added">1773     return JSValueMakeUndefined(context);</span>
<span class="line-added">1774 }</span>
<span class="line-added">1775 #endif</span>
<span class="line-added">1776 </span>
1777 // Static Values
1778 
1779 static JSValueRef getTimeoutCallback(JSContextRef context, JSObjectRef thisObject, JSStringRef propertyName, JSValueRef* exception)
1780 {
1781     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1782     return JSValueMakeNumber(context, controller-&gt;timeout());
1783 }
1784 
1785 static JSValueRef getGlobalFlagCallback(JSContextRef context, JSObjectRef thisObject, JSStringRef propertyName, JSValueRef* exception)
1786 {
1787     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1788     return JSValueMakeBoolean(context, controller-&gt;globalFlag());
1789 }
1790 
1791 static JSValueRef getDidCancelClientRedirect(JSContextRef context, JSObjectRef thisObject, JSStringRef propertyName, JSValueRef* exception)
1792 {
1793     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1794     return JSValueMakeBoolean(context, controller-&gt;didCancelClientRedirect());
1795 }
1796 
</pre>
<hr />
<pre>
1991     return JSC::numberOfDFGCompiles(context, arguments[0]);
1992 }
1993 
1994 static JSValueRef neverInlineFunction(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1995 {
1996     if (argumentCount &lt; 1)
1997         return JSValueMakeUndefined(context);
1998 
1999     return JSC::setNeverInline(context, arguments[0]);
2000 }
2001 
2002 static JSValueRef accummulateLogsForChannel(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
2003 {
2004     if (argumentCount &lt; 1)
2005         return JSValueMakeUndefined(context);
2006 
2007     auto channel = adopt(JSValueToStringCopy(context, arguments[0], exception));
2008     ASSERT(!*exception);
2009 
2010     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
<span class="line-added">2011 #if OS(WINDOWS) &amp;&amp; PLATFORM(JAVA)</span>
<span class="line-added">2012     // FIXME : error LNK2019: unresolved external symbol</span>
<span class="line-added">2013     // controller-&gt;setAccummulateLogsForChannel(channel.get());</span>
<span class="line-added">2014 #else</span>
2015     controller-&gt;setAccummulateLogsForChannel(channel.get());
<span class="line-modified">2016 #endif</span>
2017     return JSValueMakeUndefined(context);
2018 }
2019 
2020 static JSValueRef runUIScriptCallback(JSContextRef context, JSObjectRef, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
2021 {
2022     if (argumentCount &lt; 1)
2023         return JSValueMakeUndefined(context);
2024 
2025     auto script = argumentCount &gt; 0 ? adopt(JSValueToStringCopy(context, arguments[0], 0)) : JSRetainPtr&lt;JSStringRef&gt;();
2026     JSValueRef callback = argumentCount &gt; 1 ? arguments[1] : JSValueMakeUndefined(context);
2027 
2028     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
2029     controller-&gt;runUIScript(context, script.get(), callback);
2030 
2031     return JSValueMakeUndefined(context);
2032 }
2033 
2034 static void testRunnerObjectFinalize(JSObjectRef object)
2035 {
2036     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(object));
</pre>
<hr />
<pre>
2046 
2047     JSClassRef classRef = getJSClass();
2048     JSValueRef layoutTestContollerObject = JSObjectMake(context, classRef, this);
2049     JSClassRelease(classRef);
2050 
2051     JSObjectSetProperty(context, windowObject, testRunnerStr.get(), layoutTestContollerObject, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete, exception);
2052 }
2053 
2054 JSClassRef TestRunner::getJSClass()
2055 {
2056     static JSStaticValue* staticValues = TestRunner::staticValues();
2057     static JSStaticFunction* staticFunctions = TestRunner::staticFunctions();
2058     static JSClassDefinition classDefinition = {
2059         0, kJSClassAttributeNone, &quot;TestRunner&quot;, 0, staticValues, staticFunctions,
2060         0, testRunnerObjectFinalize, 0, 0, 0, 0, 0, 0, 0, 0, 0
2061     };
2062 
2063     return JSClassCreate(&amp;classDefinition);
2064 }
2065 
<span class="line-added">2066 // Constants</span>
<span class="line-added">2067 </span>
<span class="line-added">2068 static JSValueRef getRENDER_TREE_SHOW_ALL_LAYERS(JSContextRef context, JSObjectRef, JSStringRef, JSValueRef*)</span>
<span class="line-added">2069 {</span>
<span class="line-added">2070     return JSValueMakeNumber(context, 1);</span>
<span class="line-added">2071 }</span>
<span class="line-added">2072 </span>
<span class="line-added">2073 static JSValueRef getRENDER_TREE_SHOW_LAYER_NESTING(JSContextRef context, JSObjectRef, JSStringRef, JSValueRef*)</span>
<span class="line-added">2074 {</span>
<span class="line-added">2075     return JSValueMakeNumber(context, 2);</span>
<span class="line-added">2076 }</span>
<span class="line-added">2077 </span>
<span class="line-added">2078 static JSValueRef getRENDER_TREE_SHOW_COMPOSITED_LAYERS(JSContextRef context, JSObjectRef, JSStringRef, JSValueRef*)</span>
<span class="line-added">2079 {</span>
<span class="line-added">2080     return JSValueMakeNumber(context, 4);</span>
<span class="line-added">2081 }</span>
<span class="line-added">2082 </span>
<span class="line-added">2083 static JSValueRef getRENDER_TREE_SHOW_OVERFLOW(JSContextRef context, JSObjectRef, JSStringRef, JSValueRef*)</span>
<span class="line-added">2084 {</span>
<span class="line-added">2085     return JSValueMakeNumber(context, 8);</span>
<span class="line-added">2086 }</span>
<span class="line-added">2087 </span>
<span class="line-added">2088 static JSValueRef getRENDER_TREE_SHOW_SVG_GEOMETRY(JSContextRef context, JSObjectRef, JSStringRef, JSValueRef*)</span>
<span class="line-added">2089 {</span>
<span class="line-added">2090     return JSValueMakeNumber(context, 16);</span>
<span class="line-added">2091 }</span>
<span class="line-added">2092 </span>
<span class="line-added">2093 static JSValueRef getRENDER_TREE_SHOW_LAYER_FRAGMENTS(JSContextRef context, JSObjectRef, JSStringRef, JSValueRef*)</span>
<span class="line-added">2094 {</span>
<span class="line-added">2095     return JSValueMakeNumber(context, 32);</span>
<span class="line-added">2096 }</span>
<span class="line-added">2097 </span>
2098 JSStaticValue* TestRunner::staticValues()
2099 {
2100     static JSStaticValue staticValues[] = {
2101         { &quot;didCancelClientRedirect&quot;, getDidCancelClientRedirect, 0, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2102         { &quot;timeout&quot;, getTimeoutCallback, 0, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2103         { &quot;globalFlag&quot;, getGlobalFlagCallback, setGlobalFlagCallback, kJSPropertyAttributeNone },
2104         { &quot;webHistoryItemCount&quot;, getWebHistoryItemCountCallback, 0, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2105         { &quot;secureEventInputIsEnabled&quot;, getSecureEventInputIsEnabledCallback, 0, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2106         { &quot;titleTextDirection&quot;, getTitleTextDirectionCallback, 0, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2107         { &quot;databaseDefaultQuota&quot;, getDatabaseDefaultQuotaCallback, setDatabaseDefaultQuotaCallback, kJSPropertyAttributeNone },
2108         { &quot;databaseMaxQuota&quot;, getDatabaseMaxQuotaCallback, setDatabaseMaxQuotaCallback, kJSPropertyAttributeNone },
2109         { &quot;inspectorTestStubURL&quot;, getInspectorTestStubURLCallback, 0, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
<span class="line-added">2110         { &quot;RENDER_TREE_SHOW_ALL_LAYERS&quot;, getRENDER_TREE_SHOW_ALL_LAYERS, 0, kJSPropertyAttributeDontDelete | kJSPropertyAttributeReadOnly },</span>
<span class="line-added">2111         { &quot;RENDER_TREE_SHOW_LAYER_NESTING&quot;, getRENDER_TREE_SHOW_LAYER_NESTING, 0, kJSPropertyAttributeDontDelete | kJSPropertyAttributeReadOnly },</span>
<span class="line-added">2112         { &quot;RENDER_TREE_SHOW_COMPOSITED_LAYERS&quot;, getRENDER_TREE_SHOW_COMPOSITED_LAYERS, 0, kJSPropertyAttributeDontDelete | kJSPropertyAttributeReadOnly },</span>
<span class="line-added">2113         { &quot;RENDER_TREE_SHOW_OVERFLOW&quot;, getRENDER_TREE_SHOW_OVERFLOW, 0, kJSPropertyAttributeDontDelete | kJSPropertyAttributeReadOnly },</span>
<span class="line-added">2114         { &quot;RENDER_TREE_SHOW_SVG_GEOMETRY&quot;, getRENDER_TREE_SHOW_SVG_GEOMETRY, 0, kJSPropertyAttributeDontDelete | kJSPropertyAttributeReadOnly },</span>
<span class="line-added">2115         { &quot;RENDER_TREE_SHOW_LAYER_FRAGMENTS&quot;, getRENDER_TREE_SHOW_LAYER_FRAGMENTS, 0, kJSPropertyAttributeDontDelete | kJSPropertyAttributeReadOnly },</span>
2116         { 0, 0, 0, 0 }
2117     };
2118     return staticValues;
2119 }
2120 
2121 JSStaticFunction* TestRunner::staticFunctions()
2122 {
2123     static JSStaticFunction staticFunctions[] = {
2124         { &quot;abortModal&quot;, abortModalCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2125         { &quot;addDisallowedURL&quot;, addDisallowedURLCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2126         { &quot;addURLToRedirect&quot;, addURLToRedirectCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2127         { &quot;addUserScript&quot;, addUserScriptCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2128         { &quot;addUserStyleSheet&quot;, addUserStyleSheetCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2129         { &quot;apiTestNewWindowDataLoadBaseURL&quot;, apiTestNewWindowDataLoadBaseURLCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2130         { &quot;apiTestGoToCurrentBackForwardItem&quot;, apiTestGoToCurrentBackForwardItemCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2131         { &quot;applicationCacheDiskUsageForOrigin&quot;, applicationCacheDiskUsageForOriginCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2132         { &quot;callShouldCloseOnWebView&quot;, callShouldCloseOnWebViewCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2133         { &quot;clearAllApplicationCaches&quot;, clearAllApplicationCachesCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2134         { &quot;clearAllDatabases&quot;, clearAllDatabasesCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2135         { &quot;clearApplicationCacheForOrigin&quot;, clearApplicationCacheForOriginCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2136         { &quot;clearBackForwardList&quot;, clearBackForwardListCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2137         { &quot;clearPersistentUserStyleSheet&quot;, clearPersistentUserStyleSheetCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2138         { &quot;closeWebInspector&quot;, closeWebInspectorCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2139         { &quot;decodeHostName&quot;, decodeHostNameCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2140         { &quot;disallowIncreaseForApplicationCacheQuota&quot;, disallowIncreaseForApplicationCacheQuotaCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2141         { &quot;dispatchPendingLoadRequests&quot;, dispatchPendingLoadRequestsCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2142         { &quot;display&quot;, displayCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2143         { &quot;displayAndTrackRepaints&quot;, displayAndTrackRepaintsCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2144         { &quot;dumpApplicationCacheDelegateCallbacks&quot;, dumpApplicationCacheDelegateCallbacksCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
<span class="line-added">2145         { &quot;setRenderTreeDumpOptions&quot;, setRenderTreeDumpOptionsCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },</span>
2146         { &quot;dumpAsText&quot;, dumpAsTextCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2147         { &quot;dumpBackForwardList&quot;, dumpBackForwardListCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2148         { &quot;dumpChildFrameScrollPositions&quot;, dumpChildFrameScrollPositionsCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2149         { &quot;dumpChildFramesAsText&quot;, dumpChildFramesAsTextCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2150         { &quot;dumpDOMAsWebArchive&quot;, dumpDOMAsWebArchiveCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2151         { &quot;dumpDatabaseCallbacks&quot;, dumpDatabaseCallbacksCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2152         { &quot;dumpEditingCallbacks&quot;, dumpEditingCallbacksCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2153         { &quot;dumpFrameLoadCallbacks&quot;, dumpFrameLoadCallbacksCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2154         { &quot;dumpProgressFinishedCallback&quot;, dumpProgressFinishedCallbackCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2155         { &quot;dumpUserGestureInFrameLoadCallbacks&quot;, dumpUserGestureInFrameLoadCallbacksCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2156         { &quot;dumpResourceLoadCallbacks&quot;, dumpResourceLoadCallbacksCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2157         { &quot;dumpResourceResponseMIMETypes&quot;, dumpResourceResponseMIMETypesCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2158         { &quot;dumpSelectionRect&quot;, dumpSelectionRectCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2159         { &quot;dumpSourceAsWebArchive&quot;, dumpSourceAsWebArchiveCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2160         { &quot;dumpStatusCallbacks&quot;, dumpStatusCallbacksCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2161         { &quot;dumpTitleChanges&quot;, dumpTitleChangesCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2162         { &quot;dumpWillCacheResponse&quot;, dumpWillCacheResponseCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2163         { &quot;encodeHostName&quot;, encodeHostNameCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2164         { &quot;evaluateInWebInspector&quot;, evaluateInWebInspectorCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2165         { &quot;evaluateScriptInIsolatedWorldAndReturnValue&quot;, evaluateScriptInIsolatedWorldAndReturnValueCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
</pre>
<hr />
<pre>
2196         { &quot;setAlwaysAcceptCookies&quot;, setAlwaysAcceptCookiesCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2197         { &quot;setOnlyAcceptFirstPartyCookies&quot;, setOnlyAcceptFirstPartyCookiesCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2198         { &quot;setAppCacheMaximumSize&quot;, setAppCacheMaximumSizeCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2199         { &quot;setAudioResult&quot;, setAudioResultCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2200         { &quot;setAuthenticationPassword&quot;, setAuthenticationPasswordCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2201         { &quot;setAuthenticationUsername&quot;, setAuthenticationUsernameCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2202         { &quot;setAuthorAndUserStylesEnabled&quot;, setAuthorAndUserStylesEnabledCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2203         { &quot;setCacheModel&quot;, setCacheModelCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2204         { &quot;setCallCloseOnWebViews&quot;, setCallCloseOnWebViewsCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2205         { &quot;setCanOpenWindows&quot;, setCanOpenWindowsCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2206         { &quot;setCloseRemainingWindowsWhenComplete&quot;, setCloseRemainingWindowsWhenCompleteCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2207         { &quot;setCustomPolicyDelegate&quot;, setCustomPolicyDelegateCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2208         { &quot;setDatabaseQuota&quot;, setDatabaseQuotaCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2209         { &quot;setDefersLoading&quot;, setDefersLoadingCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2210         { &quot;setUseDeferredFrameLoading&quot;, setUseDeferredFrameLoadingCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2211         { &quot;setDomainRelaxationForbiddenForURLScheme&quot;, setDomainRelaxationForbiddenForURLSchemeCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2212         { &quot;setGeolocationPermission&quot;, setGeolocationPermissionCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2213         { &quot;setRejectsProtectionSpaceAndContinueForAuthenticationChallenges&quot;, setRejectsProtectionSpaceAndContinueForAuthenticationChallengesCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2214         { &quot;setHandlesAuthenticationChallenges&quot;, setHandlesAuthenticationChallengesCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2215         { &quot;setIconDatabaseEnabled&quot;, setIconDatabaseEnabledCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },

2216         { &quot;setAutomaticLinkDetectionEnabled&quot;, setAutomaticLinkDetectionEnabledCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2217         { &quot;setMainFrameIsFirstResponder&quot;, setMainFrameIsFirstResponderCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2218         { &quot;setMockDeviceOrientation&quot;, setMockDeviceOrientationCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2219         { &quot;setMockGeolocationPositionUnavailableError&quot;, setMockGeolocationPositionUnavailableErrorCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2220         { &quot;setMockGeolocationPosition&quot;, setMockGeolocationPositionCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2221         { &quot;setNewWindowsCopyBackForwardList&quot;, setNewWindowsCopyBackForwardListCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2222         { &quot;setPageVisibility&quot;, setPageVisibilityCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2223         { &quot;setPOSIXLocale&quot;, setPOSIXLocaleCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2224         { &quot;setPersistentUserStyleSheetLocation&quot;, setPersistentUserStyleSheetLocationCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2225         { &quot;setPopupBlockingEnabled&quot;, setPopupBlockingEnabledCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2226         { &quot;setPluginsEnabled&quot;, setPluginsEnabledCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2227         { &quot;setPrinting&quot;, setPrintingCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2228         { &quot;setPrivateBrowsingEnabled&quot;, setPrivateBrowsingEnabledCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2229         { &quot;setSerializeHTTPLoads&quot;, setSerializeHTTPLoadsCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2230         { &quot;setSpatialNavigationEnabled&quot;, setSpatialNavigationEnabledCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2231         { &quot;setStopProvisionalFrameLoads&quot;, setStopProvisionalFrameLoadsCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2232         { &quot;setTabKeyCyclesThroughElements&quot;, setTabKeyCyclesThroughElementsCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2233 #if PLATFORM(IOS_FAMILY)
2234         { &quot;setTelephoneNumberParsingEnabled&quot;, setTelephoneNumberParsingEnabledCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2235         { &quot;setPagePaused&quot;, setPagePausedCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2236 #endif

2237         { &quot;setUserStyleSheetEnabled&quot;, setUserStyleSheetEnabledCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2238         { &quot;setUserStyleSheetLocation&quot;, setUserStyleSheetLocationCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2239         { &quot;setValueForUser&quot;, setValueForUserCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2240         { &quot;setWebViewEditable&quot;, setWebViewEditableCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2241         { &quot;setWillSendRequestClearHeader&quot;, setWillSendRequestClearHeaderCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2242         { &quot;setWillSendRequestReturnsNull&quot;, setWillSendRequestReturnsNullCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2243         { &quot;setWillSendRequestReturnsNullOnRedirect&quot;, setWillSendRequestReturnsNullOnRedirectCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2244         { &quot;setWindowIsKey&quot;, setWindowIsKeyCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2245         { &quot;setViewSize&quot;, setViewSizeCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2246         { &quot;setJavaScriptCanAccessClipboard&quot;, setJavaScriptCanAccessClipboardCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2247         { &quot;setXSSAuditorEnabled&quot;, setXSSAuditorEnabledCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2248         { &quot;showWebInspector&quot;, showWebInspectorCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2249         { &quot;simulateLegacyWebNotificationClick&quot;, simulateLegacyWebNotificationClickCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2250         { &quot;testOnscreen&quot;, testOnscreenCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2251         { &quot;testRepaint&quot;, testRepaintCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2252         { &quot;waitForPolicyDelegate&quot;, waitForPolicyDelegateCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2253         { &quot;waitUntilDone&quot;, waitUntilDoneCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2254         { &quot;windowCount&quot;, windowCountCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2255         { &quot;addOriginAccessWhitelistEntry&quot;, addOriginAccessWhitelistEntryCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2256         { &quot;setScrollbarPolicy&quot;, setScrollbarPolicyCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
</pre>
<hr />
<pre>
2262         { &quot;removeChromeInputField&quot;, removeChromeInputFieldCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2263         { &quot;focusWebView&quot;, focusWebViewCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2264         { &quot;setBackingScaleFactor&quot;, setBackingScaleFactorCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2265         { &quot;preciseTime&quot;, preciseTimeCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2266         { &quot;setHasCustomFullScreenBehavior&quot;, setHasCustomFullScreenBehaviorCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2267         { &quot;setStorageDatabaseIdleInterval&quot;, setStorageDatabaseIdleIntervalCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2268         { &quot;closeIdleLocalStorageDatabases&quot;, closeIdleLocalStorageDatabasesCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2269         { &quot;grantWebNotificationPermission&quot;, grantWebNotificationPermissionCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2270         { &quot;denyWebNotificationPermission&quot;, denyWebNotificationPermissionCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2271         { &quot;removeAllWebNotificationPermissions&quot;, removeAllWebNotificationPermissionsCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2272         { &quot;simulateWebNotificationClick&quot;, simulateWebNotificationClickCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2273         { &quot;failNextNewCodeBlock&quot;, failNextNewCodeBlock, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2274         { &quot;numberOfDFGCompiles&quot;, numberOfDFGCompiles, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2275         { &quot;neverInlineFunction&quot;, neverInlineFunction, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2276         { &quot;accummulateLogsForChannel&quot;, accummulateLogsForChannel, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2277         { &quot;runUIScript&quot;, runUIScriptCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2278         { &quot;imageCountInGeneralPasteboard&quot;, imageCountInGeneralPasteboardCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2279         { &quot;setSpellCheckerLoggingEnabled&quot;, setSpellCheckerLoggingEnabledCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2280         { &quot;setSpellCheckerResults&quot;, setSpellCheckerResultsCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2281         { &quot;setOpenPanelFiles&quot;, setOpenPanelFilesCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
<span class="line-added">2282 #if PLATFORM(IOS_FAMILY)</span>
<span class="line-added">2283         { &quot;setOpenPanelFilesMediaIcon&quot;, SetOpenPanelFilesMediaIconCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },</span>
<span class="line-added">2284 #endif</span>
2285         { &quot;forceImmediateCompletion&quot;, forceImmediateCompletionCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2286         { 0, 0, 0 }
2287     };
2288 
2289     return staticFunctions;
2290 }
2291 
2292 void TestRunner::queueLoadHTMLString(JSStringRef content, JSStringRef baseURL)
2293 {
2294     DRT::WorkQueue::singleton().queue(new LoadHTMLStringItem(content, baseURL));
2295 }
2296 
2297 void TestRunner::queueLoadAlternateHTMLString(JSStringRef content, JSStringRef baseURL, JSStringRef unreachableURL)
2298 {
2299     DRT::WorkQueue::singleton().queue(new LoadHTMLStringItem(content, baseURL, unreachableURL));
2300 }
2301 
2302 void TestRunner::queueBackNavigation(int howFarBack)
2303 {
2304     DRT::WorkQueue::singleton().queue(new BackItem(howFarBack));
</pre>
<hr />
<pre>
2356     setlocale(LC_ALL, localeBuf);
2357 }
2358 
2359 void TestRunner::addURLToRedirect(std::string origin, std::string destination)
2360 {
2361     m_URLsToRedirect[origin] = destination;
2362 }
2363 
2364 const char* TestRunner::redirectionDestinationForURL(const char* origin)
2365 {
2366     if (!origin)
2367         return nullptr;
2368 
2369     auto iterator = m_URLsToRedirect.find(origin);
2370     if (iterator == m_URLsToRedirect.end())
2371         return nullptr;
2372 
2373     return iterator-&gt;second.data();
2374 }
2375 
<span class="line-added">2376 void TestRunner::setRenderTreeDumpOptions(unsigned options)</span>
<span class="line-added">2377 {</span>
<span class="line-added">2378     m_renderTreeDumpOptions = options;</span>
<span class="line-added">2379 }</span>
<span class="line-added">2380 </span>
2381 void TestRunner::setShouldPaintBrokenImage(bool shouldPaintBrokenImage)
2382 {
2383     m_shouldPaintBrokenImage = shouldPaintBrokenImage;
2384 }
2385 
2386 void TestRunner::setAccummulateLogsForChannel(JSStringRef channel)
2387 {
2388     size_t maxLength = JSStringGetMaximumUTF8CStringSize(channel);
<span class="line-modified">2389     auto buffer = makeUniqueArray&lt;char&gt;(maxLength + 1);</span>
2390     JSStringGetUTF8CString(channel, buffer.get(), maxLength + 1);
2391 
<span class="line-added">2392 #if OS(WINDOWS) &amp;&amp; PLATFORM(JAVA)</span>
<span class="line-added">2393     // FIXME : error LNK2019: unresolved external symbol</span>
<span class="line-added">2394     // WebCoreTestSupport::setLogChannelToAccumulate({ buffer.get() });</span>
<span class="line-added">2395 #else</span>
2396     WebCoreTestSupport::setLogChannelToAccumulate({ buffer.get() });
<span class="line-added">2397 #endif</span>
2398 }
2399 
2400 typedef WTF::HashMap&lt;unsigned, JSValueRef&gt; CallbackMap;
2401 static CallbackMap&amp; callbackMap()
2402 {
2403     static CallbackMap&amp; map = *new CallbackMap;
2404     return map;
2405 }
2406 
2407 void TestRunner::cacheTestRunnerCallback(unsigned index, JSValueRef callback)
2408 {
2409     if (!callback)
2410         return;
2411 
2412     if (callbackMap().contains(index)) {
2413         fprintf(stderr, &quot;FAIL: Tried to install a second TestRunner callback for the same event (id %d)\n&quot;, index);
2414         return;
2415     }
2416 
2417     JSContextRef context = mainFrameJSContext();
</pre>
<hr />
<pre>
2444 }
2445 
2446 enum {
2447     FirstUIScriptCallbackID = 100
2448 };
2449 
2450 static unsigned nextUIScriptCallbackID()
2451 {
2452     static unsigned callbackID = FirstUIScriptCallbackID;
2453     return callbackID++;
2454 }
2455 
2456 void TestRunner::runUIScript(JSContextRef context, JSStringRef script, JSValueRef callback)
2457 {
2458     m_pendingUIScriptInvocationData = nullptr;
2459 
2460     unsigned callbackID = nextUIScriptCallbackID();
2461     cacheTestRunnerCallback(callbackID, callback);
2462 
2463     if (!m_UIScriptContext)
<span class="line-modified">2464         m_UIScriptContext = makeUniqueWithoutFastMallocCheck&lt;WTR::UIScriptContext&gt;(*this);</span>
2465 
2466     String scriptString(JSStringGetCharactersPtr(script), JSStringGetLength(script));
2467     m_UIScriptContext-&gt;runUIScript(scriptString, callbackID);
2468 }
2469 
2470 void TestRunner::callUIScriptCallback(unsigned callbackID, JSStringRef result)
2471 {
2472     JSRetainPtr&lt;JSStringRef&gt; protectedResult(result);
2473 #if !PLATFORM(IOS_FAMILY)
2474     RunLoop::main().dispatch([protectedThis = makeRef(*this), callbackID, protectedResult]() mutable {
2475         JSContextRef context = protectedThis-&gt;mainFrameJSContext();
2476         JSValueRef resultValue = JSValueMakeString(context, protectedResult.get());
2477         protectedThis-&gt;callTestRunnerCallback(callbackID, 1, &amp;resultValue);
2478     });
2479 #else
2480     WebThreadRun(
2481         makeBlockPtr([protectedThis = makeRef(*this), callbackID, protectedResult] {
2482             JSContextRef context = protectedThis-&gt;mainFrameJSContext();
2483             JSValueRef resultValue = JSValueMakeString(context, protectedResult.get());
2484             protectedThis-&gt;callTestRunnerCallback(callbackID, 1, &amp;resultValue);
2485         }).get()
2486     );
2487 #endif
2488 }
2489 
2490 void TestRunner::uiScriptDidComplete(const String&amp; result, unsigned callbackID)
2491 {
2492     auto stringRef = adopt(JSStringCreateWithUTF8CString(result.utf8().data()));
2493     callUIScriptCallback(callbackID, stringRef.get());
2494 }
2495 
2496 void TestRunner::setAllowsAnySSLCertificate(bool allowsAnySSLCertificate)
2497 {
<span class="line-added">2498 #if OS(WINDOWS) &amp;&amp; PLATFORM(JAVA)</span>
<span class="line-added">2499     // FIXME : error LNK2019: unresolved external symbol</span>
<span class="line-added">2500     // WebCoreTestSupport::setAllowsAnySSLCertificate(allowsAnySSLCertificate);</span>
<span class="line-added">2501 #else</span>
2502     WebCoreTestSupport::setAllowsAnySSLCertificate(allowsAnySSLCertificate);
<span class="line-added">2503 #endif</span>
2504 }
2505 
2506 void TestRunner::setOpenPanelFiles(JSContextRef context, JSValueRef filesValue)
2507 {
2508     if (!JSValueIsArray(context, filesValue))
2509         return;
2510 
2511     JSObjectRef files = JSValueToObject(context, filesValue, nullptr);
2512     static auto lengthProperty = adopt(JSStringCreateWithUTF8CString(&quot;length&quot;));
2513     JSValueRef filesLengthValue = JSObjectGetProperty(context, files, lengthProperty.get(), nullptr);
2514     if (!JSValueIsNumber(context, filesLengthValue))
2515         return;
2516 
2517     m_openPanelFiles.clear();
2518     auto filesLength = static_cast&lt;size_t&gt;(JSValueToNumber(context, filesLengthValue, nullptr));
2519     for (size_t i = 0; i &lt; filesLength; ++i) {
2520         JSValueRef fileValue = JSObjectGetPropertyAtIndex(context, files, i, nullptr);
2521         if (!JSValueIsString(context, fileValue))
2522             continue;
2523 
2524         auto file = adopt(JSValueToStringCopy(context, fileValue, nullptr));
2525         size_t fileBufferSize = JSStringGetMaximumUTF8CStringSize(file.get()) + 1;
<span class="line-modified">2526         auto fileBuffer = makeUniqueArray&lt;char&gt;(fileBufferSize);</span>
2527         JSStringGetUTF8CString(file.get(), fileBuffer.get(), fileBufferSize);
2528 
2529         m_openPanelFiles.push_back(fileBuffer.get());
2530     }
2531 }
2532 
<span class="line-added">2533 #if PLATFORM(IOS_FAMILY)</span>
<span class="line-added">2534 void TestRunner::setOpenPanelFilesMediaIcon(JSContextRef context, JSValueRef mediaIcon)</span>
<span class="line-added">2535 {</span>
<span class="line-added">2536     // FIXME (123058): Use a JSC API to get buffer contents once such is exposed.</span>
<span class="line-added">2537     JSC::VM&amp; vm = toJS(context)-&gt;vm();</span>
<span class="line-added">2538     JSC::JSLockHolder lock(vm);</span>
<span class="line-added">2539 </span>
<span class="line-added">2540     JSC::JSArrayBufferView* jsBufferView = JSC::jsDynamicCast&lt;JSC::JSArrayBufferView*&gt;(vm, toJS(toJS(context), mediaIcon));</span>
<span class="line-added">2541     ASSERT(jsBufferView);</span>
<span class="line-added">2542     RefPtr&lt;JSC::ArrayBufferView&gt; bufferView = jsBufferView-&gt;unsharedImpl();</span>
<span class="line-added">2543     const char* buffer = static_cast&lt;const char*&gt;(bufferView-&gt;baseAddress());</span>
<span class="line-added">2544     std::vector&lt;char&gt; mediaIconData(buffer, buffer + bufferView-&gt;byteLength());</span>
<span class="line-added">2545 </span>
<span class="line-added">2546     m_openPanelFilesMediaIcon = mediaIconData;</span>
<span class="line-added">2547 }</span>
<span class="line-added">2548 #endif</span>
<span class="line-added">2549 </span>
2550 void TestRunner::cleanup()
2551 {
2552     clearTestRunnerCallbacks();
2553 }
</pre>
</td>
</tr>
</table>
<center><a href="TestOptions.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../index.html" target="_top">index</a> <a href="TestRunner.h.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>