<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames modules/javafx.web/src/main/native/Source/WebCore/platform/graphics/texmap/coordinated/CoordinatedGraphicsLayer.h</title>
    <link rel="stylesheet" href="../../../../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
  2  Copyright (C) 2010 Nokia Corporation and/or its subsidiary(-ies)
  3 
  4  This library is free software; you can redistribute it and/or
  5  modify it under the terms of the GNU Library General Public
  6  License as published by the Free Software Foundation; either
  7  version 2 of the License, or (at your option) any later version.
  8 
  9  This library is distributed in the hope that it will be useful,
 10  but WITHOUT ANY WARRANTY; without even the implied warranty of
 11  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 12  Library General Public License for more details.
 13 
 14  You should have received a copy of the GNU Library General Public License
 15  along with this library; see the file COPYING.LIB.  If not, write to
 16  the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor,
 17  Boston, MA 02110-1301, USA.
 18  */
 19 
 20 
 21 #ifndef CoordinatedGraphicsLayer_h
 22 #define CoordinatedGraphicsLayer_h
 23 
 24 #if USE(COORDINATED_GRAPHICS)
 25 
 26 #include &quot;CoordinatedGraphicsState.h&quot;
 27 #include &quot;FloatPoint3D.h&quot;
 28 #include &quot;GraphicsLayer.h&quot;
 29 #include &quot;GraphicsLayerTransform.h&quot;
 30 #include &quot;Image.h&quot;
 31 #include &quot;IntSize.h&quot;
 32 #include &quot;NicosiaAnimatedBackingStoreClient.h&quot;
<a name="1" id="anc1"></a>
 33 #include &quot;NicosiaBuffer.h&quot;
 34 #include &quot;NicosiaPlatformLayer.h&quot;
<a name="2" id="anc2"></a><span class="line-removed"> 35 #include &quot;TextureMapperAnimation.h&quot;</span>
 36 #include &quot;TransformationMatrix.h&quot;
 37 #include &lt;wtf/RunLoop.h&gt;
 38 #include &lt;wtf/text/StringHash.h&gt;
 39 
 40 namespace Nicosia {
<a name="3" id="anc3"></a>
 41 class PaintingEngine;
 42 }
 43 
 44 namespace WebCore {
 45 class CoordinatedGraphicsLayer;
<a name="4" id="anc4"></a><span class="line-removed"> 46 class TextureMapperAnimations;</span>
 47 
 48 class CoordinatedGraphicsLayerClient {
 49 public:
 50     virtual bool isFlushingLayerChanges() const = 0;
 51     virtual FloatRect visibleContentsRect() const = 0;
 52     virtual void detachLayer(CoordinatedGraphicsLayer*) = 0;
 53     virtual void attachLayer(CoordinatedGraphicsLayer*) = 0;
 54     virtual Nicosia::PaintingEngine&amp; paintingEngine() = 0;
 55     virtual void syncLayerState() = 0;
 56 };
 57 
 58 class WEBCORE_EXPORT CoordinatedGraphicsLayer : public GraphicsLayer {
 59 public:
 60     explicit CoordinatedGraphicsLayer(Type, GraphicsLayerClient&amp;);
 61     virtual ~CoordinatedGraphicsLayer();
 62 
 63     // FIXME: Merge these two methods.
 64     Nicosia::PlatformLayer::LayerID id() const;
 65     PlatformLayerID primaryLayerID() const override;
 66 
 67     // Reimplementations from GraphicsLayer.h.
 68     bool setChildren(Vector&lt;Ref&lt;GraphicsLayer&gt;&gt;&amp;&amp;) override;
 69     void addChild(Ref&lt;GraphicsLayer&gt;&amp;&amp;) override;
 70     void addChildAtIndex(Ref&lt;GraphicsLayer&gt;&amp;&amp;, int) override;
 71     void addChildAbove(Ref&lt;GraphicsLayer&gt;&amp;&amp;, GraphicsLayer*) override;
 72     void addChildBelow(Ref&lt;GraphicsLayer&gt;&amp;&amp;, GraphicsLayer*) override;
 73     bool replaceChild(GraphicsLayer*, Ref&lt;GraphicsLayer&gt;&amp;&amp;) override;
 74     void removeFromParent() override;
 75     void setPosition(const FloatPoint&amp;) override;
 76     void setAnchorPoint(const FloatPoint3D&amp;) override;
 77     void setSize(const FloatSize&amp;) override;
 78     void setTransform(const TransformationMatrix&amp;) override;
 79     void setChildrenTransform(const TransformationMatrix&amp;) override;
 80     void setPreserves3D(bool) override;
 81     void setMasksToBounds(bool) override;
 82     void setDrawsContent(bool) override;
 83     void setContentsVisible(bool) override;
 84     void setContentsOpaque(bool) override;
 85     void setBackfaceVisibility(bool) override;
 86     void setOpacity(float) override;
 87     void setContentsRect(const FloatRect&amp;) override;
 88     void setContentsTilePhase(const FloatSize&amp;) override;
 89     void setContentsTileSize(const FloatSize&amp;) override;
 90     void setContentsToImage(Image*) override;
 91     void setContentsToSolidColor(const Color&amp;) override;
 92     void setShowDebugBorder(bool) override;
 93     void setShowRepaintCounter(bool) override;
 94     bool shouldDirectlyCompositeImage(Image*) const override;
 95     void setContentsToPlatformLayer(PlatformLayer*, ContentsLayerPurpose) override;
 96     void setMaskLayer(RefPtr&lt;GraphicsLayer&gt;&amp;&amp;) override;
 97     void setReplicatedByLayer(RefPtr&lt;GraphicsLayer&gt;&amp;&amp;) override;
 98     void setNeedsDisplay() override;
 99     void setNeedsDisplayInRect(const FloatRect&amp;, ShouldClipToLayer = ClipToLayer) override;
100     void setContentsNeedsDisplay() override;
101     void deviceOrPageScaleFactorChanged() override;
102     void flushCompositingState(const FloatRect&amp;) override;
103     void flushCompositingStateForThisLayerOnly() override;
104     bool setFilters(const FilterOperations&amp;) override;
105     bool addAnimation(const KeyframeValueList&amp;, const FloatSize&amp;, const Animation*, const String&amp;, double) override;
106     void pauseAnimation(const String&amp;, double) override;
107     void removeAnimation(const String&amp;) override;
108     void suspendAnimations(MonotonicTime) override;
109     void resumeAnimations() override;
110     bool usesContentsLayer() const override;
111 
112     void syncPendingStateChangesIncludingSubLayers();
113     void updateContentBuffersIncludingSubLayers();
114 
115     FloatPoint computePositionRelativeToBase();
116     void computePixelAlignment(FloatPoint&amp; position, FloatSize&amp;, FloatPoint3D&amp; anchorPoint, FloatSize&amp; alignmentOffset);
117 
118     IntRect transformedVisibleRect();
119 
120     void setCoordinator(CoordinatedGraphicsLayerClient*);
121     void setCoordinatorIncludingSubLayersIfNeeded(CoordinatedGraphicsLayerClient*);
122 
123     void setNeedsVisibleRectAdjustment();
124     void purgeBackingStores();
125 
126     const RefPtr&lt;Nicosia::CompositionLayer&gt;&amp; compositionLayer() const;
127 
128     class AnimatedBackingStoreHost : public ThreadSafeRefCounted&lt;AnimatedBackingStoreHost&gt; {
129     public:
130         static Ref&lt;AnimatedBackingStoreHost&gt; create(CoordinatedGraphicsLayer&amp; layer)
131         {
132             return adoptRef(*new AnimatedBackingStoreHost(layer));
133         }
134 
135         void requestBackingStoreUpdate()
136         {
137             if (m_layer)
138                 m_layer-&gt;requestBackingStoreUpdate();
139         }
140 
141         void layerWillBeDestroyed() { m_layer = nullptr; }
142     private:
143         explicit AnimatedBackingStoreHost(CoordinatedGraphicsLayer&amp; layer)
144             : m_layer(&amp;layer)
145         { }
146 
147         CoordinatedGraphicsLayer* m_layer;
148     };
149 
150     void requestBackingStoreUpdate();
151 
152 private:
<a name="5" id="anc5"></a><span class="line-modified">153     bool isCoordinatedGraphicsLayer() const;</span>
154 
155     void updatePlatformLayer();
156 
157     void setDebugBorder(const Color&amp;, float width) override;
158 
159     void didChangeAnimations();
160     void didChangeGeometry();
161     void didChangeChildren();
162     void didChangeFilters();
163     void didUpdateTileBuffers();
164 
165     void computeTransformedVisibleRect();
166     void updateContentBuffers();
167 
168     void notifyFlushRequired();
169 
170     bool shouldHaveBackingStore() const;
171     bool selfOrAncestorHasActiveTransformAnimation() const;
172     bool selfOrAncestorHaveNonAffineTransforms();
173 
174     void setShouldUpdateVisibleRect();
175     float effectiveContentsScale();
176 
177     void animationStartedTimerFired();
178     void requestPendingTileCreationTimerFired();
179 
180     bool filtersCanBeComposited(const FilterOperations&amp;) const;
181 
182     Nicosia::PlatformLayer::LayerID m_id;
183     GraphicsLayerTransform m_layerTransform;
184     TransformationMatrix m_cachedInverseTransform;
185     FloatSize m_pixelAlignmentOffset;
186     FloatSize m_adjustedSize;
187     FloatPoint m_adjustedPosition;
188     FloatPoint3D m_adjustedAnchorPoint;
189 
190     Color m_solidColor;
191 
192 #ifndef NDEBUG
193     bool m_isPurging;
194 #endif
195     bool m_shouldUpdateVisibleRect: 1;
<a name="6" id="anc6"></a><span class="line-removed">196     bool m_shouldSyncLayerState: 1;</span>
197     bool m_movingVisibleRect : 1;
198     bool m_pendingContentsScaleAdjustment : 1;
199     bool m_pendingVisibleRectAdjustment : 1;
200     bool m_shouldUpdatePlatformLayer : 1;
201 
202     CoordinatedGraphicsLayerClient* m_coordinator;
203 
204     struct {
205         bool completeLayer { false };
206         Vector&lt;FloatRect, 32&gt; rects;
207     } m_needsDisplay;
208 
209     RefPtr&lt;Image&gt; m_compositedImage;
210     NativeImagePtr m_compositedNativeImagePtr;
211 
212     Timer m_animationStartedTimer;
213     RunLoop::Timer&lt;CoordinatedGraphicsLayer&gt; m_requestPendingTileCreationTimer;
<a name="7" id="anc7"></a><span class="line-modified">214     TextureMapperAnimations m_animations;</span>
215     MonotonicTime m_lastAnimationStartTime;
216 
217     struct {
218         RefPtr&lt;Nicosia::CompositionLayer&gt; layer;
219         Nicosia::CompositionLayer::LayerState::Delta delta;
220         Nicosia::CompositionLayer::LayerState::RepaintCounter repaintCounter;
221         Nicosia::CompositionLayer::LayerState::DebugBorder debugBorder;
222         bool performLayerSync { false };
223 
224         RefPtr&lt;Nicosia::BackingStore&gt; backingStore;
225         RefPtr&lt;Nicosia::ContentLayer&gt; contentLayer;
226         RefPtr&lt;Nicosia::ImageBacking&gt; imageBacking;
227         RefPtr&lt;Nicosia::AnimatedBackingStoreClient&gt; animatedBackingStoreClient;
228     } m_nicosia;
229 
230     RefPtr&lt;AnimatedBackingStoreHost&gt; m_animatedBackingStoreHost;
231 };
232 
233 } // namespace WebCore
234 
235 SPECIALIZE_TYPE_TRAITS_GRAPHICSLAYER(WebCore::CoordinatedGraphicsLayer, isCoordinatedGraphicsLayer())
236 
237 #endif // USE(COORDINATED_GRAPHICS)
238 
239 #endif // CoordinatedGraphicsLayer_h
<a name="8" id="anc8"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="8" type="hidden" />
</body>
</html>