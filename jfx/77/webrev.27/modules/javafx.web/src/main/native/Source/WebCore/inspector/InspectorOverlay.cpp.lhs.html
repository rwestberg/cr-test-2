<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames modules/javafx.web/src/main/native/Source/WebCore/inspector/InspectorOverlay.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
  2  * Copyright (C) 2011 Google Inc. All rights reserved.
<a name="1" id="anc1"></a>
  3  *
  4  * Redistribution and use in source and binary forms, with or without
  5  * modification, are permitted provided that the following conditions
  6  * are met:
  7  *
  8  * 1.  Redistributions of source code must retain the above copyright
  9  *     notice, this list of conditions and the following disclaimer.
 10  * 2.  Redistributions in binary form must reproduce the above copyright
 11  *     notice, this list of conditions and the following disclaimer in the
 12  *     documentation and/or other materials provided with the distribution.
 13  * 3.  Neither the name of Apple Inc. (&quot;Apple&quot;) nor the names of
 14  *     its contributors may be used to endorse or promote products derived
 15  *     from this software without specific prior written permission.
 16  *
 17  * THIS SOFTWARE IS PROVIDED BY APPLE AND ITS CONTRIBUTORS &quot;AS IS&quot; AND ANY
 18  * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
 19  * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
 20  * DISCLAIMED. IN NO EVENT SHALL APPLE OR ITS CONTRIBUTORS BE LIABLE FOR ANY
 21  * DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
 22  * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
 23  * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
 24  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 25  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF
 26  * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 27  */
 28 
 29 #include &quot;config.h&quot;
 30 #include &quot;InspectorOverlay.h&quot;
 31 
<a name="2" id="anc2"></a><span class="line-modified"> 32 #include &quot;CacheStorageProvider.h&quot;</span>
<span class="line-modified"> 33 #include &quot;DocumentLoader.h&quot;</span>
<span class="line-modified"> 34 #include &quot;EditorClient.h&quot;</span>

 35 #include &quot;Element.h&quot;
<a name="3" id="anc3"></a><span class="line-modified"> 36 #include &quot;EmptyClients.h&quot;</span>




 37 #include &quot;Frame.h&quot;
 38 #include &quot;FrameView.h&quot;
 39 #include &quot;GraphicsContext.h&quot;
 40 #include &quot;InspectorClient.h&quot;
<a name="4" id="anc4"></a><span class="line-modified"> 41 #include &quot;InspectorOverlayPage.h&quot;</span>
<span class="line-modified"> 42 #include &quot;LibWebRTCProvider.h&quot;</span>

 43 #include &quot;Node.h&quot;
<a name="5" id="anc5"></a>
 44 #include &quot;Page.h&quot;
<a name="6" id="anc6"></a><span class="line-removed"> 45 #include &quot;PageConfiguration.h&quot;</span>
<span class="line-removed"> 46 #include &quot;PolygonShape.h&quot;</span>
 47 #include &quot;PseudoElement.h&quot;
<a name="7" id="anc7"></a><span class="line-modified"> 48 #include &quot;RTCController.h&quot;</span>
<span class="line-removed"> 49 #include &quot;RectangleShape.h&quot;</span>
 50 #include &quot;RenderBoxModelObject.h&quot;
<a name="8" id="anc8"></a><span class="line-removed"> 51 #include &quot;RenderElement.h&quot;</span>
 52 #include &quot;RenderInline.h&quot;
<a name="9" id="anc9"></a><span class="line-modified"> 53 #include &quot;RenderView.h&quot;</span>
<span class="line-removed"> 54 #include &quot;ScriptController.h&quot;</span>
<span class="line-removed"> 55 #include &quot;ScriptSourceCode.h&quot;</span>
 56 #include &quot;Settings.h&quot;
<a name="10" id="anc10"></a><span class="line-modified"> 57 #include &quot;SocketProvider.h&quot;</span>
<span class="line-modified"> 58 #include &quot;StyledElement.h&quot;</span>
<span class="line-removed"> 59 #include &lt;JavaScriptCore/InspectorProtocolObjects.h&gt;</span>
<span class="line-removed"> 60 #include &lt;wtf/JSONValues.h&gt;</span>
<span class="line-removed"> 61 </span>
<span class="line-removed"> 62 #if PLATFORM(MAC)</span>
<span class="line-removed"> 63 #include &quot;LocalDefaultSystemAppearance.h&quot;</span>
<span class="line-removed"> 64 #endif</span>
 65 
 66 namespace WebCore {
 67 
 68 using namespace Inspector;
 69 
<a name="11" id="anc11"></a>


























 70 static void contentsQuadToCoordinateSystem(const FrameView* mainView, const FrameView* view, FloatQuad&amp; quad, InspectorOverlay::CoordinateSystem coordinateSystem)
 71 {
<a name="12" id="anc12"></a><span class="line-modified"> 72     quad.setP1(view-&gt;contentsToRootView(roundedIntPoint(quad.p1())));</span>
<span class="line-modified"> 73     quad.setP2(view-&gt;contentsToRootView(roundedIntPoint(quad.p2())));</span>
<span class="line-modified"> 74     quad.setP3(view-&gt;contentsToRootView(roundedIntPoint(quad.p3())));</span>
<span class="line-modified"> 75     quad.setP4(view-&gt;contentsToRootView(roundedIntPoint(quad.p4())));</span>
 76 
 77     if (coordinateSystem == InspectorOverlay::CoordinateSystem::View)
 78         quad += toIntSize(mainView-&gt;scrollPosition());
 79 }
 80 
<a name="13" id="anc13"></a><span class="line-modified"> 81 static void contentsQuadToPage(const FrameView* mainView, const FrameView* view, FloatQuad&amp; quad)</span>
 82 {
<a name="14" id="anc14"></a><span class="line-modified"> 83     contentsQuadToCoordinateSystem(mainView, view, quad, InspectorOverlay::CoordinateSystem::View);</span>










 84 }
 85 
 86 static void buildRendererHighlight(RenderObject* renderer, const HighlightConfig&amp; highlightConfig, Highlight&amp; highlight, InspectorOverlay::CoordinateSystem coordinateSystem)
 87 {
 88     Frame* containingFrame = renderer-&gt;document().frame();
 89     if (!containingFrame)
 90         return;
 91 
 92     highlight.setDataFromConfig(highlightConfig);
 93     FrameView* containingView = containingFrame-&gt;view();
 94     FrameView* mainView = containingFrame-&gt;page()-&gt;mainFrame().view();
 95 
 96     // RenderSVGRoot should be highlighted through the isBox() code path, all other SVG elements should just dump their absoluteQuads().
 97     bool isSVGRenderer = renderer-&gt;node() &amp;&amp; renderer-&gt;node()-&gt;isSVGElement() &amp;&amp; !renderer-&gt;isSVGRoot();
 98 
 99     if (isSVGRenderer) {
100         highlight.type = HighlightType::Rects;
101         renderer-&gt;absoluteQuads(highlight.quads);
102         for (auto&amp; quad : highlight.quads)
103             contentsQuadToCoordinateSystem(mainView, containingView, quad, coordinateSystem);
104     } else if (is&lt;RenderBox&gt;(*renderer) || is&lt;RenderInline&gt;(*renderer)) {
105         LayoutRect contentBox;
106         LayoutRect paddingBox;
107         LayoutRect borderBox;
108         LayoutRect marginBox;
109 
110         if (is&lt;RenderBox&gt;(*renderer)) {
111             auto&amp; renderBox = downcast&lt;RenderBox&gt;(*renderer);
112 
113             LayoutBoxExtent margins(renderBox.marginTop(), renderBox.marginRight(), renderBox.marginBottom(), renderBox.marginLeft());
114             paddingBox = renderBox.clientBoxRect();
115             contentBox = LayoutRect(paddingBox.x() + renderBox.paddingLeft(), paddingBox.y() + renderBox.paddingTop(),
116                 paddingBox.width() - renderBox.paddingLeft() - renderBox.paddingRight(), paddingBox.height() - renderBox.paddingTop() - renderBox.paddingBottom());
117             borderBox = LayoutRect(paddingBox.x() - renderBox.borderLeft(), paddingBox.y() - renderBox.borderTop(),
118                 paddingBox.width() + renderBox.borderLeft() + renderBox.borderRight(), paddingBox.height() + renderBox.borderTop() + renderBox.borderBottom());
119             marginBox = LayoutRect(borderBox.x() - margins.left(), borderBox.y() - margins.top(),
120                 borderBox.width() + margins.left() + margins.right(), borderBox.height() + margins.top() + margins.bottom());
121         } else {
122             auto&amp; renderInline = downcast&lt;RenderInline&gt;(*renderer);
123 
124             // RenderInline&#39;s bounding box includes paddings and borders, excludes margins.
125             borderBox = renderInline.linesBoundingBox();
126             paddingBox = LayoutRect(borderBox.x() + renderInline.borderLeft(), borderBox.y() + renderInline.borderTop(),
127                 borderBox.width() - renderInline.borderLeft() - renderInline.borderRight(), borderBox.height() - renderInline.borderTop() - renderInline.borderBottom());
128             contentBox = LayoutRect(paddingBox.x() + renderInline.paddingLeft(), paddingBox.y() + renderInline.paddingTop(),
129                 paddingBox.width() - renderInline.paddingLeft() - renderInline.paddingRight(), paddingBox.height() - renderInline.paddingTop() - renderInline.paddingBottom());
130             // Ignore marginTop and marginBottom for inlines.
131             marginBox = LayoutRect(borderBox.x() - renderInline.marginLeft(), borderBox.y(),
132                 borderBox.width() + renderInline.horizontalMarginExtent(), borderBox.height());
133         }
134 
135         FloatQuad absContentQuad = renderer-&gt;localToAbsoluteQuad(FloatRect(contentBox));
136         FloatQuad absPaddingQuad = renderer-&gt;localToAbsoluteQuad(FloatRect(paddingBox));
137         FloatQuad absBorderQuad = renderer-&gt;localToAbsoluteQuad(FloatRect(borderBox));
138         FloatQuad absMarginQuad = renderer-&gt;localToAbsoluteQuad(FloatRect(marginBox));
139 
140         contentsQuadToCoordinateSystem(mainView, containingView, absContentQuad, coordinateSystem);
141         contentsQuadToCoordinateSystem(mainView, containingView, absPaddingQuad, coordinateSystem);
142         contentsQuadToCoordinateSystem(mainView, containingView, absBorderQuad, coordinateSystem);
143         contentsQuadToCoordinateSystem(mainView, containingView, absMarginQuad, coordinateSystem);
144 
145         highlight.type = HighlightType::Node;
146         highlight.quads.append(absMarginQuad);
147         highlight.quads.append(absBorderQuad);
148         highlight.quads.append(absPaddingQuad);
149         highlight.quads.append(absContentQuad);
150     }
151 }
152 
153 static void buildNodeHighlight(Node&amp; node, const HighlightConfig&amp; highlightConfig, Highlight&amp; highlight, InspectorOverlay::CoordinateSystem coordinateSystem)
154 {
155     RenderObject* renderer = node.renderer();
156     if (!renderer)
157         return;
158 
159     buildRendererHighlight(renderer, highlightConfig, highlight, coordinateSystem);
160 }
161 
162 static void buildQuadHighlight(const FloatQuad&amp; quad, const HighlightConfig&amp; highlightConfig, Highlight&amp; highlight)
163 {
164     highlight.setDataFromConfig(highlightConfig);
165     highlight.type = HighlightType::Rects;
166     highlight.quads.append(quad);
167 }
168 
<a name="15" id="anc15"></a>































































































































































169 InspectorOverlay::InspectorOverlay(Page&amp; page, InspectorClient* client)
170     : m_page(page)
171     , m_client(client)
172     , m_paintRectUpdateTimer(*this, &amp;InspectorOverlay::updatePaintRectsTimerFired)
173 {
174 }
175 
176 InspectorOverlay::~InspectorOverlay() = default;
177 
178 void InspectorOverlay::paint(GraphicsContext&amp; context)
179 {
180     if (!shouldShowOverlay())
181         return;
182 
<a name="16" id="anc16"></a><span class="line-modified">183     Page* overlayPage = this-&gt;overlayPage();</span>
<span class="line-modified">184     if (!overlayPage)</span>
<span class="line-modified">185         return;</span>
186 
187     GraphicsContextStateSaver stateSaver(context);
<a name="17" id="anc17"></a><span class="line-removed">188     FrameView* view = overlayPage-&gt;mainFrame().view();</span>
189 
<a name="18" id="anc18"></a><span class="line-modified">190 #if PLATFORM(MAC)</span>
<span class="line-modified">191     LocalDefaultSystemAppearance localAppearance(view-&gt;useDarkAppearance());</span>
<span class="line-modified">192 #endif</span>





























193 
<a name="19" id="anc19"></a><span class="line-modified">194     view-&gt;updateLayoutAndStyleIfNeededRecursive();</span>
<span class="line-modified">195     view-&gt;paint(context, IntRect(0, 0, view-&gt;width(), view-&gt;height()));</span>
196 }
197 
198 void InspectorOverlay::getHighlight(Highlight&amp; highlight, InspectorOverlay::CoordinateSystem coordinateSystem) const
199 {
200     if (!m_highlightNode &amp;&amp; !m_highlightQuad &amp;&amp; !m_highlightNodeList)
201         return;
202 
203     highlight.type = HighlightType::Rects;
204     if (m_highlightNode)
205         buildNodeHighlight(*m_highlightNode, m_nodeHighlightConfig, highlight, coordinateSystem);
206     else if (m_highlightNodeList) {
207         highlight.setDataFromConfig(m_nodeHighlightConfig);
208         for (unsigned i = 0; i &lt; m_highlightNodeList-&gt;length(); ++i) {
209             Highlight nodeHighlight;
210             buildNodeHighlight(*(m_highlightNodeList-&gt;item(i)), m_nodeHighlightConfig, nodeHighlight, coordinateSystem);
211             if (nodeHighlight.type == HighlightType::Node)
212                 highlight.quads.appendVector(nodeHighlight.quads);
213         }
214         highlight.type = HighlightType::NodeList;
215     } else
216         buildQuadHighlight(*m_highlightQuad, m_quadHighlightConfig, highlight);
217 }
218 
<a name="20" id="anc20"></a><span class="line-removed">219 void InspectorOverlay::setPausedInDebuggerMessage(const String* message)</span>
<span class="line-removed">220 {</span>
<span class="line-removed">221     m_pausedInDebuggerMessage = message ? *message : String();</span>
<span class="line-removed">222     update();</span>
<span class="line-removed">223 }</span>
<span class="line-removed">224 </span>
225 void InspectorOverlay::hideHighlight()
226 {
227     m_highlightNode = nullptr;
228     m_highlightNodeList = nullptr;
229     m_highlightQuad = nullptr;
230     update();
231 }
232 
233 void InspectorOverlay::highlightNodeList(RefPtr&lt;NodeList&gt;&amp;&amp; nodes, const HighlightConfig&amp; highlightConfig)
234 {
235     m_nodeHighlightConfig = highlightConfig;
236     m_highlightNodeList = WTFMove(nodes);
237     m_highlightNode = nullptr;
238     update();
239 }
240 
241 void InspectorOverlay::highlightNode(Node* node, const HighlightConfig&amp; highlightConfig)
242 {
243     m_nodeHighlightConfig = highlightConfig;
244     m_highlightNode = node;
245     m_highlightNodeList = nullptr;
246     update();
247 }
248 
249 void InspectorOverlay::highlightQuad(std::unique_ptr&lt;FloatQuad&gt; quad, const HighlightConfig&amp; highlightConfig)
250 {
251     if (highlightConfig.usePageCoordinates)
252         *quad -= toIntSize(m_page.mainFrame().view()-&gt;scrollPosition());
253 
254     m_quadHighlightConfig = highlightConfig;
255     m_highlightQuad = WTFMove(quad);
256     update();
257 }
258 
259 Node* InspectorOverlay::highlightedNode() const
260 {
261     return m_highlightNode.get();
262 }
263 
264 void InspectorOverlay::didSetSearchingForNode(bool enabled)
265 {
266     m_client-&gt;didSetSearchingForNode(enabled);
267 }
268 
269 void InspectorOverlay::setIndicating(bool indicating)
270 {
<a name="21" id="anc21"></a><span class="line-modified">271     m_indicating = indicating;</span>

272 
<a name="22" id="anc22"></a><span class="line-modified">273     if (m_indicating)</span>
<span class="line-removed">274         evaluateInOverlay(&quot;showPageIndication&quot;_s);</span>
<span class="line-removed">275     else</span>
<span class="line-removed">276         evaluateInOverlay(&quot;hidePageIndication&quot;_s);</span>
277 
278     update();
279 }
280 
281 bool InspectorOverlay::shouldShowOverlay() const
282 {
<a name="23" id="anc23"></a><span class="line-modified">283     return m_highlightNode || m_highlightNodeList || m_highlightQuad || m_indicating || m_showingPaintRects || m_showRulers || !m_pausedInDebuggerMessage.isNull();</span>


284 }
285 
286 void InspectorOverlay::update()
287 {
288     if (!shouldShowOverlay()) {
289         m_client-&gt;hideHighlight();
290         return;
291     }
292 
293     FrameView* view = m_page.mainFrame().view();
294     if (!view)
295         return;
296 
<a name="24" id="anc24"></a><span class="line-modified">297     Page* overlayPage = this-&gt;overlayPage();</span>
<span class="line-removed">298     if (overlayPage) {</span>
<span class="line-removed">299         FrameView* overlayView = overlayPage-&gt;mainFrame().view();</span>
<span class="line-removed">300         IntSize frameViewFullSize = view-&gt;sizeForVisibleContent(ScrollableArea::IncludeScrollbars);</span>
<span class="line-removed">301         overlayView-&gt;resize(frameViewFullSize);</span>
<span class="line-removed">302     }</span>
<span class="line-removed">303 </span>
<span class="line-removed">304     // Clear canvas and paint things.</span>
<span class="line-removed">305     IntSize viewportSize = view-&gt;sizeForVisibleContent();</span>
<span class="line-removed">306     IntPoint scrollOffset = view-&gt;scrollPosition();</span>
<span class="line-removed">307     reset(viewportSize, scrollOffset);</span>
<span class="line-removed">308 </span>
<span class="line-removed">309     // Include scrollbars to avoid masking them by the gutter.</span>
<span class="line-removed">310     drawNodeHighlight();</span>
<span class="line-removed">311     drawQuadHighlight();</span>
<span class="line-removed">312     drawPausedInDebuggerMessage();</span>
<span class="line-removed">313     drawPaintRects();</span>
<span class="line-removed">314 </span>
<span class="line-removed">315     if (m_showRulers)</span>
<span class="line-removed">316         drawRulers();</span>
<span class="line-removed">317 </span>
<span class="line-removed">318     // Position DOM elements.</span>
<span class="line-removed">319     if (overlayPage) {</span>
<span class="line-removed">320         overlayPage-&gt;mainFrame().document()-&gt;resolveStyle(Document::ResolveStyleType::Rebuild);</span>
<span class="line-removed">321         FrameView* overlayView = overlayPage-&gt;mainFrame().view();</span>
<span class="line-removed">322         if (overlayView-&gt;needsLayout())</span>
<span class="line-removed">323             overlayView-&gt;layoutContext().layout();</span>
<span class="line-removed">324     }</span>
<span class="line-removed">325 </span>
<span class="line-removed">326     forcePaint();</span>
<span class="line-removed">327 }</span>
<span class="line-removed">328 </span>
<span class="line-removed">329 static Ref&lt;Inspector::Protocol::OverlayTypes::Point&gt; buildObjectForPoint(const FloatPoint&amp; point)</span>
<span class="line-removed">330 {</span>
<span class="line-removed">331     return Inspector::Protocol::OverlayTypes::Point::create()</span>
<span class="line-removed">332         .setX(point.x())</span>
<span class="line-removed">333         .setY(point.y())</span>
<span class="line-removed">334         .release();</span>
<span class="line-removed">335 }</span>
<span class="line-removed">336 </span>
<span class="line-removed">337 static Ref&lt;Inspector::Protocol::OverlayTypes::Rect&gt; buildObjectForRect(const FloatRect&amp; rect)</span>
<span class="line-removed">338 {</span>
<span class="line-removed">339     return Inspector::Protocol::OverlayTypes::Rect::create()</span>
<span class="line-removed">340         .setX(rect.x())</span>
<span class="line-removed">341         .setY(rect.y())</span>
<span class="line-removed">342         .setWidth(rect.width())</span>
<span class="line-removed">343         .setHeight(rect.height())</span>
<span class="line-removed">344         .release();</span>
<span class="line-removed">345 }</span>
<span class="line-removed">346 </span>
<span class="line-removed">347 static Ref&lt;Inspector::Protocol::OverlayTypes::Quad&gt; buildArrayForQuad(const FloatQuad&amp; quad)</span>
<span class="line-removed">348 {</span>
<span class="line-removed">349     auto array = Inspector::Protocol::OverlayTypes::Quad::create();</span>
<span class="line-removed">350     array-&gt;addItem(buildObjectForPoint(quad.p1()));</span>
<span class="line-removed">351     array-&gt;addItem(buildObjectForPoint(quad.p2()));</span>
<span class="line-removed">352     array-&gt;addItem(buildObjectForPoint(quad.p3()));</span>
<span class="line-removed">353     array-&gt;addItem(buildObjectForPoint(quad.p4()));</span>
<span class="line-removed">354     return array;</span>
<span class="line-removed">355 }</span>
<span class="line-removed">356 </span>
<span class="line-removed">357 static Ref&lt;Inspector::Protocol::OverlayTypes::FragmentHighlightData&gt; buildObjectForHighlight(const Highlight&amp; highlight)</span>
<span class="line-removed">358 {</span>
<span class="line-removed">359     auto arrayOfQuads = JSON::ArrayOf&lt;Inspector::Protocol::OverlayTypes::Quad&gt;::create();</span>
<span class="line-removed">360     for (auto&amp; quad : highlight.quads)</span>
<span class="line-removed">361         arrayOfQuads-&gt;addItem(buildArrayForQuad(quad));</span>
<span class="line-removed">362 </span>
<span class="line-removed">363     return Inspector::Protocol::OverlayTypes::FragmentHighlightData::create()</span>
<span class="line-removed">364         .setQuads(WTFMove(arrayOfQuads))</span>
<span class="line-removed">365         .setContentColor(highlight.contentColor.serialized())</span>
<span class="line-removed">366         .setContentOutlineColor(highlight.contentOutlineColor.serialized())</span>
<span class="line-removed">367         .setPaddingColor(highlight.paddingColor.serialized())</span>
<span class="line-removed">368         .setBorderColor(highlight.borderColor.serialized())</span>
<span class="line-removed">369         .setMarginColor(highlight.marginColor.serialized())</span>
<span class="line-removed">370         .release();</span>
<span class="line-removed">371 }</span>
<span class="line-removed">372 </span>
<span class="line-removed">373 static Ref&lt;Inspector::Protocol::OverlayTypes::Size&gt; buildObjectForSize(const IntSize&amp; size)</span>
<span class="line-removed">374 {</span>
<span class="line-removed">375     return Inspector::Protocol::OverlayTypes::Size::create()</span>
<span class="line-removed">376         .setWidth(size.width())</span>
<span class="line-removed">377         .setHeight(size.height())</span>
<span class="line-removed">378         .release();</span>
379 }
380 
<a name="25" id="anc25"></a><span class="line-modified">381 void InspectorOverlay::setShowingPaintRects(bool showingPaintRects)</span>
382 {
<a name="26" id="anc26"></a><span class="line-modified">383     if (m_showingPaintRects == showingPaintRects)</span>
384         return;
385 
<a name="27" id="anc27"></a><span class="line-modified">386     m_showingPaintRects = showingPaintRects;</span>
<span class="line-modified">387     if (!m_showingPaintRects) {</span>
388         m_paintRects.clear();
389         m_paintRectUpdateTimer.stop();
<a name="28" id="anc28"></a><span class="line-modified">390         drawPaintRects();</span>
<span class="line-removed">391         forcePaint();</span>
392     }
393 }
394 
395 void InspectorOverlay::showPaintRect(const FloatRect&amp; rect)
396 {
<a name="29" id="anc29"></a><span class="line-modified">397     if (!m_showingPaintRects)</span>
398         return;
399 
400     IntRect rootRect = m_page.mainFrame().view()-&gt;contentsToRootView(enclosingIntRect(rect));
401 
402     const auto removeDelay = 250_ms;
403 
404     MonotonicTime removeTime = MonotonicTime::now() + removeDelay;
405     m_paintRects.append(TimeRectPair(removeTime, rootRect));
406 
407     if (!m_paintRectUpdateTimer.isActive()) {
408         const Seconds paintRectsUpdateInterval { 32_ms };
409         m_paintRectUpdateTimer.startRepeating(paintRectsUpdateInterval);
410     }
411 
<a name="30" id="anc30"></a><span class="line-modified">412     drawPaintRects();</span>
<span class="line-removed">413     forcePaint();</span>
414 }
415 
416 void InspectorOverlay::setShowRulers(bool showRulers)
417 {
418     if (m_showRulers == showRulers)
419         return;
420 
421     m_showRulers = showRulers;
422 
423     update();
424 }
425 
426 void InspectorOverlay::updatePaintRectsTimerFired()
427 {
428     MonotonicTime now = MonotonicTime::now();
429     bool rectsChanged = false;
430     while (!m_paintRects.isEmpty() &amp;&amp; m_paintRects.first().first &lt; now) {
431         m_paintRects.removeFirst();
432         rectsChanged = true;
433     }
434 
435     if (m_paintRects.isEmpty())
436         m_paintRectUpdateTimer.stop();
437 
<a name="31" id="anc31"></a><span class="line-modified">438     if (rectsChanged) {</span>
<span class="line-modified">439         drawPaintRects();</span>
<span class="line-removed">440         forcePaint();</span>
<span class="line-removed">441     }</span>
442 }
443 
<a name="32" id="anc32"></a><span class="line-modified">444 void InspectorOverlay::drawPaintRects()</span>
445 {
<a name="33" id="anc33"></a><span class="line-modified">446     auto arrayOfRects = JSON::ArrayOf&lt;Inspector::Protocol::OverlayTypes::Rect&gt;::create();</span>
<span class="line-removed">447     for (const auto&amp; pair : m_paintRects)</span>
<span class="line-removed">448         arrayOfRects-&gt;addItem(buildObjectForRect(pair.second));</span>
449 
<a name="34" id="anc34"></a><span class="line-modified">450     evaluateInOverlay(&quot;updatePaintRects&quot;_s, WTFMove(arrayOfRects));</span>
<span class="line-removed">451 }</span>
452 
<a name="35" id="anc35"></a><span class="line-modified">453 void InspectorOverlay::drawRulers()</span>
<span class="line-modified">454 {</span>
<span class="line-modified">455     evaluateInOverlay(&quot;drawRulers&quot;_s);</span>








456 }
457 
<a name="36" id="anc36"></a><span class="line-modified">458 static RefPtr&lt;JSON::ArrayOf&lt;Inspector::Protocol::OverlayTypes::FragmentHighlightData&gt;&gt; buildArrayForRendererFragments(RenderObject* renderer, const HighlightConfig&amp; config)</span>
459 {
<a name="37" id="anc37"></a><span class="line-modified">460     auto arrayOfFragments = JSON::ArrayOf&lt;Inspector::Protocol::OverlayTypes::FragmentHighlightData&gt;::create();</span>
461 
462     Highlight highlight;
<a name="38" id="anc38"></a><span class="line-modified">463     buildRendererHighlight(renderer, config, highlight, InspectorOverlay::CoordinateSystem::View);</span>
<span class="line-modified">464     arrayOfFragments-&gt;addItem(buildObjectForHighlight(highlight));</span>


465 
<a name="39" id="anc39"></a><span class="line-modified">466     return WTFMove(arrayOfFragments);</span>




467 }
468 
<a name="40" id="anc40"></a><span class="line-modified">469 static FloatPoint localPointToRoot(RenderObject* renderer, const FrameView* mainView, const FrameView* view, const FloatPoint&amp; point)</span>
470 {
<a name="41" id="anc41"></a><span class="line-modified">471     FloatPoint result = renderer-&gt;localToAbsolute(point);</span>
<span class="line-removed">472     result = view-&gt;contentsToRootView(roundedIntPoint(result));</span>
<span class="line-removed">473     result += toIntSize(mainView-&gt;scrollPosition());</span>
<span class="line-removed">474     return result;</span>
<span class="line-removed">475 }</span>
476 
<a name="42" id="anc42"></a><span class="line-modified">477 struct PathApplyInfo {</span>
<span class="line-modified">478     FrameView* rootView;</span>
<span class="line-removed">479     FrameView* view;</span>
<span class="line-removed">480     Inspector::Protocol::OverlayTypes::DisplayPath* pathArray;</span>
<span class="line-removed">481     RenderObject* renderer;</span>
<span class="line-removed">482     const ShapeOutsideInfo* shapeOutsideInfo;</span>
<span class="line-removed">483 };</span>
484 
<a name="43" id="anc43"></a><span class="line-modified">485 static void appendPathCommandAndPoints(PathApplyInfo&amp; info, const String&amp; command, const FloatPoint points[], unsigned length)</span>




486 {
<a name="44" id="anc44"></a><span class="line-modified">487     FloatPoint point;</span>
<span class="line-modified">488     info.pathArray-&gt;addItem(command);</span>
<span class="line-modified">489     for (unsigned i = 0; i &lt; length; i++) {</span>
<span class="line-modified">490         point = info.shapeOutsideInfo-&gt;shapeToRendererPoint(points[i]);</span>
<span class="line-modified">491         point = localPointToRoot(info.renderer, info.rootView, info.view, point);</span>
<span class="line-modified">492         info.pathArray-&gt;addItem(point.x());</span>
<span class="line-modified">493         info.pathArray-&gt;addItem(point.y());</span>













494     }
<a name="45" id="anc45"></a><span class="line-removed">495 }</span>
496 
<a name="46" id="anc46"></a><span class="line-modified">497 static void appendPathSegment(PathApplyInfo&amp; pathApplyInfo, const PathElement&amp; pathElement)</span>
<span class="line-modified">498 {</span>
<span class="line-modified">499     FloatPoint point;</span>
<span class="line-modified">500     switch (pathElement.type) {</span>
<span class="line-modified">501     // The points member will contain 1 value.</span>
<span class="line-modified">502     case PathElementMoveToPoint:</span>
<span class="line-modified">503         appendPathCommandAndPoints(pathApplyInfo, &quot;M&quot;_s, pathElement.points, 1);</span>
<span class="line-modified">504         break;</span>
<span class="line-modified">505     // The points member will contain 1 value.</span>
<span class="line-modified">506     case PathElementAddLineToPoint:</span>
<span class="line-modified">507         appendPathCommandAndPoints(pathApplyInfo, &quot;L&quot;_s, pathElement.points, 1);</span>
<span class="line-modified">508         break;</span>
<span class="line-modified">509     // The points member will contain 3 values.</span>
<span class="line-modified">510     case PathElementAddCurveToPoint:</span>
<span class="line-removed">511         appendPathCommandAndPoints(pathApplyInfo, &quot;C&quot;_s, pathElement.points, 3);</span>
<span class="line-removed">512         break;</span>
<span class="line-removed">513     // The points member will contain 2 values.</span>
<span class="line-removed">514     case PathElementAddQuadCurveToPoint:</span>
<span class="line-removed">515         appendPathCommandAndPoints(pathApplyInfo, &quot;Q&quot;_s, pathElement.points, 2);</span>
<span class="line-removed">516         break;</span>
<span class="line-removed">517     // The points member will contain no values.</span>
<span class="line-removed">518     case PathElementCloseSubpath:</span>
<span class="line-removed">519         appendPathCommandAndPoints(pathApplyInfo, &quot;Z&quot;_s, nullptr, 0);</span>
<span class="line-removed">520         break;</span>
521     }
<a name="47" id="anc47"></a>








522 }
523 
<a name="48" id="anc48"></a><span class="line-modified">524 static RefPtr&lt;Inspector::Protocol::OverlayTypes::ShapeOutsideData&gt; buildObjectForShapeOutside(Frame* containingFrame, RenderBox* renderer)</span>
525 {
<a name="49" id="anc49"></a><span class="line-modified">526     const ShapeOutsideInfo* shapeOutsideInfo = renderer-&gt;shapeOutsideInfo();</span>
<span class="line-modified">527     if (!shapeOutsideInfo)</span>
<span class="line-modified">528         return nullptr;</span>
















































529 
<a name="50" id="anc50"></a><span class="line-modified">530     LayoutRect shapeBounds = shapeOutsideInfo-&gt;computedShapePhysicalBoundingBox();</span>
<span class="line-modified">531     FloatQuad shapeQuad = renderer-&gt;localToAbsoluteQuad(FloatRect(shapeBounds));</span>
<span class="line-removed">532     contentsQuadToPage(containingFrame-&gt;page()-&gt;mainFrame().view(), containingFrame-&gt;view(), shapeQuad);</span>
533 
<a name="51" id="anc51"></a><span class="line-modified">534     auto shapeObject = Inspector::Protocol::OverlayTypes::ShapeOutsideData::create()</span>
<span class="line-modified">535         .setBounds(buildArrayForQuad(shapeQuad))</span>
<span class="line-modified">536         .release();</span>
537 
<a name="52" id="anc52"></a><span class="line-modified">538     Shape::DisplayPaths paths;</span>
<span class="line-removed">539     shapeOutsideInfo-&gt;computedShape().buildDisplayPaths(paths);</span>
540 
<a name="53" id="anc53"></a><span class="line-modified">541     if (paths.shape.length()) {</span>
<span class="line-modified">542         auto shapePath = Inspector::Protocol::OverlayTypes::DisplayPath::create();</span>
<span class="line-modified">543         PathApplyInfo info;</span>
<span class="line-modified">544         info.rootView = containingFrame-&gt;page()-&gt;mainFrame().view();</span>
<span class="line-modified">545         info.view = containingFrame-&gt;view();</span>
<span class="line-modified">546         info.pathArray = &amp;shapePath.get();</span>
<span class="line-modified">547         info.renderer = renderer;</span>
<span class="line-modified">548         info.shapeOutsideInfo = shapeOutsideInfo;</span>
<span class="line-modified">549 </span>
<span class="line-modified">550         paths.shape.apply([&amp;info](const PathElement&amp; pathElement) {</span>
<span class="line-modified">551             appendPathSegment(info, pathElement);</span>
<span class="line-modified">552         });</span>





































553 
<a name="54" id="anc54"></a><span class="line-modified">554         shapeObject-&gt;setShape(shapePath.copyRef());</span>

555 
<a name="55" id="anc55"></a><span class="line-modified">556         if (paths.marginShape.length()) {</span>
<span class="line-modified">557             auto marginShapePath = Inspector::Protocol::OverlayTypes::DisplayPath::create();</span>
<span class="line-modified">558             info.pathArray = &amp;marginShapePath.get();</span>

559 
<a name="56" id="anc56"></a><span class="line-modified">560             paths.marginShape.apply([&amp;info](const PathElement&amp; pathElement) {</span>
<span class="line-modified">561                 appendPathSegment(info, pathElement);</span>
<span class="line-modified">562             });</span>


563 
<a name="57" id="anc57"></a><span class="line-modified">564             shapeObject-&gt;setMarginShape(marginShapePath.copyRef());</span>



































565         }
566     }
567 
<a name="58" id="anc58"></a><span class="line-modified">568     return WTFMove(shapeObject);</span>

























































569 }
570 
<a name="59" id="anc59"></a><span class="line-modified">571 static RefPtr&lt;Inspector::Protocol::OverlayTypes::ElementData&gt; buildObjectForElementData(Node* node, HighlightType)</span>
572 {
<a name="60" id="anc60"></a><span class="line-modified">573     if (!is&lt;Element&gt;(node) || !node-&gt;document().frame())</span>
<span class="line-modified">574         return nullptr;</span>
575 
<a name="61" id="anc61"></a><span class="line-modified">576     Element* effectiveElement = downcast&lt;Element&gt;(node);</span>
<span class="line-modified">577     if (node-&gt;isPseudoElement()) {</span>
<span class="line-modified">578         Element* hostElement = downcast&lt;PseudoElement&gt;(*node).hostElement();</span>
<span class="line-removed">579         if (!hostElement)</span>
<span class="line-removed">580             return nullptr;</span>
<span class="line-removed">581         effectiveElement = hostElement;</span>
<span class="line-removed">582     }</span>
583 
<a name="62" id="anc62"></a><span class="line-modified">584     Element&amp; element = *effectiveElement;</span>
<span class="line-modified">585     bool isXHTML = element.document().isXHTMLDocument();</span>
<span class="line-modified">586     auto elementData = Inspector::Protocol::OverlayTypes::ElementData::create()</span>
<span class="line-modified">587         .setTagName(isXHTML ? element.nodeName() : element.nodeName().convertToASCIILowercase())</span>
<span class="line-modified">588         .setIdValue(element.getIdAttribute())</span>
<span class="line-modified">589         .release();</span>
<span class="line-modified">590 </span>
<span class="line-modified">591     if (element.hasClass() &amp;&amp; is&lt;StyledElement&gt;(element)) {</span>
<span class="line-modified">592         auto classes = JSON::ArrayOf&lt;String&gt;::create();</span>
<span class="line-modified">593         HashSet&lt;AtomicString&gt; usedClassNames;</span>
<span class="line-modified">594         const SpaceSplitString&amp; classNamesString = downcast&lt;StyledElement&gt;(element).classNames();</span>
<span class="line-modified">595         for (size_t i = 0; i &lt; classNamesString.size(); ++i) {</span>
<span class="line-modified">596             const AtomicString&amp; className = classNamesString[i];</span>
<span class="line-modified">597             if (usedClassNames.contains(className))</span>
<span class="line-modified">598                 continue;</span>
<span class="line-modified">599 </span>
<span class="line-modified">600             usedClassNames.add(className);</span>
<span class="line-modified">601             classes-&gt;addItem(className);</span>

602         }
<a name="63" id="anc63"></a><span class="line-removed">603         elementData-&gt;setClasses(WTFMove(classes));</span>
<span class="line-removed">604     }</span>
605 
<a name="64" id="anc64"></a><span class="line-modified">606     if (node-&gt;isPseudoElement()) {</span>
<span class="line-modified">607         if (node-&gt;pseudoId() == PseudoId::Before)</span>
<span class="line-removed">608             elementData-&gt;setPseudoElement(&quot;before&quot;);</span>
<span class="line-removed">609         else if (node-&gt;pseudoId() == PseudoId::After)</span>
<span class="line-removed">610             elementData-&gt;setPseudoElement(&quot;after&quot;);</span>
611     }
612 
<a name="65" id="anc65"></a><span class="line-modified">613     RenderElement* renderer = element.renderer();</span>
<span class="line-modified">614     if (!renderer)</span>
<span class="line-modified">615         return nullptr;</span>
<span class="line-modified">616 </span>
<span class="line-modified">617     Frame* containingFrame = node-&gt;document().frame();</span>
<span class="line-modified">618     FrameView* containingView = containingFrame-&gt;view();</span>
<span class="line-modified">619     IntRect boundingBox = snappedIntRect(containingView-&gt;contentsToRootView(renderer-&gt;absoluteBoundingBoxRect()));</span>
<span class="line-modified">620     RenderBoxModelObject* modelObject = is&lt;RenderBoxModelObject&gt;(*renderer) ? downcast&lt;RenderBoxModelObject&gt;(renderer) : nullptr;</span>
<span class="line-modified">621     auto sizeObject = Inspector::Protocol::OverlayTypes::Size::create()</span>
<span class="line-modified">622         .setWidth(modelObject ? adjustForAbsoluteZoom(roundToInt(modelObject-&gt;offsetWidth()), *modelObject) : boundingBox.width())</span>
<span class="line-modified">623         .setHeight(modelObject ? adjustForAbsoluteZoom(roundToInt(modelObject-&gt;offsetHeight()), *modelObject) : boundingBox.height())</span>
<span class="line-modified">624         .release();</span>
<span class="line-modified">625     elementData-&gt;setSize(WTFMove(sizeObject));</span>
<span class="line-modified">626 </span>
<span class="line-modified">627     if (is&lt;RenderBox&gt;(*renderer)) {</span>
<span class="line-modified">628         auto&amp; renderBox = downcast&lt;RenderBox&gt;(*renderer);</span>
<span class="line-modified">629         if (RefPtr&lt;Inspector::Protocol::OverlayTypes::ShapeOutsideData&gt; shapeObject = buildObjectForShapeOutside(containingFrame, &amp;renderBox))</span>
<span class="line-removed">630             elementData-&gt;setShapeOutsideData(WTFMove(shapeObject));</span>
631     }
632 
633     // Need to enable AX to get the computed role.
634     if (!WebCore::AXObjectCache::accessibilityEnabled())
635         WebCore::AXObjectCache::enableAccessibility();
636 
<a name="66" id="anc66"></a><span class="line-modified">637     if (AXObjectCache* axObjectCache = node-&gt;document().axObjectCache()) {</span>
<span class="line-modified">638         if (AccessibilityObject* axObject = axObjectCache-&gt;getOrCreate(node))</span>
<span class="line-modified">639             elementData-&gt;setRole(axObject-&gt;computedRoleString());</span>

640     }
641 
<a name="67" id="anc67"></a><span class="line-modified">642     return WTFMove(elementData);</span>
<span class="line-modified">643 }</span>

644 
<a name="68" id="anc68"></a><span class="line-modified">645 RefPtr&lt;Inspector::Protocol::OverlayTypes::NodeHighlightData&gt; InspectorOverlay::buildHighlightObjectForNode(Node* node, HighlightType type) const</span>
<span class="line-modified">646 {</span>
<span class="line-removed">647     if (!node)</span>
<span class="line-removed">648         return nullptr;</span>
649 
<a name="69" id="anc69"></a><span class="line-modified">650     RenderObject* renderer = node-&gt;renderer();</span>
<span class="line-removed">651     if (!renderer)</span>
<span class="line-removed">652         return nullptr;</span>
653 
<a name="70" id="anc70"></a><span class="line-modified">654     RefPtr&lt;JSON::ArrayOf&lt;Inspector::Protocol::OverlayTypes::FragmentHighlightData&gt;&gt; arrayOfFragmentHighlights = buildArrayForRendererFragments(renderer, m_nodeHighlightConfig);</span>
<span class="line-modified">655     if (!arrayOfFragmentHighlights)</span>
<span class="line-modified">656         return nullptr;</span>
657 
<a name="71" id="anc71"></a><span class="line-modified">658     // The main view&#39;s scroll offset is shared across all quads.</span>
<span class="line-modified">659     FrameView* mainView = m_page.mainFrame().view();</span>

660 
<a name="72" id="anc72"></a><span class="line-modified">661     auto nodeHighlightObject = Inspector::Protocol::OverlayTypes::NodeHighlightData::create()</span>
<span class="line-modified">662         .setScrollOffset(buildObjectForPoint(!mainView-&gt;delegatesScrolling() ? mainView-&gt;visibleContentRect().location() : FloatPoint()))</span>
<span class="line-removed">663         .setFragments(WTFMove(arrayOfFragmentHighlights))</span>
<span class="line-removed">664         .release();</span>
665 
<a name="73" id="anc73"></a><span class="line-modified">666     if (m_nodeHighlightConfig.showInfo) {</span>
<span class="line-modified">667         if (RefPtr&lt;Inspector::Protocol::OverlayTypes::ElementData&gt; elementData = buildObjectForElementData(node, type))</span>
<span class="line-modified">668             nodeHighlightObject-&gt;setElementData(WTFMove(elementData));</span>
669     }
670 
<a name="74" id="anc74"></a><span class="line-modified">671     return WTFMove(nodeHighlightObject);</span>
<span class="line-removed">672 }</span>
673 
<a name="75" id="anc75"></a><span class="line-modified">674 Ref&lt;JSON::ArrayOf&lt;Inspector::Protocol::OverlayTypes::NodeHighlightData&gt;&gt; InspectorOverlay::buildObjectForHighlightedNodes() const</span>
<span class="line-modified">675 {</span>
<span class="line-removed">676     auto highlights = JSON::ArrayOf&lt;Inspector::Protocol::OverlayTypes::NodeHighlightData&gt;::create();</span>
677 
<a name="76" id="anc76"></a><span class="line-modified">678     if (m_highlightNode) {</span>
<span class="line-modified">679         if (RefPtr&lt;Inspector::Protocol::OverlayTypes::NodeHighlightData&gt; nodeHighlightData = buildHighlightObjectForNode(m_highlightNode.get(), HighlightType::Node))</span>
<span class="line-modified">680             highlights-&gt;addItem(WTFMove(nodeHighlightData));</span>
<span class="line-modified">681     } else if (m_highlightNodeList) {</span>
<span class="line-modified">682         for (unsigned i = 0; i &lt; m_highlightNodeList-&gt;length(); ++i) {</span>
<span class="line-modified">683             if (RefPtr&lt;Inspector::Protocol::OverlayTypes::NodeHighlightData&gt; nodeHighlightData = buildHighlightObjectForNode(m_highlightNodeList-&gt;item(i), HighlightType::NodeList))</span>
<span class="line-modified">684                 highlights-&gt;addItem(WTFMove(nodeHighlightData));</span>
<span class="line-modified">685         }</span>






























686     }
687 
<a name="77" id="anc77"></a><span class="line-modified">688     return highlights;</span>
<span class="line-modified">689 }</span>














690 
<a name="78" id="anc78"></a><span class="line-modified">691 void InspectorOverlay::drawNodeHighlight()</span>
<span class="line-removed">692 {</span>
<span class="line-removed">693     if (m_highlightNode || m_highlightNodeList)</span>
<span class="line-removed">694         evaluateInOverlay(&quot;drawNodeHighlight&quot;, buildObjectForHighlightedNodes());</span>
<span class="line-removed">695 }</span>
696 
<a name="79" id="anc79"></a><span class="line-modified">697 void InspectorOverlay::drawQuadHighlight()</span>
<span class="line-removed">698 {</span>
<span class="line-removed">699     if (!m_highlightQuad)</span>
<span class="line-removed">700         return;</span>
701 
<a name="80" id="anc80"></a><span class="line-modified">702     Highlight highlight;</span>
<span class="line-modified">703     buildQuadHighlight(*m_highlightQuad, m_quadHighlightConfig, highlight);</span>
<span class="line-removed">704     evaluateInOverlay(&quot;drawQuadHighlight&quot;, buildObjectForHighlight(highlight));</span>
<span class="line-removed">705 }</span>
<span class="line-removed">706 </span>
<span class="line-removed">707 void InspectorOverlay::drawPausedInDebuggerMessage()</span>
<span class="line-removed">708 {</span>
<span class="line-removed">709     if (!m_pausedInDebuggerMessage.isNull())</span>
<span class="line-removed">710         evaluateInOverlay(&quot;drawPausedInDebuggerMessage&quot;, m_pausedInDebuggerMessage);</span>
<span class="line-removed">711 }</span>
<span class="line-removed">712 </span>
<span class="line-removed">713 Page* InspectorOverlay::overlayPage()</span>
<span class="line-removed">714 {</span>
<span class="line-removed">715 #if PLATFORM(IOS_FAMILY)</span>
<span class="line-removed">716     return nullptr;</span>
<span class="line-removed">717 #else</span>
<span class="line-removed">718     if (m_overlayPage)</span>
<span class="line-removed">719         return m_overlayPage.get();</span>
<span class="line-removed">720 </span>
<span class="line-removed">721     auto pageConfiguration = pageConfigurationWithEmptyClients();</span>
<span class="line-removed">722     m_overlayPage = std::make_unique&lt;Page&gt;(WTFMove(pageConfiguration));</span>
<span class="line-removed">723     m_overlayPage-&gt;setDeviceScaleFactor(m_page.deviceScaleFactor());</span>
<span class="line-removed">724 </span>
<span class="line-removed">725     Settings&amp; settings = m_page.settings();</span>
<span class="line-removed">726     Settings&amp; overlaySettings = m_overlayPage-&gt;settings();</span>
<span class="line-removed">727 </span>
<span class="line-removed">728     overlaySettings.setStandardFontFamily(settings.standardFontFamily());</span>
<span class="line-removed">729     overlaySettings.setSerifFontFamily(settings.serifFontFamily());</span>
<span class="line-removed">730     overlaySettings.setSansSerifFontFamily(settings.sansSerifFontFamily());</span>
<span class="line-removed">731     overlaySettings.setCursiveFontFamily(settings.cursiveFontFamily());</span>
<span class="line-removed">732     overlaySettings.setFantasyFontFamily(settings.fantasyFontFamily());</span>
<span class="line-removed">733     overlaySettings.setPictographFontFamily(settings.pictographFontFamily());</span>
<span class="line-removed">734     overlaySettings.setMinimumFontSize(settings.minimumFontSize());</span>
<span class="line-removed">735     overlaySettings.setMinimumLogicalFontSize(settings.minimumLogicalFontSize());</span>
<span class="line-removed">736     overlaySettings.setMediaEnabled(false);</span>
<span class="line-removed">737     overlaySettings.setScriptEnabled(true);</span>
<span class="line-removed">738     overlaySettings.setPluginsEnabled(false);</span>
<span class="line-removed">739 </span>
<span class="line-removed">740     Frame&amp; frame = m_overlayPage-&gt;mainFrame();</span>
<span class="line-removed">741     frame.setView(FrameView::create(frame));</span>
<span class="line-removed">742     frame.init();</span>
<span class="line-removed">743     FrameLoader&amp; loader = frame.loader();</span>
<span class="line-removed">744     frame.view()-&gt;setCanHaveScrollbars(false);</span>
<span class="line-removed">745     frame.view()-&gt;setTransparent(true);</span>
<span class="line-removed">746     ASSERT(loader.activeDocumentLoader());</span>
<span class="line-removed">747     auto&amp; writer = loader.activeDocumentLoader()-&gt;writer();</span>
<span class="line-removed">748     writer.setMIMEType(&quot;text/html&quot;);</span>
<span class="line-removed">749     writer.begin();</span>
<span class="line-removed">750     writer.insertDataSynchronously(String(reinterpret_cast&lt;const char*&gt;(InspectorOverlayPage_html), sizeof(InspectorOverlayPage_html)));</span>
<span class="line-removed">751     writer.end();</span>
<span class="line-removed">752 </span>
<span class="line-removed">753 #if OS(WINDOWS)</span>
<span class="line-removed">754     evaluateInOverlay(&quot;setPlatform&quot;, &quot;windows&quot;);</span>
<span class="line-removed">755 #elif OS(MAC_OS_X)</span>
<span class="line-removed">756     evaluateInOverlay(&quot;setPlatform&quot;, &quot;mac&quot;);</span>
<span class="line-removed">757 #elif OS(UNIX)</span>
<span class="line-removed">758     evaluateInOverlay(&quot;setPlatform&quot;, &quot;linux&quot;);</span>
<span class="line-removed">759 #endif</span>
<span class="line-removed">760 </span>
<span class="line-removed">761     return m_overlayPage.get();</span>
<span class="line-removed">762 #endif</span>
<span class="line-removed">763 }</span>
<span class="line-removed">764 </span>
<span class="line-removed">765 void InspectorOverlay::forcePaint()</span>
<span class="line-removed">766 {</span>
<span class="line-removed">767     // This overlay page is very weird and doesn&#39;t automatically paint. We have to force paints manually.</span>
<span class="line-removed">768     m_client-&gt;highlight();</span>
<span class="line-removed">769 }</span>
770 
<a name="81" id="anc81"></a><span class="line-modified">771 void InspectorOverlay::reset(const IntSize&amp; viewportSize, const IntPoint&amp; scrollOffset)</span>
<span class="line-removed">772 {</span>
<span class="line-removed">773     auto configObject = Inspector::Protocol::OverlayTypes::OverlayConfiguration::create()</span>
<span class="line-removed">774         .setDeviceScaleFactor(m_page.deviceScaleFactor())</span>
<span class="line-removed">775         .setViewportSize(buildObjectForSize(viewportSize))</span>
<span class="line-removed">776         .setPageScaleFactor(m_page.pageScaleFactor())</span>
<span class="line-removed">777         .setPageZoomFactor(m_page.mainFrame().pageZoomFactor())</span>
<span class="line-removed">778         .setScrollOffset(buildObjectForPoint(scrollOffset))</span>
<span class="line-removed">779         .setContentInset(buildObjectForSize(IntSize(0, m_page.mainFrame().view()-&gt;topContentInset(ScrollView::TopContentInsetType::WebCoreOrPlatformContentInset))))</span>
<span class="line-removed">780         .setShowRulers(m_showRulers)</span>
<span class="line-removed">781         .release();</span>
<span class="line-removed">782     evaluateInOverlay(&quot;reset&quot;, WTFMove(configObject));</span>
<span class="line-removed">783 }</span>
784 
<a name="82" id="anc82"></a><span class="line-modified">785 static void evaluateCommandInOverlay(Page* page, Ref&lt;JSON::Array&gt;&amp;&amp; command)</span>
<span class="line-removed">786 {</span>
<span class="line-removed">787     if (!page)</span>
<span class="line-removed">788         return;</span>
789 
<a name="83" id="anc83"></a><span class="line-modified">790     page-&gt;mainFrame().script().evaluate(ScriptSourceCode(makeString(&quot;dispatch(&quot;, command-&gt;toJSONString(), &#39;)&#39;)));</span>
<span class="line-modified">791 }</span>
792 
<a name="84" id="anc84"></a><span class="line-modified">793 void InspectorOverlay::evaluateInOverlay(const String&amp; method)</span>
<span class="line-removed">794 {</span>
<span class="line-removed">795     Ref&lt;JSON::Array&gt; command = JSON::Array::create();</span>
<span class="line-removed">796     command-&gt;pushString(method);</span>
797 
<a name="85" id="anc85"></a><span class="line-modified">798     evaluateCommandInOverlay(overlayPage(), WTFMove(command));</span>
<span class="line-modified">799 }</span>



800 
<a name="86" id="anc86"></a><span class="line-modified">801 void InspectorOverlay::evaluateInOverlay(const String&amp; method, const String&amp; argument)</span>
<span class="line-modified">802 {</span>
<span class="line-modified">803     Ref&lt;JSON::Array&gt; command = JSON::Array::create();</span>
<span class="line-removed">804     command-&gt;pushString(method);</span>
<span class="line-removed">805     command-&gt;pushString(argument);</span>
806 
<a name="87" id="anc87"></a><span class="line-modified">807     evaluateCommandInOverlay(overlayPage(), WTFMove(command));</span>
<span class="line-modified">808 }</span>










809 
<a name="88" id="anc88"></a><span class="line-modified">810 void InspectorOverlay::evaluateInOverlay(const String&amp; method, RefPtr&lt;JSON::Value&gt;&amp;&amp; argument)</span>
<span class="line-modified">811 {</span>
<span class="line-modified">812     Ref&lt;JSON::Array&gt; command = JSON::Array::create();</span>
<span class="line-removed">813     command-&gt;pushString(method);</span>
<span class="line-removed">814     command-&gt;pushValue(WTFMove(argument));</span>
815 
<a name="89" id="anc89"></a><span class="line-modified">816     evaluateCommandInOverlay(overlayPage(), WTFMove(command));</span>
<span class="line-modified">817 }</span>


818 
<a name="90" id="anc90"></a><span class="line-modified">819 void InspectorOverlay::freePage()</span>
<span class="line-removed">820 {</span>
<span class="line-removed">821     m_overlayPage = nullptr;</span>
822 }
823 
824 } // namespace WebCore
<a name="91" id="anc91"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="91" type="hidden" />
</body>
</html>