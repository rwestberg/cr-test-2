<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff modules/javafx.web/src/main/native/Source/WebCore/page/Page.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="NavigatorBase.h.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="Page.h.udiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/page/Page.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -33,10 +33,11 @@</span>
  #include &quot;ChromeClient.h&quot;
  #include &quot;ConstantPropertyMap.h&quot;
  #include &quot;ContextMenuClient.h&quot;
  #include &quot;ContextMenuController.h&quot;
  #include &quot;CookieJar.h&quot;
<span class="udiff-line-added">+ #include &quot;CustomHeaderFields.h&quot;</span>
  #include &quot;DOMRect.h&quot;
  #include &quot;DOMRectList.h&quot;
  #include &quot;DatabaseProvider.h&quot;
  #include &quot;DiagnosticLoggingClient.h&quot;
  #include &quot;DiagnosticLoggingKeys.h&quot;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -55,10 +56,11 @@</span>
  #include &quot;FrameLoader.h&quot;
  #include &quot;FrameLoaderClient.h&quot;
  #include &quot;FrameSelection.h&quot;
  #include &quot;FrameTree.h&quot;
  #include &quot;FrameView.h&quot;
<span class="udiff-line-added">+ #include &quot;FullscreenManager.h&quot;</span>
  #include &quot;HTMLElement.h&quot;
  #include &quot;HTMLMediaElement.h&quot;
  #include &quot;HistoryController.h&quot;
  #include &quot;HistoryItem.h&quot;
  #include &quot;InspectorClient.h&quot;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -87,15 +89,16 @@</span>
  #include &quot;PluginInfoProvider.h&quot;
  #include &quot;PluginViewBase.h&quot;
  #include &quot;PointerCaptureController.h&quot;
  #include &quot;PointerLockController.h&quot;
  #include &quot;ProgressTracker.h&quot;
<span class="udiff-line-modified-removed">- #include &quot;PublicSuffix.h&quot;</span>
<span class="udiff-line-modified-added">+ #include &quot;RenderDescendantIterator.h&quot;</span>
  #include &quot;RenderLayerCompositor.h&quot;
  #include &quot;RenderTheme.h&quot;
  #include &quot;RenderView.h&quot;
  #include &quot;RenderWidget.h&quot;
<span class="udiff-line-added">+ #include &quot;ResizeObserver.h&quot;</span>
  #include &quot;ResourceUsageOverlay.h&quot;
  #include &quot;RuntimeEnabledFeatures.h&quot;
  #include &quot;SVGDocumentExtensions.h&quot;
  #include &quot;SchemeRegistry.h&quot;
  #include &quot;ScriptController.h&quot;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -117,16 +120,16 @@</span>
  #include &quot;UserInputBridge.h&quot;
  #include &quot;ValidationMessageClient.h&quot;
  #include &quot;VisitedLinkState.h&quot;
  #include &quot;VisitedLinkStore.h&quot;
  #include &quot;VoidCallback.h&quot;
<span class="udiff-line-removed">- #include &quot;WebGLStateTracker.h&quot;</span>
  #include &quot;WheelEventDeltaFilter.h&quot;
  #include &quot;Widget.h&quot;
  #include &lt;wtf/FileSystem.h&gt;
  #include &lt;wtf/RefCountedLeakCounter.h&gt;
  #include &lt;wtf/StdLibExtras.h&gt;
<span class="udiff-line-added">+ #include &lt;wtf/SystemTracing.h&gt;</span>
  #include &lt;wtf/text/Base64.h&gt;
  #include &lt;wtf/text/StringHash.h&gt;
  
  #if ENABLE(WIRELESS_PLAYBACK_TARGET)
  #include &quot;HTMLVideoElement.h&quot;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -148,10 +151,14 @@</span>
  
  #if ENABLE(DATA_INTERACTION)
  #include &quot;SelectionRect.h&quot;
  #endif
  
<span class="udiff-line-added">+ #if ENABLE(WEBGL)</span>
<span class="udiff-line-added">+ #include &quot;WebGLStateTracker.h&quot;</span>
<span class="udiff-line-added">+ #endif</span>
<span class="udiff-line-added">+ </span>
  namespace WebCore {
  
  static HashSet&lt;Page*&gt;&amp; allPages()
  {
      static NeverDestroyed&lt;HashSet&lt;Page*&gt;&gt; set;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -202,75 +209,77 @@</span>
  {
      return { ActivityState::IsVisible, ActivityState::IsInWindow };
  }
  
  Page::Page(PageConfiguration&amp;&amp; pageConfiguration)
<span class="udiff-line-modified-removed">-     : m_chrome(std::make_unique&lt;Chrome&gt;(*this, *pageConfiguration.chromeClient))</span>
<span class="udiff-line-modified-removed">-     , m_dragCaretController(std::make_unique&lt;DragCaretController&gt;())</span>
<span class="udiff-line-modified-added">+     : m_chrome(makeUnique&lt;Chrome&gt;(*this, *pageConfiguration.chromeClient))</span>
<span class="udiff-line-modified-added">+     , m_dragCaretController(makeUnique&lt;DragCaretController&gt;())</span>
  #if ENABLE(DRAG_SUPPORT)
<span class="udiff-line-modified-removed">-     , m_dragController(std::make_unique&lt;DragController&gt;(*this, *pageConfiguration.dragClient))</span>
<span class="udiff-line-modified-added">+     , m_dragController(makeUnique&lt;DragController&gt;(*this, *pageConfiguration.dragClient))</span>
  #endif
<span class="udiff-line-modified-removed">-     , m_focusController(std::make_unique&lt;FocusController&gt;(*this, pageInitialActivityState()))</span>
<span class="udiff-line-modified-added">+     , m_focusController(makeUnique&lt;FocusController&gt;(*this, pageInitialActivityState()))</span>
  #if ENABLE(CONTEXT_MENUS)
<span class="udiff-line-modified-removed">-     , m_contextMenuController(std::make_unique&lt;ContextMenuController&gt;(*this, *pageConfiguration.contextMenuClient))</span>
<span class="udiff-line-modified-added">+     , m_contextMenuController(makeUnique&lt;ContextMenuController&gt;(*this, *pageConfiguration.contextMenuClient))</span>
  #endif
<span class="udiff-line-modified-removed">-     , m_userInputBridge(std::make_unique&lt;UserInputBridge&gt;(*this))</span>
<span class="udiff-line-modified-removed">-     , m_inspectorController(std::make_unique&lt;InspectorController&gt;(*this, pageConfiguration.inspectorClient))</span>
<span class="udiff-line-modified-added">+     , m_userInputBridge(makeUnique&lt;UserInputBridge&gt;(*this))</span>
<span class="udiff-line-modified-added">+     , m_inspectorController(makeUnique&lt;InspectorController&gt;(*this, pageConfiguration.inspectorClient))</span>
  #if ENABLE(POINTER_EVENTS)
<span class="udiff-line-modified-removed">-     , m_pointerCaptureController(std::make_unique&lt;PointerCaptureController&gt;(*this))</span>
<span class="udiff-line-modified-added">+     , m_pointerCaptureController(makeUnique&lt;PointerCaptureController&gt;(*this))</span>
  #endif
  #if ENABLE(POINTER_LOCK)
<span class="udiff-line-modified-removed">-     , m_pointerLockController(std::make_unique&lt;PointerLockController&gt;(*this))</span>
<span class="udiff-line-modified-added">+     , m_pointerLockController(makeUnique&lt;PointerLockController&gt;(*this))</span>
  #endif
      , m_settings(Settings::create(this))
<span class="udiff-line-modified-removed">-     , m_progress(std::make_unique&lt;ProgressTracker&gt;(*pageConfiguration.progressTrackerClient))</span>
<span class="udiff-line-modified-removed">-     , m_backForwardController(std::make_unique&lt;BackForwardController&gt;(*this, WTFMove(pageConfiguration.backForwardClient)))</span>
<span class="udiff-line-modified-added">+     , m_progress(makeUnique&lt;ProgressTracker&gt;(*pageConfiguration.progressTrackerClient))</span>
<span class="udiff-line-modified-added">+     , m_backForwardController(makeUnique&lt;BackForwardController&gt;(*this, WTFMove(pageConfiguration.backForwardClient)))</span>
      , m_mainFrame(Frame::create(this, nullptr, pageConfiguration.loaderClientForMainFrame))
      , m_editorClient(WTFMove(pageConfiguration.editorClient))
      , m_plugInClient(pageConfiguration.plugInClient)
      , m_validationMessageClient(WTFMove(pageConfiguration.validationMessageClient))
      , m_diagnosticLoggingClient(WTFMove(pageConfiguration.diagnosticLoggingClient))
      , m_performanceLoggingClient(WTFMove(pageConfiguration.performanceLoggingClient))
<span class="udiff-line-added">+ #if ENABLE(WEBGL)</span>
      , m_webGLStateTracker(WTFMove(pageConfiguration.webGLStateTracker))
<span class="udiff-line-added">+ #endif</span>
<span class="udiff-line-added">+ #if ENABLE(SPEECH_SYNTHESIS)</span>
<span class="udiff-line-added">+     , m_speechSynthesisClient(WTFMove(pageConfiguration.speechSynthesisClient))</span>
<span class="udiff-line-added">+ #endif</span>
      , m_libWebRTCProvider(WTFMove(pageConfiguration.libWebRTCProvider))
      , m_verticalScrollElasticity(ScrollElasticityAllowed)
      , m_horizontalScrollElasticity(ScrollElasticityAllowed)
      , m_domTimerAlignmentInterval(DOMTimer::defaultAlignmentInterval())
      , m_domTimerAlignmentIntervalIncreaseTimer(*this, &amp;Page::domTimerAlignmentIntervalIncreaseTimerFired)
      , m_activityState(pageInitialActivityState())
      , m_alternativeTextClient(pageConfiguration.alternativeTextClient)
<span class="udiff-line-modified-removed">-     , m_consoleClient(std::make_unique&lt;PageConsoleClient&gt;(*this))</span>
<span class="udiff-line-modified-added">+     , m_consoleClient(makeUnique&lt;PageConsoleClient&gt;(*this))</span>
  #if ENABLE(REMOTE_INSPECTOR)
<span class="udiff-line-modified-removed">-     , m_inspectorDebuggable(std::make_unique&lt;PageDebuggable&gt;(*this))</span>
<span class="udiff-line-modified-added">+     , m_inspectorDebuggable(makeUnique&lt;PageDebuggable&gt;(*this))</span>
  #endif
      , m_socketProvider(WTFMove(pageConfiguration.socketProvider))
      , m_cookieJar(WTFMove(pageConfiguration.cookieJar))
      , m_applicationCacheStorage(*WTFMove(pageConfiguration.applicationCacheStorage))
      , m_cacheStorageProvider(WTFMove(pageConfiguration.cacheStorageProvider))
      , m_databaseProvider(*WTFMove(pageConfiguration.databaseProvider))
      , m_pluginInfoProvider(*WTFMove(pageConfiguration.pluginInfoProvider))
      , m_storageNamespaceProvider(*WTFMove(pageConfiguration.storageNamespaceProvider))
      , m_userContentProvider(*WTFMove(pageConfiguration.userContentProvider))
      , m_visitedLinkStore(*WTFMove(pageConfiguration.visitedLinkStore))
<span class="udiff-line-removed">- #if ENABLE(INTERSECTION_OBSERVER)</span>
<span class="udiff-line-removed">-     , m_intersectionObservationUpdateTimer(*this, &amp;Page::updateIntersectionObservations)</span>
<span class="udiff-line-removed">- #endif</span>
      , m_sessionID(PAL::SessionID::defaultSessionID())
  #if ENABLE(VIDEO)
      , m_playbackControlsManagerUpdateTimer(*this, &amp;Page::playbackControlsManagerUpdateTimerFired)
  #endif
      , m_isUtilityPage(isUtilityPageChromeClient(chrome().client()))
<span class="udiff-line-modified-removed">-     , m_performanceMonitor(isUtilityPage() ? nullptr : std::make_unique&lt;PerformanceMonitor&gt;(*this))</span>
<span class="udiff-line-modified-removed">-     , m_lowPowerModeNotifier(std::make_unique&lt;LowPowerModeNotifier&gt;([this](bool isLowPowerModeEnabled) { handleLowModePowerChange(isLowPowerModeEnabled); }))</span>
<span class="udiff-line-modified-removed">-     , m_performanceLogging(std::make_unique&lt;PerformanceLogging&gt;(*this))</span>
<span class="udiff-line-modified-added">+     , m_performanceMonitor(isUtilityPage() ? nullptr : makeUnique&lt;PerformanceMonitor&gt;(*this))</span>
<span class="udiff-line-modified-added">+     , m_lowPowerModeNotifier(makeUnique&lt;LowPowerModeNotifier&gt;([this](bool isLowPowerModeEnabled) { handleLowModePowerChange(isLowPowerModeEnabled); }))</span>
<span class="udiff-line-modified-added">+     , m_performanceLogging(makeUnique&lt;PerformanceLogging&gt;(*this))</span>
  #if PLATFORM(MAC) &amp;&amp; (ENABLE(SERVICE_CONTROLS) || ENABLE(TELEPHONE_NUMBER_DETECTION))
<span class="udiff-line-modified-removed">-     , m_servicesOverlayController(std::make_unique&lt;ServicesOverlayController&gt;(*this))</span>
<span class="udiff-line-modified-added">+     , m_servicesOverlayController(makeUnique&lt;ServicesOverlayController&gt;(*this))</span>
  #endif
      , m_recentWheelEventDeltaFilter(WheelEventDeltaFilter::create())
<span class="udiff-line-modified-removed">-     , m_pageOverlayController(std::make_unique&lt;PageOverlayController&gt;(*this))</span>
<span class="udiff-line-modified-added">+     , m_pageOverlayController(makeUnique&lt;PageOverlayController&gt;(*this))</span>
  #if ENABLE(APPLE_PAY)
<span class="udiff-line-modified-removed">-     , m_paymentCoordinator(std::make_unique&lt;PaymentCoordinator&gt;(*pageConfiguration.paymentCoordinatorClient))</span>
<span class="udiff-line-modified-added">+     , m_paymentCoordinator(makeUnique&lt;PaymentCoordinator&gt;(*pageConfiguration.paymentCoordinatorClient))</span>
  #endif
  #if ENABLE(WEB_AUTHN)
      , m_authenticatorCoordinator(makeUniqueRef&lt;AuthenticatorCoordinator&gt;(WTFMove(pageConfiguration.authenticatorCoordinatorClient)))
  #endif
  #if ENABLE(APPLICATION_MANIFEST)
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -278,11 +287,10 @@</span>
  #endif
  {
      updateTimerThrottlingState();
  
      m_pluginInfoProvider-&gt;addPage(*this);
<span class="udiff-line-removed">-     m_storageNamespaceProvider-&gt;addPage(*this);</span>
      m_userContentProvider-&gt;addPage(*this);
      m_visitedLinkStore-&gt;addPage(*this);
  
      static bool addedListener;
      if (!addedListener) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -356,11 +364,10 @@</span>
  #ifndef NDEBUG
      pageCounter.decrement();
  #endif
  
      m_pluginInfoProvider-&gt;removePage(*this);
<span class="udiff-line-removed">-     m_storageNamespaceProvider-&gt;removePage(*this);</span>
      m_userContentProvider-&gt;removePage(*this);
      m_visitedLinkStore-&gt;removePage(*this);
  }
  
  void Page::clearPreviousItemFromAllPages(HistoryItem* item)
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -396,10 +403,20 @@</span>
  ViewportArguments Page::viewportArguments() const
  {
      return mainFrame().document() ? mainFrame().document()-&gt;viewportArguments() : ViewportArguments();
  }
  
<span class="udiff-line-added">+ void Page::setOverrideViewportArguments(const Optional&lt;ViewportArguments&gt;&amp; viewportArguments)</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     if (viewportArguments == m_overrideViewportArguments)</span>
<span class="udiff-line-added">+         return;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     m_overrideViewportArguments = viewportArguments;</span>
<span class="udiff-line-added">+     if (auto* document = mainFrame().document())</span>
<span class="udiff-line-added">+         document-&gt;updateViewportArguments();</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
  ScrollingCoordinator* Page::scrollingCoordinator()
  {
      if (!m_scrollingCoordinator &amp;&amp; m_settings-&gt;scrollingCoordinatorEnabled()) {
          m_scrollingCoordinator = chrome().client().createScrollingCoordinator(*this);
          if (!m_scrollingCoordinator)
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -540,11 +557,11 @@</span>
  
  void Page::initGroup()
  {
      ASSERT(!m_singlePageGroup);
      ASSERT(!m_group);
<span class="udiff-line-modified-removed">-     m_singlePageGroup = std::make_unique&lt;PageGroup&gt;(*this);</span>
<span class="udiff-line-modified-added">+     m_singlePageGroup = makeUnique&lt;PageGroup&gt;(*this);</span>
      m_group = m_singlePageGroup.get();
  }
  
  void Page::updateStyleAfterChangeInEnvironment()
  {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1073,10 +1090,15 @@</span>
      PageCache::singleton().markPagesForDeviceOrPageScaleChanged(*this);
  
      pageOverlayController().didChangeDeviceScaleFactor();
  }
  
<span class="udiff-line-added">+ void Page::setInitialScale(float initialScale)</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     m_initialScale = initialScale;</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
  void Page::setUserInterfaceLayoutDirection(UserInterfaceLayoutDirection userInterfaceLayoutDirection)
  {
      if (m_userInterfaceLayoutDirection == userInterfaceLayoutDirection)
          return;
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1110,17 +1132,10 @@</span>
  
      if (m_performanceMonitor)
          m_performanceMonitor-&gt;didFinishLoad();
  }
  
<span class="udiff-line-removed">- void Page::willDisplayPage()</span>
<span class="udiff-line-removed">- {</span>
<span class="udiff-line-removed">- #if ENABLE(INTERSECTION_OBSERVER)</span>
<span class="udiff-line-removed">-     updateIntersectionObservations();</span>
<span class="udiff-line-removed">- #endif</span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-removed">- </span>
  bool Page::isOnlyNonUtilityPage() const
  {
      return !isUtilityPage() &amp;&amp; nonUtilityPageCount == 1;
  }
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1258,35 +1273,54 @@</span>
  void Page::removeActivityStateChangeObserver(ActivityStateChangeObserver&amp; observer)
  {
      m_activityStateChangeObservers.remove(&amp;observer);
  }
  
<span class="udiff-line-modified-removed">- #if ENABLE(INTERSECTION_OBSERVER)</span>
<span class="udiff-line-removed">- void Page::addDocumentNeedingIntersectionObservationUpdate(Document&amp; document)</span>
<span class="udiff-line-modified-added">+ void Page::layoutIfNeeded()</span>
  {
<span class="udiff-line-modified-removed">-     if (m_documentsNeedingIntersectionObservationUpdate.find(&amp;document) == notFound)</span>
<span class="udiff-line-modified-removed">-         m_documentsNeedingIntersectionObservationUpdate.append(makeWeakPtr(document));</span>
<span class="udiff-line-modified-added">+     if (FrameView* view = m_mainFrame-&gt;view())</span>
<span class="udiff-line-modified-added">+         view-&gt;updateLayoutAndStyleIfNeededRecursive();</span>
  }
  
<span class="udiff-line-modified-removed">- void Page::updateIntersectionObservations()</span>
<span class="udiff-line-modified-added">+ void Page::updateRendering()</span>
  {
<span class="udiff-line-modified-removed">-     m_intersectionObservationUpdateTimer.stop();</span>
<span class="udiff-line-modified-removed">-     for (const auto&amp; document : m_documentsNeedingIntersectionObservationUpdate) {</span>
<span class="udiff-line-modified-removed">-         if (document)</span>
<span class="udiff-line-modified-removed">-             document-&gt;updateIntersectionObservations();</span>
<span class="udiff-line-modified-added">+     // This function is not reentrant, e.g. a rAF callback may force repaint.</span>
<span class="udiff-line-modified-added">+     if (m_inUpdateRendering) {</span>
<span class="udiff-line-modified-added">+         layoutIfNeeded();</span>
<span class="udiff-line-modified-added">+         return;</span>
      }
<span class="udiff-line-removed">-     m_documentsNeedingIntersectionObservationUpdate.clear();</span>
<span class="udiff-line-removed">- }</span>
  
<span class="udiff-line-modified-removed">- void Page::scheduleForcedIntersectionObservationUpdate(Document&amp; document)</span>
<span class="udiff-line-modified-removed">- {</span>
<span class="udiff-line-modified-removed">-     addDocumentNeedingIntersectionObservationUpdate(document);</span>
<span class="udiff-line-modified-removed">-     if (m_intersectionObservationUpdateTimer.isActive())</span>
<span class="udiff-line-modified-removed">-         return;</span>
<span class="udiff-line-modified-removed">-     m_intersectionObservationUpdateTimer.startOneShot(0_s);</span>
<span class="udiff-line-modified-removed">- }</span>
<span class="udiff-line-modified-added">+     TraceScope traceScope(RenderingUpdateStart, RenderingUpdateEnd);</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+     SetForScope&lt;bool&gt; change(m_inUpdateRendering, true);</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+     Vector&lt;RefPtr&lt;Document&gt;&gt; documents;</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+     // The requestAnimationFrame callbacks may change the frame hierarchy of the page</span>
<span class="udiff-line-added">+     forEachDocument([&amp;documents] (Document&amp; document) {</span>
<span class="udiff-line-added">+         documents.append(&amp;document);</span>
<span class="udiff-line-added">+     });</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     for (auto&amp; document : documents) {</span>
<span class="udiff-line-added">+         DOMHighResTimeStamp timestamp = document-&gt;domWindow()-&gt;nowTimestamp();</span>
<span class="udiff-line-added">+         document-&gt;updateAnimationsAndSendEvents(timestamp);</span>
<span class="udiff-line-added">+         document-&gt;serviceRequestAnimationFrameCallbacks(timestamp);</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     layoutIfNeeded();</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ #if ENABLE(INTERSECTION_OBSERVER)</span>
<span class="udiff-line-added">+     for (auto&amp; document : documents)</span>
<span class="udiff-line-added">+         document-&gt;updateIntersectionObservations();</span>
  #endif
<span class="udiff-line-added">+ #if ENABLE(RESIZE_OBSERVER)</span>
<span class="udiff-line-added">+     for (auto&amp; document : documents)</span>
<span class="udiff-line-added">+         document-&gt;updateResizeObservations(*this);</span>
<span class="udiff-line-added">+ #endif</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     layoutIfNeeded();</span>
<span class="udiff-line-added">+ }</span>
  
  void Page::suspendScriptedAnimations()
  {
      m_scriptedAnimationsSuspended = true;
      for (Frame* frame = &amp;mainFrame(); frame; frame = frame-&gt;tree().traverseNext()) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1472,23 +1506,10 @@</span>
  void Page::setSessionStorage(RefPtr&lt;StorageNamespace&gt;&amp;&amp; newStorage)
  {
      m_sessionStorage = WTFMove(newStorage);
  }
  
<span class="udiff-line-removed">- StorageNamespace* Page::ephemeralLocalStorage(bool optionalCreate)</span>
<span class="udiff-line-removed">- {</span>
<span class="udiff-line-removed">-     if (!m_ephemeralLocalStorage &amp;&amp; optionalCreate)</span>
<span class="udiff-line-removed">-         m_ephemeralLocalStorage = m_storageNamespaceProvider-&gt;createEphemeralLocalStorageNamespace(*this, m_settings-&gt;sessionStorageQuota());</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     return m_ephemeralLocalStorage.get();</span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">- void Page::setEphemeralLocalStorage(RefPtr&lt;StorageNamespace&gt;&amp;&amp; newStorage)</span>
<span class="udiff-line-removed">- {</span>
<span class="udiff-line-removed">-     m_ephemeralLocalStorage = WTFMove(newStorage);</span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-removed">- </span>
  bool Page::hasCustomHTMLTokenizerTimeDelay() const
  {
      return m_settings-&gt;maxParseDuration() != -1;
  }
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1762,10 +1783,39 @@</span>
              document-&gt;resumeAllMediaPlayback();
      }
  #endif
  }
  
<span class="udiff-line-added">+ void Page::suspendAllMediaBuffering()</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+ #if ENABLE(VIDEO)</span>
<span class="udiff-line-added">+     ASSERT(!m_mediaBufferingIsSuspended);</span>
<span class="udiff-line-added">+     if (m_mediaBufferingIsSuspended)</span>
<span class="udiff-line-added">+         return;</span>
<span class="udiff-line-added">+     m_mediaBufferingIsSuspended = true;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     for (Frame* frame = &amp;mainFrame(); frame; frame = frame-&gt;tree().traverseNext()) {</span>
<span class="udiff-line-added">+         if (auto* document = frame-&gt;document())</span>
<span class="udiff-line-added">+             document-&gt;suspendAllMediaBuffering();</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ #endif</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ void Page::resumeAllMediaBuffering()</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+ #if ENABLE(VIDEO)</span>
<span class="udiff-line-added">+     if (!m_mediaBufferingIsSuspended)</span>
<span class="udiff-line-added">+         return;</span>
<span class="udiff-line-added">+     m_mediaBufferingIsSuspended = false;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     for (Frame* frame = &amp;mainFrame(); frame; frame = frame-&gt;tree().traverseNext()) {</span>
<span class="udiff-line-added">+         if (auto* document = frame-&gt;document())</span>
<span class="udiff-line-added">+             document-&gt;resumeAllMediaBuffering();</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ #endif</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
  #if ENABLE(MEDIA_SESSION)
  void Page::handleMediaEvent(MediaEventType eventType)
  {
      switch (eventType) {
      case MediaEventType::PlayPause:
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -2131,11 +2181,11 @@</span>
      // DidHitRelevantRepaintedObjectsAreaThreshold is a LayoutMilestone intended to indicate that
      // a certain relevant amount of content has been drawn to the screen. This is the rect that
      // has been determined to be relevant in the context of this goal. We may choose to tweak
      // the rect over time, much like we may choose to tweak gMinimumPaintedAreaRatio and
      // gMaximumUnpaintedAreaRatio. But this seems to work well right now.
<span class="udiff-line-modified-removed">-     LayoutRect relevantViewRect { 0, 0, relevantViewRectWidth, 1300 };</span>
<span class="udiff-line-modified-added">+     LayoutRect relevantViewRect { 0, 0, LayoutUnit(relevantViewRectWidth), 1300 };</span>
      // If the viewRect is wider than the relevantViewRect, center the relevantViewRect.
      if (viewRect.width() &gt; relevantViewRect.width())
          relevantViewRect.setX((viewRect.width() - relevantViewRect.width()) / 2);
  
      return relevantViewRect;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -2367,23 +2417,16 @@</span>
          return;
      }
      diagnosticLoggingClient().logDiagnosticMessage(DiagnosticLoggingKeys::navigationKey(), navigationDescription, ShouldSample::No);
  
      if (!navigation.domain.isEmpty())
<span class="udiff-line-modified-removed">-         diagnosticLoggingClient().logDiagnosticMessageWithEnhancedPrivacy(DiagnosticLoggingKeys::domainVisitedKey(), navigation.domain, ShouldSample::Yes);</span>
<span class="udiff-line-modified-added">+         diagnosticLoggingClient().logDiagnosticMessageWithEnhancedPrivacy(DiagnosticLoggingKeys::domainVisitedKey(), navigation.domain.string(), ShouldSample::Yes);</span>
  }
  
  void Page::mainFrameLoadStarted(const URL&amp; destinationURL, FrameLoadType type)
  {
<span class="udiff-line-modified-removed">-     String domain;</span>
<span class="udiff-line-removed">- #if ENABLE(PUBLIC_SUFFIX_LIST)</span>
<span class="udiff-line-removed">-     domain = topPrivatelyControlledDomain(destinationURL.host().toString());</span>
<span class="udiff-line-removed">- #else</span>
<span class="udiff-line-removed">-     UNUSED_PARAM(destinationURL);</span>
<span class="udiff-line-removed">- #endif</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     Navigation navigation = { domain, type };</span>
<span class="udiff-line-modified-added">+     Navigation navigation = { RegistrableDomain { destinationURL }, type };</span>
  
      // To avoid being too verbose, we only log navigations if the page is or becomes visible. This avoids logging non-user observable loads.
      if (!isVisible()) {
          m_navigationToLogWhenVisible = navigation;
          return;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -2410,19 +2453,10 @@</span>
      m_userContentProvider-&gt;addPage(*this);
  
      invalidateInjectedStyleSheetCacheInAllFrames();
  }
  
<span class="udiff-line-removed">- void Page::setStorageNamespaceProvider(Ref&lt;StorageNamespaceProvider&gt;&amp;&amp; storageNamespaceProvider)</span>
<span class="udiff-line-removed">- {</span>
<span class="udiff-line-removed">-     m_storageNamespaceProvider-&gt;removePage(*this);</span>
<span class="udiff-line-removed">-     m_storageNamespaceProvider = WTFMove(storageNamespaceProvider);</span>
<span class="udiff-line-removed">-     m_storageNamespaceProvider-&gt;addPage(*this);</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     // This needs to reset all the local storage namespaces of all the pages.</span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-removed">- </span>
  VisitedLinkStore&amp; Page::visitedLinkStore()
  {
      return m_visitedLinkStore;
  }
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -2447,21 +2481,24 @@</span>
  #if ENABLE(INDEXED_DATABASE)
      if (sessionID != m_sessionID)
          m_idbConnectionToServer = nullptr;
  #endif
  
<span class="udiff-line-added">+     if (sessionID != m_sessionID &amp;&amp; m_sessionStorage)</span>
<span class="udiff-line-added">+         m_sessionStorage-&gt;setSessionIDForTesting(sessionID);</span>
<span class="udiff-line-added">+ </span>
      bool privateBrowsingStateChanged = (sessionID.isEphemeral() != m_sessionID.isEphemeral());
  
      m_sessionID = sessionID;
  
      if (!privateBrowsingStateChanged)
          return;
  
      for (Frame* frame = &amp;mainFrame(); frame; frame = frame-&gt;tree().traverseNext()) {
          if (!frame-&gt;document())
              continue;
<span class="udiff-line-modified-removed">-         frame-&gt;document()-&gt;privateBrowsingStateDidChange();</span>
<span class="udiff-line-modified-added">+         frame-&gt;document()-&gt;privateBrowsingStateDidChange(m_sessionID);</span>
      }
  
      // Collect the PluginViews in to a vector to ensure that action the plug-in takes
      // from below privateBrowsingStateChanged does not affect their lifetime.
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -2594,11 +2631,11 @@</span>
          m_resourceUsageOverlay = nullptr;
          return;
      }
  
      if (!m_resourceUsageOverlay &amp;&amp; m_settings-&gt;acceleratedCompositingEnabled())
<span class="udiff-line-modified-removed">-         m_resourceUsageOverlay = std::make_unique&lt;ResourceUsageOverlay&gt;(*this);</span>
<span class="udiff-line-modified-added">+         m_resourceUsageOverlay = makeUnique&lt;ResourceUsageOverlay&gt;(*this);</span>
  }
  #endif
  
  bool Page::isAlwaysOnLoggingAllowed() const
  {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -2639,23 +2676,10 @@</span>
          document-&gt;styleScope().evaluateMediaQueriesForAppearanceChange();
          document-&gt;evaluateMediaQueryList();
      }
  }
  
<span class="udiff-line-removed">- void Page::installedPageOverlaysChanged()</span>
<span class="udiff-line-removed">- {</span>
<span class="udiff-line-removed">-     if (isInWindow()) {</span>
<span class="udiff-line-removed">-         if (pageOverlayController().hasViewOverlays())</span>
<span class="udiff-line-removed">-             chrome().client().attachViewOverlayGraphicsLayer(&amp;pageOverlayController().layerWithViewOverlays());</span>
<span class="udiff-line-removed">-         else</span>
<span class="udiff-line-removed">-             chrome().client().attachViewOverlayGraphicsLayer(nullptr);</span>
<span class="udiff-line-removed">-     }</span>
<span class="udiff-line-removed">- </span>
<span class="udiff-line-removed">-     if (auto* frameView = mainFrame().view())</span>
<span class="udiff-line-removed">-         frameView-&gt;setNeedsCompositingConfigurationUpdate();</span>
<span class="udiff-line-removed">- }</span>
<span class="udiff-line-removed">- </span>
  void Page::setUnobscuredSafeAreaInsets(const FloatBoxExtent&amp; insets)
  {
      if (m_unobscuredSafeAreaInsets == insets)
          return;
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -2686,29 +2710,37 @@</span>
          document-&gt;extensionStyleSheets().clearPageUserSheet();
          document-&gt;extensionStyleSheets().invalidateInjectedStyleSheetCache();
      }
  }
  
<span class="udiff-line-modified-removed">- void Page::setUseDarkAppearance(bool value)</span>
<span class="udiff-line-modified-added">+ void Page::effectiveAppearanceDidChange(bool useDarkAppearance, bool useElevatedUserInterfaceLevel)</span>
  {
<span class="udiff-line-modified-removed">- #if HAVE(OS_DARK_MODE_SUPPORT)</span>
<span class="udiff-line-modified-removed">-     if (m_useDarkAppearance == value)</span>
<span class="udiff-line-modified-added">+ #if ENABLE(DARK_MODE_CSS)</span>
<span class="udiff-line-modified-added">+     if (m_useDarkAppearance == useDarkAppearance &amp;&amp; m_useElevatedUserInterfaceLevel == useElevatedUserInterfaceLevel)</span>
          return;
  
<span class="udiff-line-modified-removed">-     m_useDarkAppearance = value;</span>
<span class="udiff-line-modified-added">+     m_useDarkAppearance = useDarkAppearance;</span>
<span class="udiff-line-added">+     m_useElevatedUserInterfaceLevel = useElevatedUserInterfaceLevel;</span>
  
<span class="udiff-line-modified-removed">-     InspectorInstrumentation::defaultAppearanceDidChange(*this, value);</span>
<span class="udiff-line-modified-added">+     InspectorInstrumentation::defaultAppearanceDidChange(*this, useDarkAppearance);</span>
  
      appearanceDidChange();
  #else
<span class="udiff-line-modified-removed">-     UNUSED_PARAM(value);</span>
<span class="udiff-line-modified-added">+     UNUSED_PARAM(useDarkAppearance);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     if (m_useElevatedUserInterfaceLevel == useElevatedUserInterfaceLevel)</span>
<span class="udiff-line-added">+         return;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     m_useElevatedUserInterfaceLevel = useElevatedUserInterfaceLevel;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     appearanceDidChange();</span>
  #endif
  }
  
  bool Page::useDarkAppearance() const
  {
<span class="udiff-line-modified-removed">- #if HAVE(OS_DARK_MODE_SUPPORT)</span>
<span class="udiff-line-modified-added">+ #if ENABLE(DARK_MODE_CSS)</span>
      FrameView* view = mainFrame().view();
      if (!view || !equalLettersIgnoringASCIICase(view-&gt;mediaType(), &quot;screen&quot;))
          return false;
      if (m_useDarkAppearanceOverride)
          return m_useDarkAppearanceOverride.value();
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -2761,11 +2793,11 @@</span>
  {
  #if ENABLE(FULLSCREEN_API)
      for (Frame* frame = &amp;mainFrame(); frame; frame = frame-&gt;tree().traverseNext()) {
          if (!frame-&gt;document())
              continue;
<span class="udiff-line-modified-removed">-         frame-&gt;document()-&gt;setFullscreenControlsHidden(hidden);</span>
<span class="udiff-line-modified-added">+         frame-&gt;document()-&gt;fullscreenManager().setFullscreenControlsHidden(hidden);</span>
      }
  #else
      UNUSED_PARAM(hidden);
  #endif
  }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -2811,10 +2843,20 @@</span>
  void Page::didChangeMainDocument()
  {
  #if ENABLE(WEB_RTC)
      m_rtcController.reset(m_shouldEnableICECandidateFilteringByDefault);
  #endif
<span class="udiff-line-added">+ #if ENABLE(POINTER_EVENTS)</span>
<span class="udiff-line-added">+     m_pointerCaptureController-&gt;reset();</span>
<span class="udiff-line-added">+ #endif</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ RenderingUpdateScheduler&amp; Page::renderingUpdateScheduler()</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     if (!m_renderingUpdateScheduler)</span>
<span class="udiff-line-added">+         m_renderingUpdateScheduler = RenderingUpdateScheduler::create(*this);</span>
<span class="udiff-line-added">+     return *m_renderingUpdateScheduler;</span>
  }
  
  void Page::forEachDocument(const Function&lt;void(Document&amp;)&gt;&amp; functor)
  {
      for (Frame* frame = &amp;mainFrame(); frame; frame = frame-&gt;tree().traverseNext()) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -2890,13 +2932,84 @@</span>
          return targetNode.isEqualNode(wheelElement);
      });
  }
  #endif // PLATFORM(MAC)
  
<span class="udiff-line-added">+ static void dispatchPrintEvent(Frame&amp; mainFrame, const AtomString&amp; eventType)</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     Vector&lt;Ref&lt;Frame&gt;&gt; frames;</span>
<span class="udiff-line-added">+     for (auto* frame = &amp;mainFrame; frame; frame = frame-&gt;tree().traverseNext())</span>
<span class="udiff-line-added">+         frames.append(*frame);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     for (auto&amp; frame : frames) {</span>
<span class="udiff-line-added">+         if (auto* window = frame-&gt;window())</span>
<span class="udiff-line-added">+             window-&gt;dispatchEvent(Event::create(eventType, Event::CanBubble::No, Event::IsCancelable::No), window-&gt;document());</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ void Page::dispatchBeforePrintEvent()</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     dispatchPrintEvent(m_mainFrame, eventNames().beforeprintEvent);</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ void Page::dispatchAfterPrintEvent()</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     dispatchPrintEvent(m_mainFrame, eventNames().afterprintEvent);</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
  #if ENABLE(APPLE_PAY)
  void Page::setPaymentCoordinator(std::unique_ptr&lt;PaymentCoordinator&gt;&amp;&amp; paymentCoordinator)
  {
      m_paymentCoordinator = WTFMove(paymentCoordinator);
  }
  #endif
  
<span class="udiff-line-added">+ void Page::configureLoggingChannel(const String&amp; channelName, WTFLogChannelState state, WTFLogLevel level)</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+ #if !RELEASE_LOG_DISABLED</span>
<span class="udiff-line-added">+     if (auto* channel = getLogChannel(channelName)) {</span>
<span class="udiff-line-added">+         channel-&gt;state = state;</span>
<span class="udiff-line-added">+         channel-&gt;level = level;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ #if USE(LIBWEBRTC)</span>
<span class="udiff-line-added">+         if (channel == &amp;LogWebRTC &amp;&amp; m_mainFrame-&gt;document())</span>
<span class="udiff-line-added">+             libWebRTCProvider().setEnableLogging(!m_mainFrame-&gt;document()-&gt;sessionID().isEphemeral());</span>
<span class="udiff-line-added">+ #endif</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     chrome().client().configureLoggingChannel(channelName, state, level);</span>
<span class="udiff-line-added">+ #else</span>
<span class="udiff-line-added">+     UNUSED_PARAM(channelName);</span>
<span class="udiff-line-added">+     UNUSED_PARAM(state);</span>
<span class="udiff-line-added">+     UNUSED_PARAM(level);</span>
<span class="udiff-line-added">+ #endif</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ void Page::didFinishLoadingImageForElement(HTMLImageElement&amp; element)</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     chrome().client().didFinishLoadingImageForElement(element);</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ #if ENABLE(TEXT_AUTOSIZING)</span>
<span class="udiff-line-added">+ void Page::recomputeTextAutoSizingInAllFrames()</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     ASSERT(settings().textAutosizingEnabled() &amp;&amp; settings().textAutosizingUsesIdempotentMode());</span>
<span class="udiff-line-added">+     for (auto* frame = &amp;mainFrame(); frame; frame = frame-&gt;tree().traverseNext()) {</span>
<span class="udiff-line-added">+         if (!frame-&gt;document())</span>
<span class="udiff-line-added">+             continue;</span>
<span class="udiff-line-added">+         auto&amp; document = *frame-&gt;document();</span>
<span class="udiff-line-added">+         if (!document.renderView() || !document.styleScope().resolverIfExists())</span>
<span class="udiff-line-added">+             continue;</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+         auto&amp; styleResolver = document.styleScope().resolver();</span>
<span class="udiff-line-added">+         for (auto&amp; renderer : descendantsOfType&lt;RenderElement&gt;(*document.renderView())) {</span>
<span class="udiff-line-added">+             if (auto* element = renderer.element()) {</span>
<span class="udiff-line-added">+                 auto needsLayout = styleResolver.adjustRenderStyleForTextAutosizing(renderer.mutableStyle(), *element);</span>
<span class="udiff-line-added">+                 if (needsLayout)</span>
<span class="udiff-line-added">+                     renderer.setNeedsLayout();</span>
<span class="udiff-line-added">+             }</span>
<span class="udiff-line-added">+         }</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ #endif</span>
<span class="udiff-line-added">+ </span>
  } // namespace WebCore
</pre>
<center><a href="NavigatorBase.h.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="Page.h.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>