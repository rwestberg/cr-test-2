<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff modules/javafx.web/src/main/native/Source/JavaScriptCore/runtime/IntlPluralRules.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="IntlObject.h.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="IntlPluralRulesConstructor.cpp.cdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/JavaScriptCore/runtime/IntlPluralRules.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 1,7 ***</span>
<span class="line-new-header">--- 1,8 ---</span>
  /*
   * Copyright (C) 2018 Andy VanWagoner (andy@vanwagoner.family)
<span class="line-added">+  * Copyright (C) 2019 Apple Inc. All rights reserved.</span>
   *
   * Redistribution and use in source and binary forms, with or without
   * modification, are permitted provided that the following conditions
   * are met:
   * 1. Redistributions of source code must retain the above copyright
</pre>
<hr />
<pre>
<span class="line-old-header">*** 131,38 ***</span>
      if (m_locale.isEmpty()) {
          throwTypeError(&amp;exec, scope, &quot;failed to initialize PluralRules due to invalid locale&quot;_s);
          return;
      }
  
<span class="line-modified">!     String typeString = intlStringOption(exec, options, Identifier::fromString(&amp;vm, &quot;type&quot;), { &quot;cardinal&quot;, &quot;ordinal&quot; }, &quot;type must be \&quot;cardinal\&quot; or \&quot;ordinal\&quot;&quot;, &quot;cardinal&quot;);</span>
      RETURN_IF_EXCEPTION(scope, void());
      m_type = typeString == &quot;ordinal&quot; ? UPLURAL_TYPE_ORDINAL : UPLURAL_TYPE_CARDINAL;
  
<span class="line-modified">!     unsigned minimumIntegerDigits = intlNumberOption(exec, options, Identifier::fromString(&amp;vm, &quot;minimumIntegerDigits&quot;), 1, 21, 1);</span>
      RETURN_IF_EXCEPTION(scope, void());
      m_minimumIntegerDigits = minimumIntegerDigits;
  
      unsigned minimumFractionDigitsDefault = 0;
<span class="line-modified">!     unsigned minimumFractionDigits = intlNumberOption(exec, options, Identifier::fromString(&amp;vm, &quot;minimumFractionDigits&quot;), 0, 20, minimumFractionDigitsDefault);</span>
      RETURN_IF_EXCEPTION(scope, void());
      m_minimumFractionDigits = minimumFractionDigits;
  
      unsigned maximumFractionDigitsDefault = std::max(minimumFractionDigits, 3u);
<span class="line-modified">!     unsigned maximumFractionDigits = intlNumberOption(exec, options, Identifier::fromString(&amp;vm, &quot;maximumFractionDigits&quot;), minimumFractionDigits, 20, maximumFractionDigitsDefault);</span>
      RETURN_IF_EXCEPTION(scope, void());
      m_maximumFractionDigits = maximumFractionDigits;
  
<span class="line-modified">!     JSValue minimumSignificantDigitsValue = options-&gt;get(&amp;exec, Identifier::fromString(&amp;vm, &quot;minimumSignificantDigits&quot;));</span>
      RETURN_IF_EXCEPTION(scope, void());
  
<span class="line-modified">!     JSValue maximumSignificantDigitsValue = options-&gt;get(&amp;exec, Identifier::fromString(&amp;vm, &quot;maximumSignificantDigits&quot;));</span>
      RETURN_IF_EXCEPTION(scope, void());
  
      if (!minimumSignificantDigitsValue.isUndefined() || !maximumSignificantDigitsValue.isUndefined()) {
<span class="line-modified">!         unsigned minimumSignificantDigits = intlNumberOption(exec, options, Identifier::fromString(&amp;vm, &quot;minimumSignificantDigits&quot;), 1, 21, 1);</span>
          RETURN_IF_EXCEPTION(scope, void());
<span class="line-modified">!         unsigned maximumSignificantDigits = intlNumberOption(exec, options, Identifier::fromString(&amp;vm, &quot;maximumSignificantDigits&quot;), minimumSignificantDigits, 21, 21);</span>
          RETURN_IF_EXCEPTION(scope, void());
          m_minimumSignificantDigits = minimumSignificantDigits;
          m_maximumSignificantDigits = maximumSignificantDigits;
      }
  
<span class="line-new-header">--- 132,38 ---</span>
      if (m_locale.isEmpty()) {
          throwTypeError(&amp;exec, scope, &quot;failed to initialize PluralRules due to invalid locale&quot;_s);
          return;
      }
  
<span class="line-modified">!     String typeString = intlStringOption(exec, options, Identifier::fromString(vm, &quot;type&quot;), { &quot;cardinal&quot;, &quot;ordinal&quot; }, &quot;type must be \&quot;cardinal\&quot; or \&quot;ordinal\&quot;&quot;, &quot;cardinal&quot;);</span>
      RETURN_IF_EXCEPTION(scope, void());
      m_type = typeString == &quot;ordinal&quot; ? UPLURAL_TYPE_ORDINAL : UPLURAL_TYPE_CARDINAL;
  
<span class="line-modified">!     unsigned minimumIntegerDigits = intlNumberOption(exec, options, Identifier::fromString(vm, &quot;minimumIntegerDigits&quot;), 1, 21, 1);</span>
      RETURN_IF_EXCEPTION(scope, void());
      m_minimumIntegerDigits = minimumIntegerDigits;
  
      unsigned minimumFractionDigitsDefault = 0;
<span class="line-modified">!     unsigned minimumFractionDigits = intlNumberOption(exec, options, Identifier::fromString(vm, &quot;minimumFractionDigits&quot;), 0, 20, minimumFractionDigitsDefault);</span>
      RETURN_IF_EXCEPTION(scope, void());
      m_minimumFractionDigits = minimumFractionDigits;
  
      unsigned maximumFractionDigitsDefault = std::max(minimumFractionDigits, 3u);
<span class="line-modified">!     unsigned maximumFractionDigits = intlNumberOption(exec, options, Identifier::fromString(vm, &quot;maximumFractionDigits&quot;), minimumFractionDigits, 20, maximumFractionDigitsDefault);</span>
      RETURN_IF_EXCEPTION(scope, void());
      m_maximumFractionDigits = maximumFractionDigits;
  
<span class="line-modified">!     JSValue minimumSignificantDigitsValue = options-&gt;get(&amp;exec, Identifier::fromString(vm, &quot;minimumSignificantDigits&quot;));</span>
      RETURN_IF_EXCEPTION(scope, void());
  
<span class="line-modified">!     JSValue maximumSignificantDigitsValue = options-&gt;get(&amp;exec, Identifier::fromString(vm, &quot;maximumSignificantDigits&quot;));</span>
      RETURN_IF_EXCEPTION(scope, void());
  
      if (!minimumSignificantDigitsValue.isUndefined() || !maximumSignificantDigitsValue.isUndefined()) {
<span class="line-modified">!         unsigned minimumSignificantDigits = intlNumberOption(exec, options, Identifier::fromString(vm, &quot;minimumSignificantDigits&quot;), 1, 21, 1);</span>
          RETURN_IF_EXCEPTION(scope, void());
<span class="line-modified">!         unsigned maximumSignificantDigits = intlNumberOption(exec, options, Identifier::fromString(vm, &quot;maximumSignificantDigits&quot;), minimumSignificantDigits, 21, 21);</span>
          RETURN_IF_EXCEPTION(scope, void());
          m_minimumSignificantDigits = minimumSignificantDigits;
          m_maximumSignificantDigits = maximumSignificantDigits;
      }
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 198,43 ***</span>
      VM&amp; vm = exec.vm();
      auto scope = DECLARE_THROW_SCOPE(vm);
  
      // 13.4.4 Intl.PluralRules.prototype.resolvedOptions ()
      // https://tc39.github.io/ecma402/#sec-intl.pluralrules.prototype.resolvedoptions
<span class="line-modified">!     if (!m_initializedPluralRules)</span>
<span class="line-modified">!         return throwTypeError(&amp;exec, scope, &quot;Intl.PluralRules.prototype.resolvedOptions called on value that&#39;s not an object initialized as a PluralRules&quot;_s);</span>
  
      JSObject* options = constructEmptyObject(&amp;exec);
<span class="line-modified">!     options-&gt;putDirect(vm, vm.propertyNames-&gt;locale, jsNontrivialString(&amp;exec, m_locale));</span>
<span class="line-modified">!     options-&gt;putDirect(vm, Identifier::fromString(&amp;vm, &quot;type&quot;), jsNontrivialString(&amp;exec, m_type == UPLURAL_TYPE_ORDINAL ? &quot;ordinal&quot;_s : &quot;cardinal&quot;_s));</span>
<span class="line-modified">!     options-&gt;putDirect(vm, Identifier::fromString(&amp;vm, &quot;minimumIntegerDigits&quot;), jsNumber(m_minimumIntegerDigits));</span>
<span class="line-modified">!     options-&gt;putDirect(vm, Identifier::fromString(&amp;vm, &quot;minimumFractionDigits&quot;), jsNumber(m_minimumFractionDigits));</span>
<span class="line-modified">!     options-&gt;putDirect(vm, Identifier::fromString(&amp;vm, &quot;maximumFractionDigits&quot;), jsNumber(m_maximumFractionDigits));</span>
      if (m_minimumSignificantDigits) {
<span class="line-modified">!         options-&gt;putDirect(vm, Identifier::fromString(&amp;vm, &quot;minimumSignificantDigits&quot;), jsNumber(m_minimumSignificantDigits.value()));</span>
<span class="line-modified">!         options-&gt;putDirect(vm, Identifier::fromString(&amp;vm, &quot;maximumSignificantDigits&quot;), jsNumber(m_maximumSignificantDigits.value()));</span>
      }
  
  #if HAVE(ICU_PLURALRULES_KEYWORDS)
      JSGlobalObject* globalObject = exec.jsCallee()-&gt;globalObject(vm);
      JSArray* categories = JSArray::tryCreate(vm, globalObject-&gt;arrayStructureForIndexingTypeDuringAllocation(ArrayWithContiguous), 0);
<span class="line-modified">!     if (!categories)</span>
<span class="line-modified">!         return throwOutOfMemoryError(&amp;exec, scope);</span>
  
      UErrorCode status = U_ZERO_ERROR;
      auto keywords = std::unique_ptr&lt;UEnumeration, UEnumerationDeleter&gt;(uplrules_getKeywords(m_pluralRules.get(), &amp;status));
      ASSERT(U_SUCCESS(status));
      int32_t resultLength;
  
      // Category names are always ASCII, so use char[].
      unsigned index = 0;
      while (const char* result = uenum_next(keywords.get(), &amp;resultLength, &amp;status)) {
          ASSERT(U_SUCCESS(status));
<span class="line-modified">!         categories-&gt;putDirectIndex(&amp;exec, index++, jsNontrivialString(&amp;exec, String(result, resultLength)));</span>
          RETURN_IF_EXCEPTION(scope, { });
      }
<span class="line-modified">!     options-&gt;putDirect(vm, Identifier::fromString(&amp;vm, &quot;pluralCategories&quot;), categories);</span>
  #endif
  
      RELEASE_AND_RETURN(scope, options);
  }
  
<span class="line-new-header">--- 199,47 ---</span>
      VM&amp; vm = exec.vm();
      auto scope = DECLARE_THROW_SCOPE(vm);
  
      // 13.4.4 Intl.PluralRules.prototype.resolvedOptions ()
      // https://tc39.github.io/ecma402/#sec-intl.pluralrules.prototype.resolvedoptions
<span class="line-modified">!     if (UNLIKELY(!m_initializedPluralRules)) {</span>
<span class="line-modified">!         throwTypeError(&amp;exec, scope, &quot;Intl.PluralRules.prototype.resolvedOptions called on value that&#39;s not an object initialized as a PluralRules&quot;_s);</span>
<span class="line-added">+         return nullptr;</span>
<span class="line-added">+     }</span>
  
      JSObject* options = constructEmptyObject(&amp;exec);
<span class="line-modified">!     options-&gt;putDirect(vm, vm.propertyNames-&gt;locale, jsNontrivialString(vm, m_locale));</span>
<span class="line-modified">!     options-&gt;putDirect(vm, Identifier::fromString(vm, &quot;type&quot;), jsNontrivialString(vm, m_type == UPLURAL_TYPE_ORDINAL ? &quot;ordinal&quot;_s : &quot;cardinal&quot;_s));</span>
<span class="line-modified">!     options-&gt;putDirect(vm, Identifier::fromString(vm, &quot;minimumIntegerDigits&quot;), jsNumber(m_minimumIntegerDigits));</span>
<span class="line-modified">!     options-&gt;putDirect(vm, Identifier::fromString(vm, &quot;minimumFractionDigits&quot;), jsNumber(m_minimumFractionDigits));</span>
<span class="line-modified">!     options-&gt;putDirect(vm, Identifier::fromString(vm, &quot;maximumFractionDigits&quot;), jsNumber(m_maximumFractionDigits));</span>
      if (m_minimumSignificantDigits) {
<span class="line-modified">!         options-&gt;putDirect(vm, Identifier::fromString(vm, &quot;minimumSignificantDigits&quot;), jsNumber(m_minimumSignificantDigits.value()));</span>
<span class="line-modified">!         options-&gt;putDirect(vm, Identifier::fromString(vm, &quot;maximumSignificantDigits&quot;), jsNumber(m_maximumSignificantDigits.value()));</span>
      }
  
  #if HAVE(ICU_PLURALRULES_KEYWORDS)
      JSGlobalObject* globalObject = exec.jsCallee()-&gt;globalObject(vm);
      JSArray* categories = JSArray::tryCreate(vm, globalObject-&gt;arrayStructureForIndexingTypeDuringAllocation(ArrayWithContiguous), 0);
<span class="line-modified">!     if (UNLIKELY(!categories)) {</span>
<span class="line-modified">!         throwOutOfMemoryError(&amp;exec, scope);</span>
<span class="line-added">+         return nullptr;</span>
<span class="line-added">+     }</span>
  
      UErrorCode status = U_ZERO_ERROR;
      auto keywords = std::unique_ptr&lt;UEnumeration, UEnumerationDeleter&gt;(uplrules_getKeywords(m_pluralRules.get(), &amp;status));
      ASSERT(U_SUCCESS(status));
      int32_t resultLength;
  
      // Category names are always ASCII, so use char[].
      unsigned index = 0;
      while (const char* result = uenum_next(keywords.get(), &amp;resultLength, &amp;status)) {
          ASSERT(U_SUCCESS(status));
<span class="line-modified">!         categories-&gt;putDirectIndex(&amp;exec, index++, jsNontrivialString(vm, String(result, resultLength)));</span>
          RETURN_IF_EXCEPTION(scope, { });
      }
<span class="line-modified">!     options-&gt;putDirect(vm, Identifier::fromString(vm, &quot;pluralCategories&quot;), categories);</span>
  #endif
  
      RELEASE_AND_RETURN(scope, options);
  }
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 247,11 ***</span>
      // https://tc39.github.io/ecma402/#sec-resolveplural
      if (!m_initializedPluralRules)
          return throwTypeError(&amp;exec, scope, &quot;Intl.PluralRules.prototype.select called on value that&#39;s not an object initialized as a PluralRules&quot;_s);
  
      if (!std::isfinite(value))
<span class="line-modified">!         return jsNontrivialString(&amp;exec, &quot;other&quot;_s);</span>
  
  #if HAVE(ICU_PLURALRULES_WITH_FORMAT)
      UErrorCode status = U_ZERO_ERROR;
      Vector&lt;UChar, 8&gt; result(8);
      auto length = uplrules_selectWithFormat(m_pluralRules.get(), value, m_numberFormat.get(), result.data(), result.size(), &amp;status);
<span class="line-new-header">--- 252,11 ---</span>
      // https://tc39.github.io/ecma402/#sec-resolveplural
      if (!m_initializedPluralRules)
          return throwTypeError(&amp;exec, scope, &quot;Intl.PluralRules.prototype.select called on value that&#39;s not an object initialized as a PluralRules&quot;_s);
  
      if (!std::isfinite(value))
<span class="line-modified">!         return jsNontrivialString(vm, &quot;other&quot;_s);</span>
  
  #if HAVE(ICU_PLURALRULES_WITH_FORMAT)
      UErrorCode status = U_ZERO_ERROR;
      Vector&lt;UChar, 8&gt; result(8);
      auto length = uplrules_selectWithFormat(m_pluralRules.get(), value, m_numberFormat.get(), result.data(), result.size(), &amp;status);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 279,11 ***</span>
      length = uplrules_select(m_pluralRules.get(), formatted, result.data(), result.size(), &amp;status);
      if (U_FAILURE(status))
          return throwTypeError(&amp;exec, scope, &quot;failed to select plural value&quot;_s);
  #endif
  
<span class="line-modified">!     return jsString(&amp;exec, String(result.data(), length));</span>
  }
  
  } // namespace JSC
  
  #endif // ENABLE(INTL)
<span class="line-new-header">--- 284,11 ---</span>
      length = uplrules_select(m_pluralRules.get(), formatted, result.data(), result.size(), &amp;status);
      if (U_FAILURE(status))
          return throwTypeError(&amp;exec, scope, &quot;failed to select plural value&quot;_s);
  #endif
  
<span class="line-modified">!     return jsString(vm, String(result.data(), length));</span>
  }
  
  } // namespace JSC
  
  #endif // ENABLE(INTL)
</pre>
<center><a href="IntlObject.h.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="IntlPluralRulesConstructor.cpp.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>