<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames modules/javafx.web/src/main/native/Source/WebKitLegacy/java/WebCoreSupport/FrameLoaderClientJava.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>   1 /*
   2  * Copyright (c) 2011, 2019, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.  Oracle designates this
   8  * particular file as subject to the &quot;Classpath&quot; exception as provided
   9  * by Oracle in the LICENSE file that accompanied this code.
  10  *
  11  * This code is distributed in the hope that it will be useful, but WITHOUT
  12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  14  * version 2 for more details (a copy is included in the LICENSE file that
  15  * accompanied this code).
  16  *
  17  * You should have received a copy of the GNU General Public License version
  18  * 2 along with this work; if not, write to the Free Software Foundation,
  19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  20  *
  21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  22  * or visit www.oracle.com if you need additional information or have any
  23  * questions.
  24  */
  25 
  26 
  27 #include &quot;FrameLoaderClientJava.h&quot;
  28 #include &quot;FrameNetworkingContextJava.h&quot;
  29 #include &quot;WebPage.h&quot;
  30 
  31 #include &lt;JavaScriptCore/APICast.h&gt;
  32 #include &lt;JavaScriptCore/JavaScript.h&gt;
  33 #include &lt;WebCore/AuthenticationChallenge.h&gt;
  34 #include &lt;WebCore/Chrome.h&gt;
  35 #include &lt;WebCore/DNS.h&gt;
  36 #include &lt;WebCore/DocumentLoader.h&gt;
  37 #include &lt;WebCore/FormState.h&gt;
  38 #include &lt;WebCore/Frame.h&gt;
  39 #include &lt;WebCore/FrameLoadRequest.h&gt;
  40 #include &lt;WebCore/FrameTree.h&gt;
  41 #include &lt;WebCore/FrameView.h&gt;
  42 #include &lt;WebCore/HTMLFormElement.h&gt;
  43 #include &lt;WebCore/HistoryItem.h&gt;
  44 #include &lt;WebCore/MIMETypeRegistry.h&gt;
  45 #include &lt;WebCore/NotImplemented.h&gt;
  46 #include &lt;WebCore/Page.h&gt;
  47 #include &lt;WebCore/PluginWidgetJava.h&gt;
  48 #include &lt;WebCore/PolicyChecker.h&gt;
  49 #include &lt;WebCore/ProgressTracker.h&gt;
  50 #include &lt;WebCore/ScriptController.h&gt;
  51 #include &lt;WebCore/Settings.h&gt;
  52 #include &lt;WebCore/WindowFeatures.h&gt;
  53 
  54 #include &quot;com_sun_webkit_LoadListenerClient.h&quot;
  55 
  56 namespace WebCore {
  57 
  58 namespace FrameLoaderClientJavaInternal {
  59 
  60 static JGClass webPageClass;
  61 static JGClass networkContextClass;
  62 
  63 static jmethodID setRequestURLMID;
  64 static jmethodID removeRequestURLMID;
  65 
  66 static jmethodID fireLoadEventMID;
  67 static jmethodID fireResourceLoadEventMID;
  68 static jmethodID canHandleURLMID;
  69 
  70 static jmethodID permitNavigateActionMID;
  71 static jmethodID permitRedirectActionMID;
  72 static jmethodID permitAcceptResourceActionMID;
  73 static jmethodID permitSubmitDataActionMID;
  74 static jmethodID permitEnableScriptsActionMID;
  75 static jmethodID permitNewWindowActionMID;
  76 
  77 static jmethodID didClearWindowObjectMID;
  78 
  79 static jmethodID frameCreatedMID;
  80 static jmethodID frameDestroyedMID;
  81 
  82 static void initRefs(JNIEnv* env)
  83 {
  84     if (!webPageClass) {
  85         webPageClass = JLClass(env-&gt;FindClass(
  86             &quot;com/sun/webkit/WebPage&quot;));
  87         ASSERT(webPageClass);
  88 
  89         setRequestURLMID = env-&gt;GetMethodID(webPageClass, &quot;fwkSetRequestURL&quot;, &quot;(JILjava/lang/String;)V&quot;);
  90         ASSERT(setRequestURLMID);
  91         removeRequestURLMID = env-&gt;GetMethodID(webPageClass, &quot;fwkRemoveRequestURL&quot;, &quot;(JI)V&quot;);
  92         ASSERT(removeRequestURLMID);
  93 
  94         fireLoadEventMID = env-&gt;GetMethodID(webPageClass, &quot;fwkFireLoadEvent&quot;,
  95                                             &quot;(JILjava/lang/String;Ljava/lang/String;DI)V&quot;);
  96         ASSERT(fireLoadEventMID);
  97         fireResourceLoadEventMID = env-&gt;GetMethodID(webPageClass, &quot;fwkFireResourceLoadEvent&quot;,
  98                                                     &quot;(JIILjava/lang/String;DI)V&quot;);
  99         ASSERT(fireResourceLoadEventMID);
 100 
 101         permitNavigateActionMID = env-&gt;GetMethodID(webPageClass, &quot;fwkPermitNavigateAction&quot;,
 102                                                    &quot;(JLjava/lang/String;)Z&quot;);
 103         ASSERT(permitNavigateActionMID);
 104 
 105         permitRedirectActionMID = env-&gt;GetMethodID(webPageClass, &quot;fwkPermitRedirectAction&quot;,
 106                                                    &quot;(JLjava/lang/String;)Z&quot;);
 107         ASSERT(permitRedirectActionMID);
 108 
 109         permitAcceptResourceActionMID = env-&gt;GetMethodID(webPageClass, &quot;fwkPermitAcceptResourceAction&quot;,
 110                                                          &quot;(JLjava/lang/String;)Z&quot;);
 111         ASSERT(permitAcceptResourceActionMID);
 112 
 113         permitSubmitDataActionMID = env-&gt;GetMethodID(webPageClass, &quot;fwkPermitSubmitDataAction&quot;,
 114                                                      &quot;(JLjava/lang/String;Ljava/lang/String;Z)Z&quot;);
 115         ASSERT(permitSubmitDataActionMID);
 116 
 117         permitEnableScriptsActionMID = env-&gt;GetMethodID(webPageClass, &quot;fwkPermitEnableScriptsAction&quot;,
 118                                                         &quot;(JLjava/lang/String;)Z&quot;);
 119         ASSERT(permitEnableScriptsActionMID);
 120 
 121         permitNewWindowActionMID = env-&gt;GetMethodID(webPageClass, &quot;fwkPermitNewWindowAction&quot;,
 122                                                     &quot;(JLjava/lang/String;)Z&quot;);
 123         ASSERT(permitNewWindowActionMID);
 124 
 125         didClearWindowObjectMID = env-&gt;GetMethodID(webPageClass, &quot;fwkDidClearWindowObject&quot;, &quot;(JJ)V&quot;);
 126         ASSERT(didClearWindowObjectMID);
 127 
 128         frameCreatedMID = env-&gt;GetMethodID(webPageClass, &quot;fwkFrameCreated&quot;, &quot;(J)V&quot;);
 129         ASSERT(frameCreatedMID);
 130 
 131         frameDestroyedMID = env-&gt;GetMethodID(webPageClass, &quot;fwkFrameDestroyed&quot;, &quot;(J)V&quot;);
 132         ASSERT(frameDestroyedMID);
 133     }
 134     if (!networkContextClass) {
 135         networkContextClass = JLClass(env-&gt;FindClass(&quot;com/sun/webkit/network/NetworkContext&quot;));
 136         ASSERT(networkContextClass);
 137 
 138         canHandleURLMID = env-&gt;GetStaticMethodID(networkContextClass, &quot;canHandleURL&quot;, &quot;(Ljava/lang/String;)Z&quot;);
 139         ASSERT(canHandleURLMID);
 140     }
 141 }
 142 // This was copied from file &quot;WebKit/Source/WebKit/mac/Misc/WebKitErrors.h&quot;.
 143 enum {
 144     WebKitErrorCannotShowMIMEType =                             100,
 145     WebKitErrorCannotShowURL =                                  101,
 146     WebKitErrorFrameLoadInterruptedByPolicyChange =             102,
 147     WebKitErrorCannotUseRestrictedPort =                        103,
 148     WebKitErrorCannotFindPlugIn =                               200,
 149     WebKitErrorCannotLoadPlugIn =                               201,
 150     WebKitErrorJavaUnavailable =                                202,
 151     WebKitErrorPluginWillHandleLoad =                           203
 152 };
 153 
 154 enum ContentDispositionType {
 155     ContentDispositionNone,
 156     ContentDispositionInline,
 157     ContentDispositionAttachment,
 158     ContentDispositionOther
 159 };
 160 
 161 // Below function was removed after https://bugs.webkit.org/show_bug.cgi?id=163095
 162 // from HTTPParser.h.
 163 ContentDispositionType contentDispositionType(const String&amp; contentDisposition)
 164 {
 165     if (contentDisposition.isEmpty())
 166         return ContentDispositionNone;
 167 
 168     Vector&lt;String&gt; parameters = contentDisposition.split(&#39;;&#39;);
 169 
 170     String dispositionType = parameters[0];
 171     dispositionType.stripWhiteSpace();
 172 
 173     if (equalLettersIgnoringASCIICase(dispositionType, &quot;inline&quot;))
 174         return ContentDispositionInline;
 175 
 176     // Some broken sites just send bogus headers like
 177     //
 178     //   Content-Disposition: ; filename=&quot;file&quot;
 179     //   Content-Disposition: filename=&quot;file&quot;
 180     //   Content-Disposition: name=&quot;file&quot;
 181     //
 182     // without a disposition token... screen those out.
 183     if (!isValidHTTPToken(dispositionType))
 184         return ContentDispositionNone;
 185 
 186     // We have a content-disposition of &quot;attachment&quot; or unknown.
 187     // RFC 2183, section 2.8 says that an unknown disposition
 188     // value should be treated as &quot;attachment&quot;
 189     return ContentDispositionAttachment;
 190 }
 191 } // namespace
 192 
 193 FrameLoaderClientJava::FrameLoaderClientJava(const JLObject &amp;webPage)
 194     : m_page(nullptr)
 195     , m_frame(nullptr)
 196     , m_isPageRedirected(false)
 197     , m_hasRepresentation(false)
 198     , m_webPage(webPage)
 199 {
 200 }
 201 
 202 void FrameLoaderClientJava::dispatchDidNavigateWithinPage()
 203 {
 204     postLoadEvent(frame(),
 205                   com_sun_webkit_LoadListenerClient_PAGE_REPLACED,
 206                   frame()-&gt;document()-&gt;url(),
 207                   frame()-&gt;loader().documentLoader()-&gt;responseMIMEType(),
 208                   1.0 /* progress */);
 209 }
 210 
 211 void FrameLoaderClientJava::frameLoaderDestroyed()
 212 {
 213     using namespace FrameLoaderClientJavaInternal;
 214     WC_GETJAVAENV_CHKRET(env);
 215     initRefs(env);
 216 
 217     ASSERT(m_webPage);
 218     ASSERT(m_frame);
 219     env-&gt;CallVoidMethod(m_webPage, frameDestroyedMID, ptr_to_jlong(m_frame));
 220     WTF::CheckAndClearException(env);
 221 
 222     m_page = 0;
 223     m_frame = 0;
 224 
 225     delete this;
 226 }
 227 
 228 Page* FrameLoaderClientJava::page()
 229 {
 230     if (!m_page) {
 231         m_page = WebPage::pageFromJObject(m_webPage);
 232         ASSERT(m_page);
 233     }
 234     return m_page;
 235 }
 236 
 237 Frame* FrameLoaderClientJava::frame()
 238 {
 239     return m_frame;
 240 }
 241 
 242 void FrameLoaderClientJava::setFrame(Frame* frame)
 243 {
 244     ASSERT(frame);
 245     m_frame = frame;
 246 }
 247 
 248 void FrameLoaderClientJava::setRequestURL(Frame* f, int identifier, String url)
 249 {
 250     using namespace FrameLoaderClientJavaInternal;
 251     JNIEnv* env = WTF::GetJavaEnv();
 252     initRefs(env);
 253 
 254     JLString urlJavaString(url.toJavaString(env));
 255     env-&gt;CallVoidMethod(m_webPage, setRequestURLMID, ptr_to_jlong(f), identifier, (jstring)urlJavaString);
 256     WTF::CheckAndClearException(env);
 257 }
 258 
 259 void FrameLoaderClientJava::removeRequestURL(Frame* f, int identifier)
 260 {
 261     using namespace FrameLoaderClientJavaInternal;
 262     JNIEnv* env = WTF::GetJavaEnv();
 263     initRefs(env);
 264 
 265     env-&gt;CallVoidMethod(m_webPage, removeRequestURLMID, ptr_to_jlong(f), identifier);
 266     WTF::CheckAndClearException(env);
 267 }
 268 
 269 void FrameLoaderClientJava::postLoadEvent(Frame* f, int state,
 270                                           String url, String contentType,
 271                                           double progress, int errorCode)
 272 {
 273     using namespace FrameLoaderClientJavaInternal;
 274     JNIEnv* env = WTF::GetJavaEnv();
 275     initRefs(env);
 276 
 277     JLString urlJavaString(url.toJavaString(env));
 278     JLString contentTypeJavaString(contentType.toJavaString(env));
 279 
 280     // First, notify SharedBufferManager, so users can get the full source
 281     // in CONTENT_RECEIVED handler
 282     if (state == com_sun_webkit_LoadListenerClient_PAGE_STARTED ||
 283         state == com_sun_webkit_LoadListenerClient_PROGRESS_CHANGED ||
 284         state == com_sun_webkit_LoadListenerClient_CONTENT_RECEIVED)
 285     {
 286         DocumentLoader* dl = f-&gt;loader().activeDocumentLoader();
 287         if (dl &amp;&amp; dl-&gt;mainResourceData()) {
 288             dl-&gt;mainResourceData()-&gt;size(); // TODO-java: recheck
 289         }
 290     }
 291 
 292     // Second, send a load event
 293     env-&gt;CallVoidMethod(m_webPage, fireLoadEventMID,
 294                         ptr_to_jlong(f), state, (jstring)urlJavaString,
 295                         (jstring)contentTypeJavaString, progress, errorCode);
 296     WTF::CheckAndClearException(env);
 297 }
 298 
 299 void FrameLoaderClientJava::postResourceLoadEvent(Frame* f, int state,
 300                                                   int id, String contentType,
 301                                                   double progress, int errorCode)
 302 {
 303     using namespace FrameLoaderClientJavaInternal;
 304     JNIEnv* env = WTF::GetJavaEnv();
 305     initRefs(env);
 306 
 307     JLString contentTypeJavaString(contentType.toJavaString(env));
 308     // notification for resource event listeners
 309     env-&gt;CallVoidMethod(m_webPage, fireResourceLoadEventMID,
 310                         ptr_to_jlong(f), state, id,
 311                         (jstring)contentTypeJavaString, progress, errorCode);
 312     WTF::CheckAndClearException(env);
 313 }
 314 
 315 String FrameLoaderClientJava::userAgent(const URL&amp;)
 316 {
 317     return page()-&gt;settings().userAgent();
 318 }
 319 
 320 void FrameLoaderClientJava::savePlatformDataToCachedFrame(CachedFrame*)
 321 {
 322     notImplemented();
 323 }
 324 
 325 void FrameLoaderClientJava::transitionToCommittedFromCachedFrame(CachedFrame*)
 326 {
 327     notImplemented();
 328 }
 329 
 330 void FrameLoaderClientJava::transitionToCommittedForNewPage()
 331 {
 332     FloatRect pageRect = frame()-&gt;page()-&gt;chrome().pageRect();
 333     Color bkColor(Color::white);
 334     Optional&lt;Color&gt; backgroundColor;
 335     FrameView* fv = frame()-&gt;view();
 336     if (fv) {
 337         backgroundColor = fv-&gt;baseBackgroundColor();
 338     }
 339     frame()-&gt;createView(IntRect(pageRect).size(), backgroundColor, /* fixedLayoutSize */ { }, /* fixedVisibleContentRect */ { });
 340 }
 341 
<a name="1" id="anc1"></a><span class="line-added"> 342 void FrameLoaderClientJava::didSaveToPageCache()</span>
<span class="line-added"> 343 {</span>
<span class="line-added"> 344     notImplemented();</span>
<span class="line-added"> 345 }</span>
<span class="line-added"> 346 </span>
<span class="line-added"> 347 void FrameLoaderClientJava::didRestoreFromPageCache()</span>
<span class="line-added"> 348 {</span>
<span class="line-added"> 349     notImplemented();</span>
<span class="line-added"> 350 }</span>
<span class="line-added"> 351 </span>
 352 WTF::Ref&lt;WebCore::DocumentLoader&gt; FrameLoaderClientJava::createDocumentLoader(const WebCore::ResourceRequest&amp; request, const SubstituteData&amp; substituteData)
 353 {
 354     return DocumentLoader::create(request, substituteData);
 355 }
 356 
 357 void FrameLoaderClientJava::dispatchWillSubmitForm(FormState&amp;, CompletionHandler&lt;void()&gt;&amp;&amp; function)
 358 {
 359     // FIXME: This is surely too simple
 360     if (!frame() || !function) {
 361         return;
 362     }
 363     function();
 364 }
 365 
 366 void FrameLoaderClientJava::committedLoad(DocumentLoader* loader, const char* data, int length)
 367 {
 368     //uta: for m_pluginWidget we need to do something different
 369     loader-&gt;commitData(data, length);
 370 }
 371 
<a name="2" id="anc2"></a><span class="line-modified"> 372 void FrameLoaderClientJava::dispatchDecidePolicyForResponse(const ResourceResponse&amp; response, const ResourceRequest&amp;, PolicyCheckIdentifier identifier, const String&amp;, FramePolicyFunction&amp;&amp; policyFunction)</span>
 373 {
 374     using namespace FrameLoaderClientJavaInternal;
 375     PolicyAction action;
 376 
 377     int statusCode = response.httpStatusCode();
 378     if (statusCode == 204 || statusCode == 205) {
 379         // The server does not want us to replace the page contents.
 380         action = PolicyAction::Ignore;
 381     } else if (contentDispositionType(response.httpHeaderField(HTTPHeaderName::ContentDisposition)) == ContentDispositionAttachment) {
 382         // The server wants us to download instead of replacing the page contents.
 383         // Downloading is handled by the embedder, but we still get the initial
 384         // response so that we can ignore it and clean up properly.
 385         action = PolicyAction::Ignore;
 386     } else if (!canShowMIMEType(response.mimeType())) {
 387         // Make sure that we can actually handle this type internally.
 388         action = PolicyAction::Ignore;
 389     } else {
 390         // OK, we will render this page.
 391         action = PolicyAction::Use;
 392     }
 393 
 394     // NOTE: PolicyChangeError will be generated when action is not PolicyUse.
 395     policyFunction(action, identifier);
 396 }
 397 
 398 void FrameLoaderClientJava::dispatchDidReceiveResponse(DocumentLoader*, unsigned long identifier, const ResourceResponse&amp; response)
 399 {
 400     m_response = response;
 401 
 402     if (identifier == m_mainResourceRequestID) {
 403         double progress = page()-&gt;progress().estimatedProgress();
 404         postLoadEvent(frame(),
 405                       com_sun_webkit_LoadListenerClient_CONTENTTYPE_RECEIVED,
 406                       response.url().string(),
 407                       response.mimeType(),
 408                       progress);
 409     }
 410 }
 411 
 412 void FrameLoaderClientJava::dispatchDecidePolicyForNewWindowAction(const NavigationAction&amp;,
 413                                                                    const ResourceRequest&amp; req,
 414                                                                    FormState*,
 415                                                                    const String&amp;,
 416                                                                    PolicyCheckIdentifier identifier,
 417                                                                    FramePolicyFunction&amp;&amp; policyFunction)
 418 {
 419     using namespace FrameLoaderClientJavaInternal;
 420     JNIEnv* env = WTF::GetJavaEnv();
 421     initRefs(env);
 422 
 423     ASSERT(frame() &amp;&amp; policyFunction);
 424     if (!frame() || !policyFunction) {
 425         return;
 426     }
 427 
 428     JLString urlString(req.url().string().toJavaString(env));
 429     bool permit = jbool_to_bool(env-&gt;CallBooleanMethod(m_webPage, permitNewWindowActionMID,
 430                                                        ptr_to_jlong(frame()), (jstring)urlString));
 431     WTF::CheckAndClearException(env);
 432 
 433     // FIXME: I think Qt version marshals this to another thread so when we
 434     // have multi-threaded download, we might need to do the same
 435     policyFunction(permit ? PolicyAction::Use : PolicyAction::Ignore, identifier);
 436 }
 437 
 438 void FrameLoaderClientJava::dispatchDecidePolicyForNavigationAction(const NavigationAction&amp; action,
 439                                                                     const ResourceRequest&amp; req,
 440                                                                     const ResourceResponse&amp; /*didReceiveRedirectResponse*/,
 441                                                                     FormState*,
 442                                                                     PolicyDecisionMode,
 443                                                                     PolicyCheckIdentifier identifier,
 444                                                                     FramePolicyFunction&amp;&amp; policyFunction)
 445 {
 446     using namespace FrameLoaderClientJavaInternal;
 447     JNIEnv* env = WTF::GetJavaEnv();
 448     initRefs(env);
 449 
 450     ASSERT(frame() &amp;&amp; policyFunction);
 451     if (!frame() || !policyFunction) {
 452         return;
 453     }
 454 
 455     bool permit = true;
 456 
 457     JLString urlJavaString(req.url().string().toJavaString(env));
 458 
 459     // 1. Submitting/resubmitting data.
 460     if (action.type() == NavigationType::FormSubmitted ||
 461         action.type() == NavigationType::FormResubmitted)
 462     {
 463         JLString httpMethodString(req.httpMethod().toJavaString(env));
 464         permit = env-&gt;CallBooleanMethod(m_webPage, permitSubmitDataActionMID,
 465                                         ptr_to_jlong(frame()), (jstring)urlJavaString,
 466                                         (jstring)httpMethodString,
 467                                         bool_to_jbool(action.type() == NavigationType::FormSubmitted));
 468         WTF::CheckAndClearException(env);
 469     // 2. Redirecting page.
 470     } else if (m_isPageRedirected) {
 471         permit = env-&gt;CallBooleanMethod(m_webPage, permitRedirectActionMID,
 472                                         ptr_to_jlong(frame()), (jstring)urlJavaString);
 473         WTF::CheckAndClearException(env);
 474         m_isPageRedirected = false;
 475     // 3. Loading document.
 476     } else {
 477         permit = env-&gt;CallBooleanMethod(m_webPage, permitNavigateActionMID,
 478                                         ptr_to_jlong(frame()), (jstring)urlJavaString);
 479         WTF::CheckAndClearException(env);
 480     }
 481 
 482     policyFunction(permit ? PolicyAction::Use : PolicyAction::Ignore, identifier);
 483 }
 484 
 485 RefPtr&lt;Widget&gt; FrameLoaderClientJava::createPlugin(const IntSize&amp; intSize, HTMLPlugInElement&amp; element, const URL&amp; url,
 486                                             const Vector&lt;String&gt;&amp; paramNames, const Vector&lt;String&gt;&amp; paramValues,
 487                                             const String&amp; mimeType, bool)
 488 {
 489     return adoptRef(new PluginWidgetJava(
 490         m_webPage,
 491         &amp;element,
 492         intSize,
 493         url.string(),
 494         mimeType,
 495         paramNames,
 496         paramValues));
 497 }
 498 
 499 RefPtr&lt;Frame&gt; FrameLoaderClientJava::createFrame(const URL&amp; url, const String&amp; name, HTMLFrameOwnerElement&amp; ownerElement,
 500                                         const String&amp; referrer)
 501 {
 502     using namespace FrameLoaderClientJavaInternal;
 503     JNIEnv* env = WTF::GetJavaEnv();
 504     initRefs(env);
 505 
 506     FrameLoaderClientJava* frameLoaderClient = new FrameLoaderClientJava(m_webPage);
 507     RefPtr&lt;Frame&gt; childFrame(Frame::create(page(), &amp;ownerElement, frameLoaderClient));
 508     frameLoaderClient-&gt;setFrame(childFrame.get());
 509 
 510     childFrame-&gt;tree().setName(name);
 511     m_frame-&gt;tree().appendChild(*childFrame);
 512 
 513     childFrame-&gt;init();
 514 
 515     // gtk: The creation of the frame may have run arbitrary JS that removed it from the page already.
 516     if (!childFrame-&gt;page()) {
 517         return 0;
 518     }
 519 
 520     m_frame-&gt;loader().loadURLIntoChildFrame(url, referrer, childFrame.get());
 521 
 522     // gtk: The frame&#39;s onload handler may have removed it from the document.
 523     if (!childFrame-&gt;tree().parent()) {
 524         return 0;
 525     }
 526 
 527     env-&gt;CallVoidMethod(m_webPage, frameCreatedMID, ptr_to_jlong(childFrame.get()));
 528     WTF::CheckAndClearException(env);
 529 
 530     return childFrame;
 531 }
 532 
 533 void FrameLoaderClientJava::redirectDataToPlugin(Widget&amp;)
 534 {
 535     /*
 536     ASSERT(!m_pluginWidget);
 537     m_pluginWidget = static_cast&lt;PluginWidgetJava*&gt;(pluginWidget);
 538     */
 539     notImplemented();
 540 }
 541 
 542 RefPtr&lt;Widget&gt; FrameLoaderClientJava::createJavaAppletWidget(const IntSize&amp;, HTMLAppletElement&amp;, const URL&amp;,
 543                                                       const Vector&lt;String&gt;&amp;, const Vector&lt;String&gt;&amp;)
 544 {
 545     notImplemented();
 546     return nullptr;
 547 }
 548 
 549 ObjectContentType FrameLoaderClientJava::objectContentType(const URL&amp; url, const String&amp; mimeType)
 550 {
 551     //copied from FrameLoaderClientEfl.cpp
 552 
 553     // FIXME: once plugin support is enabled, this method needs to correctly handle the &#39;shouldPreferPlugInsForImages&#39; flag. See
 554     // WebCore::FrameLoader::defaultObjectContentType() for an example.
 555 
 556     if (url.isEmpty() &amp;&amp; mimeType.isEmpty())
 557         return ObjectContentType::None;
 558 
 559     // We don&#39;t use MIMETypeRegistry::getMIMETypeForPath() because it returns &quot;application/octet-stream&quot; upon failure
 560     String type = mimeType;
 561     if (type.isEmpty())
 562         type = MIMETypeRegistry::getMIMETypeForExtension(url.path().substring(url.path().reverseFind(&#39;.&#39;) + 1));
 563 
 564     if (type.isEmpty())
 565         return ObjectContentType::Frame;
 566 
 567     if (MIMETypeRegistry::isSupportedImageMIMEType(type))
 568         return ObjectContentType::Image;
 569 
 570 #if 0 // PluginDatabase is disabled until we have Plugin system done.
 571     if (PluginDatabase::installedPlugins()-&gt;isMIMETypeRegistered(mimeType))
 572         return ObjectContentNetscapePlugin;
 573 #endif
 574 
 575     if (MIMETypeRegistry::isSupportedNonImageMIMEType(type))
 576         return ObjectContentType::Frame;
 577 
 578     if (url.protocol() == &quot;about&quot;)
 579         return ObjectContentType::Frame;
 580 
 581     return ObjectContentType::None;
 582 }
 583 
 584 String FrameLoaderClientJava::overrideMediaType() const
 585 {
 586     notImplemented();
 587     return String();
 588 }
 589 
 590 void FrameLoaderClientJava::setMainFrameDocumentReady(bool)
 591 {
 592     // this is only interesting once we provide an external API for the DOM
 593 }
 594 
 595 bool FrameLoaderClientJava::hasWebView() const
 596 {
 597     notImplemented();
 598     return true;
 599 }
 600 
 601 void FrameLoaderClientJava::assignIdentifierToInitialRequest(unsigned long, DocumentLoader*, const ResourceRequest&amp;)
 602 {
 603     notImplemented();
 604 }
 605 
 606 void FrameLoaderClientJava::willReplaceMultipartContent()
 607 {
 608     notImplemented(); // TODO-java: recheck
 609 }
 610 
 611 void FrameLoaderClientJava::didReplaceMultipartContent()
 612 {
 613     notImplemented(); // TODO-java: recheck
 614 }
 615 
 616 void FrameLoaderClientJava::updateCachedDocumentLoader(DocumentLoader&amp;)
 617 {
 618     notImplemented(); // TODO-java: recheck
 619 }
 620 
 621 void FrameLoaderClientJava::dispatchDidStartProvisionalLoad()
 622 {
 623     m_mainResourceRequestID = 0;
 624 }
 625 
 626 void FrameLoaderClientJava::dispatchWillSendRequest(DocumentLoader* l, unsigned long identifier, ResourceRequest&amp; req, const ResourceResponse&amp; res)
 627 {
 628     using namespace FrameLoaderClientJavaInternal;
 629     JNIEnv* env = WTF::GetJavaEnv();
 630     initRefs(env);
 631 
 632     Frame* f = l-&gt;frame();
 633     if (!f) {
 634         f = frame();
 635     }
 636 
 637     double progress = 0.0;
 638     progress = page()-&gt;progress().estimatedProgress();
 639 
 640     if (m_mainResourceRequestID == 0) {
 641         m_mainResourceRequestID = identifier;
 642         postLoadEvent(f,
 643                       com_sun_webkit_LoadListenerClient_PAGE_STARTED,
 644                       req.url().string(),
 645                       res.mimeType(),
 646                       progress);
 647     } else if (m_mainResourceRequestID == identifier) { // serever-side redirection
 648         m_isPageRedirected = true;
 649         postLoadEvent(f,
 650                       com_sun_webkit_LoadListenerClient_PAGE_REDIRECTED,
 651                       req.url().string(),
 652                       res.mimeType(),
 653                       progress);
 654     } else {
 655         // Check resource policy.
 656         JLString urlJavaString(req.url().string().toJavaString(env));
 657         bool permit = jbool_to_bool(env-&gt;CallBooleanMethod(m_webPage, permitAcceptResourceActionMID,
 658                                                            ptr_to_jlong(f), (jstring)urlJavaString));
 659         WTF::CheckAndClearException(env);
 660         if (!permit) {
 661 /*
 662             req.setURL(NULL); // will cancel loading
 663 */
 664             req.setURL(URL());
 665         } else {
 666             setRequestURL(f, identifier, req.url().string());
 667             postResourceLoadEvent(f,
 668                                   com_sun_webkit_LoadListenerClient_RESOURCE_STARTED,
 669                                   identifier,
 670                                   res.mimeType(),
 671                                   0.0 /* progress */);
 672         }
 673     }
 674 }
 675 
 676 void FrameLoaderClientJava::dispatchDidFailLoading(DocumentLoader* dl, unsigned long identifier, const ResourceError&amp; error)
 677 {
 678     Frame* f = dl-&gt;frame();
 679     if (!f) {
 680         f = frame();
 681     }
 682     postResourceLoadEvent(f,
 683                           com_sun_webkit_LoadListenerClient_RESOURCE_FAILED,
 684                           identifier,
 685                           dl-&gt;responseMIMEType(),
 686                           0.0 /* progress */,
 687                           error.errorCode());
 688     removeRequestURL(f, identifier);
 689 }
 690 
<a name="3" id="anc3"></a><span class="line-modified"> 691 void FrameLoaderClientJava::dispatchDidFailProvisionalLoad(const ResourceError&amp; error, WillContinueLoading)</span>
 692 {
 693     ASSERT(frame());
 694     if (!frame()) {
 695         return;
 696     }
 697     DocumentLoader* dl = frame()-&gt;loader().activeDocumentLoader();
 698     if (!dl) {
 699         return;
 700     }
 701 
 702     double progress = page()-&gt;progress().estimatedProgress();
 703     int state = error.isCancellation()
 704         ? com_sun_webkit_LoadListenerClient_LOAD_STOPPED
 705         : com_sun_webkit_LoadListenerClient_LOAD_FAILED;
 706     postLoadEvent(frame(), state,
 707                   dl-&gt;url().string(),
 708                   dl-&gt;responseMIMEType(),
 709                   progress,
 710                   error.errorCode());
 711 }
 712 
 713 void FrameLoaderClientJava::dispatchDidFailLoad(const ResourceError&amp; error)
 714 {
<a name="4" id="anc4"></a><span class="line-modified"> 715     dispatchDidFailProvisionalLoad(error, WillContinueLoading::No);</span>
 716 }
 717 
 718 // client-side redirection
 719 void FrameLoaderClientJava::dispatchWillPerformClientRedirect(const URL&amp;, double, WallTime, LockBackForwardList)
 720 {
 721 }
 722 
 723 void FrameLoaderClientJava::dispatchDidReceiveTitle(const StringWithDirection&amp;)
 724 {
 725     double progress = page()-&gt;progress().estimatedProgress();
 726     postLoadEvent(frame(),
 727                   com_sun_webkit_LoadListenerClient_TITLE_RECEIVED,
 728                   frame()-&gt;document()-&gt;url(),
 729                   frame()-&gt;loader().documentLoader()-&gt;responseMIMEType(),
 730                   progress);
 731 }
 732 
 733 void FrameLoaderClientJava::dispatchDidReceiveIcon()
 734 {
 735     // not called without IconDatabase support, so sending the notification
 736     // from dispatchDidLoadMainResource()
 737     /*
 738     Frame* f = page()-&gt;mainFrame();
 739     if (!f-&gt;loader() || !f-&gt;document()) {
 740         return;
 741     }
 742 
 743     double progress = page()-&gt;progress()-&gt;estimatedProgress();
 744     postLoadEvent(com_sun_webkit_LoadListenerClient_ICON_RECEIVED,
 745                   0, // request id
 746                   f-&gt;document()-&gt;url(),
 747                   f-&gt;loader()-&gt;documentLoader()-&gt;responseMIMEType(),
 748                   progress);
 749     */
 750 }
 751 
 752 void FrameLoaderClientJava::dispatchDidReceiveContentLength(DocumentLoader*, unsigned long, int)
 753 {
 754     notImplemented();
 755 }
 756 
 757 void FrameLoaderClientJava::dispatchDidFinishDocumentLoad()
 758 {
 759     if (!frame()-&gt;isMainFrame()) {
 760         // send the notification for the main frame only
 761         return;
 762     }
 763 
 764     double progress = page()-&gt;progress().estimatedProgress();
 765     postLoadEvent(frame(),
 766                   com_sun_webkit_LoadListenerClient_DOCUMENT_AVAILABLE,
 767                   frame()-&gt;document()-&gt;url(),
 768                   frame()-&gt;loader().documentLoader()-&gt;responseMIMEType(),
 769                   progress);
 770 }
 771 
 772 void FrameLoaderClientJava::dispatchDidLoadMainResource(DocumentLoader* l)
 773 {
 774     double progress = page()-&gt;progress().estimatedProgress();
 775     // send ICON_RECEIVED here instead of dispatchDidReceiveIcon(),
 776     // see comments in the method for details
 777     postLoadEvent(frame(),
 778                   com_sun_webkit_LoadListenerClient_ICON_RECEIVED,
 779                   frame()-&gt;document()-&gt;url(),
 780                   l-&gt;responseMIMEType(),
 781                   progress);
 782     postLoadEvent(frame(),
 783                   com_sun_webkit_LoadListenerClient_CONTENT_RECEIVED,
 784                   l-&gt;responseURL().string(),
 785                   l-&gt;responseMIMEType(),
 786                   progress);
 787 }
 788 
 789 void FrameLoaderClientJava::dispatchDidFinishLoading(DocumentLoader* l, unsigned long identifier)
 790 {
 791     postResourceLoadEvent(frame(),
 792                           com_sun_webkit_LoadListenerClient_RESOURCE_FINISHED,
 793                           identifier,
 794                           l-&gt;responseMIMEType(),
 795                           1.0 /* progress */);
 796     removeRequestURL(frame(), identifier);
 797 }
 798 
 799 void FrameLoaderClientJava::dispatchDidFinishLoad()
 800 {
 801     double progress = page()-&gt;progress().estimatedProgress();
 802     postLoadEvent(frame(),
 803                   com_sun_webkit_LoadListenerClient_PAGE_FINISHED,
 804                   frame()-&gt;document()-&gt;url(),
 805                   frame()-&gt;loader().documentLoader()-&gt;responseMIMEType(),
 806                   progress);
 807 }
 808 
 809 void FrameLoaderClientJava::finishedLoading(DocumentLoader* dl)
 810 {
 811     // This is necessary to create an empty document. See bug 634004.
 812     // However, we only want to do this if makeRepresentation has been called, to
 813     // match the behavior on the Mac.
 814     if (m_hasRepresentation)
 815         dl-&gt;writer().setEncoding(&quot;&quot;, false);
 816 }
 817 
 818 void FrameLoaderClientJava::frameLoadCompleted()
 819 {
 820     notImplemented();
 821 }
 822 
 823 void FrameLoaderClientJava::saveViewStateToItem(HistoryItem&amp;)
 824 {
 825     notImplemented();
 826 }
 827 
 828 void FrameLoaderClientJava::restoreViewState()
 829 {
 830     notImplemented();
 831 }
 832 
 833 Frame* FrameLoaderClientJava::dispatchCreatePage(const NavigationAction&amp; action)
 834 {
 835     struct WindowFeatures features {};
 836     Page* newPage = frame()-&gt;page()-&gt;chrome().createWindow(
 837                         *frame(),
 838                         FrameLoadRequest(*frame()-&gt;document(),
 839                                             frame()-&gt;document()-&gt;securityOrigin(),
 840                                             action.resourceRequest(),
 841                                             {},
 842                                             LockHistory::No,
 843                                             LockBackForwardList::No,
 844                                             ShouldSendReferrer::MaybeSendReferrer,
 845                                             AllowNavigationToInvalidURL::Yes,
 846                                             NewFrameOpenerPolicy::Allow, // TODO-java: check params
 847                                             action.shouldOpenExternalURLsPolicy(),
 848                                             action.initiatedByMainFrame()),
 849                         features,
 850                         action);
 851 
 852     // createWindow can return null (e.g., popup blocker denies the window).
 853     if (!newPage)
 854         return 0;
 855 
 856     return &amp;newPage-&gt;mainFrame();
 857 }
 858 
 859 bool FrameLoaderClientJava::shouldGoToHistoryItem(HistoryItem&amp;) const
 860 {
 861     // FIXME: This is a very simple implementation. More sophisticated
 862     // implementation would delegate the decision to a PolicyDelegate.
 863     // See mac implementation for example.
 864     return true;
 865 }
 866 
 867 void FrameLoaderClientJava::didDisplayInsecureContent()
 868 {
 869     notImplemented();
 870 }
 871 
 872 void FrameLoaderClientJava::didRunInsecureContent(SecurityOrigin&amp;, const URL&amp;)
 873 {
 874     notImplemented();
 875 }
 876 
 877 void FrameLoaderClientJava::didDetectXSS(const URL&amp;, bool)
 878 {
 879     notImplemented();
 880 }
 881 
 882 void FrameLoaderClientJava::makeRepresentation(DocumentLoader*)
 883 {
 884     m_hasRepresentation = true;
 885 }
 886 
 887 void FrameLoaderClientJava::forceLayoutForNonHTML() { notImplemented(); }
 888 void FrameLoaderClientJava::setCopiesOnScroll() { notImplemented(); }
 889 void FrameLoaderClientJava::detachedFromParent2() { notImplemented(); }
 890 void FrameLoaderClientJava::detachedFromParent3() { notImplemented(); }
 891 
 892 void FrameLoaderClientJava::dispatchDidPushStateWithinPage()
 893 {
 894     dispatchDidNavigateWithinPage();
 895 }
 896 
 897 void FrameLoaderClientJava::dispatchDidReplaceStateWithinPage()
 898 {
 899     dispatchDidNavigateWithinPage();
 900 }
 901 
 902 void FrameLoaderClientJava::dispatchDidDispatchOnloadEvents() {notImplemented(); }
 903 void FrameLoaderClientJava::dispatchDidPopStateWithinPage() { notImplemented(); }
 904 void FrameLoaderClientJava::dispatchDidReceiveServerRedirectForProvisionalLoad() { notImplemented(); }
 905 void FrameLoaderClientJava::dispatchDidCancelClientRedirect() { notImplemented(); }
 906 void FrameLoaderClientJava::dispatchDidChangeLocationWithinPage() { notImplemented(); }
 907 void FrameLoaderClientJava::dispatchWillClose() { notImplemented(); }
 908 void FrameLoaderClientJava::dispatchDidCommitLoad(Optional&lt;HasInsecureContent&gt;)
 909 {
 910     // TODO: Look at GTK version
 911     notImplemented();
 912 }
 913 
 914 void FrameLoaderClientJava::dispatchShow() { notImplemented(); }
 915 void FrameLoaderClientJava::cancelPolicyCheck() { notImplemented(); }
 916 void FrameLoaderClientJava::revertToProvisionalState(DocumentLoader*) { notImplemented(); }
 917 void FrameLoaderClientJava::willChangeTitle(DocumentLoader*) { notImplemented(); }
 918 void FrameLoaderClientJava::didChangeTitle(DocumentLoader *l) { setTitle(l-&gt;title(), l-&gt;url()); }
 919 
 920 bool FrameLoaderClientJava::canHandleRequest(const ResourceRequest&amp; req) const
 921 {
 922     using namespace FrameLoaderClientJavaInternal;
 923     JNIEnv* env = WTF::GetJavaEnv();
 924     initRefs(env);
 925 
 926     JLString urlJavaString(req.url().string().toJavaString(env));
 927     jboolean ret = env-&gt;CallStaticBooleanMethod(networkContextClass, canHandleURLMID, (jstring)urlJavaString);
 928     WTF::CheckAndClearException(env);
 929 
 930     return jbool_to_bool(ret);
 931 }
 932 
 933 bool FrameLoaderClientJava::canShowMIMEType(const String&amp; mimeType) const
 934 {
 935     //copy from QT implementation
 936     String type = mimeType.convertToLowercaseWithoutLocale();
 937     if (MIMETypeRegistry::isSupportedImageMIMEType(type))
 938         return true;
 939 
 940     if (MIMETypeRegistry::isSupportedNonImageMIMEType(type))
 941         return true;
 942 
 943     if (MIMETypeRegistry::isSupportedMediaMIMEType(type))
 944         return true;
 945 
 946 #if 0 // PluginDatabase is disabled until we have Plugin system done.
 947     if (m_frame &amp;&amp; m_frame-&gt;settings().arePluginsEnabled()
 948         &amp;&amp; PluginDatabase::installedPlugins()-&gt;isMIMETypeRegistered(type))
 949         return true;
 950 #endif
 951 
 952     return false;
 953 }
 954 
 955 bool FrameLoaderClientJava::canShowMIMETypeAsHTML(const String&amp;) const
 956 {
 957     notImplemented();
 958     return false;
 959 }
 960 
 961 
 962 bool FrameLoaderClientJava::representationExistsForURLScheme(const String&amp;) const
 963 {
 964     notImplemented();
 965     return false;
 966 }
 967 
 968 String FrameLoaderClientJava::generatedMIMETypeForURLScheme(const String&amp;) const
 969 {
 970     notImplemented();
 971     return String();
 972 }
 973 
 974 void FrameLoaderClientJava::provisionalLoadStarted()
 975 {
 976     notImplemented();
 977 }
 978 
 979 void FrameLoaderClientJava::didFinishLoad()
 980 {
 981     notImplemented();
 982 }
 983 
 984 void FrameLoaderClientJava::prepareForDataSourceReplacement()
 985 {
 986     notImplemented();
 987 }
 988 
 989 void FrameLoaderClientJava::setTitle(const StringWithDirection&amp;, const URL&amp;)
 990 {
 991     notImplemented();
 992 }
 993 
 994 bool FrameLoaderClientJava::dispatchDidLoadResourceFromMemoryCache(
 995     DocumentLoader*,
 996     const ResourceRequest&amp;,
 997     const ResourceResponse&amp;,
 998     int)
 999 {
1000     notImplemented();
1001     return false;
1002 }
1003 
1004 ResourceError FrameLoaderClientJava::cancelledError(const ResourceRequest&amp; request)
1005 {
1006     return ResourceError(&quot;Error&quot;, -999, request.url(), &quot;Request cancelled&quot;);
1007 }
1008 
1009 ResourceError FrameLoaderClientJava::blockedError(const ResourceRequest&amp; request)
1010 {
1011     using namespace FrameLoaderClientJavaInternal;
1012     return ResourceError(&quot;Error&quot;, WebKitErrorCannotUseRestrictedPort, request.url(),
1013                          &quot;Request blocked&quot;);
1014 }
1015 
1016 ResourceError FrameLoaderClientJava::blockedByContentBlockerError(const ResourceRequest&amp; request)
1017 {
1018     using namespace FrameLoaderClientJavaInternal;
1019     RELEASE_ASSERT_NOT_REACHED(); // Content Blockers are not enabled for WK1.
1020     return ResourceError(&quot;Error&quot;, WebKitErrorCannotShowURL, request.url(),
1021                          &quot;Cannot show URL&quot;);
1022 }
1023 
1024 ResourceError FrameLoaderClientJava::cannotShowURLError(const ResourceRequest&amp; request)
1025 {
1026     using namespace FrameLoaderClientJavaInternal;
1027     return ResourceError(&quot;Error&quot;, WebKitErrorCannotShowURL, request.url(),
1028                          &quot;Cannot show URL&quot;);
1029 }
1030 
1031 ResourceError FrameLoaderClientJava::interruptedForPolicyChangeError(const ResourceRequest&amp; request)
1032 {
1033     using namespace FrameLoaderClientJavaInternal;
1034     return ResourceError(&quot;Error&quot;, WebKitErrorFrameLoadInterruptedByPolicyChange,
1035                          request.url(), &quot;Frame load interrupted by policy change&quot;);
1036 }
1037 
1038 ResourceError FrameLoaderClientJava::cannotShowMIMETypeError(const ResourceResponse&amp; response)
1039 {
1040     using namespace FrameLoaderClientJavaInternal;
1041     return ResourceError(&quot;Error&quot;, WebKitErrorCannotShowMIMEType, response.url(),
1042                          &quot;Cannot show mimetype&quot;);
1043 }
1044 
1045 ResourceError FrameLoaderClientJava::fileDoesNotExistError(const ResourceResponse&amp; response)
1046 {
1047     return ResourceError(&quot;Error&quot;, -998 /* ### */, response.url(),
1048                          &quot;File does not exist&quot;);
1049 }
1050 
1051 ResourceError FrameLoaderClientJava::pluginWillHandleLoadError(const ResourceResponse&amp; response)
1052 {
1053     using namespace FrameLoaderClientJavaInternal;
1054     return ResourceError(&quot;Error&quot;, WebKitErrorPluginWillHandleLoad, response.url(), &quot;Loading is handled by the media engine&quot;);
1055 }
1056 
1057 bool FrameLoaderClientJava::shouldFallBack(const ResourceError&amp; error)
1058 {
1059     using namespace FrameLoaderClientJavaInternal;
1060     //Font fallback supported by Java Fonts internaly
1061     return !(error.isCancellation() || (error.errorCode() == WebKitErrorFrameLoadInterruptedByPolicyChange));
1062 }
1063 
1064 bool FrameLoaderClientJava::canCachePage() const
1065 {
1066     return true;
1067 }
1068 
<a name="5" id="anc5"></a>







1069 void FrameLoaderClientJava::dispatchUnableToImplementPolicy(const ResourceError&amp;)
1070 {
1071     notImplemented();
1072 }
1073 
1074 void FrameLoaderClientJava::dispatchDidBecomeFrameset(bool)
1075 {
1076    notImplemented();
1077 }
1078 
1079 
1080 void FrameLoaderClientJava::setMainDocumentError(
1081     DocumentLoader*,
1082     const ResourceError&amp;)
1083 {
1084 //    if (m_pluginWidget) {
1085 //        m_pluginWidget = 0;
1086 //    }
1087     notImplemented();
1088 }
1089 
1090 void FrameLoaderClientJava::startDownload(const ResourceRequest&amp;, const String&amp;)
1091 {
1092     notImplemented();
1093 }
1094 
1095 void FrameLoaderClientJava::updateGlobalHistory()
1096 {
1097     notImplemented();
1098 }
1099 
1100 void FrameLoaderClientJava::updateGlobalHistoryRedirectLinks()
1101 {
1102     notImplemented();
1103 }
1104 
1105 void FrameLoaderClientJava::dispatchDidClearWindowObjectInWorld(
1106     DOMWrapperWorld&amp; world)
1107 {
1108     using namespace FrameLoaderClientJavaInternal;
1109     JNIEnv* env = WTF::GetJavaEnv();
1110     initRefs(env);
1111 
1112     if (&amp;world != &amp;mainThreadNormalWorld()) {
1113         return;
1114     }
1115 
1116     JSGlobalContextRef context = toGlobalRef(frame()-&gt;script().globalObject(
1117             mainThreadNormalWorld())-&gt;globalExec());
1118     JSObjectRef windowObject = JSContextGetGlobalObject(context);
1119 
1120     env-&gt;CallVoidMethod(m_webPage, didClearWindowObjectMID,
1121             ptr_to_jlong(context), ptr_to_jlong(windowObject));
1122     WTF::CheckAndClearException(env);
1123 }
1124 
1125 void FrameLoaderClientJava::registerForIconNotification()
1126 {
1127     //notImplemented();
1128 }
1129 
1130 void FrameLoaderClientJava::convertMainResourceLoadToDownload(DocumentLoader*, PAL::SessionID, const ResourceRequest&amp;, const ResourceResponse&amp;)
1131 {
1132     //notImplemented();
1133 }
1134 
1135 Ref&lt;FrameNetworkingContext&gt; FrameLoaderClientJava::createNetworkingContext()
1136 {
1137     return FrameNetworkingContextJava::create(frame());
1138 }
1139 
1140 
1141 bool FrameLoaderClientJava::shouldUseCredentialStorage(
1142     DocumentLoader*,
1143     unsigned long)
1144 {
1145     notImplemented();
1146     return false;
1147 }
1148 
1149 void FrameLoaderClientJava::dispatchDidReceiveAuthenticationChallenge(DocumentLoader*, unsigned long, const AuthenticationChallenge&amp; challenge)
1150 {
1151     notImplemented();
1152     // If the ResourceLoadDelegate doesn&#39;t exist or fails to handle the call, we tell the ResourceHandle
1153     // to continue without credential - this is the best approximation of Mac behavior
1154     challenge.authenticationClient()-&gt;receivedRequestToContinueWithoutCredential(challenge);
1155 }
1156 
1157 void FrameLoaderClientJava::prefetchDNS(const String&amp; hostname)
1158 {
1159     WebCore::prefetchDNS(hostname);
1160 }
1161 
<a name="6" id="anc6"></a><span class="line-modified">1162 Optional&lt;PageIdentifier&gt; FrameLoaderClientJava::pageID() const</span>
1163 {
1164     return WTF::nullopt;
1165 }
1166 
<a name="7" id="anc7"></a><span class="line-modified">1167 Optional&lt;FrameIdentifier&gt; FrameLoaderClientJava::frameID() const</span>
1168 {
1169     return WTF::nullopt;
1170 }
1171 
1172 PAL::SessionID FrameLoaderClientJava::sessionID() const
1173 {
<a name="8" id="anc8"></a><span class="line-modified">1174     return m_frame &amp;&amp; m_frame-&gt;page() ? m_frame-&gt;page()-&gt;sessionID() : PAL::SessionID::defaultSessionID();</span>

1175 }
1176 
<a name="9" id="anc9"></a>
1177 }
<a name="10" id="anc10"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="10" type="hidden" />
</body>
</html>