<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames modules/javafx.web/src/main/native/Tools/DumpRenderTree/TestRunner.cpp</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>   1 /*
   2  * Copyright (C) 2007-2016 Apple Inc. All rights reserved.
   3  * Copyright (C) 2010 Joone Hur &lt;joone@kldp.org&gt;
   4  *
   5  * Redistribution and use in source and binary forms, with or without
   6  * modification, are permitted provided that the following conditions
   7  * are met:
   8  *
   9  * 1.  Redistributions of source code must retain the above copyright
  10  *     notice, this list of conditions and the following disclaimer.
  11  * 2.  Redistributions in binary form must reproduce the above copyright
  12  *     notice, this list of conditions and the following disclaimer in the
  13  *     documentation and/or other materials provided with the distribution.
  14  * 3.  Neither the name of Apple Inc. (&quot;Apple&quot;) nor the names of
  15  *     its contributors may be used to endorse or promote products derived
  16  *     from this software without specific prior written permission.
  17  *
  18  * THIS SOFTWARE IS PROVIDED BY APPLE AND ITS CONTRIBUTORS &quot;AS IS&quot; AND ANY
  19  * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
  20  * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
  21  * DISCLAIMED. IN NO EVENT SHALL APPLE OR ITS CONTRIBUTORS BE LIABLE FOR ANY
  22  * DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
  23  * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
  24  * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
  25  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
  26  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF
  27  * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
  28  */
  29 
  30 #include &quot;config.h&quot;
  31 #include &quot;TestRunner.h&quot;
  32 
  33 #include &quot;WebCoreTestSupport.h&quot;
  34 #include &quot;WorkQueue.h&quot;
  35 #include &quot;WorkQueueItem.h&quot;
  36 #include &lt;JavaScriptCore/APICast.h&gt;
  37 #include &lt;JavaScriptCore/ArrayBufferView.h&gt;
  38 #include &lt;JavaScriptCore/HeapInlines.h&gt;
  39 #include &lt;JavaScriptCore/JSArrayBufferView.h&gt;
  40 #include &lt;JavaScriptCore/JSCTestRunnerUtils.h&gt;
  41 #include &lt;JavaScriptCore/JSContextRef.h&gt;
  42 #include &lt;JavaScriptCore/JSObjectRef.h&gt;
  43 #include &lt;JavaScriptCore/JSRetainPtr.h&gt;
  44 #include &lt;JavaScriptCore/TypedArrayInlines.h&gt;
  45 #include &lt;JavaScriptCore/VMInlines.h&gt;
  46 #include &lt;WebCore/LogInitialization.h&gt;
  47 #include &lt;cstring&gt;
  48 #include &lt;locale.h&gt;
  49 #include &lt;stdio.h&gt;
  50 #include &lt;wtf/Assertions.h&gt;
  51 #include &lt;wtf/LoggingAccumulator.h&gt;
  52 #include &lt;wtf/MathExtras.h&gt;
  53 #include &lt;wtf/RefPtr.h&gt;
  54 #include &lt;wtf/RunLoop.h&gt;
  55 #include &lt;wtf/StdLibExtras.h&gt;
<a name="1" id="anc1"></a>
  56 #include &lt;wtf/WallTime.h&gt;
  57 #include &lt;wtf/text/WTFString.h&gt;
  58 
  59 #if PLATFORM(IOS_FAMILY)
  60 #include &lt;WebCore/WebCoreThreadRun.h&gt;
  61 #include &lt;wtf/BlockPtr.h&gt;
  62 #endif
  63 
  64 #if PLATFORM(MAC) &amp;&amp; !PLATFORM(IOS_FAMILY)
  65 #include &lt;Carbon/Carbon.h&gt;
  66 #endif
  67 
  68 FILE* testResult = stdout;
  69 
  70 const unsigned TestRunner::viewWidth = 800;
  71 const unsigned TestRunner::viewHeight = 600;
  72 
  73 const unsigned TestRunner::w3cSVGViewWidth = 480;
  74 const unsigned TestRunner::w3cSVGViewHeight = 360;
  75 
  76 TestRunner::TestRunner(const std::string&amp; testURL, const std::string&amp; expectedPixelHash)
<a name="2" id="anc2"></a><span class="line-modified">  77     : m_disallowIncreaseForApplicationCacheQuota(false)</span>
<span class="line-removed">  78     , m_dumpApplicationCacheDelegateCallbacks(false)</span>
<span class="line-removed">  79     , m_dumpAsAudio(false)</span>
<span class="line-removed">  80     , m_dumpAsPDF(false)</span>
<span class="line-removed">  81     , m_dumpAsText(false)</span>
<span class="line-removed">  82     , m_dumpBackForwardList(false)</span>
<span class="line-removed">  83     , m_dumpChildFrameScrollPositions(false)</span>
<span class="line-removed">  84     , m_dumpChildFramesAsText(false)</span>
<span class="line-removed">  85     , m_dumpDOMAsWebArchive(false)</span>
<span class="line-removed">  86     , m_dumpDatabaseCallbacks(false)</span>
<span class="line-removed">  87     , m_dumpEditingCallbacks(false)</span>
<span class="line-removed">  88     , m_dumpFrameLoadCallbacks(false)</span>
<span class="line-removed">  89     , m_dumpProgressFinishedCallback(false)</span>
<span class="line-removed">  90     , m_dumpUserGestureInFrameLoadCallbacks(false)</span>
<span class="line-removed">  91     , m_dumpHistoryDelegateCallbacks(false)</span>
<span class="line-removed">  92     , m_dumpResourceLoadCallbacks(false)</span>
<span class="line-removed">  93     , m_dumpResourceResponseMIMETypes(false)</span>
<span class="line-removed">  94     , m_dumpSelectionRect(false)</span>
<span class="line-removed">  95     , m_dumpSourceAsWebArchive(false)</span>
<span class="line-removed">  96     , m_dumpStatusCallbacks(false)</span>
<span class="line-removed">  97     , m_dumpTitleChanges(false)</span>
<span class="line-removed">  98     , m_dumpVisitedLinksCallback(false)</span>
<span class="line-removed">  99     , m_dumpWillCacheResponse(false)</span>
<span class="line-removed"> 100     , m_generatePixelResults(true)</span>
<span class="line-removed"> 101     , m_callCloseOnWebViews(true)</span>
<span class="line-removed"> 102     , m_canOpenWindows(false)</span>
<span class="line-removed"> 103     , m_closeRemainingWindowsWhenComplete(true)</span>
<span class="line-removed"> 104     , m_newWindowsCopyBackForwardList(false)</span>
<span class="line-removed"> 105     , m_stopProvisionalFrameLoads(false)</span>
<span class="line-removed"> 106     , m_testOnscreen(false)</span>
<span class="line-removed"> 107     , m_testRepaint(false)</span>
<span class="line-removed"> 108     , m_testRepaintSweepHorizontally(false)</span>
<span class="line-removed"> 109     , m_waitToDump(false)</span>
<span class="line-removed"> 110     , m_willSendRequestReturnsNull(false)</span>
<span class="line-removed"> 111     , m_willSendRequestReturnsNullOnRedirect(false)</span>
<span class="line-removed"> 112     , m_windowIsKey(true)</span>
<span class="line-removed"> 113     , m_alwaysAcceptCookies(false)</span>
<span class="line-removed"> 114     , m_globalFlag(false)</span>
<span class="line-removed"> 115     , m_isGeolocationPermissionSet(false)</span>
<span class="line-removed"> 116     , m_geolocationPermission(false)</span>
<span class="line-removed"> 117     , m_rejectsProtectionSpaceAndContinueForAuthenticationChallenges(false)</span>
<span class="line-removed"> 118     , m_handlesAuthenticationChallenges(false)</span>
<span class="line-removed"> 119     , m_isPrinting(false)</span>
<span class="line-removed"> 120     , m_useDeferredFrameLoading(false)</span>
<span class="line-removed"> 121     , m_shouldPaintBrokenImage(true)</span>
<span class="line-removed"> 122     , m_shouldStayOnPageAfterHandlingBeforeUnload(false)</span>
<span class="line-removed"> 123     , m_areLegacyWebNotificationPermissionRequestsIgnored(false)</span>
<span class="line-removed"> 124     , m_customFullScreenBehavior(false)</span>
<span class="line-removed"> 125     , m_hasPendingWebNotificationClick(false)</span>
<span class="line-removed"> 126     , m_databaseDefaultQuota(-1)</span>
<span class="line-removed"> 127     , m_databaseMaxQuota(-1)</span>
<span class="line-removed"> 128     , m_testURL(testURL)</span>
 129     , m_expectedPixelHash(expectedPixelHash)
 130     , m_titleTextDirection(&quot;ltr&quot;)
<a name="3" id="anc3"></a><span class="line-removed"> 131     , m_timeout(0)</span>
 132 {
 133 }
 134 
 135 Ref&lt;TestRunner&gt; TestRunner::create(const std::string&amp; testURL, const std::string&amp; expectedPixelHash)
 136 {
 137     return adoptRef(*new TestRunner(testURL, expectedPixelHash));
 138 }
 139 
 140 // Static Functions
 141 
 142 static JSValueRef disallowIncreaseForApplicationCacheQuotaCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 143 {
 144     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 145     controller-&gt;setDisallowIncreaseForApplicationCacheQuota(true);
 146     return JSValueMakeUndefined(context);
 147 }
 148 
 149 static JSValueRef dumpApplicationCacheDelegateCallbacksCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 150 {
 151     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 152     controller-&gt;setDumpApplicationCacheDelegateCallbacks(true);
 153     return JSValueMakeUndefined(context);
 154 }
 155 
 156 static JSValueRef dumpAsPDFCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 157 {
 158     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 159     controller-&gt;setDumpAsPDF(true);
 160     return JSValueMakeUndefined(context);
 161 }
 162 
<a name="4" id="anc4"></a>










 163 static JSValueRef dumpAsTextCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 164 {
 165     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 166     controller-&gt;setDumpAsText(true);
 167 
 168     // Optional paramater, describing whether it&#39;s allowed to dump pixel results in dumpAsText mode.
 169     controller-&gt;setGeneratePixelResults(argumentCount &gt; 0 ? JSValueToBoolean(context, arguments[0]) : false);
 170 
 171     return JSValueMakeUndefined(context);
 172 }
 173 
 174 static JSValueRef dumpBackForwardListCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 175 {
 176     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 177     controller-&gt;setDumpBackForwardList(true);
 178     return JSValueMakeUndefined(context);
 179 }
 180 
 181 static JSValueRef dumpChildFramesAsTextCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 182 {
 183     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 184     controller-&gt;setDumpChildFramesAsText(true);
 185     return JSValueMakeUndefined(context);
 186 }
 187 
 188 static JSValueRef dumpChildFrameScrollPositionsCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 189 {
 190     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 191     controller-&gt;setDumpChildFrameScrollPositions(true);
 192     return JSValueMakeUndefined(context);
 193 }
 194 
 195 static JSValueRef dumpDatabaseCallbacksCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 196 {
 197     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 198     controller-&gt;setDumpDatabaseCallbacks(true);
 199     return JSValueMakeUndefined(context);
 200 }
 201 
 202 static JSValueRef dumpDOMAsWebArchiveCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 203 {
 204     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 205     controller-&gt;setDumpDOMAsWebArchive(true);
 206     return JSValueMakeUndefined(context);
 207 }
 208 
 209 static JSValueRef dumpEditingCallbacksCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 210 {
 211     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 212     controller-&gt;setDumpEditingCallbacks(true);
 213     return JSValueMakeUndefined(context);
 214 }
 215 
 216 static JSValueRef dumpFrameLoadCallbacksCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 217 {
 218     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 219     controller-&gt;setDumpFrameLoadCallbacks(true);
 220     return JSValueMakeUndefined(context);
 221 }
 222 
 223 static JSValueRef dumpProgressFinishedCallbackCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 224 {
 225     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 226     controller-&gt;setDumpProgressFinishedCallback(true);
 227     return JSValueMakeUndefined(context);
 228 }
 229 
 230 static JSValueRef dumpUserGestureInFrameLoadCallbacksCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 231 {
 232     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 233     controller-&gt;setDumpUserGestureInFrameLoadCallbacks(true);
 234     return JSValueMakeUndefined(context);
 235 }
 236 
 237 static JSValueRef dumpResourceLoadCallbacksCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 238 {
 239     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 240     controller-&gt;setDumpResourceLoadCallbacks(true);
 241     return JSValueMakeUndefined(context);
 242 }
 243 
 244 static JSValueRef dumpResourceResponseMIMETypesCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 245 {
 246     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 247     controller-&gt;setDumpResourceResponseMIMETypes(true);
 248     return JSValueMakeUndefined(context);
 249 }
 250 
 251 static JSValueRef dumpSelectionRectCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 252 {
 253     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 254     controller-&gt;setDumpSelectionRect(true);
 255     return JSValueMakeUndefined(context);
 256 }
 257 
 258 static JSValueRef dumpSourceAsWebArchiveCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 259 {
 260     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 261     controller-&gt;setDumpSourceAsWebArchive(true);
 262     return JSValueMakeUndefined(context);
 263 }
 264 
 265 static JSValueRef dumpStatusCallbacksCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 266 {
 267     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 268     controller-&gt;setDumpStatusCallbacks(true);
 269     return JSValueMakeUndefined(context);
 270 }
 271 
 272 static JSValueRef dumpTitleChangesCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 273 {
 274     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 275     controller-&gt;setDumpTitleChanges(true);
 276     return JSValueMakeUndefined(context);
 277 }
 278 
 279 static JSValueRef dumpWillCacheResponseCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 280 {
 281     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 282     controller-&gt;setDumpWillCacheResponse(true);
 283     return JSValueMakeUndefined(context);
 284 }
 285 
 286 static JSValueRef pathToLocalResourceCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 287 {
 288     if (argumentCount &lt; 1)
 289         return JSValueMakeUndefined(context);
 290 
 291     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 292     auto localPath = adopt(JSValueToStringCopy(context, arguments[0], exception));
 293     ASSERT(!*exception);
 294 
 295     auto convertedPath = controller-&gt;pathToLocalResource(context, localPath.get());
 296     if (!convertedPath)
 297         return JSValueMakeUndefined(context);
 298 
 299     return JSValueMakeString(context, convertedPath.get());
 300 }
 301 
 302 static JSValueRef removeAllVisitedLinksCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 303 {
 304     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 305     controller-&gt;setDumpVisitedLinksCallback(true);
 306     controller-&gt;removeAllVisitedLinks();
 307     return JSValueMakeUndefined(context);
 308 }
 309 
 310 static JSValueRef repaintSweepHorizontallyCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 311 {
 312     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 313     controller-&gt;setTestRepaintSweepHorizontally(true);
 314     return JSValueMakeUndefined(context);
 315 }
 316 
 317 static JSValueRef setCallCloseOnWebViewsCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 318 {
 319     if (argumentCount &lt; 1)
 320         return JSValueMakeUndefined(context);
 321 
 322     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 323     controller-&gt;setCallCloseOnWebViews(JSValueToBoolean(context, arguments[0]));
 324     return JSValueMakeUndefined(context);
 325 }
 326 
 327 static JSValueRef setCanOpenWindowsCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 328 {
 329     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 330     controller-&gt;setCanOpenWindows(true);
 331     return JSValueMakeUndefined(context);
 332 }
 333 
 334 static JSValueRef setCloseRemainingWindowsWhenCompleteCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 335 {
 336     if (argumentCount &lt; 1)
 337         return JSValueMakeUndefined(context);
 338 
 339     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 340     controller-&gt;setCloseRemainingWindowsWhenComplete(JSValueToBoolean(context, arguments[0]));
 341     return JSValueMakeUndefined(context);
 342 }
 343 
 344 static JSValueRef setAudioResultCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 345 {
 346     if (argumentCount &lt; 1)
 347         return JSValueMakeUndefined(context);
 348 
 349 #if !PLATFORM(JAVA)
 350     // FIXME (123058): Use a JSC API to get buffer contents once such is exposed.
 351     JSC::VM&amp; vm = toJS(context)-&gt;vm();
 352     JSC::JSLockHolder lock(vm);
 353 
 354     JSC::JSArrayBufferView* jsBufferView = JSC::jsDynamicCast&lt;JSC::JSArrayBufferView*&gt;(vm, toJS(toJS(context), arguments[0]));
 355     ASSERT(jsBufferView);
 356     RefPtr&lt;JSC::ArrayBufferView&gt; bufferView = jsBufferView-&gt;unsharedImpl();
 357     const char* buffer = static_cast&lt;const char*&gt;(bufferView-&gt;baseAddress());
 358     std::vector&lt;char&gt; audioData(buffer, buffer + bufferView-&gt;byteLength());
 359 
 360     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 361     controller-&gt;setAudioResult(audioData);
 362     controller-&gt;setDumpAsAudio(true);
 363 #endif
 364 
 365     return JSValueMakeUndefined(context);
 366 }
 367 
 368 static JSValueRef testOnscreenCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 369 {
 370     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 371     controller-&gt;setTestOnscreen(true);
 372     return JSValueMakeUndefined(context);
 373 }
 374 
 375 static JSValueRef testRepaintCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 376 {
 377     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 378     controller-&gt;setTestRepaint(true);
 379     return JSValueMakeUndefined(context);
 380 }
 381 
 382 static JSValueRef addDisallowedURLCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 383 {
 384     // Has mac implementation
 385     if (argumentCount &lt; 1)
 386         return JSValueMakeUndefined(context);
 387 
 388     auto url = adopt(JSValueToStringCopy(context, arguments[0], exception));
 389     ASSERT(!*exception);
 390 
 391     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 392     controller-&gt;addDisallowedURL(url.get());
 393 
 394     return JSValueMakeUndefined(context);
 395 }
 396 
 397 static JSValueRef addURLToRedirectCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 398 {
 399     if (argumentCount &lt; 2)
 400         return JSValueMakeUndefined(context);
 401 
 402     auto origin = adopt(JSValueToStringCopy(context, arguments[0], exception));
 403     ASSERT(!*exception);
 404 
 405     auto destination = adopt(JSValueToStringCopy(context, arguments[1], exception));
 406     ASSERT(!*exception);
 407 
 408     size_t maxLength = JSStringGetMaximumUTF8CStringSize(origin.get());
<a name="5" id="anc5"></a><span class="line-modified"> 409     auto originBuffer = std::make_unique&lt;char[]&gt;(maxLength + 1);</span>
 410     JSStringGetUTF8CString(origin.get(), originBuffer.get(), maxLength + 1);
 411 
 412     maxLength = JSStringGetMaximumUTF8CStringSize(destination.get());
<a name="6" id="anc6"></a><span class="line-modified"> 413     auto destinationBuffer = std::make_unique&lt;char[]&gt;(maxLength + 1);</span>
 414     JSStringGetUTF8CString(destination.get(), destinationBuffer.get(), maxLength + 1);
 415 
 416     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 417     controller-&gt;addURLToRedirect(originBuffer.get(), destinationBuffer.get());
 418 
 419     return JSValueMakeUndefined(context);
 420 }
 421 
 422 static JSValueRef callShouldCloseOnWebViewCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 423 {
 424     // Has mac &amp; windows implementation
 425     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 426 
 427     return JSValueMakeBoolean(context, controller-&gt;callShouldCloseOnWebView());
 428 }
 429 
 430 static JSValueRef clearAllApplicationCachesCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 431 {
 432     // Has mac implementation
 433     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 434     controller-&gt;clearAllApplicationCaches();
 435 
 436     return JSValueMakeUndefined(context);
 437 }
 438 
 439 static JSValueRef clearApplicationCacheForOriginCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 440 {
 441     if (argumentCount &lt; 1)
 442         return JSValueMakeUndefined(context);
 443 
 444     auto originURL = adopt(JSValueToStringCopy(context, arguments[0], exception));
 445     ASSERT(!*exception);
 446 
 447     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 448     controller-&gt;clearApplicationCacheForOrigin(originURL.get());
 449 
 450     return JSValueMakeUndefined(context);
 451 }
 452 
 453 static JSValueRef applicationCacheDiskUsageForOriginCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 454 {
 455     if (argumentCount &lt; 1)
 456         return JSValueMakeUndefined(context);
 457 
 458     auto originURL = adopt(JSValueToStringCopy(context, arguments[0], exception));
 459     ASSERT(!*exception);
 460 
 461     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 462 
 463     return JSValueMakeNumber(context, controller-&gt;applicationCacheDiskUsageForOrigin(originURL.get()));
 464 }
 465 
 466 static JSValueRef originsWithApplicationCacheCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 467 {
 468     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 469     return controller-&gt;originsWithApplicationCache(context);
 470 }
 471 
 472 static JSValueRef clearAllDatabasesCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 473 {
 474     // Has mac &amp; windows implementation
 475     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 476     controller-&gt;clearAllDatabases();
 477 
 478     return JSValueMakeUndefined(context);
 479 }
 480 
 481 static JSValueRef clearBackForwardListCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 482 {
 483     // Has mac &amp; windows implementation
 484     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 485     controller-&gt;clearBackForwardList();
 486 
 487     return JSValueMakeUndefined(context);
 488 }
 489 
 490 static JSValueRef clearPersistentUserStyleSheetCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 491 {
 492     // Has mac &amp; windows implementation
 493     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 494     controller-&gt;clearPersistentUserStyleSheet();
 495 
 496     return JSValueMakeUndefined(context);
 497 }
 498 
 499 static JSValueRef decodeHostNameCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 500 {
 501     // Has mac implementation
 502     if (argumentCount &lt; 1)
 503         return JSValueMakeUndefined(context);
 504 
 505     auto name = adopt(JSValueToStringCopy(context, arguments[0], exception));
 506     ASSERT(!*exception);
 507 
 508     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 509     auto decodedHostName = controller-&gt;copyDecodedHostName(name.get());
 510     return JSValueMakeString(context, decodedHostName.get());
 511 }
 512 
 513 static JSValueRef dispatchPendingLoadRequestsCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 514 {
 515     // Has mac implementation, needs windows implementation
 516     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 517     controller-&gt;dispatchPendingLoadRequests();
 518 
 519     return JSValueMakeUndefined(context);
 520 }
 521 
 522 static JSValueRef displayCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 523 {
 524     // Has mac &amp; windows implementation
 525     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 526     controller-&gt;display();
 527 
 528     return JSValueMakeUndefined(context);
 529 }
 530 
 531 static JSValueRef displayAndTrackRepaintsCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 532 {
 533     // Has mac &amp; windows implementation
 534     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 535     controller-&gt;displayAndTrackRepaints();
 536 
 537     return JSValueMakeUndefined(context);
 538 }
 539 
 540 static JSValueRef encodeHostNameCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 541 {
 542     // Has mac implementation
 543     if (argumentCount &lt; 1)
 544         return JSValueMakeUndefined(context);
 545 
 546     auto name = adopt(JSValueToStringCopy(context, arguments[0], exception));
 547     ASSERT(!*exception);
 548 
 549     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 550     auto encodedHostName = controller-&gt;copyEncodedHostName(name.get());
 551     return JSValueMakeString(context, encodedHostName.get());
 552 }
 553 
 554 static JSValueRef execCommandCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 555 {
 556     // Has Mac &amp; Windows implementations.
 557     if (argumentCount &lt; 1)
 558         return JSValueMakeUndefined(context);
 559 
 560     auto name = adopt(JSValueToStringCopy(context, arguments[0], exception));
 561     ASSERT(!*exception);
 562 
 563     // Ignoring the second parameter (userInterface), as this command emulates a manual action.
 564 
 565     JSRetainPtr&lt;JSStringRef&gt; value;
 566     if (argumentCount &gt;= 3) {
 567         value = adopt(JSValueToStringCopy(context, arguments[2], exception));
 568         ASSERT(!*exception);
 569     } else
 570         value = adopt(JSStringCreateWithUTF8CString(&quot;&quot;));
 571 
 572 
 573     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 574     controller-&gt;execCommand(name.get(), value.get());
 575 
 576     return JSValueMakeUndefined(context);
 577 }
 578 
 579 static JSValueRef findStringCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 580 {
 581     // Has Mac implementation.
 582     if (argumentCount &lt; 2)
 583         return JSValueMakeUndefined(context);
 584 
 585     auto target = adopt(JSValueToStringCopy(context, arguments[0], exception));
 586     ASSERT(!*exception);
 587 
 588     JSObjectRef options = JSValueToObject(context, arguments[1], exception);
 589     ASSERT(!*exception);
 590 
 591     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 592     return JSValueMakeBoolean(context, controller-&gt;findString(context, target.get(), options));
 593 }
 594 
 595 static JSValueRef goBackCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 596 {
 597     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 598     controller-&gt;goBack();
 599 
 600     return JSValueMakeUndefined(context);
 601 }
 602 
 603 static JSValueRef isCommandEnabledCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 604 {
 605     // Has Mac implementation.
 606 
 607     if (argumentCount &lt; 1)
 608         return JSValueMakeUndefined(context);
 609 
 610     auto name = adopt(JSValueToStringCopy(context, arguments[0], exception));
 611     ASSERT(!*exception);
 612 
 613     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 614 
 615     return JSValueMakeBoolean(context, controller-&gt;isCommandEnabled(name.get()));
 616 }
 617 
 618 static JSValueRef overridePreferenceCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 619 {
 620     if (argumentCount &lt; 2)
 621         return JSValueMakeUndefined(context);
 622 
 623     auto key = adopt(JSValueToStringCopy(context, arguments[0], exception));
 624     ASSERT(!*exception);
 625     auto value = adopt(JSValueToStringCopy(context, arguments[1], exception));
 626     ASSERT(!*exception);
 627 
 628     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 629     controller-&gt;overridePreference(key.get(), value.get());
 630 
 631     return JSValueMakeUndefined(context);
 632 }
 633 
 634 static JSValueRef keepWebHistoryCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 635 {
 636     // Has mac implementation
 637     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 638     controller-&gt;keepWebHistory();
 639 
 640     return JSValueMakeUndefined(context);
 641 }
 642 
 643 static JSValueRef notifyDoneCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 644 {
 645     // Has mac &amp; windows implementation
 646     // May be able to be made platform independant by using shared WorkQueue
 647     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 648     controller-&gt;notifyDone();
 649     return JSValueMakeUndefined(context);
 650 }
 651 
 652 static JSValueRef numberOfPendingGeolocationPermissionRequestsCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 653 {
 654     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 655     return JSValueMakeNumber(context, controller-&gt;numberOfPendingGeolocationPermissionRequests());
 656 }
 657 
 658 static JSValueRef isGeolocationProviderActiveCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 659 {
 660     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 661     return JSValueMakeBoolean(context, controller-&gt;isGeolocationProviderActive());
 662 }
 663 
 664 static JSValueRef queueBackNavigationCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 665 {
 666     // Has mac &amp; windows implementation
 667     // May be able to be made platform independant by using shared WorkQueue
 668     if (argumentCount &lt; 1)
 669         return JSValueMakeUndefined(context);
 670 
 671     double howFarBackDouble = JSValueToNumber(context, arguments[0], exception);
 672     ASSERT(!*exception);
 673 
 674     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 675     controller-&gt;queueBackNavigation(static_cast&lt;int&gt;(howFarBackDouble));
 676 
 677     return JSValueMakeUndefined(context);
 678 }
 679 
 680 static JSValueRef queueForwardNavigationCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 681 {
 682     // Has mac &amp; windows implementation
 683     // May be able to be made platform independant by using shared WorkQueue
 684     if (argumentCount &lt; 1)
 685         return JSValueMakeUndefined(context);
 686 
 687     double howFarForwardDouble = JSValueToNumber(context, arguments[0], exception);
 688     ASSERT(!*exception);
 689 
 690     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 691     controller-&gt;queueForwardNavigation(static_cast&lt;int&gt;(howFarForwardDouble));
 692 
 693     return JSValueMakeUndefined(context);
 694 }
 695 
 696 static JSValueRef queueLoadCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 697 {
 698     // Has mac &amp; windows implementation
 699     // May be able to be made platform independant by using shared WorkQueue
 700     if (argumentCount &lt; 1)
 701         return JSValueMakeUndefined(context);
 702 
 703     auto url = adopt(JSValueToStringCopy(context, arguments[0], exception));
 704     ASSERT(!*exception);
 705 
 706     JSRetainPtr&lt;JSStringRef&gt; target;
 707     if (argumentCount &gt;= 2) {
 708         target = adopt(JSValueToStringCopy(context, arguments[1], exception));
 709         ASSERT(!*exception);
 710     } else
 711         target = adopt(JSStringCreateWithUTF8CString(&quot;&quot;));
 712 
 713     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 714     controller-&gt;queueLoad(url.get(), target.get());
 715 
 716     return JSValueMakeUndefined(context);
 717 }
 718 
 719 static JSValueRef queueLoadHTMLStringCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 720 {
 721     // Has Mac &amp; Windows implementation
 722     if (argumentCount &lt; 1)
 723         return JSValueMakeUndefined(context);
 724 
 725     auto content = adopt(JSValueToStringCopy(context, arguments[0], exception));
 726     ASSERT(!*exception);
 727 
 728     JSRetainPtr&lt;JSStringRef&gt; baseURL;
 729     if (argumentCount &gt;= 2) {
 730         baseURL = adopt(JSValueToStringCopy(context, arguments[1], exception));
 731         ASSERT(!*exception);
 732     } else
 733         baseURL = adopt(JSStringCreateWithUTF8CString(&quot;&quot;));
 734 
 735     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 736 
 737     if (argumentCount &gt;= 3) {
 738         auto unreachableURL = adopt(JSValueToStringCopy(context, arguments[2], exception));
 739         ASSERT(!*exception);
 740         controller-&gt;queueLoadAlternateHTMLString(content.get(), baseURL.get(), unreachableURL.get());
 741         return JSValueMakeUndefined(context);
 742     }
 743 
 744     controller-&gt;queueLoadHTMLString(content.get(), baseURL.get());
 745     return JSValueMakeUndefined(context);
 746 }
 747 
 748 static JSValueRef queueReloadCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 749 {
 750     // Has mac &amp; windows implementation
 751     // May be able to be made platform independant by using shared WorkQueue
 752 
 753     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 754     controller-&gt;queueReload();
 755 
 756     return JSValueMakeUndefined(context);
 757 }
 758 
 759 static JSValueRef queueLoadingScriptCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 760 {
 761     // Has mac &amp; windows implementation
 762     // May be able to be made platform independant by using shared WorkQueue
 763     if (argumentCount &lt; 1)
 764         return JSValueMakeUndefined(context);
 765 
 766     auto script = adopt(JSValueToStringCopy(context, arguments[0], exception));
 767     ASSERT(!*exception);
 768 
 769     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 770     controller-&gt;queueLoadingScript(script.get());
 771 
 772     return JSValueMakeUndefined(context);
 773 }
 774 
 775 static JSValueRef queueNonLoadingScriptCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 776 {
 777     // Has mac &amp; windows implementation
 778     // May be able to be made platform independant by using shared WorkQueue
 779     if (argumentCount &lt; 1)
 780         return JSValueMakeUndefined(context);
 781 
 782     auto script = adopt(JSValueToStringCopy(context, arguments[0], exception));
 783     ASSERT(!*exception);
 784 
 785     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 786     controller-&gt;queueNonLoadingScript(script.get());
 787 
 788     return JSValueMakeUndefined(context);
 789 }
 790 
 791 static JSValueRef setAcceptsEditingCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 792 {
 793     // Has mac &amp; windows implementation
 794     if (argumentCount &lt; 1)
 795         return JSValueMakeUndefined(context);
 796 
 797     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 798     controller-&gt;setAcceptsEditing(JSValueToBoolean(context, arguments[0]));
 799 
 800     return JSValueMakeUndefined(context);
 801 }
 802 
 803 static JSValueRef setAlwaysAcceptCookiesCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 804 {
 805     // Has mac &amp; windows implementation
 806     if (argumentCount &lt; 1)
 807         return JSValueMakeUndefined(context);
 808 
 809     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 810     controller-&gt;setAlwaysAcceptCookies(JSValueToBoolean(context, arguments[0]));
 811 
 812     return JSValueMakeUndefined(context);
 813 }
 814 
 815 static JSValueRef setOnlyAcceptFirstPartyCookiesCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 816 {
 817     if (argumentCount &lt; 1)
 818         return JSValueMakeUndefined(context);
 819 
 820     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 821     controller-&gt;setOnlyAcceptFirstPartyCookies(JSValueToBoolean(context, arguments[0]));
 822 
 823     return JSValueMakeUndefined(context);
 824 }
 825 
 826 static JSValueRef setAppCacheMaximumSizeCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 827 {
 828     // Has mac implementation
 829     if (argumentCount &lt; 1)
 830         return JSValueMakeUndefined(context);
 831 
 832     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 833 
 834     double size = JSValueToNumber(context, arguments[0], NULL);
 835     if (!std::isnan(size))
 836         controller-&gt;setAppCacheMaximumSize(static_cast&lt;unsigned long long&gt;(size));
 837 
 838     return JSValueMakeUndefined(context);
 839 }
 840 
 841 static JSValueRef setAuthenticationPasswordCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 842 {
 843     // Has mac &amp; windows implementation
 844     if (argumentCount &lt; 1)
 845         return JSValueMakeUndefined(context);
 846 
 847     auto password = adopt(JSValueToStringCopy(context, arguments[0], exception));
 848     ASSERT(!*exception);
 849 
 850     size_t maxLength = JSStringGetMaximumUTF8CStringSize(password.get());
 851     char* passwordBuffer = new char[maxLength + 1];
 852     JSStringGetUTF8CString(password.get(), passwordBuffer, maxLength + 1);
 853 
 854     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 855     controller-&gt;setAuthenticationPassword(passwordBuffer);
 856     delete[] passwordBuffer;
 857 
 858     return JSValueMakeUndefined(context);
 859 }
 860 
 861 static JSValueRef setAuthenticationUsernameCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 862 {
 863     // Has mac &amp; windows implementation
 864     if (argumentCount &lt; 1)
 865         return JSValueMakeUndefined(context);
 866 
 867     auto username = adopt(JSValueToStringCopy(context, arguments[0], exception));
 868     ASSERT(!*exception);
 869 
 870     size_t maxLength = JSStringGetMaximumUTF8CStringSize(username.get());
 871     char* usernameBuffer = new char[maxLength + 1];
 872     JSStringGetUTF8CString(username.get(), usernameBuffer, maxLength + 1);
 873 
 874     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 875     controller-&gt;setAuthenticationUsername(usernameBuffer);
 876     delete[] usernameBuffer;
 877 
 878     return JSValueMakeUndefined(context);
 879 }
 880 
 881 static JSValueRef setAuthorAndUserStylesEnabledCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 882 {
 883     // Has mac &amp; windows implementation
 884     if (argumentCount &lt; 1)
 885         return JSValueMakeUndefined(context);
 886 
 887     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 888     controller-&gt;setAuthorAndUserStylesEnabled(JSValueToBoolean(context, arguments[0]));
 889 
 890     return JSValueMakeUndefined(context);
 891 }
 892 
 893 static JSValueRef setCacheModelCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 894 {
 895     // Has Mac implementation.
 896     if (argumentCount &lt; 1)
 897         return JSValueMakeUndefined(context);
 898 
 899     int cacheModel = JSValueToNumber(context, arguments[0], exception);
 900     ASSERT(!*exception);
 901 
 902     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 903     controller-&gt;setCacheModel(cacheModel);
 904 
 905     return JSValueMakeUndefined(context);
 906 }
 907 
 908 static JSValueRef setCustomPolicyDelegateCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 909 {
 910     // Has mac implementation
 911     if (argumentCount &lt; 1)
 912         return JSValueMakeUndefined(context);
 913 
 914     bool permissive = false;
 915     if (argumentCount &gt;= 2)
 916         permissive = JSValueToBoolean(context, arguments[1]);
 917 
 918     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 919     controller-&gt;setCustomPolicyDelegate(JSValueToBoolean(context, arguments[0]), permissive);
 920 
 921     return JSValueMakeUndefined(context);
 922 }
 923 
 924 static JSValueRef setDatabaseQuotaCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 925 {
 926     // Has mac implementation
 927     if (argumentCount &lt; 1)
 928         return JSValueMakeUndefined(context);
 929 
 930     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 931 
 932     double quota = JSValueToNumber(context, arguments[0], NULL);
 933     if (!std::isnan(quota))
 934         controller-&gt;setDatabaseQuota(static_cast&lt;unsigned long long&gt;(quota));
 935 
 936     return JSValueMakeUndefined(context);
 937 }
 938 
<a name="7" id="anc7"></a><span class="line-removed"> 939 static JSValueRef setIDBPerOriginQuotaCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)</span>
<span class="line-removed"> 940 {</span>
<span class="line-removed"> 941     if (argumentCount &lt; 1)</span>
<span class="line-removed"> 942         return JSValueMakeUndefined(context);</span>
<span class="line-removed"> 943 </span>
<span class="line-removed"> 944     auto* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));</span>
<span class="line-removed"> 945 </span>
<span class="line-removed"> 946     double quota = JSValueToNumber(context, arguments[0], nullptr);</span>
<span class="line-removed"> 947     if (!std::isnan(quota))</span>
<span class="line-removed"> 948         controller-&gt;setIDBPerOriginQuota(static_cast&lt;uint64_t&gt;(quota));</span>
<span class="line-removed"> 949 </span>
<span class="line-removed"> 950     return JSValueMakeUndefined(context);</span>
<span class="line-removed"> 951 }</span>
<span class="line-removed"> 952 </span>
 953 static JSValueRef setDefersLoadingCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 954 {
 955     if (argumentCount &lt; 1)
 956         return JSValueMakeUndefined(context);
 957 
 958     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 959     controller-&gt;setDefersLoading(JSValueToBoolean(context, arguments[0]));
 960 
 961     return JSValueMakeUndefined(context);
 962 }
 963 
 964 static JSValueRef setUseDeferredFrameLoadingCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 965 {
 966     if (argumentCount &lt; 1)
 967         return JSValueMakeUndefined(context);
 968 
 969     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 970     controller-&gt;setUseDeferredFrameLoading(JSValueToBoolean(context, arguments[0]));
 971 
 972     return JSValueMakeUndefined(context);
 973 }
 974 
 975 static JSValueRef setDomainRelaxationForbiddenForURLSchemeCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 976 {
 977     // Has Mac and Windows implementation
 978     if (argumentCount &lt; 2)
 979         return JSValueMakeUndefined(context);
 980 
 981     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
 982 
 983     bool forbidden = JSValueToBoolean(context, arguments[0]);
 984     auto scheme = adopt(JSValueToStringCopy(context, arguments[1], 0));
 985     controller-&gt;setDomainRelaxationForbiddenForURLScheme(forbidden, scheme.get());
 986 
 987     return JSValueMakeUndefined(context);
 988 }
 989 
 990 static JSValueRef setMockDeviceOrientationCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
 991 {
 992     if (argumentCount &lt; 6)
 993         return JSValueMakeUndefined(context);
 994 
 995     bool canProvideAlpha = JSValueToBoolean(context, arguments[0]);
 996     double alpha = JSValueToNumber(context, arguments[1], exception);
 997     ASSERT(!*exception);
 998     bool canProvideBeta = JSValueToBoolean(context, arguments[2]);
 999     double beta = JSValueToNumber(context, arguments[3], exception);
1000     ASSERT(!*exception);
1001     bool canProvideGamma = JSValueToBoolean(context, arguments[4]);
1002     double gamma = JSValueToNumber(context, arguments[5], exception);
1003     ASSERT(!*exception);
1004 
1005     TestRunner* controller = reinterpret_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1006     controller-&gt;setMockDeviceOrientation(canProvideAlpha, alpha, canProvideBeta, beta, canProvideGamma, gamma);
1007 
1008     return JSValueMakeUndefined(context);
1009 }
1010 
1011 static JSValueRef setMockGeolocationPositionCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1012 {
1013     if (argumentCount &lt; 3)
1014         return JSValueMakeUndefined(context);
1015 
1016     double latitude = JSValueToNumber(context, arguments[0], 0);
1017     double longitude = JSValueToNumber(context, arguments[1], 0);
1018     double accuracy = JSValueToNumber(context, arguments[2], 0);
1019 
1020     bool canProvideAltitude = false;
1021     double altitude = 0.;
1022     if (argumentCount &gt; 3 &amp;&amp; !JSValueIsUndefined(context, arguments[3])) {
1023         canProvideAltitude = true;
1024         altitude = JSValueToNumber(context, arguments[3], 0);
1025     }
1026 
1027     bool canProvideAltitudeAccuracy = false;
1028     double altitudeAccuracy = 0.;
1029     if (argumentCount &gt; 4 &amp;&amp; !JSValueIsUndefined(context, arguments[4])) {
1030         canProvideAltitudeAccuracy = true;
1031         altitudeAccuracy = JSValueToNumber(context, arguments[4], 0);
1032     }
1033 
1034     bool canProvideHeading = false;
1035     double heading = 0.;
1036     if (argumentCount &gt; 5 &amp;&amp; !JSValueIsUndefined(context, arguments[5])) {
1037         canProvideHeading = true;
1038         heading = JSValueToNumber(context, arguments[5], 0);
1039     }
1040 
1041     bool canProvideSpeed = false;
1042     double speed = 0.;
1043     if (argumentCount &gt; 6 &amp;&amp; !JSValueIsUndefined(context, arguments[6])) {
1044         canProvideSpeed = true;
1045         speed = JSValueToNumber(context, arguments[6], 0);
1046     }
1047 
1048     bool canProvideFloorLevel = false;
1049     double floorLevel = 0.;
1050     if (argumentCount &gt; 7 &amp;&amp; !JSValueIsUndefined(context, arguments[7])) {
1051         canProvideFloorLevel = true;
1052         floorLevel = JSValueToNumber(context, arguments[7], 0);
1053     }
1054 
1055     TestRunner* controller = reinterpret_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1056     controller-&gt;setMockGeolocationPosition(latitude, longitude, accuracy, canProvideAltitude, altitude, canProvideAltitudeAccuracy, altitudeAccuracy, canProvideHeading, heading, canProvideSpeed, speed, canProvideFloorLevel, floorLevel);
1057 
1058     return JSValueMakeUndefined(context);
1059 }
1060 
1061 static JSValueRef setMockGeolocationPositionUnavailableErrorCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1062 {
1063     if (argumentCount != 1)
1064         return JSValueMakeUndefined(context);
1065 
1066     auto message = adopt(JSValueToStringCopy(context, arguments[0], exception));
1067     ASSERT(!*exception);
1068 
1069     TestRunner* controller = reinterpret_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1070     controller-&gt;setMockGeolocationPositionUnavailableError(message.get());
1071 
1072     return JSValueMakeUndefined(context);
1073 }
1074 
1075 static JSValueRef setNewWindowsCopyBackForwardListCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1076 {
1077     // Has mac implementation
1078     if (argumentCount &lt; 1)
1079         return JSValueMakeUndefined(context);
1080 
1081     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1082     controller-&gt;setNewWindowsCopyBackForwardList(JSValueToBoolean(context, arguments[0]));
1083 
1084     return JSValueMakeUndefined(context);
1085 }
1086 
1087 static JSValueRef setGeolocationPermissionCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1088 {
1089     // Has mac implementation
1090     if (argumentCount &lt; 1)
1091         return JSValueMakeUndefined(context);
1092 
1093     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1094     controller-&gt;setGeolocationPermission(JSValueToBoolean(context, arguments[0]));
1095 
1096     return JSValueMakeUndefined(context);
1097 }
1098 
1099 static JSValueRef setRejectsProtectionSpaceAndContinueForAuthenticationChallengesCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1100 {
1101     // Has mac &amp; windows implementation
1102     if (argumentCount &lt; 1)
1103         return JSValueMakeUndefined(context);
1104 
1105     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1106     controller-&gt;setRejectsProtectionSpaceAndContinueForAuthenticationChallenges(JSValueToBoolean(context, arguments[0]));
1107 
1108     return JSValueMakeUndefined(context);
1109 }
1110 
1111 static JSValueRef setHandlesAuthenticationChallengesCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1112 {
1113     // Has mac &amp; windows implementation
1114     if (argumentCount &lt; 1)
1115         return JSValueMakeUndefined(context);
1116 
1117     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1118     controller-&gt;setHandlesAuthenticationChallenges(JSValueToBoolean(context, arguments[0]));
1119 
1120     return JSValueMakeUndefined(context);
1121 }
1122 
1123 static JSValueRef setPOSIXLocaleCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1124 {
1125     if (argumentCount &lt; 1)
1126         return JSValueMakeUndefined(context);
1127 
1128     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1129     auto locale = adopt(JSValueToStringCopy(context, arguments[0], exception));
1130     ASSERT(!*exception);
1131     controller-&gt;setPOSIXLocale(locale.get());
1132 
1133     return JSValueMakeUndefined(context);
1134 }
1135 
1136 static JSValueRef setIconDatabaseEnabledCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1137 {
1138     // Has mac &amp; windows implementation
1139     if (argumentCount &lt; 1)
1140         return JSValueMakeUndefined(context);
1141 
1142     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1143     controller-&gt;setIconDatabaseEnabled(JSValueToBoolean(context, arguments[0]));
1144 
1145     return JSValueMakeUndefined(context);
1146 }
1147 
1148 static JSValueRef setMainFrameIsFirstResponderCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1149 {
1150     // Has mac implementation
1151     if (argumentCount &lt; 1)
1152         return JSValueMakeUndefined(context);
1153 
1154     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1155     controller-&gt;setMainFrameIsFirstResponder(JSValueToBoolean(context, arguments[0]));
1156 
1157     return JSValueMakeUndefined(context);
1158 }
1159 
1160 static JSValueRef setPersistentUserStyleSheetLocationCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1161 {
1162     // Has mac implementation
1163     if (argumentCount &lt; 1)
1164         return JSValueMakeUndefined(context);
1165 
1166     auto path = adopt(JSValueToStringCopy(context, arguments[0], exception));
1167     ASSERT(!*exception);
1168 
1169     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1170     controller-&gt;setPersistentUserStyleSheetLocation(path.get());
1171 
1172     return JSValueMakeUndefined(context);
1173 }
1174 
1175 static JSValueRef setPrivateBrowsingEnabledCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1176 {
1177     // Has mac &amp; windows implementation
1178     if (argumentCount &lt; 1)
1179         return JSValueMakeUndefined(context);
1180 
1181     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1182     controller-&gt;setPrivateBrowsingEnabled(JSValueToBoolean(context, arguments[0]));
1183 
1184     return JSValueMakeUndefined(context);
1185 }
1186 
1187 static JSValueRef setJavaScriptCanAccessClipboardCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1188 {
1189     // Has mac &amp; windows implementation
1190     if (argumentCount &lt; 1)
1191         return JSValueMakeUndefined(context);
1192 
1193     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1194     controller-&gt;setJavaScriptCanAccessClipboard(JSValueToBoolean(context, arguments[0]));
1195 
1196     return JSValueMakeUndefined(context);
1197 }
1198 
1199 static JSValueRef setXSSAuditorEnabledCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1200 {
1201     // Has mac &amp; windows implementation
1202     if (argumentCount &lt; 1)
1203         return JSValueMakeUndefined(context);
1204 
1205     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1206     controller-&gt;setXSSAuditorEnabled(JSValueToBoolean(context, arguments[0]));
1207 
1208     return JSValueMakeUndefined(context);
1209 }
1210 
1211 static JSValueRef setSpatialNavigationEnabledCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1212 {
1213     // Has mac &amp; windows implementation.
1214     if (argumentCount &lt; 1)
1215         return JSValueMakeUndefined(context);
1216 
1217     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1218     controller-&gt;setSpatialNavigationEnabled(JSValueToBoolean(context, arguments[0]));
1219 
1220     return JSValueMakeUndefined(context);
1221 }
1222 
1223 static JSValueRef setPrintingCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1224 {
1225     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1226     controller-&gt;setIsPrinting(true);
1227     return JSValueMakeUndefined(context);
1228 }
1229 
1230 static JSValueRef setAllowsAnySSLCertificateCallback(JSContextRef context, JSObjectRef, JSObjectRef, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1231 {
1232     bool allowAnyCertificate = false;
1233     if (argumentCount == 1)
1234         allowAnyCertificate = JSValueToBoolean(context, arguments[0]);
1235 
1236     TestRunner::setAllowsAnySSLCertificate(allowAnyCertificate);
1237     return JSValueMakeUndefined(context);
1238 }
1239 
1240 static JSValueRef setAllowUniversalAccessFromFileURLsCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1241 {
1242     // Has mac &amp; windows implementation
1243     if (argumentCount &lt; 1)
1244         return JSValueMakeUndefined(context);
1245 
1246     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1247     controller-&gt;setAllowUniversalAccessFromFileURLs(JSValueToBoolean(context, arguments[0]));
1248 
1249     return JSValueMakeUndefined(context);
1250 }
1251 
1252 static JSValueRef setAllowFileAccessFromFileURLsCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1253 {
1254     // Has mac &amp; windows implementation
1255     if (argumentCount &lt; 1)
1256         return JSValueMakeUndefined(context);
1257 
1258     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1259     controller-&gt;setAllowFileAccessFromFileURLs(JSValueToBoolean(context, arguments[0]));
1260 
1261     return JSValueMakeUndefined(context);
1262 }
1263 
1264 static JSValueRef setNeedsStorageAccessFromFileURLsQuirkCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1265 {
1266     // Has mac &amp; windows implementation
1267     if (argumentCount &lt; 1)
1268         return JSValueMakeUndefined(context);
1269 
1270     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1271     controller-&gt;setNeedsStorageAccessFromFileURLsQuirk(JSValueToBoolean(context, arguments[0]));
1272 
1273     return JSValueMakeUndefined(context);
1274 }
1275 
1276 static JSValueRef setTabKeyCyclesThroughElementsCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1277 {
1278     // Has mac &amp; windows implementation
1279     if (argumentCount &lt; 1)
1280         return JSValueMakeUndefined(context);
1281 
1282     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1283     controller-&gt;setTabKeyCyclesThroughElements(JSValueToBoolean(context, arguments[0]));
1284 
1285     return JSValueMakeUndefined(context);
1286 }
1287 
1288 #if PLATFORM(IOS_FAMILY)
1289 static JSValueRef setTelephoneNumberParsingEnabledCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1290 {
1291     if (argumentCount &lt; 1)
1292         return JSValueMakeUndefined(context);
1293 
1294     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1295     controller-&gt;setTelephoneNumberParsingEnabled(JSValueToBoolean(context, arguments[0]));
1296 
1297     return JSValueMakeUndefined(context);
1298 }
1299 
1300 static JSValueRef setPagePausedCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1301 {
1302     if (argumentCount &lt; 1)
1303         return JSValueMakeUndefined(context);
1304 
1305     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1306     controller-&gt;setPagePaused(JSValueToBoolean(context, arguments[0]));
1307 
1308     return JSValueMakeUndefined(context);
1309 }
1310 #endif
1311 
<a name="8" id="anc8"></a><span class="line-removed">1312 static JSValueRef setUseDashboardCompatibilityModeCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)</span>
<span class="line-removed">1313 {</span>
<span class="line-removed">1314     // Has mac implementation</span>
<span class="line-removed">1315     if (argumentCount &lt; 1)</span>
<span class="line-removed">1316         return JSValueMakeUndefined(context);</span>
<span class="line-removed">1317 </span>
<span class="line-removed">1318     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));</span>
<span class="line-removed">1319     controller-&gt;setUseDashboardCompatibilityMode(JSValueToBoolean(context, arguments[0]));</span>
<span class="line-removed">1320 </span>
<span class="line-removed">1321     return JSValueMakeUndefined(context);</span>
<span class="line-removed">1322 }</span>
<span class="line-removed">1323 </span>
1324 static JSValueRef setUserStyleSheetEnabledCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1325 {
1326     // Has mac implementation
1327     if (argumentCount &lt; 1)
1328         return JSValueMakeUndefined(context);
1329 
1330     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1331     controller-&gt;setUserStyleSheetEnabled(JSValueToBoolean(context, arguments[0]));
1332 
1333     return JSValueMakeUndefined(context);
1334 }
1335 
1336 static JSValueRef setUserStyleSheetLocationCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1337 {
1338     // Has mac implementation
1339     if (argumentCount &lt; 1)
1340         return JSValueMakeUndefined(context);
1341 
1342     auto path = adopt(JSValueToStringCopy(context, arguments[0], exception));
1343     ASSERT(!*exception);
1344 
1345     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1346     controller-&gt;setUserStyleSheetLocation(path.get());
1347 
1348     return JSValueMakeUndefined(context);
1349 }
1350 
1351 static JSValueRef setValueForUserCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1352 {
1353     // Has mac implementation
1354     if (argumentCount != 2)
1355         return JSValueMakeUndefined(context);
1356 
1357     auto value = adopt(JSValueToStringCopy(context, arguments[1], exception));
1358     ASSERT(!*exception);
1359 
1360     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1361     controller-&gt;setValueForUser(context, arguments[0], value.get());
1362 
1363     return JSValueMakeUndefined(context);
1364 }
1365 
1366 static JSValueRef setWillSendRequestClearHeaderCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1367 {
1368     // Has mac &amp; windows implementation
1369     if (argumentCount &lt; 1)
1370         return JSValueMakeUndefined(context);
1371 
1372     auto header = adopt(JSValueToStringCopy(context, arguments[0], exception));
1373     ASSERT(!*exception);
1374 
1375     size_t maxLength = JSStringGetMaximumUTF8CStringSize(header.get());
<a name="9" id="anc9"></a><span class="line-modified">1376     auto headerBuffer = std::make_unique&lt;char[]&gt;(maxLength + 1);</span>
1377     JSStringGetUTF8CString(header.get(), headerBuffer.get(), maxLength + 1);
1378 
1379     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1380     controller-&gt;setWillSendRequestClearHeader(headerBuffer.get());
1381 
1382     return JSValueMakeUndefined(context);
1383 }
1384 
1385 static JSValueRef setWillSendRequestReturnsNullCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1386 {
1387     // Has cross-platform implementation
1388     if (argumentCount &lt; 1)
1389         return JSValueMakeUndefined(context);
1390 
1391     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1392     controller-&gt;setWillSendRequestReturnsNull(JSValueToBoolean(context, arguments[0]));
1393 
1394     return JSValueMakeUndefined(context);
1395 }
1396 
1397 static JSValueRef setWillSendRequestReturnsNullOnRedirectCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1398 {
1399     // Has cross-platform implementation
1400     if (argumentCount &lt; 1)
1401         return JSValueMakeUndefined(context);
1402 
1403     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1404     controller-&gt;setWillSendRequestReturnsNullOnRedirect(JSValueToBoolean(context, arguments[0]));
1405 
1406     return JSValueMakeUndefined(context);
1407 }
1408 
1409 static JSValueRef setWindowIsKeyCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1410 {
1411     // Has mac implementation
1412     if (argumentCount &lt; 1)
1413         return JSValueMakeUndefined(context);
1414 
1415     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1416     controller-&gt;setWindowIsKey(JSValueToBoolean(context, arguments[0]));
1417 
1418     return JSValueMakeUndefined(context);
1419 }
1420 
1421 static JSValueRef setViewSizeCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1422 {
1423     if (argumentCount &lt; 2)
1424         return JSValueMakeUndefined(context);
1425 
1426     double width = JSValueToNumber(context, arguments[0], exception);
1427     ASSERT(!*exception);
1428     double height = JSValueToNumber(context, arguments[1], exception);
1429     ASSERT(!*exception);
1430 
1431     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1432     controller-&gt;setViewSize(width, height);
1433 
1434     return JSValueMakeUndefined(context);
1435 }
1436 
1437 static JSValueRef waitUntilDoneCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1438 {
1439     // Has mac &amp; windows implementation
1440     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1441     controller-&gt;setWaitToDump(true);
1442 
1443     return JSValueMakeUndefined(context);
1444 }
1445 
1446 static JSValueRef windowCountCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1447 {
1448     // Has mac implementation
1449     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1450     int windows = controller-&gt;windowCount();
1451     return JSValueMakeNumber(context, windows);
1452 }
1453 
1454 static JSValueRef setPopupBlockingEnabledCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1455 {
1456     // Has mac &amp; windows implementation
1457     if (argumentCount &lt; 1)
1458         return JSValueMakeUndefined(context);
1459 
1460     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1461     controller-&gt;setPopupBlockingEnabled(JSValueToBoolean(context, arguments[0]));
1462 
1463     return JSValueMakeUndefined(context);
1464 }
1465 
1466 static JSValueRef setPluginsEnabledCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1467 {
1468     // Has mac &amp; windows implementation
1469     if (argumentCount &lt; 1)
1470         return JSValueMakeUndefined(context);
1471 
1472     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1473     controller-&gt;setPluginsEnabled(JSValueToBoolean(context, arguments[0]));
1474 
1475     return JSValueMakeUndefined(context);
1476 }
1477 
1478 static JSValueRef setPageVisibilityCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1479 {
1480     // Has mac &amp; windows implementation
1481     if (argumentCount &lt; 1)
1482         return JSValueMakeUndefined(context);
1483 
1484     auto visibility = adopt(JSValueToStringCopy(context, arguments[0], exception));
1485     ASSERT(!*exception);
1486 
1487     size_t maxLength = JSStringGetMaximumUTF8CStringSize(visibility.get());
1488     char* visibilityBuffer = new char[maxLength + 1];
1489     JSStringGetUTF8CString(visibility.get(), visibilityBuffer, maxLength + 1);
1490 
1491     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1492     controller-&gt;setPageVisibility(visibilityBuffer);
1493     delete[] visibilityBuffer;
1494 
1495     return JSValueMakeUndefined(context);
1496 }
1497 
1498 static JSValueRef resetPageVisibilityCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1499 {
1500     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1501     controller-&gt;resetPageVisibility();
1502     return JSValueMakeUndefined(context);
1503 }
1504 
1505 static JSValueRef setAutomaticLinkDetectionEnabledCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1506 {
1507     if (argumentCount &lt; 1)
1508         return JSValueMakeUndefined(context);
1509 
1510     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1511     controller-&gt;setAutomaticLinkDetectionEnabled(JSValueToBoolean(context, arguments[0]));
1512     return JSValueMakeUndefined(context);
1513 }
1514 
1515 static JSValueRef setStopProvisionalFrameLoadsCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1516 {
1517     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1518     controller-&gt;setStopProvisionalFrameLoads(true);
1519     return JSValueMakeUndefined(context);
1520 }
1521 
1522 static JSValueRef showWebInspectorCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1523 {
1524     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1525     controller-&gt;showWebInspector();
1526     return JSValueMakeUndefined(context);
1527 }
1528 
1529 static JSValueRef closeWebInspectorCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1530 {
1531     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1532     controller-&gt;closeWebInspector();
1533     return JSValueMakeUndefined(context);
1534 }
1535 
1536 static JSValueRef evaluateInWebInspectorCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1537 {
1538     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1539     auto script = adopt(JSValueToStringCopy(context, arguments[0], exception));
1540     ASSERT(!*exception);
1541 
1542     controller-&gt;evaluateInWebInspector(script.get());
1543     return JSValueMakeUndefined(context);
1544 }
1545 
1546 static JSValueRef evaluateScriptInIsolatedWorldCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1547 {
1548     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1549     double worldID = JSValueToNumber(context, arguments[0], exception);
1550     ASSERT(!*exception);
1551     auto script = adopt(JSValueToStringCopy(context, arguments[1], exception));
1552     ASSERT(!*exception);
1553 
1554     controller-&gt;evaluateScriptInIsolatedWorld(static_cast&lt;unsigned&gt;(worldID), JSContextGetGlobalObject(context), script.get());
1555     return JSValueMakeUndefined(context);
1556 }
1557 
1558 static JSValueRef evaluateScriptInIsolatedWorldAndReturnValueCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1559 {
1560     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1561     double worldID = JSValueToNumber(context, arguments[0], exception);
1562     ASSERT(!*exception);
1563     auto script = adopt(JSValueToStringCopy(context, arguments[1], exception));
1564     ASSERT(!*exception);
1565 
1566     controller-&gt;evaluateScriptInIsolatedWorldAndReturnValue(static_cast&lt;unsigned&gt;(worldID), JSContextGetGlobalObject(context), script.get());
1567     return JSValueMakeUndefined(context);
1568 }
1569 
1570 static JSValueRef waitForPolicyDelegateCallback(JSContextRef context, JSObjectRef, JSObjectRef thisObject, size_t, const JSValueRef[], JSValueRef*)
1571 {
1572     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1573     controller-&gt;waitForPolicyDelegate();
1574     return JSValueMakeUndefined(context);
1575 }
1576 
1577 static JSValueRef addOriginAccessWhitelistEntryCallback(JSContextRef context, JSObjectRef, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1578 {
1579     if (argumentCount != 4)
1580         return JSValueMakeUndefined(context);
1581 
1582     auto sourceOrigin = adopt(JSValueToStringCopy(context, arguments[0], exception));
1583     ASSERT(!*exception);
1584     auto destinationProtocol = adopt(JSValueToStringCopy(context, arguments[1], exception));
1585     ASSERT(!*exception);
1586     auto destinationHost = adopt(JSValueToStringCopy(context, arguments[2], exception));
1587     ASSERT(!*exception);
1588     bool allowDestinationSubdomains = JSValueToBoolean(context, arguments[3]);
1589 
1590     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1591     controller-&gt;addOriginAccessWhitelistEntry(sourceOrigin.get(), destinationProtocol.get(), destinationHost.get(), allowDestinationSubdomains);
1592     return JSValueMakeUndefined(context);
1593 }
1594 
1595 static JSValueRef removeOriginAccessWhitelistEntryCallback(JSContextRef context, JSObjectRef, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1596 {
1597     if (argumentCount != 4)
1598         return JSValueMakeUndefined(context);
1599 
1600     auto sourceOrigin = adopt(JSValueToStringCopy(context, arguments[0], exception));
1601     ASSERT(!*exception);
1602     auto destinationProtocol = adopt(JSValueToStringCopy(context, arguments[1], exception));
1603     ASSERT(!*exception);
1604     auto destinationHost = adopt(JSValueToStringCopy(context, arguments[2], exception));
1605     ASSERT(!*exception);
1606     bool allowDestinationSubdomains = JSValueToBoolean(context, arguments[3]);
1607 
1608     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1609     controller-&gt;removeOriginAccessWhitelistEntry(sourceOrigin.get(), destinationProtocol.get(), destinationHost.get(), allowDestinationSubdomains);
1610     return JSValueMakeUndefined(context);
1611 }
1612 
1613 static JSValueRef setScrollbarPolicyCallback(JSContextRef context, JSObjectRef, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1614 {
1615     if (argumentCount != 2)
1616         return JSValueMakeUndefined(context);
1617 
1618     auto orientation = adopt(JSValueToStringCopy(context, arguments[0], exception));
1619     ASSERT(!*exception);
1620     auto policy = adopt(JSValueToStringCopy(context, arguments[1], exception));
1621     ASSERT(!*exception);
1622 
1623     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1624     controller-&gt;setScrollbarPolicy(orientation.get(), policy.get());
1625     return JSValueMakeUndefined(context);
1626 }
1627 
1628 static JSValueRef addUserScriptCallback(JSContextRef context, JSObjectRef, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1629 {
1630     if (argumentCount != 3)
1631         return JSValueMakeUndefined(context);
1632 
1633     auto source = adopt(JSValueToStringCopy(context, arguments[0], exception));
1634     ASSERT(!*exception);
1635     bool runAtStart = JSValueToBoolean(context, arguments[1]);
1636     bool allFrames = JSValueToBoolean(context, arguments[2]);
1637 
1638     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1639     controller-&gt;addUserScript(source.get(), runAtStart, allFrames);
1640     return JSValueMakeUndefined(context);
1641 }
1642 
1643 static JSValueRef addUserStyleSheetCallback(JSContextRef context, JSObjectRef, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1644 {
1645     if (argumentCount != 2)
1646         return JSValueMakeUndefined(context);
1647 
1648     auto source = adopt(JSValueToStringCopy(context, arguments[0], exception));
1649     ASSERT(!*exception);
1650     bool allFrames = JSValueToBoolean(context, arguments[1]);
1651 
1652     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1653     controller-&gt;addUserStyleSheet(source.get(), allFrames);
1654     return JSValueMakeUndefined(context);
1655 }
1656 
1657 static JSValueRef setShouldPaintBrokenImageCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1658 {
1659     // Has Mac implementation
1660     if (argumentCount &lt; 1)
1661         return JSValueMakeUndefined(context);
1662 
1663     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1664     controller-&gt;setShouldPaintBrokenImage(JSValueToBoolean(context, arguments[0]));
1665 
1666     return JSValueMakeUndefined(context);
1667 }
1668 
1669 static JSValueRef apiTestNewWindowDataLoadBaseURLCallback(JSContextRef context, JSObjectRef, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1670 {
1671     if (argumentCount != 2)
1672         return JSValueMakeUndefined(context);
1673 
1674     auto utf8Data = adopt(JSValueToStringCopy(context, arguments[0], exception));
1675     ASSERT(!*exception);
1676 
1677     auto baseURL = adopt(JSValueToStringCopy(context, arguments[1], exception));
1678     ASSERT(!*exception);
1679 
1680     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1681     controller-&gt;apiTestNewWindowDataLoadBaseURL(utf8Data.get(), baseURL.get());
1682     return JSValueMakeUndefined(context);
1683 }
1684 
1685 static JSValueRef apiTestGoToCurrentBackForwardItemCallback(JSContextRef context, JSObjectRef, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1686 {
1687     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1688     controller-&gt;apiTestGoToCurrentBackForwardItem();
1689     return JSValueMakeUndefined(context);
1690 }
1691 
1692 static JSValueRef setWebViewEditableCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1693 {
1694     // Has Mac implementation
1695     if (argumentCount &lt; 1)
1696         return JSValueMakeUndefined(context);
1697 
1698     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1699     controller-&gt;setWebViewEditable(JSValueToBoolean(context, arguments[0]));
1700 
1701     return JSValueMakeUndefined(context);
1702 }
1703 
1704 static JSValueRef abortModalCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1705 {
1706     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1707     controller-&gt;abortModal();
1708     return JSValueMakeUndefined(context);
1709 }
1710 
1711 static JSValueRef authenticateSessionCallback(JSContextRef context, JSObjectRef, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1712 {
1713     // authenticateSession(url, username, password)
1714     if (argumentCount != 3)
1715         return JSValueMakeUndefined(context);
1716 
1717     auto url = adopt(JSValueToStringCopy(context, arguments[0], exception));
1718     ASSERT(!*exception);
1719     auto username = adopt(JSValueToStringCopy(context, arguments[1], exception));
1720     ASSERT(!*exception);
1721     auto password = adopt(JSValueToStringCopy(context, arguments[2], exception));
1722     ASSERT(!*exception);
1723 
1724     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1725     controller-&gt;authenticateSession(url.get(), username.get(), password.get());
1726     return JSValueMakeUndefined(context);
1727 }
1728 
1729 static JSValueRef setSerializeHTTPLoadsCallback(JSContextRef context, JSObjectRef, JSObjectRef, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1730 {
1731     bool serialize = true;
1732     if (argumentCount == 1)
1733         serialize = JSValueToBoolean(context, arguments[0]);
1734 
1735     TestRunner::setSerializeHTTPLoads(serialize);
1736     return JSValueMakeUndefined(context);
1737 }
1738 
1739 static JSValueRef setShouldStayOnPageAfterHandlingBeforeUnloadCallback(JSContextRef context, JSObjectRef, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1740 {
1741     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1742 
1743     if (argumentCount == 1)
1744         controller-&gt;setShouldStayOnPageAfterHandlingBeforeUnload(JSValueToBoolean(context, arguments[0]));
1745 
1746     return JSValueMakeUndefined(context);
1747 }
1748 
1749 static JSValueRef addChromeInputFieldCallback(JSContextRef context, JSObjectRef, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1750 {
1751     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1752     controller-&gt;addChromeInputField();
1753     // the first argument is a callback that is called once the input field has been added
1754     if (argumentCount == 1)
1755         JSObjectCallAsFunction(context, JSValueToObject(context, arguments[0], 0), thisObject, 0, 0, 0);
1756     return JSValueMakeUndefined(context);
1757 }
1758 
1759 static JSValueRef removeChromeInputFieldCallback(JSContextRef context, JSObjectRef, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1760 {
1761     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1762     controller-&gt;removeChromeInputField();
1763     // the first argument is a callback that is called once the input field has been added
1764     if (argumentCount == 1)
1765         JSObjectCallAsFunction(context, JSValueToObject(context, arguments[0], 0), thisObject, 0, 0, 0);
1766     return JSValueMakeUndefined(context);
1767 }
1768 
1769 static JSValueRef focusWebViewCallback(JSContextRef context, JSObjectRef, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1770 {
1771     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1772     controller-&gt;focusWebView();
1773     // the first argument is a callback that is called once the input field has been added
1774     if (argumentCount == 1)
1775         JSObjectCallAsFunction(context, JSValueToObject(context, arguments[0], 0), thisObject, 0, 0, 0);
1776     return JSValueMakeUndefined(context);
1777 }
1778 
1779 static JSValueRef setBackingScaleFactorCallback(JSContextRef context, JSObjectRef, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1780 {
1781     if (argumentCount != 2)
1782         return JSValueMakeUndefined(context);
1783 
1784     double backingScaleFactor = JSValueToNumber(context, arguments[0], exception);
1785     ASSERT(!*exception);
1786 
1787     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1788     controller-&gt;setBackingScaleFactor(backingScaleFactor);
1789 
1790     // The second argument is a callback that is called once the backing scale factor has been set.
1791     JSObjectCallAsFunction(context, JSValueToObject(context, arguments[1], 0), thisObject, 0, 0, 0);
1792     return JSValueMakeUndefined(context);
1793 }
1794 
1795 static JSValueRef preciseTimeCallback(JSContextRef context, JSObjectRef, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1796 {
1797     return JSValueMakeNumber(context, WallTime::now().secondsSinceEpoch().seconds());
1798 }
1799 
1800 static JSValueRef imageCountInGeneralPasteboardCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1801 {
1802     // Has mac &amp; windows implementation
1803     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1804 
1805     return JSValueMakeNumber(context, controller-&gt;imageCountInGeneralPasteboard());
1806 }
1807 
1808 static JSValueRef setSpellCheckerLoggingEnabledCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1809 {
1810     if (argumentCount &lt; 1)
1811         return JSValueMakeUndefined(context);
1812     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1813     controller-&gt;setSpellCheckerLoggingEnabled(JSValueToBoolean(context, arguments[0]));
1814     return JSValueMakeUndefined(context);
1815 }
1816 
1817 static JSValueRef setSpellCheckerResultsCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1818 {
1819     if (argumentCount &lt; 1)
1820         return JSValueMakeUndefined(context);
1821 
1822     auto* runner = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1823     runner-&gt;setSpellCheckerResults(context, JSValueToObject(context, arguments[0], nullptr));
1824     return JSValueMakeUndefined(context);
1825 }
1826 
1827 static JSValueRef setOpenPanelFilesCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1828 {
1829     if (argumentCount == 1)
1830         static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject))-&gt;setOpenPanelFiles(context, arguments[0]);
1831     return JSValueMakeUndefined(context);
1832 }
1833 
<a name="10" id="anc10"></a>








1834 // Static Values
1835 
1836 static JSValueRef getTimeoutCallback(JSContextRef context, JSObjectRef thisObject, JSStringRef propertyName, JSValueRef* exception)
1837 {
1838     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1839     return JSValueMakeNumber(context, controller-&gt;timeout());
1840 }
1841 
1842 static JSValueRef getGlobalFlagCallback(JSContextRef context, JSObjectRef thisObject, JSStringRef propertyName, JSValueRef* exception)
1843 {
1844     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1845     return JSValueMakeBoolean(context, controller-&gt;globalFlag());
1846 }
1847 
1848 static JSValueRef getDidCancelClientRedirect(JSContextRef context, JSObjectRef thisObject, JSStringRef propertyName, JSValueRef* exception)
1849 {
1850     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1851     return JSValueMakeBoolean(context, controller-&gt;didCancelClientRedirect());
1852 }
1853 
1854 static JSValueRef getDatabaseDefaultQuotaCallback(JSContextRef context, JSObjectRef thisObject, JSStringRef propertyName, JSValueRef* exception)
1855 {
1856     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1857     return JSValueMakeNumber(context, controller-&gt;databaseDefaultQuota());
1858 }
1859 
1860 static JSValueRef getDatabaseMaxQuotaCallback(JSContextRef context, JSObjectRef thisObject, JSStringRef propertyName, JSValueRef* exception)
1861 {
1862     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1863     return JSValueMakeNumber(context, controller-&gt;databaseMaxQuota());
1864 }
1865 
1866 static JSValueRef getWebHistoryItemCountCallback(JSContextRef context, JSObjectRef thisObject, JSStringRef propertyName, JSValueRef* exception)
1867 {
1868     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1869     return JSValueMakeNumber(context, controller-&gt;webHistoryItemCount());
1870 }
1871 
1872 static JSValueRef getSecureEventInputIsEnabledCallback(JSContextRef context, JSObjectRef thisObject, JSStringRef propertyName, JSValueRef* exception)
1873 {
1874 #if PLATFORM(MAC) &amp;&amp; !PLATFORM(IOS_FAMILY)
1875     return JSValueMakeBoolean(context, IsSecureEventInputEnabled());
1876 #else
1877     return JSValueMakeBoolean(context, false);
1878 #endif
1879 }
1880 
1881 static JSValueRef getTitleTextDirectionCallback(JSContextRef context, JSObjectRef thisObject, JSStringRef propertyName, JSValueRef* exception)
1882 {
1883     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1884     auto titleDirection = adopt(JSStringCreateWithUTF8CString(controller-&gt;titleTextDirection().c_str()));
1885     return JSValueMakeString(context, titleDirection.get());
1886 }
1887 
1888 static JSValueRef getInspectorTestStubURLCallback(JSContextRef context, JSObjectRef thisObject, JSStringRef propertyName, JSValueRef* exception)
1889 {
1890     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1891     auto url = controller-&gt;inspectorTestStubURL();
1892     return JSValueMakeString(context, url.get());
1893 }
1894 
1895 static bool setGlobalFlagCallback(JSContextRef context, JSObjectRef thisObject, JSStringRef propertyName, JSValueRef value, JSValueRef* exception)
1896 {
1897     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1898     controller-&gt;setGlobalFlag(JSValueToBoolean(context, value));
1899     return true;
1900 }
1901 
1902 static bool setDatabaseDefaultQuotaCallback(JSContextRef context, JSObjectRef thisObject, JSStringRef propertyName, JSValueRef value, JSValueRef* exception)
1903 {
1904     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1905     controller-&gt;setDatabaseDefaultQuota(JSValueToNumber(context, value, exception));
1906     ASSERT(!*exception);
1907     return true;
1908 }
1909 
1910 static bool setDatabaseMaxQuotaCallback(JSContextRef context, JSObjectRef thisObject, JSStringRef propertyName, JSValueRef value, JSValueRef* exception)
1911 {
1912     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1913     controller-&gt;setDatabaseMaxQuota(JSValueToNumber(context, value, exception));
1914     ASSERT(!*exception);
1915     return true;
1916 }
1917 
1918 static JSValueRef ignoreLegacyWebNotificationPermissionRequestsCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1919 {
1920     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1921     controller-&gt;ignoreLegacyWebNotificationPermissionRequests();
1922     return JSValueMakeUndefined(context);
1923 }
1924 
1925 static JSValueRef simulateLegacyWebNotificationClickCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1926 {
1927     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1928     auto title = adopt(JSValueToStringCopy(context, arguments[0], exception));
1929     controller-&gt;simulateLegacyWebNotificationClick(title.get());
1930     return JSValueMakeUndefined(context);
1931 }
1932 
1933 static JSValueRef setTextDirectionCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1934 {
1935     if (argumentCount == 1) {
1936         auto direction = adopt(JSValueToStringCopy(context, arguments[0], exception));
1937         TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1938         controller-&gt;setTextDirection(direction.get());
1939     }
1940 
1941     return JSValueMakeUndefined(context);
1942 
1943 }
1944 
1945 static JSValueRef setHasCustomFullScreenBehaviorCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1946 {
1947     if (argumentCount == 1) {
1948         bool hasCustomBehavior = JSValueToBoolean(context, arguments[0]);
1949         TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1950         controller-&gt;setHasCustomFullScreenBehavior(hasCustomBehavior);
1951     }
1952 
1953     return JSValueMakeUndefined(context);
1954 }
1955 
1956 static JSValueRef setStorageDatabaseIdleIntervalCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1957 {
1958     if (argumentCount != 1)
1959         return JSValueMakeUndefined(context);
1960 
1961     double interval = JSValueToNumber(context, arguments[0], exception);
1962     ASSERT(!*exception);
1963 
1964     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1965     controller-&gt;setStorageDatabaseIdleInterval(interval);
1966 
1967     return JSValueMakeUndefined(context);
1968 }
1969 
1970 static JSValueRef closeIdleLocalStorageDatabasesCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1971 {
1972     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1973     controller-&gt;closeIdleLocalStorageDatabases();
1974 
1975     return JSValueMakeUndefined(context);
1976 }
1977 
1978 static JSValueRef grantWebNotificationPermissionCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1979 {
1980     if (argumentCount &lt; 1)
1981         return JSValueMakeUndefined(context);
1982 
1983     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1984 
1985     auto origin = adopt(JSValueToStringCopy(context, arguments[0], exception));
1986     ASSERT(!*exception);
1987     controller-&gt;grantWebNotificationPermission(origin.get());
1988 
1989     return JSValueMakeUndefined(context);
1990 }
1991 
1992 
1993 static JSValueRef denyWebNotificationPermissionCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
1994 {
1995     if (argumentCount &lt; 1)
1996         return JSValueMakeUndefined(context);
1997 
1998     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
1999 
2000     auto origin = adopt(JSValueToStringCopy(context, arguments[0], exception));
2001     ASSERT(!*exception);
2002     controller-&gt;denyWebNotificationPermission(origin.get());
2003 
2004     return JSValueMakeUndefined(context);
2005 }
2006 
2007 
2008 static JSValueRef removeAllWebNotificationPermissionsCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
2009 {
2010     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
2011 
2012     controller-&gt;removeAllWebNotificationPermissions();
2013 
2014     return JSValueMakeUndefined(context);
2015 }
2016 
2017 
2018 static JSValueRef simulateWebNotificationClickCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
2019 {
2020     // Has Windows implementation
2021     if (argumentCount &lt; 1)
2022         return JSValueMakeUndefined(context);
2023 
2024     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
2025 
2026     controller-&gt;simulateWebNotificationClick(arguments[0]);
2027 
2028     return JSValueMakeUndefined(context);
2029 }
2030 
2031 static JSValueRef forceImmediateCompletionCallback(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
2032 {
2033     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
2034     controller-&gt;forceImmediateCompletion();
2035     return JSValueMakeUndefined(context);
2036 }
2037 
2038 static JSValueRef failNextNewCodeBlock(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
2039 {
2040     if (argumentCount &lt; 1)
2041         return JSValueMakeUndefined(context);
2042 
2043     return JSC::failNextNewCodeBlock(context);
2044 }
2045 
2046 static JSValueRef numberOfDFGCompiles(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
2047 {
2048     return JSC::numberOfDFGCompiles(context, arguments[0]);
2049 }
2050 
2051 static JSValueRef neverInlineFunction(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
2052 {
2053     if (argumentCount &lt; 1)
2054         return JSValueMakeUndefined(context);
2055 
2056     return JSC::setNeverInline(context, arguments[0]);
2057 }
2058 
2059 static JSValueRef accummulateLogsForChannel(JSContextRef context, JSObjectRef function, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
2060 {
2061     if (argumentCount &lt; 1)
2062         return JSValueMakeUndefined(context);
2063 
2064     auto channel = adopt(JSValueToStringCopy(context, arguments[0], exception));
2065     ASSERT(!*exception);
2066 
2067     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
<a name="11" id="anc11"></a>



2068     controller-&gt;setAccummulateLogsForChannel(channel.get());
<a name="12" id="anc12"></a><span class="line-modified">2069 </span>
2070     return JSValueMakeUndefined(context);
2071 }
2072 
2073 static JSValueRef runUIScriptCallback(JSContextRef context, JSObjectRef, JSObjectRef thisObject, size_t argumentCount, const JSValueRef arguments[], JSValueRef* exception)
2074 {
2075     if (argumentCount &lt; 1)
2076         return JSValueMakeUndefined(context);
2077 
2078     auto script = argumentCount &gt; 0 ? adopt(JSValueToStringCopy(context, arguments[0], 0)) : JSRetainPtr&lt;JSStringRef&gt;();
2079     JSValueRef callback = argumentCount &gt; 1 ? arguments[1] : JSValueMakeUndefined(context);
2080 
2081     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(thisObject));
2082     controller-&gt;runUIScript(context, script.get(), callback);
2083 
2084     return JSValueMakeUndefined(context);
2085 }
2086 
2087 static void testRunnerObjectFinalize(JSObjectRef object)
2088 {
2089     TestRunner* controller = static_cast&lt;TestRunner*&gt;(JSObjectGetPrivate(object));
2090     controller-&gt;deref();
2091 }
2092 
2093 // Object Creation
2094 
2095 void TestRunner::makeWindowObject(JSContextRef context, JSObjectRef windowObject, JSValueRef* exception)
2096 {
2097     auto testRunnerStr = adopt(JSStringCreateWithUTF8CString(&quot;testRunner&quot;));
2098     ref();
2099 
2100     JSClassRef classRef = getJSClass();
2101     JSValueRef layoutTestContollerObject = JSObjectMake(context, classRef, this);
2102     JSClassRelease(classRef);
2103 
2104     JSObjectSetProperty(context, windowObject, testRunnerStr.get(), layoutTestContollerObject, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete, exception);
2105 }
2106 
2107 JSClassRef TestRunner::getJSClass()
2108 {
2109     static JSStaticValue* staticValues = TestRunner::staticValues();
2110     static JSStaticFunction* staticFunctions = TestRunner::staticFunctions();
2111     static JSClassDefinition classDefinition = {
2112         0, kJSClassAttributeNone, &quot;TestRunner&quot;, 0, staticValues, staticFunctions,
2113         0, testRunnerObjectFinalize, 0, 0, 0, 0, 0, 0, 0, 0, 0
2114     };
2115 
2116     return JSClassCreate(&amp;classDefinition);
2117 }
2118 
<a name="13" id="anc13"></a>































2119 JSStaticValue* TestRunner::staticValues()
2120 {
2121     static JSStaticValue staticValues[] = {
2122         { &quot;didCancelClientRedirect&quot;, getDidCancelClientRedirect, 0, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2123         { &quot;timeout&quot;, getTimeoutCallback, 0, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2124         { &quot;globalFlag&quot;, getGlobalFlagCallback, setGlobalFlagCallback, kJSPropertyAttributeNone },
2125         { &quot;webHistoryItemCount&quot;, getWebHistoryItemCountCallback, 0, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2126         { &quot;secureEventInputIsEnabled&quot;, getSecureEventInputIsEnabledCallback, 0, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2127         { &quot;titleTextDirection&quot;, getTitleTextDirectionCallback, 0, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2128         { &quot;databaseDefaultQuota&quot;, getDatabaseDefaultQuotaCallback, setDatabaseDefaultQuotaCallback, kJSPropertyAttributeNone },
2129         { &quot;databaseMaxQuota&quot;, getDatabaseMaxQuotaCallback, setDatabaseMaxQuotaCallback, kJSPropertyAttributeNone },
2130         { &quot;inspectorTestStubURL&quot;, getInspectorTestStubURLCallback, 0, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
<a name="14" id="anc14"></a>





2131         { 0, 0, 0, 0 }
2132     };
2133     return staticValues;
2134 }
2135 
2136 JSStaticFunction* TestRunner::staticFunctions()
2137 {
2138     static JSStaticFunction staticFunctions[] = {
2139         { &quot;abortModal&quot;, abortModalCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2140         { &quot;addDisallowedURL&quot;, addDisallowedURLCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2141         { &quot;addURLToRedirect&quot;, addURLToRedirectCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2142         { &quot;addUserScript&quot;, addUserScriptCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2143         { &quot;addUserStyleSheet&quot;, addUserStyleSheetCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2144         { &quot;apiTestNewWindowDataLoadBaseURL&quot;, apiTestNewWindowDataLoadBaseURLCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2145         { &quot;apiTestGoToCurrentBackForwardItem&quot;, apiTestGoToCurrentBackForwardItemCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2146         { &quot;applicationCacheDiskUsageForOrigin&quot;, applicationCacheDiskUsageForOriginCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2147         { &quot;callShouldCloseOnWebView&quot;, callShouldCloseOnWebViewCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2148         { &quot;clearAllApplicationCaches&quot;, clearAllApplicationCachesCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2149         { &quot;clearAllDatabases&quot;, clearAllDatabasesCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2150         { &quot;clearApplicationCacheForOrigin&quot;, clearApplicationCacheForOriginCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2151         { &quot;clearBackForwardList&quot;, clearBackForwardListCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2152         { &quot;clearPersistentUserStyleSheet&quot;, clearPersistentUserStyleSheetCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2153         { &quot;closeWebInspector&quot;, closeWebInspectorCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2154         { &quot;decodeHostName&quot;, decodeHostNameCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2155         { &quot;disallowIncreaseForApplicationCacheQuota&quot;, disallowIncreaseForApplicationCacheQuotaCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2156         { &quot;dispatchPendingLoadRequests&quot;, dispatchPendingLoadRequestsCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2157         { &quot;display&quot;, displayCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2158         { &quot;displayAndTrackRepaints&quot;, displayAndTrackRepaintsCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2159         { &quot;dumpApplicationCacheDelegateCallbacks&quot;, dumpApplicationCacheDelegateCallbacksCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
<a name="15" id="anc15"></a>
2160         { &quot;dumpAsText&quot;, dumpAsTextCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2161         { &quot;dumpBackForwardList&quot;, dumpBackForwardListCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2162         { &quot;dumpChildFrameScrollPositions&quot;, dumpChildFrameScrollPositionsCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2163         { &quot;dumpChildFramesAsText&quot;, dumpChildFramesAsTextCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2164         { &quot;dumpDOMAsWebArchive&quot;, dumpDOMAsWebArchiveCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2165         { &quot;dumpDatabaseCallbacks&quot;, dumpDatabaseCallbacksCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2166         { &quot;dumpEditingCallbacks&quot;, dumpEditingCallbacksCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2167         { &quot;dumpFrameLoadCallbacks&quot;, dumpFrameLoadCallbacksCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2168         { &quot;dumpProgressFinishedCallback&quot;, dumpProgressFinishedCallbackCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2169         { &quot;dumpUserGestureInFrameLoadCallbacks&quot;, dumpUserGestureInFrameLoadCallbacksCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2170         { &quot;dumpResourceLoadCallbacks&quot;, dumpResourceLoadCallbacksCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2171         { &quot;dumpResourceResponseMIMETypes&quot;, dumpResourceResponseMIMETypesCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2172         { &quot;dumpSelectionRect&quot;, dumpSelectionRectCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2173         { &quot;dumpSourceAsWebArchive&quot;, dumpSourceAsWebArchiveCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2174         { &quot;dumpStatusCallbacks&quot;, dumpStatusCallbacksCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2175         { &quot;dumpTitleChanges&quot;, dumpTitleChangesCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2176         { &quot;dumpWillCacheResponse&quot;, dumpWillCacheResponseCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2177         { &quot;encodeHostName&quot;, encodeHostNameCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2178         { &quot;evaluateInWebInspector&quot;, evaluateInWebInspectorCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2179         { &quot;evaluateScriptInIsolatedWorldAndReturnValue&quot;, evaluateScriptInIsolatedWorldAndReturnValueCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2180         { &quot;evaluateScriptInIsolatedWorld&quot;, evaluateScriptInIsolatedWorldCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2181         { &quot;execCommand&quot;, execCommandCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2182         { &quot;findString&quot;, findStringCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2183         { &quot;originsWithApplicationCache&quot;, originsWithApplicationCacheCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2184         { &quot;goBack&quot;, goBackCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2185         { &quot;ignoreLegacyWebNotificationPermissionRequests&quot;, ignoreLegacyWebNotificationPermissionRequestsCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2186         { &quot;isGeolocationProviderActive&quot;, isGeolocationProviderActiveCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2187         { &quot;isCommandEnabled&quot;, isCommandEnabledCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2188         { &quot;keepWebHistory&quot;, keepWebHistoryCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2189         { &quot;numberOfPendingGeolocationPermissionRequests&quot;, numberOfPendingGeolocationPermissionRequestsCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2190         { &quot;notifyDone&quot;, notifyDoneCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2191         { &quot;overridePreference&quot;, overridePreferenceCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2192         { &quot;pathToLocalResource&quot;, pathToLocalResourceCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2193         { &quot;printToPDF&quot;, dumpAsPDFCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2194         { &quot;queueBackNavigation&quot;, queueBackNavigationCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2195         { &quot;queueForwardNavigation&quot;, queueForwardNavigationCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2196         { &quot;queueLoad&quot;, queueLoadCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2197         { &quot;queueLoadHTMLString&quot;, queueLoadHTMLStringCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2198         { &quot;queueLoadingScript&quot;, queueLoadingScriptCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2199         { &quot;queueNonLoadingScript&quot;, queueNonLoadingScriptCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2200         { &quot;queueReload&quot;, queueReloadCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2201         { &quot;removeAllVisitedLinks&quot;, removeAllVisitedLinksCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2202         { &quot;removeOriginAccessWhitelistEntry&quot;, removeOriginAccessWhitelistEntryCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2203         { &quot;repaintSweepHorizontally&quot;, repaintSweepHorizontallyCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2204         { &quot;resetPageVisibility&quot;, resetPageVisibilityCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2205         { &quot;setAcceptsEditing&quot;, setAcceptsEditingCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2206         { &quot;setAllowUniversalAccessFromFileURLs&quot;, setAllowUniversalAccessFromFileURLsCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2207         { &quot;setAllowFileAccessFromFileURLs&quot;, setAllowFileAccessFromFileURLsCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2208         { &quot;setNeedsStorageAccessFromFileURLsQuirk&quot;, setNeedsStorageAccessFromFileURLsQuirkCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2209         { &quot;setAllowsAnySSLCertificate&quot;, setAllowsAnySSLCertificateCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2210         { &quot;setAlwaysAcceptCookies&quot;, setAlwaysAcceptCookiesCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2211         { &quot;setOnlyAcceptFirstPartyCookies&quot;, setOnlyAcceptFirstPartyCookiesCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2212         { &quot;setAppCacheMaximumSize&quot;, setAppCacheMaximumSizeCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2213         { &quot;setAudioResult&quot;, setAudioResultCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2214         { &quot;setAuthenticationPassword&quot;, setAuthenticationPasswordCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2215         { &quot;setAuthenticationUsername&quot;, setAuthenticationUsernameCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2216         { &quot;setAuthorAndUserStylesEnabled&quot;, setAuthorAndUserStylesEnabledCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2217         { &quot;setCacheModel&quot;, setCacheModelCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2218         { &quot;setCallCloseOnWebViews&quot;, setCallCloseOnWebViewsCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2219         { &quot;setCanOpenWindows&quot;, setCanOpenWindowsCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2220         { &quot;setCloseRemainingWindowsWhenComplete&quot;, setCloseRemainingWindowsWhenCompleteCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2221         { &quot;setCustomPolicyDelegate&quot;, setCustomPolicyDelegateCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2222         { &quot;setDatabaseQuota&quot;, setDatabaseQuotaCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2223         { &quot;setDefersLoading&quot;, setDefersLoadingCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2224         { &quot;setUseDeferredFrameLoading&quot;, setUseDeferredFrameLoadingCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2225         { &quot;setDomainRelaxationForbiddenForURLScheme&quot;, setDomainRelaxationForbiddenForURLSchemeCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2226         { &quot;setGeolocationPermission&quot;, setGeolocationPermissionCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2227         { &quot;setRejectsProtectionSpaceAndContinueForAuthenticationChallenges&quot;, setRejectsProtectionSpaceAndContinueForAuthenticationChallengesCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2228         { &quot;setHandlesAuthenticationChallenges&quot;, setHandlesAuthenticationChallengesCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2229         { &quot;setIconDatabaseEnabled&quot;, setIconDatabaseEnabledCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
<a name="16" id="anc16"></a><span class="line-removed">2230         { &quot;setIDBPerOriginQuota&quot;, setIDBPerOriginQuotaCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },</span>
2231         { &quot;setAutomaticLinkDetectionEnabled&quot;, setAutomaticLinkDetectionEnabledCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2232         { &quot;setMainFrameIsFirstResponder&quot;, setMainFrameIsFirstResponderCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2233         { &quot;setMockDeviceOrientation&quot;, setMockDeviceOrientationCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2234         { &quot;setMockGeolocationPositionUnavailableError&quot;, setMockGeolocationPositionUnavailableErrorCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2235         { &quot;setMockGeolocationPosition&quot;, setMockGeolocationPositionCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2236         { &quot;setNewWindowsCopyBackForwardList&quot;, setNewWindowsCopyBackForwardListCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2237         { &quot;setPageVisibility&quot;, setPageVisibilityCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2238         { &quot;setPOSIXLocale&quot;, setPOSIXLocaleCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2239         { &quot;setPersistentUserStyleSheetLocation&quot;, setPersistentUserStyleSheetLocationCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2240         { &quot;setPopupBlockingEnabled&quot;, setPopupBlockingEnabledCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2241         { &quot;setPluginsEnabled&quot;, setPluginsEnabledCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2242         { &quot;setPrinting&quot;, setPrintingCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2243         { &quot;setPrivateBrowsingEnabled&quot;, setPrivateBrowsingEnabledCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2244         { &quot;setSerializeHTTPLoads&quot;, setSerializeHTTPLoadsCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2245         { &quot;setSpatialNavigationEnabled&quot;, setSpatialNavigationEnabledCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2246         { &quot;setStopProvisionalFrameLoads&quot;, setStopProvisionalFrameLoadsCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2247         { &quot;setTabKeyCyclesThroughElements&quot;, setTabKeyCyclesThroughElementsCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2248 #if PLATFORM(IOS_FAMILY)
2249         { &quot;setTelephoneNumberParsingEnabled&quot;, setTelephoneNumberParsingEnabledCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2250         { &quot;setPagePaused&quot;, setPagePausedCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2251 #endif
<a name="17" id="anc17"></a><span class="line-removed">2252         { &quot;setUseDashboardCompatibilityMode&quot;, setUseDashboardCompatibilityModeCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },</span>
2253         { &quot;setUserStyleSheetEnabled&quot;, setUserStyleSheetEnabledCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2254         { &quot;setUserStyleSheetLocation&quot;, setUserStyleSheetLocationCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2255         { &quot;setValueForUser&quot;, setValueForUserCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2256         { &quot;setWebViewEditable&quot;, setWebViewEditableCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2257         { &quot;setWillSendRequestClearHeader&quot;, setWillSendRequestClearHeaderCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2258         { &quot;setWillSendRequestReturnsNull&quot;, setWillSendRequestReturnsNullCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2259         { &quot;setWillSendRequestReturnsNullOnRedirect&quot;, setWillSendRequestReturnsNullOnRedirectCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2260         { &quot;setWindowIsKey&quot;, setWindowIsKeyCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2261         { &quot;setViewSize&quot;, setViewSizeCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2262         { &quot;setJavaScriptCanAccessClipboard&quot;, setJavaScriptCanAccessClipboardCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2263         { &quot;setXSSAuditorEnabled&quot;, setXSSAuditorEnabledCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2264         { &quot;showWebInspector&quot;, showWebInspectorCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2265         { &quot;simulateLegacyWebNotificationClick&quot;, simulateLegacyWebNotificationClickCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2266         { &quot;testOnscreen&quot;, testOnscreenCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2267         { &quot;testRepaint&quot;, testRepaintCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2268         { &quot;waitForPolicyDelegate&quot;, waitForPolicyDelegateCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2269         { &quot;waitUntilDone&quot;, waitUntilDoneCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2270         { &quot;windowCount&quot;, windowCountCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2271         { &quot;addOriginAccessWhitelistEntry&quot;, addOriginAccessWhitelistEntryCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2272         { &quot;setScrollbarPolicy&quot;, setScrollbarPolicyCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2273         { &quot;authenticateSession&quot;, authenticateSessionCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2274         { &quot;setShouldPaintBrokenImage&quot;, setShouldPaintBrokenImageCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2275         { &quot;setTextDirection&quot;, setTextDirectionCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2276         { &quot;setShouldStayOnPageAfterHandlingBeforeUnload&quot;, setShouldStayOnPageAfterHandlingBeforeUnloadCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2277         { &quot;addChromeInputField&quot;, addChromeInputFieldCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2278         { &quot;removeChromeInputField&quot;, removeChromeInputFieldCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2279         { &quot;focusWebView&quot;, focusWebViewCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2280         { &quot;setBackingScaleFactor&quot;, setBackingScaleFactorCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2281         { &quot;preciseTime&quot;, preciseTimeCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2282         { &quot;setHasCustomFullScreenBehavior&quot;, setHasCustomFullScreenBehaviorCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2283         { &quot;setStorageDatabaseIdleInterval&quot;, setStorageDatabaseIdleIntervalCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2284         { &quot;closeIdleLocalStorageDatabases&quot;, closeIdleLocalStorageDatabasesCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2285         { &quot;grantWebNotificationPermission&quot;, grantWebNotificationPermissionCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2286         { &quot;denyWebNotificationPermission&quot;, denyWebNotificationPermissionCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2287         { &quot;removeAllWebNotificationPermissions&quot;, removeAllWebNotificationPermissionsCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2288         { &quot;simulateWebNotificationClick&quot;, simulateWebNotificationClickCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2289         { &quot;failNextNewCodeBlock&quot;, failNextNewCodeBlock, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2290         { &quot;numberOfDFGCompiles&quot;, numberOfDFGCompiles, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2291         { &quot;neverInlineFunction&quot;, neverInlineFunction, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2292         { &quot;accummulateLogsForChannel&quot;, accummulateLogsForChannel, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2293         { &quot;runUIScript&quot;, runUIScriptCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2294         { &quot;imageCountInGeneralPasteboard&quot;, imageCountInGeneralPasteboardCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2295         { &quot;setSpellCheckerLoggingEnabled&quot;, setSpellCheckerLoggingEnabledCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2296         { &quot;setSpellCheckerResults&quot;, setSpellCheckerResultsCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2297         { &quot;setOpenPanelFiles&quot;, setOpenPanelFilesCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
<a name="18" id="anc18"></a>


2298         { &quot;forceImmediateCompletion&quot;, forceImmediateCompletionCallback, kJSPropertyAttributeReadOnly | kJSPropertyAttributeDontDelete },
2299         { 0, 0, 0 }
2300     };
2301 
2302     return staticFunctions;
2303 }
2304 
2305 void TestRunner::queueLoadHTMLString(JSStringRef content, JSStringRef baseURL)
2306 {
2307     DRT::WorkQueue::singleton().queue(new LoadHTMLStringItem(content, baseURL));
2308 }
2309 
2310 void TestRunner::queueLoadAlternateHTMLString(JSStringRef content, JSStringRef baseURL, JSStringRef unreachableURL)
2311 {
2312     DRT::WorkQueue::singleton().queue(new LoadHTMLStringItem(content, baseURL, unreachableURL));
2313 }
2314 
2315 void TestRunner::queueBackNavigation(int howFarBack)
2316 {
2317     DRT::WorkQueue::singleton().queue(new BackItem(howFarBack));
2318 }
2319 
2320 void TestRunner::queueForwardNavigation(int howFarForward)
2321 {
2322     DRT::WorkQueue::singleton().queue(new ForwardItem(howFarForward));
2323 }
2324 
2325 void TestRunner::queueLoadingScript(JSStringRef script)
2326 {
2327     DRT::WorkQueue::singleton().queue(new LoadingScriptItem(script));
2328 }
2329 
2330 void TestRunner::queueNonLoadingScript(JSStringRef script)
2331 {
2332     DRT::WorkQueue::singleton().queue(new NonLoadingScriptItem(script));
2333 }
2334 
2335 void TestRunner::queueReload()
2336 {
2337     DRT::WorkQueue::singleton().queue(new ReloadItem);
2338 }
2339 
2340 void TestRunner::ignoreLegacyWebNotificationPermissionRequests()
2341 {
2342     m_areLegacyWebNotificationPermissionRequestsIgnored = false;
2343 }
2344 
2345 void TestRunner::waitToDumpWatchdogTimerFired()
2346 {
2347     const char* message = &quot;FAIL: Timed out waiting for notifyDone to be called\n&quot;;
2348     fprintf(testResult, &quot;%s&quot;, message);
2349 
2350     auto accumulatedLogs = getAndResetAccumulatedLogs();
2351     if (!accumulatedLogs.isEmpty()) {
2352         const char* message = &quot;Logs accumulated during test run:\n&quot;;
2353         fprintf(testResult, &quot;%s%s\n&quot;, message, accumulatedLogs.utf8().data());
2354     }
2355 
2356     notifyDone();
2357 }
2358 
2359 void TestRunner::setGeolocationPermissionCommon(bool allow)
2360 {
2361     m_isGeolocationPermissionSet = true;
2362     m_geolocationPermission = allow;
2363 }
2364 
2365 void TestRunner::setPOSIXLocale(JSStringRef locale)
2366 {
2367     char localeBuf[32];
2368     JSStringGetUTF8CString(locale, localeBuf, sizeof(localeBuf));
2369     setlocale(LC_ALL, localeBuf);
2370 }
2371 
2372 void TestRunner::addURLToRedirect(std::string origin, std::string destination)
2373 {
2374     m_URLsToRedirect[origin] = destination;
2375 }
2376 
2377 const char* TestRunner::redirectionDestinationForURL(const char* origin)
2378 {
2379     if (!origin)
2380         return nullptr;
2381 
2382     auto iterator = m_URLsToRedirect.find(origin);
2383     if (iterator == m_URLsToRedirect.end())
2384         return nullptr;
2385 
2386     return iterator-&gt;second.data();
2387 }
2388 
<a name="19" id="anc19"></a>




2389 void TestRunner::setShouldPaintBrokenImage(bool shouldPaintBrokenImage)
2390 {
2391     m_shouldPaintBrokenImage = shouldPaintBrokenImage;
2392 }
2393 
2394 void TestRunner::setAccummulateLogsForChannel(JSStringRef channel)
2395 {
2396     size_t maxLength = JSStringGetMaximumUTF8CStringSize(channel);
<a name="20" id="anc20"></a><span class="line-modified">2397     auto buffer = std::make_unique&lt;char[]&gt;(maxLength + 1);</span>
2398     JSStringGetUTF8CString(channel, buffer.get(), maxLength + 1);
2399 
<a name="21" id="anc21"></a>



2400     WebCoreTestSupport::setLogChannelToAccumulate({ buffer.get() });
<a name="22" id="anc22"></a>
2401 }
2402 
2403 typedef WTF::HashMap&lt;unsigned, JSValueRef&gt; CallbackMap;
2404 static CallbackMap&amp; callbackMap()
2405 {
2406     static CallbackMap&amp; map = *new CallbackMap;
2407     return map;
2408 }
2409 
2410 void TestRunner::cacheTestRunnerCallback(unsigned index, JSValueRef callback)
2411 {
2412     if (!callback)
2413         return;
2414 
2415     if (callbackMap().contains(index)) {
2416         fprintf(stderr, &quot;FAIL: Tried to install a second TestRunner callback for the same event (id %d)\n&quot;, index);
2417         return;
2418     }
2419 
2420     JSContextRef context = mainFrameJSContext();
2421     JSValueProtect(context, callback);
2422     callbackMap().add(index, callback);
2423 }
2424 
2425 void TestRunner::callTestRunnerCallback(unsigned index, size_t argumentCount, const JSValueRef arguments[])
2426 {
2427     if (!callbackMap().contains(index))
2428         return;
2429 
2430     JSContextRef context = mainFrameJSContext();
2431     if (JSObjectRef callback = JSValueToObject(context, callbackMap().take(index), 0)) {
2432         JSObjectCallAsFunction(context, callback, JSContextGetGlobalObject(context), argumentCount, arguments, 0);
2433         JSValueUnprotect(context, callback);
2434     }
2435 }
2436 
2437 void TestRunner::clearTestRunnerCallbacks()
2438 {
2439     JSContextRef context = mainFrameJSContext();
2440 
2441     for (auto&amp; iter : callbackMap()) {
2442         if (JSObjectRef callback = JSValueToObject(context, iter.value, 0))
2443             JSValueUnprotect(context, callback);
2444     }
2445 
2446     callbackMap().clear();
2447 }
2448 
2449 enum {
2450     FirstUIScriptCallbackID = 100
2451 };
2452 
2453 static unsigned nextUIScriptCallbackID()
2454 {
2455     static unsigned callbackID = FirstUIScriptCallbackID;
2456     return callbackID++;
2457 }
2458 
2459 void TestRunner::runUIScript(JSContextRef context, JSStringRef script, JSValueRef callback)
2460 {
2461     m_pendingUIScriptInvocationData = nullptr;
2462 
2463     unsigned callbackID = nextUIScriptCallbackID();
2464     cacheTestRunnerCallback(callbackID, callback);
2465 
2466     if (!m_UIScriptContext)
<a name="23" id="anc23"></a><span class="line-modified">2467         m_UIScriptContext = std::make_unique&lt;WTR::UIScriptContext&gt;(*this);</span>
2468 
2469     String scriptString(JSStringGetCharactersPtr(script), JSStringGetLength(script));
2470     m_UIScriptContext-&gt;runUIScript(scriptString, callbackID);
2471 }
2472 
2473 void TestRunner::callUIScriptCallback(unsigned callbackID, JSStringRef result)
2474 {
2475     JSRetainPtr&lt;JSStringRef&gt; protectedResult(result);
2476 #if !PLATFORM(IOS_FAMILY)
2477     RunLoop::main().dispatch([protectedThis = makeRef(*this), callbackID, protectedResult]() mutable {
2478         JSContextRef context = protectedThis-&gt;mainFrameJSContext();
2479         JSValueRef resultValue = JSValueMakeString(context, protectedResult.get());
2480         protectedThis-&gt;callTestRunnerCallback(callbackID, 1, &amp;resultValue);
2481     });
2482 #else
2483     WebThreadRun(
2484         makeBlockPtr([protectedThis = makeRef(*this), callbackID, protectedResult] {
2485             JSContextRef context = protectedThis-&gt;mainFrameJSContext();
2486             JSValueRef resultValue = JSValueMakeString(context, protectedResult.get());
2487             protectedThis-&gt;callTestRunnerCallback(callbackID, 1, &amp;resultValue);
2488         }).get()
2489     );
2490 #endif
2491 }
2492 
2493 void TestRunner::uiScriptDidComplete(const String&amp; result, unsigned callbackID)
2494 {
2495     auto stringRef = adopt(JSStringCreateWithUTF8CString(result.utf8().data()));
2496     callUIScriptCallback(callbackID, stringRef.get());
2497 }
2498 
2499 void TestRunner::setAllowsAnySSLCertificate(bool allowsAnySSLCertificate)
2500 {
<a name="24" id="anc24"></a>



2501     WebCoreTestSupport::setAllowsAnySSLCertificate(allowsAnySSLCertificate);
<a name="25" id="anc25"></a>
2502 }
2503 
2504 void TestRunner::setOpenPanelFiles(JSContextRef context, JSValueRef filesValue)
2505 {
2506     if (!JSValueIsArray(context, filesValue))
2507         return;
2508 
2509     JSObjectRef files = JSValueToObject(context, filesValue, nullptr);
2510     static auto lengthProperty = adopt(JSStringCreateWithUTF8CString(&quot;length&quot;));
2511     JSValueRef filesLengthValue = JSObjectGetProperty(context, files, lengthProperty.get(), nullptr);
2512     if (!JSValueIsNumber(context, filesLengthValue))
2513         return;
2514 
2515     m_openPanelFiles.clear();
2516     auto filesLength = static_cast&lt;size_t&gt;(JSValueToNumber(context, filesLengthValue, nullptr));
2517     for (size_t i = 0; i &lt; filesLength; ++i) {
2518         JSValueRef fileValue = JSObjectGetPropertyAtIndex(context, files, i, nullptr);
2519         if (!JSValueIsString(context, fileValue))
2520             continue;
2521 
2522         auto file = adopt(JSValueToStringCopy(context, fileValue, nullptr));
2523         size_t fileBufferSize = JSStringGetMaximumUTF8CStringSize(file.get()) + 1;
<a name="26" id="anc26"></a><span class="line-modified">2524         auto fileBuffer = std::make_unique&lt;char[]&gt;(fileBufferSize);</span>
2525         JSStringGetUTF8CString(file.get(), fileBuffer.get(), fileBufferSize);
2526 
2527         m_openPanelFiles.push_back(fileBuffer.get());
2528     }
2529 }
2530 
<a name="27" id="anc27"></a>
















2531 void TestRunner::cleanup()
2532 {
2533     clearTestRunnerCallbacks();
2534 }
<a name="28" id="anc28"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="28" type="hidden" />
</body>
</html>