<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff modules/javafx.web/src/main/native/Source/WebCore/accessibility/atk/WebKitAccessible.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="AccessibilityObjectAtk.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="WebKitAccessible.h.sdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/accessibility/atk/WebKitAccessible.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  15  *
  16  * This library is free software; you can redistribute it and/or
  17  * modify it under the terms of the GNU Library General Public
  18  * License as published by the Free Software Foundation; either
  19  * version 2 of the License, or (at your option) any later version.
  20  *
  21  * This library is distributed in the hope that it will be useful,
  22  * but WITHOUT ANY WARRANTY; without even the implied warranty of
  23  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
  24  * Library General Public License for more details.
  25  *
  26  * You should have received a copy of the GNU Library General Public License
  27  * along with this library; see the file COPYING.LIB.  If not, write to
  28  * the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor,
  29  * Boston, MA 02110-1301, USA.
  30  */
  31 
  32 #include &quot;config.h&quot;
  33 #include &quot;WebKitAccessible.h&quot;
  34 
<span class="line-modified">  35 #if HAVE(ACCESSIBILITY)</span>
  36 
  37 #include &quot;AXObjectCache.h&quot;
  38 #include &quot;AccessibilityList.h&quot;
  39 #include &quot;AccessibilityListBoxOption.h&quot;
  40 #include &quot;AccessibilityTable.h&quot;
  41 #include &quot;AccessibilityTableCell.h&quot;
  42 #include &quot;AccessibilityTableRow.h&quot;
  43 #include &quot;Document.h&quot;
  44 #include &quot;Editing.h&quot;
  45 #include &quot;Frame.h&quot;
  46 #include &quot;FrameView.h&quot;
  47 #include &quot;HTMLNames.h&quot;
  48 #include &quot;HTMLTableElement.h&quot;
  49 #include &quot;HostWindow.h&quot;
  50 #include &quot;RenderAncestorIterator.h&quot;
  51 #include &quot;RenderBlock.h&quot;
  52 #include &quot;RenderObject.h&quot;
  53 #include &quot;SVGElement.h&quot;
  54 #include &quot;Settings.h&quot;
  55 #include &quot;TextIterator.h&quot;
</pre>
<hr />
<pre>
 377             if (child.get() == object)
 378                 return i;
 379         }
 380     }
 381 
 382     if (!parent)
 383         return -1;
 384 
 385     size_t index = parent-&gt;children().find(coreObject);
 386     return (index == WTF::notFound) ? -1 : index;
 387 }
 388 
 389 static AtkAttributeSet* webkitAccessibleGetAttributes(AtkObject* object)
 390 {
 391     auto* accessible = WEBKIT_ACCESSIBLE(object);
 392     returnValIfWebKitAccessibleIsInvalid(accessible, nullptr);
 393 
 394     AtkAttributeSet* attributeSet = nullptr;
 395 #if PLATFORM(GTK)
 396     attributeSet = addToAtkAttributeSet(attributeSet, &quot;toolkit&quot;, &quot;WebKitGtk&quot;);


 397 #endif
 398 
 399     auto* coreObject = accessible-&gt;priv-&gt;object;
 400 
 401     // Hack needed for WebKit2 tests because obtaining an element by its ID
 402     // cannot be done from the UIProcess. Assistive technologies have no need
 403     // for this information.
 404     Element* element = coreObject-&gt;element() ? coreObject-&gt;element() : coreObject-&gt;actionElement();
 405     if (element) {
 406         String tagName = element-&gt;tagName();
 407         if (!tagName.isEmpty())
 408             attributeSet = addToAtkAttributeSet(attributeSet, &quot;tag&quot;, tagName.convertToASCIILowercase().utf8().data());
 409         String id = element-&gt;getIdAttribute().string();
 410         if (!id.isEmpty())
 411             attributeSet = addToAtkAttributeSet(attributeSet, &quot;html-id&quot;, id.utf8().data());
 412     }
 413 
 414     int level = coreObject-&gt;isHeading() ? coreObject-&gt;headingLevel() : coreObject-&gt;hierarchicalLevel();
 415     if (level) {
 416         String value = String::number(level);
</pre>
<hr />
<pre>
 448         if (columnIndex != -1)
 449             attributeSet = addToAtkAttributeSet(attributeSet, &quot;colindex&quot;, String::number(columnIndex).utf8().data());
 450 
 451         int rowSpan = cell.axRowSpan();
 452         if (rowSpan != -1)
 453             attributeSet = addToAtkAttributeSet(attributeSet, &quot;rowspan&quot;, String::number(rowSpan).utf8().data());
 454 
 455         int columnSpan = cell.axColumnSpan();
 456         if (columnSpan != -1)
 457             attributeSet = addToAtkAttributeSet(attributeSet, &quot;colspan&quot;, String::number(columnSpan).utf8().data());
 458     }
 459 
 460     String placeholder = coreObject-&gt;placeholderValue();
 461     if (!placeholder.isEmpty())
 462         attributeSet = addToAtkAttributeSet(attributeSet, &quot;placeholder-text&quot;, placeholder.utf8().data());
 463 
 464     if (coreObject-&gt;supportsAutoComplete())
 465         attributeSet = addToAtkAttributeSet(attributeSet, &quot;autocomplete&quot;, coreObject-&gt;autoCompleteValue().utf8().data());
 466 
 467     if (coreObject-&gt;supportsHasPopup())
<span class="line-modified"> 468         attributeSet = addToAtkAttributeSet(attributeSet, &quot;haspopup&quot;, coreObject-&gt;hasPopupValue().utf8().data());</span>
 469 
 470     if (coreObject-&gt;supportsCurrent())
 471         attributeSet = addToAtkAttributeSet(attributeSet, &quot;current&quot;, coreObject-&gt;currentValue().utf8().data());
 472 
 473     // The Core AAM states that an explicitly-set value should be exposed, including &quot;none&quot;.
 474     if (coreObject-&gt;hasAttribute(HTMLNames::aria_sortAttr)) {
 475         switch (coreObject-&gt;sortDirection()) {
 476         case AccessibilitySortDirection::Invalid:
 477             break;
 478         case AccessibilitySortDirection::Ascending:
 479             attributeSet = addToAtkAttributeSet(attributeSet, &quot;sort&quot;, &quot;ascending&quot;);
 480             break;
 481         case AccessibilitySortDirection::Descending:
 482             attributeSet = addToAtkAttributeSet(attributeSet, &quot;sort&quot;, &quot;descending&quot;);
 483             break;
 484         case AccessibilitySortDirection::Other:
 485             attributeSet = addToAtkAttributeSet(attributeSet, &quot;sort&quot;, &quot;other&quot;);
 486             break;
 487         case AccessibilitySortDirection::None:
 488             attributeSet = addToAtkAttributeSet(attributeSet, &quot;sort&quot;, &quot;none&quot;);
</pre>
<hr />
<pre>
 501 
 502     String valueDescription = coreObject-&gt;valueDescription();
 503     if (!valueDescription.isEmpty())
 504         attributeSet = addToAtkAttributeSet(attributeSet, &quot;valuetext&quot;, valueDescription.utf8().data());
 505 
 506     // According to the W3C Core Accessibility API Mappings 1.1, section 5.4.1 General Rules:
 507     // &quot;User agents must expose the WAI-ARIA role string if the API supports a mechanism to do so.&quot;
 508     // In the case of ATK, the mechanism to do so is an object attribute pair (xml-roles:&quot;string&quot;).
 509     // We cannot use the computedRoleString for this purpose because it is not limited to elements
 510     // with ARIA roles, and it might not contain the actual ARIA role value (e.g. DPub ARIA).
 511     String roleString = coreObject-&gt;getAttribute(HTMLNames::roleAttr);
 512     if (!roleString.isEmpty())
 513         attributeSet = addToAtkAttributeSet(attributeSet, &quot;xml-roles&quot;, roleString.utf8().data());
 514 
 515     String computedRoleString = coreObject-&gt;computedRoleString();
 516     if (!computedRoleString.isEmpty()) {
 517         attributeSet = addToAtkAttributeSet(attributeSet, &quot;computed-role&quot;, computedRoleString.utf8().data());
 518 
 519         // The HTML AAM maps several elements to ARIA landmark roles. In order for the type of landmark
 520         // to be obtainable in the same fashion as an ARIA landmark, fall back on the computedRoleString.
<span class="line-modified"> 521         if (coreObject-&gt;ariaRoleAttribute() == AccessibilityRole::Unknown &amp;&amp; coreObject-&gt;isLandmark())</span>



 522             attributeSet = addToAtkAttributeSet(attributeSet, &quot;xml-roles&quot;, computedRoleString.utf8().data());
 523     }
 524 
 525     String roleDescription = coreObject-&gt;roleDescription();
 526     if (!roleDescription.isEmpty())
 527         attributeSet = addToAtkAttributeSet(attributeSet, &quot;roledescription&quot;, roleDescription.utf8().data());
 528 
 529     // We need to expose the live region attributes even if the live region is currently disabled/off.
 530     if (auto liveContainer = coreObject-&gt;liveRegionAncestor(false)) {
 531         String liveStatus = liveContainer-&gt;liveRegionStatus();
 532         String relevant = liveContainer-&gt;liveRegionRelevant();
<span class="line-modified"> 533         bool isAtomic = liveContainer-&gt;liveRegionAtomic();</span>
 534         String liveRole = roleString.isEmpty() ? computedRoleString : roleString;
 535 
 536         // According to the Core AAM, we need to expose the above properties with &quot;container-&quot; prefixed
 537         // object attributes regardless of whether the container is this object, or an ancestor of it.
 538         attributeSet = addToAtkAttributeSet(attributeSet, &quot;container-live&quot;, liveStatus.utf8().data());
 539         attributeSet = addToAtkAttributeSet(attributeSet, &quot;container-relevant&quot;, relevant.utf8().data());
<span class="line-modified"> 540         if (isAtomic)</span>
 541             attributeSet = addToAtkAttributeSet(attributeSet, &quot;container-atomic&quot;, &quot;true&quot;);
 542         if (!liveRole.isEmpty())
 543             attributeSet = addToAtkAttributeSet(attributeSet, &quot;container-live-role&quot;, liveRole.utf8().data());
 544 
 545         // According to the Core AAM, if this object is the live region (rather than its descendant),
 546         // we must expose the above properties on the object without a &quot;container-&quot; prefix.
 547         if (liveContainer == coreObject) {
 548             attributeSet = addToAtkAttributeSet(attributeSet, &quot;live&quot;, liveStatus.utf8().data());
 549             attributeSet = addToAtkAttributeSet(attributeSet, &quot;relevant&quot;, relevant.utf8().data());
<span class="line-modified"> 550             if (isAtomic)</span>
 551                 attributeSet = addToAtkAttributeSet(attributeSet, &quot;atomic&quot;, &quot;true&quot;);
<span class="line-modified"> 552         } else if (!isAtomic &amp;&amp; coreObject-&gt;liveRegionAtomic())</span>
 553             attributeSet = addToAtkAttributeSet(attributeSet, &quot;atomic&quot;, &quot;true&quot;);
 554     }
 555 
 556     // The Core AAM states the author-provided value should be exposed as-is.
 557     String dropEffect = coreObject-&gt;getAttribute(HTMLNames::aria_dropeffectAttr);
 558     if (!dropEffect.isEmpty())
 559         attributeSet = addToAtkAttributeSet(attributeSet, &quot;dropeffect&quot;, dropEffect.utf8().data());
 560 
 561     if (coreObject-&gt;isARIAGrabbed())
 562         attributeSet = addToAtkAttributeSet(attributeSet, &quot;grabbed&quot;, &quot;true&quot;);
 563     else if (coreObject-&gt;supportsARIADragging())
 564         attributeSet = addToAtkAttributeSet(attributeSet, &quot;grabbed&quot;, &quot;false&quot;);
 565 
 566     // The Core AAM states the author-provided value should be exposed as-is.
<span class="line-modified"> 567     const AtomicString&amp; keyShortcuts = coreObject-&gt;keyShortcutsValue();</span>
 568     if (!keyShortcuts.isEmpty())
 569         attributeSet = addToAtkAttributeSet(attributeSet, &quot;keyshortcuts&quot;, keyShortcuts.string().utf8().data());
 570 
 571     return attributeSet;
 572 }
 573 
 574 static AtkRole atkRole(AccessibilityObject* coreObject)
 575 {
 576     switch (coreObject-&gt;roleValue()) {
 577     case AccessibilityRole::ApplicationAlert:
 578         return ATK_ROLE_ALERT;
 579     case AccessibilityRole::ApplicationAlertDialog:
 580     case AccessibilityRole::ApplicationDialog:
 581         return ATK_ROLE_DIALOG;
 582     case AccessibilityRole::ApplicationStatus:
 583         return ATK_ROLE_STATUSBAR;
 584     case AccessibilityRole::Unknown:
 585         return ATK_ROLE_UNKNOWN;
 586     case AccessibilityRole::Audio:
<span class="line-removed"> 587 #if ATK_CHECK_VERSION(2, 11, 3)</span>
 588         return ATK_ROLE_AUDIO;
<span class="line-removed"> 589 #endif</span>
 590     case AccessibilityRole::Video:
<span class="line-removed"> 591 #if ATK_CHECK_VERSION(2, 11, 3)</span>
 592         return ATK_ROLE_VIDEO;
<span class="line-removed"> 593 #endif</span>
<span class="line-removed"> 594         return ATK_ROLE_EMBEDDED;</span>
 595     case AccessibilityRole::Button:
 596         return ATK_ROLE_PUSH_BUTTON;
 597     case AccessibilityRole::Switch:
 598     case AccessibilityRole::ToggleButton:
 599         return ATK_ROLE_TOGGLE_BUTTON;
 600     case AccessibilityRole::RadioButton:
 601         return ATK_ROLE_RADIO_BUTTON;
 602     case AccessibilityRole::CheckBox:
 603         return ATK_ROLE_CHECK_BOX;
 604     case AccessibilityRole::Slider:
 605         return ATK_ROLE_SLIDER;
 606     case AccessibilityRole::TabGroup:
 607     case AccessibilityRole::TabList:
 608         return ATK_ROLE_PAGE_TAB_LIST;
 609     case AccessibilityRole::TextField:
 610     case AccessibilityRole::TextArea:
 611     case AccessibilityRole::SearchField:
 612         return ATK_ROLE_ENTRY;
 613     case AccessibilityRole::StaticText:
<span class="line-removed"> 614 #if ATK_CHECK_VERSION(2, 15, 2)</span>
 615         return ATK_ROLE_STATIC;
<span class="line-removed"> 616 #else</span>
<span class="line-removed"> 617         return ATK_ROLE_TEXT;</span>
<span class="line-removed"> 618 #endif</span>
 619     case AccessibilityRole::Outline:
 620     case AccessibilityRole::Tree:
 621         return ATK_ROLE_TREE;
 622     case AccessibilityRole::TreeItem:
 623         return ATK_ROLE_TREE_ITEM;
 624     case AccessibilityRole::MenuBar:
 625         return ATK_ROLE_MENU_BAR;
 626     case AccessibilityRole::MenuListPopup:
 627     case AccessibilityRole::Menu:
 628         return ATK_ROLE_MENU;
 629     case AccessibilityRole::MenuListOption:
 630     case AccessibilityRole::MenuItem:
 631     case AccessibilityRole::MenuButton:
 632         return ATK_ROLE_MENU_ITEM;
 633     case AccessibilityRole::MenuItemCheckbox:
 634         return ATK_ROLE_CHECK_MENU_ITEM;
 635     case AccessibilityRole::MenuItemRadio:
 636         return ATK_ROLE_RADIO_MENU_ITEM;
 637     case AccessibilityRole::Column:
 638         // return ATK_ROLE_TABLE_COLUMN_HEADER; // Is this right?
 639         return ATK_ROLE_UNKNOWN; // Matches Mozilla
 640     case AccessibilityRole::Row:
 641         return ATK_ROLE_TABLE_ROW;
 642     case AccessibilityRole::Toolbar:
 643         return ATK_ROLE_TOOL_BAR;


 644     case AccessibilityRole::BusyIndicator:
<span class="line-removed"> 645         return ATK_ROLE_PROGRESS_BAR; // Is this right?</span>
 646     case AccessibilityRole::ProgressIndicator:
<span class="line-modified"> 647         return coreObject-&gt;isMeter() ? ATK_ROLE_LEVEL_BAR : ATK_ROLE_PROGRESS_BAR;</span>
 648     case AccessibilityRole::Window:
 649         return ATK_ROLE_WINDOW;
 650     case AccessibilityRole::PopUpButton:
 651         return coreObject-&gt;hasPopup() ? ATK_ROLE_PUSH_BUTTON : ATK_ROLE_COMBO_BOX;
 652     case AccessibilityRole::ComboBox:
 653         return ATK_ROLE_COMBO_BOX;
 654     case AccessibilityRole::SplitGroup:
 655         return ATK_ROLE_SPLIT_PANE;
 656     case AccessibilityRole::Splitter:
 657         return ATK_ROLE_SEPARATOR;
<span class="line-removed"> 658     case AccessibilityRole::ColorWell:</span>
 659 #if PLATFORM(GTK)

 660         // ATK_ROLE_COLOR_CHOOSER is defined as a dialog (i.e. it&#39;s what appears when you push the button).
 661         return ATK_ROLE_PUSH_BUTTON;
 662 #endif
 663     case AccessibilityRole::List:
 664         return ATK_ROLE_LIST;
 665     case AccessibilityRole::ScrollBar:
 666         return ATK_ROLE_SCROLL_BAR;
 667     case AccessibilityRole::ScrollArea:
 668     case AccessibilityRole::TabPanel:
 669         return ATK_ROLE_SCROLL_PANE;
 670     case AccessibilityRole::Grid:
 671     case AccessibilityRole::Table:
 672         return ATK_ROLE_TABLE;
 673     case AccessibilityRole::TreeGrid:
 674         return ATK_ROLE_TREE_TABLE;
 675     case AccessibilityRole::Application:
 676         return ATK_ROLE_APPLICATION;
 677     case AccessibilityRole::ApplicationGroup:
 678     case AccessibilityRole::Feed:
 679     case AccessibilityRole::Figure:
</pre>
<hr />
<pre>
 686         return ATK_ROLE_ROW_HEADER;
 687     case AccessibilityRole::ColumnHeader:
 688         return ATK_ROLE_COLUMN_HEADER;
 689     case AccessibilityRole::Caption:
 690         return ATK_ROLE_CAPTION;
 691     case AccessibilityRole::Cell:
 692     case AccessibilityRole::GridCell:
 693         return coreObject-&gt;inheritsPresentationalRole() ? ATK_ROLE_SECTION : ATK_ROLE_TABLE_CELL;
 694     case AccessibilityRole::Link:
 695     case AccessibilityRole::WebCoreLink:
 696     case AccessibilityRole::ImageMapLink:
 697         return ATK_ROLE_LINK;
 698     case AccessibilityRole::ImageMap:
 699         return ATK_ROLE_IMAGE_MAP;
 700     case AccessibilityRole::GraphicsSymbol:
 701     case AccessibilityRole::Image:
 702         return ATK_ROLE_IMAGE;
 703     case AccessibilityRole::ListMarker:
 704         return ATK_ROLE_TEXT;
 705     case AccessibilityRole::DocumentArticle:
<span class="line-removed"> 706 #if ATK_CHECK_VERSION(2, 11, 3)</span>
 707         return ATK_ROLE_ARTICLE;
<span class="line-removed"> 708 #endif</span>
 709     case AccessibilityRole::Document:
 710     case AccessibilityRole::GraphicsDocument:
 711         return ATK_ROLE_DOCUMENT_FRAME;
 712     case AccessibilityRole::DocumentNote:
 713         return ATK_ROLE_COMMENT;
 714     case AccessibilityRole::Heading:
 715         return ATK_ROLE_HEADING;
 716     case AccessibilityRole::ListBox:
 717         // https://rawgit.com/w3c/aria/master/core-aam/core-aam.html#role-map-listbox
 718         return coreObject-&gt;isDescendantOfRole(AccessibilityRole::ComboBox) ? ATK_ROLE_MENU : ATK_ROLE_LIST_BOX;
 719     case AccessibilityRole::ListItem:
 720         return coreObject-&gt;inheritsPresentationalRole() ? ATK_ROLE_SECTION : ATK_ROLE_LIST_ITEM;
 721     case AccessibilityRole::ListBoxOption:
 722         return coreObject-&gt;isDescendantOfRole(AccessibilityRole::ComboBox) ? ATK_ROLE_MENU_ITEM : ATK_ROLE_LIST_ITEM;
 723     case AccessibilityRole::Paragraph:
 724         return ATK_ROLE_PARAGRAPH;
 725     case AccessibilityRole::Label:
 726     case AccessibilityRole::Legend:
 727         return ATK_ROLE_LABEL;
 728     case AccessibilityRole::Blockquote:
<span class="line-removed"> 729 #if ATK_CHECK_VERSION(2, 11, 3)</span>
 730         return ATK_ROLE_BLOCK_QUOTE;
<span class="line-removed"> 731 #endif</span>
<span class="line-removed"> 732     case AccessibilityRole::Footnote:</span>
 733 #if ATK_CHECK_VERSION(2, 25, 2)

 734         return ATK_ROLE_FOOTNOTE;
 735 #endif
 736     case AccessibilityRole::ApplicationTextGroup:
 737     case AccessibilityRole::Div:
 738     case AccessibilityRole::Pre:
 739     case AccessibilityRole::SVGText:
 740     case AccessibilityRole::TextGroup:
 741         return ATK_ROLE_SECTION;
 742     case AccessibilityRole::Footer:
 743         return ATK_ROLE_FOOTER;
 744     case AccessibilityRole::Form:
<span class="line-removed"> 745 #if ATK_CHECK_VERSION(2, 11, 3)</span>
 746         if (coreObject-&gt;ariaRoleAttribute() != AccessibilityRole::Unknown)
 747             return ATK_ROLE_LANDMARK;
<span class="line-removed"> 748 #endif</span>
 749         return ATK_ROLE_FORM;
 750     case AccessibilityRole::Canvas:
 751         return ATK_ROLE_CANVAS;
 752     case AccessibilityRole::HorizontalRule:
 753         return ATK_ROLE_SEPARATOR;
 754     case AccessibilityRole::SpinButton:
 755         return ATK_ROLE_SPIN_BUTTON;
 756     case AccessibilityRole::Tab:
 757         return ATK_ROLE_PAGE_TAB;
 758     case AccessibilityRole::UserInterfaceTooltip:
 759         return ATK_ROLE_TOOL_TIP;
 760     case AccessibilityRole::WebArea:
 761         return ATK_ROLE_DOCUMENT_WEB;
 762     case AccessibilityRole::WebApplication:
 763         return ATK_ROLE_EMBEDDED;
<span class="line-removed"> 764 #if ATK_CHECK_VERSION(2, 11, 3)</span>
 765     case AccessibilityRole::ApplicationLog:
 766         return ATK_ROLE_LOG;
 767     case AccessibilityRole::ApplicationMarquee:
 768         return ATK_ROLE_MARQUEE;
 769     case AccessibilityRole::ApplicationTimer:
 770         return ATK_ROLE_TIMER;
 771     case AccessibilityRole::Definition:
 772         return ATK_ROLE_DEFINITION;
 773     case AccessibilityRole::DocumentMath:
 774         return ATK_ROLE_MATH;
 775     case AccessibilityRole::MathElement:
 776         if (coreObject-&gt;isMathRow())
 777             return ATK_ROLE_PANEL;
 778         if (coreObject-&gt;isMathTable())
 779             return ATK_ROLE_TABLE;
 780         if (coreObject-&gt;isMathTableRow())
 781             return ATK_ROLE_TABLE_ROW;
 782         if (coreObject-&gt;isMathTableCell())
 783             return ATK_ROLE_TABLE_CELL;
 784         if (coreObject-&gt;isMathSubscriptSuperscript() || coreObject-&gt;isMathMultiscript())
 785             return ATK_ROLE_SECTION;
<span class="line-removed"> 786 #if ATK_CHECK_VERSION(2, 15, 4)</span>
 787         if (coreObject-&gt;isMathFraction())
 788             return ATK_ROLE_MATH_FRACTION;
 789         if (coreObject-&gt;isMathSquareRoot() || coreObject-&gt;isMathRoot())
 790             return ATK_ROLE_MATH_ROOT;
 791         if (coreObject-&gt;isMathScriptObject(AccessibilityMathScriptObjectType::Subscript)
 792             || coreObject-&gt;isMathMultiscriptObject(AccessibilityMathMultiscriptObjectType::PreSubscript) || coreObject-&gt;isMathMultiscriptObject(AccessibilityMathMultiscriptObjectType::PostSubscript))
 793             return ATK_ROLE_SUBSCRIPT;
 794         if (coreObject-&gt;isMathScriptObject(AccessibilityMathScriptObjectType::Superscript)
 795             || coreObject-&gt;isMathMultiscriptObject(AccessibilityMathMultiscriptObjectType::PreSuperscript) || coreObject-&gt;isMathMultiscriptObject(AccessibilityMathMultiscriptObjectType::PostSuperscript))
 796             return ATK_ROLE_SUPERSCRIPT;
<span class="line-removed"> 797 #endif</span>
<span class="line-removed"> 798 #if ATK_CHECK_VERSION(2, 15, 2)</span>
 799         if (coreObject-&gt;isMathToken())
 800             return ATK_ROLE_STATIC;
<span class="line-removed"> 801 #endif</span>
 802         return ATK_ROLE_UNKNOWN;
 803     case AccessibilityRole::LandmarkBanner:
 804     case AccessibilityRole::LandmarkComplementary:
 805     case AccessibilityRole::LandmarkContentInfo:
 806     case AccessibilityRole::LandmarkDocRegion:
 807     case AccessibilityRole::LandmarkMain:
 808     case AccessibilityRole::LandmarkNavigation:
 809     case AccessibilityRole::LandmarkRegion:
 810     case AccessibilityRole::LandmarkSearch:
 811         return ATK_ROLE_LANDMARK;
<span class="line-removed"> 812 #endif</span>
<span class="line-removed"> 813 #if ATK_CHECK_VERSION(2, 11, 4)</span>
 814     case AccessibilityRole::DescriptionList:
 815         return ATK_ROLE_DESCRIPTION_LIST;
 816     case AccessibilityRole::Term:
 817     case AccessibilityRole::DescriptionListTerm:
 818         return ATK_ROLE_DESCRIPTION_TERM;
 819     case AccessibilityRole::DescriptionListDetail:
 820         return ATK_ROLE_DESCRIPTION_VALUE;





 821 #endif
<span class="line-modified"> 822     case AccessibilityRole::Inline:</span>
<span class="line-modified"> 823 #if ATK_CHECK_VERSION(2, 15, 4)</span>
<span class="line-modified"> 824         if (coreObject-&gt;isSubscriptStyleGroup())</span>
<span class="line-modified"> 825             return ATK_ROLE_SUBSCRIPT;</span>
<span class="line-removed"> 826         if (coreObject-&gt;isSuperscriptStyleGroup())</span>
<span class="line-removed"> 827             return ATK_ROLE_SUPERSCRIPT;</span>
<span class="line-removed"> 828 #endif</span>
<span class="line-removed"> 829 #if ATK_CHECK_VERSION(2, 15, 2)</span>
 830         return ATK_ROLE_STATIC;






 831     case AccessibilityRole::SVGTextPath:
 832     case AccessibilityRole::SVGTSpan:
 833     case AccessibilityRole::Time:
 834         return ATK_ROLE_STATIC;
<span class="line-removed"> 835 #endif</span>
 836     default:
 837         return ATK_ROLE_UNKNOWN;
 838     }
 839 }
 840 
 841 static AtkRole webkitAccessibleGetRole(AtkObject* object)
 842 {
 843     // ATK_ROLE_UNKNOWN should only be applied in cases where there is a valid
 844     // WebCore accessible object for which the platform role mapping is unknown.
 845     auto* accessible = WEBKIT_ACCESSIBLE(object);
 846     returnValIfWebKitAccessibleIsInvalid(accessible, ATK_ROLE_INVALID);
 847 
 848     // Note: Why doesn&#39;t WebCore have a password field for this
 849     if (accessible-&gt;priv-&gt;object-&gt;isPasswordField())
 850         return ATK_ROLE_PASSWORD_TEXT;
 851 
 852     return atkRole(accessible-&gt;priv-&gt;object);
 853 }
 854 
 855 static bool isTextWithCaret(AccessibilityObject* coreObject)
</pre>
<hr />
<pre>
 878     VisibleSelection selection = coreObject-&gt;selection();
 879     if (!selection.isCaret())
 880         return false;
 881 
 882     return selectionBelongsToObject(coreObject, selection);
 883 }
 884 
 885 static void setAtkStateSetFromCoreObject(AccessibilityObject* coreObject, AtkStateSet* stateSet)
 886 {
 887     AccessibilityObject* parent = coreObject-&gt;parentObject();
 888     bool isListBoxOption = parent &amp;&amp; parent-&gt;isListBox();
 889 
 890     // Please keep the state list in alphabetical order
 891     if ((isListBoxOption &amp;&amp; coreObject-&gt;isSelectedOptionActive())
 892         || coreObject-&gt;currentState() != AccessibilityCurrentState::False)
 893         atk_state_set_add_state(stateSet, ATK_STATE_ACTIVE);
 894 
 895     if (coreObject-&gt;isBusy())
 896         atk_state_set_add_state(stateSet, ATK_STATE_BUSY);
 897 
<span class="line-removed"> 898 #if ATK_CHECK_VERSION(2,11,2)</span>
 899     if (coreObject-&gt;supportsChecked() &amp;&amp; coreObject-&gt;canSetValueAttribute())
 900         atk_state_set_add_state(stateSet, ATK_STATE_CHECKABLE);
<span class="line-removed"> 901 #endif</span>
 902 
 903     if (coreObject-&gt;isChecked())
 904         atk_state_set_add_state(stateSet, ATK_STATE_CHECKED);
 905 
 906     if ((coreObject-&gt;isTextControl() || coreObject-&gt;isNonNativeTextControl()) &amp;&amp; coreObject-&gt;canSetValueAttribute())
 907         atk_state_set_add_state(stateSet, ATK_STATE_EDITABLE);
 908 
 909     // FIXME: Put both ENABLED and SENSITIVE together here for now
 910     if (coreObject-&gt;isEnabled()) {
 911         atk_state_set_add_state(stateSet, ATK_STATE_ENABLED);
 912         atk_state_set_add_state(stateSet, ATK_STATE_SENSITIVE);
 913     }
 914 
 915     if (coreObject-&gt;canSetExpandedAttribute())
 916         atk_state_set_add_state(stateSet, ATK_STATE_EXPANDABLE);
 917 
 918     if (coreObject-&gt;isExpanded())
 919         atk_state_set_add_state(stateSet, ATK_STATE_EXPANDED);
 920 
 921     if (coreObject-&gt;canSetFocusAttribute())
</pre>
<hr />
<pre>
 943         atk_state_set_add_state(stateSet, ATK_STATE_INDETERMINATE);
 944     else if (coreObject-&gt;isCheckboxOrRadio() || coreObject-&gt;isMenuItem() || coreObject-&gt;isToggleButton()) {
 945         if (coreObject-&gt;checkboxOrRadioValue() == AccessibilityButtonState::Mixed)
 946             atk_state_set_add_state(stateSet, ATK_STATE_INDETERMINATE);
 947     }
 948 
 949     if (coreObject-&gt;isModalNode())
 950         atk_state_set_add_state(stateSet, ATK_STATE_MODAL);
 951 
 952     if (coreObject-&gt;invalidStatus() != &quot;false&quot;)
 953         atk_state_set_add_state(stateSet, ATK_STATE_INVALID_ENTRY);
 954 
 955     if (coreObject-&gt;isMultiSelectable())
 956         atk_state_set_add_state(stateSet, ATK_STATE_MULTISELECTABLE);
 957 
 958     // TODO: ATK_STATE_OPAQUE
 959 
 960     if (coreObject-&gt;isPressed())
 961         atk_state_set_add_state(stateSet, ATK_STATE_PRESSED);
 962 
<span class="line-removed"> 963 #if ATK_CHECK_VERSION(2,15,3)</span>
 964     if (!coreObject-&gt;canSetValueAttribute() &amp;&amp; (coreObject-&gt;supportsReadOnly()))
 965         atk_state_set_add_state(stateSet, ATK_STATE_READ_ONLY);
<span class="line-removed"> 966 #endif</span>
 967 
 968     if (coreObject-&gt;isRequired())
 969         atk_state_set_add_state(stateSet, ATK_STATE_REQUIRED);
 970 
 971     // TODO: ATK_STATE_SELECTABLE_TEXT
 972 
 973     if (coreObject-&gt;canSetSelectedAttribute()) {
 974         atk_state_set_add_state(stateSet, ATK_STATE_SELECTABLE);
 975         // Items in focusable lists have both STATE_SELECT{ABLE,ED}
 976         // and STATE_FOCUS{ABLE,ED}. We&#39;ll fake the latter based on
 977         // the former.
 978         if (isListBoxOption)
 979             atk_state_set_add_state(stateSet, ATK_STATE_FOCUSABLE);
 980     }
 981 
 982     if (coreObject-&gt;isSelected()) {
 983         atk_state_set_add_state(stateSet, ATK_STATE_SELECTED);
 984         // Items in focusable lists have both STATE_SELECT{ABLE,ED}
 985         // and STATE_FOCUS{ABLE,ED}. We&#39;ll fake the latter based on the
 986         // former.
</pre>
<hr />
<pre>
1092     atkObjectClass-&gt;get_description = webkitAccessibleGetDescription;
1093     atkObjectClass-&gt;get_parent = webkitAccessibleGetParent;
1094     atkObjectClass-&gt;get_n_children = webkitAccessibleGetNChildren;
1095     atkObjectClass-&gt;ref_child = webkitAccessibleRefChild;
1096     atkObjectClass-&gt;get_role = webkitAccessibleGetRole;
1097     atkObjectClass-&gt;ref_state_set = webkitAccessibleRefStateSet;
1098     atkObjectClass-&gt;get_index_in_parent = webkitAccessibleGetIndexInParent;
1099     atkObjectClass-&gt;get_attributes = webkitAccessibleGetAttributes;
1100     atkObjectClass-&gt;ref_relation_set = webkitAccessibleRefRelationSet;
1101     atkObjectClass-&gt;get_object_locale = webkitAccessibleGetObjectLocale;
1102 }
1103 
1104 static const GInterfaceInfo atkInterfacesInitFunctions[] = {
1105     {reinterpret_cast&lt;GInterfaceInitFunc&gt;(reinterpret_cast&lt;GCallback&gt;(webkitAccessibleActionInterfaceInit)), nullptr, nullptr},
1106     {reinterpret_cast&lt;GInterfaceInitFunc&gt;(reinterpret_cast&lt;GCallback&gt;(webkitAccessibleSelectionInterfaceInit)), nullptr, nullptr},
1107     {reinterpret_cast&lt;GInterfaceInitFunc&gt;(reinterpret_cast&lt;GCallback&gt;(webkitAccessibleEditableTextInterfaceInit)), nullptr, nullptr},
1108     {reinterpret_cast&lt;GInterfaceInitFunc&gt;(reinterpret_cast&lt;GCallback&gt;(webkitAccessibleTextInterfaceInit)), nullptr, nullptr},
1109     {reinterpret_cast&lt;GInterfaceInitFunc&gt;(reinterpret_cast&lt;GCallback&gt;(webkitAccessibleComponentInterfaceInit)), nullptr, nullptr},
1110     {reinterpret_cast&lt;GInterfaceInitFunc&gt;(reinterpret_cast&lt;GCallback&gt;(webkitAccessibleImageInterfaceInit)), nullptr, nullptr},
1111     {reinterpret_cast&lt;GInterfaceInitFunc&gt;(reinterpret_cast&lt;GCallback&gt;(webkitAccessibleTableInterfaceInit)), nullptr, nullptr},
<span class="line-removed">1112 #if ATK_CHECK_VERSION(2,11,90)</span>
1113     {reinterpret_cast&lt;GInterfaceInitFunc&gt;(reinterpret_cast&lt;GCallback&gt;(webkitAccessibleTableCellInterfaceInit)), nullptr, nullptr},
<span class="line-removed">1114 #endif</span>
1115     {reinterpret_cast&lt;GInterfaceInitFunc&gt;(reinterpret_cast&lt;GCallback&gt;(webkitAccessibleHypertextInterfaceInit)), nullptr, nullptr},
1116     {reinterpret_cast&lt;GInterfaceInitFunc&gt;(reinterpret_cast&lt;GCallback&gt;(webkitAccessibleHyperlinkImplInterfaceInit)), nullptr, nullptr},
1117     {reinterpret_cast&lt;GInterfaceInitFunc&gt;(reinterpret_cast&lt;GCallback&gt;(webkitAccessibleDocumentInterfaceInit)), nullptr, nullptr},
1118     {reinterpret_cast&lt;GInterfaceInitFunc&gt;(reinterpret_cast&lt;GCallback&gt;(webkitAccessibleValueInterfaceInit)), nullptr, nullptr}
1119 };
1120 
1121 enum WAIType {
1122     WAIAction,
1123     WAISelection,
1124     WAIEditableText,
1125     WAIText,
1126     WAIComponent,
1127     WAIImage,
1128     WAITable,
<span class="line-removed">1129 #if ATK_CHECK_VERSION(2,11,90)</span>
1130     WAITableCell,
<span class="line-removed">1131 #endif</span>
1132     WAIHypertext,
1133     WAIHyperlink,
1134     WAIDocument,
1135     WAIValue,
1136 };
1137 
1138 static GType atkInterfaceTypeFromWAIType(WAIType type)
1139 {
1140     switch (type) {
1141     case WAIAction:
1142         return ATK_TYPE_ACTION;
1143     case WAISelection:
1144         return ATK_TYPE_SELECTION;
1145     case WAIEditableText:
1146         return ATK_TYPE_EDITABLE_TEXT;
1147     case WAIText:
1148         return ATK_TYPE_TEXT;
1149     case WAIComponent:
1150         return ATK_TYPE_COMPONENT;
1151     case WAIImage:
1152         return ATK_TYPE_IMAGE;
1153     case WAITable:
1154         return ATK_TYPE_TABLE;
<span class="line-removed">1155 #if ATK_CHECK_VERSION(2,11,90)</span>
1156     case WAITableCell:
1157         return ATK_TYPE_TABLE_CELL;
<span class="line-removed">1158 #endif</span>
1159     case WAIHypertext:
1160         return ATK_TYPE_HYPERTEXT;
1161     case WAIHyperlink:
1162         return ATK_TYPE_HYPERLINK_IMPL;
1163     case WAIDocument:
1164         return ATK_TYPE_DOCUMENT;
1165     case WAIValue:
1166         return ATK_TYPE_VALUE;
1167     }
1168 
1169     return G_TYPE_INVALID;
1170 }
1171 
1172 static bool roleIsTextType(AccessibilityRole role)
1173 {
1174     return role == AccessibilityRole::Paragraph
1175         || role == AccessibilityRole::Heading
1176         || role == AccessibilityRole::Div
1177         || role == AccessibilityRole::Cell
1178         || role == AccessibilityRole::Link
</pre>
<hr />
<pre>
1229                 interfaceMask |= 1 &lt;&lt; WAIText;
1230         }
1231 
1232         // Add the TEXT interface for list items whose
1233         // first accessible child has a text renderer
1234         if (role == AccessibilityRole::ListItem) {
1235             const auto&amp; children = coreObject-&gt;children();
1236             if (!children.isEmpty())
1237                 interfaceMask |= interfaceMaskFromObject(children[0].get());
1238         }
1239     }
1240 
1241     // Image
1242     if (coreObject-&gt;isImage())
1243         interfaceMask |= 1 &lt;&lt; WAIImage;
1244 
1245     // Table
1246     if (coreObject-&gt;isTable())
1247         interfaceMask |= 1 &lt;&lt; WAITable;
1248 
<span class="line-removed">1249 #if ATK_CHECK_VERSION(2,11,90)</span>
1250     if (role == AccessibilityRole::Cell || role == AccessibilityRole::GridCell || role == AccessibilityRole::ColumnHeader || role == AccessibilityRole::RowHeader)
1251         interfaceMask |= 1 &lt;&lt; WAITableCell;
<span class="line-removed">1252 #endif</span>
1253 
1254     // Document
1255     if (role == AccessibilityRole::WebArea)
1256         interfaceMask |= 1 &lt;&lt; WAIDocument;
1257 
1258     // Value
1259     if (coreObject-&gt;supportsRangeValue())
1260         interfaceMask |= 1 &lt;&lt; WAIValue;
1261 
1262 #if ENABLE(INPUT_TYPE_COLOR)
1263     // Color type.
1264     if (role == AccessibilityRole::ColorWell)
1265         interfaceMask |= 1 &lt;&lt; WAIText;
1266 #endif
1267 
1268     return interfaceMask;
1269 }
1270 
1271 static const char* uniqueAccessibilityTypeName(guint16 interfaceMask)
1272 {
</pre>
<hr />
<pre>
1374         propertyPtr = &amp;priv-&gt;documentEncoding;
1375         break;
1376     case AtkCachedDocumentURI:
1377         propertyPtr = &amp;priv-&gt;documentURI;
1378         break;
1379     case AtkCachedImageDescription:
1380         propertyPtr = &amp;priv-&gt;imageDescription;
1381         break;
1382     default:
1383         ASSERT_NOT_REACHED();
1384     }
1385 
1386     // Don&#39;t invalidate old memory if not stricly needed, since other
1387     // callers might be still holding on to it.
1388     if (*propertyPtr != value)
1389         *propertyPtr = WTFMove(value);
1390 
1391     return (*propertyPtr).data();
1392 }
1393 
<span class="line-modified">1394 #endif // HAVE(ACCESSIBILITY)</span>
</pre>
</td>
<td>
<hr />
<pre>
  15  *
  16  * This library is free software; you can redistribute it and/or
  17  * modify it under the terms of the GNU Library General Public
  18  * License as published by the Free Software Foundation; either
  19  * version 2 of the License, or (at your option) any later version.
  20  *
  21  * This library is distributed in the hope that it will be useful,
  22  * but WITHOUT ANY WARRANTY; without even the implied warranty of
  23  * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
  24  * Library General Public License for more details.
  25  *
  26  * You should have received a copy of the GNU Library General Public License
  27  * along with this library; see the file COPYING.LIB.  If not, write to
  28  * the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor,
  29  * Boston, MA 02110-1301, USA.
  30  */
  31 
  32 #include &quot;config.h&quot;
  33 #include &quot;WebKitAccessible.h&quot;
  34 
<span class="line-modified">  35 #if ENABLE(ACCESSIBILITY)</span>
  36 
  37 #include &quot;AXObjectCache.h&quot;
  38 #include &quot;AccessibilityList.h&quot;
  39 #include &quot;AccessibilityListBoxOption.h&quot;
  40 #include &quot;AccessibilityTable.h&quot;
  41 #include &quot;AccessibilityTableCell.h&quot;
  42 #include &quot;AccessibilityTableRow.h&quot;
  43 #include &quot;Document.h&quot;
  44 #include &quot;Editing.h&quot;
  45 #include &quot;Frame.h&quot;
  46 #include &quot;FrameView.h&quot;
  47 #include &quot;HTMLNames.h&quot;
  48 #include &quot;HTMLTableElement.h&quot;
  49 #include &quot;HostWindow.h&quot;
  50 #include &quot;RenderAncestorIterator.h&quot;
  51 #include &quot;RenderBlock.h&quot;
  52 #include &quot;RenderObject.h&quot;
  53 #include &quot;SVGElement.h&quot;
  54 #include &quot;Settings.h&quot;
  55 #include &quot;TextIterator.h&quot;
</pre>
<hr />
<pre>
 377             if (child.get() == object)
 378                 return i;
 379         }
 380     }
 381 
 382     if (!parent)
 383         return -1;
 384 
 385     size_t index = parent-&gt;children().find(coreObject);
 386     return (index == WTF::notFound) ? -1 : index;
 387 }
 388 
 389 static AtkAttributeSet* webkitAccessibleGetAttributes(AtkObject* object)
 390 {
 391     auto* accessible = WEBKIT_ACCESSIBLE(object);
 392     returnValIfWebKitAccessibleIsInvalid(accessible, nullptr);
 393 
 394     AtkAttributeSet* attributeSet = nullptr;
 395 #if PLATFORM(GTK)
 396     attributeSet = addToAtkAttributeSet(attributeSet, &quot;toolkit&quot;, &quot;WebKitGtk&quot;);
<span class="line-added"> 397 #elif PLATFORM(WPE)</span>
<span class="line-added"> 398     attributeSet = addToAtkAttributeSet(attributeSet, &quot;toolkit&quot;, &quot;WPEWebKit&quot;);</span>
 399 #endif
 400 
 401     auto* coreObject = accessible-&gt;priv-&gt;object;
 402 
 403     // Hack needed for WebKit2 tests because obtaining an element by its ID
 404     // cannot be done from the UIProcess. Assistive technologies have no need
 405     // for this information.
 406     Element* element = coreObject-&gt;element() ? coreObject-&gt;element() : coreObject-&gt;actionElement();
 407     if (element) {
 408         String tagName = element-&gt;tagName();
 409         if (!tagName.isEmpty())
 410             attributeSet = addToAtkAttributeSet(attributeSet, &quot;tag&quot;, tagName.convertToASCIILowercase().utf8().data());
 411         String id = element-&gt;getIdAttribute().string();
 412         if (!id.isEmpty())
 413             attributeSet = addToAtkAttributeSet(attributeSet, &quot;html-id&quot;, id.utf8().data());
 414     }
 415 
 416     int level = coreObject-&gt;isHeading() ? coreObject-&gt;headingLevel() : coreObject-&gt;hierarchicalLevel();
 417     if (level) {
 418         String value = String::number(level);
</pre>
<hr />
<pre>
 450         if (columnIndex != -1)
 451             attributeSet = addToAtkAttributeSet(attributeSet, &quot;colindex&quot;, String::number(columnIndex).utf8().data());
 452 
 453         int rowSpan = cell.axRowSpan();
 454         if (rowSpan != -1)
 455             attributeSet = addToAtkAttributeSet(attributeSet, &quot;rowspan&quot;, String::number(rowSpan).utf8().data());
 456 
 457         int columnSpan = cell.axColumnSpan();
 458         if (columnSpan != -1)
 459             attributeSet = addToAtkAttributeSet(attributeSet, &quot;colspan&quot;, String::number(columnSpan).utf8().data());
 460     }
 461 
 462     String placeholder = coreObject-&gt;placeholderValue();
 463     if (!placeholder.isEmpty())
 464         attributeSet = addToAtkAttributeSet(attributeSet, &quot;placeholder-text&quot;, placeholder.utf8().data());
 465 
 466     if (coreObject-&gt;supportsAutoComplete())
 467         attributeSet = addToAtkAttributeSet(attributeSet, &quot;autocomplete&quot;, coreObject-&gt;autoCompleteValue().utf8().data());
 468 
 469     if (coreObject-&gt;supportsHasPopup())
<span class="line-modified"> 470         attributeSet = addToAtkAttributeSet(attributeSet, &quot;haspopup&quot;, coreObject-&gt;popupValue().utf8().data());</span>
 471 
 472     if (coreObject-&gt;supportsCurrent())
 473         attributeSet = addToAtkAttributeSet(attributeSet, &quot;current&quot;, coreObject-&gt;currentValue().utf8().data());
 474 
 475     // The Core AAM states that an explicitly-set value should be exposed, including &quot;none&quot;.
 476     if (coreObject-&gt;hasAttribute(HTMLNames::aria_sortAttr)) {
 477         switch (coreObject-&gt;sortDirection()) {
 478         case AccessibilitySortDirection::Invalid:
 479             break;
 480         case AccessibilitySortDirection::Ascending:
 481             attributeSet = addToAtkAttributeSet(attributeSet, &quot;sort&quot;, &quot;ascending&quot;);
 482             break;
 483         case AccessibilitySortDirection::Descending:
 484             attributeSet = addToAtkAttributeSet(attributeSet, &quot;sort&quot;, &quot;descending&quot;);
 485             break;
 486         case AccessibilitySortDirection::Other:
 487             attributeSet = addToAtkAttributeSet(attributeSet, &quot;sort&quot;, &quot;other&quot;);
 488             break;
 489         case AccessibilitySortDirection::None:
 490             attributeSet = addToAtkAttributeSet(attributeSet, &quot;sort&quot;, &quot;none&quot;);
</pre>
<hr />
<pre>
 503 
 504     String valueDescription = coreObject-&gt;valueDescription();
 505     if (!valueDescription.isEmpty())
 506         attributeSet = addToAtkAttributeSet(attributeSet, &quot;valuetext&quot;, valueDescription.utf8().data());
 507 
 508     // According to the W3C Core Accessibility API Mappings 1.1, section 5.4.1 General Rules:
 509     // &quot;User agents must expose the WAI-ARIA role string if the API supports a mechanism to do so.&quot;
 510     // In the case of ATK, the mechanism to do so is an object attribute pair (xml-roles:&quot;string&quot;).
 511     // We cannot use the computedRoleString for this purpose because it is not limited to elements
 512     // with ARIA roles, and it might not contain the actual ARIA role value (e.g. DPub ARIA).
 513     String roleString = coreObject-&gt;getAttribute(HTMLNames::roleAttr);
 514     if (!roleString.isEmpty())
 515         attributeSet = addToAtkAttributeSet(attributeSet, &quot;xml-roles&quot;, roleString.utf8().data());
 516 
 517     String computedRoleString = coreObject-&gt;computedRoleString();
 518     if (!computedRoleString.isEmpty()) {
 519         attributeSet = addToAtkAttributeSet(attributeSet, &quot;computed-role&quot;, computedRoleString.utf8().data());
 520 
 521         // The HTML AAM maps several elements to ARIA landmark roles. In order for the type of landmark
 522         // to be obtainable in the same fashion as an ARIA landmark, fall back on the computedRoleString.
<span class="line-modified"> 523         // We also want to do this for the style-format-group element types so that the type of format</span>
<span class="line-added"> 524         // group it is doesn&#39;t get lost to a generic platform role.</span>
<span class="line-added"> 525         if (coreObject-&gt;ariaRoleAttribute() == AccessibilityRole::Unknown</span>
<span class="line-added"> 526             &amp;&amp; (coreObject-&gt;isLandmark() || coreObject-&gt;isStyleFormatGroup()))</span>
 527             attributeSet = addToAtkAttributeSet(attributeSet, &quot;xml-roles&quot;, computedRoleString.utf8().data());
 528     }
 529 
 530     String roleDescription = coreObject-&gt;roleDescription();
 531     if (!roleDescription.isEmpty())
 532         attributeSet = addToAtkAttributeSet(attributeSet, &quot;roledescription&quot;, roleDescription.utf8().data());
 533 
 534     // We need to expose the live region attributes even if the live region is currently disabled/off.
 535     if (auto liveContainer = coreObject-&gt;liveRegionAncestor(false)) {
 536         String liveStatus = liveContainer-&gt;liveRegionStatus();
 537         String relevant = liveContainer-&gt;liveRegionRelevant();
<span class="line-modified"> 538         bool isAtom = liveContainer-&gt;liveRegionAtomic();</span>
 539         String liveRole = roleString.isEmpty() ? computedRoleString : roleString;
 540 
 541         // According to the Core AAM, we need to expose the above properties with &quot;container-&quot; prefixed
 542         // object attributes regardless of whether the container is this object, or an ancestor of it.
 543         attributeSet = addToAtkAttributeSet(attributeSet, &quot;container-live&quot;, liveStatus.utf8().data());
 544         attributeSet = addToAtkAttributeSet(attributeSet, &quot;container-relevant&quot;, relevant.utf8().data());
<span class="line-modified"> 545         if (isAtom)</span>
 546             attributeSet = addToAtkAttributeSet(attributeSet, &quot;container-atomic&quot;, &quot;true&quot;);
 547         if (!liveRole.isEmpty())
 548             attributeSet = addToAtkAttributeSet(attributeSet, &quot;container-live-role&quot;, liveRole.utf8().data());
 549 
 550         // According to the Core AAM, if this object is the live region (rather than its descendant),
 551         // we must expose the above properties on the object without a &quot;container-&quot; prefix.
 552         if (liveContainer == coreObject) {
 553             attributeSet = addToAtkAttributeSet(attributeSet, &quot;live&quot;, liveStatus.utf8().data());
 554             attributeSet = addToAtkAttributeSet(attributeSet, &quot;relevant&quot;, relevant.utf8().data());
<span class="line-modified"> 555             if (isAtom)</span>
 556                 attributeSet = addToAtkAttributeSet(attributeSet, &quot;atomic&quot;, &quot;true&quot;);
<span class="line-modified"> 557         } else if (!isAtom &amp;&amp; coreObject-&gt;liveRegionAtomic())</span>
 558             attributeSet = addToAtkAttributeSet(attributeSet, &quot;atomic&quot;, &quot;true&quot;);
 559     }
 560 
 561     // The Core AAM states the author-provided value should be exposed as-is.
 562     String dropEffect = coreObject-&gt;getAttribute(HTMLNames::aria_dropeffectAttr);
 563     if (!dropEffect.isEmpty())
 564         attributeSet = addToAtkAttributeSet(attributeSet, &quot;dropeffect&quot;, dropEffect.utf8().data());
 565 
 566     if (coreObject-&gt;isARIAGrabbed())
 567         attributeSet = addToAtkAttributeSet(attributeSet, &quot;grabbed&quot;, &quot;true&quot;);
 568     else if (coreObject-&gt;supportsARIADragging())
 569         attributeSet = addToAtkAttributeSet(attributeSet, &quot;grabbed&quot;, &quot;false&quot;);
 570 
 571     // The Core AAM states the author-provided value should be exposed as-is.
<span class="line-modified"> 572     const AtomString&amp; keyShortcuts = coreObject-&gt;keyShortcutsValue();</span>
 573     if (!keyShortcuts.isEmpty())
 574         attributeSet = addToAtkAttributeSet(attributeSet, &quot;keyshortcuts&quot;, keyShortcuts.string().utf8().data());
 575 
 576     return attributeSet;
 577 }
 578 
 579 static AtkRole atkRole(AccessibilityObject* coreObject)
 580 {
 581     switch (coreObject-&gt;roleValue()) {
 582     case AccessibilityRole::ApplicationAlert:
 583         return ATK_ROLE_ALERT;
 584     case AccessibilityRole::ApplicationAlertDialog:
 585     case AccessibilityRole::ApplicationDialog:
 586         return ATK_ROLE_DIALOG;
 587     case AccessibilityRole::ApplicationStatus:
 588         return ATK_ROLE_STATUSBAR;
 589     case AccessibilityRole::Unknown:
 590         return ATK_ROLE_UNKNOWN;
 591     case AccessibilityRole::Audio:

 592         return ATK_ROLE_AUDIO;

 593     case AccessibilityRole::Video:

 594         return ATK_ROLE_VIDEO;


 595     case AccessibilityRole::Button:
 596         return ATK_ROLE_PUSH_BUTTON;
 597     case AccessibilityRole::Switch:
 598     case AccessibilityRole::ToggleButton:
 599         return ATK_ROLE_TOGGLE_BUTTON;
 600     case AccessibilityRole::RadioButton:
 601         return ATK_ROLE_RADIO_BUTTON;
 602     case AccessibilityRole::CheckBox:
 603         return ATK_ROLE_CHECK_BOX;
 604     case AccessibilityRole::Slider:
 605         return ATK_ROLE_SLIDER;
 606     case AccessibilityRole::TabGroup:
 607     case AccessibilityRole::TabList:
 608         return ATK_ROLE_PAGE_TAB_LIST;
 609     case AccessibilityRole::TextField:
 610     case AccessibilityRole::TextArea:
 611     case AccessibilityRole::SearchField:
 612         return ATK_ROLE_ENTRY;
 613     case AccessibilityRole::StaticText:

 614         return ATK_ROLE_STATIC;



 615     case AccessibilityRole::Outline:
 616     case AccessibilityRole::Tree:
 617         return ATK_ROLE_TREE;
 618     case AccessibilityRole::TreeItem:
 619         return ATK_ROLE_TREE_ITEM;
 620     case AccessibilityRole::MenuBar:
 621         return ATK_ROLE_MENU_BAR;
 622     case AccessibilityRole::MenuListPopup:
 623     case AccessibilityRole::Menu:
 624         return ATK_ROLE_MENU;
 625     case AccessibilityRole::MenuListOption:
 626     case AccessibilityRole::MenuItem:
 627     case AccessibilityRole::MenuButton:
 628         return ATK_ROLE_MENU_ITEM;
 629     case AccessibilityRole::MenuItemCheckbox:
 630         return ATK_ROLE_CHECK_MENU_ITEM;
 631     case AccessibilityRole::MenuItemRadio:
 632         return ATK_ROLE_RADIO_MENU_ITEM;
 633     case AccessibilityRole::Column:
 634         // return ATK_ROLE_TABLE_COLUMN_HEADER; // Is this right?
 635         return ATK_ROLE_UNKNOWN; // Matches Mozilla
 636     case AccessibilityRole::Row:
 637         return ATK_ROLE_TABLE_ROW;
 638     case AccessibilityRole::Toolbar:
 639         return ATK_ROLE_TOOL_BAR;
<span class="line-added"> 640     case AccessibilityRole::Meter:</span>
<span class="line-added"> 641         return ATK_ROLE_LEVEL_BAR;</span>
 642     case AccessibilityRole::BusyIndicator:

 643     case AccessibilityRole::ProgressIndicator:
<span class="line-modified"> 644         return ATK_ROLE_PROGRESS_BAR;</span>
 645     case AccessibilityRole::Window:
 646         return ATK_ROLE_WINDOW;
 647     case AccessibilityRole::PopUpButton:
 648         return coreObject-&gt;hasPopup() ? ATK_ROLE_PUSH_BUTTON : ATK_ROLE_COMBO_BOX;
 649     case AccessibilityRole::ComboBox:
 650         return ATK_ROLE_COMBO_BOX;
 651     case AccessibilityRole::SplitGroup:
 652         return ATK_ROLE_SPLIT_PANE;
 653     case AccessibilityRole::Splitter:
 654         return ATK_ROLE_SEPARATOR;

 655 #if PLATFORM(GTK)
<span class="line-added"> 656     case AccessibilityRole::ColorWell:</span>
 657         // ATK_ROLE_COLOR_CHOOSER is defined as a dialog (i.e. it&#39;s what appears when you push the button).
 658         return ATK_ROLE_PUSH_BUTTON;
 659 #endif
 660     case AccessibilityRole::List:
 661         return ATK_ROLE_LIST;
 662     case AccessibilityRole::ScrollBar:
 663         return ATK_ROLE_SCROLL_BAR;
 664     case AccessibilityRole::ScrollArea:
 665     case AccessibilityRole::TabPanel:
 666         return ATK_ROLE_SCROLL_PANE;
 667     case AccessibilityRole::Grid:
 668     case AccessibilityRole::Table:
 669         return ATK_ROLE_TABLE;
 670     case AccessibilityRole::TreeGrid:
 671         return ATK_ROLE_TREE_TABLE;
 672     case AccessibilityRole::Application:
 673         return ATK_ROLE_APPLICATION;
 674     case AccessibilityRole::ApplicationGroup:
 675     case AccessibilityRole::Feed:
 676     case AccessibilityRole::Figure:
</pre>
<hr />
<pre>
 683         return ATK_ROLE_ROW_HEADER;
 684     case AccessibilityRole::ColumnHeader:
 685         return ATK_ROLE_COLUMN_HEADER;
 686     case AccessibilityRole::Caption:
 687         return ATK_ROLE_CAPTION;
 688     case AccessibilityRole::Cell:
 689     case AccessibilityRole::GridCell:
 690         return coreObject-&gt;inheritsPresentationalRole() ? ATK_ROLE_SECTION : ATK_ROLE_TABLE_CELL;
 691     case AccessibilityRole::Link:
 692     case AccessibilityRole::WebCoreLink:
 693     case AccessibilityRole::ImageMapLink:
 694         return ATK_ROLE_LINK;
 695     case AccessibilityRole::ImageMap:
 696         return ATK_ROLE_IMAGE_MAP;
 697     case AccessibilityRole::GraphicsSymbol:
 698     case AccessibilityRole::Image:
 699         return ATK_ROLE_IMAGE;
 700     case AccessibilityRole::ListMarker:
 701         return ATK_ROLE_TEXT;
 702     case AccessibilityRole::DocumentArticle:

 703         return ATK_ROLE_ARTICLE;

 704     case AccessibilityRole::Document:
 705     case AccessibilityRole::GraphicsDocument:
 706         return ATK_ROLE_DOCUMENT_FRAME;
 707     case AccessibilityRole::DocumentNote:
 708         return ATK_ROLE_COMMENT;
 709     case AccessibilityRole::Heading:
 710         return ATK_ROLE_HEADING;
 711     case AccessibilityRole::ListBox:
 712         // https://rawgit.com/w3c/aria/master/core-aam/core-aam.html#role-map-listbox
 713         return coreObject-&gt;isDescendantOfRole(AccessibilityRole::ComboBox) ? ATK_ROLE_MENU : ATK_ROLE_LIST_BOX;
 714     case AccessibilityRole::ListItem:
 715         return coreObject-&gt;inheritsPresentationalRole() ? ATK_ROLE_SECTION : ATK_ROLE_LIST_ITEM;
 716     case AccessibilityRole::ListBoxOption:
 717         return coreObject-&gt;isDescendantOfRole(AccessibilityRole::ComboBox) ? ATK_ROLE_MENU_ITEM : ATK_ROLE_LIST_ITEM;
 718     case AccessibilityRole::Paragraph:
 719         return ATK_ROLE_PARAGRAPH;
 720     case AccessibilityRole::Label:
 721     case AccessibilityRole::Legend:
 722         return ATK_ROLE_LABEL;
 723     case AccessibilityRole::Blockquote:

 724         return ATK_ROLE_BLOCK_QUOTE;


 725 #if ATK_CHECK_VERSION(2, 25, 2)
<span class="line-added"> 726     case AccessibilityRole::Footnote:</span>
 727         return ATK_ROLE_FOOTNOTE;
 728 #endif
 729     case AccessibilityRole::ApplicationTextGroup:
 730     case AccessibilityRole::Div:
 731     case AccessibilityRole::Pre:
 732     case AccessibilityRole::SVGText:
 733     case AccessibilityRole::TextGroup:
 734         return ATK_ROLE_SECTION;
 735     case AccessibilityRole::Footer:
 736         return ATK_ROLE_FOOTER;
 737     case AccessibilityRole::Form:

 738         if (coreObject-&gt;ariaRoleAttribute() != AccessibilityRole::Unknown)
 739             return ATK_ROLE_LANDMARK;

 740         return ATK_ROLE_FORM;
 741     case AccessibilityRole::Canvas:
 742         return ATK_ROLE_CANVAS;
 743     case AccessibilityRole::HorizontalRule:
 744         return ATK_ROLE_SEPARATOR;
 745     case AccessibilityRole::SpinButton:
 746         return ATK_ROLE_SPIN_BUTTON;
 747     case AccessibilityRole::Tab:
 748         return ATK_ROLE_PAGE_TAB;
 749     case AccessibilityRole::UserInterfaceTooltip:
 750         return ATK_ROLE_TOOL_TIP;
 751     case AccessibilityRole::WebArea:
 752         return ATK_ROLE_DOCUMENT_WEB;
 753     case AccessibilityRole::WebApplication:
 754         return ATK_ROLE_EMBEDDED;

 755     case AccessibilityRole::ApplicationLog:
 756         return ATK_ROLE_LOG;
 757     case AccessibilityRole::ApplicationMarquee:
 758         return ATK_ROLE_MARQUEE;
 759     case AccessibilityRole::ApplicationTimer:
 760         return ATK_ROLE_TIMER;
 761     case AccessibilityRole::Definition:
 762         return ATK_ROLE_DEFINITION;
 763     case AccessibilityRole::DocumentMath:
 764         return ATK_ROLE_MATH;
 765     case AccessibilityRole::MathElement:
 766         if (coreObject-&gt;isMathRow())
 767             return ATK_ROLE_PANEL;
 768         if (coreObject-&gt;isMathTable())
 769             return ATK_ROLE_TABLE;
 770         if (coreObject-&gt;isMathTableRow())
 771             return ATK_ROLE_TABLE_ROW;
 772         if (coreObject-&gt;isMathTableCell())
 773             return ATK_ROLE_TABLE_CELL;
 774         if (coreObject-&gt;isMathSubscriptSuperscript() || coreObject-&gt;isMathMultiscript())
 775             return ATK_ROLE_SECTION;

 776         if (coreObject-&gt;isMathFraction())
 777             return ATK_ROLE_MATH_FRACTION;
 778         if (coreObject-&gt;isMathSquareRoot() || coreObject-&gt;isMathRoot())
 779             return ATK_ROLE_MATH_ROOT;
 780         if (coreObject-&gt;isMathScriptObject(AccessibilityMathScriptObjectType::Subscript)
 781             || coreObject-&gt;isMathMultiscriptObject(AccessibilityMathMultiscriptObjectType::PreSubscript) || coreObject-&gt;isMathMultiscriptObject(AccessibilityMathMultiscriptObjectType::PostSubscript))
 782             return ATK_ROLE_SUBSCRIPT;
 783         if (coreObject-&gt;isMathScriptObject(AccessibilityMathScriptObjectType::Superscript)
 784             || coreObject-&gt;isMathMultiscriptObject(AccessibilityMathMultiscriptObjectType::PreSuperscript) || coreObject-&gt;isMathMultiscriptObject(AccessibilityMathMultiscriptObjectType::PostSuperscript))
 785             return ATK_ROLE_SUPERSCRIPT;


 786         if (coreObject-&gt;isMathToken())
 787             return ATK_ROLE_STATIC;

 788         return ATK_ROLE_UNKNOWN;
 789     case AccessibilityRole::LandmarkBanner:
 790     case AccessibilityRole::LandmarkComplementary:
 791     case AccessibilityRole::LandmarkContentInfo:
 792     case AccessibilityRole::LandmarkDocRegion:
 793     case AccessibilityRole::LandmarkMain:
 794     case AccessibilityRole::LandmarkNavigation:
 795     case AccessibilityRole::LandmarkRegion:
 796     case AccessibilityRole::LandmarkSearch:
 797         return ATK_ROLE_LANDMARK;


 798     case AccessibilityRole::DescriptionList:
 799         return ATK_ROLE_DESCRIPTION_LIST;
 800     case AccessibilityRole::Term:
 801     case AccessibilityRole::DescriptionListTerm:
 802         return ATK_ROLE_DESCRIPTION_TERM;
 803     case AccessibilityRole::DescriptionListDetail:
 804         return ATK_ROLE_DESCRIPTION_VALUE;
<span class="line-added"> 805     case AccessibilityRole::Deletion:</span>
<span class="line-added"> 806 #if ATK_CHECK_VERSION(2, 33, 3)</span>
<span class="line-added"> 807         return ATK_ROLE_CONTENT_DELETION;</span>
<span class="line-added"> 808 #else</span>
<span class="line-added"> 809         return ATK_ROLE_STATIC;</span>
 810 #endif
<span class="line-modified"> 811     case AccessibilityRole::Insertion:</span>
<span class="line-modified"> 812 #if ATK_CHECK_VERSION(2, 33, 3)</span>
<span class="line-modified"> 813         return ATK_ROLE_CONTENT_INSERTION;</span>
<span class="line-modified"> 814 #else</span>




 815         return ATK_ROLE_STATIC;
<span class="line-added"> 816 #endif</span>
<span class="line-added"> 817     case AccessibilityRole::Subscript:</span>
<span class="line-added"> 818         return ATK_ROLE_SUBSCRIPT;</span>
<span class="line-added"> 819     case AccessibilityRole::Superscript:</span>
<span class="line-added"> 820         return ATK_ROLE_SUPERSCRIPT;</span>
<span class="line-added"> 821     case AccessibilityRole::Inline:</span>
 822     case AccessibilityRole::SVGTextPath:
 823     case AccessibilityRole::SVGTSpan:
 824     case AccessibilityRole::Time:
 825         return ATK_ROLE_STATIC;

 826     default:
 827         return ATK_ROLE_UNKNOWN;
 828     }
 829 }
 830 
 831 static AtkRole webkitAccessibleGetRole(AtkObject* object)
 832 {
 833     // ATK_ROLE_UNKNOWN should only be applied in cases where there is a valid
 834     // WebCore accessible object for which the platform role mapping is unknown.
 835     auto* accessible = WEBKIT_ACCESSIBLE(object);
 836     returnValIfWebKitAccessibleIsInvalid(accessible, ATK_ROLE_INVALID);
 837 
 838     // Note: Why doesn&#39;t WebCore have a password field for this
 839     if (accessible-&gt;priv-&gt;object-&gt;isPasswordField())
 840         return ATK_ROLE_PASSWORD_TEXT;
 841 
 842     return atkRole(accessible-&gt;priv-&gt;object);
 843 }
 844 
 845 static bool isTextWithCaret(AccessibilityObject* coreObject)
</pre>
<hr />
<pre>
 868     VisibleSelection selection = coreObject-&gt;selection();
 869     if (!selection.isCaret())
 870         return false;
 871 
 872     return selectionBelongsToObject(coreObject, selection);
 873 }
 874 
 875 static void setAtkStateSetFromCoreObject(AccessibilityObject* coreObject, AtkStateSet* stateSet)
 876 {
 877     AccessibilityObject* parent = coreObject-&gt;parentObject();
 878     bool isListBoxOption = parent &amp;&amp; parent-&gt;isListBox();
 879 
 880     // Please keep the state list in alphabetical order
 881     if ((isListBoxOption &amp;&amp; coreObject-&gt;isSelectedOptionActive())
 882         || coreObject-&gt;currentState() != AccessibilityCurrentState::False)
 883         atk_state_set_add_state(stateSet, ATK_STATE_ACTIVE);
 884 
 885     if (coreObject-&gt;isBusy())
 886         atk_state_set_add_state(stateSet, ATK_STATE_BUSY);
 887 

 888     if (coreObject-&gt;supportsChecked() &amp;&amp; coreObject-&gt;canSetValueAttribute())
 889         atk_state_set_add_state(stateSet, ATK_STATE_CHECKABLE);

 890 
 891     if (coreObject-&gt;isChecked())
 892         atk_state_set_add_state(stateSet, ATK_STATE_CHECKED);
 893 
 894     if ((coreObject-&gt;isTextControl() || coreObject-&gt;isNonNativeTextControl()) &amp;&amp; coreObject-&gt;canSetValueAttribute())
 895         atk_state_set_add_state(stateSet, ATK_STATE_EDITABLE);
 896 
 897     // FIXME: Put both ENABLED and SENSITIVE together here for now
 898     if (coreObject-&gt;isEnabled()) {
 899         atk_state_set_add_state(stateSet, ATK_STATE_ENABLED);
 900         atk_state_set_add_state(stateSet, ATK_STATE_SENSITIVE);
 901     }
 902 
 903     if (coreObject-&gt;canSetExpandedAttribute())
 904         atk_state_set_add_state(stateSet, ATK_STATE_EXPANDABLE);
 905 
 906     if (coreObject-&gt;isExpanded())
 907         atk_state_set_add_state(stateSet, ATK_STATE_EXPANDED);
 908 
 909     if (coreObject-&gt;canSetFocusAttribute())
</pre>
<hr />
<pre>
 931         atk_state_set_add_state(stateSet, ATK_STATE_INDETERMINATE);
 932     else if (coreObject-&gt;isCheckboxOrRadio() || coreObject-&gt;isMenuItem() || coreObject-&gt;isToggleButton()) {
 933         if (coreObject-&gt;checkboxOrRadioValue() == AccessibilityButtonState::Mixed)
 934             atk_state_set_add_state(stateSet, ATK_STATE_INDETERMINATE);
 935     }
 936 
 937     if (coreObject-&gt;isModalNode())
 938         atk_state_set_add_state(stateSet, ATK_STATE_MODAL);
 939 
 940     if (coreObject-&gt;invalidStatus() != &quot;false&quot;)
 941         atk_state_set_add_state(stateSet, ATK_STATE_INVALID_ENTRY);
 942 
 943     if (coreObject-&gt;isMultiSelectable())
 944         atk_state_set_add_state(stateSet, ATK_STATE_MULTISELECTABLE);
 945 
 946     // TODO: ATK_STATE_OPAQUE
 947 
 948     if (coreObject-&gt;isPressed())
 949         atk_state_set_add_state(stateSet, ATK_STATE_PRESSED);
 950 

 951     if (!coreObject-&gt;canSetValueAttribute() &amp;&amp; (coreObject-&gt;supportsReadOnly()))
 952         atk_state_set_add_state(stateSet, ATK_STATE_READ_ONLY);

 953 
 954     if (coreObject-&gt;isRequired())
 955         atk_state_set_add_state(stateSet, ATK_STATE_REQUIRED);
 956 
 957     // TODO: ATK_STATE_SELECTABLE_TEXT
 958 
 959     if (coreObject-&gt;canSetSelectedAttribute()) {
 960         atk_state_set_add_state(stateSet, ATK_STATE_SELECTABLE);
 961         // Items in focusable lists have both STATE_SELECT{ABLE,ED}
 962         // and STATE_FOCUS{ABLE,ED}. We&#39;ll fake the latter based on
 963         // the former.
 964         if (isListBoxOption)
 965             atk_state_set_add_state(stateSet, ATK_STATE_FOCUSABLE);
 966     }
 967 
 968     if (coreObject-&gt;isSelected()) {
 969         atk_state_set_add_state(stateSet, ATK_STATE_SELECTED);
 970         // Items in focusable lists have both STATE_SELECT{ABLE,ED}
 971         // and STATE_FOCUS{ABLE,ED}. We&#39;ll fake the latter based on the
 972         // former.
</pre>
<hr />
<pre>
1078     atkObjectClass-&gt;get_description = webkitAccessibleGetDescription;
1079     atkObjectClass-&gt;get_parent = webkitAccessibleGetParent;
1080     atkObjectClass-&gt;get_n_children = webkitAccessibleGetNChildren;
1081     atkObjectClass-&gt;ref_child = webkitAccessibleRefChild;
1082     atkObjectClass-&gt;get_role = webkitAccessibleGetRole;
1083     atkObjectClass-&gt;ref_state_set = webkitAccessibleRefStateSet;
1084     atkObjectClass-&gt;get_index_in_parent = webkitAccessibleGetIndexInParent;
1085     atkObjectClass-&gt;get_attributes = webkitAccessibleGetAttributes;
1086     atkObjectClass-&gt;ref_relation_set = webkitAccessibleRefRelationSet;
1087     atkObjectClass-&gt;get_object_locale = webkitAccessibleGetObjectLocale;
1088 }
1089 
1090 static const GInterfaceInfo atkInterfacesInitFunctions[] = {
1091     {reinterpret_cast&lt;GInterfaceInitFunc&gt;(reinterpret_cast&lt;GCallback&gt;(webkitAccessibleActionInterfaceInit)), nullptr, nullptr},
1092     {reinterpret_cast&lt;GInterfaceInitFunc&gt;(reinterpret_cast&lt;GCallback&gt;(webkitAccessibleSelectionInterfaceInit)), nullptr, nullptr},
1093     {reinterpret_cast&lt;GInterfaceInitFunc&gt;(reinterpret_cast&lt;GCallback&gt;(webkitAccessibleEditableTextInterfaceInit)), nullptr, nullptr},
1094     {reinterpret_cast&lt;GInterfaceInitFunc&gt;(reinterpret_cast&lt;GCallback&gt;(webkitAccessibleTextInterfaceInit)), nullptr, nullptr},
1095     {reinterpret_cast&lt;GInterfaceInitFunc&gt;(reinterpret_cast&lt;GCallback&gt;(webkitAccessibleComponentInterfaceInit)), nullptr, nullptr},
1096     {reinterpret_cast&lt;GInterfaceInitFunc&gt;(reinterpret_cast&lt;GCallback&gt;(webkitAccessibleImageInterfaceInit)), nullptr, nullptr},
1097     {reinterpret_cast&lt;GInterfaceInitFunc&gt;(reinterpret_cast&lt;GCallback&gt;(webkitAccessibleTableInterfaceInit)), nullptr, nullptr},

1098     {reinterpret_cast&lt;GInterfaceInitFunc&gt;(reinterpret_cast&lt;GCallback&gt;(webkitAccessibleTableCellInterfaceInit)), nullptr, nullptr},

1099     {reinterpret_cast&lt;GInterfaceInitFunc&gt;(reinterpret_cast&lt;GCallback&gt;(webkitAccessibleHypertextInterfaceInit)), nullptr, nullptr},
1100     {reinterpret_cast&lt;GInterfaceInitFunc&gt;(reinterpret_cast&lt;GCallback&gt;(webkitAccessibleHyperlinkImplInterfaceInit)), nullptr, nullptr},
1101     {reinterpret_cast&lt;GInterfaceInitFunc&gt;(reinterpret_cast&lt;GCallback&gt;(webkitAccessibleDocumentInterfaceInit)), nullptr, nullptr},
1102     {reinterpret_cast&lt;GInterfaceInitFunc&gt;(reinterpret_cast&lt;GCallback&gt;(webkitAccessibleValueInterfaceInit)), nullptr, nullptr}
1103 };
1104 
1105 enum WAIType {
1106     WAIAction,
1107     WAISelection,
1108     WAIEditableText,
1109     WAIText,
1110     WAIComponent,
1111     WAIImage,
1112     WAITable,

1113     WAITableCell,

1114     WAIHypertext,
1115     WAIHyperlink,
1116     WAIDocument,
1117     WAIValue,
1118 };
1119 
1120 static GType atkInterfaceTypeFromWAIType(WAIType type)
1121 {
1122     switch (type) {
1123     case WAIAction:
1124         return ATK_TYPE_ACTION;
1125     case WAISelection:
1126         return ATK_TYPE_SELECTION;
1127     case WAIEditableText:
1128         return ATK_TYPE_EDITABLE_TEXT;
1129     case WAIText:
1130         return ATK_TYPE_TEXT;
1131     case WAIComponent:
1132         return ATK_TYPE_COMPONENT;
1133     case WAIImage:
1134         return ATK_TYPE_IMAGE;
1135     case WAITable:
1136         return ATK_TYPE_TABLE;

1137     case WAITableCell:
1138         return ATK_TYPE_TABLE_CELL;

1139     case WAIHypertext:
1140         return ATK_TYPE_HYPERTEXT;
1141     case WAIHyperlink:
1142         return ATK_TYPE_HYPERLINK_IMPL;
1143     case WAIDocument:
1144         return ATK_TYPE_DOCUMENT;
1145     case WAIValue:
1146         return ATK_TYPE_VALUE;
1147     }
1148 
1149     return G_TYPE_INVALID;
1150 }
1151 
1152 static bool roleIsTextType(AccessibilityRole role)
1153 {
1154     return role == AccessibilityRole::Paragraph
1155         || role == AccessibilityRole::Heading
1156         || role == AccessibilityRole::Div
1157         || role == AccessibilityRole::Cell
1158         || role == AccessibilityRole::Link
</pre>
<hr />
<pre>
1209                 interfaceMask |= 1 &lt;&lt; WAIText;
1210         }
1211 
1212         // Add the TEXT interface for list items whose
1213         // first accessible child has a text renderer
1214         if (role == AccessibilityRole::ListItem) {
1215             const auto&amp; children = coreObject-&gt;children();
1216             if (!children.isEmpty())
1217                 interfaceMask |= interfaceMaskFromObject(children[0].get());
1218         }
1219     }
1220 
1221     // Image
1222     if (coreObject-&gt;isImage())
1223         interfaceMask |= 1 &lt;&lt; WAIImage;
1224 
1225     // Table
1226     if (coreObject-&gt;isTable())
1227         interfaceMask |= 1 &lt;&lt; WAITable;
1228 

1229     if (role == AccessibilityRole::Cell || role == AccessibilityRole::GridCell || role == AccessibilityRole::ColumnHeader || role == AccessibilityRole::RowHeader)
1230         interfaceMask |= 1 &lt;&lt; WAITableCell;

1231 
1232     // Document
1233     if (role == AccessibilityRole::WebArea)
1234         interfaceMask |= 1 &lt;&lt; WAIDocument;
1235 
1236     // Value
1237     if (coreObject-&gt;supportsRangeValue())
1238         interfaceMask |= 1 &lt;&lt; WAIValue;
1239 
1240 #if ENABLE(INPUT_TYPE_COLOR)
1241     // Color type.
1242     if (role == AccessibilityRole::ColorWell)
1243         interfaceMask |= 1 &lt;&lt; WAIText;
1244 #endif
1245 
1246     return interfaceMask;
1247 }
1248 
1249 static const char* uniqueAccessibilityTypeName(guint16 interfaceMask)
1250 {
</pre>
<hr />
<pre>
1352         propertyPtr = &amp;priv-&gt;documentEncoding;
1353         break;
1354     case AtkCachedDocumentURI:
1355         propertyPtr = &amp;priv-&gt;documentURI;
1356         break;
1357     case AtkCachedImageDescription:
1358         propertyPtr = &amp;priv-&gt;imageDescription;
1359         break;
1360     default:
1361         ASSERT_NOT_REACHED();
1362     }
1363 
1364     // Don&#39;t invalidate old memory if not stricly needed, since other
1365     // callers might be still holding on to it.
1366     if (*propertyPtr != value)
1367         *propertyPtr = WTFMove(value);
1368 
1369     return (*propertyPtr).data();
1370 }
1371 
<span class="line-modified">1372 #endif // ENABLE(ACCESSIBILITY)</span>
</pre>
</td>
</tr>
</table>
<center><a href="AccessibilityObjectAtk.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="WebKitAccessible.h.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>