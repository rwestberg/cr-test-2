<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff modules/javafx.web/src/main/native/Source/WebCore/loader/ResourceLoadObserver.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="ResourceLoadNotifier.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="ResourceLoadObserver.h.sdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/loader/ResourceLoadObserver.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 13  * THIS SOFTWARE IS PROVIDED BY APPLE INC. AND ITS CONTRIBUTORS ``AS IS&#39;&#39;
 14  * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO,
 15  * THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
 16  * PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL APPLE INC. OR ITS CONTRIBUTORS
 17  * BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
 18  * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
 19  * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
 20  * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
 21  * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
 22  * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF
 23  * THE POSSIBILITY OF SUCH DAMAGE.
 24  */
 25 
 26 #include &quot;config.h&quot;
 27 #include &quot;ResourceLoadObserver.h&quot;
 28 
 29 #include &quot;DeprecatedGlobalSettings.h&quot;
 30 #include &quot;Document.h&quot;
 31 #include &quot;Frame.h&quot;
 32 #include &quot;FrameLoader.h&quot;

 33 #include &quot;HTMLFrameOwnerElement.h&quot;
 34 #include &quot;Logging.h&quot;
 35 #include &quot;Page.h&quot;

 36 #include &quot;ResourceLoadStatistics.h&quot;
 37 #include &quot;ResourceRequest.h&quot;
 38 #include &quot;ResourceResponse.h&quot;
 39 #include &quot;RuntimeEnabledFeatures.h&quot;
 40 #include &quot;ScriptExecutionContext.h&quot;
 41 #include &quot;SecurityOrigin.h&quot;
 42 #include &quot;Settings.h&quot;
 43 #include &lt;wtf/URL.h&gt;
 44 
 45 namespace WebCore {
 46 
<span class="line-modified"> 47 template&lt;typename T&gt; static inline String primaryDomain(const T&amp; value)</span>



 48 {
<span class="line-removed"> 49     return ResourceLoadStatistics::primaryDomain(value);</span>
 50 }
 51 
<span class="line-removed"> 52 static const Seconds minimumNotificationInterval { 5_s };</span>
<span class="line-removed"> 53 </span>
 54 ResourceLoadObserver&amp; ResourceLoadObserver::shared()
 55 {
 56     static NeverDestroyed&lt;ResourceLoadObserver&gt; resourceLoadObserver;
 57     return resourceLoadObserver;
 58 }
 59 
<span class="line-modified"> 60 void ResourceLoadObserver::setNotificationCallback(WTF::Function&lt;void (Vector&lt;ResourceLoadStatistics&gt;&amp;&amp;)&gt;&amp;&amp; notificationCallback)</span>
 61 {
 62     ASSERT(!m_notificationCallback);
 63     m_notificationCallback = WTFMove(notificationCallback);
 64 }
 65 
<span class="line-modified"> 66 void ResourceLoadObserver::setRequestStorageAccessUnderOpenerCallback(WTF::Function&lt;void(const String&amp; domainInNeedOfStorageAccess, uint64_t openerPageID, const String&amp; openerDomain)&gt;&amp;&amp; callback)</span>
 67 {
 68     ASSERT(!m_requestStorageAccessUnderOpenerCallback);
 69     m_requestStorageAccessUnderOpenerCallback = WTFMove(callback);
 70 }
 71 
<span class="line-modified"> 72 void ResourceLoadObserver::setLogUserInteractionNotificationCallback(Function&lt;void(PAL::SessionID, const String&amp;)&gt;&amp;&amp; callback)</span>
 73 {
 74     ASSERT(!m_logUserInteractionNotificationCallback);
 75     m_logUserInteractionNotificationCallback = WTFMove(callback);
 76 }
 77 
<span class="line-removed"> 78 void ResourceLoadObserver::setLogWebSocketLoadingNotificationCallback(Function&lt;void(PAL::SessionID, const String&amp;, const String&amp;, WallTime)&gt;&amp;&amp; callback)</span>
<span class="line-removed"> 79 {</span>
<span class="line-removed"> 80     ASSERT(!m_logWebSocketLoadingNotificationCallback);</span>
<span class="line-removed"> 81     m_logWebSocketLoadingNotificationCallback = WTFMove(callback);</span>
<span class="line-removed"> 82 }</span>
<span class="line-removed"> 83 </span>
<span class="line-removed"> 84 void ResourceLoadObserver::setLogSubresourceLoadingNotificationCallback(Function&lt;void(PAL::SessionID, const String&amp;, const String&amp;, WallTime)&gt;&amp;&amp; callback)</span>
<span class="line-removed"> 85 {</span>
<span class="line-removed"> 86     ASSERT(!m_logSubresourceLoadingNotificationCallback);</span>
<span class="line-removed"> 87     m_logSubresourceLoadingNotificationCallback = WTFMove(callback);</span>
<span class="line-removed"> 88 }</span>
<span class="line-removed"> 89 </span>
<span class="line-removed"> 90 void ResourceLoadObserver::setLogSubresourceRedirectNotificationCallback(Function&lt;void(PAL::SessionID, const String&amp;, const String&amp;)&gt;&amp;&amp; callback)</span>
<span class="line-removed"> 91 {</span>
<span class="line-removed"> 92     ASSERT(!m_logSubresourceRedirectNotificationCallback);</span>
<span class="line-removed"> 93     m_logSubresourceRedirectNotificationCallback = WTFMove(callback);</span>
<span class="line-removed"> 94 }</span>
<span class="line-removed"> 95 </span>
<span class="line-removed"> 96 ResourceLoadObserver::ResourceLoadObserver()</span>
<span class="line-removed"> 97     : m_notificationTimer(*this, &amp;ResourceLoadObserver::notifyObserver)</span>
<span class="line-removed"> 98 {</span>
<span class="line-removed"> 99 }</span>
<span class="line-removed">100 </span>
101 static inline bool is3xxRedirect(const ResourceResponse&amp; response)
102 {
103     return response.httpStatusCode() &gt;= 300 &amp;&amp; response.httpStatusCode() &lt;= 399;
104 }
105 
<span class="line-modified">106 bool ResourceLoadObserver::shouldLog(bool usesEphemeralSession) const</span>
107 {
<span class="line-modified">108     return DeprecatedGlobalSettings::resourceLoadStatisticsEnabled() &amp;&amp; !usesEphemeralSession &amp;&amp; m_notificationCallback;</span>
109 }
110 
111 void ResourceLoadObserver::logSubresourceLoading(const Frame* frame, const ResourceRequest&amp; newRequest, const ResourceResponse&amp; redirectResponse)
112 {
113     ASSERT(frame-&gt;page());
114 
115     if (!frame)
116         return;
117 
118     auto* page = frame-&gt;page();
<span class="line-modified">119     if (!page || !shouldLog(page-&gt;usesEphemeralSession()))</span>
120         return;
121 
122     bool isRedirect = is3xxRedirect(redirectResponse);
<span class="line-modified">123     const URL&amp; sourceURL = redirectResponse.url();</span>
124     const URL&amp; targetURL = newRequest.url();
<span class="line-modified">125     const URL&amp; mainFrameURL = frame ? frame-&gt;mainFrame().document()-&gt;url() : URL();</span>
126 
127     auto targetHost = targetURL.host();
<span class="line-modified">128     auto mainFrameHost = mainFrameURL.host();</span>
129 
<span class="line-modified">130     if (targetHost.isEmpty() || mainFrameHost.isEmpty() || targetHost == mainFrameHost || (isRedirect &amp;&amp; targetHost == sourceURL.host()))</span>
131         return;
132 
<span class="line-modified">133     auto targetPrimaryDomain = primaryDomain(targetURL);</span>
<span class="line-modified">134     auto mainFramePrimaryDomain = primaryDomain(mainFrameURL);</span>
<span class="line-modified">135     auto sourcePrimaryDomain = primaryDomain(sourceURL);</span>
136 
<span class="line-modified">137     if (targetPrimaryDomain == mainFramePrimaryDomain || (isRedirect &amp;&amp; targetPrimaryDomain == sourcePrimaryDomain))</span>
138         return;
139 
<span class="line-removed">140     bool shouldCallNotificationCallback = false;</span>
141     {
<span class="line-modified">142         auto&amp; targetStatistics = ensureResourceStatisticsForPrimaryDomain(targetPrimaryDomain);</span>
143         auto lastSeen = ResourceLoadStatistics::reduceTimeResolution(WallTime::now());
144         targetStatistics.lastSeen = lastSeen;
<span class="line-modified">145         if (targetStatistics.subresourceUnderTopFrameOrigins.add(mainFramePrimaryDomain).isNewEntry)</span>
<span class="line-removed">146             shouldCallNotificationCallback = true;</span>
147 
<span class="line-modified">148         m_logSubresourceLoadingNotificationCallback(page-&gt;sessionID(), targetPrimaryDomain, mainFramePrimaryDomain, lastSeen);</span>
149     }
150 
151     if (isRedirect) {
<span class="line-modified">152         auto&amp; redirectingOriginStatistics = ensureResourceStatisticsForPrimaryDomain(sourcePrimaryDomain);</span>
<span class="line-modified">153         bool isNewRedirectToEntry = redirectingOriginStatistics.subresourceUniqueRedirectsTo.add(targetPrimaryDomain).isNewEntry;</span>
<span class="line-modified">154         auto&amp; targetStatistics = ensureResourceStatisticsForPrimaryDomain(targetPrimaryDomain);</span>
<span class="line-modified">155         bool isNewRedirectFromEntry = targetStatistics.subresourceUniqueRedirectsFrom.add(sourcePrimaryDomain).isNewEntry;</span>
<span class="line-removed">156 </span>
<span class="line-removed">157         if (isNewRedirectToEntry || isNewRedirectFromEntry)</span>
<span class="line-removed">158             shouldCallNotificationCallback = true;</span>
159 
<span class="line-removed">160         m_logSubresourceRedirectNotificationCallback(page-&gt;sessionID(), sourcePrimaryDomain, targetPrimaryDomain);</span>
<span class="line-removed">161     }</span>
<span class="line-removed">162 </span>
<span class="line-removed">163     if (shouldCallNotificationCallback)</span>
164         scheduleNotificationIfNeeded();

165 }
166 
167 void ResourceLoadObserver::logWebSocketLoading(const URL&amp; targetURL, const URL&amp; mainFrameURL, PAL::SessionID sessionID)
168 {
<span class="line-modified">169     if (!shouldLog(sessionID.isEphemeral()))</span>
170         return;
171 
172     auto targetHost = targetURL.host();
173     auto mainFrameHost = mainFrameURL.host();
174 
175     if (targetHost.isEmpty() || mainFrameHost.isEmpty() || targetHost == mainFrameHost)
176         return;
177 
<span class="line-modified">178     auto targetPrimaryDomain = primaryDomain(targetURL);</span>
<span class="line-modified">179     auto mainFramePrimaryDomain = primaryDomain(mainFrameURL);</span>
180 
<span class="line-modified">181     if (targetPrimaryDomain == mainFramePrimaryDomain)</span>
182         return;
183 
184     auto lastSeen = ResourceLoadStatistics::reduceTimeResolution(WallTime::now());
185 
<span class="line-modified">186     auto&amp; targetStatistics = ensureResourceStatisticsForPrimaryDomain(targetPrimaryDomain);</span>
187     targetStatistics.lastSeen = lastSeen;
<span class="line-modified">188     if (targetStatistics.subresourceUnderTopFrameOrigins.add(mainFramePrimaryDomain).isNewEntry)</span>
<span class="line-removed">189         scheduleNotificationIfNeeded();</span>
190 
<span class="line-modified">191     m_logWebSocketLoadingNotificationCallback(sessionID, targetPrimaryDomain, mainFramePrimaryDomain, lastSeen);</span>
192 }
193 
194 void ResourceLoadObserver::logUserInteractionWithReducedTimeResolution(const Document&amp; document)
195 {
<span class="line-modified">196     if (!document.sessionID().isValid() || !shouldLog(document.sessionID().isEphemeral()))</span>
197         return;
198 
199     auto&amp; url = document.url();
<span class="line-modified">200     if (url.protocolIsAbout() || url.isEmpty())</span>
201         return;
202 
<span class="line-modified">203     auto domain = primaryDomain(url);</span>
204     auto newTime = ResourceLoadStatistics::reduceTimeResolution(WallTime::now());
<span class="line-modified">205     auto lastReportedUserInteraction = m_lastReportedUserInteractionMap.get(domain);</span>
206     if (newTime == lastReportedUserInteraction)
207         return;
208 
<span class="line-modified">209     m_lastReportedUserInteractionMap.set(domain, newTime);</span>
210 
<span class="line-modified">211     auto&amp; statistics = ensureResourceStatisticsForPrimaryDomain(domain);</span>
212     statistics.hadUserInteraction = true;
213     statistics.lastSeen = newTime;
214     statistics.mostRecentUserInteractionTime = newTime;
215 
216 #if ENABLE(RESOURCE_LOAD_STATISTICS)
217     if (auto* frame = document.frame()) {
218         if (auto* opener = frame-&gt;loader().opener()) {
219             if (auto* openerDocument = opener-&gt;document()) {
220                 if (auto* openerFrame = openerDocument-&gt;frame()) {
221                     if (auto openerPageID = openerFrame-&gt;loader().client().pageID())
<span class="line-modified">222                         requestStorageAccessUnderOpener(domain, openerPageID.value(), *openerDocument);</span>
223                 }
224             }
225         }
226     }
227 
<span class="line-modified">228     m_logUserInteractionNotificationCallback(document.sessionID(), domain);</span>


229 #endif
230 
<span class="line-removed">231     m_notificationTimer.stop();</span>
<span class="line-removed">232     notifyObserver();</span>
<span class="line-removed">233 </span>
234 #if ENABLE(RESOURCE_LOAD_STATISTICS) &amp;&amp; !RELEASE_LOG_DISABLED
235     if (shouldLogUserInteraction()) {
236         auto counter = ++m_loggingCounter;
237 #define LOCAL_LOG(str, ...) \
238         RELEASE_LOG(ResourceLoadStatistics, &quot;ResourceLoadObserver::logUserInteraction: counter = %&quot; PRIu64 &quot;: &quot; str, counter, ##__VA_ARGS__)
239 
240         auto escapeForJSON = [](String s) {
241             s.replace(&#39;\\&#39;, &quot;\\\\&quot;).replace(&#39;&quot;&#39;, &quot;\\\&quot;&quot;);
242             return s;
243         };
244         auto escapedURL = escapeForJSON(url.string());
<span class="line-modified">245         auto escapedDomain = escapeForJSON(domain);</span>
246 
247         LOCAL_LOG(R&quot;({ &quot;url&quot;: &quot;%{public}s&quot;,)&quot;, escapedURL.utf8().data());
248         LOCAL_LOG(R&quot;(  &quot;domain&quot; : &quot;%{public}s&quot;,)&quot;, escapedDomain.utf8().data());
249         LOCAL_LOG(R&quot;(  &quot;until&quot; : %f })&quot;, newTime.secondsSinceEpoch().seconds());
250 
251 #undef LOCAL_LOG
252     }
253 #endif
254 }
255 
256 #if ENABLE(RESOURCE_LOAD_STATISTICS)
<span class="line-modified">257 void ResourceLoadObserver::requestStorageAccessUnderOpener(const String&amp; domainInNeedOfStorageAccess, uint64_t openerPageID, Document&amp; openerDocument)</span>
258 {
259     auto openerUrl = openerDocument.url();
<span class="line-modified">260     auto openerPrimaryDomain = primaryDomain(openerUrl);</span>
<span class="line-modified">261     if (domainInNeedOfStorageAccess != openerPrimaryDomain</span>
262         &amp;&amp; !openerDocument.hasRequestedPageSpecificStorageAccessWithUserInteraction(domainInNeedOfStorageAccess)
263         &amp;&amp; !equalIgnoringASCIICase(openerUrl.string(), WTF::blankURL())) {
<span class="line-modified">264         m_requestStorageAccessUnderOpenerCallback(domainInNeedOfStorageAccess, openerPageID, openerPrimaryDomain);</span>
265         // Remember user interaction-based requests since they don&#39;t need to be repeated.
266         openerDocument.setHasRequestedPageSpecificStorageAccessWithUserInteraction(domainInNeedOfStorageAccess);
267     }
268 }
269 #endif
270 
271 void ResourceLoadObserver::logFontLoad(const Document&amp; document, const String&amp; familyName, bool loadStatus)
272 {
273 #if ENABLE(WEB_API_STATISTICS)
<span class="line-modified">274     if (!shouldLog(document.sessionID().isEphemeral()))</span>
275         return;
<span class="line-modified">276     auto registrableDomain = primaryDomain(document.url());</span>
<span class="line-modified">277     auto&amp; statistics = ensureResourceStatisticsForPrimaryDomain(registrableDomain);</span>
278     bool shouldCallNotificationCallback = false;
279     if (!loadStatus) {
280         if (statistics.fontsFailedToLoad.add(familyName).isNewEntry)
281             shouldCallNotificationCallback = true;
282     } else {
283         if (statistics.fontsSuccessfullyLoaded.add(familyName).isNewEntry)
284             shouldCallNotificationCallback = true;
285     }
<span class="line-modified">286     auto mainFrameRegistrableDomain = primaryDomain(document.topDocument().url());</span>
<span class="line-modified">287     if (statistics.topFrameRegistrableDomainsWhichAccessedWebAPIs.add(mainFrameRegistrableDomain).isNewEntry)</span>
288         shouldCallNotificationCallback = true;
289     if (shouldCallNotificationCallback)
290         scheduleNotificationIfNeeded();
291 #else
292     UNUSED_PARAM(document);
293     UNUSED_PARAM(familyName);
294     UNUSED_PARAM(loadStatus);
295 #endif
296 }
297 
298 void ResourceLoadObserver::logCanvasRead(const Document&amp; document)
299 {
300 #if ENABLE(WEB_API_STATISTICS)
<span class="line-modified">301     if (!shouldLog(document.sessionID().isEphemeral()))</span>
302         return;
<span class="line-modified">303     auto registrableDomain = primaryDomain(document.url());</span>
<span class="line-modified">304     auto&amp; statistics = ensureResourceStatisticsForPrimaryDomain(registrableDomain);</span>
<span class="line-modified">305     auto mainFrameRegistrableDomain = primaryDomain(document.topDocument().url());</span>
306     statistics.canvasActivityRecord.wasDataRead = true;
<span class="line-modified">307     if (statistics.topFrameRegistrableDomainsWhichAccessedWebAPIs.add(mainFrameRegistrableDomain).isNewEntry)</span>
308         scheduleNotificationIfNeeded();
309 #else
310     UNUSED_PARAM(document);
311 #endif
312 }
313 
314 void ResourceLoadObserver::logCanvasWriteOrMeasure(const Document&amp; document, const String&amp; textWritten)
315 {
316 #if ENABLE(WEB_API_STATISTICS)
<span class="line-modified">317     if (!shouldLog(document.sessionID().isEphemeral()))</span>
318         return;
<span class="line-modified">319     auto registrableDomain = primaryDomain(document.url());</span>
<span class="line-modified">320     auto&amp; statistics = ensureResourceStatisticsForPrimaryDomain(registrableDomain);</span>
321     bool shouldCallNotificationCallback = false;
<span class="line-modified">322     auto mainFrameRegistrableDomain = primaryDomain(document.topDocument().url());</span>
323     if (statistics.canvasActivityRecord.recordWrittenOrMeasuredText(textWritten))
324         shouldCallNotificationCallback = true;
<span class="line-modified">325     if (statistics.topFrameRegistrableDomainsWhichAccessedWebAPIs.add(mainFrameRegistrableDomain).isNewEntry)</span>
326         shouldCallNotificationCallback = true;
327     if (shouldCallNotificationCallback)
328         scheduleNotificationIfNeeded();
329 #else
330     UNUSED_PARAM(document);
331     UNUSED_PARAM(textWritten);
332 #endif
333 }
334 
335 void ResourceLoadObserver::logNavigatorAPIAccessed(const Document&amp; document, const ResourceLoadStatistics::NavigatorAPI functionName)
336 {
337 #if ENABLE(WEB_API_STATISTICS)
<span class="line-modified">338     if (!shouldLog(document.sessionID().isEphemeral()))</span>
339         return;
<span class="line-modified">340     auto registrableDomain = primaryDomain(document.url());</span>
<span class="line-modified">341     auto&amp; statistics = ensureResourceStatisticsForPrimaryDomain(registrableDomain);</span>
342     bool shouldCallNotificationCallback = false;
343     if (!statistics.navigatorFunctionsAccessed.contains(functionName)) {
344         statistics.navigatorFunctionsAccessed.add(functionName);
345         shouldCallNotificationCallback = true;
346     }
<span class="line-modified">347     auto mainFrameRegistrableDomain = primaryDomain(document.topDocument().url());</span>
<span class="line-modified">348     if (statistics.topFrameRegistrableDomainsWhichAccessedWebAPIs.add(mainFrameRegistrableDomain).isNewEntry)</span>
349         shouldCallNotificationCallback = true;
350     if (shouldCallNotificationCallback)
351         scheduleNotificationIfNeeded();
352 #else
353     UNUSED_PARAM(document);
354     UNUSED_PARAM(functionName);
355 #endif
356 }
357 
358 void ResourceLoadObserver::logScreenAPIAccessed(const Document&amp; document, const ResourceLoadStatistics::ScreenAPI functionName)
359 {
360 #if ENABLE(WEB_API_STATISTICS)
<span class="line-modified">361     if (!shouldLog(document.sessionID().isEphemeral()))</span>
362         return;
<span class="line-modified">363     auto registrableDomain = primaryDomain(document.url());</span>
<span class="line-modified">364     auto&amp; statistics = ensureResourceStatisticsForPrimaryDomain(registrableDomain);</span>
365     bool shouldCallNotificationCallback = false;
366     if (!statistics.screenFunctionsAccessed.contains(functionName)) {
367         statistics.screenFunctionsAccessed.add(functionName);
368         shouldCallNotificationCallback = true;
369     }
<span class="line-modified">370     auto mainFrameRegistrableDomain = primaryDomain(document.topDocument().url());</span>
<span class="line-modified">371     if (statistics.topFrameRegistrableDomainsWhichAccessedWebAPIs.add(mainFrameRegistrableDomain).isNewEntry)</span>
372         shouldCallNotificationCallback = true;
373     if (shouldCallNotificationCallback)
374         scheduleNotificationIfNeeded();
375 #else
376     UNUSED_PARAM(document);
377     UNUSED_PARAM(functionName);
378 #endif
379 }
380 
<span class="line-modified">381 ResourceLoadStatistics&amp; ResourceLoadObserver::ensureResourceStatisticsForPrimaryDomain(const String&amp; primaryDomain)</span>
382 {
<span class="line-modified">383     auto addResult = m_resourceStatisticsMap.ensure(primaryDomain, [&amp;primaryDomain] {</span>
<span class="line-modified">384         return ResourceLoadStatistics(primaryDomain);</span>
385     });
<span class="line-modified">386     return addResult.iterator-&gt;value;</span>




387 }
388 
389 void ResourceLoadObserver::scheduleNotificationIfNeeded()
390 {
391     ASSERT(m_notificationCallback);
<span class="line-modified">392     if (m_resourceStatisticsMap.isEmpty()) {</span>
393         m_notificationTimer.stop();
394         return;
395     }
396 
397     if (!m_notificationTimer.isActive())
398         m_notificationTimer.startOneShot(minimumNotificationInterval);
399 }
400 
<span class="line-modified">401 void ResourceLoadObserver::notifyObserver()</span>
402 {
403     ASSERT(m_notificationCallback);
404     m_notificationTimer.stop();
405     m_notificationCallback(takeStatistics());
406 }
407 
<span class="line-modified">408 String ResourceLoadObserver::statisticsForOrigin(const String&amp; origin)</span>
409 {
<span class="line-modified">410     auto iter = m_resourceStatisticsMap.find(origin);</span>
<span class="line-modified">411     if (iter == m_resourceStatisticsMap.end())</span>
412         return emptyString();
413 
<span class="line-modified">414     return &quot;Statistics for &quot; + origin + &quot;:\n&quot; + iter-&gt;value.toString();</span>




415 }
416 
<span class="line-modified">417 Vector&lt;ResourceLoadStatistics&gt; ResourceLoadObserver::takeStatistics()</span>
418 {
<span class="line-modified">419     Vector&lt;ResourceLoadStatistics&gt; statistics;</span>
<span class="line-modified">420     statistics.reserveInitialCapacity(m_resourceStatisticsMap.size());</span>
<span class="line-modified">421     for (auto&amp; statistic : m_resourceStatisticsMap.values())</span>
<span class="line-modified">422         statistics.uncheckedAppend(WTFMove(statistic));</span>

423 
<span class="line-modified">424     m_resourceStatisticsMap.clear();</span>




425 
<span class="line-modified">426     return statistics;</span>

427 }
428 
429 void ResourceLoadObserver::clearState()
430 {
431     m_notificationTimer.stop();
<span class="line-modified">432     m_resourceStatisticsMap.clear();</span>
433     m_lastReportedUserInteractionMap.clear();
434 }
435 
436 URL ResourceLoadObserver::nonNullOwnerURL(const Document&amp; document) const
437 {
438     auto url = document.url();
439     auto* frame = document.frame();
440     auto host = document.url().host();
441 
442     while ((host.isNull() || host.isEmpty()) &amp;&amp; frame &amp;&amp; !frame-&gt;isMainFrame()) {
443         auto* ownerElement = frame-&gt;ownerElement();
444 
445         ASSERT(ownerElement != nullptr);
446 
447         auto&amp; doc = ownerElement-&gt;document();
448         frame = doc.frame();
449         url = doc.url();
450         host = url.host();
451     }
452 
</pre>
</td>
<td>
<hr />
<pre>
 13  * THIS SOFTWARE IS PROVIDED BY APPLE INC. AND ITS CONTRIBUTORS ``AS IS&#39;&#39;
 14  * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO,
 15  * THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
 16  * PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL APPLE INC. OR ITS CONTRIBUTORS
 17  * BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
 18  * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
 19  * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
 20  * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
 21  * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
 22  * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF
 23  * THE POSSIBILITY OF SUCH DAMAGE.
 24  */
 25 
 26 #include &quot;config.h&quot;
 27 #include &quot;ResourceLoadObserver.h&quot;
 28 
 29 #include &quot;DeprecatedGlobalSettings.h&quot;
 30 #include &quot;Document.h&quot;
 31 #include &quot;Frame.h&quot;
 32 #include &quot;FrameLoader.h&quot;
<span class="line-added"> 33 #include &quot;FrameLoaderClient.h&quot;</span>
 34 #include &quot;HTMLFrameOwnerElement.h&quot;
 35 #include &quot;Logging.h&quot;
 36 #include &quot;Page.h&quot;
<span class="line-added"> 37 #include &quot;RegistrableDomain.h&quot;</span>
 38 #include &quot;ResourceLoadStatistics.h&quot;
 39 #include &quot;ResourceRequest.h&quot;
 40 #include &quot;ResourceResponse.h&quot;
 41 #include &quot;RuntimeEnabledFeatures.h&quot;
 42 #include &quot;ScriptExecutionContext.h&quot;
 43 #include &quot;SecurityOrigin.h&quot;
 44 #include &quot;Settings.h&quot;
 45 #include &lt;wtf/URL.h&gt;
 46 
 47 namespace WebCore {
 48 
<span class="line-modified"> 49 static const Seconds minimumNotificationInterval { 5_s };</span>
<span class="line-added"> 50 </span>
<span class="line-added"> 51 ResourceLoadObserver::ResourceLoadObserver()</span>
<span class="line-added"> 52     : m_notificationTimer(*this, &amp;ResourceLoadObserver::updateCentralStatisticsStore)</span>
 53 {

 54 }
 55 


 56 ResourceLoadObserver&amp; ResourceLoadObserver::shared()
 57 {
 58     static NeverDestroyed&lt;ResourceLoadObserver&gt; resourceLoadObserver;
 59     return resourceLoadObserver;
 60 }
 61 
<span class="line-modified"> 62 void ResourceLoadObserver::setStatisticsUpdatedCallback(Function&lt;void(PerSessionResourceLoadData&amp;&amp;)&gt;&amp;&amp; notificationCallback)</span>
 63 {
 64     ASSERT(!m_notificationCallback);
 65     m_notificationCallback = WTFMove(notificationCallback);
 66 }
 67 
<span class="line-modified"> 68 void ResourceLoadObserver::setRequestStorageAccessUnderOpenerCallback(Function&lt;void(PAL::SessionID sessionID, const RegistrableDomain&amp; domainInNeedOfStorageAccess, PageIdentifier openerPageID, const RegistrableDomain&amp; openerDomain)&gt;&amp;&amp; callback)</span>
 69 {
 70     ASSERT(!m_requestStorageAccessUnderOpenerCallback);
 71     m_requestStorageAccessUnderOpenerCallback = WTFMove(callback);
 72 }
 73 
<span class="line-modified"> 74 void ResourceLoadObserver::setLogUserInteractionNotificationCallback(Function&lt;void(PAL::SessionID, const RegistrableDomain&amp;)&gt;&amp;&amp; callback)</span>
 75 {
 76     ASSERT(!m_logUserInteractionNotificationCallback);
 77     m_logUserInteractionNotificationCallback = WTFMove(callback);
 78 }
 79 























 80 static inline bool is3xxRedirect(const ResourceResponse&amp; response)
 81 {
 82     return response.httpStatusCode() &gt;= 300 &amp;&amp; response.httpStatusCode() &lt;= 399;
 83 }
 84 
<span class="line-modified"> 85 bool ResourceLoadObserver::shouldLog(PAL::SessionID sessionID) const</span>
 86 {
<span class="line-modified"> 87     return DeprecatedGlobalSettings::resourceLoadStatisticsEnabled() &amp;&amp; !sessionID.isEphemeral() &amp;&amp; m_notificationCallback;</span>
 88 }
 89 
 90 void ResourceLoadObserver::logSubresourceLoading(const Frame* frame, const ResourceRequest&amp; newRequest, const ResourceResponse&amp; redirectResponse)
 91 {
 92     ASSERT(frame-&gt;page());
 93 
 94     if (!frame)
 95         return;
 96 
 97     auto* page = frame-&gt;page();
<span class="line-modified"> 98     if (!page || !shouldLog(page-&gt;sessionID()))</span>
 99         return;
100 
101     bool isRedirect = is3xxRedirect(redirectResponse);
<span class="line-modified">102     const URL&amp; redirectedFromURL = redirectResponse.url();</span>
103     const URL&amp; targetURL = newRequest.url();
<span class="line-modified">104     const URL&amp; topFrameURL = frame ? frame-&gt;mainFrame().document()-&gt;url() : URL();</span>
105 
106     auto targetHost = targetURL.host();
<span class="line-modified">107     auto topFrameHost = topFrameURL.host();</span>
108 
<span class="line-modified">109     if (targetHost.isEmpty() || topFrameHost.isEmpty() || targetHost == topFrameHost || (isRedirect &amp;&amp; targetHost == redirectedFromURL.host()))</span>
110         return;
111 
<span class="line-modified">112     RegistrableDomain targetDomain { targetURL };</span>
<span class="line-modified">113     RegistrableDomain topFrameDomain { topFrameURL };</span>
<span class="line-modified">114     RegistrableDomain redirectedFromDomain { redirectedFromURL };</span>
115 
<span class="line-modified">116     if (targetDomain == topFrameDomain || (isRedirect &amp;&amp; targetDomain == redirectedFromDomain))</span>
117         return;
118 

119     {
<span class="line-modified">120         auto&amp; targetStatistics = ensureResourceStatisticsForRegistrableDomain(page-&gt;sessionID(), targetDomain);</span>
121         auto lastSeen = ResourceLoadStatistics::reduceTimeResolution(WallTime::now());
122         targetStatistics.lastSeen = lastSeen;
<span class="line-modified">123         targetStatistics.subresourceUnderTopFrameDomains.add(topFrameDomain);</span>

124 
<span class="line-modified">125         scheduleNotificationIfNeeded();</span>
126     }
127 
128     if (isRedirect) {
<span class="line-modified">129         auto&amp; redirectingOriginStatistics = ensureResourceStatisticsForRegistrableDomain(page-&gt;sessionID(), redirectedFromDomain);</span>
<span class="line-modified">130         redirectingOriginStatistics.subresourceUniqueRedirectsTo.add(targetDomain);</span>
<span class="line-modified">131         auto&amp; targetStatistics = ensureResourceStatisticsForRegistrableDomain(page-&gt;sessionID(), targetDomain);</span>
<span class="line-modified">132         targetStatistics.subresourceUniqueRedirectsFrom.add(redirectedFromDomain);</span>



133 




134         scheduleNotificationIfNeeded();
<span class="line-added">135     }</span>
136 }
137 
138 void ResourceLoadObserver::logWebSocketLoading(const URL&amp; targetURL, const URL&amp; mainFrameURL, PAL::SessionID sessionID)
139 {
<span class="line-modified">140     if (!shouldLog(sessionID))</span>
141         return;
142 
143     auto targetHost = targetURL.host();
144     auto mainFrameHost = mainFrameURL.host();
145 
146     if (targetHost.isEmpty() || mainFrameHost.isEmpty() || targetHost == mainFrameHost)
147         return;
148 
<span class="line-modified">149     RegistrableDomain targetDomain { targetURL };</span>
<span class="line-modified">150     RegistrableDomain topFrameDomain { mainFrameURL };</span>
151 
<span class="line-modified">152     if (targetDomain == topFrameDomain)</span>
153         return;
154 
155     auto lastSeen = ResourceLoadStatistics::reduceTimeResolution(WallTime::now());
156 
<span class="line-modified">157     auto&amp; targetStatistics = ensureResourceStatisticsForRegistrableDomain(sessionID, targetDomain);</span>
158     targetStatistics.lastSeen = lastSeen;
<span class="line-modified">159     targetStatistics.subresourceUnderTopFrameDomains.add(topFrameDomain);</span>

160 
<span class="line-modified">161     scheduleNotificationIfNeeded();</span>
162 }
163 
164 void ResourceLoadObserver::logUserInteractionWithReducedTimeResolution(const Document&amp; document)
165 {
<span class="line-modified">166     if (!document.sessionID().isValid() || !shouldLog(document.sessionID()))</span>
167         return;
168 
169     auto&amp; url = document.url();
<span class="line-modified">170     if (url.protocolIsAbout() || url.isLocalFile() || url.isEmpty())</span>
171         return;
172 
<span class="line-modified">173     RegistrableDomain topFrameDomain { url };</span>
174     auto newTime = ResourceLoadStatistics::reduceTimeResolution(WallTime::now());
<span class="line-modified">175     auto lastReportedUserInteraction = m_lastReportedUserInteractionMap.get(topFrameDomain);</span>
176     if (newTime == lastReportedUserInteraction)
177         return;
178 
<span class="line-modified">179     m_lastReportedUserInteractionMap.set(topFrameDomain, newTime);</span>
180 
<span class="line-modified">181     auto&amp; statistics = ensureResourceStatisticsForRegistrableDomain(document.sessionID(), topFrameDomain);</span>
182     statistics.hadUserInteraction = true;
183     statistics.lastSeen = newTime;
184     statistics.mostRecentUserInteractionTime = newTime;
185 
186 #if ENABLE(RESOURCE_LOAD_STATISTICS)
187     if (auto* frame = document.frame()) {
188         if (auto* opener = frame-&gt;loader().opener()) {
189             if (auto* openerDocument = opener-&gt;document()) {
190                 if (auto* openerFrame = openerDocument-&gt;frame()) {
191                     if (auto openerPageID = openerFrame-&gt;loader().client().pageID())
<span class="line-modified">192                         requestStorageAccessUnderOpener(document.sessionID(), topFrameDomain, openerPageID.value(), *openerDocument);</span>
193                 }
194             }
195         }
196     }
197 
<span class="line-modified">198     // We notify right away in case of a user interaction instead of waiting the usual 5 seconds because we want</span>
<span class="line-added">199     // to update cookie blocking state as quickly as possible.</span>
<span class="line-added">200     m_logUserInteractionNotificationCallback(document.sessionID(), topFrameDomain);</span>
201 #endif
202 



203 #if ENABLE(RESOURCE_LOAD_STATISTICS) &amp;&amp; !RELEASE_LOG_DISABLED
204     if (shouldLogUserInteraction()) {
205         auto counter = ++m_loggingCounter;
206 #define LOCAL_LOG(str, ...) \
207         RELEASE_LOG(ResourceLoadStatistics, &quot;ResourceLoadObserver::logUserInteraction: counter = %&quot; PRIu64 &quot;: &quot; str, counter, ##__VA_ARGS__)
208 
209         auto escapeForJSON = [](String s) {
210             s.replace(&#39;\\&#39;, &quot;\\\\&quot;).replace(&#39;&quot;&#39;, &quot;\\\&quot;&quot;);
211             return s;
212         };
213         auto escapedURL = escapeForJSON(url.string());
<span class="line-modified">214         auto escapedDomain = escapeForJSON(topFrameDomain.string());</span>
215 
216         LOCAL_LOG(R&quot;({ &quot;url&quot;: &quot;%{public}s&quot;,)&quot;, escapedURL.utf8().data());
217         LOCAL_LOG(R&quot;(  &quot;domain&quot; : &quot;%{public}s&quot;,)&quot;, escapedDomain.utf8().data());
218         LOCAL_LOG(R&quot;(  &quot;until&quot; : %f })&quot;, newTime.secondsSinceEpoch().seconds());
219 
220 #undef LOCAL_LOG
221     }
222 #endif
223 }
224 
225 #if ENABLE(RESOURCE_LOAD_STATISTICS)
<span class="line-modified">226 void ResourceLoadObserver::requestStorageAccessUnderOpener(PAL::SessionID sessionID, const RegistrableDomain&amp; domainInNeedOfStorageAccess, PageIdentifier openerPageID, Document&amp; openerDocument)</span>
227 {
228     auto openerUrl = openerDocument.url();
<span class="line-modified">229     RegistrableDomain openerDomain { openerUrl };</span>
<span class="line-modified">230     if (domainInNeedOfStorageAccess != openerDomain</span>
231         &amp;&amp; !openerDocument.hasRequestedPageSpecificStorageAccessWithUserInteraction(domainInNeedOfStorageAccess)
232         &amp;&amp; !equalIgnoringASCIICase(openerUrl.string(), WTF::blankURL())) {
<span class="line-modified">233         m_requestStorageAccessUnderOpenerCallback(sessionID, domainInNeedOfStorageAccess, openerPageID, openerDomain);</span>
234         // Remember user interaction-based requests since they don&#39;t need to be repeated.
235         openerDocument.setHasRequestedPageSpecificStorageAccessWithUserInteraction(domainInNeedOfStorageAccess);
236     }
237 }
238 #endif
239 
240 void ResourceLoadObserver::logFontLoad(const Document&amp; document, const String&amp; familyName, bool loadStatus)
241 {
242 #if ENABLE(WEB_API_STATISTICS)
<span class="line-modified">243     if (!shouldLog(document.sessionID()))</span>
244         return;
<span class="line-modified">245     RegistrableDomain registrableDomain { document.url() };</span>
<span class="line-modified">246     auto&amp; statistics = ensureResourceStatisticsForRegistrableDomain(document.sessionID, registrableDomain);</span>
247     bool shouldCallNotificationCallback = false;
248     if (!loadStatus) {
249         if (statistics.fontsFailedToLoad.add(familyName).isNewEntry)
250             shouldCallNotificationCallback = true;
251     } else {
252         if (statistics.fontsSuccessfullyLoaded.add(familyName).isNewEntry)
253             shouldCallNotificationCallback = true;
254     }
<span class="line-modified">255     RegistrableDomain mainFrameRegistrableDomain { document.topDocument().url() };</span>
<span class="line-modified">256     if (statistics.topFrameRegistrableDomainsWhichAccessedWebAPIs.add(mainFrameRegistrableDomain.string()).isNewEntry)</span>
257         shouldCallNotificationCallback = true;
258     if (shouldCallNotificationCallback)
259         scheduleNotificationIfNeeded();
260 #else
261     UNUSED_PARAM(document);
262     UNUSED_PARAM(familyName);
263     UNUSED_PARAM(loadStatus);
264 #endif
265 }
266 
267 void ResourceLoadObserver::logCanvasRead(const Document&amp; document)
268 {
269 #if ENABLE(WEB_API_STATISTICS)
<span class="line-modified">270     if (!shouldLog(document.sessionID()))</span>
271         return;
<span class="line-modified">272     RegistrableDomain registrableDomain { document.url() };</span>
<span class="line-modified">273     auto&amp; statistics = ensureResourceStatisticsForRegistrableDomain(document.sessionID(), registrableDomain);</span>
<span class="line-modified">274     RegistrableDomain mainFrameRegistrableDomain { document.topDocument().url() };</span>
275     statistics.canvasActivityRecord.wasDataRead = true;
<span class="line-modified">276     if (statistics.topFrameRegistrableDomainsWhichAccessedWebAPIs.add(mainFrameRegistrableDomain.string()).isNewEntry)</span>
277         scheduleNotificationIfNeeded();
278 #else
279     UNUSED_PARAM(document);
280 #endif
281 }
282 
283 void ResourceLoadObserver::logCanvasWriteOrMeasure(const Document&amp; document, const String&amp; textWritten)
284 {
285 #if ENABLE(WEB_API_STATISTICS)
<span class="line-modified">286     if (!shouldLog(document.sessionID()))</span>
287         return;
<span class="line-modified">288     RegistrableDomain registrableDomain { document.url() };</span>
<span class="line-modified">289     auto&amp; statistics = ensureResourceStatisticsForRegistrableDomain(document.sessionID, registrableDomain);</span>
290     bool shouldCallNotificationCallback = false;
<span class="line-modified">291     RegistrableDomain mainFrameRegistrableDomain { document.topDocument().url() };</span>
292     if (statistics.canvasActivityRecord.recordWrittenOrMeasuredText(textWritten))
293         shouldCallNotificationCallback = true;
<span class="line-modified">294     if (statistics.topFrameRegistrableDomainsWhichAccessedWebAPIs.add(mainFrameRegistrableDomain.string()).isNewEntry)</span>
295         shouldCallNotificationCallback = true;
296     if (shouldCallNotificationCallback)
297         scheduleNotificationIfNeeded();
298 #else
299     UNUSED_PARAM(document);
300     UNUSED_PARAM(textWritten);
301 #endif
302 }
303 
304 void ResourceLoadObserver::logNavigatorAPIAccessed(const Document&amp; document, const ResourceLoadStatistics::NavigatorAPI functionName)
305 {
306 #if ENABLE(WEB_API_STATISTICS)
<span class="line-modified">307     if (!shouldLog(document.sessionID()))</span>
308         return;
<span class="line-modified">309     RegistrableDomain registrableDomain { document.url() };</span>
<span class="line-modified">310     auto&amp; statistics = ensureResourceStatisticsForRegistrableDomain(document.sessionID, registrableDomain);</span>
311     bool shouldCallNotificationCallback = false;
312     if (!statistics.navigatorFunctionsAccessed.contains(functionName)) {
313         statistics.navigatorFunctionsAccessed.add(functionName);
314         shouldCallNotificationCallback = true;
315     }
<span class="line-modified">316     RegistrableDomain mainFrameRegistrableDomain { document.topDocument().url() };</span>
<span class="line-modified">317     if (statistics.topFrameRegistrableDomainsWhichAccessedWebAPIs.add(mainFrameRegistrableDomain.string()).isNewEntry)</span>
318         shouldCallNotificationCallback = true;
319     if (shouldCallNotificationCallback)
320         scheduleNotificationIfNeeded();
321 #else
322     UNUSED_PARAM(document);
323     UNUSED_PARAM(functionName);
324 #endif
325 }
326 
327 void ResourceLoadObserver::logScreenAPIAccessed(const Document&amp; document, const ResourceLoadStatistics::ScreenAPI functionName)
328 {
329 #if ENABLE(WEB_API_STATISTICS)
<span class="line-modified">330     if (!shouldLog(document.sessionID()))</span>
331         return;
<span class="line-modified">332     RegistrableDomain registrableDomain { document.url() };</span>
<span class="line-modified">333     auto&amp; statistics = ensureResourceStatisticsForRegistrableDomain(document.sessionID, registrableDomain);</span>
334     bool shouldCallNotificationCallback = false;
335     if (!statistics.screenFunctionsAccessed.contains(functionName)) {
336         statistics.screenFunctionsAccessed.add(functionName);
337         shouldCallNotificationCallback = true;
338     }
<span class="line-modified">339     RegistrableDomain mainFrameRegistrableDomain { document.topDocument().url() };</span>
<span class="line-modified">340     if (statistics.topFrameRegistrableDomainsWhichAccessedWebAPIs.add(mainFrameRegistrableDomain.string()).isNewEntry)</span>
341         shouldCallNotificationCallback = true;
342     if (shouldCallNotificationCallback)
343         scheduleNotificationIfNeeded();
344 #else
345     UNUSED_PARAM(document);
346     UNUSED_PARAM(functionName);
347 #endif
348 }
349 
<span class="line-modified">350 ResourceLoadStatistics&amp; ResourceLoadObserver::ensureResourceStatisticsForRegistrableDomain(PAL::SessionID sessionID, const RegistrableDomain&amp; domain)</span>
351 {
<span class="line-modified">352     auto addResult = m_perSessionResourceStatisticsMap.ensure(sessionID, [] {</span>
<span class="line-modified">353         return makeUnique&lt;HashMap&lt;RegistrableDomain, ResourceLoadStatistics&gt;&gt;();</span>
354     });
<span class="line-modified">355 </span>
<span class="line-added">356     auto addDomainResult = addResult.iterator-&gt;value-&gt;ensure(domain, [&amp;domain] {</span>
<span class="line-added">357         return ResourceLoadStatistics(domain);</span>
<span class="line-added">358     });</span>
<span class="line-added">359     return addDomainResult.iterator-&gt;value;</span>
360 }
361 
362 void ResourceLoadObserver::scheduleNotificationIfNeeded()
363 {
364     ASSERT(m_notificationCallback);
<span class="line-modified">365     if (m_perSessionResourceStatisticsMap.isEmpty()) {</span>
366         m_notificationTimer.stop();
367         return;
368     }
369 
370     if (!m_notificationTimer.isActive())
371         m_notificationTimer.startOneShot(minimumNotificationInterval);
372 }
373 
<span class="line-modified">374 void ResourceLoadObserver::updateCentralStatisticsStore()</span>
375 {
376     ASSERT(m_notificationCallback);
377     m_notificationTimer.stop();
378     m_notificationCallback(takeStatistics());
379 }
380 
<span class="line-modified">381 String ResourceLoadObserver::statisticsForURL(PAL::SessionID sessionID, const URL&amp; url)</span>
382 {
<span class="line-modified">383     auto* resourceStatisticsByDomain = m_perSessionResourceStatisticsMap.get(sessionID);</span>
<span class="line-modified">384     if (!resourceStatisticsByDomain)</span>
385         return emptyString();
386 
<span class="line-modified">387     auto iter = resourceStatisticsByDomain-&gt;find(RegistrableDomain { url });</span>
<span class="line-added">388     if (iter == resourceStatisticsByDomain-&gt;end())</span>
<span class="line-added">389         return emptyString();</span>
<span class="line-added">390 </span>
<span class="line-added">391     return makeString(&quot;Statistics for &quot;, url.host().toString(), &quot;:\n&quot;, iter-&gt;value.toString());</span>
392 }
393 
<span class="line-modified">394 auto ResourceLoadObserver::takeStatistics() -&gt; PerSessionResourceLoadData</span>
395 {
<span class="line-modified">396     PerSessionResourceLoadData perSessionStatistics;</span>
<span class="line-modified">397 </span>
<span class="line-modified">398     for (auto&amp; iter : m_perSessionResourceStatisticsMap) {</span>
<span class="line-modified">399         Vector&lt;ResourceLoadStatistics&gt; statistics;</span>
<span class="line-added">400         statistics.reserveInitialCapacity(iter.value-&gt;size());</span>
401 
<span class="line-modified">402         for (auto&amp; statistic : iter.value-&gt;values())</span>
<span class="line-added">403             statistics.uncheckedAppend(WTFMove(statistic));</span>
<span class="line-added">404 </span>
<span class="line-added">405         perSessionStatistics.append(std::make_pair(iter.key, WTFMove(statistics)));</span>
<span class="line-added">406     }</span>
407 
<span class="line-modified">408     m_perSessionResourceStatisticsMap.clear();</span>
<span class="line-added">409     return perSessionStatistics;</span>
410 }
411 
412 void ResourceLoadObserver::clearState()
413 {
414     m_notificationTimer.stop();
<span class="line-modified">415     m_perSessionResourceStatisticsMap.clear();</span>
416     m_lastReportedUserInteractionMap.clear();
417 }
418 
419 URL ResourceLoadObserver::nonNullOwnerURL(const Document&amp; document) const
420 {
421     auto url = document.url();
422     auto* frame = document.frame();
423     auto host = document.url().host();
424 
425     while ((host.isNull() || host.isEmpty()) &amp;&amp; frame &amp;&amp; !frame-&gt;isMainFrame()) {
426         auto* ownerElement = frame-&gt;ownerElement();
427 
428         ASSERT(ownerElement != nullptr);
429 
430         auto&amp; doc = ownerElement-&gt;document();
431         frame = doc.frame();
432         url = doc.url();
433         host = url.host();
434     }
435 
</pre>
</td>
</tr>
</table>
<center><a href="ResourceLoadNotifier.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="ResourceLoadObserver.h.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>