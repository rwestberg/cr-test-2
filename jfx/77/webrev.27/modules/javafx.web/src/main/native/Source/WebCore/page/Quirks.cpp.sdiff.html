<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff modules/javafx.web/src/main/native/Source/WebCore/page/Quirks.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="ProcessWarming.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="Quirks.h.sdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/page/Quirks.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (C) 2018 Apple Inc. All rights reserved.</span>
  3  *
  4  * Redistribution and use in source and binary forms, with or without
  5  * modification, are permitted provided that the following conditions
  6  * are met:
  7  * 1. Redistributions of source code must retain the above copyright
  8  *    notice, this list of conditions and the following disclaimer.
  9  * 2. Redistributions in binary form must reproduce the above copyright
 10  *    notice, this list of conditions and the following disclaimer in the
 11  *    documentation and/or other materials provided with the distribution.
 12  *
 13  * THIS SOFTWARE IS PROVIDED BY APPLE INC. AND ITS CONTRIBUTORS ``AS IS&#39;&#39;
 14  * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO,
 15  * THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
 16  * PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL APPLE INC. OR ITS CONTRIBUTORS
 17  * BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
 18  * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
 19  * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
 20  * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
 21  * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
 22  * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF
 23  * THE POSSIBILITY OF SUCH DAMAGE.
 24  */
 25 
 26 #include &quot;config.h&quot;
 27 #include &quot;Quirks.h&quot;
 28 


 29 #include &quot;Document.h&quot;






 30 #include &quot;Settings.h&quot;

 31 
 32 namespace WebCore {
 33 









 34 Quirks::Quirks(Document&amp; document)
 35     : m_document(makeWeakPtr(document))
 36 {
 37 }
 38 
 39 Quirks::~Quirks() = default;
 40 































































 41 bool Quirks::hasBrokenEncryptedMediaAPISupportQuirk() const
 42 {
<span class="line-modified"> 43     if (!m_document || !m_document-&gt;settings().needsSiteSpecificQuirks())</span>
 44         return false;
 45 
 46     if (m_hasBrokenEncryptedMediaAPISupportQuirk)
 47         return m_hasBrokenEncryptedMediaAPISupportQuirk.value();
 48 
 49     auto domain = m_document-&gt;securityOrigin().domain().convertToASCIILowercase();
 50 
 51     m_hasBrokenEncryptedMediaAPISupportQuirk = domain == &quot;starz.com&quot;
 52         || domain.endsWith(&quot;.starz.com&quot;)


 53         || domain == &quot;hulu.com&quot;
 54         || domain.endsWith(&quot;hulu.com&quot;);
 55 
 56     return m_hasBrokenEncryptedMediaAPISupportQuirk.value();
 57 }
 58 



























































































































































































































































































































































































































































 59 }
</pre>
</td>
<td>
<hr />
<pre>
  1 /*
<span class="line-modified">  2  * Copyright (C) 2018-2019 Apple Inc. All rights reserved.</span>
  3  *
  4  * Redistribution and use in source and binary forms, with or without
  5  * modification, are permitted provided that the following conditions
  6  * are met:
  7  * 1. Redistributions of source code must retain the above copyright
  8  *    notice, this list of conditions and the following disclaimer.
  9  * 2. Redistributions in binary form must reproduce the above copyright
 10  *    notice, this list of conditions and the following disclaimer in the
 11  *    documentation and/or other materials provided with the distribution.
 12  *
 13  * THIS SOFTWARE IS PROVIDED BY APPLE INC. AND ITS CONTRIBUTORS ``AS IS&#39;&#39;
 14  * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO,
 15  * THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
 16  * PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL APPLE INC. OR ITS CONTRIBUTORS
 17  * BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
 18  * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
 19  * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
 20  * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
 21  * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
 22  * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF
 23  * THE POSSIBILITY OF SUCH DAMAGE.
 24  */
 25 
 26 #include &quot;config.h&quot;
 27 #include &quot;Quirks.h&quot;
 28 
<span class="line-added"> 29 #include &quot;CustomHeaderFields.h&quot;</span>
<span class="line-added"> 30 #include &quot;DOMTokenList.h&quot;</span>
 31 #include &quot;Document.h&quot;
<span class="line-added"> 32 #include &quot;DocumentLoader.h&quot;</span>
<span class="line-added"> 33 #include &quot;FrameLoader.h&quot;</span>
<span class="line-added"> 34 #include &quot;HTMLMetaElement.h&quot;</span>
<span class="line-added"> 35 #include &quot;HTMLObjectElement.h&quot;</span>
<span class="line-added"> 36 #include &quot;LayoutUnit.h&quot;</span>
<span class="line-added"> 37 #include &quot;RuntimeEnabledFeatures.h&quot;</span>
 38 #include &quot;Settings.h&quot;
<span class="line-added"> 39 #include &quot;UserAgent.h&quot;</span>
 40 
 41 namespace WebCore {
 42 
<span class="line-added"> 43 static inline OptionSet&lt;AutoplayQuirk&gt; allowedAutoplayQuirks(Document&amp; document)</span>
<span class="line-added"> 44 {</span>
<span class="line-added"> 45     auto* loader = document.loader();</span>
<span class="line-added"> 46     if (!loader)</span>
<span class="line-added"> 47         return { };</span>
<span class="line-added"> 48 </span>
<span class="line-added"> 49     return loader-&gt;allowedAutoplayQuirks();</span>
<span class="line-added"> 50 }</span>
<span class="line-added"> 51 </span>
 52 Quirks::Quirks(Document&amp; document)
 53     : m_document(makeWeakPtr(document))
 54 {
 55 }
 56 
 57 Quirks::~Quirks() = default;
 58 
<span class="line-added"> 59 inline bool Quirks::needsQuirks() const</span>
<span class="line-added"> 60 {</span>
<span class="line-added"> 61     return m_document &amp;&amp; m_document-&gt;settings().needsSiteSpecificQuirks();</span>
<span class="line-added"> 62 }</span>
<span class="line-added"> 63 </span>
<span class="line-added"> 64 bool Quirks::shouldIgnoreInvalidSignal() const</span>
<span class="line-added"> 65 {</span>
<span class="line-added"> 66     return needsQuirks();</span>
<span class="line-added"> 67 }</span>
<span class="line-added"> 68 </span>
<span class="line-added"> 69 bool Quirks::needsFormControlToBeMouseFocusable() const</span>
<span class="line-added"> 70 {</span>
<span class="line-added"> 71 #if PLATFORM(MAC)</span>
<span class="line-added"> 72     if (!needsQuirks())</span>
<span class="line-added"> 73         return false;</span>
<span class="line-added"> 74 </span>
<span class="line-added"> 75     auto host = m_document-&gt;url().host();</span>
<span class="line-added"> 76     return equalLettersIgnoringASCIICase(host, &quot;ceac.state.gov&quot;) || host.endsWithIgnoringASCIICase(&quot;.ceac.state.gov&quot;);</span>
<span class="line-added"> 77 #else</span>
<span class="line-added"> 78     return false;</span>
<span class="line-added"> 79 #endif</span>
<span class="line-added"> 80 }</span>
<span class="line-added"> 81 </span>
<span class="line-added"> 82 bool Quirks::needsAutoplayPlayPauseEvents() const</span>
<span class="line-added"> 83 {</span>
<span class="line-added"> 84     if (!needsQuirks())</span>
<span class="line-added"> 85         return false;</span>
<span class="line-added"> 86 </span>
<span class="line-added"> 87     if (allowedAutoplayQuirks(*m_document).contains(AutoplayQuirk::SynthesizedPauseEvents))</span>
<span class="line-added"> 88         return true;</span>
<span class="line-added"> 89 </span>
<span class="line-added"> 90     return allowedAutoplayQuirks(m_document-&gt;topDocument()).contains(AutoplayQuirk::SynthesizedPauseEvents);</span>
<span class="line-added"> 91 }</span>
<span class="line-added"> 92 </span>
<span class="line-added"> 93 bool Quirks::needsSeekingSupportDisabled() const</span>
<span class="line-added"> 94 {</span>
<span class="line-added"> 95     if (!needsQuirks())</span>
<span class="line-added"> 96         return false;</span>
<span class="line-added"> 97 </span>
<span class="line-added"> 98     auto host = m_document-&gt;topDocument().url().host();</span>
<span class="line-added"> 99     return equalLettersIgnoringASCIICase(host, &quot;netflix.com&quot;) || host.endsWithIgnoringASCIICase(&quot;.netflix.com&quot;);</span>
<span class="line-added">100 }</span>
<span class="line-added">101 </span>
<span class="line-added">102 bool Quirks::needsPerDocumentAutoplayBehavior() const</span>
<span class="line-added">103 {</span>
<span class="line-added">104 #if PLATFORM(MAC)</span>
<span class="line-added">105     ASSERT(m_document == &amp;m_document-&gt;topDocument());</span>
<span class="line-added">106     return needsQuirks() &amp;&amp; allowedAutoplayQuirks(*m_document).contains(AutoplayQuirk::PerDocumentAutoplayBehavior);</span>
<span class="line-added">107 #else</span>
<span class="line-added">108     auto host = m_document-&gt;topDocument().url().host();</span>
<span class="line-added">109     return equalLettersIgnoringASCIICase(host, &quot;netflix.com&quot;) || host.endsWithIgnoringASCIICase(&quot;.netflix.com&quot;);</span>
<span class="line-added">110 #endif</span>
<span class="line-added">111 }</span>
<span class="line-added">112 </span>
<span class="line-added">113 bool Quirks::shouldAutoplayForArbitraryUserGesture() const</span>
<span class="line-added">114 {</span>
<span class="line-added">115 #if PLATFORM(MAC)</span>
<span class="line-added">116     return needsQuirks() &amp;&amp; allowedAutoplayQuirks(*m_document).contains(AutoplayQuirk::ArbitraryUserGestures);</span>
<span class="line-added">117 #else</span>
<span class="line-added">118     return false;</span>
<span class="line-added">119 #endif</span>
<span class="line-added">120 }</span>
<span class="line-added">121 </span>
122 bool Quirks::hasBrokenEncryptedMediaAPISupportQuirk() const
123 {
<span class="line-modified">124     if (!needsQuirks())</span>
125         return false;
126 
127     if (m_hasBrokenEncryptedMediaAPISupportQuirk)
128         return m_hasBrokenEncryptedMediaAPISupportQuirk.value();
129 
130     auto domain = m_document-&gt;securityOrigin().domain().convertToASCIILowercase();
131 
132     m_hasBrokenEncryptedMediaAPISupportQuirk = domain == &quot;starz.com&quot;
133         || domain.endsWith(&quot;.starz.com&quot;)
<span class="line-added">134         || domain == &quot;youtube.com&quot;</span>
<span class="line-added">135         || domain.endsWith(&quot;.youtube.com&quot;)</span>
136         || domain == &quot;hulu.com&quot;
137         || domain.endsWith(&quot;hulu.com&quot;);
138 
139     return m_hasBrokenEncryptedMediaAPISupportQuirk.value();
140 }
141 
<span class="line-added">142 bool Quirks::shouldDisableContentChangeObserverTouchEventAdjustment() const</span>
<span class="line-added">143 {</span>
<span class="line-added">144     if (!needsQuirks())</span>
<span class="line-added">145         return false;</span>
<span class="line-added">146 </span>
<span class="line-added">147     auto&amp; topDocument = m_document-&gt;topDocument();</span>
<span class="line-added">148     auto* topDocumentLoader = topDocument.loader();</span>
<span class="line-added">149     if (!topDocumentLoader || !topDocumentLoader-&gt;allowContentChangeObserverQuirk())</span>
<span class="line-added">150         return false;</span>
<span class="line-added">151 </span>
<span class="line-added">152     auto host = m_document-&gt;topDocument().url().host();</span>
<span class="line-added">153     return host.endsWith(&quot;.youtube.com&quot;) || host == &quot;youtube.com&quot;;</span>
<span class="line-added">154 }</span>
<span class="line-added">155 </span>
<span class="line-added">156 bool Quirks::shouldStripQuotationMarkInFontFaceSetFamily() const</span>
<span class="line-added">157 {</span>
<span class="line-added">158     if (!needsQuirks())</span>
<span class="line-added">159         return false;</span>
<span class="line-added">160 </span>
<span class="line-added">161     auto host = m_document-&gt;topDocument().url().host();</span>
<span class="line-added">162     return equalLettersIgnoringASCIICase(host, &quot;docs.google.com&quot;);</span>
<span class="line-added">163 }</span>
<span class="line-added">164 </span>
<span class="line-added">165 bool Quirks::isTouchBarUpdateSupressedForHiddenContentEditable() const</span>
<span class="line-added">166 {</span>
<span class="line-added">167 #if PLATFORM(MAC)</span>
<span class="line-added">168     if (!needsQuirks())</span>
<span class="line-added">169         return false;</span>
<span class="line-added">170 </span>
<span class="line-added">171     auto host = m_document-&gt;topDocument().url().host();</span>
<span class="line-added">172     return equalLettersIgnoringASCIICase(host, &quot;docs.google.com&quot;);</span>
<span class="line-added">173 #else</span>
<span class="line-added">174     return false;</span>
<span class="line-added">175 #endif</span>
<span class="line-added">176 }</span>
<span class="line-added">177 </span>
<span class="line-added">178 bool Quirks::isNeverRichlyEditableForTouchBar() const</span>
<span class="line-added">179 {</span>
<span class="line-added">180 #if PLATFORM(MAC)</span>
<span class="line-added">181     if (!needsQuirks())</span>
<span class="line-added">182         return false;</span>
<span class="line-added">183 </span>
<span class="line-added">184     auto&amp; url = m_document-&gt;topDocument().url();</span>
<span class="line-added">185     auto host = url.host();</span>
<span class="line-added">186 </span>
<span class="line-added">187     if (equalLettersIgnoringASCIICase(host, &quot;twitter.com&quot;))</span>
<span class="line-added">188         return true;</span>
<span class="line-added">189 </span>
<span class="line-added">190     if (equalLettersIgnoringASCIICase(host, &quot;onedrive.live.com&quot;))</span>
<span class="line-added">191         return true;</span>
<span class="line-added">192 </span>
<span class="line-added">193     if (equalLettersIgnoringASCIICase(host, &quot;trix-editor.org&quot;))</span>
<span class="line-added">194         return true;</span>
<span class="line-added">195 </span>
<span class="line-added">196     if (equalLettersIgnoringASCIICase(host, &quot;www.icloud.com&quot;)) {</span>
<span class="line-added">197         auto path = url.path();</span>
<span class="line-added">198         if (path.contains(&quot;notes&quot;) || url.fragmentIdentifier().contains(&quot;notes&quot;))</span>
<span class="line-added">199             return true;</span>
<span class="line-added">200     }</span>
<span class="line-added">201 #endif</span>
<span class="line-added">202 </span>
<span class="line-added">203     return false;</span>
<span class="line-added">204 }</span>
<span class="line-added">205 </span>
<span class="line-added">206 static bool shouldSuppressAutocorrectionAndAutocaptializationInHiddenEditableAreasForHost(const StringView&amp; host)</span>
<span class="line-added">207 {</span>
<span class="line-added">208 #if PLATFORM(IOS_FAMILY)</span>
<span class="line-added">209     return equalLettersIgnoringASCIICase(host, &quot;docs.google.com&quot;);</span>
<span class="line-added">210 #else</span>
<span class="line-added">211     UNUSED_PARAM(host);</span>
<span class="line-added">212     return false;</span>
<span class="line-added">213 #endif</span>
<span class="line-added">214 }</span>
<span class="line-added">215 </span>
<span class="line-added">216 bool Quirks::shouldDispatchSyntheticMouseEventsWhenModifyingSelection() const</span>
<span class="line-added">217 {</span>
<span class="line-added">218     if (m_document-&gt;settings().shouldDispatchSyntheticMouseEventsWhenModifyingSelection())</span>
<span class="line-added">219         return true;</span>
<span class="line-added">220 </span>
<span class="line-added">221     if (!needsQuirks())</span>
<span class="line-added">222         return false;</span>
<span class="line-added">223 </span>
<span class="line-added">224     auto host = m_document-&gt;topDocument().url().host();</span>
<span class="line-added">225     if (equalLettersIgnoringASCIICase(host, &quot;medium.com&quot;) || host.endsWithIgnoringASCIICase(&quot;.medium.com&quot;))</span>
<span class="line-added">226         return true;</span>
<span class="line-added">227 </span>
<span class="line-added">228     if (equalLettersIgnoringASCIICase(host, &quot;weebly.com&quot;) || host.endsWithIgnoringASCIICase(&quot;.weebly.com&quot;))</span>
<span class="line-added">229         return true;</span>
<span class="line-added">230 </span>
<span class="line-added">231     return false;</span>
<span class="line-added">232 }</span>
<span class="line-added">233 </span>
<span class="line-added">234 bool Quirks::needsYouTubeMouseOutQuirk() const</span>
<span class="line-added">235 {</span>
<span class="line-added">236 #if PLATFORM(IOS_FAMILY)</span>
<span class="line-added">237     if (m_document-&gt;settings().shouldDispatchSyntheticMouseOutAfterSyntheticClick())</span>
<span class="line-added">238         return true;</span>
<span class="line-added">239 </span>
<span class="line-added">240     if (!needsQuirks())</span>
<span class="line-added">241         return false;</span>
<span class="line-added">242 </span>
<span class="line-added">243     return equalLettersIgnoringASCIICase(m_document-&gt;url().host(), &quot;www.youtube.com&quot;);</span>
<span class="line-added">244 #else</span>
<span class="line-added">245     return false;</span>
<span class="line-added">246 #endif</span>
<span class="line-added">247 }</span>
<span class="line-added">248 </span>
<span class="line-added">249 bool Quirks::shouldAvoidUsingIOS13ForGmail() const</span>
<span class="line-added">250 {</span>
<span class="line-added">251 #if PLATFORM(IOS_FAMILY)</span>
<span class="line-added">252     if (!needsQuirks())</span>
<span class="line-added">253         return false;</span>
<span class="line-added">254 </span>
<span class="line-added">255     auto&amp; url = m_document-&gt;topDocument().url();</span>
<span class="line-added">256     return equalLettersIgnoringASCIICase(url.host(), &quot;mail.google.com&quot;);</span>
<span class="line-added">257 #else</span>
<span class="line-added">258     return false;</span>
<span class="line-added">259 #endif</span>
<span class="line-added">260 }</span>
<span class="line-added">261 </span>
<span class="line-added">262 bool Quirks::shouldSuppressAutocorrectionAndAutocaptializationInHiddenEditableAreas() const</span>
<span class="line-added">263 {</span>
<span class="line-added">264     if (!needsQuirks())</span>
<span class="line-added">265         return false;</span>
<span class="line-added">266 </span>
<span class="line-added">267     return shouldSuppressAutocorrectionAndAutocaptializationInHiddenEditableAreasForHost(m_document-&gt;topDocument().url().host());</span>
<span class="line-added">268 }</span>
<span class="line-added">269 </span>
<span class="line-added">270 #if ENABLE(TOUCH_EVENTS)</span>
<span class="line-added">271 bool Quirks::isAmazon() const</span>
<span class="line-added">272 {</span>
<span class="line-added">273     return topPrivatelyControlledDomain(m_document-&gt;topDocument().url().host().toString()).startsWith(&quot;amazon.&quot;);</span>
<span class="line-added">274 }</span>
<span class="line-added">275 </span>
<span class="line-added">276 bool Quirks::isGoogleMaps() const</span>
<span class="line-added">277 {</span>
<span class="line-added">278     auto&amp; url = m_document-&gt;topDocument().url();</span>
<span class="line-added">279     return topPrivatelyControlledDomain(url.host().toString()).startsWith(&quot;google.&quot;) &amp;&amp; url.path().startsWithIgnoringASCIICase(&quot;/maps/&quot;);</span>
<span class="line-added">280 }</span>
<span class="line-added">281 </span>
<span class="line-added">282 bool Quirks::shouldDispatchSimulatedMouseEvents() const</span>
<span class="line-added">283 {</span>
<span class="line-added">284     if (RuntimeEnabledFeatures::sharedFeatures().mouseEventsSimulationEnabled())</span>
<span class="line-added">285         return true;</span>
<span class="line-added">286 </span>
<span class="line-added">287     if (!needsQuirks())</span>
<span class="line-added">288         return false;</span>
<span class="line-added">289 </span>
<span class="line-added">290     auto* loader = m_document-&gt;loader();</span>
<span class="line-added">291     if (!loader || loader-&gt;simulatedMouseEventsDispatchPolicy() != SimulatedMouseEventsDispatchPolicy::Allow)</span>
<span class="line-added">292         return false;</span>
<span class="line-added">293 </span>
<span class="line-added">294     if (isAmazon())</span>
<span class="line-added">295         return true;</span>
<span class="line-added">296     if (isGoogleMaps())</span>
<span class="line-added">297         return true;</span>
<span class="line-added">298 </span>
<span class="line-added">299     auto&amp; url = m_document-&gt;topDocument().url();</span>
<span class="line-added">300     auto host = url.host();</span>
<span class="line-added">301 </span>
<span class="line-added">302     if (equalLettersIgnoringASCIICase(host, &quot;wix.com&quot;) || host.endsWithIgnoringASCIICase(&quot;.wix.com&quot;)) {</span>
<span class="line-added">303         // Disable simulated mouse dispatching for template selection.</span>
<span class="line-added">304         return !url.path().startsWithIgnoringASCIICase(&quot;/website/templates/&quot;);</span>
<span class="line-added">305     }</span>
<span class="line-added">306     if ((equalLettersIgnoringASCIICase(host, &quot;desmos.com&quot;) || host.endsWithIgnoringASCIICase(&quot;.desmos.com&quot;)) &amp;&amp; url.path().startsWithIgnoringASCIICase(&quot;/calculator/&quot;))</span>
<span class="line-added">307         return true;</span>
<span class="line-added">308     if (equalLettersIgnoringASCIICase(host, &quot;figma.com&quot;) || host.endsWithIgnoringASCIICase(&quot;.figma.com&quot;))</span>
<span class="line-added">309         return true;</span>
<span class="line-added">310     if (equalLettersIgnoringASCIICase(host, &quot;trello.com&quot;) || host.endsWithIgnoringASCIICase(&quot;.trello.com&quot;))</span>
<span class="line-added">311         return true;</span>
<span class="line-added">312     if (equalLettersIgnoringASCIICase(host, &quot;airtable.com&quot;) || host.endsWithIgnoringASCIICase(&quot;.airtable.com&quot;))</span>
<span class="line-added">313         return true;</span>
<span class="line-added">314     if (equalLettersIgnoringASCIICase(host, &quot;msn.com&quot;) || host.endsWithIgnoringASCIICase(&quot;.msn.com&quot;))</span>
<span class="line-added">315         return true;</span>
<span class="line-added">316     if (equalLettersIgnoringASCIICase(host, &quot;flipkart.com&quot;) || host.endsWithIgnoringASCIICase(&quot;.flipkart.com&quot;))</span>
<span class="line-added">317         return true;</span>
<span class="line-added">318     if (equalLettersIgnoringASCIICase(host, &quot;iqiyi.com&quot;) || host.endsWithIgnoringASCIICase(&quot;.iqiyi.com&quot;))</span>
<span class="line-added">319         return true;</span>
<span class="line-added">320     if (equalLettersIgnoringASCIICase(host, &quot;trailers.apple.com&quot;))</span>
<span class="line-added">321         return true;</span>
<span class="line-added">322     if (equalLettersIgnoringASCIICase(host, &quot;soundcloud.com&quot;))</span>
<span class="line-added">323         return true;</span>
<span class="line-added">324     if (equalLettersIgnoringASCIICase(host, &quot;naver.com&quot;))</span>
<span class="line-added">325         return true;</span>
<span class="line-added">326     if (host.endsWithIgnoringASCIICase(&quot;.naver.com&quot;)) {</span>
<span class="line-added">327         // Disable the quirk for tv.naver.com subdomain to be able to simulate hover on videos.</span>
<span class="line-added">328         if (equalLettersIgnoringASCIICase(host, &quot;tv.naver.com&quot;))</span>
<span class="line-added">329             return false;</span>
<span class="line-added">330         // Disable the quirk for mail.naver.com subdomain to be able to tap on mail subjects.</span>
<span class="line-added">331         if (equalLettersIgnoringASCIICase(host, &quot;mail.naver.com&quot;))</span>
<span class="line-added">332             return false;</span>
<span class="line-added">333         // Disable the quirk on the mobile site.</span>
<span class="line-added">334         // FIXME: Maybe this quirk should be disabled for &quot;m.&quot; subdomains on all sites? These are generally mobile sites that don&#39;t need mouse events.</span>
<span class="line-added">335         if (equalLettersIgnoringASCIICase(host, &quot;m.naver.com&quot;))</span>
<span class="line-added">336             return false;</span>
<span class="line-added">337         return true;</span>
<span class="line-added">338     }</span>
<span class="line-added">339     return false;</span>
<span class="line-added">340 }</span>
<span class="line-added">341 </span>
<span class="line-added">342 bool Quirks::shouldDispatchedSimulatedMouseEventsAssumeDefaultPrevented(EventTarget* target) const</span>
<span class="line-added">343 {</span>
<span class="line-added">344     if (!needsQuirks() || !shouldDispatchSimulatedMouseEvents())</span>
<span class="line-added">345         return false;</span>
<span class="line-added">346 </span>
<span class="line-added">347     if (isAmazon() &amp;&amp; is&lt;Element&gt;(target)) {</span>
<span class="line-added">348         // When panning on an Amazon product image, we&#39;re either touching on the #magnifierLens element</span>
<span class="line-added">349         // or its previous sibling.</span>
<span class="line-added">350         auto&amp; element = downcast&lt;Element&gt;(*target);</span>
<span class="line-added">351         if (element.getIdAttribute() == &quot;magnifierLens&quot;)</span>
<span class="line-added">352             return true;</span>
<span class="line-added">353         if (auto* sibling = element.nextElementSibling())</span>
<span class="line-added">354             return sibling-&gt;getIdAttribute() == &quot;magnifierLens&quot;;</span>
<span class="line-added">355     }</span>
<span class="line-added">356 </span>
<span class="line-added">357     if (equalLettersIgnoringASCIICase(m_document-&gt;topDocument().url().host(), &quot;soundcloud.com&quot;) &amp;&amp; is&lt;Element&gt;(target))</span>
<span class="line-added">358         return downcast&lt;Element&gt;(*target).classList().contains(&quot;sceneLayer&quot;);</span>
<span class="line-added">359 </span>
<span class="line-added">360     return false;</span>
<span class="line-added">361 }</span>
<span class="line-added">362 </span>
<span class="line-added">363 Optional&lt;Event::IsCancelable&gt; Quirks::simulatedMouseEventTypeForTarget(EventTarget* target) const</span>
<span class="line-added">364 {</span>
<span class="line-added">365     if (!shouldDispatchSimulatedMouseEvents())</span>
<span class="line-added">366         return { };</span>
<span class="line-added">367 </span>
<span class="line-added">368     // On Google Maps, we want to limit simulated mouse events to dragging the little man that allows entering into Street View.</span>
<span class="line-added">369     if (isGoogleMaps()) {</span>
<span class="line-added">370         if (is&lt;Element&gt;(target) &amp;&amp; downcast&lt;Element&gt;(target)-&gt;getAttribute(&quot;class&quot;) == &quot;widget-expand-button-pegman-icon&quot;)</span>
<span class="line-added">371             return Event::IsCancelable::Yes;</span>
<span class="line-added">372         return { };</span>
<span class="line-added">373     }</span>
<span class="line-added">374 </span>
<span class="line-added">375     auto host = m_document-&gt;topDocument().url().host();</span>
<span class="line-added">376     if (equalLettersIgnoringASCIICase(host, &quot;desmos.com&quot;) || host.endsWithIgnoringASCIICase(&quot;.desmos.com&quot;))</span>
<span class="line-added">377         return Event::IsCancelable::No;</span>
<span class="line-added">378 </span>
<span class="line-added">379     return Event::IsCancelable::Yes;</span>
<span class="line-added">380 }</span>
<span class="line-added">381 </span>
<span class="line-added">382 bool Quirks::shouldMakeTouchEventNonCancelableForTarget(EventTarget* target) const</span>
<span class="line-added">383 {</span>
<span class="line-added">384     if (!needsQuirks())</span>
<span class="line-added">385         return false;</span>
<span class="line-added">386 </span>
<span class="line-added">387     auto host = m_document-&gt;topDocument().url().host();</span>
<span class="line-added">388 </span>
<span class="line-added">389     if (equalLettersIgnoringASCIICase(host, &quot;www.youtube.com&quot;)) {</span>
<span class="line-added">390         if (is&lt;Element&gt;(target)) {</span>
<span class="line-added">391             unsigned depth = 3;</span>
<span class="line-added">392             for (auto* element = downcast&lt;Element&gt;(target); element &amp;&amp; depth; element = element-&gt;parentElement(), --depth) {</span>
<span class="line-added">393                 if (element-&gt;localName() == &quot;paper-item&quot; &amp;&amp; element-&gt;classList().contains(&quot;yt-dropdown-menu&quot;))</span>
<span class="line-added">394                     return true;</span>
<span class="line-added">395             }</span>
<span class="line-added">396         }</span>
<span class="line-added">397     }</span>
<span class="line-added">398 </span>
<span class="line-added">399     return false;</span>
<span class="line-added">400 }</span>
<span class="line-added">401 #endif</span>
<span class="line-added">402 </span>
<span class="line-added">403 bool Quirks::shouldAvoidResizingWhenInputViewBoundsChange() const</span>
<span class="line-added">404 {</span>
<span class="line-added">405     if (!needsQuirks())</span>
<span class="line-added">406         return false;</span>
<span class="line-added">407 </span>
<span class="line-added">408     auto host = m_document-&gt;topDocument().url().host();</span>
<span class="line-added">409     if (equalLettersIgnoringASCIICase(host, &quot;live.com&quot;) || host.endsWithIgnoringASCIICase(&quot;.live.com&quot;))</span>
<span class="line-added">410         return true;</span>
<span class="line-added">411 </span>
<span class="line-added">412     if (host.endsWithIgnoringASCIICase(&quot;.sharepoint.com&quot;))</span>
<span class="line-added">413         return true;</span>
<span class="line-added">414 </span>
<span class="line-added">415     return false;</span>
<span class="line-added">416 }</span>
<span class="line-added">417 </span>
<span class="line-added">418 bool Quirks::shouldDisablePointerEventsQuirk() const</span>
<span class="line-added">419 {</span>
<span class="line-added">420 #if PLATFORM(IOS_FAMILY)</span>
<span class="line-added">421     if (!needsQuirks())</span>
<span class="line-added">422         return false;</span>
<span class="line-added">423 </span>
<span class="line-added">424     auto&amp; url = m_document-&gt;topDocument().url();</span>
<span class="line-added">425     auto host = url.host();</span>
<span class="line-added">426     if (equalLettersIgnoringASCIICase(host, &quot;mailchimp.com&quot;) || host.endsWithIgnoringASCIICase(&quot;.mailchimp.com&quot;))</span>
<span class="line-added">427         return true;</span>
<span class="line-added">428 #endif</span>
<span class="line-added">429     return false;</span>
<span class="line-added">430 }</span>
<span class="line-added">431 </span>
<span class="line-added">432 bool Quirks::needsDeferKeyDownAndKeyPressTimersUntilNextEditingCommand() const</span>
<span class="line-added">433 {</span>
<span class="line-added">434 #if PLATFORM(IOS_FAMILY)</span>
<span class="line-added">435     if (m_document-&gt;settings().needsDeferKeyDownAndKeyPressTimersUntilNextEditingCommandQuirk())</span>
<span class="line-added">436         return true;</span>
<span class="line-added">437 </span>
<span class="line-added">438     if (!needsQuirks())</span>
<span class="line-added">439         return false;</span>
<span class="line-added">440 </span>
<span class="line-added">441     auto&amp; url = m_document-&gt;topDocument().url();</span>
<span class="line-added">442     return equalLettersIgnoringASCIICase(url.host(), &quot;docs.google.com&quot;) &amp;&amp; url.path().startsWithIgnoringASCIICase(&quot;/spreadsheets/&quot;);</span>
<span class="line-added">443 #else</span>
<span class="line-added">444     return false;</span>
<span class="line-added">445 #endif</span>
<span class="line-added">446 }</span>
<span class="line-added">447 </span>
<span class="line-added">448 bool Quirks::shouldLightenJapaneseBoldSansSerif() const</span>
<span class="line-added">449 {</span>
<span class="line-added">450 #if USE(HIRAGINO_SANS_WORKAROUND)</span>
<span class="line-added">451     if (!needsQuirks())</span>
<span class="line-added">452         return false;</span>
<span class="line-added">453 </span>
<span class="line-added">454     // lang=&quot;ja&quot; style=&quot;font: bold sans-serif;&quot; content would naturally get HiraginoSans-W8 here, but that&#39;s visually</span>
<span class="line-added">455     // too bold. Instead, we should pick HiraginoSans-W6 instead.</span>
<span class="line-added">456     // FIXME: webkit.org/b/200047 Remove this quirk.</span>
<span class="line-added">457     auto host = m_document-&gt;topDocument().url().host();</span>
<span class="line-added">458     return equalLettersIgnoringASCIICase(host, &quot;m.yahoo.co.jp&quot;);</span>
<span class="line-added">459 #else</span>
<span class="line-added">460     return false;</span>
<span class="line-added">461 #endif</span>
<span class="line-added">462 }</span>
<span class="line-added">463 </span>
<span class="line-added">464 bool Quirks::shouldIgnoreContentChange(const Element&amp; element) const</span>
<span class="line-added">465 {</span>
<span class="line-added">466 #if PLATFORM(IOS_FAMILY)</span>
<span class="line-added">467     if (!needsQuirks())</span>
<span class="line-added">468         return false;</span>
<span class="line-added">469 </span>
<span class="line-added">470     auto* parentElement = element.parentElement();</span>
<span class="line-added">471     if (!parentElement || !parentElement-&gt;hasClass())</span>
<span class="line-added">472         return false;</span>
<span class="line-added">473 </span>
<span class="line-added">474     DOMTokenList&amp; classList = parentElement-&gt;classList();</span>
<span class="line-added">475     if (!classList.contains(&quot;feedback&quot;) || !classList.contains(&quot;feedback-mid&quot;))</span>
<span class="line-added">476         return false;</span>
<span class="line-added">477 </span>
<span class="line-added">478     if (!equalLettersIgnoringASCIICase(topPrivatelyControlledDomain(m_document-&gt;url().host().toString()), &quot;united.com&quot;))</span>
<span class="line-added">479         return false;</span>
<span class="line-added">480 </span>
<span class="line-added">481     return true;</span>
<span class="line-added">482 #else</span>
<span class="line-added">483     UNUSED_PARAM(element);</span>
<span class="line-added">484     return false;</span>
<span class="line-added">485 #endif</span>
<span class="line-added">486 }</span>
<span class="line-added">487 </span>
<span class="line-added">488 // FIXME(&lt;rdar://problem/50394969&gt;): Remove after desmos.com adopts inputmode=&quot;none&quot;.</span>
<span class="line-added">489 bool Quirks::needsInputModeNoneImplicitly(const HTMLElement&amp; element) const</span>
<span class="line-added">490 {</span>
<span class="line-added">491 #if PLATFORM(IOS_FAMILY)</span>
<span class="line-added">492     if (!needsQuirks())</span>
<span class="line-added">493         return false;</span>
<span class="line-added">494 </span>
<span class="line-added">495     if (element.hasTagName(HTMLNames::inputTag)) {</span>
<span class="line-added">496         if (!equalLettersIgnoringASCIICase(m_document-&gt;url().host(), &quot;calendar.google.com&quot;))</span>
<span class="line-added">497             return false;</span>
<span class="line-added">498         static NeverDestroyed&lt;QualifiedName&gt; dataInitialValueAttr(nullAtom(), &quot;data-initial-value&quot;, nullAtom());</span>
<span class="line-added">499         static NeverDestroyed&lt;QualifiedName&gt; dataPreviousValueAttr(nullAtom(), &quot;data-previous-value&quot;, nullAtom());</span>
<span class="line-added">500 </span>
<span class="line-added">501         return equalLettersIgnoringASCIICase(element.attributeWithoutSynchronization(HTMLNames::autocompleteAttr), &quot;off&quot;)</span>
<span class="line-added">502             &amp;&amp; element.hasAttributeWithoutSynchronization(dataInitialValueAttr)</span>
<span class="line-added">503             &amp;&amp; element.hasAttributeWithoutSynchronization(dataPreviousValueAttr);</span>
<span class="line-added">504     }</span>
<span class="line-added">505 </span>
<span class="line-added">506     if (!element.hasTagName(HTMLNames::textareaTag))</span>
<span class="line-added">507         return false;</span>
<span class="line-added">508 </span>
<span class="line-added">509     auto&amp; url = m_document-&gt;url();</span>
<span class="line-added">510     auto host = url.host();</span>
<span class="line-added">511     if (!host.endsWithIgnoringASCIICase(&quot;.desmos.com&quot;))</span>
<span class="line-added">512         return false;</span>
<span class="line-added">513 </span>
<span class="line-added">514     return element.parentElement() &amp;&amp; element.parentElement()-&gt;classNames().contains(&quot;dcg-mq-textarea&quot;);</span>
<span class="line-added">515 #else</span>
<span class="line-added">516     UNUSED_PARAM(element);</span>
<span class="line-added">517     return false;</span>
<span class="line-added">518 #endif</span>
<span class="line-added">519 }</span>
<span class="line-added">520 </span>
<span class="line-added">521 // FIXME: Remove after the site is fixed, &lt;rdar://problem/50374200&gt;</span>
<span class="line-added">522 bool Quirks::needsGMailOverflowScrollQuirk() const</span>
<span class="line-added">523 {</span>
<span class="line-added">524 #if PLATFORM(IOS_FAMILY)</span>
<span class="line-added">525     if (!needsQuirks())</span>
<span class="line-added">526         return false;</span>
<span class="line-added">527 </span>
<span class="line-added">528     if (!m_needsGMailOverflowScrollQuirk)</span>
<span class="line-added">529         m_needsGMailOverflowScrollQuirk = equalLettersIgnoringASCIICase(m_document-&gt;url().host(), &quot;mail.google.com&quot;);</span>
<span class="line-added">530 </span>
<span class="line-added">531     return *m_needsGMailOverflowScrollQuirk;</span>
<span class="line-added">532 #else</span>
<span class="line-added">533     return false;</span>
<span class="line-added">534 #endif</span>
<span class="line-added">535 }</span>
<span class="line-added">536 </span>
<span class="line-added">537 // FIXME: Remove after the site is fixed, &lt;rdar://problem/50374311&gt;</span>
<span class="line-added">538 bool Quirks::needsYouTubeOverflowScrollQuirk() const</span>
<span class="line-added">539 {</span>
<span class="line-added">540 #if PLATFORM(IOS_FAMILY)</span>
<span class="line-added">541     if (!needsQuirks())</span>
<span class="line-added">542         return false;</span>
<span class="line-added">543 </span>
<span class="line-added">544     if (!m_needsYouTubeOverflowScrollQuirk)</span>
<span class="line-added">545         m_needsYouTubeOverflowScrollQuirk = equalLettersIgnoringASCIICase(m_document-&gt;url().host(), &quot;www.youtube.com&quot;);</span>
<span class="line-added">546 </span>
<span class="line-added">547     return *m_needsYouTubeOverflowScrollQuirk;</span>
<span class="line-added">548 #else</span>
<span class="line-added">549     return false;</span>
<span class="line-added">550 #endif</span>
<span class="line-added">551 }</span>
<span class="line-added">552 </span>
<span class="line-added">553 bool Quirks::shouldAvoidScrollingWhenFocusedContentIsVisible() const</span>
<span class="line-added">554 {</span>
<span class="line-added">555     if (!needsQuirks())</span>
<span class="line-added">556         return false;</span>
<span class="line-added">557 </span>
<span class="line-added">558     return equalLettersIgnoringASCIICase(m_document-&gt;url().host(), &quot;www.zillow.com&quot;);</span>
<span class="line-added">559 }</span>
<span class="line-added">560 </span>
<span class="line-added">561 bool Quirks::shouldOpenAsAboutBlank(const String&amp; stringToOpen) const</span>
<span class="line-added">562 {</span>
<span class="line-added">563 #if PLATFORM(IOS_FAMILY)</span>
<span class="line-added">564     if (!needsQuirks())</span>
<span class="line-added">565         return false;</span>
<span class="line-added">566 </span>
<span class="line-added">567     auto openerURL = m_document-&gt;url();</span>
<span class="line-added">568     if (!equalLettersIgnoringASCIICase(openerURL.host(), &quot;docs.google.com&quot;))</span>
<span class="line-added">569         return false;</span>
<span class="line-added">570 </span>
<span class="line-added">571     if (!m_document-&gt;frame() || !m_document-&gt;frame()-&gt;loader().userAgentForJavaScript(openerURL).contains(&quot;Macintosh&quot;))</span>
<span class="line-added">572         return false;</span>
<span class="line-added">573 </span>
<span class="line-added">574     URL urlToOpen { URL { }, stringToOpen };</span>
<span class="line-added">575     if (!urlToOpen.protocolIsAbout())</span>
<span class="line-added">576         return false;</span>
<span class="line-added">577 </span>
<span class="line-added">578     return !equalLettersIgnoringASCIICase(urlToOpen.host(), &quot;blank&quot;) &amp;&amp; !equalLettersIgnoringASCIICase(urlToOpen.host(), &quot;srcdoc&quot;);</span>
<span class="line-added">579 #else</span>
<span class="line-added">580     UNUSED_PARAM(stringToOpen);</span>
<span class="line-added">581     return false;</span>
<span class="line-added">582 #endif</span>
<span class="line-added">583 }</span>
<span class="line-added">584 </span>
585 }
</pre>
</td>
</tr>
</table>
<center><a href="ProcessWarming.cpp.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="Quirks.h.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>