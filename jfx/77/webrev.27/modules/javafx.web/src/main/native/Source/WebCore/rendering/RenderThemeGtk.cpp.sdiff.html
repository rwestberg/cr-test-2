<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff modules/javafx.web/src/main/native/Source/WebCore/rendering/RenderThemeGtk.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="RenderTheme.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="RenderThemeGtk.h.sdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/rendering/RenderThemeGtk.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  16  * Library General Public License for more details.
  17  *
  18  * You should have received a copy of the GNU Library General Public License
  19  * along with this library; see the file COPYING.LIB.  If not, write to
  20  * the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor,
  21  * Boston, MA 02110-1301, USA.
  22  *
  23  */
  24 
  25 #include &quot;config.h&quot;
  26 #include &quot;RenderThemeGtk.h&quot;
  27 
  28 #include &quot;CSSValueKeywords.h&quot;
  29 #include &quot;FileList.h&quot;
  30 #include &quot;FloatRoundedRect.h&quot;
  31 #include &quot;FontDescription.h&quot;
  32 #include &quot;GRefPtrGtk.h&quot;
  33 #include &quot;GUniquePtrGtk.h&quot;
  34 #include &quot;Gradient.h&quot;
  35 #include &quot;GraphicsContext.h&quot;
<span class="line-removed">  36 #include &quot;GtkVersioning.h&quot;</span>
  37 #include &quot;HTMLInputElement.h&quot;
  38 #include &quot;HTMLMediaElement.h&quot;
  39 #include &quot;LocalizedStrings.h&quot;
  40 #include &quot;MediaControlElements.h&quot;
  41 #include &quot;Page.h&quot;
  42 #include &quot;PaintInfo.h&quot;
  43 #include &quot;PlatformContextCairo.h&quot;
  44 #include &quot;RenderBox.h&quot;
  45 #include &quot;RenderObject.h&quot;
  46 #include &quot;RenderProgress.h&quot;
  47 #include &quot;RenderThemeWidget.h&quot;
  48 #include &quot;ScrollbarThemeGtk.h&quot;
  49 #include &quot;StringTruncator.h&quot;
  50 #include &quot;TimeRanges.h&quot;
  51 #include &quot;UserAgentScripts.h&quot;
  52 #include &quot;UserAgentStyleSheets.h&quot;
  53 #include &lt;cmath&gt;
  54 #include &lt;gdk/gdk.h&gt;
  55 #include &lt;glib.h&gt;
  56 #include &lt;gtk/gtk.h&gt;
</pre>
<hr />
<pre>
 108     fontDescription.setIsAbsoluteSize(true);
 109     fontDescription.setWeight(normalWeightValue());
 110     fontDescription.setItalic(FontSelectionValue());
 111     pango_font_description_free(pangoDescription);
 112 }
 113 
 114 #if ENABLE(DATALIST_ELEMENT)
 115 IntSize RenderThemeGtk::sliderTickSize() const
 116 {
 117     // FIXME: We need to set this to the size of one tick mark.
 118     return IntSize(0, 0);
 119 }
 120 
 121 int RenderThemeGtk::sliderTickOffsetFromTrackCenter() const
 122 {
 123     // FIXME: We need to set this to the position of the tick marks.
 124     return 0;
 125 }
 126 #endif
 127 
<span class="line-removed"> 128 #ifndef GTK_API_VERSION_2</span>
<span class="line-removed"> 129 </span>
<span class="line-removed"> 130 static void themeChangedCallback()</span>
<span class="line-removed"> 131 {</span>
<span class="line-removed"> 132     Page::updateStyleForAllPagesAfterGlobalChangeInEnvironment();</span>
<span class="line-removed"> 133 }</span>
<span class="line-removed"> 134 </span>
<span class="line-removed"> 135 RenderThemeGtk::RenderThemeGtk()</span>
<span class="line-removed"> 136 {</span>
<span class="line-removed"> 137     static bool themeMonitorInitialized = false;</span>
<span class="line-removed"> 138     if (!themeMonitorInitialized) {</span>
<span class="line-removed"> 139         GtkSettings* settings = gtk_settings_get_default();</span>
<span class="line-removed"> 140         g_signal_connect(settings, &quot;notify::gtk-theme-name&quot;, G_CALLBACK(themeChangedCallback), nullptr);</span>
<span class="line-removed"> 141         g_signal_connect(settings, &quot;notify::gtk-color-scheme&quot;, G_CALLBACK(themeChangedCallback), nullptr);</span>
<span class="line-removed"> 142         themeMonitorInitialized = true;</span>
<span class="line-removed"> 143     }</span>
<span class="line-removed"> 144 }</span>
<span class="line-removed"> 145 </span>
 146 enum RenderThemePart {
 147     Entry,
 148     EntrySelection,
 149     EntryIconLeft,
 150     EntryIconRight,
 151     Button,
 152     CheckButton,
 153     RadioButton,
 154     ComboBox,
 155     ComboBoxButton,
 156     ComboBoxArrow,
 157     Scale,
 158     ScaleTrough,
 159     ScaleSlider,
 160     ProgressBar,
 161     ProgressBarTrough,
 162     ProgressBarProgress,
 163     ListBox,
 164     SpinButton,
 165     SpinButtonUpButton,
 166     SpinButtonDownButton,
 167 #if ENABLE(VIDEO)
 168     MediaButton,
 169 #endif

 170 };
 171 
<span class="line-removed"> 172 #if !GTK_CHECK_VERSION(3, 20, 0)</span>
<span class="line-removed"> 173 // This is the default value defined by GTK+, where it was defined as MIN_ARROW_SIZE in gtkarrow.c.</span>
<span class="line-removed"> 174 static const int minArrowSize = 15;</span>
<span class="line-removed"> 175 // This is the default value defined by GTK+, where it was defined as MIN_ARROW_WIDTH in gtkspinbutton.c.</span>
<span class="line-removed"> 176 static const int minSpinButtonArrowSize = 6;</span>
<span class="line-removed"> 177 </span>
<span class="line-removed"> 178 static GRefPtr&lt;GtkStyleContext&gt; createStyleContext(RenderThemePart themePart, GtkStyleContext* parent = nullptr)</span>
<span class="line-removed"> 179 {</span>
<span class="line-removed"> 180     GRefPtr&lt;GtkWidgetPath&gt; path = adoptGRef(parent ? gtk_widget_path_copy(gtk_style_context_get_path(parent)) : gtk_widget_path_new());</span>
<span class="line-removed"> 181 </span>
<span class="line-removed"> 182     switch (themePart) {</span>
<span class="line-removed"> 183     case Entry:</span>
<span class="line-removed"> 184     case EntrySelection:</span>
<span class="line-removed"> 185         gtk_widget_path_append_type(path.get(), GTK_TYPE_ENTRY);</span>
<span class="line-removed"> 186         gtk_widget_path_iter_add_class(path.get(), -1, GTK_STYLE_CLASS_ENTRY);</span>
<span class="line-removed"> 187         break;</span>
<span class="line-removed"> 188     case EntryIconLeft:</span>
<span class="line-removed"> 189     case EntryIconRight:</span>
<span class="line-removed"> 190         gtk_widget_path_append_type(path.get(), GTK_TYPE_ENTRY);</span>
<span class="line-removed"> 191         break;</span>
<span class="line-removed"> 192     case Button:</span>
<span class="line-removed"> 193         gtk_widget_path_append_type(path.get(), GTK_TYPE_BUTTON);</span>
<span class="line-removed"> 194         gtk_widget_path_iter_add_class(path.get(), -1, GTK_STYLE_CLASS_BUTTON);</span>
<span class="line-removed"> 195         gtk_widget_path_iter_add_class(path.get(), -1, &quot;text-button&quot;);</span>
<span class="line-removed"> 196         break;</span>
<span class="line-removed"> 197     case CheckButton:</span>
<span class="line-removed"> 198         gtk_widget_path_append_type(path.get(), GTK_TYPE_CHECK_BUTTON);</span>
<span class="line-removed"> 199         gtk_widget_path_iter_add_class(path.get(), -1, GTK_STYLE_CLASS_CHECK);</span>
<span class="line-removed"> 200         break;</span>
<span class="line-removed"> 201     case RadioButton:</span>
<span class="line-removed"> 202         gtk_widget_path_append_type(path.get(), GTK_TYPE_RADIO_BUTTON);</span>
<span class="line-removed"> 203         gtk_widget_path_iter_add_class(path.get(), -1, GTK_STYLE_CLASS_RADIO);</span>
<span class="line-removed"> 204         break;</span>
<span class="line-removed"> 205     case ComboBox:</span>
<span class="line-removed"> 206         gtk_widget_path_append_type(path.get(), GTK_TYPE_COMBO_BOX);</span>
<span class="line-removed"> 207         break;</span>
<span class="line-removed"> 208     case ComboBoxButton:</span>
<span class="line-removed"> 209         gtk_widget_path_append_type(path.get(), GTK_TYPE_BUTTON);</span>
<span class="line-removed"> 210         gtk_widget_path_iter_add_class(path.get(), -1, GTK_STYLE_CLASS_BUTTON);</span>
<span class="line-removed"> 211         gtk_widget_path_iter_add_class(path.get(), -1, &quot;text-button&quot;);</span>
<span class="line-removed"> 212         gtk_widget_path_iter_add_class(path.get(), -1, &quot;combo&quot;);</span>
<span class="line-removed"> 213         break;</span>
<span class="line-removed"> 214     case ComboBoxArrow:</span>
<span class="line-removed"> 215         gtk_widget_path_append_type(path.get(), GTK_TYPE_ARROW);</span>
<span class="line-removed"> 216         gtk_widget_path_iter_add_class(path.get(), -1, &quot;arrow&quot;);</span>
<span class="line-removed"> 217         break;</span>
<span class="line-removed"> 218     case Scale:</span>
<span class="line-removed"> 219         gtk_widget_path_append_type(path.get(), GTK_TYPE_SCALE);</span>
<span class="line-removed"> 220         gtk_widget_path_iter_add_class(path.get(), -1, GTK_STYLE_CLASS_SCALE);</span>
<span class="line-removed"> 221         break;</span>
<span class="line-removed"> 222     case ScaleTrough:</span>
<span class="line-removed"> 223         gtk_widget_path_append_type(path.get(), GTK_TYPE_SCALE);</span>
<span class="line-removed"> 224         gtk_widget_path_iter_add_class(path.get(), -1, GTK_STYLE_CLASS_SCALE);</span>
<span class="line-removed"> 225         gtk_widget_path_iter_add_class(path.get(), -1, GTK_STYLE_CLASS_TROUGH);</span>
<span class="line-removed"> 226         break;</span>
<span class="line-removed"> 227     case ScaleSlider:</span>
<span class="line-removed"> 228         gtk_widget_path_append_type(path.get(), GTK_TYPE_SCALE);</span>
<span class="line-removed"> 229         gtk_widget_path_iter_add_class(path.get(), -1, GTK_STYLE_CLASS_SCALE);</span>
<span class="line-removed"> 230         gtk_widget_path_iter_add_class(path.get(), -1, GTK_STYLE_CLASS_SLIDER);</span>
<span class="line-removed"> 231         break;</span>
<span class="line-removed"> 232     case ProgressBar:</span>
<span class="line-removed"> 233         gtk_widget_path_append_type(path.get(), GTK_TYPE_PROGRESS_BAR);</span>
<span class="line-removed"> 234         gtk_widget_path_iter_add_class(path.get(), -1, GTK_STYLE_CLASS_PROGRESSBAR);</span>
<span class="line-removed"> 235         gtk_widget_path_iter_add_class(path.get(), -1, GTK_STYLE_CLASS_HORIZONTAL);</span>
<span class="line-removed"> 236         break;</span>
<span class="line-removed"> 237     case ProgressBarTrough:</span>
<span class="line-removed"> 238         gtk_widget_path_append_type(path.get(), GTK_TYPE_PROGRESS_BAR);</span>
<span class="line-removed"> 239         gtk_widget_path_iter_add_class(path.get(), -1, GTK_STYLE_CLASS_TROUGH);</span>
<span class="line-removed"> 240         break;</span>
<span class="line-removed"> 241     case ProgressBarProgress:</span>
<span class="line-removed"> 242         gtk_widget_path_append_type(path.get(), GTK_TYPE_PROGRESS_BAR);</span>
<span class="line-removed"> 243         gtk_widget_path_iter_add_class(path.get(), -1, GTK_STYLE_CLASS_PROGRESSBAR);</span>
<span class="line-removed"> 244         break;</span>
<span class="line-removed"> 245     case ListBox:</span>
<span class="line-removed"> 246         gtk_widget_path_append_type(path.get(), GTK_TYPE_TREE_VIEW);</span>
<span class="line-removed"> 247         gtk_widget_path_iter_add_class(path.get(), -1, GTK_STYLE_CLASS_VIEW);</span>
<span class="line-removed"> 248         break;</span>
<span class="line-removed"> 249     case SpinButton:</span>
<span class="line-removed"> 250         gtk_widget_path_append_type(path.get(), GTK_TYPE_SPIN_BUTTON);</span>
<span class="line-removed"> 251         gtk_widget_path_iter_add_class(path.get(), -1, GTK_STYLE_CLASS_SPINBUTTON);</span>
<span class="line-removed"> 252         gtk_widget_path_iter_add_class(path.get(), -1, GTK_STYLE_CLASS_HORIZONTAL);</span>
<span class="line-removed"> 253         break;</span>
<span class="line-removed"> 254     case SpinButtonUpButton:</span>
<span class="line-removed"> 255     case SpinButtonDownButton:</span>
<span class="line-removed"> 256         gtk_widget_path_append_type(path.get(), GTK_TYPE_SPIN_BUTTON);</span>
<span class="line-removed"> 257         gtk_widget_path_iter_add_class(path.get(), -1, GTK_STYLE_CLASS_SPINBUTTON);</span>
<span class="line-removed"> 258         gtk_widget_path_iter_add_class(path.get(), -1, GTK_STYLE_CLASS_BUTTON);</span>
<span class="line-removed"> 259         break;</span>
<span class="line-removed"> 260 #if ENABLE(VIDEO)</span>
<span class="line-removed"> 261     case MediaButton:</span>
<span class="line-removed"> 262         gtk_widget_path_append_type(path.get(), GTK_TYPE_IMAGE);</span>
<span class="line-removed"> 263         gtk_widget_path_iter_add_class(path.get(), -1, GTK_STYLE_CLASS_IMAGE);</span>
<span class="line-removed"> 264         break;</span>
<span class="line-removed"> 265 #endif // ENABLE(VIDEO)</span>
<span class="line-removed"> 266     default:</span>
<span class="line-removed"> 267         ASSERT_NOT_REACHED();</span>
<span class="line-removed"> 268         break;</span>
<span class="line-removed"> 269     }</span>
<span class="line-removed"> 270 </span>
<span class="line-removed"> 271     GRefPtr&lt;GtkStyleContext&gt; context = adoptGRef(gtk_style_context_new());</span>
<span class="line-removed"> 272     gtk_style_context_set_path(context.get(), path.get());</span>
<span class="line-removed"> 273     gtk_style_context_set_parent(context.get(), parent);</span>
<span class="line-removed"> 274     return context;</span>
<span class="line-removed"> 275 }</span>
<span class="line-removed"> 276 </span>
<span class="line-removed"> 277 static GRefPtr&lt;GdkPixbuf&gt; loadThemedIcon(GtkStyleContext* context, const char* iconName, GtkIconSize iconSize)</span>
<span class="line-removed"> 278 {</span>
<span class="line-removed"> 279     GRefPtr&lt;GIcon&gt; icon = adoptGRef(g_themed_icon_new(iconName));</span>
<span class="line-removed"> 280     unsigned lookupFlags = GTK_ICON_LOOKUP_USE_BUILTIN | GTK_ICON_LOOKUP_FORCE_SIZE | GTK_ICON_LOOKUP_FORCE_SVG;</span>
<span class="line-removed"> 281 #if GTK_CHECK_VERSION(3, 14, 0)</span>
<span class="line-removed"> 282     GtkTextDirection direction = gtk_style_context_get_direction(context);</span>
<span class="line-removed"> 283     if (direction &amp; GTK_TEXT_DIR_LTR)</span>
<span class="line-removed"> 284         lookupFlags |= GTK_ICON_LOOKUP_DIR_LTR;</span>
<span class="line-removed"> 285     else if (direction &amp; GTK_TEXT_DIR_RTL)</span>
<span class="line-removed"> 286         lookupFlags |= GTK_ICON_LOOKUP_DIR_RTL;</span>
<span class="line-removed"> 287 #endif</span>
<span class="line-removed"> 288     int width, height;</span>
<span class="line-removed"> 289     gtk_icon_size_lookup(iconSize, &amp;width, &amp;height);</span>
<span class="line-removed"> 290     GRefPtr&lt;GtkIconInfo&gt; iconInfo = adoptGRef(gtk_icon_theme_lookup_by_gicon(gtk_icon_theme_get_default(), icon.get(), std::min(width, height), static_cast&lt;GtkIconLookupFlags&gt;(lookupFlags)));</span>
<span class="line-removed"> 291     if (!iconInfo)</span>
<span class="line-removed"> 292         return nullptr;</span>
<span class="line-removed"> 293 </span>
<span class="line-removed"> 294     return adoptGRef(gtk_icon_info_load_symbolic_for_context(iconInfo.get(), context, nullptr, nullptr));</span>
<span class="line-removed"> 295 }</span>
<span class="line-removed"> 296 #endif // !GTK_CHECK_VERSION(3, 20, 0)</span>
<span class="line-removed"> 297 </span>
 298 #if ENABLE(VIDEO)
 299 static bool nodeHasPseudo(Node&amp; node, const char* pseudo)
 300 {
 301     return is&lt;Element&gt;(node) &amp;&amp; downcast&lt;Element&gt;(node).pseudo() == pseudo;
 302 }
 303 
 304 static bool nodeHasClass(Node* node, const char* className)
 305 {
 306     if (!is&lt;Element&gt;(*node))
 307         return false;
 308 
 309     Element&amp; element = downcast&lt;Element&gt;(*node);
 310 
 311     if (!element.hasClass())
 312         return false;
 313 
 314     return element.classNames().contains(className);
 315 }
 316 #endif // ENABLE(VIDEO)
 317 
</pre>
<hr />
<pre>
 337 }
 338 
 339 bool RenderThemeGtk::supportsFocusRing(const RenderStyle&amp; style) const
 340 {
 341     return supportsFocus(style.appearance());
 342 }
 343 
 344 bool RenderThemeGtk::controlSupportsTints(const RenderObject&amp; o) const
 345 {
 346     return isEnabled(o);
 347 }
 348 
 349 int RenderThemeGtk::baselinePosition(const RenderBox&amp; box) const
 350 {
 351     // FIXME: This strategy is possibly incorrect for the GTK+ port.
 352     if (box.style().appearance() == CheckboxPart || box.style().appearance() == RadioPart)
 353         return box.marginTop() + box.height() - 2;
 354     return RenderTheme::baselinePosition(box);
 355 }
 356 
<span class="line-removed"> 357 #if GTK_CHECK_VERSION(3, 20, 0)</span>
 358 void RenderThemeGtk::adjustRepaintRect(const RenderObject&amp;, FloatRect&amp;)
 359 {
 360 }
 361 static GtkStateFlags themePartStateFlags(const RenderThemeGtk&amp; theme, RenderThemePart themePart, const RenderObject&amp; renderObject)
 362 {
 363     unsigned stateFlags = 0;
 364     switch (renderObject.style().direction()) {
 365     case TextDirection::RTL:
 366         stateFlags |= GTK_STATE_FLAG_DIR_RTL;
 367         break;
 368     case TextDirection::LTR:
 369         stateFlags |= GTK_STATE_FLAG_DIR_LTR;
 370         break;
 371     }
 372 
 373     if (!theme.isEnabled(renderObject) || (themePart == Entry &amp;&amp; theme.isReadOnlyControl(renderObject)))
 374         stateFlags |= GTK_STATE_FLAG_INSENSITIVE;
 375     else {
 376         if (theme.isHovered(renderObject))
 377             stateFlags |= GTK_STATE_FLAG_PRELIGHT;
</pre>
<hr />
<pre>
 401             stateFlags |= GTK_STATE_FLAG_ACTIVE;
 402         break;
 403     case SpinButtonUpButton:
 404         if (theme.isPressed(renderObject) &amp;&amp; theme.isSpinUpButtonPartPressed(renderObject))
 405             stateFlags |= GTK_STATE_FLAG_ACTIVE;
 406         if (theme.isHovered(renderObject) &amp;&amp; !theme.isSpinUpButtonPartHovered(renderObject))
 407             stateFlags &amp;= ~GTK_STATE_FLAG_PRELIGHT;
 408         break;
 409     case SpinButtonDownButton:
 410         if (theme.isPressed(renderObject) &amp;&amp; !theme.isSpinUpButtonPartPressed(renderObject))
 411             stateFlags |= GTK_STATE_FLAG_ACTIVE;
 412         if (theme.isHovered(renderObject) &amp;&amp; theme.isSpinUpButtonPartHovered(renderObject))
 413             stateFlags &amp;= ~GTK_STATE_FLAG_PRELIGHT;
 414         break;
 415     default:
 416         break;
 417     }
 418 
 419     return static_cast&lt;GtkStateFlags&gt;(stateFlags);
 420 }
<span class="line-removed"> 421 #else</span>
<span class="line-removed"> 422 static GtkTextDirection gtkTextDirection(TextDirection direction)</span>
<span class="line-removed"> 423 {</span>
<span class="line-removed"> 424     switch (direction) {</span>
<span class="line-removed"> 425     case TextDirection::RTL:</span>
<span class="line-removed"> 426         return GTK_TEXT_DIR_RTL;</span>
<span class="line-removed"> 427     case TextDirection::LTR:</span>
<span class="line-removed"> 428         return GTK_TEXT_DIR_LTR;</span>
<span class="line-removed"> 429     default:</span>
<span class="line-removed"> 430         return GTK_TEXT_DIR_NONE;</span>
<span class="line-removed"> 431     }</span>
<span class="line-removed"> 432 }</span>
<span class="line-removed"> 433 </span>
<span class="line-removed"> 434 static GtkStateFlags gtkIconStateFlags(RenderTheme* theme, const RenderObject&amp; renderObject)</span>
<span class="line-removed"> 435 {</span>
<span class="line-removed"> 436     if (!theme-&gt;isEnabled(renderObject))</span>
<span class="line-removed"> 437         return GTK_STATE_FLAG_INSENSITIVE;</span>
<span class="line-removed"> 438     if (theme-&gt;isPressed(renderObject))</span>
<span class="line-removed"> 439         return GTK_STATE_FLAG_ACTIVE;</span>
<span class="line-removed"> 440     if (theme-&gt;isHovered(renderObject))</span>
<span class="line-removed"> 441         return GTK_STATE_FLAG_PRELIGHT;</span>
<span class="line-removed"> 442 </span>
<span class="line-removed"> 443     return GTK_STATE_FLAG_NORMAL;</span>
<span class="line-removed"> 444 }</span>
<span class="line-removed"> 445 </span>
<span class="line-removed"> 446 static void adjustRectForFocus(GtkStyleContext* context, FloatRect&amp; rect)</span>
<span class="line-removed"> 447 {</span>
<span class="line-removed"> 448     gint focusWidth, focusPad;</span>
<span class="line-removed"> 449     gtk_style_context_get_style(context, &quot;focus-line-width&quot;, &amp;focusWidth, &quot;focus-padding&quot;, &amp;focusPad, nullptr);</span>
<span class="line-removed"> 450     rect.inflate(focusWidth + focusPad);</span>
<span class="line-removed"> 451 }</span>
<span class="line-removed"> 452 </span>
<span class="line-removed"> 453 void RenderThemeGtk::adjustRepaintRect(const RenderObject&amp; renderObject, FloatRect&amp; rect)</span>
<span class="line-removed"> 454 {</span>
<span class="line-removed"> 455     GRefPtr&lt;GtkStyleContext&gt; context;</span>
<span class="line-removed"> 456     bool checkInteriorFocus = false;</span>
<span class="line-removed"> 457     ControlPart part = renderObject.style().appearance();</span>
<span class="line-removed"> 458     switch (part) {</span>
<span class="line-removed"> 459     case CheckboxPart:</span>
<span class="line-removed"> 460     case RadioPart:</span>
<span class="line-removed"> 461         context = createStyleContext(part == CheckboxPart ? CheckButton : RadioButton);</span>
<span class="line-removed"> 462 </span>
<span class="line-removed"> 463         gint indicatorSpacing;</span>
<span class="line-removed"> 464         gtk_style_context_get_style(context.get(), &quot;indicator-spacing&quot;, &amp;indicatorSpacing, nullptr);</span>
<span class="line-removed"> 465         rect.inflate(indicatorSpacing);</span>
<span class="line-removed"> 466 </span>
<span class="line-removed"> 467         return;</span>
<span class="line-removed"> 468     case SliderVerticalPart:</span>
<span class="line-removed"> 469     case SliderHorizontalPart:</span>
<span class="line-removed"> 470         context = createStyleContext(ScaleSlider);</span>
<span class="line-removed"> 471         break;</span>
<span class="line-removed"> 472     case ButtonPart:</span>
<span class="line-removed"> 473     case MenulistButtonPart:</span>
<span class="line-removed"> 474     case MenulistPart:</span>
<span class="line-removed"> 475         context = createStyleContext(Button);</span>
<span class="line-removed"> 476         checkInteriorFocus = true;</span>
<span class="line-removed"> 477         break;</span>
<span class="line-removed"> 478     case TextFieldPart:</span>
<span class="line-removed"> 479     case TextAreaPart:</span>
<span class="line-removed"> 480         context = createStyleContext(Entry);</span>
<span class="line-removed"> 481         checkInteriorFocus = true;</span>
<span class="line-removed"> 482         break;</span>
<span class="line-removed"> 483     default:</span>
<span class="line-removed"> 484         return;</span>
<span class="line-removed"> 485     }</span>
<span class="line-removed"> 486 </span>
<span class="line-removed"> 487     ASSERT(context);</span>
<span class="line-removed"> 488     if (checkInteriorFocus) {</span>
<span class="line-removed"> 489         gboolean interiorFocus;</span>
<span class="line-removed"> 490         gtk_style_context_get_style(context.get(), &quot;interior-focus&quot;, &amp;interiorFocus, nullptr);</span>
<span class="line-removed"> 491         if (interiorFocus)</span>
<span class="line-removed"> 492             return;</span>
<span class="line-removed"> 493     }</span>
<span class="line-removed"> 494     adjustRectForFocus(context.get(), rect);</span>
<span class="line-removed"> 495 }</span>
<span class="line-removed"> 496 #endif // GTK_CHECK_VERSION(3, 20, 0)</span>
 497 
 498 void RenderThemeGtk::adjustButtonStyle(StyleResolver&amp;, RenderStyle&amp; style, const Element*) const
 499 {
 500     // Some layout tests check explicitly that buttons ignore line-height.
 501     if (style.appearance() == PushButtonPart)
 502         style.setLineHeight(RenderStyle::initialLineHeight());
 503 }
 504 
 505 static void shrinkToMinimumSizeAndCenterRectangle(FloatRect&amp; rect, const IntSize&amp; minSize)
 506 {
 507     if (rect.width() &gt; minSize.width()) {
 508         rect.inflateX(-(rect.width() - minSize.width()) / 2);
 509         rect.setWidth(minSize.width()); // In case rect.width() was equal to minSize.width() + 1.
 510     }
 511 
 512     if (rect.height() &gt; minSize.height()) {
 513         rect.inflateY(-(rect.height() - minSize.height()) / 2);
 514         rect.setHeight(minSize.height()); // In case rect.height() was equal to minSize.height() + 1.
 515     }
 516 }
 517 
<span class="line-removed"> 518 #if GTK_CHECK_VERSION(3, 20, 0)</span>
 519 static void setToggleSize(RenderThemePart themePart, RenderStyle&amp; style)
 520 {
 521     ASSERT(themePart == CheckButton || themePart == RadioButton);
 522 
 523     // The width and height are both specified, so we shouldn&#39;t change them.
 524     if (!style.width().isIntrinsicOrAuto() &amp;&amp; !style.height().isAuto())
 525         return;
 526 
 527     auto&amp; toggleWidget = static_cast&lt;RenderThemeToggleButton&amp;&gt;(RenderThemeWidget::getOrCreate(themePart == CheckButton ? RenderThemeWidget::Type::CheckButton : RenderThemeWidget::Type::RadioButton));
 528     toggleWidget.button().setState(GTK_STATE_FLAG_NORMAL);
 529     toggleWidget.toggle().setState(GTK_STATE_FLAG_NORMAL);
 530     IntSize preferredSize = toggleWidget.button().preferredSize();
 531     preferredSize = preferredSize.expandedTo(toggleWidget.toggle().preferredSize());
 532 
 533     if (style.width().isIntrinsicOrAuto())
 534         style.setWidth(Length(preferredSize.width(), Fixed));
 535 
 536     if (style.height().isAuto())
 537         style.setHeight(Length(preferredSize.height(), Fixed));
 538 }
</pre>
<hr />
<pre>
 543 
 544     auto&amp; toggleWidget = static_cast&lt;RenderThemeToggleButton&amp;&gt;(RenderThemeWidget::getOrCreate(themePart == CheckButton ? RenderThemeWidget::Type::CheckButton : RenderThemeWidget::Type::RadioButton));
 545     auto toggleState = themePartStateFlags(*theme, themePart, renderObject);
 546     toggleWidget.button().setState(toggleState);
 547     toggleWidget.toggle().setState(toggleState);
 548 
 549     FloatRect rect = fullRect;
 550     // Some themes do not render large toggle buttons properly, so we simply
 551     // shrink the rectangle back down to the default size and then center it
 552     // in the full toggle button region. The reason for not simply forcing toggle
 553     // buttons to be a smaller size is that we don&#39;t want to break site layouts.
 554     IntSize preferredSize = toggleWidget.button().preferredSize();
 555     preferredSize = preferredSize.expandedTo(toggleWidget.toggle().preferredSize());
 556     shrinkToMinimumSizeAndCenterRectangle(rect, preferredSize);
 557     toggleWidget.button().render(paintInfo.context().platformContext()-&gt;cr(), rect);
 558     toggleWidget.toggle().render(paintInfo.context().platformContext()-&gt;cr(), rect);
 559 
 560     if (theme-&gt;isFocused(renderObject))
 561         toggleWidget.button().renderFocus(paintInfo.context().platformContext()-&gt;cr(), rect);
 562 }
<span class="line-removed"> 563 #else</span>
<span class="line-removed"> 564 static void setToggleSize(RenderThemePart themePart, RenderStyle&amp; style)</span>
<span class="line-removed"> 565 {</span>
<span class="line-removed"> 566     // The width and height are both specified, so we shouldn&#39;t change them.</span>
<span class="line-removed"> 567     if (!style.width().isIntrinsicOrAuto() &amp;&amp; !style.height().isAuto())</span>
<span class="line-removed"> 568         return;</span>
<span class="line-removed"> 569 </span>
<span class="line-removed"> 570     GRefPtr&lt;GtkStyleContext&gt; context = createStyleContext(themePart);</span>
<span class="line-removed"> 571     // Other ports hard-code this to 13. GTK+ users tend to demand the native look.</span>
<span class="line-removed"> 572     gint indicatorSize;</span>
<span class="line-removed"> 573     gtk_style_context_get_style(context.get(), &quot;indicator-size&quot;, &amp;indicatorSize, nullptr);</span>
<span class="line-removed"> 574 </span>
<span class="line-removed"> 575     if (style.width().isIntrinsicOrAuto())</span>
<span class="line-removed"> 576         style.setWidth(Length(indicatorSize, Fixed));</span>
<span class="line-removed"> 577 </span>
<span class="line-removed"> 578     if (style.height().isAuto())</span>
<span class="line-removed"> 579         style.setHeight(Length(indicatorSize, Fixed));</span>
<span class="line-removed"> 580 }</span>
<span class="line-removed"> 581 </span>
<span class="line-removed"> 582 static void paintToggle(const RenderThemeGtk* theme, RenderThemePart themePart, const RenderObject&amp; renderObject, const PaintInfo&amp; paintInfo, const IntRect&amp; fullRect)</span>
<span class="line-removed"> 583 {</span>
<span class="line-removed"> 584     GRefPtr&lt;GtkStyleContext&gt; context = createStyleContext(themePart);</span>
<span class="line-removed"> 585     gtk_style_context_set_direction(context.get(), static_cast&lt;GtkTextDirection&gt;(gtkTextDirection(renderObject.style().direction())));</span>
<span class="line-removed"> 586 </span>
<span class="line-removed"> 587     unsigned flags = 0;</span>
<span class="line-removed"> 588     if (!theme-&gt;isEnabled(renderObject))</span>
<span class="line-removed"> 589         flags |= GTK_STATE_FLAG_INSENSITIVE;</span>
<span class="line-removed"> 590     else if (theme-&gt;isHovered(renderObject))</span>
<span class="line-removed"> 591         flags |= GTK_STATE_FLAG_PRELIGHT;</span>
<span class="line-removed"> 592     if (theme-&gt;isIndeterminate(renderObject))</span>
<span class="line-removed"> 593         flags |= GTK_STATE_FLAG_INCONSISTENT;</span>
<span class="line-removed"> 594     else if (theme-&gt;isChecked(renderObject))</span>
<span class="line-removed"> 595 #if GTK_CHECK_VERSION(3, 13, 7)</span>
<span class="line-removed"> 596         flags |= GTK_STATE_FLAG_CHECKED;</span>
<span class="line-removed"> 597 #else</span>
<span class="line-removed"> 598         flags |= GTK_STATE_FLAG_ACTIVE;</span>
<span class="line-removed"> 599 #endif</span>
<span class="line-removed"> 600     if (theme-&gt;isPressed(renderObject))</span>
<span class="line-removed"> 601         flags |= GTK_STATE_FLAG_SELECTED;</span>
<span class="line-removed"> 602     gtk_style_context_set_state(context.get(), static_cast&lt;GtkStateFlags&gt;(flags));</span>
<span class="line-removed"> 603 </span>
<span class="line-removed"> 604     // Some themes do not render large toggle buttons properly, so we simply</span>
<span class="line-removed"> 605     // shrink the rectangle back down to the default size and then center it</span>
<span class="line-removed"> 606     // in the full toggle button region. The reason for not simply forcing toggle</span>
<span class="line-removed"> 607     // buttons to be a smaller size is that we don&#39;t want to break site layouts.</span>
<span class="line-removed"> 608     FloatRect rect(fullRect);</span>
<span class="line-removed"> 609     gint indicatorSize;</span>
<span class="line-removed"> 610     gtk_style_context_get_style(context.get(), &quot;indicator-size&quot;, &amp;indicatorSize, nullptr);</span>
<span class="line-removed"> 611     IntSize minSize(indicatorSize, indicatorSize);</span>
<span class="line-removed"> 612     shrinkToMinimumSizeAndCenterRectangle(rect, minSize);</span>
<span class="line-removed"> 613 </span>
<span class="line-removed"> 614     gtk_render_background(context.get(), paintInfo.context().platformContext()-&gt;cr(), rect.x(), rect.y(), rect.width(), rect.height());</span>
<span class="line-removed"> 615     gtk_render_frame(context.get(), paintInfo.context().platformContext()-&gt;cr(), rect.x(), rect.y(), rect.width(), rect.height());</span>
<span class="line-removed"> 616 </span>
<span class="line-removed"> 617     if (themePart == CheckButton)</span>
<span class="line-removed"> 618         gtk_render_check(context.get(), paintInfo.context().platformContext()-&gt;cr(), rect.x(), rect.y(), rect.width(), rect.height());</span>
<span class="line-removed"> 619     else</span>
<span class="line-removed"> 620         gtk_render_option(context.get(), paintInfo.context().platformContext()-&gt;cr(), rect.x(), rect.y(), rect.width(), rect.height());</span>
<span class="line-removed"> 621 </span>
<span class="line-removed"> 622     if (theme-&gt;isFocused(renderObject)) {</span>
<span class="line-removed"> 623         IntRect indicatorRect(rect);</span>
<span class="line-removed"> 624         gint indicatorSpacing;</span>
<span class="line-removed"> 625         gtk_style_context_get_style(context.get(), &quot;indicator-spacing&quot;, &amp;indicatorSpacing, nullptr);</span>
<span class="line-removed"> 626         indicatorRect.inflate(indicatorSpacing);</span>
<span class="line-removed"> 627         gtk_render_focus(context.get(), paintInfo.context().platformContext()-&gt;cr(), indicatorRect.x(), indicatorRect.y(),</span>
<span class="line-removed"> 628             indicatorRect.width(), indicatorRect.height());</span>
<span class="line-removed"> 629     }</span>
<span class="line-removed"> 630 }</span>
<span class="line-removed"> 631 #endif // GTK_CHECK_VERSION(3, 20, 0)</span>
 632 
 633 void RenderThemeGtk::setCheckboxSize(RenderStyle&amp; style) const
 634 {
 635     setToggleSize(CheckButton, style);
 636 }
 637 
 638 bool RenderThemeGtk::paintCheckbox(const RenderObject&amp; renderObject, const PaintInfo&amp; paintInfo, const IntRect&amp; rect)
 639 {
 640     paintToggle(this, CheckButton, renderObject, paintInfo, rect);
 641     return false;
 642 }
 643 
 644 void RenderThemeGtk::setRadioSize(RenderStyle&amp; style) const
 645 {
 646     setToggleSize(RadioButton, style);
 647 }
 648 
 649 bool RenderThemeGtk::paintRadio(const RenderObject&amp; renderObject, const PaintInfo&amp; paintInfo, const IntRect&amp; rect)
 650 {
 651     paintToggle(this, RadioButton, renderObject, paintInfo, rect);
 652     return false;
 653 }
 654 
<span class="line-removed"> 655 #if GTK_CHECK_VERSION(3, 20, 0)</span>
 656 bool RenderThemeGtk::paintButton(const RenderObject&amp; renderObject, const PaintInfo&amp; paintInfo, const IntRect&amp; rect)
 657 {
 658     auto&amp; buttonWidget = static_cast&lt;RenderThemeButton&amp;&gt;(RenderThemeWidget::getOrCreate(isDefault(renderObject) ? RenderThemeWidget::Type::ButtonDefault : RenderThemeWidget::Type::Button));
 659     buttonWidget.button().setState(themePartStateFlags(*this, Button, renderObject));
 660     buttonWidget.button().render(paintInfo.context().platformContext()-&gt;cr(), rect);
 661     if (isFocused(renderObject))
 662         buttonWidget.button().renderFocus(paintInfo.context().platformContext()-&gt;cr(), rect);
 663     return false;
 664 }
<span class="line-removed"> 665 #else</span>
<span class="line-removed"> 666 static void renderButton(RenderTheme* theme, GtkStyleContext* context, const RenderObject&amp; renderObject, const PaintInfo&amp; paintInfo, const IntRect&amp; rect)</span>
<span class="line-removed"> 667 {</span>
<span class="line-removed"> 668     IntRect buttonRect(rect);</span>
<span class="line-removed"> 669 </span>
<span class="line-removed"> 670     guint flags = 0;</span>
<span class="line-removed"> 671     if (!theme-&gt;isEnabled(renderObject))</span>
<span class="line-removed"> 672         flags |= GTK_STATE_FLAG_INSENSITIVE;</span>
<span class="line-removed"> 673     else if (theme-&gt;isHovered(renderObject))</span>
<span class="line-removed"> 674         flags |= GTK_STATE_FLAG_PRELIGHT;</span>
<span class="line-removed"> 675     if (theme-&gt;isPressed(renderObject))</span>
<span class="line-removed"> 676         flags |= GTK_STATE_FLAG_ACTIVE;</span>
<span class="line-removed"> 677     gtk_style_context_set_state(context, static_cast&lt;GtkStateFlags&gt;(flags));</span>
<span class="line-removed"> 678 </span>
<span class="line-removed"> 679     if (theme-&gt;isDefault(renderObject)) {</span>
<span class="line-removed"> 680         GtkBorder* borderPtr = 0;</span>
<span class="line-removed"> 681         GtkBorder border = { 1, 1, 1, 1 };</span>
<span class="line-removed"> 682 </span>
<span class="line-removed"> 683         gtk_style_context_get_style(context, &quot;default-border&quot;, &amp;borderPtr, nullptr);</span>
<span class="line-removed"> 684         if (borderPtr) {</span>
<span class="line-removed"> 685             border = *borderPtr;</span>
<span class="line-removed"> 686             gtk_border_free(borderPtr);</span>
<span class="line-removed"> 687         }</span>
<span class="line-removed"> 688 </span>
<span class="line-removed"> 689         buttonRect.move(border.left, border.top);</span>
<span class="line-removed"> 690         buttonRect.setWidth(buttonRect.width() - (border.left + border.right));</span>
<span class="line-removed"> 691         buttonRect.setHeight(buttonRect.height() - (border.top + border.bottom));</span>
<span class="line-removed"> 692 </span>
<span class="line-removed"> 693         gtk_style_context_add_class(context, GTK_STYLE_CLASS_DEFAULT);</span>
<span class="line-removed"> 694     }</span>
<span class="line-removed"> 695 </span>
<span class="line-removed"> 696     gtk_render_background(context, paintInfo.context().platformContext()-&gt;cr(), buttonRect.x(), buttonRect.y(), buttonRect.width(), buttonRect.height());</span>
<span class="line-removed"> 697     gtk_render_frame(context, paintInfo.context().platformContext()-&gt;cr(), buttonRect.x(), buttonRect.y(), buttonRect.width(), buttonRect.height());</span>
<span class="line-removed"> 698 </span>
<span class="line-removed"> 699     if (theme-&gt;isFocused(renderObject)) {</span>
<span class="line-removed"> 700         gint focusWidth, focusPad;</span>
<span class="line-removed"> 701         gboolean displaceFocus, interiorFocus;</span>
<span class="line-removed"> 702         gtk_style_context_get_style(</span>
<span class="line-removed"> 703             context,</span>
<span class="line-removed"> 704             &quot;focus-line-width&quot;, &amp;focusWidth,</span>
<span class="line-removed"> 705             &quot;focus-padding&quot;, &amp;focusPad,</span>
<span class="line-removed"> 706             &quot;interior-focus&quot;, &amp;interiorFocus,</span>
<span class="line-removed"> 707             &quot;displace-focus&quot;, &amp;displaceFocus,</span>
<span class="line-removed"> 708             nullptr);</span>
<span class="line-removed"> 709 </span>
<span class="line-removed"> 710         if (interiorFocus) {</span>
<span class="line-removed"> 711             GtkBorder borderWidth;</span>
<span class="line-removed"> 712             gtk_style_context_get_border(context, gtk_style_context_get_state(context), &amp;borderWidth);</span>
<span class="line-removed"> 713 </span>
<span class="line-removed"> 714             buttonRect = IntRect(</span>
<span class="line-removed"> 715                 buttonRect.x() + borderWidth.left + focusPad,</span>
<span class="line-removed"> 716                 buttonRect.y() + borderWidth.top + focusPad,</span>
<span class="line-removed"> 717                 buttonRect.width() - (2 * focusPad + borderWidth.left + borderWidth.right),</span>
<span class="line-removed"> 718                 buttonRect.height() - (2 * focusPad + borderWidth.top + borderWidth.bottom));</span>
<span class="line-removed"> 719         } else</span>
<span class="line-removed"> 720             buttonRect.inflate(focusWidth + focusPad);</span>
<span class="line-removed"> 721 </span>
<span class="line-removed"> 722         if (displaceFocus &amp;&amp; theme-&gt;isPressed(renderObject)) {</span>
<span class="line-removed"> 723             gint childDisplacementX;</span>
<span class="line-removed"> 724             gint childDisplacementY;</span>
<span class="line-removed"> 725             gtk_style_context_get_style(context, &quot;child-displacement-x&quot;, &amp;childDisplacementX, &quot;child-displacement-y&quot;, &amp;childDisplacementY, nullptr);</span>
<span class="line-removed"> 726             buttonRect.move(childDisplacementX, childDisplacementY);</span>
<span class="line-removed"> 727         }</span>
<span class="line-removed"> 728 </span>
<span class="line-removed"> 729         gtk_render_focus(context, paintInfo.context().platformContext()-&gt;cr(), buttonRect.x(), buttonRect.y(), buttonRect.width(), buttonRect.height());</span>
<span class="line-removed"> 730     }</span>
<span class="line-removed"> 731 }</span>
<span class="line-removed"> 732 bool RenderThemeGtk::paintButton(const RenderObject&amp; renderObject, const PaintInfo&amp; paintInfo, const IntRect&amp; rect)</span>
<span class="line-removed"> 733 {</span>
<span class="line-removed"> 734     GRefPtr&lt;GtkStyleContext&gt; context = createStyleContext(Button);</span>
<span class="line-removed"> 735     gtk_style_context_set_direction(context.get(), static_cast&lt;GtkTextDirection&gt;(gtkTextDirection(renderObject.style().direction())));</span>
<span class="line-removed"> 736     renderButton(this, context.get(), renderObject, paintInfo, rect);</span>
<span class="line-removed"> 737     return false;</span>
<span class="line-removed"> 738 }</span>
<span class="line-removed"> 739 #endif // GTK_CHECK_VERSION(3, 20, 0)</span>
 740 
 741 static Color menuListColor(const Element* element)
 742 {
<span class="line-removed"> 743 #if GTK_CHECK_VERSION(3, 20, 0)</span>
 744     auto&amp; comboWidget = static_cast&lt;RenderThemeComboBox&amp;&gt;(RenderThemeWidget::getOrCreate(RenderThemeWidget::Type::ComboBox));
 745     GtkStateFlags state = element-&gt;isDisabledFormControl() ? GTK_STATE_FLAG_INSENSITIVE : GTK_STATE_FLAG_NORMAL;
 746     comboWidget.comboBox().setState(state);
 747     comboWidget.button().setState(state);
 748     return comboWidget.button().color();
<span class="line-removed"> 749 #else</span>
<span class="line-removed"> 750     GRefPtr&lt;GtkStyleContext&gt; parentStyleContext = createStyleContext(ComboBox);</span>
<span class="line-removed"> 751     GRefPtr&lt;GtkStyleContext&gt; buttonStyleContext = createStyleContext(ComboBoxButton, parentStyleContext.get());</span>
<span class="line-removed"> 752     gtk_style_context_set_state(buttonStyleContext.get(), element-&gt;isDisabledFormControl() ? GTK_STATE_FLAG_INSENSITIVE : GTK_STATE_FLAG_NORMAL);</span>
<span class="line-removed"> 753 </span>
<span class="line-removed"> 754     GdkRGBA gdkRGBAColor;</span>
<span class="line-removed"> 755     gtk_style_context_get_color(buttonStyleContext.get(), gtk_style_context_get_state(buttonStyleContext.get()), &amp;gdkRGBAColor);</span>
<span class="line-removed"> 756     return gdkRGBAColor;</span>
<span class="line-removed"> 757 #endif // GTK_CHECK_VERSION(3, 20, 0)</span>
 758 }
 759 
 760 void RenderThemeGtk::adjustMenuListStyle(StyleResolver&amp;, RenderStyle&amp; style, const Element* element) const
 761 {
 762     // The tests check explicitly that select menu buttons ignore line height.
 763     style.setLineHeight(RenderStyle::initialLineHeight());
 764 
 765     // We cannot give a proper rendering when border radius is active, unfortunately.
 766     style.resetBorderRadius();
 767 
 768     if (element)
 769         style.setColor(menuListColor(element));
 770 }
 771 
 772 void RenderThemeGtk::adjustMenuListButtonStyle(StyleResolver&amp; styleResolver, RenderStyle&amp; style, const Element* e) const
 773 {
 774     adjustMenuListStyle(styleResolver, style, e);
 775 }
 776 
<span class="line-removed"> 777 #if GTK_CHECK_VERSION(3, 20, 0)</span>
 778 /*
 779  * GtkComboBox gadgets tree
 780  *
 781  * combobox
 782  * ├── box.linked
 783  * │   ╰── button.combo
 784  * │       ╰── box
 785  * │           ├── cellview
 786  * │           ╰── arrow
 787  * ╰── window.popup
 788  */
 789 LengthBox RenderThemeGtk::popupInternalPaddingBox(const RenderStyle&amp; style) const
 790 {
 791     if (style.appearance() == NoControlPart)
 792         return LengthBox(0);
 793 
 794     auto&amp; comboWidget = static_cast&lt;RenderThemeComboBox&amp;&gt;(RenderThemeWidget::getOrCreate(RenderThemeWidget::Type::ComboBox));
 795     comboWidget.comboBox().setState(GTK_STATE_FLAG_NORMAL);
 796     comboWidget.button().setState(GTK_STATE_FLAG_NORMAL);
 797     comboWidget.arrow().setState(GTK_STATE_FLAG_NORMAL);
</pre>
<hr />
<pre>
 813 bool RenderThemeGtk::paintMenuList(const RenderObject&amp; renderObject, const PaintInfo&amp; paintInfo, const FloatRect&amp; rect)
 814 {
 815     auto&amp; comboWidget = static_cast&lt;RenderThemeComboBox&amp;&gt;(RenderThemeWidget::getOrCreate(RenderThemeWidget::Type::ComboBox));
 816     auto comboState = themePartStateFlags(*this, ComboBoxButton, renderObject);
 817     comboWidget.comboBox().setState(comboState);
 818     comboWidget.button().setState(comboState);
 819     comboWidget.arrow().setState(comboState);
 820 
 821     cairo_t* cr = paintInfo.context().platformContext()-&gt;cr();
 822     comboWidget.comboBox().render(cr, rect);
 823     comboWidget.box().render(cr, rect);
 824     FloatRect contentsRect;
 825     comboWidget.button().render(cr, rect, &amp;contentsRect);
 826     comboWidget.buttonBox().render(cr, contentsRect);
 827     comboWidget.arrow().render(cr, contentsRect);
 828     if (isFocused(renderObject))
 829         comboWidget.button().renderFocus(cr, rect);
 830 
 831     return false;
 832 }
<span class="line-removed"> 833 #else</span>
<span class="line-removed"> 834 LengthBox RenderThemeGtk::popupInternalPaddingBox(const RenderStyle&amp; style) const</span>
<span class="line-removed"> 835 {</span>
<span class="line-removed"> 836     if (style.appearance() == NoControlPart)</span>
<span class="line-removed"> 837         return { 0, 0, 0, 0 };</span>
<span class="line-removed"> 838 </span>
<span class="line-removed"> 839     GRefPtr&lt;GtkStyleContext&gt; parentContext = createStyleContext(ComboBox);</span>
<span class="line-removed"> 840     GRefPtr&lt;GtkStyleContext&gt; context = createStyleContext(ComboBoxButton, parentContext.get());</span>
<span class="line-removed"> 841     gtk_style_context_set_direction(context.get(), static_cast&lt;GtkTextDirection&gt;(gtkTextDirection(style.direction())));</span>
<span class="line-removed"> 842     gtk_style_context_set_state(context.get(), static_cast&lt;GtkStateFlags&gt;(0));</span>
<span class="line-removed"> 843     GtkBorder borderWidth = { 0, 0, 0, 0 };</span>
<span class="line-removed"> 844     gtk_style_context_get_border(context.get(), gtk_style_context_get_state(context.get()), &amp;borderWidth);</span>
<span class="line-removed"> 845 </span>
<span class="line-removed"> 846     gboolean interiorFocus;</span>
<span class="line-removed"> 847     gint focusWidth, focusPad;</span>
<span class="line-removed"> 848     gtk_style_context_get_style(context.get(), &quot;interior-focus&quot;, &amp;interiorFocus, &quot;focus-line-width&quot;, &amp;focusWidth, &quot;focus-padding&quot;, &amp;focusPad, nullptr);</span>
<span class="line-removed"> 849     focusWidth = interiorFocus ? focusWidth + focusPad : 0;</span>
<span class="line-removed"> 850 </span>
<span class="line-removed"> 851     return { borderWidth.top + focusWidth, borderWidth.right + focusWidth + (style.direction() == TextDirection::LTR ? minArrowSize : 0),</span>
<span class="line-removed"> 852         borderWidth.bottom + focusWidth, borderWidth.left + focusWidth + (style.direction() == TextDirection::RTL ? minArrowSize : 0) };</span>
<span class="line-removed"> 853 }</span>
<span class="line-removed"> 854 </span>
<span class="line-removed"> 855 bool RenderThemeGtk::paintMenuList(const RenderObject&amp; renderObject, const PaintInfo&amp; paintInfo, const FloatRect&amp; r)</span>
<span class="line-removed"> 856 {</span>
<span class="line-removed"> 857     // FIXME: adopt subpixel themes.</span>
<span class="line-removed"> 858     IntRect rect = IntRect(r);</span>
<span class="line-removed"> 859 </span>
<span class="line-removed"> 860     cairo_t* cairoContext = paintInfo.context().platformContext()-&gt;cr();</span>
<span class="line-removed"> 861     GtkTextDirection direction = static_cast&lt;GtkTextDirection&gt;(gtkTextDirection(renderObject.style().direction()));</span>
<span class="line-removed"> 862 </span>
<span class="line-removed"> 863     GRefPtr&lt;GtkStyleContext&gt; parentStyleContext = createStyleContext(ComboBox);</span>
<span class="line-removed"> 864 </span>
<span class="line-removed"> 865     // Paint the button.</span>
<span class="line-removed"> 866     GRefPtr&lt;GtkStyleContext&gt; buttonStyleContext = createStyleContext(ComboBoxButton, parentStyleContext.get());</span>
<span class="line-removed"> 867     gtk_style_context_set_direction(buttonStyleContext.get(), direction);</span>
<span class="line-removed"> 868     renderButton(this, buttonStyleContext.get(), renderObject, paintInfo, rect);</span>
<span class="line-removed"> 869 </span>
<span class="line-removed"> 870     // Get the inner rectangle.</span>
<span class="line-removed"> 871     gint focusWidth, focusPad;</span>
<span class="line-removed"> 872     GtkBorder* innerBorderPtr = 0;</span>
<span class="line-removed"> 873     GtkBorder innerBorder = { 1, 1, 1, 1 };</span>
<span class="line-removed"> 874     gtk_style_context_get_style(buttonStyleContext.get(), &quot;inner-border&quot;, &amp;innerBorderPtr, &quot;focus-line-width&quot;, &amp;focusWidth, &quot;focus-padding&quot;, &amp;focusPad, nullptr);</span>
<span class="line-removed"> 875     if (innerBorderPtr) {</span>
<span class="line-removed"> 876         innerBorder = *innerBorderPtr;</span>
<span class="line-removed"> 877         gtk_border_free(innerBorderPtr);</span>
<span class="line-removed"> 878     }</span>
<span class="line-removed"> 879 </span>
<span class="line-removed"> 880     GtkBorder borderWidth;</span>
<span class="line-removed"> 881     GtkStateFlags state = gtk_style_context_get_state(buttonStyleContext.get());</span>
<span class="line-removed"> 882     gtk_style_context_get_border(buttonStyleContext.get(), state, &amp;borderWidth);</span>
<span class="line-removed"> 883 </span>
<span class="line-removed"> 884     focusWidth += focusPad;</span>
<span class="line-removed"> 885     IntRect innerRect(</span>
<span class="line-removed"> 886         rect.x() + innerBorder.left + borderWidth.left + focusWidth,</span>
<span class="line-removed"> 887         rect.y() + innerBorder.top + borderWidth.top + focusWidth,</span>
<span class="line-removed"> 888         rect.width() - borderWidth.left - borderWidth.right - innerBorder.left - innerBorder.right - (2 * focusWidth),</span>
<span class="line-removed"> 889         rect.height() - borderWidth.top - borderWidth.bottom - innerBorder.top - innerBorder.bottom - (2 * focusWidth));</span>
<span class="line-removed"> 890 </span>
<span class="line-removed"> 891     if (isPressed(renderObject)) {</span>
<span class="line-removed"> 892         gint childDisplacementX;</span>
<span class="line-removed"> 893         gint childDisplacementY;</span>
<span class="line-removed"> 894         gtk_style_context_get_style(buttonStyleContext.get(), &quot;child-displacement-x&quot;, &amp;childDisplacementX, &quot;child-displacement-y&quot;, &amp;childDisplacementY, nullptr);</span>
<span class="line-removed"> 895         innerRect.move(childDisplacementX, childDisplacementY);</span>
<span class="line-removed"> 896     }</span>
<span class="line-removed"> 897     innerRect.setWidth(std::max(1, innerRect.width()));</span>
<span class="line-removed"> 898     innerRect.setHeight(std::max(1, innerRect.height()));</span>
<span class="line-removed"> 899 </span>
<span class="line-removed"> 900     // Paint the arrow.</span>
<span class="line-removed"> 901     GRefPtr&lt;GtkStyleContext&gt; arrowStyleContext = createStyleContext(ComboBoxArrow, buttonStyleContext.get());</span>
<span class="line-removed"> 902     gtk_style_context_set_direction(arrowStyleContext.get(), direction);</span>
<span class="line-removed"> 903 </span>
<span class="line-removed"> 904     gfloat arrowScaling;</span>
<span class="line-removed"> 905     gtk_style_context_get_style(parentStyleContext.get(), &quot;arrow-scaling&quot;, &amp;arrowScaling, nullptr);</span>
<span class="line-removed"> 906 </span>
<span class="line-removed"> 907     IntSize arrowSize(minArrowSize, innerRect.height());</span>
<span class="line-removed"> 908     FloatPoint arrowPosition(innerRect.location());</span>
<span class="line-removed"> 909     if (direction == GTK_TEXT_DIR_LTR)</span>
<span class="line-removed"> 910         arrowPosition.move(innerRect.width() - arrowSize.width(), 0);</span>
<span class="line-removed"> 911 </span>
<span class="line-removed"> 912     // GTK+ actually fetches the xalign and valign values from the widget, but since we</span>
<span class="line-removed"> 913     // don&#39;t have a widget here, we are just using the default xalign and valign values of 0.5.</span>
<span class="line-removed"> 914     gint extent = std::min(arrowSize.width(), arrowSize.height()) * arrowScaling;</span>
<span class="line-removed"> 915     arrowPosition.move((arrowSize.width() - extent) / 2, (arrowSize.height() - extent) / 2);</span>
<span class="line-removed"> 916 </span>
<span class="line-removed"> 917     gtk_style_context_set_state(arrowStyleContext.get(), state);</span>
<span class="line-removed"> 918     gtk_render_arrow(arrowStyleContext.get(), cairoContext, G_PI, arrowPosition.x(), arrowPosition.y(), extent);</span>
<span class="line-removed"> 919 </span>
<span class="line-removed"> 920     return false;</span>
<span class="line-removed"> 921 }</span>
<span class="line-removed"> 922 #endif // GTK_CHECK_VERSION(3, 20, 0)</span>
 923 
 924 bool RenderThemeGtk::paintMenuListButtonDecorations(const RenderBox&amp; object, const PaintInfo&amp; info, const FloatRect&amp; rect)
 925 {
 926     return paintMenuList(object, info, rect);
 927 }
 928 
<span class="line-removed"> 929 bool RenderThemeGtk::isControlStyled(const RenderStyle&amp; style, const BorderData&amp; border, const FillLayer&amp; background, const Color&amp; backgroundColor) const</span>
<span class="line-removed"> 930 {</span>
<span class="line-removed"> 931     // To avoid rendering issues with dark themes, if text input elements have color styling, we don&#39;t style them with GTK.</span>
<span class="line-removed"> 932     if ((style.appearance() == TextFieldPart || style.appearance() == TextAreaPart || style.appearance() == SearchFieldPart) &amp;&amp; style.color() != RenderStyle::initialColor())</span>
<span class="line-removed"> 933         return true;</span>
<span class="line-removed"> 934 </span>
<span class="line-removed"> 935     return RenderTheme::isControlStyled(style, border, background, backgroundColor);</span>
<span class="line-removed"> 936 }</span>
<span class="line-removed"> 937 </span>
<span class="line-removed"> 938 #if GTK_CHECK_VERSION(3, 20, 0)</span>
<span class="line-removed"> 939 </span>
 940 static IntSize spinButtonSize()
 941 {
 942     auto&amp; spinButtonWidget = static_cast&lt;RenderThemeSpinButton&amp;&gt;(RenderThemeWidget::getOrCreate(RenderThemeWidget::Type::SpinButton));
 943     spinButtonWidget.spinButton().setState(GTK_STATE_FLAG_NORMAL);
 944     spinButtonWidget.entry().setState(GTK_STATE_FLAG_NORMAL);
 945     spinButtonWidget.up().setState(GTK_STATE_FLAG_NORMAL);
 946     spinButtonWidget.down().setState(GTK_STATE_FLAG_NORMAL);
 947 
 948     IntSize preferredSize = spinButtonWidget.spinButton().preferredSize();
 949     preferredSize = preferredSize.expandedTo(spinButtonWidget.entry().preferredSize());
 950     IntSize upPreferredSize = preferredSize.expandedTo(spinButtonWidget.up().preferredSize());
 951     IntSize downPreferredSize = preferredSize.expandedTo(spinButtonWidget.down().preferredSize());
 952 
 953     return IntSize(upPreferredSize.width() + downPreferredSize.width(), std::max(upPreferredSize.height(), downPreferredSize.height()));
 954 }
 955 
 956 
 957 void RenderThemeGtk::adjustTextFieldStyle(StyleResolver&amp;, RenderStyle&amp; style, const Element* element) const
 958 {
 959     if (!is&lt;HTMLInputElement&gt;(element) || !shouldHaveSpinButton(downcast&lt;HTMLInputElement&gt;(*element)))
 960         return;
 961 
 962     style.setMinHeight(Length(spinButtonSize().height(), Fixed));
 963 
 964     // The default theme for the GTK+ port uses very wide spin buttons (66px) compared to what other
 965     // browsers use (~13 px). And unfortunately, most of the web developers won&#39;t test how their site
<span class="line-modified"> 966     // renders on WebKitGTK+. To ensure that spin buttons don&#39;t end up covering the values of the input</span>
 967     // field, we override the width of the input element and always increment it with the width needed
 968     // for the spinbutton (when drawing the spinbutton).
 969     int minimumWidth = style.width().intValue() + spinButtonSize().width();
 970     style.setMinWidth(Length(minimumWidth, Fixed));
 971 }
 972 
 973 bool RenderThemeGtk::paintTextField(const RenderObject&amp; renderObject, const PaintInfo&amp; paintInfo, const FloatRect&amp; rect)
 974 {
 975     if (is&lt;HTMLInputElement&gt;(renderObject.node()) &amp;&amp; shouldHaveSpinButton(downcast&lt;HTMLInputElement&gt;(*renderObject.node()))) {
 976         auto&amp; spinButtonWidget = static_cast&lt;RenderThemeSpinButton&amp;&gt;(RenderThemeWidget::getOrCreate(RenderThemeWidget::Type::SpinButton));
 977         auto spinButtonState = themePartStateFlags(*this, Entry, renderObject);
 978         spinButtonWidget.spinButton().setState(spinButtonState);
 979         spinButtonWidget.entry().setState(spinButtonState);
 980         spinButtonWidget.spinButton().render(paintInfo.context().platformContext()-&gt;cr(), rect);
 981         spinButtonWidget.entry().render(paintInfo.context().platformContext()-&gt;cr(), rect);
 982     } else {
 983         auto&amp; entryWidget = static_cast&lt;RenderThemeEntry&amp;&gt;(RenderThemeWidget::getOrCreate(RenderThemeWidget::Type::Entry));
 984         entryWidget.entry().setState(themePartStateFlags(*this, Entry, renderObject));
 985         entryWidget.entry().render(paintInfo.context().platformContext()-&gt;cr(), rect);
<span class="line-removed"> 986     }</span>
<span class="line-removed"> 987     return false;</span>
<span class="line-removed"> 988 }</span>
<span class="line-removed"> 989 #else</span>
<span class="line-removed"> 990 void RenderThemeGtk::adjustTextFieldStyle(StyleResolver&amp;, RenderStyle&amp;, const Element*) const</span>
<span class="line-removed"> 991 {</span>
<span class="line-removed"> 992 }</span>
 993 
<span class="line-modified"> 994 bool RenderThemeGtk::paintTextField(const RenderObject&amp; renderObject, const PaintInfo&amp; paintInfo, const FloatRect&amp; rect)</span>
<span class="line-modified"> 995 {</span>
<span class="line-modified"> 996     GRefPtr&lt;GtkStyleContext&gt; context = createStyleContext(Entry);</span>
<span class="line-modified"> 997     gtk_style_context_set_direction(context.get(), static_cast&lt;GtkTextDirection&gt;(gtkTextDirection(renderObject.style().direction())));</span>
<span class="line-modified"> 998 </span>
<span class="line-removed"> 999     guint flags = 0;</span>
<span class="line-removed">1000     if (!isEnabled(renderObject) || isReadOnlyControl(renderObject))</span>
<span class="line-removed">1001         flags |= GTK_STATE_FLAG_INSENSITIVE;</span>
<span class="line-removed">1002     else if (isFocused(renderObject))</span>
<span class="line-removed">1003         flags |= GTK_STATE_FLAG_FOCUSED;</span>
<span class="line-removed">1004     gtk_style_context_set_state(context.get(), static_cast&lt;GtkStateFlags&gt;(flags));</span>
<span class="line-removed">1005 </span>
<span class="line-removed">1006     gtk_render_background(context.get(), paintInfo.context().platformContext()-&gt;cr(), rect.x(), rect.y(), rect.width(), rect.height());</span>
<span class="line-removed">1007     gtk_render_frame(context.get(), paintInfo.context().platformContext()-&gt;cr(), rect.x(), rect.y(), rect.width(), rect.height());</span>
<span class="line-removed">1008 </span>
<span class="line-removed">1009     if (isFocused(renderObject) &amp;&amp; isEnabled(renderObject)) {</span>
<span class="line-removed">1010         gboolean interiorFocus;</span>
<span class="line-removed">1011         gint focusWidth, focusPad;</span>
<span class="line-removed">1012         gtk_style_context_get_style(context.get(), &quot;interior-focus&quot;, &amp;interiorFocus, &quot;focus-line-width&quot;, &amp;focusWidth, &quot;focus-padding&quot;, &amp;focusPad, nullptr);</span>
<span class="line-removed">1013         if (!interiorFocus) {</span>
<span class="line-removed">1014             IntRect focusRect(rect);</span>
<span class="line-removed">1015             focusRect.inflate(focusWidth + focusPad);</span>
<span class="line-removed">1016             gtk_render_focus(context.get(), paintInfo.context().platformContext()-&gt;cr(), focusRect.x(), focusRect.y(), focusRect.width(), focusRect.height());</span>
1017         }

1018     }
<span class="line-removed">1019 </span>
1020     return false;
1021 }
<span class="line-removed">1022 #endif</span>
1023 
<span class="line-removed">1024 #if GTK_CHECK_VERSION(3, 20, 0)</span>
1025 static void adjustSearchFieldIconStyle(RenderThemePart themePart, RenderStyle&amp; style)
1026 {
1027     ASSERT(themePart == EntryIconLeft || themePart == EntryIconRight);
1028     auto&amp; searchEntryWidget = static_cast&lt;RenderThemeSearchEntry&amp;&gt;(RenderThemeWidget::getOrCreate(RenderThemeWidget::Type::SearchEntry));
1029     searchEntryWidget.entry().setState(GTK_STATE_FLAG_NORMAL);
1030     searchEntryWidget.leftIcon().setState(GTK_STATE_FLAG_NORMAL);
1031     searchEntryWidget.rightIcon().setState(GTK_STATE_FLAG_NORMAL);
1032 
1033     // Get the icon size based on the font size.
1034     auto&amp; icon = static_cast&lt;RenderThemeIconGadget&amp;&gt;(themePart == EntryIconLeft ? searchEntryWidget.leftIcon() : searchEntryWidget.rightIcon());
1035     icon.setIconSize(style.computedFontPixelSize());
1036     IntSize preferredSize = icon.preferredSize();
1037     GtkBorder contentsBox = searchEntryWidget.entry().contentsBox();
1038     if (themePart == EntryIconLeft)
1039         preferredSize.expand(contentsBox.left, contentsBox.top + contentsBox.bottom);
1040     else
1041         preferredSize.expand(contentsBox.right, contentsBox.top + contentsBox.bottom);
1042     style.setWidth(Length(preferredSize.width(), Fixed));
1043     style.setHeight(Length(preferredSize.height(), Fixed));
1044 }
<span class="line-removed">1045 #else</span>
<span class="line-removed">1046 // Defined in GTK+ (gtk/gtkiconfactory.c)</span>
<span class="line-removed">1047 static const gint gtkIconSizeMenu = 16;</span>
<span class="line-removed">1048 static const gint gtkIconSizeSmallToolbar = 18;</span>
<span class="line-removed">1049 static const gint gtkIconSizeButton = 20;</span>
<span class="line-removed">1050 static const gint gtkIconSizeLargeToolbar = 24;</span>
<span class="line-removed">1051 static const gint gtkIconSizeDnd = 32;</span>
<span class="line-removed">1052 static const gint gtkIconSizeDialog = 48;</span>
<span class="line-removed">1053 </span>
<span class="line-removed">1054 static GtkIconSize getIconSizeForPixelSize(gint pixelSize)</span>
<span class="line-removed">1055 {</span>
<span class="line-removed">1056     if (pixelSize &lt; gtkIconSizeSmallToolbar)</span>
<span class="line-removed">1057         return GTK_ICON_SIZE_MENU;</span>
<span class="line-removed">1058     if (pixelSize &gt;= gtkIconSizeSmallToolbar &amp;&amp; pixelSize &lt; gtkIconSizeButton)</span>
<span class="line-removed">1059         return GTK_ICON_SIZE_SMALL_TOOLBAR;</span>
<span class="line-removed">1060     if (pixelSize &gt;= gtkIconSizeButton &amp;&amp; pixelSize &lt; gtkIconSizeLargeToolbar)</span>
<span class="line-removed">1061         return GTK_ICON_SIZE_BUTTON;</span>
<span class="line-removed">1062     if (pixelSize &gt;= gtkIconSizeLargeToolbar &amp;&amp; pixelSize &lt; gtkIconSizeDnd)</span>
<span class="line-removed">1063         return GTK_ICON_SIZE_LARGE_TOOLBAR;</span>
<span class="line-removed">1064     if (pixelSize &gt;= gtkIconSizeDnd &amp;&amp; pixelSize &lt; gtkIconSizeDialog)</span>
<span class="line-removed">1065         return GTK_ICON_SIZE_DND;</span>
<span class="line-removed">1066 </span>
<span class="line-removed">1067     return GTK_ICON_SIZE_DIALOG;</span>
<span class="line-removed">1068 }</span>
<span class="line-removed">1069 </span>
<span class="line-removed">1070 static void adjustSearchFieldIconStyle(RenderThemePart themePart, RenderStyle&amp; style)</span>
<span class="line-removed">1071 {</span>
<span class="line-removed">1072     style.resetBorder();</span>
<span class="line-removed">1073     style.resetPadding();</span>
<span class="line-removed">1074 </span>
<span class="line-removed">1075     GRefPtr&lt;GtkStyleContext&gt; parentContext = createStyleContext(Entry);</span>
<span class="line-removed">1076     GRefPtr&lt;GtkStyleContext&gt; context = createStyleContext(themePart, parentContext.get());</span>
<span class="line-removed">1077 </span>
<span class="line-removed">1078     GtkBorder padding;</span>
<span class="line-removed">1079     gtk_style_context_get_padding(context.get(), gtk_style_context_get_state(context.get()), &amp;padding);</span>
<span class="line-removed">1080 </span>
<span class="line-removed">1081     // Get the icon size based on the font size.</span>
<span class="line-removed">1082     int fontSize = style.computedFontPixelSize();</span>
<span class="line-removed">1083     if (fontSize &lt; gtkIconSizeMenu) {</span>
<span class="line-removed">1084         style.setWidth(Length(fontSize + (padding.left + padding.right), Fixed));</span>
<span class="line-removed">1085         style.setHeight(Length(fontSize + (padding.top + padding.bottom), Fixed));</span>
<span class="line-removed">1086         return;</span>
<span class="line-removed">1087     }</span>
<span class="line-removed">1088     gint width = 0, height = 0;</span>
<span class="line-removed">1089     gtk_icon_size_lookup(getIconSizeForPixelSize(fontSize), &amp;width, &amp;height);</span>
<span class="line-removed">1090     style.setWidth(Length(width + (padding.left + padding.right), Fixed));</span>
<span class="line-removed">1091     style.setHeight(Length(height + (padding.top + padding.bottom), Fixed));</span>
<span class="line-removed">1092 }</span>
<span class="line-removed">1093 #endif</span>
1094 
1095 bool RenderThemeGtk::paintTextArea(const RenderObject&amp; o, const PaintInfo&amp; i, const FloatRect&amp; r)
1096 {
1097     return paintTextField(o, i, r);
1098 }
1099 
1100 void RenderThemeGtk::adjustSearchFieldResultsButtonStyle(StyleResolver&amp; styleResolver, RenderStyle&amp; style, const Element* e) const
1101 {
1102     adjustSearchFieldCancelButtonStyle(styleResolver, style, e);
1103 }
1104 
1105 bool RenderThemeGtk::paintSearchFieldResultsButton(const RenderBox&amp; o, const PaintInfo&amp; i, const IntRect&amp; rect)
1106 {
1107     return paintSearchFieldResultsDecorationPart(o, i, rect);
1108 }
1109 
1110 void RenderThemeGtk::adjustSearchFieldResultsDecorationPartStyle(StyleResolver&amp;, RenderStyle&amp; style, const Element*) const
1111 {
1112     adjustSearchFieldIconStyle(EntryIconLeft, style);
1113 }
1114 
1115 void RenderThemeGtk::adjustSearchFieldCancelButtonStyle(StyleResolver&amp;, RenderStyle&amp; style, const Element*) const
1116 {
1117     adjustSearchFieldIconStyle(EntryIconRight, style);
1118 }
1119 
<span class="line-removed">1120 #if GTK_CHECK_VERSION(3, 20, 0)</span>
1121 static bool paintSearchFieldIcon(RenderThemeGtk* theme, RenderThemePart themePart, const RenderBox&amp; renderObject, const PaintInfo&amp; paintInfo, const IntRect&amp; rect)
1122 {
1123     ASSERT(themePart == EntryIconLeft || themePart == EntryIconRight);
1124     auto&amp; searchEntryWidget = static_cast&lt;RenderThemeSearchEntry&amp;&gt;(RenderThemeWidget::getOrCreate(RenderThemeWidget::Type::SearchEntry));
1125     searchEntryWidget.entry().setState(themePartStateFlags(*theme, Entry, renderObject));
1126     auto&amp; icon = static_cast&lt;RenderThemeIconGadget&amp;&gt;(themePart == EntryIconLeft ? searchEntryWidget.leftIcon() : searchEntryWidget.rightIcon());
1127     icon.setState(themePartStateFlags(*theme, themePart, renderObject));
1128     icon.setIconSize(renderObject.style().computedFontPixelSize());
1129     GtkBorder contentsBox = searchEntryWidget.entry().contentsBox();
1130     IntRect iconRect = rect;
1131     if (themePart == EntryIconLeft) {
1132         iconRect.move(contentsBox.left, contentsBox.top);
1133         iconRect.contract(contentsBox.left, contentsBox.top + contentsBox.bottom);
1134     } else
1135         iconRect.contract(contentsBox.right, contentsBox.top + contentsBox.bottom);
1136     return !icon.render(paintInfo.context().platformContext()-&gt;cr(), iconRect);
1137 }
1138 bool RenderThemeGtk::paintSearchFieldResultsDecorationPart(const RenderBox&amp; renderObject, const PaintInfo&amp; paintInfo, const IntRect&amp; rect)
1139 {
1140     return paintSearchFieldIcon(this, EntryIconLeft, renderObject, paintInfo, rect);
1141 }
1142 
1143 bool RenderThemeGtk::paintSearchFieldCancelButton(const RenderBox&amp; renderObject, const PaintInfo&amp; paintInfo, const IntRect&amp; rect)
1144 {
1145     return paintSearchFieldIcon(this, EntryIconRight, renderObject, paintInfo, rect);
1146 }
<span class="line-removed">1147 #else</span>
<span class="line-removed">1148 static bool paintIcon(GtkStyleContext* context, GraphicsContext&amp; graphicsContext, const IntRect&amp; rect, const char* iconName)</span>
<span class="line-removed">1149 {</span>
<span class="line-removed">1150     GRefPtr&lt;GdkPixbuf&gt; icon = loadThemedIcon(context, iconName, getIconSizeForPixelSize(rect.height()));</span>
<span class="line-removed">1151     if (!icon)</span>
<span class="line-removed">1152         return false;</span>
<span class="line-removed">1153 </span>
<span class="line-removed">1154     if (gdk_pixbuf_get_width(icon.get()) &gt; rect.width() || gdk_pixbuf_get_height(icon.get()) &gt; rect.height())</span>
<span class="line-removed">1155         icon = adoptGRef(gdk_pixbuf_scale_simple(icon.get(), rect.width(), rect.height(), GDK_INTERP_BILINEAR));</span>
<span class="line-removed">1156 </span>
<span class="line-removed">1157     gtk_render_icon(context, graphicsContext.platformContext()-&gt;cr(), icon.get(), rect.x(), rect.y());</span>
<span class="line-removed">1158     return true;</span>
<span class="line-removed">1159 }</span>
<span class="line-removed">1160 </span>
<span class="line-removed">1161 static bool paintEntryIcon(RenderThemePart themePart, const char* iconName, GraphicsContext&amp; graphicsContext, const IntRect&amp; rect, GtkTextDirection direction, GtkStateFlags state)</span>
<span class="line-removed">1162 {</span>
<span class="line-removed">1163     GRefPtr&lt;GtkStyleContext&gt; parentContext = createStyleContext(Entry);</span>
<span class="line-removed">1164     GRefPtr&lt;GtkStyleContext&gt; context = createStyleContext(themePart, parentContext.get());</span>
<span class="line-removed">1165     gtk_style_context_set_direction(context.get(), direction);</span>
<span class="line-removed">1166     gtk_style_context_set_state(context.get(), state);</span>
<span class="line-removed">1167     return paintIcon(context.get(), graphicsContext, rect, iconName);</span>
<span class="line-removed">1168 }</span>
<span class="line-removed">1169 </span>
<span class="line-removed">1170 static IntRect centerRectVerticallyInParentInputElement(const RenderObject&amp; renderObject, const IntRect&amp; rect)</span>
<span class="line-removed">1171 {</span>
<span class="line-removed">1172     if (!renderObject.node())</span>
<span class="line-removed">1173         return IntRect();</span>
<span class="line-removed">1174 </span>
<span class="line-removed">1175     // Get the renderer of &lt;input&gt; element.</span>
<span class="line-removed">1176     Node* input = renderObject.node()-&gt;shadowHost();</span>
<span class="line-removed">1177     if (!input)</span>
<span class="line-removed">1178         input = renderObject.node();</span>
<span class="line-removed">1179     if (!is&lt;RenderBox&gt;(*input-&gt;renderer()))</span>
<span class="line-removed">1180         return IntRect();</span>
<span class="line-removed">1181 </span>
<span class="line-removed">1182     // If possible center the y-coordinate of the rect vertically in the parent input element.</span>
<span class="line-removed">1183     // We also add one pixel here to ensure that the y coordinate is rounded up for box heights</span>
<span class="line-removed">1184     // that are even, which looks in relation to the box text.</span>
<span class="line-removed">1185     IntRect inputContentBox = downcast&lt;RenderBox&gt;(*input-&gt;renderer()).absoluteContentBox();</span>
<span class="line-removed">1186 </span>
<span class="line-removed">1187     // Make sure the scaled decoration stays square and will fit in its parent&#39;s box.</span>
<span class="line-removed">1188     int iconSize = std::min(inputContentBox.width(), std::min(inputContentBox.height(), rect.height()));</span>
<span class="line-removed">1189     IntRect scaledRect(rect.x(), inputContentBox.y() + (inputContentBox.height() - iconSize + 1) / 2, iconSize, iconSize);</span>
<span class="line-removed">1190     return scaledRect;</span>
<span class="line-removed">1191 }</span>
1192 
<span class="line-modified">1193 bool RenderThemeGtk::paintSearchFieldResultsDecorationPart(const RenderBox&amp; renderObject, const PaintInfo&amp; paintInfo, const IntRect&amp; rect)</span>

1194 {
<span class="line-modified">1195     IntRect iconRect = centerRectVerticallyInParentInputElement(renderObject, rect);</span>
<span class="line-modified">1196     if (iconRect.isEmpty())</span>
<span class="line-modified">1197         return true;</span>
<span class="line-modified">1198 </span>
<span class="line-modified">1199     return !paintEntryIcon(EntryIconLeft, &quot;edit-find-symbolic&quot;, paintInfo.context(), iconRect, gtkTextDirection(renderObject.style().direction()),</span>
<span class="line-removed">1200         gtkIconStateFlags(this, renderObject));</span>
1201 }
1202 
<span class="line-modified">1203 bool RenderThemeGtk::paintSearchFieldCancelButton(const RenderBox&amp; renderObject, const PaintInfo&amp; paintInfo, const IntRect&amp; rect)</span>
1204 {
<span class="line-modified">1205     IntRect iconRect = centerRectVerticallyInParentInputElement(renderObject, rect);</span>
<span class="line-modified">1206     if (iconRect.isEmpty())</span>
<span class="line-modified">1207         return true;</span>
1208 
<span class="line-modified">1209     return !paintEntryIcon(EntryIconRight, &quot;edit-clear-symbolic&quot;, paintInfo.context(), iconRect, gtkTextDirection(renderObject.style().direction()),</span>
<span class="line-modified">1210         gtkIconStateFlags(this, renderObject));</span>







1211 }
<span class="line-modified">1212 #endif // GTK_CHECK_VERSION(3, 20, 0)</span>
1213 
1214 void RenderThemeGtk::adjustSearchFieldStyle(StyleResolver&amp;, RenderStyle&amp; style, const Element*) const
1215 {
1216     // We cannot give a proper rendering when border radius is active, unfortunately.
1217     style.resetBorderRadius();
1218     style.setLineHeight(RenderStyle::initialLineHeight());
1219 }
1220 
1221 bool RenderThemeGtk::paintSearchField(const RenderObject&amp; o, const PaintInfo&amp; i, const IntRect&amp; rect)
1222 {
1223     return paintTextField(o, i, rect);
1224 }
1225 
1226 bool RenderThemeGtk::shouldHaveCapsLockIndicator(const HTMLInputElement&amp; element) const
1227 {
1228     return element.isPasswordField();
1229 }
1230 
1231 void RenderThemeGtk::adjustSliderTrackStyle(StyleResolver&amp;, RenderStyle&amp; style, const Element*) const
1232 {
1233     style.setBoxShadow(nullptr);
1234 }
1235 
1236 void RenderThemeGtk::adjustSliderThumbStyle(StyleResolver&amp; styleResolver, RenderStyle&amp; style, const Element* element) const
1237 {
1238     RenderTheme::adjustSliderThumbStyle(styleResolver, style, element);
1239     style.setBoxShadow(nullptr);
1240 }
1241 
<span class="line-removed">1242 #if GTK_CHECK_VERSION(3, 20, 0)</span>
1243 /*
1244  * GtkScale
1245  *
1246  * scale
1247  * ╰── contents
1248  *     ╰── trough
1249  *         ├── slider
1250  *         ╰── [highlight]
1251  */
1252 bool RenderThemeGtk::paintSliderTrack(const RenderObject&amp; renderObject, const PaintInfo&amp; paintInfo, const IntRect&amp; rect)
1253 {
1254     ControlPart part = renderObject.style().appearance();
1255     ASSERT(part == SliderHorizontalPart || part == SliderVerticalPart);
1256 
1257     auto&amp; sliderWidget = static_cast&lt;RenderThemeSlider&amp;&gt;(RenderThemeWidget::getOrCreate(part == SliderHorizontalPart ? RenderThemeWidget::Type::HorizontalSlider : RenderThemeWidget::Type::VerticalSlider));
1258     auto scaleState = themePartStateFlags(*this, Scale, renderObject);
1259     auto&amp; scale = sliderWidget.scale();
1260     scale.setState(scaleState);
1261     auto&amp; contents = sliderWidget.contents();
1262     auto&amp; trough = sliderWidget.trough();
</pre>
<hr />
<pre>
1350     slider.setState(themePartStateFlags(*this, ScaleSlider, renderObject));
1351     auto&amp; highlight = sliderWidget.highlight();
1352 
1353     GtkBorder scaleContentsBox = scale.contentsBox();
1354     GtkBorder contentsContentsBox = contents.contentsBox();
1355     GtkBorder troughContentsBox = trough.contentsBox();
1356     GtkBorder padding;
1357     padding.left = scaleContentsBox.left + contentsContentsBox.left + troughContentsBox.left;
1358     padding.right = scaleContentsBox.right + contentsContentsBox.right + troughContentsBox.right;
1359     padding.top = scaleContentsBox.top + contentsContentsBox.top + troughContentsBox.top;
1360     padding.bottom = scaleContentsBox.bottom + contentsContentsBox.bottom + troughContentsBox.bottom;
1361 
1362     // Scale trough defines its size querying slider and highlight.
1363     int troughHeight = trough.preferredSize().height() + std::max(slider.preferredSize().height(), highlight.preferredSize().height());
1364     IntRect sliderRect(rect.location(), IntSize(troughHeight, troughHeight));
1365     sliderRect.move(padding.left, padding.top);
1366     sliderRect.contract(padding.left + padding.right, padding.top + padding.bottom);
1367     slider.render(paintInfo.context().platformContext()-&gt;cr(), sliderRect);
1368     return false;
1369 }
<span class="line-removed">1370 #else</span>
<span class="line-removed">1371 bool RenderThemeGtk::paintSliderTrack(const RenderObject&amp; renderObject, const PaintInfo&amp; paintInfo, const IntRect&amp; rect)</span>
<span class="line-removed">1372 {</span>
<span class="line-removed">1373     ControlPart part = renderObject.style().appearance();</span>
<span class="line-removed">1374     ASSERT(part == SliderHorizontalPart || part == SliderVerticalPart);</span>
<span class="line-removed">1375 </span>
<span class="line-removed">1376     GRefPtr&lt;GtkStyleContext&gt; parentContext = createStyleContext(Scale);</span>
<span class="line-removed">1377     gtk_style_context_add_class(parentContext.get(), part == SliderHorizontalPart ? GTK_STYLE_CLASS_HORIZONTAL : GTK_STYLE_CLASS_VERTICAL);</span>
<span class="line-removed">1378     GRefPtr&lt;GtkStyleContext&gt; context = createStyleContext(ScaleTrough, parentContext.get());</span>
<span class="line-removed">1379     gtk_style_context_set_direction(context.get(), gtkTextDirection(renderObject.style().direction()));</span>
<span class="line-removed">1380 </span>
<span class="line-removed">1381     if (!isEnabled(renderObject))</span>
<span class="line-removed">1382         gtk_style_context_set_state(context.get(), GTK_STATE_FLAG_INSENSITIVE);</span>
1383 
<span class="line-removed">1384     IntRect sliderRect = rect;</span>
<span class="line-removed">1385     // GTK+ uses the slider thumb size and margins to calculate the trough size, but in WebKit we render the thumb and</span>
<span class="line-removed">1386     // the slider track separately and the track rectangle we receive here can&#39;t be used to apply the GTK+ CSS sizes</span>
<span class="line-removed">1387     // and margins. So we use a maximum fixed size for the trough to match at least Adwaita, but that should look</span>
<span class="line-removed">1388     // good in other themes as well.</span>
<span class="line-removed">1389     static const int sliderSize = 4;</span>
<span class="line-removed">1390 </span>
<span class="line-removed">1391     if (part == SliderHorizontalPart) {</span>
<span class="line-removed">1392         sliderRect.setHeight(std::min(rect.height(), sliderSize));</span>
<span class="line-removed">1393         sliderRect.move(0, (rect.height() - sliderRect.height()) / 2);</span>
<span class="line-removed">1394     } else {</span>
<span class="line-removed">1395         sliderRect.setWidth(std::min(rect.width(), sliderSize));</span>
<span class="line-removed">1396         sliderRect.move((rect.width() - sliderRect.width()) / 2, 0);</span>
<span class="line-removed">1397     }</span>
<span class="line-removed">1398 </span>
<span class="line-removed">1399     gtk_render_background(context.get(), paintInfo.context().platformContext()-&gt;cr(), sliderRect.x(), sliderRect.y(), sliderRect.width(), sliderRect.height());</span>
<span class="line-removed">1400     gtk_render_frame(context.get(), paintInfo.context().platformContext()-&gt;cr(), sliderRect.x(), sliderRect.y(), sliderRect.width(), sliderRect.height());</span>
<span class="line-removed">1401 </span>
<span class="line-removed">1402     if (isFocused(renderObject)) {</span>
<span class="line-removed">1403         gint focusWidth, focusPad;</span>
<span class="line-removed">1404         gtk_style_context_get_style(context.get(), &quot;focus-line-width&quot;, &amp;focusWidth, &quot;focus-padding&quot;, &amp;focusPad, nullptr);</span>
<span class="line-removed">1405         IntRect focusRect(sliderRect);</span>
<span class="line-removed">1406         focusRect.inflate(focusWidth + focusPad);</span>
<span class="line-removed">1407         gtk_render_focus(context.get(), paintInfo.context().platformContext()-&gt;cr(), focusRect.x(), focusRect.y(), focusRect.width(), focusRect.height());</span>
<span class="line-removed">1408     }</span>
<span class="line-removed">1409 </span>
<span class="line-removed">1410     return false;</span>
<span class="line-removed">1411 }</span>
<span class="line-removed">1412 </span>
<span class="line-removed">1413 void RenderThemeGtk::adjustSliderThumbSize(RenderStyle&amp; style, const Element*) const</span>
<span class="line-removed">1414 {</span>
<span class="line-removed">1415     ControlPart part = style.appearance();</span>
<span class="line-removed">1416     if (part != SliderThumbHorizontalPart &amp;&amp; part != SliderThumbVerticalPart)</span>
<span class="line-removed">1417         return;</span>
<span class="line-removed">1418 </span>
<span class="line-removed">1419     GRefPtr&lt;GtkStyleContext&gt; context = createStyleContext(Scale);</span>
<span class="line-removed">1420     gint sliderWidth, sliderLength;</span>
<span class="line-removed">1421     gtk_style_context_get_style(context.get(), &quot;slider-width&quot;, &amp;sliderWidth, &quot;slider-length&quot;, &amp;sliderLength, nullptr);</span>
<span class="line-removed">1422 </span>
<span class="line-removed">1423     if (part == SliderThumbHorizontalPart) {</span>
<span class="line-removed">1424         style.setWidth(Length(sliderLength, Fixed));</span>
<span class="line-removed">1425         style.setHeight(Length(sliderWidth, Fixed));</span>
<span class="line-removed">1426         return;</span>
<span class="line-removed">1427     }</span>
<span class="line-removed">1428     ASSERT(part == SliderThumbVerticalPart);</span>
<span class="line-removed">1429     style.setWidth(Length(sliderWidth, Fixed));</span>
<span class="line-removed">1430     style.setHeight(Length(sliderLength, Fixed));</span>
<span class="line-removed">1431 }</span>
<span class="line-removed">1432 </span>
<span class="line-removed">1433 bool RenderThemeGtk::paintSliderThumb(const RenderObject&amp; renderObject, const PaintInfo&amp; paintInfo, const IntRect&amp; rect)</span>
<span class="line-removed">1434 {</span>
<span class="line-removed">1435     ControlPart part = renderObject.style().appearance();</span>
<span class="line-removed">1436     ASSERT(part == SliderThumbHorizontalPart || part == SliderThumbVerticalPart);</span>
<span class="line-removed">1437 </span>
<span class="line-removed">1438     // FIXME: The entire slider is too wide, stretching the thumb into an oval rather than a circle.</span>
<span class="line-removed">1439     GRefPtr&lt;GtkStyleContext&gt; parentContext = createStyleContext(Scale);</span>
<span class="line-removed">1440     gtk_style_context_add_class(parentContext.get(), part == SliderThumbHorizontalPart ? GTK_STYLE_CLASS_HORIZONTAL : GTK_STYLE_CLASS_VERTICAL);</span>
<span class="line-removed">1441     GRefPtr&lt;GtkStyleContext&gt; troughContext = createStyleContext(ScaleTrough, parentContext.get());</span>
<span class="line-removed">1442     GRefPtr&lt;GtkStyleContext&gt; context = createStyleContext(ScaleSlider, troughContext.get());</span>
<span class="line-removed">1443     gtk_style_context_set_direction(context.get(), gtkTextDirection(renderObject.style().direction()));</span>
<span class="line-removed">1444 </span>
<span class="line-removed">1445     guint flags = 0;</span>
<span class="line-removed">1446     if (!isEnabled(renderObject))</span>
<span class="line-removed">1447         flags |= GTK_STATE_FLAG_INSENSITIVE;</span>
<span class="line-removed">1448     else if (isHovered(renderObject))</span>
<span class="line-removed">1449         flags |= GTK_STATE_FLAG_PRELIGHT;</span>
<span class="line-removed">1450     if (isPressed(renderObject))</span>
<span class="line-removed">1451         flags |= GTK_STATE_FLAG_ACTIVE;</span>
<span class="line-removed">1452     gtk_style_context_set_state(context.get(), static_cast&lt;GtkStateFlags&gt;(flags));</span>
<span class="line-removed">1453 </span>
<span class="line-removed">1454     gtk_render_slider(context.get(), paintInfo.context().platformContext()-&gt;cr(), rect.x(), rect.y(), rect.width(), rect.height(),</span>
<span class="line-removed">1455         part == SliderThumbHorizontalPart ? GTK_ORIENTATION_HORIZONTAL : GTK_ORIENTATION_VERTICAL);</span>
<span class="line-removed">1456 </span>
<span class="line-removed">1457     return false;</span>
<span class="line-removed">1458 }</span>
<span class="line-removed">1459 #endif</span>
<span class="line-removed">1460 </span>
<span class="line-removed">1461 #if GTK_CHECK_VERSION(3, 20, 0)</span>
1462 IntRect RenderThemeGtk::progressBarRectForBounds(const RenderObject&amp; renderObject, const IntRect&amp; bounds) const
1463 {
1464     const auto&amp; renderProgress = downcast&lt;RenderProgress&gt;(renderObject);
1465     auto&amp; progressBarWidget = static_cast&lt;RenderThemeProgressBar&amp;&gt;(RenderThemeWidget::getOrCreate(renderProgress.isDeterminate() ? RenderThemeProgressBar::Type::ProgressBar : RenderThemeProgressBar::Type::IndeterminateProgressBar));
1466     IntSize preferredSize = progressBarWidget.progressBar().preferredSize();
1467     preferredSize = preferredSize.expandedTo(progressBarWidget.trough().preferredSize());
1468     preferredSize = preferredSize.expandedTo(progressBarWidget.progress().preferredSize());
1469     return IntRect(bounds.x(), bounds.y(), bounds.width(), preferredSize.height());
1470 }
1471 
1472 bool RenderThemeGtk::paintProgressBar(const RenderObject&amp; renderObject, const PaintInfo&amp; paintInfo, const IntRect&amp; rect)
1473 {
1474     if (!renderObject.isProgress())
1475         return true;
1476 
1477     const auto&amp; renderProgress = downcast&lt;RenderProgress&gt;(renderObject);
1478     auto&amp; progressBarWidget = static_cast&lt;RenderThemeProgressBar&amp;&gt;(RenderThemeWidget::getOrCreate(renderProgress.isDeterminate() ? RenderThemeProgressBar::Type::ProgressBar : RenderThemeProgressBar::Type::IndeterminateProgressBar));
1479     progressBarWidget.progressBar().render(paintInfo.context().platformContext()-&gt;cr(), rect);
1480     progressBarWidget.trough().render(paintInfo.context().platformContext()-&gt;cr(), rect);
1481     progressBarWidget.progress().render(paintInfo.context().platformContext()-&gt;cr(), calculateProgressRect(renderObject, rect));
1482     return false;
1483 }
<span class="line-removed">1484 #else</span>
<span class="line-removed">1485 IntRect RenderThemeGtk::progressBarRectForBounds(const RenderObject&amp;, const IntRect&amp; bounds) const</span>
<span class="line-removed">1486 {</span>
<span class="line-removed">1487     return bounds;</span>
<span class="line-removed">1488 }</span>
<span class="line-removed">1489 </span>
<span class="line-removed">1490 bool RenderThemeGtk::paintProgressBar(const RenderObject&amp; renderObject, const PaintInfo&amp; paintInfo, const IntRect&amp; rect)</span>
<span class="line-removed">1491 {</span>
<span class="line-removed">1492     if (!renderObject.isProgress())</span>
<span class="line-removed">1493         return true;</span>
1494 
<span class="line-removed">1495     GRefPtr&lt;GtkStyleContext&gt; parentContext = createStyleContext(ProgressBar);</span>
<span class="line-removed">1496     GRefPtr&lt;GtkStyleContext&gt; troughContext = createStyleContext(ProgressBarTrough, parentContext.get());</span>
<span class="line-removed">1497     GRefPtr&lt;GtkStyleContext&gt; context = createStyleContext(ProgressBarProgress, troughContext.get());</span>
<span class="line-removed">1498 </span>
<span class="line-removed">1499     gtk_render_background(troughContext.get(), paintInfo.context().platformContext()-&gt;cr(), rect.x(), rect.y(), rect.width(), rect.height());</span>
<span class="line-removed">1500     gtk_render_frame(troughContext.get(), paintInfo.context().platformContext()-&gt;cr(), rect.x(), rect.y(), rect.width(), rect.height());</span>
<span class="line-removed">1501 </span>
<span class="line-removed">1502     gtk_style_context_set_state(context.get(), static_cast&lt;GtkStateFlags&gt;(0));</span>
<span class="line-removed">1503 </span>
<span class="line-removed">1504     GtkBorder padding;</span>
<span class="line-removed">1505     gtk_style_context_get_padding(context.get(), gtk_style_context_get_state(context.get()), &amp;padding);</span>
<span class="line-removed">1506     IntRect progressRect(</span>
<span class="line-removed">1507         rect.x() + padding.left,</span>
<span class="line-removed">1508         rect.y() + padding.top,</span>
<span class="line-removed">1509         rect.width() - (padding.left + padding.right),</span>
<span class="line-removed">1510         rect.height() - (padding.top + padding.bottom));</span>
<span class="line-removed">1511     progressRect = RenderThemeGtk::calculateProgressRect(renderObject, progressRect);</span>
<span class="line-removed">1512 </span>
<span class="line-removed">1513     if (!progressRect.isEmpty()) {</span>
<span class="line-removed">1514 #if GTK_CHECK_VERSION(3, 13, 7)</span>
<span class="line-removed">1515         gtk_render_background(context.get(), paintInfo.context().platformContext()-&gt;cr(), progressRect.x(), progressRect.y(), progressRect.width(), progressRect.height());</span>
<span class="line-removed">1516         gtk_render_frame(context.get(), paintInfo.context().platformContext()-&gt;cr(), progressRect.x(), progressRect.y(), progressRect.width(), progressRect.height());</span>
<span class="line-removed">1517 #else</span>
<span class="line-removed">1518         gtk_render_activity(context.get(), paintInfo.context().platformContext()-&gt;cr(), progressRect.x(), progressRect.y(), progressRect.width(), progressRect.height());</span>
<span class="line-removed">1519 #endif</span>
<span class="line-removed">1520     }</span>
<span class="line-removed">1521 </span>
<span class="line-removed">1522     return false;</span>
<span class="line-removed">1523 }</span>
<span class="line-removed">1524 #endif // GTK_CHECK_VERSION(3, 20, 0)</span>
<span class="line-removed">1525 </span>
<span class="line-removed">1526 #if GTK_CHECK_VERSION(3, 20, 0)</span>
1527 RenderTheme::InnerSpinButtonLayout RenderThemeGtk::innerSpinButtonLayout(const RenderObject&amp; renderObject) const
1528 {
1529     return renderObject.style().direction() == TextDirection::RTL ? InnerSpinButtonLayout::HorizontalUpLeft : InnerSpinButtonLayout::HorizontalUpRight;
1530 }
1531 
1532 void RenderThemeGtk::adjustInnerSpinButtonStyle(StyleResolver&amp;, RenderStyle&amp; style, const Element*) const
1533 {
1534     style.setWidth(Length(spinButtonSize().width(), Fixed));
1535     style.setHeight(Length(spinButtonSize().height(), Fixed));
1536 }
1537 
1538 bool RenderThemeGtk::paintInnerSpinButton(const RenderObject&amp; renderObject, const PaintInfo&amp; paintInfo, const IntRect&amp; rect)
1539 {
1540     auto&amp; spinButtonWidget = static_cast&lt;RenderThemeSpinButton&amp;&gt;(RenderThemeWidget::getOrCreate(RenderThemeWidget::Type::SpinButton));
1541     auto spinButtonState = themePartStateFlags(*this, SpinButton, renderObject);
1542     spinButtonWidget.spinButton().setState(spinButtonState);
1543     spinButtonWidget.entry().setState(spinButtonState);
1544     auto&amp; up = spinButtonWidget.up();
1545     up.setState(themePartStateFlags(*this, SpinButtonUpButton, renderObject));
1546     auto&amp; down = spinButtonWidget.down();
1547     down.setState(themePartStateFlags(*this, SpinButtonDownButton, renderObject));
1548 
1549     IntRect iconRect = rect;
1550     iconRect.setWidth(iconRect.width() / 2);
1551     if (renderObject.style().direction() == TextDirection::RTL)
1552         up.render(paintInfo.context().platformContext()-&gt;cr(), iconRect);
1553     else
1554         down.render(paintInfo.context().platformContext()-&gt;cr(), iconRect);
1555     iconRect.move(iconRect.width(), 0);
1556     if (renderObject.style().direction() == TextDirection::RTL)
1557         down.render(paintInfo.context().platformContext()-&gt;cr(), iconRect);
1558     else
1559         up.render(paintInfo.context().platformContext()-&gt;cr(), iconRect);
1560 
1561     return false;
1562 }
<span class="line-removed">1563 #else</span>
<span class="line-removed">1564 RenderTheme::InnerSpinButtonLayout RenderThemeGtk::innerSpinButtonLayout(const RenderObject&amp;) const</span>
<span class="line-removed">1565 {</span>
<span class="line-removed">1566     return InnerSpinButtonLayout::Vertical;</span>
<span class="line-removed">1567 }</span>
<span class="line-removed">1568 static gint spinButtonArrowSize(GtkStyleContext* context)</span>
<span class="line-removed">1569 {</span>
<span class="line-removed">1570     PangoFontDescription* fontDescription;</span>
<span class="line-removed">1571     gtk_style_context_get(context, gtk_style_context_get_state(context), &quot;font&quot;, &amp;fontDescription, nullptr);</span>
<span class="line-removed">1572     gint fontSize = pango_font_description_get_size(fontDescription);</span>
<span class="line-removed">1573     gint arrowSize = std::max(PANGO_PIXELS(fontSize), minSpinButtonArrowSize);</span>
<span class="line-removed">1574     pango_font_description_free(fontDescription);</span>
<span class="line-removed">1575 </span>
<span class="line-removed">1576     return arrowSize - arrowSize % 2; // Force even.</span>
<span class="line-removed">1577 }</span>
<span class="line-removed">1578 </span>
<span class="line-removed">1579 void RenderThemeGtk::adjustInnerSpinButtonStyle(StyleResolver&amp;, RenderStyle&amp; style, const Element*) const</span>
<span class="line-removed">1580 {</span>
<span class="line-removed">1581     GRefPtr&lt;GtkStyleContext&gt; context = createStyleContext(SpinButton);</span>
<span class="line-removed">1582 </span>
<span class="line-removed">1583     GtkBorder padding;</span>
<span class="line-removed">1584     gtk_style_context_get_padding(context.get(), gtk_style_context_get_state(context.get()), &amp;padding);</span>
<span class="line-removed">1585 </span>
<span class="line-removed">1586     int width = spinButtonArrowSize(context.get()) + padding.left + padding.right;</span>
<span class="line-removed">1587     style.setWidth(Length(width, Fixed));</span>
<span class="line-removed">1588     style.setMinWidth(Length(width, Fixed));</span>
<span class="line-removed">1589 }</span>
<span class="line-removed">1590 </span>
<span class="line-removed">1591 static void paintSpinArrowButton(RenderTheme* theme, GtkStyleContext* parentContext, const RenderObject&amp; renderObject, const PaintInfo&amp; paintInfo, const IntRect&amp; rect, GtkArrowType arrowType)</span>
<span class="line-removed">1592 {</span>
<span class="line-removed">1593     ASSERT(arrowType == GTK_ARROW_UP || arrowType == GTK_ARROW_DOWN);</span>
<span class="line-removed">1594 </span>
<span class="line-removed">1595     GRefPtr&lt;GtkStyleContext&gt; context = createStyleContext(arrowType == GTK_ARROW_UP ? SpinButtonUpButton : SpinButtonDownButton, parentContext);</span>
<span class="line-removed">1596     GtkTextDirection direction = gtk_style_context_get_direction(context.get());</span>
<span class="line-removed">1597     guint state = static_cast&lt;guint&gt;(gtk_style_context_get_state(context.get()));</span>
<span class="line-removed">1598     if (!(state &amp; GTK_STATE_FLAG_INSENSITIVE)) {</span>
<span class="line-removed">1599         if (theme-&gt;isPressed(renderObject)) {</span>
<span class="line-removed">1600             if ((arrowType == GTK_ARROW_UP &amp;&amp; theme-&gt;isSpinUpButtonPartPressed(renderObject))</span>
<span class="line-removed">1601                 || (arrowType == GTK_ARROW_DOWN &amp;&amp; !theme-&gt;isSpinUpButtonPartPressed(renderObject)))</span>
<span class="line-removed">1602                 state |= GTK_STATE_FLAG_ACTIVE;</span>
<span class="line-removed">1603         } else if (theme-&gt;isHovered(renderObject)) {</span>
<span class="line-removed">1604             if ((arrowType == GTK_ARROW_UP &amp;&amp; theme-&gt;isSpinUpButtonPartHovered(renderObject))</span>
<span class="line-removed">1605                 || (arrowType == GTK_ARROW_DOWN &amp;&amp; !theme-&gt;isSpinUpButtonPartHovered(renderObject)))</span>
<span class="line-removed">1606                 state |= GTK_STATE_FLAG_PRELIGHT;</span>
<span class="line-removed">1607         }</span>
<span class="line-removed">1608     }</span>
<span class="line-removed">1609     gtk_style_context_set_state(context.get(), static_cast&lt;GtkStateFlags&gt;(state));</span>
<span class="line-removed">1610 </span>
<span class="line-removed">1611     // Paint button.</span>
<span class="line-removed">1612     IntRect buttonRect(rect);</span>
<span class="line-removed">1613     guint junction = gtk_style_context_get_junction_sides(context.get());</span>
<span class="line-removed">1614     if (arrowType == GTK_ARROW_UP)</span>
<span class="line-removed">1615         junction |= GTK_JUNCTION_BOTTOM;</span>
<span class="line-removed">1616     else {</span>
<span class="line-removed">1617         junction |= GTK_JUNCTION_TOP;</span>
<span class="line-removed">1618         buttonRect.move(0, rect.height() / 2);</span>
<span class="line-removed">1619     }</span>
<span class="line-removed">1620     buttonRect.setHeight(rect.height() / 2);</span>
<span class="line-removed">1621     gtk_style_context_set_junction_sides(context.get(), static_cast&lt;GtkJunctionSides&gt;(junction));</span>
<span class="line-removed">1622 </span>
<span class="line-removed">1623     gtk_render_background(context.get(), paintInfo.context().platformContext()-&gt;cr(), buttonRect.x(), buttonRect.y(), buttonRect.width(), buttonRect.height());</span>
<span class="line-removed">1624     gtk_render_frame(context.get(), paintInfo.context().platformContext()-&gt;cr(), buttonRect.x(), buttonRect.y(), buttonRect.width(), buttonRect.height());</span>
<span class="line-removed">1625 </span>
<span class="line-removed">1626     // Paint arrow centered inside button.</span>
<span class="line-removed">1627     // This code is based on gtkspinbutton.c code.</span>
<span class="line-removed">1628     IntRect arrowRect;</span>
<span class="line-removed">1629     gdouble angle;</span>
<span class="line-removed">1630     if (arrowType == GTK_ARROW_UP) {</span>
<span class="line-removed">1631         angle = 0;</span>
<span class="line-removed">1632         arrowRect.setY(rect.y());</span>
<span class="line-removed">1633         arrowRect.setHeight(rect.height() / 2 - 2);</span>
<span class="line-removed">1634     } else {</span>
<span class="line-removed">1635         angle = G_PI;</span>
<span class="line-removed">1636         arrowRect.setY(rect.y() + buttonRect.y());</span>
<span class="line-removed">1637         arrowRect.setHeight(rect.height() - arrowRect.y() - 2);</span>
<span class="line-removed">1638     }</span>
<span class="line-removed">1639     arrowRect.setWidth(rect.width() - 3);</span>
<span class="line-removed">1640     if (direction == GTK_TEXT_DIR_LTR)</span>
<span class="line-removed">1641         arrowRect.setX(rect.x() + 1);</span>
<span class="line-removed">1642     else</span>
<span class="line-removed">1643         arrowRect.setX(rect.x() + 2);</span>
<span class="line-removed">1644 </span>
<span class="line-removed">1645     gint width = arrowRect.width() / 2;</span>
<span class="line-removed">1646     width -= width % 2 - 1; // Force odd.</span>
<span class="line-removed">1647     gint height = (width + 1) / 2;</span>
<span class="line-removed">1648 </span>
<span class="line-removed">1649     arrowRect.move((arrowRect.width() - width) / 2, (arrowRect.height() - height) / 2);</span>
<span class="line-removed">1650     gtk_render_arrow(context.get(), paintInfo.context().platformContext()-&gt;cr(), angle, arrowRect.x(), arrowRect.y(), width);</span>
<span class="line-removed">1651 }</span>
<span class="line-removed">1652 </span>
<span class="line-removed">1653 bool RenderThemeGtk::paintInnerSpinButton(const RenderObject&amp; renderObject, const PaintInfo&amp; paintInfo, const IntRect&amp; rect)</span>
<span class="line-removed">1654 {</span>
<span class="line-removed">1655     GRefPtr&lt;GtkStyleContext&gt; context = createStyleContext(SpinButton);</span>
<span class="line-removed">1656     gtk_style_context_set_direction(context.get(), gtkTextDirection(renderObject.style().direction()));</span>
<span class="line-removed">1657 </span>
<span class="line-removed">1658     guint flags = 0;</span>
<span class="line-removed">1659     if (!isEnabled(renderObject) || isReadOnlyControl(renderObject))</span>
<span class="line-removed">1660         flags |= GTK_STATE_FLAG_INSENSITIVE;</span>
<span class="line-removed">1661     else if (isFocused(renderObject))</span>
<span class="line-removed">1662         flags |= GTK_STATE_FLAG_FOCUSED;</span>
<span class="line-removed">1663     gtk_style_context_set_state(context.get(), static_cast&lt;GtkStateFlags&gt;(flags));</span>
<span class="line-removed">1664 </span>
<span class="line-removed">1665     paintSpinArrowButton(this, context.get(), renderObject, paintInfo, rect, GTK_ARROW_UP);</span>
<span class="line-removed">1666     paintSpinArrowButton(this, context.get(), renderObject, paintInfo, rect, GTK_ARROW_DOWN);</span>
<span class="line-removed">1667 </span>
<span class="line-removed">1668     return false;</span>
<span class="line-removed">1669 }</span>
<span class="line-removed">1670 #endif // GTK_CHECK_VERSION(3, 20, 0)</span>
1671 
1672 Seconds RenderThemeGtk::caretBlinkInterval() const
1673 {
1674     GtkSettings* settings = gtk_settings_get_default();
1675 
1676     gboolean shouldBlink;
1677     gint time;
1678 
1679     g_object_get(settings, &quot;gtk-cursor-blink&quot;, &amp;shouldBlink, &quot;gtk-cursor-blink-time&quot;, &amp;time, nullptr);
1680 
1681     if (!shouldBlink)
1682         return 0_s;
1683 
1684     return 500_us * time;
1685 }
1686 
1687 enum StyleColorType { StyleColorBackground, StyleColorForeground };
1688 
<span class="line-removed">1689 #if GTK_CHECK_VERSION(3, 20, 0)</span>
1690 static Color styleColor(RenderThemePart themePart, GtkStateFlags state, StyleColorType colorType)
1691 {
1692     RenderThemeGadget* gadget = nullptr;
1693     switch (themePart) {
1694     default:
1695         ASSERT_NOT_REACHED();
1696         FALLTHROUGH;
1697     case Entry:
1698         gadget = &amp;static_cast&lt;RenderThemeEntry&amp;&gt;(RenderThemeWidget::getOrCreate(RenderThemeWidget::Type::Entry)).entry();
1699         break;
1700     case EntrySelection:
1701         gadget = static_cast&lt;RenderThemeEntry&amp;&gt;(RenderThemeWidget::getOrCreate(RenderThemeWidget::Type::SelectedEntry)).selection();
1702         break;
1703     case ListBox:
1704         gadget = &amp;static_cast&lt;RenderThemeListView&amp;&gt;(RenderThemeWidget::getOrCreate(RenderThemeWidget::Type::ListView)).treeview();
1705         break;
1706     case Button:
1707         gadget = &amp;static_cast&lt;RenderThemeButton&amp;&gt;(RenderThemeWidget::getOrCreate(RenderThemeWidget::Type::Button)).button();
1708         break;



1709     }
1710 
1711     ASSERT(gadget);
1712     gadget-&gt;setState(state);
1713     return colorType == StyleColorBackground ? gadget-&gt;backgroundColor() : gadget-&gt;color();
1714 }
<span class="line-removed">1715 #else</span>
<span class="line-removed">1716 static Color styleColor(RenderThemePart themePart, GtkStateFlags state, StyleColorType colorType)</span>
<span class="line-removed">1717 {</span>
<span class="line-removed">1718     GRefPtr&lt;GtkStyleContext&gt; context = createStyleContext(themePart);</span>
<span class="line-removed">1719     gtk_style_context_set_state(context.get(), state);</span>
<span class="line-removed">1720 </span>
<span class="line-removed">1721     GdkRGBA gdkRGBAColor;</span>
<span class="line-removed">1722     if (colorType == StyleColorBackground)</span>
<span class="line-removed">1723         gtk_style_context_get_background_color(context.get(), state, &amp;gdkRGBAColor);</span>
<span class="line-removed">1724     else</span>
<span class="line-removed">1725         gtk_style_context_get_color(context.get(), state, &amp;gdkRGBAColor);</span>
<span class="line-removed">1726     return gdkRGBAColor;</span>
<span class="line-removed">1727 }</span>
<span class="line-removed">1728 #endif // GTK_CHECK_VERSION(3, 20, 0)</span>
1729 
1730 Color RenderThemeGtk::platformActiveSelectionBackgroundColor(OptionSet&lt;StyleColor::Options&gt;) const
1731 {
1732     return styleColor(EntrySelection, static_cast&lt;GtkStateFlags&gt;(GTK_STATE_FLAG_SELECTED | GTK_STATE_FLAG_FOCUSED), StyleColorBackground);
1733 }
1734 
1735 Color RenderThemeGtk::platformInactiveSelectionBackgroundColor(OptionSet&lt;StyleColor::Options&gt;) const
1736 {
1737     return styleColor(EntrySelection, GTK_STATE_FLAG_SELECTED, StyleColorBackground);
1738 }
1739 
1740 Color RenderThemeGtk::platformActiveSelectionForegroundColor(OptionSet&lt;StyleColor::Options&gt;) const
1741 {
1742     return styleColor(EntrySelection, static_cast&lt;GtkStateFlags&gt;(GTK_STATE_FLAG_SELECTED | GTK_STATE_FLAG_FOCUSED), StyleColorForeground);
1743 }
1744 
1745 Color RenderThemeGtk::platformInactiveSelectionForegroundColor(OptionSet&lt;StyleColor::Options&gt;) const
1746 {
1747     return styleColor(EntrySelection, GTK_STATE_FLAG_SELECTED, StyleColorForeground);
1748 }
</pre>
<hr />
<pre>
1750 Color RenderThemeGtk::platformActiveListBoxSelectionBackgroundColor(OptionSet&lt;StyleColor::Options&gt;) const
1751 {
1752     return styleColor(ListBox, static_cast&lt;GtkStateFlags&gt;(GTK_STATE_FLAG_SELECTED | GTK_STATE_FLAG_FOCUSED), StyleColorBackground);
1753 }
1754 
1755 Color RenderThemeGtk::platformInactiveListBoxSelectionBackgroundColor(OptionSet&lt;StyleColor::Options&gt;) const
1756 {
1757     return styleColor(ListBox, GTK_STATE_FLAG_SELECTED, StyleColorBackground);
1758 }
1759 
1760 Color RenderThemeGtk::platformActiveListBoxSelectionForegroundColor(OptionSet&lt;StyleColor::Options&gt;) const
1761 {
1762     return styleColor(ListBox, static_cast&lt;GtkStateFlags&gt;(GTK_STATE_FLAG_SELECTED | GTK_STATE_FLAG_FOCUSED), StyleColorForeground);
1763 }
1764 
1765 Color RenderThemeGtk::platformInactiveListBoxSelectionForegroundColor(OptionSet&lt;StyleColor::Options&gt;) const
1766 {
1767     return styleColor(ListBox, GTK_STATE_FLAG_SELECTED, StyleColorForeground);
1768 }
1769 





1770 Color RenderThemeGtk::systemColor(CSSValueID cssValueId, OptionSet&lt;StyleColor::Options&gt; options) const
1771 {
1772     switch (cssValueId) {
1773     case CSSValueButtontext:
1774         return styleColor(Button, GTK_STATE_FLAG_ACTIVE, StyleColorForeground);
1775     case CSSValueCaptiontext:
1776         return styleColor(Entry, GTK_STATE_FLAG_ACTIVE, StyleColorForeground);




1777     default:
<span class="line-modified">1778         return RenderTheme::systemColor(cssValueId, options);</span>
1779     }


1780 }
1781 
1782 void RenderThemeGtk::platformColorsDidChange()
1783 {
1784     RenderTheme::platformColorsDidChange();
1785 }
1786 
1787 #if ENABLE(VIDEO)
1788 String RenderThemeGtk::extraMediaControlsStyleSheet()
1789 {
1790     return String(mediaControlsGtkUserAgentStyleSheet, sizeof(mediaControlsGtkUserAgentStyleSheet));
1791 }
1792 
1793 #if ENABLE(FULLSCREEN_API)
1794 String RenderThemeGtk::extraFullScreenStyleSheet()
1795 {
1796     return String();
1797 }
1798 #endif
1799 
<span class="line-removed">1800 #if GTK_CHECK_VERSION(3, 20, 0)</span>
1801 bool RenderThemeGtk::paintMediaButton(const RenderObject&amp; renderObject, GraphicsContext&amp; graphicsContext, const IntRect&amp; rect, const char* iconName)
1802 {
1803     auto&amp; iconWidget = static_cast&lt;RenderThemeIcon&amp;&gt;(RenderThemeWidget::getOrCreate(RenderThemeWidget::Type::Icon));
1804     auto&amp; icon = static_cast&lt;RenderThemeIconGadget&amp;&gt;(iconWidget.icon());
1805     icon.setState(themePartStateFlags(*this, MediaButton, renderObject));
1806     icon.setIconSize(RenderThemeIconGadget::IconSizeGtk::Menu);
1807     icon.setIconName(iconName);
1808     return !icon.render(graphicsContext.platformContext()-&gt;cr(), rect);
1809 }
<span class="line-removed">1810 #else</span>
<span class="line-removed">1811 bool RenderThemeGtk::paintMediaButton(const RenderObject&amp; renderObject, GraphicsContext&amp; graphicsContext, const IntRect&amp; rect, const char* iconName)</span>
<span class="line-removed">1812 {</span>
<span class="line-removed">1813     GRefPtr&lt;GtkStyleContext&gt; context = createStyleContext(MediaButton);</span>
<span class="line-removed">1814     gtk_style_context_set_direction(context.get(), gtkTextDirection(renderObject.style().direction()));</span>
<span class="line-removed">1815     gtk_style_context_set_state(context.get(), gtkIconStateFlags(this, renderObject));</span>
<span class="line-removed">1816     static const unsigned mediaIconSize = 16;</span>
<span class="line-removed">1817     IntRect iconRect(rect.x() + (rect.width() - mediaIconSize) / 2, rect.y() + (rect.height() - mediaIconSize) / 2, mediaIconSize, mediaIconSize);</span>
<span class="line-removed">1818     return !paintIcon(context.get(), graphicsContext, iconRect, iconName);</span>
<span class="line-removed">1819 }</span>
<span class="line-removed">1820 #endif // GTK_CHECK_VERSION(3, 20, 0)</span>
1821 
1822 bool RenderThemeGtk::hasOwnDisabledStateHandlingFor(ControlPart part) const
1823 {
1824     return (part != MediaMuteButtonPart);
1825 }
1826 
1827 bool RenderThemeGtk::paintMediaFullscreenButton(const RenderObject&amp; renderObject, const PaintInfo&amp; paintInfo, const IntRect&amp; rect)
1828 {
1829     return paintMediaButton(renderObject, paintInfo.context(), rect, &quot;view-fullscreen-symbolic&quot;);
1830 }
1831 
1832 bool RenderThemeGtk::paintMediaMuteButton(const RenderObject&amp; renderObject, const PaintInfo&amp; paintInfo, const IntRect&amp; rect)
1833 {
1834     Node* node = renderObject.node();
1835     if (!node)
1836         return true;
1837     Node* mediaNode = node-&gt;shadowHost();
1838     if (!is&lt;HTMLMediaElement&gt;(mediaNode))
1839         return true;
1840 
</pre>
<hr />
<pre>
2017         return String();
2018 
2019     if (fileList-&gt;length() &gt; 1)
2020         return StringTruncator::rightTruncate(multipleFileUploadText(fileList-&gt;length()), width, font);
2021 
2022     String string;
2023     if (fileList-&gt;length())
2024         string = FileSystem::pathGetFileName(fileList-&gt;item(0)-&gt;path());
2025     else if (multipleFilesAllowed)
2026         string = fileButtonNoFilesSelectedLabel();
2027     else
2028         string = fileButtonNoFileSelectedLabel();
2029 
2030     return StringTruncator::centerTruncate(string, width, font);
2031 }
2032 
2033 #if ENABLE(VIDEO)
2034 String RenderThemeGtk::mediaControlsScript()
2035 {
2036     StringBuilder scriptBuilder;
<span class="line-modified">2037     scriptBuilder.append(mediaControlsLocalizedStringsJavaScript, sizeof(mediaControlsLocalizedStringsJavaScript));</span>
<span class="line-modified">2038     scriptBuilder.append(mediaControlsBaseJavaScript, sizeof(mediaControlsBaseJavaScript));</span>
<span class="line-modified">2039     scriptBuilder.append(mediaControlsGtkJavaScript, sizeof(mediaControlsGtkJavaScript));</span>
2040     return scriptBuilder.toString();
2041 }
2042 #endif // ENABLE(VIDEO)
<span class="line-removed">2043 </span>
<span class="line-removed">2044 #endif // GTK_API_VERSION_2</span>
2045 }
</pre>
</td>
<td>
<hr />
<pre>
  16  * Library General Public License for more details.
  17  *
  18  * You should have received a copy of the GNU Library General Public License
  19  * along with this library; see the file COPYING.LIB.  If not, write to
  20  * the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor,
  21  * Boston, MA 02110-1301, USA.
  22  *
  23  */
  24 
  25 #include &quot;config.h&quot;
  26 #include &quot;RenderThemeGtk.h&quot;
  27 
  28 #include &quot;CSSValueKeywords.h&quot;
  29 #include &quot;FileList.h&quot;
  30 #include &quot;FloatRoundedRect.h&quot;
  31 #include &quot;FontDescription.h&quot;
  32 #include &quot;GRefPtrGtk.h&quot;
  33 #include &quot;GUniquePtrGtk.h&quot;
  34 #include &quot;Gradient.h&quot;
  35 #include &quot;GraphicsContext.h&quot;

  36 #include &quot;HTMLInputElement.h&quot;
  37 #include &quot;HTMLMediaElement.h&quot;
  38 #include &quot;LocalizedStrings.h&quot;
  39 #include &quot;MediaControlElements.h&quot;
  40 #include &quot;Page.h&quot;
  41 #include &quot;PaintInfo.h&quot;
  42 #include &quot;PlatformContextCairo.h&quot;
  43 #include &quot;RenderBox.h&quot;
  44 #include &quot;RenderObject.h&quot;
  45 #include &quot;RenderProgress.h&quot;
  46 #include &quot;RenderThemeWidget.h&quot;
  47 #include &quot;ScrollbarThemeGtk.h&quot;
  48 #include &quot;StringTruncator.h&quot;
  49 #include &quot;TimeRanges.h&quot;
  50 #include &quot;UserAgentScripts.h&quot;
  51 #include &quot;UserAgentStyleSheets.h&quot;
  52 #include &lt;cmath&gt;
  53 #include &lt;gdk/gdk.h&gt;
  54 #include &lt;glib.h&gt;
  55 #include &lt;gtk/gtk.h&gt;
</pre>
<hr />
<pre>
 107     fontDescription.setIsAbsoluteSize(true);
 108     fontDescription.setWeight(normalWeightValue());
 109     fontDescription.setItalic(FontSelectionValue());
 110     pango_font_description_free(pangoDescription);
 111 }
 112 
 113 #if ENABLE(DATALIST_ELEMENT)
 114 IntSize RenderThemeGtk::sliderTickSize() const
 115 {
 116     // FIXME: We need to set this to the size of one tick mark.
 117     return IntSize(0, 0);
 118 }
 119 
 120 int RenderThemeGtk::sliderTickOffsetFromTrackCenter() const
 121 {
 122     // FIXME: We need to set this to the position of the tick marks.
 123     return 0;
 124 }
 125 #endif
 126 


















 127 enum RenderThemePart {
 128     Entry,
 129     EntrySelection,
 130     EntryIconLeft,
 131     EntryIconRight,
 132     Button,
 133     CheckButton,
 134     RadioButton,
 135     ComboBox,
 136     ComboBoxButton,
 137     ComboBoxArrow,
 138     Scale,
 139     ScaleTrough,
 140     ScaleSlider,
 141     ProgressBar,
 142     ProgressBarTrough,
 143     ProgressBarProgress,
 144     ListBox,
 145     SpinButton,
 146     SpinButtonUpButton,
 147     SpinButtonDownButton,
 148 #if ENABLE(VIDEO)
 149     MediaButton,
 150 #endif
<span class="line-added"> 151     Window,</span>
 152 };
 153 






























































































































 154 #if ENABLE(VIDEO)
 155 static bool nodeHasPseudo(Node&amp; node, const char* pseudo)
 156 {
 157     return is&lt;Element&gt;(node) &amp;&amp; downcast&lt;Element&gt;(node).pseudo() == pseudo;
 158 }
 159 
 160 static bool nodeHasClass(Node* node, const char* className)
 161 {
 162     if (!is&lt;Element&gt;(*node))
 163         return false;
 164 
 165     Element&amp; element = downcast&lt;Element&gt;(*node);
 166 
 167     if (!element.hasClass())
 168         return false;
 169 
 170     return element.classNames().contains(className);
 171 }
 172 #endif // ENABLE(VIDEO)
 173 
</pre>
<hr />
<pre>
 193 }
 194 
 195 bool RenderThemeGtk::supportsFocusRing(const RenderStyle&amp; style) const
 196 {
 197     return supportsFocus(style.appearance());
 198 }
 199 
 200 bool RenderThemeGtk::controlSupportsTints(const RenderObject&amp; o) const
 201 {
 202     return isEnabled(o);
 203 }
 204 
 205 int RenderThemeGtk::baselinePosition(const RenderBox&amp; box) const
 206 {
 207     // FIXME: This strategy is possibly incorrect for the GTK+ port.
 208     if (box.style().appearance() == CheckboxPart || box.style().appearance() == RadioPart)
 209         return box.marginTop() + box.height() - 2;
 210     return RenderTheme::baselinePosition(box);
 211 }
 212 

 213 void RenderThemeGtk::adjustRepaintRect(const RenderObject&amp;, FloatRect&amp;)
 214 {
 215 }
 216 static GtkStateFlags themePartStateFlags(const RenderThemeGtk&amp; theme, RenderThemePart themePart, const RenderObject&amp; renderObject)
 217 {
 218     unsigned stateFlags = 0;
 219     switch (renderObject.style().direction()) {
 220     case TextDirection::RTL:
 221         stateFlags |= GTK_STATE_FLAG_DIR_RTL;
 222         break;
 223     case TextDirection::LTR:
 224         stateFlags |= GTK_STATE_FLAG_DIR_LTR;
 225         break;
 226     }
 227 
 228     if (!theme.isEnabled(renderObject) || (themePart == Entry &amp;&amp; theme.isReadOnlyControl(renderObject)))
 229         stateFlags |= GTK_STATE_FLAG_INSENSITIVE;
 230     else {
 231         if (theme.isHovered(renderObject))
 232             stateFlags |= GTK_STATE_FLAG_PRELIGHT;
</pre>
<hr />
<pre>
 256             stateFlags |= GTK_STATE_FLAG_ACTIVE;
 257         break;
 258     case SpinButtonUpButton:
 259         if (theme.isPressed(renderObject) &amp;&amp; theme.isSpinUpButtonPartPressed(renderObject))
 260             stateFlags |= GTK_STATE_FLAG_ACTIVE;
 261         if (theme.isHovered(renderObject) &amp;&amp; !theme.isSpinUpButtonPartHovered(renderObject))
 262             stateFlags &amp;= ~GTK_STATE_FLAG_PRELIGHT;
 263         break;
 264     case SpinButtonDownButton:
 265         if (theme.isPressed(renderObject) &amp;&amp; !theme.isSpinUpButtonPartPressed(renderObject))
 266             stateFlags |= GTK_STATE_FLAG_ACTIVE;
 267         if (theme.isHovered(renderObject) &amp;&amp; theme.isSpinUpButtonPartHovered(renderObject))
 268             stateFlags &amp;= ~GTK_STATE_FLAG_PRELIGHT;
 269         break;
 270     default:
 271         break;
 272     }
 273 
 274     return static_cast&lt;GtkStateFlags&gt;(stateFlags);
 275 }












































































 276 
 277 void RenderThemeGtk::adjustButtonStyle(StyleResolver&amp;, RenderStyle&amp; style, const Element*) const
 278 {
 279     // Some layout tests check explicitly that buttons ignore line-height.
 280     if (style.appearance() == PushButtonPart)
 281         style.setLineHeight(RenderStyle::initialLineHeight());
 282 }
 283 
 284 static void shrinkToMinimumSizeAndCenterRectangle(FloatRect&amp; rect, const IntSize&amp; minSize)
 285 {
 286     if (rect.width() &gt; minSize.width()) {
 287         rect.inflateX(-(rect.width() - minSize.width()) / 2);
 288         rect.setWidth(minSize.width()); // In case rect.width() was equal to minSize.width() + 1.
 289     }
 290 
 291     if (rect.height() &gt; minSize.height()) {
 292         rect.inflateY(-(rect.height() - minSize.height()) / 2);
 293         rect.setHeight(minSize.height()); // In case rect.height() was equal to minSize.height() + 1.
 294     }
 295 }
 296 

 297 static void setToggleSize(RenderThemePart themePart, RenderStyle&amp; style)
 298 {
 299     ASSERT(themePart == CheckButton || themePart == RadioButton);
 300 
 301     // The width and height are both specified, so we shouldn&#39;t change them.
 302     if (!style.width().isIntrinsicOrAuto() &amp;&amp; !style.height().isAuto())
 303         return;
 304 
 305     auto&amp; toggleWidget = static_cast&lt;RenderThemeToggleButton&amp;&gt;(RenderThemeWidget::getOrCreate(themePart == CheckButton ? RenderThemeWidget::Type::CheckButton : RenderThemeWidget::Type::RadioButton));
 306     toggleWidget.button().setState(GTK_STATE_FLAG_NORMAL);
 307     toggleWidget.toggle().setState(GTK_STATE_FLAG_NORMAL);
 308     IntSize preferredSize = toggleWidget.button().preferredSize();
 309     preferredSize = preferredSize.expandedTo(toggleWidget.toggle().preferredSize());
 310 
 311     if (style.width().isIntrinsicOrAuto())
 312         style.setWidth(Length(preferredSize.width(), Fixed));
 313 
 314     if (style.height().isAuto())
 315         style.setHeight(Length(preferredSize.height(), Fixed));
 316 }
</pre>
<hr />
<pre>
 321 
 322     auto&amp; toggleWidget = static_cast&lt;RenderThemeToggleButton&amp;&gt;(RenderThemeWidget::getOrCreate(themePart == CheckButton ? RenderThemeWidget::Type::CheckButton : RenderThemeWidget::Type::RadioButton));
 323     auto toggleState = themePartStateFlags(*theme, themePart, renderObject);
 324     toggleWidget.button().setState(toggleState);
 325     toggleWidget.toggle().setState(toggleState);
 326 
 327     FloatRect rect = fullRect;
 328     // Some themes do not render large toggle buttons properly, so we simply
 329     // shrink the rectangle back down to the default size and then center it
 330     // in the full toggle button region. The reason for not simply forcing toggle
 331     // buttons to be a smaller size is that we don&#39;t want to break site layouts.
 332     IntSize preferredSize = toggleWidget.button().preferredSize();
 333     preferredSize = preferredSize.expandedTo(toggleWidget.toggle().preferredSize());
 334     shrinkToMinimumSizeAndCenterRectangle(rect, preferredSize);
 335     toggleWidget.button().render(paintInfo.context().platformContext()-&gt;cr(), rect);
 336     toggleWidget.toggle().render(paintInfo.context().platformContext()-&gt;cr(), rect);
 337 
 338     if (theme-&gt;isFocused(renderObject))
 339         toggleWidget.button().renderFocus(paintInfo.context().platformContext()-&gt;cr(), rect);
 340 }





































































 341 
 342 void RenderThemeGtk::setCheckboxSize(RenderStyle&amp; style) const
 343 {
 344     setToggleSize(CheckButton, style);
 345 }
 346 
 347 bool RenderThemeGtk::paintCheckbox(const RenderObject&amp; renderObject, const PaintInfo&amp; paintInfo, const IntRect&amp; rect)
 348 {
 349     paintToggle(this, CheckButton, renderObject, paintInfo, rect);
 350     return false;
 351 }
 352 
 353 void RenderThemeGtk::setRadioSize(RenderStyle&amp; style) const
 354 {
 355     setToggleSize(RadioButton, style);
 356 }
 357 
 358 bool RenderThemeGtk::paintRadio(const RenderObject&amp; renderObject, const PaintInfo&amp; paintInfo, const IntRect&amp; rect)
 359 {
 360     paintToggle(this, RadioButton, renderObject, paintInfo, rect);
 361     return false;
 362 }
 363 

 364 bool RenderThemeGtk::paintButton(const RenderObject&amp; renderObject, const PaintInfo&amp; paintInfo, const IntRect&amp; rect)
 365 {
 366     auto&amp; buttonWidget = static_cast&lt;RenderThemeButton&amp;&gt;(RenderThemeWidget::getOrCreate(isDefault(renderObject) ? RenderThemeWidget::Type::ButtonDefault : RenderThemeWidget::Type::Button));
 367     buttonWidget.button().setState(themePartStateFlags(*this, Button, renderObject));
 368     buttonWidget.button().render(paintInfo.context().platformContext()-&gt;cr(), rect);
 369     if (isFocused(renderObject))
 370         buttonWidget.button().renderFocus(paintInfo.context().platformContext()-&gt;cr(), rect);
 371     return false;
 372 }











































































 373 
 374 static Color menuListColor(const Element* element)
 375 {

 376     auto&amp; comboWidget = static_cast&lt;RenderThemeComboBox&amp;&gt;(RenderThemeWidget::getOrCreate(RenderThemeWidget::Type::ComboBox));
 377     GtkStateFlags state = element-&gt;isDisabledFormControl() ? GTK_STATE_FLAG_INSENSITIVE : GTK_STATE_FLAG_NORMAL;
 378     comboWidget.comboBox().setState(state);
 379     comboWidget.button().setState(state);
 380     return comboWidget.button().color();









 381 }
 382 
 383 void RenderThemeGtk::adjustMenuListStyle(StyleResolver&amp;, RenderStyle&amp; style, const Element* element) const
 384 {
 385     // The tests check explicitly that select menu buttons ignore line height.
 386     style.setLineHeight(RenderStyle::initialLineHeight());
 387 
 388     // We cannot give a proper rendering when border radius is active, unfortunately.
 389     style.resetBorderRadius();
 390 
 391     if (element)
 392         style.setColor(menuListColor(element));
 393 }
 394 
 395 void RenderThemeGtk::adjustMenuListButtonStyle(StyleResolver&amp; styleResolver, RenderStyle&amp; style, const Element* e) const
 396 {
 397     adjustMenuListStyle(styleResolver, style, e);
 398 }
 399 

 400 /*
 401  * GtkComboBox gadgets tree
 402  *
 403  * combobox
 404  * ├── box.linked
 405  * │   ╰── button.combo
 406  * │       ╰── box
 407  * │           ├── cellview
 408  * │           ╰── arrow
 409  * ╰── window.popup
 410  */
 411 LengthBox RenderThemeGtk::popupInternalPaddingBox(const RenderStyle&amp; style) const
 412 {
 413     if (style.appearance() == NoControlPart)
 414         return LengthBox(0);
 415 
 416     auto&amp; comboWidget = static_cast&lt;RenderThemeComboBox&amp;&gt;(RenderThemeWidget::getOrCreate(RenderThemeWidget::Type::ComboBox));
 417     comboWidget.comboBox().setState(GTK_STATE_FLAG_NORMAL);
 418     comboWidget.button().setState(GTK_STATE_FLAG_NORMAL);
 419     comboWidget.arrow().setState(GTK_STATE_FLAG_NORMAL);
</pre>
<hr />
<pre>
 435 bool RenderThemeGtk::paintMenuList(const RenderObject&amp; renderObject, const PaintInfo&amp; paintInfo, const FloatRect&amp; rect)
 436 {
 437     auto&amp; comboWidget = static_cast&lt;RenderThemeComboBox&amp;&gt;(RenderThemeWidget::getOrCreate(RenderThemeWidget::Type::ComboBox));
 438     auto comboState = themePartStateFlags(*this, ComboBoxButton, renderObject);
 439     comboWidget.comboBox().setState(comboState);
 440     comboWidget.button().setState(comboState);
 441     comboWidget.arrow().setState(comboState);
 442 
 443     cairo_t* cr = paintInfo.context().platformContext()-&gt;cr();
 444     comboWidget.comboBox().render(cr, rect);
 445     comboWidget.box().render(cr, rect);
 446     FloatRect contentsRect;
 447     comboWidget.button().render(cr, rect, &amp;contentsRect);
 448     comboWidget.buttonBox().render(cr, contentsRect);
 449     comboWidget.arrow().render(cr, contentsRect);
 450     if (isFocused(renderObject))
 451         comboWidget.button().renderFocus(cr, rect);
 452 
 453     return false;
 454 }


























































































 455 
 456 bool RenderThemeGtk::paintMenuListButtonDecorations(const RenderBox&amp; object, const PaintInfo&amp; info, const FloatRect&amp; rect)
 457 {
 458     return paintMenuList(object, info, rect);
 459 }
 460 











 461 static IntSize spinButtonSize()
 462 {
 463     auto&amp; spinButtonWidget = static_cast&lt;RenderThemeSpinButton&amp;&gt;(RenderThemeWidget::getOrCreate(RenderThemeWidget::Type::SpinButton));
 464     spinButtonWidget.spinButton().setState(GTK_STATE_FLAG_NORMAL);
 465     spinButtonWidget.entry().setState(GTK_STATE_FLAG_NORMAL);
 466     spinButtonWidget.up().setState(GTK_STATE_FLAG_NORMAL);
 467     spinButtonWidget.down().setState(GTK_STATE_FLAG_NORMAL);
 468 
 469     IntSize preferredSize = spinButtonWidget.spinButton().preferredSize();
 470     preferredSize = preferredSize.expandedTo(spinButtonWidget.entry().preferredSize());
 471     IntSize upPreferredSize = preferredSize.expandedTo(spinButtonWidget.up().preferredSize());
 472     IntSize downPreferredSize = preferredSize.expandedTo(spinButtonWidget.down().preferredSize());
 473 
 474     return IntSize(upPreferredSize.width() + downPreferredSize.width(), std::max(upPreferredSize.height(), downPreferredSize.height()));
 475 }
 476 
 477 
 478 void RenderThemeGtk::adjustTextFieldStyle(StyleResolver&amp;, RenderStyle&amp; style, const Element* element) const
 479 {
 480     if (!is&lt;HTMLInputElement&gt;(element) || !shouldHaveSpinButton(downcast&lt;HTMLInputElement&gt;(*element)))
 481         return;
 482 
 483     style.setMinHeight(Length(spinButtonSize().height(), Fixed));
 484 
 485     // The default theme for the GTK+ port uses very wide spin buttons (66px) compared to what other
 486     // browsers use (~13 px). And unfortunately, most of the web developers won&#39;t test how their site
<span class="line-modified"> 487     // renders on WebKitGTK. To ensure that spin buttons don&#39;t end up covering the values of the input</span>
 488     // field, we override the width of the input element and always increment it with the width needed
 489     // for the spinbutton (when drawing the spinbutton).
 490     int minimumWidth = style.width().intValue() + spinButtonSize().width();
 491     style.setMinWidth(Length(minimumWidth, Fixed));
 492 }
 493 
 494 bool RenderThemeGtk::paintTextField(const RenderObject&amp; renderObject, const PaintInfo&amp; paintInfo, const FloatRect&amp; rect)
 495 {
 496     if (is&lt;HTMLInputElement&gt;(renderObject.node()) &amp;&amp; shouldHaveSpinButton(downcast&lt;HTMLInputElement&gt;(*renderObject.node()))) {
 497         auto&amp; spinButtonWidget = static_cast&lt;RenderThemeSpinButton&amp;&gt;(RenderThemeWidget::getOrCreate(RenderThemeWidget::Type::SpinButton));
 498         auto spinButtonState = themePartStateFlags(*this, Entry, renderObject);
 499         spinButtonWidget.spinButton().setState(spinButtonState);
 500         spinButtonWidget.entry().setState(spinButtonState);
 501         spinButtonWidget.spinButton().render(paintInfo.context().platformContext()-&gt;cr(), rect);
 502         spinButtonWidget.entry().render(paintInfo.context().platformContext()-&gt;cr(), rect);
 503     } else {
 504         auto&amp; entryWidget = static_cast&lt;RenderThemeEntry&amp;&gt;(RenderThemeWidget::getOrCreate(RenderThemeWidget::Type::Entry));
 505         entryWidget.entry().setState(themePartStateFlags(*this, Entry, renderObject));
 506         entryWidget.entry().render(paintInfo.context().platformContext()-&gt;cr(), rect);







 507 
<span class="line-modified"> 508 #if ENABLE(DATALIST_ELEMENT)</span>
<span class="line-modified"> 509         if (is&lt;HTMLInputElement&gt;(renderObject.generatingNode())) {</span>
<span class="line-modified"> 510             const auto&amp; input = downcast&lt;HTMLInputElement&gt;(*(renderObject.generatingNode()));</span>
<span class="line-modified"> 511             if (input.list())</span>
<span class="line-modified"> 512                 paintListButtonForInput(renderObject, paintInfo, rect);</span>


















 513         }
<span class="line-added"> 514 #endif</span>
 515     }

 516     return false;
 517 }

 518 

 519 static void adjustSearchFieldIconStyle(RenderThemePart themePart, RenderStyle&amp; style)
 520 {
 521     ASSERT(themePart == EntryIconLeft || themePart == EntryIconRight);
 522     auto&amp; searchEntryWidget = static_cast&lt;RenderThemeSearchEntry&amp;&gt;(RenderThemeWidget::getOrCreate(RenderThemeWidget::Type::SearchEntry));
 523     searchEntryWidget.entry().setState(GTK_STATE_FLAG_NORMAL);
 524     searchEntryWidget.leftIcon().setState(GTK_STATE_FLAG_NORMAL);
 525     searchEntryWidget.rightIcon().setState(GTK_STATE_FLAG_NORMAL);
 526 
 527     // Get the icon size based on the font size.
 528     auto&amp; icon = static_cast&lt;RenderThemeIconGadget&amp;&gt;(themePart == EntryIconLeft ? searchEntryWidget.leftIcon() : searchEntryWidget.rightIcon());
 529     icon.setIconSize(style.computedFontPixelSize());
 530     IntSize preferredSize = icon.preferredSize();
 531     GtkBorder contentsBox = searchEntryWidget.entry().contentsBox();
 532     if (themePart == EntryIconLeft)
 533         preferredSize.expand(contentsBox.left, contentsBox.top + contentsBox.bottom);
 534     else
 535         preferredSize.expand(contentsBox.right, contentsBox.top + contentsBox.bottom);
 536     style.setWidth(Length(preferredSize.width(), Fixed));
 537     style.setHeight(Length(preferredSize.height(), Fixed));
 538 }

















































 539 
 540 bool RenderThemeGtk::paintTextArea(const RenderObject&amp; o, const PaintInfo&amp; i, const FloatRect&amp; r)
 541 {
 542     return paintTextField(o, i, r);
 543 }
 544 
 545 void RenderThemeGtk::adjustSearchFieldResultsButtonStyle(StyleResolver&amp; styleResolver, RenderStyle&amp; style, const Element* e) const
 546 {
 547     adjustSearchFieldCancelButtonStyle(styleResolver, style, e);
 548 }
 549 
 550 bool RenderThemeGtk::paintSearchFieldResultsButton(const RenderBox&amp; o, const PaintInfo&amp; i, const IntRect&amp; rect)
 551 {
 552     return paintSearchFieldResultsDecorationPart(o, i, rect);
 553 }
 554 
 555 void RenderThemeGtk::adjustSearchFieldResultsDecorationPartStyle(StyleResolver&amp;, RenderStyle&amp; style, const Element*) const
 556 {
 557     adjustSearchFieldIconStyle(EntryIconLeft, style);
 558 }
 559 
 560 void RenderThemeGtk::adjustSearchFieldCancelButtonStyle(StyleResolver&amp;, RenderStyle&amp; style, const Element*) const
 561 {
 562     adjustSearchFieldIconStyle(EntryIconRight, style);
 563 }
 564 

 565 static bool paintSearchFieldIcon(RenderThemeGtk* theme, RenderThemePart themePart, const RenderBox&amp; renderObject, const PaintInfo&amp; paintInfo, const IntRect&amp; rect)
 566 {
 567     ASSERT(themePart == EntryIconLeft || themePart == EntryIconRight);
 568     auto&amp; searchEntryWidget = static_cast&lt;RenderThemeSearchEntry&amp;&gt;(RenderThemeWidget::getOrCreate(RenderThemeWidget::Type::SearchEntry));
 569     searchEntryWidget.entry().setState(themePartStateFlags(*theme, Entry, renderObject));
 570     auto&amp; icon = static_cast&lt;RenderThemeIconGadget&amp;&gt;(themePart == EntryIconLeft ? searchEntryWidget.leftIcon() : searchEntryWidget.rightIcon());
 571     icon.setState(themePartStateFlags(*theme, themePart, renderObject));
 572     icon.setIconSize(renderObject.style().computedFontPixelSize());
 573     GtkBorder contentsBox = searchEntryWidget.entry().contentsBox();
 574     IntRect iconRect = rect;
 575     if (themePart == EntryIconLeft) {
 576         iconRect.move(contentsBox.left, contentsBox.top);
 577         iconRect.contract(contentsBox.left, contentsBox.top + contentsBox.bottom);
 578     } else
 579         iconRect.contract(contentsBox.right, contentsBox.top + contentsBox.bottom);
 580     return !icon.render(paintInfo.context().platformContext()-&gt;cr(), iconRect);
 581 }
 582 bool RenderThemeGtk::paintSearchFieldResultsDecorationPart(const RenderBox&amp; renderObject, const PaintInfo&amp; paintInfo, const IntRect&amp; rect)
 583 {
 584     return paintSearchFieldIcon(this, EntryIconLeft, renderObject, paintInfo, rect);
 585 }
 586 
 587 bool RenderThemeGtk::paintSearchFieldCancelButton(const RenderBox&amp; renderObject, const PaintInfo&amp; paintInfo, const IntRect&amp; rect)
 588 {
 589     return paintSearchFieldIcon(this, EntryIconRight, renderObject, paintInfo, rect);
 590 }













































 591 
<span class="line-modified"> 592 #if ENABLE(DATALIST_ELEMENT)</span>
<span class="line-added"> 593 void RenderThemeGtk::adjustListButtonStyle(StyleResolver&amp;, RenderStyle&amp; style, const Element*) const</span>
 594 {
<span class="line-modified"> 595     // Add a margin to place the button at end of the input field.</span>
<span class="line-modified"> 596     if (style.isLeftToRightDirection())</span>
<span class="line-modified"> 597         style.setMarginRight(Length(-4, Fixed));</span>
<span class="line-modified"> 598     else</span>
<span class="line-modified"> 599         style.setMarginLeft(Length(-4, Fixed));</span>

 600 }
 601 
<span class="line-modified"> 602 void RenderThemeGtk::paintListButtonForInput(const RenderObject&amp; renderObject, const PaintInfo&amp; paintInfo, const FloatRect&amp; rect)</span>
 603 {
<span class="line-modified"> 604     // Use a combo box widget to render its arrow.</span>
<span class="line-modified"> 605     auto&amp; comboWidget = static_cast&lt;RenderThemeComboBox&amp;&gt;(RenderThemeWidget::getOrCreate(RenderThemeWidget::Type::ComboBox));</span>
<span class="line-modified"> 606     comboWidget.arrow().setState(themePartStateFlags(*this, ComboBoxButton, renderObject));</span>
 607 
<span class="line-modified"> 608     // But a search entry widget to get the contents rect, since this is a text input field.</span>
<span class="line-modified"> 609     auto&amp; searchEntryWidget = static_cast&lt;RenderThemeSearchEntry&amp;&gt;(RenderThemeWidget::getOrCreate(RenderThemeWidget::Type::SearchEntry));</span>
<span class="line-added"> 610     auto&amp; icon = static_cast&lt;RenderThemeIconGadget&amp;&gt;(searchEntryWidget.rightIcon());</span>
<span class="line-added"> 611     icon.setIconSize(comboWidget.arrow().preferredSize().width());</span>
<span class="line-added"> 612     GtkBorder contentsBox = searchEntryWidget.entry().contentsBox();</span>
<span class="line-added"> 613     FloatRect adjustedRect(rect);</span>
<span class="line-added"> 614     adjustedRect.move(contentsBox.left, contentsBox.top);</span>
<span class="line-added"> 615     adjustedRect.contract(contentsBox.right + 1, contentsBox.top + contentsBox.bottom);</span>
<span class="line-added"> 616     comboWidget.arrow().render(paintInfo.context().platformContext()-&gt;cr(), adjustedRect);</span>
 617 }
<span class="line-modified"> 618 #endif</span>
 619 
 620 void RenderThemeGtk::adjustSearchFieldStyle(StyleResolver&amp;, RenderStyle&amp; style, const Element*) const
 621 {
 622     // We cannot give a proper rendering when border radius is active, unfortunately.
 623     style.resetBorderRadius();
 624     style.setLineHeight(RenderStyle::initialLineHeight());
 625 }
 626 
 627 bool RenderThemeGtk::paintSearchField(const RenderObject&amp; o, const PaintInfo&amp; i, const IntRect&amp; rect)
 628 {
 629     return paintTextField(o, i, rect);
 630 }
 631 
 632 bool RenderThemeGtk::shouldHaveCapsLockIndicator(const HTMLInputElement&amp; element) const
 633 {
 634     return element.isPasswordField();
 635 }
 636 
 637 void RenderThemeGtk::adjustSliderTrackStyle(StyleResolver&amp;, RenderStyle&amp; style, const Element*) const
 638 {
 639     style.setBoxShadow(nullptr);
 640 }
 641 
 642 void RenderThemeGtk::adjustSliderThumbStyle(StyleResolver&amp; styleResolver, RenderStyle&amp; style, const Element* element) const
 643 {
 644     RenderTheme::adjustSliderThumbStyle(styleResolver, style, element);
 645     style.setBoxShadow(nullptr);
 646 }
 647 

 648 /*
 649  * GtkScale
 650  *
 651  * scale
 652  * ╰── contents
 653  *     ╰── trough
 654  *         ├── slider
 655  *         ╰── [highlight]
 656  */
 657 bool RenderThemeGtk::paintSliderTrack(const RenderObject&amp; renderObject, const PaintInfo&amp; paintInfo, const IntRect&amp; rect)
 658 {
 659     ControlPart part = renderObject.style().appearance();
 660     ASSERT(part == SliderHorizontalPart || part == SliderVerticalPart);
 661 
 662     auto&amp; sliderWidget = static_cast&lt;RenderThemeSlider&amp;&gt;(RenderThemeWidget::getOrCreate(part == SliderHorizontalPart ? RenderThemeWidget::Type::HorizontalSlider : RenderThemeWidget::Type::VerticalSlider));
 663     auto scaleState = themePartStateFlags(*this, Scale, renderObject);
 664     auto&amp; scale = sliderWidget.scale();
 665     scale.setState(scaleState);
 666     auto&amp; contents = sliderWidget.contents();
 667     auto&amp; trough = sliderWidget.trough();
</pre>
<hr />
<pre>
 755     slider.setState(themePartStateFlags(*this, ScaleSlider, renderObject));
 756     auto&amp; highlight = sliderWidget.highlight();
 757 
 758     GtkBorder scaleContentsBox = scale.contentsBox();
 759     GtkBorder contentsContentsBox = contents.contentsBox();
 760     GtkBorder troughContentsBox = trough.contentsBox();
 761     GtkBorder padding;
 762     padding.left = scaleContentsBox.left + contentsContentsBox.left + troughContentsBox.left;
 763     padding.right = scaleContentsBox.right + contentsContentsBox.right + troughContentsBox.right;
 764     padding.top = scaleContentsBox.top + contentsContentsBox.top + troughContentsBox.top;
 765     padding.bottom = scaleContentsBox.bottom + contentsContentsBox.bottom + troughContentsBox.bottom;
 766 
 767     // Scale trough defines its size querying slider and highlight.
 768     int troughHeight = trough.preferredSize().height() + std::max(slider.preferredSize().height(), highlight.preferredSize().height());
 769     IntRect sliderRect(rect.location(), IntSize(troughHeight, troughHeight));
 770     sliderRect.move(padding.left, padding.top);
 771     sliderRect.contract(padding.left + padding.right, padding.top + padding.bottom);
 772     slider.render(paintInfo.context().platformContext()-&gt;cr(), sliderRect);
 773     return false;
 774 }













 775 














































































 776 IntRect RenderThemeGtk::progressBarRectForBounds(const RenderObject&amp; renderObject, const IntRect&amp; bounds) const
 777 {
 778     const auto&amp; renderProgress = downcast&lt;RenderProgress&gt;(renderObject);
 779     auto&amp; progressBarWidget = static_cast&lt;RenderThemeProgressBar&amp;&gt;(RenderThemeWidget::getOrCreate(renderProgress.isDeterminate() ? RenderThemeProgressBar::Type::ProgressBar : RenderThemeProgressBar::Type::IndeterminateProgressBar));
 780     IntSize preferredSize = progressBarWidget.progressBar().preferredSize();
 781     preferredSize = preferredSize.expandedTo(progressBarWidget.trough().preferredSize());
 782     preferredSize = preferredSize.expandedTo(progressBarWidget.progress().preferredSize());
 783     return IntRect(bounds.x(), bounds.y(), bounds.width(), preferredSize.height());
 784 }
 785 
 786 bool RenderThemeGtk::paintProgressBar(const RenderObject&amp; renderObject, const PaintInfo&amp; paintInfo, const IntRect&amp; rect)
 787 {
 788     if (!renderObject.isProgress())
 789         return true;
 790 
 791     const auto&amp; renderProgress = downcast&lt;RenderProgress&gt;(renderObject);
 792     auto&amp; progressBarWidget = static_cast&lt;RenderThemeProgressBar&amp;&gt;(RenderThemeWidget::getOrCreate(renderProgress.isDeterminate() ? RenderThemeProgressBar::Type::ProgressBar : RenderThemeProgressBar::Type::IndeterminateProgressBar));
 793     progressBarWidget.progressBar().render(paintInfo.context().platformContext()-&gt;cr(), rect);
 794     progressBarWidget.trough().render(paintInfo.context().platformContext()-&gt;cr(), rect);
 795     progressBarWidget.progress().render(paintInfo.context().platformContext()-&gt;cr(), calculateProgressRect(renderObject, rect));
 796     return false;
 797 }










 798 
































 799 RenderTheme::InnerSpinButtonLayout RenderThemeGtk::innerSpinButtonLayout(const RenderObject&amp; renderObject) const
 800 {
 801     return renderObject.style().direction() == TextDirection::RTL ? InnerSpinButtonLayout::HorizontalUpLeft : InnerSpinButtonLayout::HorizontalUpRight;
 802 }
 803 
 804 void RenderThemeGtk::adjustInnerSpinButtonStyle(StyleResolver&amp;, RenderStyle&amp; style, const Element*) const
 805 {
 806     style.setWidth(Length(spinButtonSize().width(), Fixed));
 807     style.setHeight(Length(spinButtonSize().height(), Fixed));
 808 }
 809 
 810 bool RenderThemeGtk::paintInnerSpinButton(const RenderObject&amp; renderObject, const PaintInfo&amp; paintInfo, const IntRect&amp; rect)
 811 {
 812     auto&amp; spinButtonWidget = static_cast&lt;RenderThemeSpinButton&amp;&gt;(RenderThemeWidget::getOrCreate(RenderThemeWidget::Type::SpinButton));
 813     auto spinButtonState = themePartStateFlags(*this, SpinButton, renderObject);
 814     spinButtonWidget.spinButton().setState(spinButtonState);
 815     spinButtonWidget.entry().setState(spinButtonState);
 816     auto&amp; up = spinButtonWidget.up();
 817     up.setState(themePartStateFlags(*this, SpinButtonUpButton, renderObject));
 818     auto&amp; down = spinButtonWidget.down();
 819     down.setState(themePartStateFlags(*this, SpinButtonDownButton, renderObject));
 820 
 821     IntRect iconRect = rect;
 822     iconRect.setWidth(iconRect.width() / 2);
 823     if (renderObject.style().direction() == TextDirection::RTL)
 824         up.render(paintInfo.context().platformContext()-&gt;cr(), iconRect);
 825     else
 826         down.render(paintInfo.context().platformContext()-&gt;cr(), iconRect);
 827     iconRect.move(iconRect.width(), 0);
 828     if (renderObject.style().direction() == TextDirection::RTL)
 829         down.render(paintInfo.context().platformContext()-&gt;cr(), iconRect);
 830     else
 831         up.render(paintInfo.context().platformContext()-&gt;cr(), iconRect);
 832 
 833     return false;
 834 }












































































































 835 
 836 Seconds RenderThemeGtk::caretBlinkInterval() const
 837 {
 838     GtkSettings* settings = gtk_settings_get_default();
 839 
 840     gboolean shouldBlink;
 841     gint time;
 842 
 843     g_object_get(settings, &quot;gtk-cursor-blink&quot;, &amp;shouldBlink, &quot;gtk-cursor-blink-time&quot;, &amp;time, nullptr);
 844 
 845     if (!shouldBlink)
 846         return 0_s;
 847 
 848     return 500_us * time;
 849 }
 850 
 851 enum StyleColorType { StyleColorBackground, StyleColorForeground };
 852 

 853 static Color styleColor(RenderThemePart themePart, GtkStateFlags state, StyleColorType colorType)
 854 {
 855     RenderThemeGadget* gadget = nullptr;
 856     switch (themePart) {
 857     default:
 858         ASSERT_NOT_REACHED();
 859         FALLTHROUGH;
 860     case Entry:
 861         gadget = &amp;static_cast&lt;RenderThemeEntry&amp;&gt;(RenderThemeWidget::getOrCreate(RenderThemeWidget::Type::Entry)).entry();
 862         break;
 863     case EntrySelection:
 864         gadget = static_cast&lt;RenderThemeEntry&amp;&gt;(RenderThemeWidget::getOrCreate(RenderThemeWidget::Type::SelectedEntry)).selection();
 865         break;
 866     case ListBox:
 867         gadget = &amp;static_cast&lt;RenderThemeListView&amp;&gt;(RenderThemeWidget::getOrCreate(RenderThemeWidget::Type::ListView)).treeview();
 868         break;
 869     case Button:
 870         gadget = &amp;static_cast&lt;RenderThemeButton&amp;&gt;(RenderThemeWidget::getOrCreate(RenderThemeWidget::Type::Button)).button();
 871         break;
<span class="line-added"> 872     case Window:</span>
<span class="line-added"> 873         gadget = &amp;static_cast&lt;RenderThemeWindow&amp;&gt;(RenderThemeWidget::getOrCreate(RenderThemeWidget::Type::Window)).window();</span>
<span class="line-added"> 874         break;</span>
 875     }
 876 
 877     ASSERT(gadget);
 878     gadget-&gt;setState(state);
 879     return colorType == StyleColorBackground ? gadget-&gt;backgroundColor() : gadget-&gt;color();
 880 }














 881 
 882 Color RenderThemeGtk::platformActiveSelectionBackgroundColor(OptionSet&lt;StyleColor::Options&gt;) const
 883 {
 884     return styleColor(EntrySelection, static_cast&lt;GtkStateFlags&gt;(GTK_STATE_FLAG_SELECTED | GTK_STATE_FLAG_FOCUSED), StyleColorBackground);
 885 }
 886 
 887 Color RenderThemeGtk::platformInactiveSelectionBackgroundColor(OptionSet&lt;StyleColor::Options&gt;) const
 888 {
 889     return styleColor(EntrySelection, GTK_STATE_FLAG_SELECTED, StyleColorBackground);
 890 }
 891 
 892 Color RenderThemeGtk::platformActiveSelectionForegroundColor(OptionSet&lt;StyleColor::Options&gt;) const
 893 {
 894     return styleColor(EntrySelection, static_cast&lt;GtkStateFlags&gt;(GTK_STATE_FLAG_SELECTED | GTK_STATE_FLAG_FOCUSED), StyleColorForeground);
 895 }
 896 
 897 Color RenderThemeGtk::platformInactiveSelectionForegroundColor(OptionSet&lt;StyleColor::Options&gt;) const
 898 {
 899     return styleColor(EntrySelection, GTK_STATE_FLAG_SELECTED, StyleColorForeground);
 900 }
</pre>
<hr />
<pre>
 902 Color RenderThemeGtk::platformActiveListBoxSelectionBackgroundColor(OptionSet&lt;StyleColor::Options&gt;) const
 903 {
 904     return styleColor(ListBox, static_cast&lt;GtkStateFlags&gt;(GTK_STATE_FLAG_SELECTED | GTK_STATE_FLAG_FOCUSED), StyleColorBackground);
 905 }
 906 
 907 Color RenderThemeGtk::platformInactiveListBoxSelectionBackgroundColor(OptionSet&lt;StyleColor::Options&gt;) const
 908 {
 909     return styleColor(ListBox, GTK_STATE_FLAG_SELECTED, StyleColorBackground);
 910 }
 911 
 912 Color RenderThemeGtk::platformActiveListBoxSelectionForegroundColor(OptionSet&lt;StyleColor::Options&gt;) const
 913 {
 914     return styleColor(ListBox, static_cast&lt;GtkStateFlags&gt;(GTK_STATE_FLAG_SELECTED | GTK_STATE_FLAG_FOCUSED), StyleColorForeground);
 915 }
 916 
 917 Color RenderThemeGtk::platformInactiveListBoxSelectionForegroundColor(OptionSet&lt;StyleColor::Options&gt;) const
 918 {
 919     return styleColor(ListBox, GTK_STATE_FLAG_SELECTED, StyleColorForeground);
 920 }
 921 
<span class="line-added"> 922 Color RenderThemeGtk::disabledTextColor(const Color&amp;, const Color&amp;) const</span>
<span class="line-added"> 923 {</span>
<span class="line-added"> 924     return styleColor(Entry, GTK_STATE_FLAG_INSENSITIVE, StyleColorForeground);</span>
<span class="line-added"> 925 }</span>
<span class="line-added"> 926 </span>
 927 Color RenderThemeGtk::systemColor(CSSValueID cssValueId, OptionSet&lt;StyleColor::Options&gt; options) const
 928 {
 929     switch (cssValueId) {
 930     case CSSValueButtontext:
 931         return styleColor(Button, GTK_STATE_FLAG_ACTIVE, StyleColorForeground);
 932     case CSSValueCaptiontext:
 933         return styleColor(Entry, GTK_STATE_FLAG_ACTIVE, StyleColorForeground);
<span class="line-added"> 934     case CSSValueText:</span>
<span class="line-added"> 935         return styleColor(Entry, GTK_STATE_FLAG_ACTIVE, StyleColorForeground);</span>
<span class="line-added"> 936     case CSSValueGraytext:</span>
<span class="line-added"> 937         return styleColor(Entry, GTK_STATE_FLAG_INSENSITIVE, StyleColorForeground);</span>
 938     default:
<span class="line-modified"> 939         break;</span>
 940     }
<span class="line-added"> 941 </span>
<span class="line-added"> 942     return RenderTheme::systemColor(cssValueId, options);</span>
 943 }
 944 
 945 void RenderThemeGtk::platformColorsDidChange()
 946 {
 947     RenderTheme::platformColorsDidChange();
 948 }
 949 
 950 #if ENABLE(VIDEO)
 951 String RenderThemeGtk::extraMediaControlsStyleSheet()
 952 {
 953     return String(mediaControlsGtkUserAgentStyleSheet, sizeof(mediaControlsGtkUserAgentStyleSheet));
 954 }
 955 
 956 #if ENABLE(FULLSCREEN_API)
 957 String RenderThemeGtk::extraFullScreenStyleSheet()
 958 {
 959     return String();
 960 }
 961 #endif
 962 

 963 bool RenderThemeGtk::paintMediaButton(const RenderObject&amp; renderObject, GraphicsContext&amp; graphicsContext, const IntRect&amp; rect, const char* iconName)
 964 {
 965     auto&amp; iconWidget = static_cast&lt;RenderThemeIcon&amp;&gt;(RenderThemeWidget::getOrCreate(RenderThemeWidget::Type::Icon));
 966     auto&amp; icon = static_cast&lt;RenderThemeIconGadget&amp;&gt;(iconWidget.icon());
 967     icon.setState(themePartStateFlags(*this, MediaButton, renderObject));
 968     icon.setIconSize(RenderThemeIconGadget::IconSizeGtk::Menu);
 969     icon.setIconName(iconName);
 970     return !icon.render(graphicsContext.platformContext()-&gt;cr(), rect);
 971 }











 972 
 973 bool RenderThemeGtk::hasOwnDisabledStateHandlingFor(ControlPart part) const
 974 {
 975     return (part != MediaMuteButtonPart);
 976 }
 977 
 978 bool RenderThemeGtk::paintMediaFullscreenButton(const RenderObject&amp; renderObject, const PaintInfo&amp; paintInfo, const IntRect&amp; rect)
 979 {
 980     return paintMediaButton(renderObject, paintInfo.context(), rect, &quot;view-fullscreen-symbolic&quot;);
 981 }
 982 
 983 bool RenderThemeGtk::paintMediaMuteButton(const RenderObject&amp; renderObject, const PaintInfo&amp; paintInfo, const IntRect&amp; rect)
 984 {
 985     Node* node = renderObject.node();
 986     if (!node)
 987         return true;
 988     Node* mediaNode = node-&gt;shadowHost();
 989     if (!is&lt;HTMLMediaElement&gt;(mediaNode))
 990         return true;
 991 
</pre>
<hr />
<pre>
1168         return String();
1169 
1170     if (fileList-&gt;length() &gt; 1)
1171         return StringTruncator::rightTruncate(multipleFileUploadText(fileList-&gt;length()), width, font);
1172 
1173     String string;
1174     if (fileList-&gt;length())
1175         string = FileSystem::pathGetFileName(fileList-&gt;item(0)-&gt;path());
1176     else if (multipleFilesAllowed)
1177         string = fileButtonNoFilesSelectedLabel();
1178     else
1179         string = fileButtonNoFileSelectedLabel();
1180 
1181     return StringTruncator::centerTruncate(string, width, font);
1182 }
1183 
1184 #if ENABLE(VIDEO)
1185 String RenderThemeGtk::mediaControlsScript()
1186 {
1187     StringBuilder scriptBuilder;
<span class="line-modified">1188     scriptBuilder.appendCharacters(mediaControlsLocalizedStringsJavaScript, sizeof(mediaControlsLocalizedStringsJavaScript));</span>
<span class="line-modified">1189     scriptBuilder.appendCharacters(mediaControlsBaseJavaScript, sizeof(mediaControlsBaseJavaScript));</span>
<span class="line-modified">1190     scriptBuilder.appendCharacters(mediaControlsGtkJavaScript, sizeof(mediaControlsGtkJavaScript));</span>
1191     return scriptBuilder.toString();
1192 }
1193 #endif // ENABLE(VIDEO)


1194 }
</pre>
</td>
</tr>
</table>
<center><a href="RenderTheme.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="RenderThemeGtk.h.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>