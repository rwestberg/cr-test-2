<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames modules/javafx.web/src/main/native/Source/WebCore/Modules/applepay/ApplePaySession.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>   1 /*
   2  * Copyright (C) 2015-2019 Apple Inc. All rights reserved.
   3  *
   4  * Redistribution and use in source and binary forms, with or without
   5  * modification, are permitted provided that the following conditions
   6  * are met:
   7  * 1. Redistributions of source code must retain the above copyright
   8  *    notice, this list of conditions and the following disclaimer.
   9  * 2. Redistributions in binary form must reproduce the above copyright
  10  *    notice, this list of conditions and the following disclaimer in the
  11  *    documentation and/or other materials provided with the distribution.
  12  *
  13  * THIS SOFTWARE IS PROVIDED BY APPLE INC. AND ITS CONTRIBUTORS ``AS IS&#39;&#39;
  14  * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO,
  15  * THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
  16  * PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL APPLE INC. OR ITS CONTRIBUTORS
  17  * BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
  18  * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
  19  * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
  20  * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
  21  * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
  22  * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF
  23  * THE POSSIBILITY OF SUCH DAMAGE.
  24  */
  25 
  26 #include &quot;config.h&quot;
  27 #include &quot;ApplePaySession.h&quot;
  28 
  29 #if ENABLE(APPLE_PAY)
  30 
  31 #include &quot;ApplePayLineItem.h&quot;
  32 #include &quot;ApplePayPaymentAuthorizationResult.h&quot;
  33 #include &quot;ApplePayPaymentAuthorizedEvent.h&quot;
  34 #include &quot;ApplePayPaymentMethodSelectedEvent.h&quot;
  35 #include &quot;ApplePayPaymentMethodUpdate.h&quot;
  36 #include &quot;ApplePayPaymentRequest.h&quot;
  37 #include &quot;ApplePayShippingContactSelectedEvent.h&quot;
  38 #include &quot;ApplePayShippingContactUpdate.h&quot;
  39 #include &quot;ApplePayShippingMethod.h&quot;
  40 #include &quot;ApplePayShippingMethodSelectedEvent.h&quot;
  41 #include &quot;ApplePayShippingMethodUpdate.h&quot;
  42 #include &quot;ApplePayValidateMerchantEvent.h&quot;
<a name="1" id="anc1"></a>
  43 #include &quot;DOMWindow.h&quot;
  44 #include &quot;Document.h&quot;
  45 #include &quot;DocumentLoader.h&quot;
  46 #include &quot;EventNames.h&quot;
  47 #include &quot;Frame.h&quot;
  48 #include &quot;JSDOMPromiseDeferred.h&quot;
  49 #include &quot;LinkIconCollector.h&quot;
  50 #include &quot;LinkIconType.h&quot;
  51 #include &quot;Page.h&quot;
  52 #include &quot;PageConsoleClient.h&quot;
  53 #include &quot;PaymentAuthorizationStatus.h&quot;
  54 #include &quot;PaymentContact.h&quot;
  55 #include &quot;PaymentCoordinator.h&quot;
  56 #include &quot;PaymentMerchantSession.h&quot;
  57 #include &quot;PaymentMethod.h&quot;
  58 #include &quot;PaymentRequestValidator.h&quot;
  59 #include &quot;SecurityOrigin.h&quot;
  60 #include &quot;Settings.h&quot;
  61 #include &quot;UserGestureIndicator.h&quot;
<a name="2" id="anc2"></a>
  62 
  63 namespace WebCore {
  64 
<a name="3" id="anc3"></a>

  65 // The amount follows the regular expression -?[0-9]+(\.[0-9][0-9])?.
  66 static bool validateAmount(const String&amp; amountString)
  67 {
  68     enum class State {
  69         Start,
  70         Sign,
  71         Digit,
  72         Dot,
  73         DotDigit,
  74         End,
  75     };
  76 
  77     State state = State::Start;
  78 
  79     for (unsigned i = 0; i &lt; amountString.length(); ++i) {
  80         UChar c = amountString[i];
  81 
  82         switch (state) {
  83         case State::Start:
  84             if (c == &#39;-&#39;) {
  85                 state = State::Sign;
  86                 break;
  87             }
  88 
  89             if (!isASCIIDigit(c))
  90                 return false;
  91             state = State::Digit;
  92             break;
  93 
  94         case State::Sign:
  95             if (!isASCIIDigit(c))
  96                 return false;
  97             state = State::Digit;
  98             break;
  99 
 100         case State::Digit:
 101             if (c == &#39;.&#39;) {
 102                 state = State::Dot;
 103                 break;
 104             }
 105 
 106             if (!isASCIIDigit(c))
 107                 return false;
 108             break;
 109 
 110         case State::Dot:
 111             if (!isASCIIDigit(c))
 112                 return false;
 113 
 114             state = State::DotDigit;
 115             break;
 116 
 117         case State::DotDigit:
 118             if (!isASCIIDigit(c))
 119                 return false;
 120 
 121             state = State::End;
 122             break;
 123 
 124         case State::End:
 125             return false;
 126         }
 127     }
 128 
 129     return state == State::Digit || state == State::DotDigit || state == State::End;
 130 }
 131 
 132 static ExceptionOr&lt;ApplePaySessionPaymentRequest::LineItem&gt; convertAndValidateTotal(ApplePayLineItem&amp;&amp; lineItem)
 133 {
 134     if (!validateAmount(lineItem.amount))
 135         return Exception { TypeError, makeString(&quot;\&quot;&quot; + lineItem.amount, &quot;\&quot; is not a valid amount.&quot;) };
 136 
 137     ApplePaySessionPaymentRequest::LineItem result;
 138     result.amount = lineItem.amount;
 139     result.type = lineItem.type;
 140     result.label = lineItem.label;
 141 
 142     return WTFMove(result);
 143 }
 144 
 145 static ExceptionOr&lt;ApplePaySessionPaymentRequest::LineItem&gt; convertAndValidate(ApplePayLineItem&amp;&amp; lineItem)
 146 {
 147     ApplePaySessionPaymentRequest::LineItem result;
 148 
 149     // It is OK for pending types to not have an amount.
 150     if (lineItem.type != ApplePaySessionPaymentRequest::LineItem::Type::Pending) {
 151         if (!validateAmount(lineItem.amount))
 152             return Exception { TypeError, makeString(&quot;\&quot;&quot; + lineItem.amount, &quot;\&quot; is not a valid amount.&quot;) };
 153 
 154         result.amount = lineItem.amount;
 155     }
 156 
 157     result.type = lineItem.type;
 158     result.label = lineItem.label;
 159 
 160     return WTFMove(result);
 161 }
 162 
 163 static ExceptionOr&lt;Vector&lt;ApplePaySessionPaymentRequest::LineItem&gt;&gt; convertAndValidate(Optional&lt;Vector&lt;ApplePayLineItem&gt;&gt;&amp;&amp; lineItems)
 164 {
 165     Vector&lt;ApplePaySessionPaymentRequest::LineItem&gt; result;
 166     if (!lineItems)
 167         return WTFMove(result);
 168 
 169     result.reserveInitialCapacity(lineItems-&gt;size());
 170 
 171     for (auto lineItem : lineItems.value()) {
 172         auto convertedLineItem = convertAndValidate(WTFMove(lineItem));
 173         if (convertedLineItem.hasException())
 174             return convertedLineItem.releaseException();
 175         result.uncheckedAppend(convertedLineItem.releaseReturnValue());
 176     }
 177 
 178     return WTFMove(result);
 179 }
 180 
 181 static ExceptionOr&lt;ApplePaySessionPaymentRequest::ShippingMethod&gt; convertAndValidate(ApplePayShippingMethod&amp;&amp; shippingMethod)
 182 {
 183     if (!validateAmount(shippingMethod.amount))
 184         return Exception { TypeError, makeString(&quot;\&quot;&quot; + shippingMethod.amount, &quot;\&quot; is not a valid amount.&quot;) };
 185 
 186     ApplePaySessionPaymentRequest::ShippingMethod result;
 187     result.amount = shippingMethod.amount;
 188     result.label = shippingMethod.label;
 189     result.detail = shippingMethod.detail;
 190     result.identifier = shippingMethod.identifier;
 191 
 192     return WTFMove(result);
 193 }
 194 
 195 static ExceptionOr&lt;Vector&lt;ApplePaySessionPaymentRequest::ShippingMethod&gt;&gt; convertAndValidate(Vector&lt;ApplePayShippingMethod&gt;&amp;&amp; shippingMethods)
 196 {
 197     Vector&lt;ApplePaySessionPaymentRequest::ShippingMethod&gt; result;
 198     result.reserveInitialCapacity(shippingMethods.size());
 199 
 200     for (auto&amp; shippingMethod : shippingMethods) {
 201         auto convertedShippingMethod = convertAndValidate(WTFMove(shippingMethod));
 202         if (convertedShippingMethod.hasException())
 203             return convertedShippingMethod.releaseException();
 204         result.uncheckedAppend(convertedShippingMethod.releaseReturnValue());
 205     }
 206 
 207     return WTFMove(result);
 208 }
 209 
<a name="4" id="anc4"></a><span class="line-modified"> 210 static ExceptionOr&lt;ApplePaySessionPaymentRequest&gt; convertAndValidate(unsigned version, ApplePayPaymentRequest&amp;&amp; paymentRequest, const PaymentCoordinator&amp; paymentCoordinator)</span>
 211 {
<a name="5" id="anc5"></a><span class="line-modified"> 212     auto convertedRequest = convertAndValidate(version, paymentRequest, paymentCoordinator);</span>
 213     if (convertedRequest.hasException())
 214         return convertedRequest.releaseException();
 215 
 216     auto result = convertedRequest.releaseReturnValue();
 217     result.setRequester(ApplePaySessionPaymentRequest::Requester::ApplePayJS);
 218     result.setCurrencyCode(paymentRequest.currencyCode);
 219 
 220     auto total = convertAndValidateTotal(WTFMove(paymentRequest.total));
 221     if (total.hasException())
 222         return total.releaseException();
 223     result.setTotal(total.releaseReturnValue());
 224 
 225     auto lineItems = convertAndValidate(WTFMove(paymentRequest.lineItems));
 226     if (lineItems.hasException())
 227         return lineItems.releaseException();
 228     result.setLineItems(lineItems.releaseReturnValue());
 229 
 230     result.setShippingType(paymentRequest.shippingType);
 231 
 232     if (paymentRequest.shippingMethods) {
 233         auto shippingMethods = convertAndValidate(WTFMove(*paymentRequest.shippingMethods));
 234         if (shippingMethods.hasException())
 235             return shippingMethods.releaseException();
 236         result.setShippingMethods(shippingMethods.releaseReturnValue());
 237     }
 238 
 239     // FIXME: Merge this validation into the validation we are doing above.
 240     auto validatedPaymentRequest = PaymentRequestValidator::validate(result);
 241     if (validatedPaymentRequest.hasException())
 242         return validatedPaymentRequest.releaseException();
 243 
 244     return WTFMove(result);
 245 }
 246 
 247 
 248 static Vector&lt;PaymentError&gt; convert(const Vector&lt;RefPtr&lt;ApplePayError&gt;&gt;&amp; errors)
 249 {
 250     Vector&lt;PaymentError&gt; convertedErrors;
 251 
 252     for (auto&amp; error : errors) {
 253         PaymentError convertedError;
 254 
 255         convertedError.code = error-&gt;code();
 256         convertedError.message = error-&gt;message();
 257         convertedError.contactField = error-&gt;contactField();
 258 
 259         convertedErrors.append(convertedError);
 260     }
 261 
 262     return convertedErrors;
 263 }
 264 
 265 static ExceptionOr&lt;PaymentAuthorizationResult&gt; convertAndValidate(ApplePayPaymentAuthorizationResult&amp;&amp; result)
 266 {
 267     PaymentAuthorizationResult convertedResult;
 268 
 269     switch (result.status) {
 270     case ApplePaySession::STATUS_SUCCESS:
 271         convertedResult.status = PaymentAuthorizationStatus::Success;
 272         break;
 273 
 274     case ApplePaySession::STATUS_FAILURE:
 275         convertedResult.status = PaymentAuthorizationStatus::Failure;
 276         break;
 277 
 278     case ApplePaySession::STATUS_INVALID_BILLING_POSTAL_ADDRESS:
 279         convertedResult.status = PaymentAuthorizationStatus::Failure;
 280         convertedResult.errors.append({ PaymentError::Code::BillingContactInvalid, { }, WTF::nullopt });
 281         break;
 282 
 283     case ApplePaySession::STATUS_INVALID_SHIPPING_POSTAL_ADDRESS:
 284         convertedResult.status = PaymentAuthorizationStatus::Failure;
 285         convertedResult.errors.append({ PaymentError::Code::ShippingContactInvalid, { }, PaymentError::ContactField::PostalAddress });
 286         break;
 287 
 288     case ApplePaySession::STATUS_INVALID_SHIPPING_CONTACT:
 289         convertedResult.status = PaymentAuthorizationStatus::Failure;
 290         convertedResult.errors.append({ PaymentError::Code::ShippingContactInvalid, { }, WTF::nullopt });
 291         break;
 292 
 293     case ApplePaySession::STATUS_PIN_REQUIRED:
 294         convertedResult.status = PaymentAuthorizationStatus::PINRequired;
 295         break;
 296 
 297     case ApplePaySession::STATUS_PIN_INCORRECT:
 298         convertedResult.status = PaymentAuthorizationStatus::PINIncorrect;
 299         break;
 300 
 301     case ApplePaySession::STATUS_PIN_LOCKOUT:
 302         convertedResult.status = PaymentAuthorizationStatus::PINLockout;
 303         break;
 304 
 305     default:
 306         return Exception { InvalidAccessError };
 307     }
 308 
 309     convertedResult.errors.appendVector(convert(result.errors));
 310 
 311     return WTFMove(convertedResult);
 312 }
 313 
 314 static ExceptionOr&lt;PaymentMethodUpdate&gt; convertAndValidate(ApplePayPaymentMethodUpdate&amp;&amp; update)
 315 {
 316     PaymentMethodUpdate convertedUpdate;
 317 
 318     auto convertedNewTotal = convertAndValidateTotal(WTFMove(update.newTotal));
 319     if (convertedNewTotal.hasException())
 320         return convertedNewTotal.releaseException();
 321     convertedUpdate.newTotalAndLineItems.total = convertedNewTotal.releaseReturnValue();
 322 
 323     // FIXME: Merge this validation into the validation we are doing above.
 324     auto validatedTotal = PaymentRequestValidator::validateTotal(convertedUpdate.newTotalAndLineItems.total);
 325     if (validatedTotal.hasException())
 326         return validatedTotal.releaseException();
 327 
 328     auto convertedNewLineItems = convertAndValidate(WTFMove(update.newLineItems));
 329     if (convertedNewLineItems.hasException())
 330         return convertedNewLineItems.releaseException();
 331 
 332     convertedUpdate.newTotalAndLineItems.lineItems = convertedNewLineItems.releaseReturnValue();
 333 
 334     return WTFMove(convertedUpdate);
 335 }
 336 
 337 static ExceptionOr&lt;ShippingContactUpdate&gt; convertAndValidate(ApplePayShippingContactUpdate&amp;&amp; update)
 338 {
 339     ShippingContactUpdate convertedUpdate;
 340 
 341     convertedUpdate.errors = convert(update.errors);
 342 
 343     auto convertedNewShippingMethods = convertAndValidate(WTFMove(update.newShippingMethods));
 344     if (convertedNewShippingMethods.hasException())
 345         return convertedNewShippingMethods.releaseException();
 346     convertedUpdate.newShippingMethods = convertedNewShippingMethods.releaseReturnValue();
 347 
 348     auto convertedNewTotal = convertAndValidateTotal(WTFMove(update.newTotal));
 349     if (convertedNewTotal.hasException())
 350         return convertedNewTotal.releaseException();
 351     convertedUpdate.newTotalAndLineItems.total = convertedNewTotal.releaseReturnValue();
 352 
 353     // FIXME: Merge this validation into the validation we are doing above.
 354     auto validatedTotal = PaymentRequestValidator::validateTotal(convertedUpdate.newTotalAndLineItems.total);
 355     if (validatedTotal.hasException())
 356         return validatedTotal.releaseException();
 357 
 358     auto convertedNewLineItems = convertAndValidate(WTFMove(update.newLineItems));
 359     if (convertedNewLineItems.hasException())
 360         return convertedNewLineItems.releaseException();
 361     convertedUpdate.newTotalAndLineItems.lineItems = convertedNewLineItems.releaseReturnValue();
 362 
 363     return WTFMove(convertedUpdate);
 364 }
 365 
 366 static ExceptionOr&lt;ShippingMethodUpdate&gt; convertAndValidate(ApplePayShippingMethodUpdate&amp;&amp; update)
 367 {
 368     ShippingMethodUpdate convertedUpdate;
 369 
 370     auto convertedNewTotal = convertAndValidateTotal(WTFMove(update.newTotal));
 371     if (convertedNewTotal.hasException())
 372         return convertedNewTotal.releaseException();
 373 
 374     convertedUpdate.newTotalAndLineItems.total = convertedNewTotal.releaseReturnValue();
 375 
 376     // FIXME: Merge this validation into the validation we are doing above.
 377     auto validatedTotal = PaymentRequestValidator::validateTotal(convertedUpdate.newTotalAndLineItems.total);
 378     if (validatedTotal.hasException())
 379         return validatedTotal.releaseException();
 380 
 381     auto convertedNewLineItems = convertAndValidate(WTFMove(update.newLineItems));
 382     if (convertedNewLineItems.hasException())
 383         return convertedNewLineItems.releaseException();
 384 
 385     convertedUpdate.newTotalAndLineItems.lineItems = convertedNewLineItems.releaseReturnValue();
 386 
 387     return WTFMove(convertedUpdate);
 388 }
 389 
 390 ExceptionOr&lt;Ref&lt;ApplePaySession&gt;&gt; ApplePaySession::create(Document&amp; document, unsigned version, ApplePayPaymentRequest&amp;&amp; paymentRequest)
 391 {
 392     auto canCall = canCreateSession(document);
 393     if (canCall.hasException())
 394         return canCall.releaseException();
 395 
 396     if (!UserGestureIndicator::processingUserGesture())
 397         return Exception { InvalidAccessError, &quot;Must create a new ApplePaySession from a user gesture handler.&quot; };
 398 
 399     if (!document.page())
 400         return Exception { InvalidAccessError, &quot;Frame is detached&quot; };
 401 
<a name="6" id="anc6"></a><span class="line-modified"> 402     auto convertedPaymentRequest = convertAndValidate(version, WTFMove(paymentRequest), document.page()-&gt;paymentCoordinator());</span>
 403     if (convertedPaymentRequest.hasException())
 404         return convertedPaymentRequest.releaseException();
 405 
 406     return adoptRef(*new ApplePaySession(document, version, convertedPaymentRequest.releaseReturnValue()));
 407 }
 408 
 409 ApplePaySession::ApplePaySession(Document&amp; document, unsigned version, ApplePaySessionPaymentRequest&amp;&amp; paymentRequest)
 410     : ActiveDOMObject { document }
 411     , m_paymentRequest { WTFMove(paymentRequest) }
 412     , m_version { version }
 413 {
<a name="7" id="anc7"></a><span class="line-modified"> 414     ASSERT(document.page()-&gt;paymentCoordinator().supportsVersion(version));</span>
 415     suspendIfNeeded();
 416 }
 417 
 418 ApplePaySession::~ApplePaySession() = default;
 419 
<a name="8" id="anc8"></a><span class="line-modified"> 420 ExceptionOr&lt;bool&gt; ApplePaySession::supportsVersion(ScriptExecutionContext&amp; scriptExecutionContext, unsigned version)</span>
 421 {
 422     if (!version)
 423         return Exception { InvalidAccessError };
 424 
<a name="9" id="anc9"></a><span class="line-removed"> 425     auto&amp; document = downcast&lt;Document&gt;(scriptExecutionContext);</span>
<span class="line-removed"> 426 </span>
 427     auto canCall = canCreateSession(document);
 428     if (canCall.hasException())
 429         return canCall.releaseException();
 430 
 431     auto* page = document.page();
 432     if (!page)
 433         return Exception { InvalidAccessError };
 434 
<a name="10" id="anc10"></a><span class="line-modified"> 435     return page-&gt;paymentCoordinator().supportsVersion(version);</span>
 436 }
 437 
 438 static bool shouldDiscloseApplePayCapability(Document&amp; document)
 439 {
 440     auto* page = document.page();
 441     if (!page || page-&gt;usesEphemeralSession())
 442         return false;
 443 
 444     return document.settings().applePayCapabilityDisclosureAllowed();
 445 }
 446 
<a name="11" id="anc11"></a><span class="line-modified"> 447 ExceptionOr&lt;bool&gt; ApplePaySession::canMakePayments(ScriptExecutionContext&amp; scriptExecutionContext)</span>
 448 {
<a name="12" id="anc12"></a><span class="line-removed"> 449     auto&amp; document = downcast&lt;Document&gt;(scriptExecutionContext);</span>
<span class="line-removed"> 450 </span>
 451     auto canCall = canCreateSession(document);
 452     if (canCall.hasException())
 453         return canCall.releaseException();
 454 
 455     auto* page = document.page();
 456     if (!page)
 457         return Exception { InvalidAccessError };
 458 
<a name="13" id="anc13"></a><span class="line-modified"> 459     return page-&gt;paymentCoordinator().canMakePayments();</span>
 460 }
 461 
<a name="14" id="anc14"></a><span class="line-modified"> 462 ExceptionOr&lt;void&gt; ApplePaySession::canMakePaymentsWithActiveCard(ScriptExecutionContext&amp; scriptExecutionContext, const String&amp; merchantIdentifier, Ref&lt;DeferredPromise&gt;&amp;&amp; passedPromise)</span>
 463 {
<a name="15" id="anc15"></a><span class="line-removed"> 464     auto&amp; document = downcast&lt;Document&gt;(scriptExecutionContext);</span>
<span class="line-removed"> 465 </span>
 466     auto canCall = canCreateSession(document);
 467     if (canCall.hasException())
 468         return canCall.releaseException();
 469 
 470     RefPtr&lt;DeferredPromise&gt; promise(WTFMove(passedPromise));
 471     if (!shouldDiscloseApplePayCapability(document)) {
 472         auto* page = document.page();
 473         if (!page)
 474             return Exception { InvalidAccessError };
 475 
 476         auto&amp; paymentCoordinator = page-&gt;paymentCoordinator();
<a name="16" id="anc16"></a><span class="line-modified"> 477         bool canMakePayments = paymentCoordinator.canMakePayments();</span>
 478 
 479         RunLoop::main().dispatch([promise, canMakePayments]() mutable {
 480             promise-&gt;resolve&lt;IDLBoolean&gt;(canMakePayments);
 481         });
 482         return { };
 483     }
 484 
 485     auto* page = document.page();
 486     if (!page)
 487         return Exception { InvalidAccessError };
 488 
 489     auto&amp; paymentCoordinator = page-&gt;paymentCoordinator();
 490 
<a name="17" id="anc17"></a><span class="line-modified"> 491     paymentCoordinator.canMakePaymentsWithActiveCard(merchantIdentifier, document.domain(), [promise](bool canMakePayments) mutable {</span>
 492         promise-&gt;resolve&lt;IDLBoolean&gt;(canMakePayments);
 493     });
 494     return { };
 495 }
 496 
<a name="18" id="anc18"></a><span class="line-modified"> 497 ExceptionOr&lt;void&gt; ApplePaySession::openPaymentSetup(ScriptExecutionContext&amp; scriptExecutionContext, const String&amp; merchantIdentifier, Ref&lt;DeferredPromise&gt;&amp;&amp; passedPromise)</span>
 498 {
<a name="19" id="anc19"></a><span class="line-removed"> 499     auto&amp; document = downcast&lt;Document&gt;(scriptExecutionContext);</span>
<span class="line-removed"> 500 </span>
 501     auto canCall = canCreateSession(document);
 502     if (canCall.hasException())
 503         return canCall.releaseException();
 504 
 505     if (!UserGestureIndicator::processingUserGesture())
 506         return Exception { InvalidAccessError, &quot;Must call ApplePaySession.openPaymentSetup from a user gesture handler.&quot; };
 507 
 508     auto* page = document.page();
 509     if (!page)
 510         return Exception { InvalidAccessError };
 511 
 512     auto&amp; paymentCoordinator = page-&gt;paymentCoordinator();
 513 
 514     RefPtr&lt;DeferredPromise&gt; promise(WTFMove(passedPromise));
<a name="20" id="anc20"></a><span class="line-modified"> 515     paymentCoordinator.openPaymentSetup(merchantIdentifier, document.domain(), [promise](bool result) mutable {</span>
 516         promise-&gt;resolve&lt;IDLBoolean&gt;(result);
 517     });
 518 
 519     return { };
 520 }
 521 
<a name="21" id="anc21"></a><span class="line-modified"> 522 ExceptionOr&lt;void&gt; ApplePaySession::begin()</span>
 523 {
 524     if (!canBegin())
 525         return Exception { InvalidAccessError, &quot;Payment session is already active.&quot; };
 526 
 527     if (paymentCoordinator().hasActiveSession())
 528         return Exception { InvalidAccessError, &quot;Page already has an active payment session.&quot; };
 529 
<a name="22" id="anc22"></a><span class="line-modified"> 530     auto&amp; document = *downcast&lt;Document&gt;(scriptExecutionContext());</span>
<span class="line-removed"> 531 </span>
<span class="line-removed"> 532     Vector&lt;URL&gt; linkIconURLs;</span>
<span class="line-removed"> 533     for (auto&amp; icon : LinkIconCollector { document }.iconsOfTypes({ LinkIconType::TouchIcon, LinkIconType::TouchPrecomposedIcon }))</span>
<span class="line-removed"> 534         linkIconURLs.append(icon.url);</span>
<span class="line-removed"> 535 </span>
<span class="line-removed"> 536     if (!paymentCoordinator().beginPaymentSession(*this, document.url(), linkIconURLs, m_paymentRequest))</span>
 537         return Exception { InvalidAccessError, &quot;There is already has an active payment session.&quot; };
 538 
 539     m_state = State::Active;
 540 
 541     setPendingActivity(*this);
 542 
 543     return { };
 544 }
 545 
 546 ExceptionOr&lt;void&gt; ApplePaySession::abort()
 547 {
 548     if (!canAbort())
 549         return Exception { InvalidAccessError };
 550 
 551     m_state = State::Aborted;
 552     paymentCoordinator().abortPaymentSession();
 553 
 554     didReachFinalState();
 555 
 556     return { };
 557 }
 558 
 559 ExceptionOr&lt;void&gt; ApplePaySession::completeMerchantValidation(JSC::ExecState&amp; state, JSC::JSValue merchantSessionValue)
 560 {
 561     if (!canCompleteMerchantValidation())
 562         return Exception { InvalidAccessError };
 563 
 564     if (!merchantSessionValue.isObject())
 565         return Exception { TypeError };
 566 
 567     auto&amp; document = *downcast&lt;Document&gt;(scriptExecutionContext());
 568     auto&amp; window = *document.domWindow();
 569 
 570     String errorMessage;
 571     auto merchantSession = PaymentMerchantSession::fromJS(state, asObject(merchantSessionValue), errorMessage);
 572     if (!merchantSession) {
 573         window.printErrorMessage(errorMessage);
 574         return Exception { InvalidAccessError };
 575     }
 576 
 577     m_merchantValidationState = MerchantValidationState::ValidationComplete;
 578     paymentCoordinator().completeMerchantValidation(*merchantSession);
 579 
 580     return { };
 581 }
 582 
 583 ExceptionOr&lt;void&gt; ApplePaySession::completeShippingMethodSelection(ApplePayShippingMethodUpdate&amp;&amp; update)
 584 {
 585     if (!canCompleteShippingMethodSelection())
 586         return Exception { InvalidAccessError };
 587 
 588     auto convertedUpdate = convertAndValidate(WTFMove(update));
 589     if (convertedUpdate.hasException())
 590         return convertedUpdate.releaseException();
 591 
 592     m_state = State::Active;
 593     paymentCoordinator().completeShippingMethodSelection(convertedUpdate.releaseReturnValue());
 594 
 595     return { };
 596 }
 597 
 598 ExceptionOr&lt;void&gt; ApplePaySession::completeShippingContactSelection(ApplePayShippingContactUpdate&amp;&amp; update)
 599 {
 600     if (!canCompleteShippingContactSelection())
 601         return Exception { InvalidAccessError };
 602 
 603     auto convertedUpdate = convertAndValidate(WTFMove(update));
 604     if (convertedUpdate.hasException())
 605         return convertedUpdate.releaseException();
 606 
 607     m_state = State::Active;
 608     paymentCoordinator().completeShippingContactSelection(convertedUpdate.releaseReturnValue());
 609 
 610     return { };
 611 }
 612 
 613 ExceptionOr&lt;void&gt; ApplePaySession::completePaymentMethodSelection(ApplePayPaymentMethodUpdate&amp;&amp; update)
 614 {
 615     if (!canCompletePaymentMethodSelection())
 616         return Exception { InvalidAccessError };
 617 
 618     auto convertedUpdate = convertAndValidate(WTFMove(update));
 619     if (convertedUpdate.hasException())
 620         return convertedUpdate.releaseException();
 621 
 622     m_state = State::Active;
 623     paymentCoordinator().completePaymentMethodSelection(convertedUpdate.releaseReturnValue());
 624 
 625     return { };
 626 }
 627 
 628 ExceptionOr&lt;void&gt; ApplePaySession::completePayment(ApplePayPaymentAuthorizationResult&amp;&amp; result)
 629 {
 630     if (!canCompletePayment())
 631         return Exception { InvalidAccessError };
 632 
 633     auto convertedResultOrException = convertAndValidate(WTFMove(result));
 634     if (convertedResultOrException.hasException())
 635         return convertedResultOrException.releaseException();
 636 
 637     auto&amp;&amp; convertedResult = convertedResultOrException.releaseReturnValue();
 638     bool isFinalState = isFinalStateResult(convertedResult);
 639 
 640     paymentCoordinator().completePaymentSession(WTFMove(convertedResult));
 641 
 642     if (!isFinalState) {
 643         m_state = State::Active;
 644         return { };
 645     }
 646 
 647     m_state = State::Completed;
 648     unsetPendingActivity(*this);
 649 
 650     return { };
 651 }
 652 
 653 ExceptionOr&lt;void&gt; ApplePaySession::completeShippingMethodSelection(unsigned short status, ApplePayLineItem&amp;&amp; newTotal, Vector&lt;ApplePayLineItem&gt;&amp;&amp; newLineItems)
 654 {
 655     ApplePayShippingMethodUpdate update;
 656 
 657     switch (status) {
 658     case ApplePaySession::STATUS_SUCCESS:
 659         break;
 660 
 661     case ApplePaySession::STATUS_FAILURE:
 662     case ApplePaySession::STATUS_INVALID_BILLING_POSTAL_ADDRESS:
 663     case ApplePaySession::STATUS_INVALID_SHIPPING_POSTAL_ADDRESS:
 664     case ApplePaySession::STATUS_INVALID_SHIPPING_CONTACT:
 665     case ApplePaySession::STATUS_PIN_REQUIRED:
 666     case ApplePaySession::STATUS_PIN_INCORRECT:
 667     case ApplePaySession::STATUS_PIN_LOCKOUT:
 668         // This is a fatal error. Cancel the request.
 669         m_state = State::CancelRequested;
 670         paymentCoordinator().cancelPaymentSession();
 671         return { };
 672 
 673     default:
 674         return Exception { InvalidAccessError };
 675     }
 676 
 677     update.newTotal = WTFMove(newTotal);
 678     update.newLineItems = WTFMove(newLineItems);
 679 
 680     return completeShippingMethodSelection(WTFMove(update));
 681 }
 682 
 683 ExceptionOr&lt;void&gt; ApplePaySession::completeShippingContactSelection(unsigned short status, Vector&lt;ApplePayShippingMethod&gt;&amp;&amp; newShippingMethods, ApplePayLineItem&amp;&amp; newTotal, Vector&lt;ApplePayLineItem&gt;&amp;&amp; newLineItems)
 684 {
 685     ApplePayShippingContactUpdate update;
 686 
 687     Optional&lt;ApplePayError::Code&gt; errorCode;
 688     Optional&lt;ApplePayError::ContactField&gt; contactField;
 689 
 690     switch (status) {
 691     case ApplePaySession::STATUS_SUCCESS:
 692         break;
 693 
 694     case ApplePaySession::STATUS_FAILURE:
 695     case ApplePaySession::STATUS_PIN_REQUIRED:
 696     case ApplePaySession::STATUS_PIN_INCORRECT:
 697     case ApplePaySession::STATUS_PIN_LOCKOUT:
 698         errorCode = ApplePayError::Code::Unknown;
 699         break;
 700 
 701     case ApplePaySession::STATUS_INVALID_BILLING_POSTAL_ADDRESS:
 702         errorCode = ApplePayError::Code::BillingContactInvalid;
 703         break;
 704 
 705     case ApplePaySession::STATUS_INVALID_SHIPPING_POSTAL_ADDRESS:
 706         errorCode = ApplePayError::Code::ShippingContactInvalid;
 707         contactField = ApplePayError::ContactField::PostalAddress;
 708         break;
 709 
 710     case ApplePaySession::STATUS_INVALID_SHIPPING_CONTACT:
 711         errorCode = ApplePayError::Code::ShippingContactInvalid;
 712         break;
 713 
 714     default:
 715         return Exception { InvalidAccessError };
 716     }
 717 
 718     if (errorCode)
 719         update.errors = { ApplePayError::create(*errorCode, contactField, { }) };
 720 
 721     update.newShippingMethods = WTFMove(newShippingMethods);
 722     update.newTotal = WTFMove(newTotal);
 723     update.newLineItems = WTFMove(newLineItems);
 724 
 725     return completeShippingContactSelection(WTFMove(update));
 726 }
 727 
 728 ExceptionOr&lt;void&gt; ApplePaySession::completePaymentMethodSelection(ApplePayLineItem&amp;&amp; newTotal, Vector&lt;ApplePayLineItem&gt;&amp;&amp; newLineItems)
 729 {
 730     ApplePayPaymentMethodUpdate update;
 731 
 732     update.newTotal = WTFMove(newTotal);
 733     update.newLineItems = WTFMove(newLineItems);
 734 
 735     return completePaymentMethodSelection(WTFMove(update));
 736 }
 737 
 738 ExceptionOr&lt;void&gt; ApplePaySession::completePayment(unsigned short status)
 739 {
 740     ApplePayPaymentAuthorizationResult result;
 741     result.status = status;
 742 
 743     return completePayment(WTFMove(result));
 744 }
 745 
 746 unsigned ApplePaySession::version() const
 747 {
 748     return m_version;
 749 }
 750 
 751 void ApplePaySession::validateMerchant(URL&amp;&amp; validationURL)
 752 {
 753     if (m_state == State::Aborted) {
 754         // ApplePaySession::abort has been called.
 755         return;
 756     }
 757 
 758     ASSERT(m_merchantValidationState == MerchantValidationState::Idle);
 759     ASSERT(m_state == State::Active);
 760 
 761     if (validationURL.isNull()) {
 762         // Something went wrong when getting the validation URL.
 763         // FIXME: Maybe we should send an error event here instead?
 764         return;
 765     }
 766 
 767     m_merchantValidationState = MerchantValidationState::ValidatingMerchant;
 768 
 769     auto event = ApplePayValidateMerchantEvent::create(eventNames().validatemerchantEvent, WTFMove(validationURL));
 770     dispatchEvent(event.get());
 771 }
 772 
 773 void ApplePaySession::didAuthorizePayment(const Payment&amp; payment)
 774 {
 775     ASSERT(m_state == State::Active);
 776 
 777     m_state = State::Authorized;
 778 
 779     auto event = ApplePayPaymentAuthorizedEvent::create(eventNames().paymentauthorizedEvent, version(), payment);
 780     dispatchEvent(event.get());
 781 }
 782 
 783 void ApplePaySession::didSelectShippingMethod(const ApplePaySessionPaymentRequest::ShippingMethod&amp; shippingMethod)
 784 {
 785     ASSERT(m_state == State::Active);
 786 
 787     if (!hasEventListeners(eventNames().shippingmethodselectedEvent)) {
 788         paymentCoordinator().completeShippingMethodSelection({ });
 789         return;
 790     }
 791 
 792     m_state = State::ShippingMethodSelected;
 793     auto event = ApplePayShippingMethodSelectedEvent::create(eventNames().shippingmethodselectedEvent, shippingMethod);
 794     dispatchEvent(event.get());
 795 }
 796 
 797 void ApplePaySession::didSelectShippingContact(const PaymentContact&amp; shippingContact)
 798 {
 799     ASSERT(m_state == State::Active);
 800 
 801     if (!hasEventListeners(eventNames().shippingcontactselectedEvent)) {
 802         paymentCoordinator().completeShippingContactSelection({ });
 803         return;
 804     }
 805 
 806     m_state = State::ShippingContactSelected;
 807     auto event = ApplePayShippingContactSelectedEvent::create(eventNames().shippingcontactselectedEvent, version(), shippingContact);
 808     dispatchEvent(event.get());
 809 }
 810 
 811 void ApplePaySession::didSelectPaymentMethod(const PaymentMethod&amp; paymentMethod)
 812 {
 813     ASSERT(m_state == State::Active);
 814 
 815     if (!hasEventListeners(eventNames().paymentmethodselectedEvent)) {
 816         paymentCoordinator().completePaymentMethodSelection({ });
 817         return;
 818     }
 819 
 820     m_state = State::PaymentMethodSelected;
 821     auto event = ApplePayPaymentMethodSelectedEvent::create(eventNames().paymentmethodselectedEvent, paymentMethod);
 822     dispatchEvent(event.get());
 823 }
 824 
 825 void ApplePaySession::didCancelPaymentSession()
 826 {
 827     ASSERT(canCancel());
 828 
 829     m_state = State::Canceled;
 830 
 831     auto event = Event::create(eventNames().cancelEvent, Event::CanBubble::No, Event::IsCancelable::No);
 832     dispatchEvent(event.get());
 833 
 834     didReachFinalState();
 835 }
 836 
 837 const char* ApplePaySession::activeDOMObjectName() const
 838 {
 839     return &quot;ApplePaySession&quot;;
 840 }
 841 
 842 bool ApplePaySession::canSuspendForDocumentSuspension() const
 843 {
 844     switch (m_state) {
 845     case State::Idle:
 846     case State::Aborted:
 847     case State::Completed:
 848     case State::Canceled:
 849         return true;
 850 
 851     case State::Active:
 852     case State::Authorized:
 853     case State::ShippingMethodSelected:
 854     case State::ShippingContactSelected:
 855     case State::PaymentMethodSelected:
 856     case State::CancelRequested:
 857         return false;
 858     }
 859 }
 860 
 861 void ApplePaySession::stop()
 862 {
 863     if (!canAbort())
 864         return;
 865 
 866     m_state = State::Aborted;
 867     paymentCoordinator().abortPaymentSession();
 868 
 869     didReachFinalState();
 870 }
 871 
 872 PaymentCoordinator&amp; ApplePaySession::paymentCoordinator() const
 873 {
 874     return downcast&lt;Document&gt;(*scriptExecutionContext()).page()-&gt;paymentCoordinator();
 875 }
 876 
 877 bool ApplePaySession::canBegin() const
 878 {
 879     switch (m_state) {
 880     case State::Idle:
 881         return true;
 882 
 883     case State::Active:
 884     case State::Aborted:
 885     case State::Authorized:
 886     case State::Completed:
 887     case State::Canceled:
 888     case State::ShippingMethodSelected:
 889     case State::ShippingContactSelected:
 890     case State::PaymentMethodSelected:
 891     case State::CancelRequested:
 892         return false;
 893     }
 894 }
 895 
 896 bool ApplePaySession::canAbort() const
 897 {
 898     switch (m_state) {
 899     case State::Idle:
 900     case State::Aborted:
 901     case State::Completed:
 902     case State::Canceled:
 903         return false;
 904 
 905     case State::Active:
 906     case State::Authorized:
 907     case State::ShippingMethodSelected:
 908     case State::ShippingContactSelected:
 909     case State::PaymentMethodSelected:
 910     case State::CancelRequested:
 911         return true;
 912     }
 913 }
 914 
 915 bool ApplePaySession::canCancel() const
 916 {
 917     switch (m_state) {
 918     case State::Idle:
 919     case State::Aborted:
 920     case State::Completed:
 921     case State::Canceled:
 922         return false;
 923 
 924     case State::Active:
 925     case State::Authorized:
 926     case State::ShippingMethodSelected:
 927     case State::ShippingContactSelected:
 928     case State::PaymentMethodSelected:
 929     case State::CancelRequested:
 930         return true;
 931     }
 932 }
 933 
 934 bool ApplePaySession::canCompleteMerchantValidation() const
 935 {
 936     if (m_state != State::Active)
 937         return false;
 938 
 939     if (m_merchantValidationState != MerchantValidationState::ValidatingMerchant)
 940         return false;
 941 
 942     return true;
 943 }
 944 
 945 bool ApplePaySession::canCompleteShippingMethodSelection() const
 946 {
 947     switch (m_state) {
 948     case State::Idle:
 949     case State::Aborted:
 950     case State::Active:
 951     case State::Completed:
 952     case State::Canceled:
 953     case State::Authorized:
 954     case State::PaymentMethodSelected:
 955     case State::ShippingContactSelected:
 956     case State::CancelRequested:
 957         return false;
 958 
 959     case State::ShippingMethodSelected:
 960         return true;
 961     }
 962 }
 963 
 964 bool ApplePaySession::canCompleteShippingContactSelection() const
 965 {
 966     switch (m_state) {
 967     case State::Idle:
 968     case State::Aborted:
 969     case State::Active:
 970     case State::Completed:
 971     case State::Canceled:
 972     case State::Authorized:
 973     case State::PaymentMethodSelected:
 974     case State::ShippingMethodSelected:
 975     case State::CancelRequested:
 976         return false;
 977 
 978     case State::ShippingContactSelected:
 979         return true;
 980     }
 981 }
 982 
 983 bool ApplePaySession::canCompletePaymentMethodSelection() const
 984 {
 985     switch (m_state) {
 986     case State::Idle:
 987     case State::Aborted:
 988     case State::Active:
 989     case State::Completed:
 990     case State::Canceled:
 991     case State::Authorized:
 992     case State::ShippingMethodSelected:
 993     case State::ShippingContactSelected:
 994     case State::CancelRequested:
 995         return false;
 996 
 997     case State::PaymentMethodSelected:
 998         return true;
 999     }
1000 }
1001 
1002 bool ApplePaySession::canCompletePayment() const
1003 {
1004     switch (m_state) {
1005     case State::Idle:
1006     case State::Aborted:
1007     case State::Active:
1008     case State::Completed:
1009     case State::Canceled:
1010     case State::ShippingMethodSelected:
1011     case State::ShippingContactSelected:
1012     case State::PaymentMethodSelected:
1013     case State::CancelRequested:
1014         return false;
1015 
1016     case State::Authorized:
1017         return true;
1018     }
1019 }
1020 
1021 bool ApplePaySession::isFinalState() const
1022 {
1023     switch (m_state) {
1024     case State::Idle:
1025     case State::Active:
1026     case State::ShippingMethodSelected:
1027     case State::ShippingContactSelected:
1028     case State::PaymentMethodSelected:
1029     case State::Authorized:
1030     case State::CancelRequested:
1031         return false;
1032 
1033     case State::Completed:
1034     case State::Aborted:
1035     case State::Canceled:
1036         return true;
1037     }
1038 }
1039 
1040 void ApplePaySession::didReachFinalState()
1041 {
1042     ASSERT(isFinalState());
1043     unsetPendingActivity(*this);
1044 }
1045 
1046 }
1047 
1048 #endif
<a name="23" id="anc23"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="23" type="hidden" />
</body>
</html>