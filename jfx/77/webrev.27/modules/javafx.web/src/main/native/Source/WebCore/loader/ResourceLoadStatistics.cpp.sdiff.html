<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff modules/javafx.web/src/main/native/Source/WebCore/loader/ResourceLoadStatistics.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="ResourceLoadObserver.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="ResourceLoadStatistics.h.sdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/loader/ResourceLoadStatistics.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 20  * PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY
 21  * OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 22  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 23  * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 24  */
 25 
 26 #include &quot;config.h&quot;
 27 #include &quot;ResourceLoadStatistics.h&quot;
 28 
 29 #include &quot;KeyedCoding.h&quot;
 30 #include &quot;PublicSuffix.h&quot;
 31 #include &lt;wtf/MainThread.h&gt;
 32 #include &lt;wtf/text/ASCIILiteral.h&gt;
 33 #include &lt;wtf/text/StringBuilder.h&gt;
 34 #include &lt;wtf/text/StringHash.h&gt;
 35 
 36 namespace WebCore {
 37 
 38 static Seconds timestampResolution { 5_s };
 39 
<span class="line-modified"> 40 typedef WTF::HashMap&lt;String, unsigned, StringHash, HashTraits&lt;String&gt;, HashTraits&lt;unsigned&gt;&gt;::KeyValuePairType ResourceLoadStatisticsValue;</span>
 41 
<span class="line-modified"> 42 static void encodeHashCountedSet(KeyedEncoder&amp; encoder, const String&amp; label, const HashCountedSet&lt;String&gt;&amp; hashCountedSet)</span>
<span class="line-removed"> 43 {</span>
<span class="line-removed"> 44     if (hashCountedSet.isEmpty())</span>
<span class="line-removed"> 45         return;</span>
<span class="line-removed"> 46 </span>
<span class="line-removed"> 47     encoder.encodeObjects(label, hashCountedSet.begin(), hashCountedSet.end(), [](KeyedEncoder&amp; encoderInner, const ResourceLoadStatisticsValue&amp; origin) {</span>
<span class="line-removed"> 48         encoderInner.encodeString(&quot;origin&quot;, origin.key);</span>
<span class="line-removed"> 49         encoderInner.encodeUInt32(&quot;count&quot;, origin.value);</span>
<span class="line-removed"> 50     });</span>
<span class="line-removed"> 51 }</span>
<span class="line-removed"> 52 </span>
<span class="line-removed"> 53 static void encodeHashSet(KeyedEncoder&amp; encoder, const String&amp; label,  const String&amp; key, const HashSet&lt;String&gt;&amp; hashSet)</span>
 54 {
 55     if (hashSet.isEmpty())
 56         return;
 57 
<span class="line-modified"> 58     encoder.encodeObjects(label, hashSet.begin(), hashSet.end(), [&amp;key](KeyedEncoder&amp; encoderInner, const String&amp; origin) {</span>
<span class="line-modified"> 59         encoderInner.encodeString(key, origin);</span>
 60     });
 61 }
 62 
<span class="line-removed"> 63 static void encodeOriginHashSet(KeyedEncoder&amp; encoder, const String&amp; label, const HashSet&lt;String&gt;&amp; hashSet)</span>
<span class="line-removed"> 64 {</span>
<span class="line-removed"> 65     encodeHashSet(encoder, label, &quot;origin&quot;, hashSet);</span>
<span class="line-removed"> 66 }</span>
<span class="line-removed"> 67 </span>
 68 template&lt;typename T&gt;
 69 static void encodeOptionSet(KeyedEncoder&amp; encoder, const String&amp; label, const OptionSet&lt;T&gt;&amp; optionSet)
 70 {
 71     if (optionSet.isEmpty())
 72         return;
 73 
 74     uint64_t optionSetBitMask = optionSet.toRaw();
 75     encoder.encodeUInt64(label, optionSetBitMask);
 76 }
 77 
 78 #if ENABLE(WEB_API_STATISTICS)
 79 static void encodeFontHashSet(KeyedEncoder&amp; encoder, const String&amp; label, const HashSet&lt;String&gt;&amp; hashSet)
 80 {
 81     encodeHashSet(encoder, label, &quot;font&quot;, hashSet);
 82 }
 83 
 84 static void encodeCanvasActivityRecord(KeyedEncoder&amp; encoder, const String&amp; label, const CanvasActivityRecord&amp; canvasActivityRecord)
 85 {
 86     encoder.encodeObject(label, canvasActivityRecord, [] (KeyedEncoder&amp; encoderInner, const CanvasActivityRecord&amp; canvasActivityRecord) {
 87         encoderInner.encodeBool(&quot;wasDataRead&quot;, canvasActivityRecord.wasDataRead);
 88         encoderInner.encodeObjects(&quot;textWritten&quot;, canvasActivityRecord.textWritten.begin(), canvasActivityRecord.textWritten.end(), [] (KeyedEncoder&amp; encoderInner2, const String&amp; text) {
 89             encoderInner2.encodeString(&quot;text&quot;, text);
 90         });
 91     });
 92 }
 93 #endif
 94 
 95 void ResourceLoadStatistics::encode(KeyedEncoder&amp; encoder) const
 96 {
<span class="line-modified"> 97     encoder.encodeString(&quot;PrevalentResourceOrigin&quot;, highLevelDomain);</span>
 98 
<span class="line-modified"> 99     encoder.encodeDouble(&quot;lastSeen&quot;, lastSeen.secondsSinceEpoch().value());</span>
100 
101     // User interaction
<span class="line-modified">102     encoder.encodeBool(&quot;hadUserInteraction&quot;, hadUserInteraction);</span>
<span class="line-modified">103     encoder.encodeDouble(&quot;mostRecentUserInteraction&quot;, mostRecentUserInteractionTime.secondsSinceEpoch().value());</span>
<span class="line-modified">104     encoder.encodeBool(&quot;grandfathered&quot;, grandfathered);</span>
105 
106     // Storage access
<span class="line-modified">107     encodeOriginHashSet(encoder, &quot;storageAccessUnderTopFrameOrigins&quot;, storageAccessUnderTopFrameOrigins);</span>
108 
109     // Top frame stats
<span class="line-modified">110     encodeHashCountedSet(encoder, &quot;topFrameUniqueRedirectsTo&quot;, topFrameUniqueRedirectsTo);</span>
<span class="line-modified">111     encodeHashCountedSet(encoder, &quot;topFrameUniqueRedirectsFrom&quot;, topFrameUniqueRedirectsFrom);</span>


112 
113     // Subframe stats
<span class="line-modified">114     encodeHashCountedSet(encoder, &quot;subframeUnderTopFrameOrigins&quot;, subframeUnderTopFrameOrigins);</span>
115 
116     // Subresource stats
<span class="line-modified">117     encodeHashCountedSet(encoder, &quot;subresourceUnderTopFrameOrigins&quot;, subresourceUnderTopFrameOrigins);</span>
<span class="line-modified">118     encodeHashCountedSet(encoder, &quot;subresourceUniqueRedirectsTo&quot;, subresourceUniqueRedirectsTo);</span>
<span class="line-modified">119     encodeHashCountedSet(encoder, &quot;subresourceUniqueRedirectsFrom&quot;, subresourceUniqueRedirectsFrom);</span>
120 
121     // Prevalent Resource
<span class="line-modified">122     encoder.encodeBool(&quot;isPrevalentResource&quot;, isPrevalentResource);</span>
<span class="line-modified">123     encoder.encodeBool(&quot;isVeryPrevalentResource&quot;, isVeryPrevalentResource);</span>
<span class="line-modified">124     encoder.encodeUInt32(&quot;dataRecordsRemoved&quot;, dataRecordsRemoved);</span>
125 
<span class="line-modified">126     encoder.encodeUInt32(&quot;timesAccessedAsFirstPartyDueToUserInteraction&quot;, timesAccessedAsFirstPartyDueToUserInteraction);</span>
<span class="line-modified">127     encoder.encodeUInt32(&quot;timesAccessedAsFirstPartyDueToStorageAccessAPI&quot;, timesAccessedAsFirstPartyDueToStorageAccessAPI);</span>
128 
129 #if ENABLE(WEB_API_STATISTICS)
130     encodeFontHashSet(encoder, &quot;fontsFailedToLoad&quot;, fontsFailedToLoad);
131     encodeFontHashSet(encoder, &quot;fontsSuccessfullyLoaded&quot;, fontsSuccessfullyLoaded);
132     encodeHashCountedSet(encoder, &quot;topFrameRegistrableDomainsWhichAccessedWebAPIs&quot;, topFrameRegistrableDomainsWhichAccessedWebAPIs);
133     encodeCanvasActivityRecord(encoder, &quot;canvasActivityRecord&quot;, canvasActivityRecord);
134     encodeOptionSet(encoder, &quot;navigatorFunctionsAccessedBitMask&quot;, navigatorFunctionsAccessed);
135     encodeOptionSet(encoder, &quot;screenFunctionsAccessedBitMask&quot;, screenFunctionsAccessed);
136 #endif
137 }
138 
<span class="line-modified">139 static void decodeHashCountedSet(KeyedDecoder&amp; decoder, const String&amp; label, HashCountedSet&lt;String&gt;&amp; hashCountedSet)</span>
140 {
141     Vector&lt;String&gt; ignore;
<span class="line-modified">142     decoder.decodeObjects(label, ignore, [&amp;hashCountedSet](KeyedDecoder&amp; decoderInner, String&amp; origin) {</span>
<span class="line-modified">143         if (!decoderInner.decodeString(&quot;origin&quot;, origin))</span>
144             return false;
145 
146         unsigned count;
147         if (!decoderInner.decodeUInt32(&quot;count&quot;, count))
148             return false;
149 
<span class="line-modified">150         hashCountedSet.add(origin, count);</span>
151         return true;
152     });
153 }
154 
<span class="line-modified">155 static void decodeHashSet(KeyedDecoder&amp; decoder, const String&amp; label, const String&amp; key, HashSet&lt;String&gt;&amp; hashSet)</span>
156 {
157     Vector&lt;String&gt; ignore;
<span class="line-modified">158     decoder.decodeObjects(label, ignore, [&amp;hashSet, &amp;key](KeyedDecoder&amp; decoderInner, String&amp; origin) {</span>
<span class="line-modified">159         if (!decoderInner.decodeString(key, origin))</span>
160             return false;
161 
<span class="line-modified">162         hashSet.add(origin);</span>
163         return true;
164     });
165 }
166 
<span class="line-removed">167 static void decodeOriginHashSet(KeyedDecoder&amp; decoder, const String&amp; label, HashSet&lt;String&gt;&amp; hashSet)</span>
<span class="line-removed">168 {</span>
<span class="line-removed">169     decodeHashSet(decoder, label, &quot;origin&quot;, hashSet);</span>
<span class="line-removed">170 }</span>
<span class="line-removed">171 </span>
172 template&lt;typename T&gt;
173 static void decodeOptionSet(KeyedDecoder&amp; decoder, const String&amp; label, OptionSet&lt;T&gt;&amp; optionSet)
174 {
175     uint64_t optionSetBitMask = 0;
176     decoder.decodeUInt64(label, optionSetBitMask);
177     optionSet = OptionSet&lt;T&gt;::fromRaw(optionSetBitMask);
178 }
179 
180 #if ENABLE(WEB_API_STATISTICS)
181 static void decodeFontHashSet(KeyedDecoder&amp; decoder, const String&amp; label, HashSet&lt;String&gt;&amp; hashSet)
182 {
183     decodeHashSet(decoder, label, &quot;font&quot;, hashSet);
184 }
185 
186 static void decodeCanvasActivityRecord(KeyedDecoder&amp; decoder, const String&amp; label, CanvasActivityRecord&amp; canvasActivityRecord)
187 {
188     decoder.decodeObject(label, canvasActivityRecord, [] (KeyedDecoder&amp; decoderInner, CanvasActivityRecord&amp; canvasActivityRecord) {
189         if (!decoderInner.decodeBool(&quot;wasDataRead&quot;, canvasActivityRecord.wasDataRead))
190             return false;
191         Vector&lt;String&gt; ignore;
192         decoderInner.decodeObjects(&quot;textWritten&quot;, ignore, [&amp;canvasActivityRecord] (KeyedDecoder&amp; decoderInner2, String&amp; text) {
193             if (!decoderInner2.decodeString(&quot;text&quot;, text))
194                 return false;
195             canvasActivityRecord.textWritten.add(text);
196             return true;
197         });
198         return true;
199     });
200 }
201 #endif
202 
203 bool ResourceLoadStatistics::decode(KeyedDecoder&amp; decoder, unsigned modelVersion)
204 {
<span class="line-modified">205     if (!decoder.decodeString(&quot;PrevalentResourceOrigin&quot;, highLevelDomain))</span>
<span class="line-modified">206         return false;</span>







207 
208     // User interaction
209     if (!decoder.decodeBool(&quot;hadUserInteraction&quot;, hadUserInteraction))
210         return false;
211 
212     // Storage access
<span class="line-modified">213     decodeOriginHashSet(decoder, &quot;storageAccessUnderTopFrameOrigins&quot;, storageAccessUnderTopFrameOrigins);</span>



214 
215     // Top frame stats
<span class="line-modified">216     if (modelVersion &gt;= 11) {</span>
<span class="line-modified">217         decodeHashCountedSet(decoder, &quot;topFrameUniqueRedirectsTo&quot;, topFrameUniqueRedirectsTo);</span>
<span class="line-modified">218         decodeHashCountedSet(decoder, &quot;topFrameUniqueRedirectsFrom&quot;, topFrameUniqueRedirectsFrom);</span>
















219     }
220 
221     // Subframe stats
<span class="line-modified">222     if (modelVersion &gt;= 14)</span>
<span class="line-modified">223         decodeHashCountedSet(decoder, &quot;subframeUnderTopFrameOrigins&quot;, subframeUnderTopFrameOrigins);</span>






224 
225     // Subresource stats
<span class="line-modified">226     decodeHashCountedSet(decoder, &quot;subresourceUnderTopFrameOrigins&quot;, subresourceUnderTopFrameOrigins);</span>
<span class="line-modified">227     decodeHashCountedSet(decoder, &quot;subresourceUniqueRedirectsTo&quot;, subresourceUniqueRedirectsTo);</span>
<span class="line-modified">228     if (modelVersion &gt;= 11)</span>
<span class="line-modified">229         decodeHashCountedSet(decoder, &quot;subresourceUniqueRedirectsFrom&quot;, subresourceUniqueRedirectsFrom);</span>


















230 
231     // Prevalent Resource
232     if (!decoder.decodeBool(&quot;isPrevalentResource&quot;, isPrevalentResource))
233         return false;
234 
235     if (modelVersion &gt;= 12) {
236         if (!decoder.decodeBool(&quot;isVeryPrevalentResource&quot;, isVeryPrevalentResource))
237             return false;
238     }
239 
240     // Trigger re-classification based on model 14.
241     if (modelVersion &lt; 14) {
242         isPrevalentResource = false;
243         isVeryPrevalentResource = false;
244     }
245 
246     if (!decoder.decodeUInt32(&quot;dataRecordsRemoved&quot;, dataRecordsRemoved))
247         return false;
248 
249     double mostRecentUserInteractionTimeAsDouble;
</pre>
<hr />
<pre>
271         decodeFontHashSet(decoder, &quot;fontsFailedToLoad&quot;, fontsFailedToLoad);
272         decodeFontHashSet(decoder, &quot;fontsSuccessfullyLoaded&quot;, fontsSuccessfullyLoaded);
273         decodeHashCountedSet(decoder, &quot;topFrameRegistrableDomainsWhichAccessedWebAPIs&quot;, topFrameRegistrableDomainsWhichAccessedWebAPIs);
274         decodeCanvasActivityRecord(decoder, &quot;canvasActivityRecord&quot;, canvasActivityRecord);
275         decodeOptionSet(decoder, &quot;navigatorFunctionsAccessedBitMask&quot;, navigatorFunctionsAccessed);
276         decodeOptionSet(decoder, &quot;screenFunctionsAccessedBitMask&quot;, screenFunctionsAccessed);
277     }
278 #endif
279 
280     return true;
281 }
282 
283 static void appendBoolean(StringBuilder&amp; builder, const String&amp; label, bool flag)
284 {
285     builder.appendLiteral(&quot;    &quot;);
286     builder.append(label);
287     builder.appendLiteral(&quot;: &quot;);
288     builder.append(flag ? &quot;Yes&quot; : &quot;No&quot;);
289 }
290 
<span class="line-modified">291 static void appendHashCountedSet(StringBuilder&amp; builder, const String&amp; label, const HashCountedSet&lt;String&gt;&amp; hashCountedSet)</span>
<span class="line-removed">292 {</span>
<span class="line-removed">293     if (hashCountedSet.isEmpty())</span>
<span class="line-removed">294         return;</span>
<span class="line-removed">295 </span>
<span class="line-removed">296     builder.appendLiteral(&quot;    &quot;);</span>
<span class="line-removed">297     builder.append(label);</span>
<span class="line-removed">298     builder.appendLiteral(&quot;:\n&quot;);</span>
<span class="line-removed">299 </span>
<span class="line-removed">300     for (auto&amp; entry : hashCountedSet) {</span>
<span class="line-removed">301         builder.appendLiteral(&quot;        &quot;);</span>
<span class="line-removed">302         builder.append(entry.key);</span>
<span class="line-removed">303         builder.appendLiteral(&quot;: &quot;);</span>
<span class="line-removed">304         builder.appendNumber(entry.value);</span>
<span class="line-removed">305         builder.append(&#39;\n&#39;);</span>
<span class="line-removed">306     }</span>
<span class="line-removed">307 }</span>
<span class="line-removed">308 </span>
<span class="line-removed">309 static void appendHashSet(StringBuilder&amp; builder, const String&amp; label, const HashSet&lt;String&gt;&amp; hashSet)</span>
310 {
311     if (hashSet.isEmpty())
312         return;
313 
314     builder.appendLiteral(&quot;    &quot;);
315     builder.append(label);
316     builder.appendLiteral(&quot;:\n&quot;);
317 
318     for (auto&amp; entry : hashSet) {
319         builder.appendLiteral(&quot;        &quot;);
<span class="line-modified">320         builder.append(entry);</span>
321         builder.append(&#39;\n&#39;);
322     }
323 }
324 
325 #if ENABLE(WEB_API_STATISTICS)
326 static ASCIILiteral navigatorAPIEnumToString(ResourceLoadStatistics::NavigatorAPI navigatorEnum)
327 {
328     switch (navigatorEnum) {
329     case ResourceLoadStatistics::NavigatorAPI::JavaEnabled:
330         return &quot;javaEnabled&quot;_s;
331     case ResourceLoadStatistics::NavigatorAPI::MimeTypes:
332         return &quot;mimeTypes&quot;_s;
333     case ResourceLoadStatistics::NavigatorAPI::CookieEnabled:
334         return &quot;cookieEnabled&quot;_s;
335     case ResourceLoadStatistics::NavigatorAPI::Plugins:
336         return &quot;plugins&quot;_s;
337     case ResourceLoadStatistics::NavigatorAPI::UserAgent:
338         return &quot;userAgent&quot;_s;
339     case ResourceLoadStatistics::NavigatorAPI::AppVersion:
340         return &quot;appVersion&quot;_s;
</pre>
<hr />
<pre>
378         builder.append(&#39;\n&#39;);
379     }
380 }
381 
382 static void appendScreenAPIOptionSet(StringBuilder&amp; builder, const OptionSet&lt;ResourceLoadStatistics::ScreenAPI&gt;&amp; optionSet)
383 {
384     if (optionSet.isEmpty())
385         return;
386     builder.appendLiteral(&quot;    screenFunctionsAccessed:\n&quot;);
387     for (auto screenAPI : optionSet) {
388         builder.appendLiteral(&quot;        &quot;);
389         builder.append(screenAPIEnumToString(screenAPI).characters());
390         builder.append(&#39;\n&#39;);
391     }
392 }
393 #endif
394 
395 String ResourceLoadStatistics::toString() const
396 {
397     StringBuilder builder;
<span class="line-modified">398     builder.appendLiteral(&quot;High level domain: &quot;);</span>
<span class="line-modified">399     builder.append(highLevelDomain);</span>
400     builder.append(&#39;\n&#39;);
401     builder.appendLiteral(&quot;    lastSeen: &quot;);
<span class="line-modified">402     builder.appendNumber(lastSeen.secondsSinceEpoch().value());</span>
403     builder.append(&#39;\n&#39;);
404 
405     // User interaction
406     appendBoolean(builder, &quot;hadUserInteraction&quot;, hadUserInteraction);
407     builder.append(&#39;\n&#39;);
408     builder.appendLiteral(&quot;    mostRecentUserInteraction: &quot;);
<span class="line-modified">409     builder.appendNumber(mostRecentUserInteractionTime.secondsSinceEpoch().value());</span>
410     builder.append(&#39;\n&#39;);
411     appendBoolean(builder, &quot;grandfathered&quot;, grandfathered);
412     builder.append(&#39;\n&#39;);
413 
414     // Storage access
<span class="line-modified">415     appendHashSet(builder, &quot;storageAccessUnderTopFrameOrigins&quot;, storageAccessUnderTopFrameOrigins);</span>
416 
417     // Top frame stats
<span class="line-modified">418     appendHashCountedSet(builder, &quot;topFrameUniqueRedirectsTo&quot;, topFrameUniqueRedirectsTo);</span>
<span class="line-modified">419     appendHashCountedSet(builder, &quot;topFrameUniqueRedirectsFrom&quot;, topFrameUniqueRedirectsFrom);</span>


420 
421     // Subframe stats
<span class="line-modified">422     appendHashCountedSet(builder, &quot;subframeUnderTopFrameOrigins&quot;, subframeUnderTopFrameOrigins);</span>
423 
424     // Subresource stats
<span class="line-modified">425     appendHashCountedSet(builder, &quot;subresourceUnderTopFrameOrigins&quot;, subresourceUnderTopFrameOrigins);</span>
<span class="line-modified">426     appendHashCountedSet(builder, &quot;subresourceUniqueRedirectsTo&quot;, subresourceUniqueRedirectsTo);</span>
<span class="line-modified">427     appendHashCountedSet(builder, &quot;subresourceUniqueRedirectsFrom&quot;, subresourceUniqueRedirectsFrom);</span>
428 
429     // Prevalent Resource
430     appendBoolean(builder, &quot;isPrevalentResource&quot;, isPrevalentResource);
431     builder.append(&#39;\n&#39;);
432     appendBoolean(builder, &quot;isVeryPrevalentResource&quot;, isVeryPrevalentResource);
433     builder.append(&#39;\n&#39;);
434     builder.appendLiteral(&quot;    dataRecordsRemoved: &quot;);
435     builder.appendNumber(dataRecordsRemoved);
436     builder.append(&#39;\n&#39;);
437 
438 #if ENABLE(WEB_API_STATISTICS)
439     appendHashSet(builder, &quot;fontsFailedToLoad&quot;, fontsFailedToLoad);
440     appendHashSet(builder, &quot;fontsSuccessfullyLoaded&quot;, fontsSuccessfullyLoaded);
441     appendHashCountedSet(builder, &quot;topFrameRegistrableDomainsWhichAccessedWebAPIs&quot;, topFrameRegistrableDomainsWhichAccessedWebAPIs);
442     appendNavigatorAPIOptionSet(builder, navigatorFunctionsAccessed);
443     appendScreenAPIOptionSet(builder, screenFunctionsAccessed);
444     appendHashSet(builder, &quot;canvasTextWritten&quot;, canvasActivityRecord.textWritten);
445     appendBoolean(builder, &quot;canvasReadData&quot;, canvasActivityRecord.wasDataRead);
446     builder.append(&#39;\n&#39;);
447     builder.append(&#39;\n&#39;);
</pre>
<hr />
<pre>
449 
450     return builder.toString();
451 }
452 
453 template &lt;typename T&gt;
454 static void mergeHashCountedSet(HashCountedSet&lt;T&gt;&amp; to, const HashCountedSet&lt;T&gt;&amp; from)
455 {
456     for (auto&amp; entry : from)
457         to.add(entry.key, entry.value);
458 }
459 
460 template &lt;typename T&gt;
461 static void mergeHashSet(HashSet&lt;T&gt;&amp; to, const HashSet&lt;T&gt;&amp; from)
462 {
463     for (auto&amp; entry : from)
464         to.add(entry);
465 }
466 
467 void ResourceLoadStatistics::merge(const ResourceLoadStatistics&amp; other)
468 {
<span class="line-modified">469     ASSERT(other.highLevelDomain == highLevelDomain);</span>
470 
471     if (lastSeen &lt; other.lastSeen)
472         lastSeen = other.lastSeen;
473 
474     if (!other.hadUserInteraction) {
475         // If user interaction has been reset do so here too.
476         // Else, do nothing.
477         if (!other.mostRecentUserInteractionTime) {
478             hadUserInteraction = false;
479             mostRecentUserInteractionTime = { };
480         }
481     } else {
482         hadUserInteraction = true;
483         if (mostRecentUserInteractionTime &lt; other.mostRecentUserInteractionTime)
484             mostRecentUserInteractionTime = other.mostRecentUserInteractionTime;
485     }
486     grandfathered |= other.grandfathered;
487 
488     // Storage access
<span class="line-modified">489     mergeHashSet(storageAccessUnderTopFrameOrigins, other.storageAccessUnderTopFrameOrigins);</span>
490 
491     // Top frame stats
<span class="line-modified">492     mergeHashCountedSet(topFrameUniqueRedirectsTo, other.topFrameUniqueRedirectsTo);</span>
<span class="line-modified">493     mergeHashCountedSet(topFrameUniqueRedirectsFrom, other.topFrameUniqueRedirectsFrom);</span>


494 
495     // Subframe stats
<span class="line-modified">496     mergeHashCountedSet(subframeUnderTopFrameOrigins, other.subframeUnderTopFrameOrigins);</span>
497 
498     // Subresource stats
<span class="line-modified">499     mergeHashCountedSet(subresourceUnderTopFrameOrigins, other.subresourceUnderTopFrameOrigins);</span>
<span class="line-modified">500     mergeHashCountedSet(subresourceUniqueRedirectsTo, other.subresourceUniqueRedirectsTo);</span>
<span class="line-modified">501     mergeHashCountedSet(subresourceUniqueRedirectsFrom, other.subresourceUniqueRedirectsFrom);</span>
502 
503     // Prevalent resource stats
504     isPrevalentResource |= other.isPrevalentResource;
505     isVeryPrevalentResource |= other.isVeryPrevalentResource;
506     dataRecordsRemoved = std::max(dataRecordsRemoved, other.dataRecordsRemoved);
507 
508 #if ENABLE(WEB_API_STATISTICS)
509     mergeHashSet(fontsFailedToLoad, other.fontsFailedToLoad);
510     mergeHashSet(fontsSuccessfullyLoaded, other.fontsSuccessfullyLoaded);
<span class="line-modified">511     mergeHashCountedSet(topFrameRegistrableDomainsWhichAccessedWebAPIs, other.topFrameRegistrableDomainsWhichAccessedWebAPIs);</span>
512     canvasActivityRecord.mergeWith(other.canvasActivityRecord);
513     navigatorFunctionsAccessed.add(other.navigatorFunctionsAccessed);
514     screenFunctionsAccessed.add(other.screenFunctionsAccessed);
515 #endif
516 }
517 
<span class="line-removed">518 String ResourceLoadStatistics::primaryDomain(const URL&amp; url)</span>
<span class="line-removed">519 {</span>
<span class="line-removed">520     return primaryDomain(url.host());</span>
<span class="line-removed">521 }</span>
<span class="line-removed">522 </span>
<span class="line-removed">523 String ResourceLoadStatistics::primaryDomain(StringView host)</span>
<span class="line-removed">524 {</span>
<span class="line-removed">525     if (host.isNull() || host.isEmpty())</span>
<span class="line-removed">526         return &quot;nullOrigin&quot;_s;</span>
<span class="line-removed">527 </span>
<span class="line-removed">528     String hostString = host.toString();</span>
<span class="line-removed">529 #if ENABLE(PUBLIC_SUFFIX_LIST)</span>
<span class="line-removed">530     String primaryDomain = topPrivatelyControlledDomain(hostString);</span>
<span class="line-removed">531     // We will have an empty string here if there is no TLD. Use the host as a fallback.</span>
<span class="line-removed">532     if (!primaryDomain.isEmpty())</span>
<span class="line-removed">533         return primaryDomain;</span>
<span class="line-removed">534 #endif</span>
<span class="line-removed">535 </span>
<span class="line-removed">536     return hostString;</span>
<span class="line-removed">537 }</span>
<span class="line-removed">538 </span>
539 WallTime ResourceLoadStatistics::reduceTimeResolution(WallTime time)
540 {
541     return WallTime::fromRawSeconds(std::floor(time.secondsSinceEpoch() / timestampResolution) * timestampResolution.seconds());
542 }
543 
544 }
</pre>
</td>
<td>
<hr />
<pre>
 20  * PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY
 21  * OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 22  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 23  * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 24  */
 25 
 26 #include &quot;config.h&quot;
 27 #include &quot;ResourceLoadStatistics.h&quot;
 28 
 29 #include &quot;KeyedCoding.h&quot;
 30 #include &quot;PublicSuffix.h&quot;
 31 #include &lt;wtf/MainThread.h&gt;
 32 #include &lt;wtf/text/ASCIILiteral.h&gt;
 33 #include &lt;wtf/text/StringBuilder.h&gt;
 34 #include &lt;wtf/text/StringHash.h&gt;
 35 
 36 namespace WebCore {
 37 
 38 static Seconds timestampResolution { 5_s };
 39 
<span class="line-modified"> 40 typedef WTF::HashMap&lt;RegistrableDomain, unsigned, RegistrableDomain::RegistrableDomainHash, HashTraits&lt;RegistrableDomain&gt;, HashTraits&lt;unsigned&gt;&gt;::KeyValuePairType ResourceLoadStatisticsValue;</span>
 41 
<span class="line-modified"> 42 static void encodeHashSet(KeyedEncoder&amp; encoder, const String&amp; label,  const String&amp; key, const HashSet&lt;RegistrableDomain&gt;&amp; hashSet)</span>











 43 {
 44     if (hashSet.isEmpty())
 45         return;
 46 
<span class="line-modified"> 47     encoder.encodeObjects(label, hashSet.begin(), hashSet.end(), [&amp;key](KeyedEncoder&amp; encoderInner, const RegistrableDomain&amp; domain) {</span>
<span class="line-modified"> 48         encoderInner.encodeString(key, domain.string());</span>
 49     });
 50 }
 51 





 52 template&lt;typename T&gt;
 53 static void encodeOptionSet(KeyedEncoder&amp; encoder, const String&amp; label, const OptionSet&lt;T&gt;&amp; optionSet)
 54 {
 55     if (optionSet.isEmpty())
 56         return;
 57 
 58     uint64_t optionSetBitMask = optionSet.toRaw();
 59     encoder.encodeUInt64(label, optionSetBitMask);
 60 }
 61 
 62 #if ENABLE(WEB_API_STATISTICS)
 63 static void encodeFontHashSet(KeyedEncoder&amp; encoder, const String&amp; label, const HashSet&lt;String&gt;&amp; hashSet)
 64 {
 65     encodeHashSet(encoder, label, &quot;font&quot;, hashSet);
 66 }
 67 
 68 static void encodeCanvasActivityRecord(KeyedEncoder&amp; encoder, const String&amp; label, const CanvasActivityRecord&amp; canvasActivityRecord)
 69 {
 70     encoder.encodeObject(label, canvasActivityRecord, [] (KeyedEncoder&amp; encoderInner, const CanvasActivityRecord&amp; canvasActivityRecord) {
 71         encoderInner.encodeBool(&quot;wasDataRead&quot;, canvasActivityRecord.wasDataRead);
 72         encoderInner.encodeObjects(&quot;textWritten&quot;, canvasActivityRecord.textWritten.begin(), canvasActivityRecord.textWritten.end(), [] (KeyedEncoder&amp; encoderInner2, const String&amp; text) {
 73             encoderInner2.encodeString(&quot;text&quot;, text);
 74         });
 75     });
 76 }
 77 #endif
 78 
 79 void ResourceLoadStatistics::encode(KeyedEncoder&amp; encoder) const
 80 {
<span class="line-modified"> 81     encoder.encodeString(&quot;PrevalentResourceDomain&quot;_s, registrableDomain.string());</span>
 82 
<span class="line-modified"> 83     encoder.encodeDouble(&quot;lastSeen&quot;_s, lastSeen.secondsSinceEpoch().value());</span>
 84 
 85     // User interaction
<span class="line-modified"> 86     encoder.encodeBool(&quot;hadUserInteraction&quot;_s, hadUserInteraction);</span>
<span class="line-modified"> 87     encoder.encodeDouble(&quot;mostRecentUserInteraction&quot;_s, mostRecentUserInteractionTime.secondsSinceEpoch().value());</span>
<span class="line-modified"> 88     encoder.encodeBool(&quot;grandfathered&quot;_s, grandfathered);</span>
 89 
 90     // Storage access
<span class="line-modified"> 91     encodeHashSet(encoder, &quot;storageAccessUnderTopFrameDomains&quot;_s, &quot;domain&quot;_s, storageAccessUnderTopFrameDomains);</span>
 92 
 93     // Top frame stats
<span class="line-modified"> 94     encodeHashSet(encoder, &quot;topFrameUniqueRedirectsTo&quot;_s, &quot;domain&quot;_s, topFrameUniqueRedirectsTo);</span>
<span class="line-modified"> 95     encodeHashSet(encoder, &quot;topFrameUniqueRedirectsFrom&quot;_s, &quot;domain&quot;_s, topFrameUniqueRedirectsFrom);</span>
<span class="line-added"> 96     encodeHashSet(encoder, &quot;topFrameLinkDecorationsFrom&quot;_s, &quot;domain&quot;, topFrameLinkDecorationsFrom);</span>
<span class="line-added"> 97     encoder.encodeBool(&quot;gotLinkDecorationFromPrevalentResource&quot;_s, gotLinkDecorationFromPrevalentResource);</span>
 98 
 99     // Subframe stats
<span class="line-modified">100     encodeHashSet(encoder, &quot;subframeUnderTopFrameDomains&quot;_s, &quot;domain&quot;_s, subframeUnderTopFrameDomains);</span>
101 
102     // Subresource stats
<span class="line-modified">103     encodeHashSet(encoder, &quot;subresourceUnderTopFrameDomains&quot;_s, &quot;domain&quot;_s, subresourceUnderTopFrameDomains);</span>
<span class="line-modified">104     encodeHashSet(encoder, &quot;subresourceUniqueRedirectsTo&quot;_s, &quot;domain&quot;_s, subresourceUniqueRedirectsTo);</span>
<span class="line-modified">105     encodeHashSet(encoder, &quot;subresourceUniqueRedirectsFrom&quot;_s, &quot;domain&quot;_s, subresourceUniqueRedirectsFrom);</span>
106 
107     // Prevalent Resource
<span class="line-modified">108     encoder.encodeBool(&quot;isPrevalentResource&quot;_s, isPrevalentResource);</span>
<span class="line-modified">109     encoder.encodeBool(&quot;isVeryPrevalentResource&quot;_s, isVeryPrevalentResource);</span>
<span class="line-modified">110     encoder.encodeUInt32(&quot;dataRecordsRemoved&quot;_s, dataRecordsRemoved);</span>
111 
<span class="line-modified">112     encoder.encodeUInt32(&quot;timesAccessedAsFirstPartyDueToUserInteraction&quot;_s, timesAccessedAsFirstPartyDueToUserInteraction);</span>
<span class="line-modified">113     encoder.encodeUInt32(&quot;timesAccessedAsFirstPartyDueToStorageAccessAPI&quot;_s, timesAccessedAsFirstPartyDueToStorageAccessAPI);</span>
114 
115 #if ENABLE(WEB_API_STATISTICS)
116     encodeFontHashSet(encoder, &quot;fontsFailedToLoad&quot;, fontsFailedToLoad);
117     encodeFontHashSet(encoder, &quot;fontsSuccessfullyLoaded&quot;, fontsSuccessfullyLoaded);
118     encodeHashCountedSet(encoder, &quot;topFrameRegistrableDomainsWhichAccessedWebAPIs&quot;, topFrameRegistrableDomainsWhichAccessedWebAPIs);
119     encodeCanvasActivityRecord(encoder, &quot;canvasActivityRecord&quot;, canvasActivityRecord);
120     encodeOptionSet(encoder, &quot;navigatorFunctionsAccessedBitMask&quot;, navigatorFunctionsAccessed);
121     encodeOptionSet(encoder, &quot;screenFunctionsAccessedBitMask&quot;, screenFunctionsAccessed);
122 #endif
123 }
124 
<span class="line-modified">125 static void decodeHashCountedSet(KeyedDecoder&amp; decoder, const String&amp; label, HashCountedSet&lt;RegistrableDomain&gt;&amp; hashCountedSet)</span>
126 {
127     Vector&lt;String&gt; ignore;
<span class="line-modified">128     decoder.decodeObjects(label, ignore, [&amp;hashCountedSet](KeyedDecoder&amp; decoderInner, String&amp; domain) {</span>
<span class="line-modified">129         if (!decoderInner.decodeString(&quot;origin&quot;, domain))</span>
130             return false;
131 
132         unsigned count;
133         if (!decoderInner.decodeUInt32(&quot;count&quot;, count))
134             return false;
135 
<span class="line-modified">136         hashCountedSet.add(RegistrableDomain::uncheckedCreateFromRegistrableDomainString(domain), count);</span>
137         return true;
138     });
139 }
140 
<span class="line-modified">141 static void decodeHashSet(KeyedDecoder&amp; decoder, const String&amp; label, const String&amp; key, HashSet&lt;RegistrableDomain&gt;&amp; hashSet)</span>
142 {
143     Vector&lt;String&gt; ignore;
<span class="line-modified">144     decoder.decodeObjects(label, ignore, [&amp;hashSet, &amp;key](KeyedDecoder&amp; decoderInner, String&amp; domain) {</span>
<span class="line-modified">145         if (!decoderInner.decodeString(key, domain))</span>
146             return false;
147 
<span class="line-modified">148         hashSet.add(RegistrableDomain::uncheckedCreateFromRegistrableDomainString(domain));</span>
149         return true;
150     });
151 }
152 





153 template&lt;typename T&gt;
154 static void decodeOptionSet(KeyedDecoder&amp; decoder, const String&amp; label, OptionSet&lt;T&gt;&amp; optionSet)
155 {
156     uint64_t optionSetBitMask = 0;
157     decoder.decodeUInt64(label, optionSetBitMask);
158     optionSet = OptionSet&lt;T&gt;::fromRaw(optionSetBitMask);
159 }
160 
161 #if ENABLE(WEB_API_STATISTICS)
162 static void decodeFontHashSet(KeyedDecoder&amp; decoder, const String&amp; label, HashSet&lt;String&gt;&amp; hashSet)
163 {
164     decodeHashSet(decoder, label, &quot;font&quot;, hashSet);
165 }
166 
167 static void decodeCanvasActivityRecord(KeyedDecoder&amp; decoder, const String&amp; label, CanvasActivityRecord&amp; canvasActivityRecord)
168 {
169     decoder.decodeObject(label, canvasActivityRecord, [] (KeyedDecoder&amp; decoderInner, CanvasActivityRecord&amp; canvasActivityRecord) {
170         if (!decoderInner.decodeBool(&quot;wasDataRead&quot;, canvasActivityRecord.wasDataRead))
171             return false;
172         Vector&lt;String&gt; ignore;
173         decoderInner.decodeObjects(&quot;textWritten&quot;, ignore, [&amp;canvasActivityRecord] (KeyedDecoder&amp; decoderInner2, String&amp; text) {
174             if (!decoderInner2.decodeString(&quot;text&quot;, text))
175                 return false;
176             canvasActivityRecord.textWritten.add(text);
177             return true;
178         });
179         return true;
180     });
181 }
182 #endif
183 
184 bool ResourceLoadStatistics::decode(KeyedDecoder&amp; decoder, unsigned modelVersion)
185 {
<span class="line-modified">186     String registrableDomainAsString;</span>
<span class="line-modified">187     if (modelVersion &gt;= 15) {</span>
<span class="line-added">188         if (!decoder.decodeString(&quot;PrevalentResourceDomain&quot;, registrableDomainAsString))</span>
<span class="line-added">189             return false;</span>
<span class="line-added">190     } else {</span>
<span class="line-added">191         if (!decoder.decodeString(&quot;PrevalentResourceOrigin&quot;, registrableDomainAsString))</span>
<span class="line-added">192             return false;</span>
<span class="line-added">193     }</span>
<span class="line-added">194     registrableDomain = RegistrableDomain::uncheckedCreateFromRegistrableDomainString(registrableDomainAsString);</span>
195 
196     // User interaction
197     if (!decoder.decodeBool(&quot;hadUserInteraction&quot;, hadUserInteraction))
198         return false;
199 
200     // Storage access
<span class="line-modified">201     if (modelVersion &gt;= 15)</span>
<span class="line-added">202         decodeHashSet(decoder, &quot;storageAccessUnderTopFrameDomains&quot;, &quot;domain&quot;, storageAccessUnderTopFrameDomains);</span>
<span class="line-added">203     else</span>
<span class="line-added">204         decodeHashSet(decoder, &quot;storageAccessUnderTopFrameOrigins&quot;, &quot;origin&quot;, storageAccessUnderTopFrameDomains);</span>
205 
206     // Top frame stats
<span class="line-modified">207     if (modelVersion &gt;= 15) {</span>
<span class="line-modified">208         decodeHashSet(decoder, &quot;topFrameUniqueRedirectsTo&quot;, &quot;domain&quot;, topFrameUniqueRedirectsTo);</span>
<span class="line-modified">209         decodeHashSet(decoder, &quot;topFrameUniqueRedirectsFrom&quot;, &quot;domain&quot;, topFrameUniqueRedirectsFrom);</span>
<span class="line-added">210     } else if (modelVersion &gt;= 11) {</span>
<span class="line-added">211         HashCountedSet&lt;RegistrableDomain&gt; topFrameUniqueRedirectsToCounted;</span>
<span class="line-added">212         decodeHashCountedSet(decoder, &quot;topFrameUniqueRedirectsTo&quot;, topFrameUniqueRedirectsToCounted);</span>
<span class="line-added">213         for (auto&amp; domain : topFrameUniqueRedirectsToCounted.values())</span>
<span class="line-added">214             topFrameUniqueRedirectsTo.add(domain);</span>
<span class="line-added">215 </span>
<span class="line-added">216         HashCountedSet&lt;RegistrableDomain&gt; topFrameUniqueRedirectsFromCounted;</span>
<span class="line-added">217         decodeHashCountedSet(decoder, &quot;topFrameUniqueRedirectsFrom&quot;, topFrameUniqueRedirectsFromCounted);</span>
<span class="line-added">218         for (auto&amp; domain : topFrameUniqueRedirectsFromCounted.values())</span>
<span class="line-added">219             topFrameUniqueRedirectsFrom.add(domain);</span>
<span class="line-added">220     }</span>
<span class="line-added">221 </span>
<span class="line-added">222     if (modelVersion &gt;= 16) {</span>
<span class="line-added">223         decodeHashSet(decoder, &quot;topFrameLinkDecorationsFrom&quot;, &quot;domain&quot;, topFrameLinkDecorationsFrom);</span>
<span class="line-added">224         if (!decoder.decodeBool(&quot;gotLinkDecorationFromPrevalentResource&quot;, gotLinkDecorationFromPrevalentResource))</span>
<span class="line-added">225             return false;</span>
226     }
227 
228     // Subframe stats
<span class="line-modified">229     if (modelVersion &gt;= 15)</span>
<span class="line-modified">230         decodeHashSet(decoder, &quot;subframeUnderTopFrameDomains&quot;, &quot;domain&quot;, subframeUnderTopFrameDomains);</span>
<span class="line-added">231     else if (modelVersion &gt;= 14) {</span>
<span class="line-added">232         HashCountedSet&lt;RegistrableDomain&gt; subframeUnderTopFrameDomainsCounted;</span>
<span class="line-added">233         decodeHashCountedSet(decoder, &quot;subframeUnderTopFrameOrigins&quot;, subframeUnderTopFrameDomainsCounted);</span>
<span class="line-added">234         for (auto&amp; domain : subframeUnderTopFrameDomainsCounted.values())</span>
<span class="line-added">235             subframeUnderTopFrameDomains.add(domain);</span>
<span class="line-added">236     }</span>
237 
238     // Subresource stats
<span class="line-modified">239     if (modelVersion &gt;= 15) {</span>
<span class="line-modified">240         decodeHashSet(decoder, &quot;subresourceUnderTopFrameDomains&quot;, &quot;domain&quot;, subresourceUnderTopFrameDomains);</span>
<span class="line-modified">241         decodeHashSet(decoder, &quot;subresourceUniqueRedirectsTo&quot;, &quot;domain&quot;, subresourceUniqueRedirectsTo);</span>
<span class="line-modified">242         decodeHashSet(decoder, &quot;subresourceUniqueRedirectsFrom&quot;, &quot;domain&quot;, subresourceUniqueRedirectsFrom);</span>
<span class="line-added">243     } else {</span>
<span class="line-added">244         HashCountedSet&lt;RegistrableDomain&gt; subresourceUnderTopFrameDomainsCounted;</span>
<span class="line-added">245         decodeHashCountedSet(decoder, &quot;subresourceUnderTopFrameOrigins&quot;, subresourceUnderTopFrameDomainsCounted);</span>
<span class="line-added">246         for (auto&amp; domain : subresourceUnderTopFrameDomainsCounted.values())</span>
<span class="line-added">247             subresourceUnderTopFrameDomains.add(domain);</span>
<span class="line-added">248 </span>
<span class="line-added">249         HashCountedSet&lt;RegistrableDomain&gt; subresourceUniqueRedirectsToCounted;</span>
<span class="line-added">250         decodeHashCountedSet(decoder, &quot;subresourceUniqueRedirectsTo&quot;, subresourceUniqueRedirectsToCounted);</span>
<span class="line-added">251         for (auto&amp; domain : subresourceUniqueRedirectsToCounted.values())</span>
<span class="line-added">252             subresourceUniqueRedirectsTo.add(domain);</span>
<span class="line-added">253         if (modelVersion &gt;= 11) {</span>
<span class="line-added">254             HashCountedSet&lt;RegistrableDomain&gt; subresourceUniqueRedirectsFromCounted;</span>
<span class="line-added">255             decodeHashCountedSet(decoder, &quot;subresourceUniqueRedirectsFrom&quot;, subresourceUniqueRedirectsFromCounted);</span>
<span class="line-added">256             for (auto&amp; domain : subresourceUniqueRedirectsFromCounted.values())</span>
<span class="line-added">257                 subresourceUniqueRedirectsFrom.add(domain);</span>
<span class="line-added">258         }</span>
<span class="line-added">259     }</span>
<span class="line-added">260 </span>
261 
262     // Prevalent Resource
263     if (!decoder.decodeBool(&quot;isPrevalentResource&quot;, isPrevalentResource))
264         return false;
265 
266     if (modelVersion &gt;= 12) {
267         if (!decoder.decodeBool(&quot;isVeryPrevalentResource&quot;, isVeryPrevalentResource))
268             return false;
269     }
270 
271     // Trigger re-classification based on model 14.
272     if (modelVersion &lt; 14) {
273         isPrevalentResource = false;
274         isVeryPrevalentResource = false;
275     }
276 
277     if (!decoder.decodeUInt32(&quot;dataRecordsRemoved&quot;, dataRecordsRemoved))
278         return false;
279 
280     double mostRecentUserInteractionTimeAsDouble;
</pre>
<hr />
<pre>
302         decodeFontHashSet(decoder, &quot;fontsFailedToLoad&quot;, fontsFailedToLoad);
303         decodeFontHashSet(decoder, &quot;fontsSuccessfullyLoaded&quot;, fontsSuccessfullyLoaded);
304         decodeHashCountedSet(decoder, &quot;topFrameRegistrableDomainsWhichAccessedWebAPIs&quot;, topFrameRegistrableDomainsWhichAccessedWebAPIs);
305         decodeCanvasActivityRecord(decoder, &quot;canvasActivityRecord&quot;, canvasActivityRecord);
306         decodeOptionSet(decoder, &quot;navigatorFunctionsAccessedBitMask&quot;, navigatorFunctionsAccessed);
307         decodeOptionSet(decoder, &quot;screenFunctionsAccessedBitMask&quot;, screenFunctionsAccessed);
308     }
309 #endif
310 
311     return true;
312 }
313 
314 static void appendBoolean(StringBuilder&amp; builder, const String&amp; label, bool flag)
315 {
316     builder.appendLiteral(&quot;    &quot;);
317     builder.append(label);
318     builder.appendLiteral(&quot;: &quot;);
319     builder.append(flag ? &quot;Yes&quot; : &quot;No&quot;);
320 }
321 
<span class="line-modified">322 static void appendHashSet(StringBuilder&amp; builder, const String&amp; label, const HashSet&lt;RegistrableDomain&gt;&amp; hashSet)</span>


















323 {
324     if (hashSet.isEmpty())
325         return;
326 
327     builder.appendLiteral(&quot;    &quot;);
328     builder.append(label);
329     builder.appendLiteral(&quot;:\n&quot;);
330 
331     for (auto&amp; entry : hashSet) {
332         builder.appendLiteral(&quot;        &quot;);
<span class="line-modified">333         builder.append(entry.string());</span>
334         builder.append(&#39;\n&#39;);
335     }
336 }
337 
338 #if ENABLE(WEB_API_STATISTICS)
339 static ASCIILiteral navigatorAPIEnumToString(ResourceLoadStatistics::NavigatorAPI navigatorEnum)
340 {
341     switch (navigatorEnum) {
342     case ResourceLoadStatistics::NavigatorAPI::JavaEnabled:
343         return &quot;javaEnabled&quot;_s;
344     case ResourceLoadStatistics::NavigatorAPI::MimeTypes:
345         return &quot;mimeTypes&quot;_s;
346     case ResourceLoadStatistics::NavigatorAPI::CookieEnabled:
347         return &quot;cookieEnabled&quot;_s;
348     case ResourceLoadStatistics::NavigatorAPI::Plugins:
349         return &quot;plugins&quot;_s;
350     case ResourceLoadStatistics::NavigatorAPI::UserAgent:
351         return &quot;userAgent&quot;_s;
352     case ResourceLoadStatistics::NavigatorAPI::AppVersion:
353         return &quot;appVersion&quot;_s;
</pre>
<hr />
<pre>
391         builder.append(&#39;\n&#39;);
392     }
393 }
394 
395 static void appendScreenAPIOptionSet(StringBuilder&amp; builder, const OptionSet&lt;ResourceLoadStatistics::ScreenAPI&gt;&amp; optionSet)
396 {
397     if (optionSet.isEmpty())
398         return;
399     builder.appendLiteral(&quot;    screenFunctionsAccessed:\n&quot;);
400     for (auto screenAPI : optionSet) {
401         builder.appendLiteral(&quot;        &quot;);
402         builder.append(screenAPIEnumToString(screenAPI).characters());
403         builder.append(&#39;\n&#39;);
404     }
405 }
406 #endif
407 
408 String ResourceLoadStatistics::toString() const
409 {
410     StringBuilder builder;
<span class="line-modified">411     builder.appendLiteral(&quot;Registrable domain: &quot;);</span>
<span class="line-modified">412     builder.append(registrableDomain.string());</span>
413     builder.append(&#39;\n&#39;);
414     builder.appendLiteral(&quot;    lastSeen: &quot;);
<span class="line-modified">415     builder.appendFixedPrecisionNumber(lastSeen.secondsSinceEpoch().value());</span>
416     builder.append(&#39;\n&#39;);
417 
418     // User interaction
419     appendBoolean(builder, &quot;hadUserInteraction&quot;, hadUserInteraction);
420     builder.append(&#39;\n&#39;);
421     builder.appendLiteral(&quot;    mostRecentUserInteraction: &quot;);
<span class="line-modified">422     builder.appendFixedPrecisionNumber(mostRecentUserInteractionTime.secondsSinceEpoch().value());</span>
423     builder.append(&#39;\n&#39;);
424     appendBoolean(builder, &quot;grandfathered&quot;, grandfathered);
425     builder.append(&#39;\n&#39;);
426 
427     // Storage access
<span class="line-modified">428     appendHashSet(builder, &quot;storageAccessUnderTopFrameDomains&quot;, storageAccessUnderTopFrameDomains);</span>
429 
430     // Top frame stats
<span class="line-modified">431     appendHashSet(builder, &quot;topFrameUniqueRedirectsTo&quot;, topFrameUniqueRedirectsTo);</span>
<span class="line-modified">432     appendHashSet(builder, &quot;topFrameUniqueRedirectsFrom&quot;, topFrameUniqueRedirectsFrom);</span>
<span class="line-added">433     appendHashSet(builder, &quot;topFrameLinkDecorationsFrom&quot;, topFrameLinkDecorationsFrom);</span>
<span class="line-added">434     appendBoolean(builder, &quot;gotLinkDecorationFromPrevalentResource&quot;, gotLinkDecorationFromPrevalentResource);</span>
435 
436     // Subframe stats
<span class="line-modified">437     appendHashSet(builder, &quot;subframeUnderTopFrameDomains&quot;, subframeUnderTopFrameDomains);</span>
438 
439     // Subresource stats
<span class="line-modified">440     appendHashSet(builder, &quot;subresourceUnderTopFrameDomains&quot;, subresourceUnderTopFrameDomains);</span>
<span class="line-modified">441     appendHashSet(builder, &quot;subresourceUniqueRedirectsTo&quot;, subresourceUniqueRedirectsTo);</span>
<span class="line-modified">442     appendHashSet(builder, &quot;subresourceUniqueRedirectsFrom&quot;, subresourceUniqueRedirectsFrom);</span>
443 
444     // Prevalent Resource
445     appendBoolean(builder, &quot;isPrevalentResource&quot;, isPrevalentResource);
446     builder.append(&#39;\n&#39;);
447     appendBoolean(builder, &quot;isVeryPrevalentResource&quot;, isVeryPrevalentResource);
448     builder.append(&#39;\n&#39;);
449     builder.appendLiteral(&quot;    dataRecordsRemoved: &quot;);
450     builder.appendNumber(dataRecordsRemoved);
451     builder.append(&#39;\n&#39;);
452 
453 #if ENABLE(WEB_API_STATISTICS)
454     appendHashSet(builder, &quot;fontsFailedToLoad&quot;, fontsFailedToLoad);
455     appendHashSet(builder, &quot;fontsSuccessfullyLoaded&quot;, fontsSuccessfullyLoaded);
456     appendHashCountedSet(builder, &quot;topFrameRegistrableDomainsWhichAccessedWebAPIs&quot;, topFrameRegistrableDomainsWhichAccessedWebAPIs);
457     appendNavigatorAPIOptionSet(builder, navigatorFunctionsAccessed);
458     appendScreenAPIOptionSet(builder, screenFunctionsAccessed);
459     appendHashSet(builder, &quot;canvasTextWritten&quot;, canvasActivityRecord.textWritten);
460     appendBoolean(builder, &quot;canvasReadData&quot;, canvasActivityRecord.wasDataRead);
461     builder.append(&#39;\n&#39;);
462     builder.append(&#39;\n&#39;);
</pre>
<hr />
<pre>
464 
465     return builder.toString();
466 }
467 
468 template &lt;typename T&gt;
469 static void mergeHashCountedSet(HashCountedSet&lt;T&gt;&amp; to, const HashCountedSet&lt;T&gt;&amp; from)
470 {
471     for (auto&amp; entry : from)
472         to.add(entry.key, entry.value);
473 }
474 
475 template &lt;typename T&gt;
476 static void mergeHashSet(HashSet&lt;T&gt;&amp; to, const HashSet&lt;T&gt;&amp; from)
477 {
478     for (auto&amp; entry : from)
479         to.add(entry);
480 }
481 
482 void ResourceLoadStatistics::merge(const ResourceLoadStatistics&amp; other)
483 {
<span class="line-modified">484     ASSERT(other.registrableDomain == registrableDomain);</span>
485 
486     if (lastSeen &lt; other.lastSeen)
487         lastSeen = other.lastSeen;
488 
489     if (!other.hadUserInteraction) {
490         // If user interaction has been reset do so here too.
491         // Else, do nothing.
492         if (!other.mostRecentUserInteractionTime) {
493             hadUserInteraction = false;
494             mostRecentUserInteractionTime = { };
495         }
496     } else {
497         hadUserInteraction = true;
498         if (mostRecentUserInteractionTime &lt; other.mostRecentUserInteractionTime)
499             mostRecentUserInteractionTime = other.mostRecentUserInteractionTime;
500     }
501     grandfathered |= other.grandfathered;
502 
503     // Storage access
<span class="line-modified">504     mergeHashSet(storageAccessUnderTopFrameDomains, other.storageAccessUnderTopFrameDomains);</span>
505 
506     // Top frame stats
<span class="line-modified">507     mergeHashSet(topFrameUniqueRedirectsTo, other.topFrameUniqueRedirectsTo);</span>
<span class="line-modified">508     mergeHashSet(topFrameUniqueRedirectsFrom, other.topFrameUniqueRedirectsFrom);</span>
<span class="line-added">509     mergeHashSet(topFrameLinkDecorationsFrom, other.topFrameLinkDecorationsFrom);</span>
<span class="line-added">510     gotLinkDecorationFromPrevalentResource |= other.gotLinkDecorationFromPrevalentResource;</span>
511 
512     // Subframe stats
<span class="line-modified">513     mergeHashSet(subframeUnderTopFrameDomains, other.subframeUnderTopFrameDomains);</span>
514 
515     // Subresource stats
<span class="line-modified">516     mergeHashSet(subresourceUnderTopFrameDomains, other.subresourceUnderTopFrameDomains);</span>
<span class="line-modified">517     mergeHashSet(subresourceUniqueRedirectsTo, other.subresourceUniqueRedirectsTo);</span>
<span class="line-modified">518     mergeHashSet(subresourceUniqueRedirectsFrom, other.subresourceUniqueRedirectsFrom);</span>
519 
520     // Prevalent resource stats
521     isPrevalentResource |= other.isPrevalentResource;
522     isVeryPrevalentResource |= other.isVeryPrevalentResource;
523     dataRecordsRemoved = std::max(dataRecordsRemoved, other.dataRecordsRemoved);
524 
525 #if ENABLE(WEB_API_STATISTICS)
526     mergeHashSet(fontsFailedToLoad, other.fontsFailedToLoad);
527     mergeHashSet(fontsSuccessfullyLoaded, other.fontsSuccessfullyLoaded);
<span class="line-modified">528     mergeHashSet(topFrameRegistrableDomainsWhichAccessedWebAPIs, other.topFrameRegistrableDomainsWhichAccessedWebAPIs);</span>
529     canvasActivityRecord.mergeWith(other.canvasActivityRecord);
530     navigatorFunctionsAccessed.add(other.navigatorFunctionsAccessed);
531     screenFunctionsAccessed.add(other.screenFunctionsAccessed);
532 #endif
533 }
534 





















535 WallTime ResourceLoadStatistics::reduceTimeResolution(WallTime time)
536 {
537     return WallTime::fromRawSeconds(std::floor(time.secondsSinceEpoch() / timestampResolution) * timestampResolution.seconds());
538 }
539 
540 }
</pre>
</td>
</tr>
</table>
<center><a href="ResourceLoadObserver.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="ResourceLoadStatistics.h.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>