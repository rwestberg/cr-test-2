<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Udiff modules/javafx.web/src/main/native/Source/WebCore/loader/FrameLoader.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="FrameLoadRequest.h.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="FrameLoader.h.udiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/loader/FrameLoader.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-new-header">@@ -43,11 +43,13 @@</span>
  #include &quot;CachedResourceLoader.h&quot;
  #include &quot;Chrome.h&quot;
  #include &quot;ChromeClient.h&quot;
  #include &quot;CommonVM.h&quot;
  #include &quot;ContentFilter.h&quot;
<span class="udiff-line-added">+ #include &quot;ContentRuleListResults.h&quot;</span>
  #include &quot;ContentSecurityPolicy.h&quot;
<span class="udiff-line-added">+ #include &quot;CustomHeaderFields.h&quot;</span>
  #include &quot;DOMWindow.h&quot;
  #include &quot;DatabaseManager.h&quot;
  #include &quot;DiagnosticLoggingClient.h&quot;
  #include &quot;DiagnosticLoggingKeys.h&quot;
  #include &quot;Document.h&quot;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -114,10 +116,11 @@</span>
  #include &quot;SecurityPolicy.h&quot;
  #include &quot;SegmentedString.h&quot;
  #include &quot;SerializedScriptValue.h&quot;
  #include &quot;Settings.h&quot;
  #include &quot;ShouldTreatAsContinuingLoad.h&quot;
<span class="udiff-line-added">+ #include &quot;StyleTreeResolver.h&quot;</span>
  #include &quot;SubframeLoader.h&quot;
  #include &quot;SubresourceLoader.h&quot;
  #include &quot;TextResourceDecoder.h&quot;
  #include &quot;UserContentController.h&quot;
  #include &quot;UserGestureIndicator.h&quot;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -143,11 +146,10 @@</span>
  
  #if PLATFORM(IOS_FAMILY)
  #include &quot;DocumentType.h&quot;
  #include &quot;ResourceLoader.h&quot;
  #include &quot;RuntimeApplicationChecks.h&quot;
<span class="udiff-line-removed">- #include &quot;WKContentObservation.h&quot;</span>
  #endif
  
  #define RELEASE_LOG_IF_ALLOWED(fmt, ...) RELEASE_LOG_IF(isAlwaysOnLoggingAllowed(), Network, &quot;%p - FrameLoader::&quot; fmt, this, ##__VA_ARGS__)
  
  namespace WebCore {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -266,14 +268,14 @@</span>
  };
  
  FrameLoader::FrameLoader(Frame&amp; frame, FrameLoaderClient&amp; client)
      : m_frame(frame)
      , m_client(client)
<span class="udiff-line-modified-removed">-     , m_policyChecker(std::make_unique&lt;PolicyChecker&gt;(frame))</span>
<span class="udiff-line-modified-removed">-     , m_history(std::make_unique&lt;HistoryController&gt;(frame))</span>
<span class="udiff-line-modified-added">+     , m_policyChecker(makeUnique&lt;PolicyChecker&gt;(frame))</span>
<span class="udiff-line-modified-added">+     , m_history(makeUnique&lt;HistoryController&gt;(frame))</span>
      , m_notifier(frame)
<span class="udiff-line-modified-removed">-     , m_subframeLoader(std::make_unique&lt;SubframeLoader&gt;(frame))</span>
<span class="udiff-line-modified-added">+     , m_subframeLoader(makeUnique&lt;SubframeLoader&gt;(frame))</span>
      , m_mixedContentChecker(frame)
      , m_state(FrameStateProvisional)
      , m_loadType(FrameLoadType::Standard)
      , m_quickRedirectComing(false)
      , m_sentRedirectNotification(false)
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -317,11 +319,11 @@</span>
      Ref&lt;Frame&gt; protect(m_frame);
      m_frame.document()-&gt;cancelParsing();
      m_stateMachine.advanceTo(FrameLoaderStateMachine::DisplayingInitialEmptyDocument);
  
      m_networkingContext = m_client.createNetworkingContext();
<span class="udiff-line-modified-removed">-     m_progressTracker = std::make_unique&lt;FrameProgressTracker&gt;(m_frame);</span>
<span class="udiff-line-modified-added">+     m_progressTracker = makeUnique&lt;FrameProgressTracker&gt;(m_frame);</span>
  }
  
  void FrameLoader::initForSynthesizedDocument(const URL&amp;)
  {
      // FIXME: We need to initialize the document URL to the specified URL. Currently the URL is empty and hence
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -342,11 +344,11 @@</span>
      m_isComplete = true;
      m_state = FrameStateComplete;
      m_needsClear = true;
  
      m_networkingContext = m_client.createNetworkingContext();
<span class="udiff-line-modified-removed">-     m_progressTracker = std::make_unique&lt;FrameProgressTracker&gt;(m_frame);</span>
<span class="udiff-line-modified-added">+     m_progressTracker = makeUnique&lt;FrameProgressTracker&gt;(m_frame);</span>
  }
  
  void FrameLoader::setDefersLoading(bool defers)
  {
      if (m_documentLoader)
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -370,19 +372,19 @@</span>
          function(PolicyAction::Ignore, identifier);
          return;
      }
  
      // FIXME: Validate the policy check identifier.
<span class="udiff-line-modified-removed">-     client().dispatchDecidePolicyForResponse(response, activeDocumentLoader()-&gt;request(), identifier, WTFMove(function));</span>
<span class="udiff-line-modified-added">+     client().dispatchDecidePolicyForResponse(response, activeDocumentLoader()-&gt;request(), identifier, activeDocumentLoader()-&gt;downloadAttribute(), WTFMove(function));</span>
  }
  
  void FrameLoader::changeLocation(FrameLoadRequest&amp;&amp; request)
  {
      urlSelected(WTFMove(request), nullptr);
  }
  
<span class="udiff-line-modified-removed">- void FrameLoader::urlSelected(const URL&amp; url, const String&amp; passedTarget, Event* triggeringEvent, LockHistory lockHistory, LockBackForwardList lockBackForwardList, ShouldSendReferrer shouldSendReferrer, ShouldOpenExternalURLsPolicy shouldOpenExternalURLsPolicy, Optional&lt;NewFrameOpenerPolicy&gt; openerPolicy, const AtomicString&amp; downloadAttribute, const SystemPreviewInfo&amp; systemPreviewInfo, Optional&lt;AdClickAttribution&gt;&amp;&amp; adClickAttribution)</span>
<span class="udiff-line-modified-added">+ void FrameLoader::urlSelected(const URL&amp; url, const String&amp; passedTarget, Event* triggeringEvent, LockHistory lockHistory, LockBackForwardList lockBackForwardList, ShouldSendReferrer shouldSendReferrer, ShouldOpenExternalURLsPolicy shouldOpenExternalURLsPolicy, Optional&lt;NewFrameOpenerPolicy&gt; openerPolicy, const AtomString&amp; downloadAttribute, const SystemPreviewInfo&amp; systemPreviewInfo, Optional&lt;AdClickAttribution&gt;&amp;&amp; adClickAttribution)</span>
  {
      auto* frame = lexicalFrameFromCommonVM();
      auto initiatedByMainFrame = frame &amp;&amp; frame-&gt;isMainFrame() ? InitiatedByMainFrame::Yes : InitiatedByMainFrame::Unknown;
  
      NewFrameOpenerPolicy newFrameOpenerPolicy = openerPolicy.valueOr(shouldSendReferrer == NeverSendReferrer ? NewFrameOpenerPolicy::Suppress : NewFrameOpenerPolicy::Allow);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -470,11 +472,10 @@</span>
          if (m_submittedFormURL == submission-&gt;requestURL())
              return;
          m_submittedFormURL = submission-&gt;requestURL();
      }
  
<span class="udiff-line-removed">-     submission-&gt;data().generateFiles(m_frame.document());</span>
      submission-&gt;setReferrer(outgoingReferrer());
      submission-&gt;setOrigin(outgoingOrigin());
  
      targetFrame-&gt;navigationScheduler().scheduleFormSubmission(WTFMove(submission));
  }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -494,14 +495,10 @@</span>
          finishedParsing();
          m_frame.document()-&gt;setParsing(false);
      }
  
      if (auto* document = m_frame.document()) {
<span class="udiff-line-removed">-         // FIXME: HTML5 doesn&#39;t tell us to set the state to complete when aborting, but we do anyway to match legacy behavior.</span>
<span class="udiff-line-removed">-         // http://www.w3.org/Bugs/Public/show_bug.cgi?id=10537</span>
<span class="udiff-line-removed">-         document-&gt;setReadyState(Document::Complete);</span>
<span class="udiff-line-removed">- </span>
          // FIXME: Should the DatabaseManager watch for something like ActiveDOMObject::stop() rather than being special-cased here?
          DatabaseManager::singleton().stopDatabases(*document, nullptr);
      }
  
      policyChecker().stopCheck();
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -591,10 +588,12 @@</span>
  
      // Calling document.open counts as committing the first real document load.
      if (!m_stateMachine.committedFirstRealDocumentLoad())
          m_stateMachine.advanceTo(FrameLoaderStateMachine::DisplayingInitialEmptyDocumentPostCommit);
  
<span class="udiff-line-added">+     m_client.dispatchDidExplicitOpen(m_frame.document() ? m_frame.document()-&gt;url() : URL());</span>
<span class="udiff-line-added">+ </span>
      // Prevent window.open(url) -- eg window.open(&quot;about:blank&quot;) -- from blowing away results
      // from a subsequent window.document.open / window.document.write call.
      // Canceling redirection here works for all cases because document.open
      // implicitly precedes document.write.
      m_frame.navigationScheduler().cancel();
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -621,27 +620,32 @@</span>
          return false;
  
      return !newDocument.securityOrigin().isSameOriginAs(frame.document()-&gt;securityOrigin());
  }
  
<span class="udiff-line-modified-removed">- void FrameLoader::clear(Document* newDocument, bool clearWindowProperties, bool clearScriptObjects, bool clearFrameView)</span>
<span class="udiff-line-modified-added">+ void FrameLoader::clear(Document* newDocument, bool clearWindowProperties, bool clearScriptObjects, bool clearFrameView, WTF::Function&lt;void()&gt;&amp;&amp; handleDOMWindowCreation)</span>
  {
      m_frame.editor().clear();
  
<span class="udiff-line-modified-removed">-     if (!m_needsClear)</span>
<span class="udiff-line-removed">-         return;</span>
<span class="udiff-line-modified-added">+     bool neededClear = m_needsClear;</span>
      m_needsClear = false;
  
<span class="udiff-line-modified-removed">-     if (m_frame.document()-&gt;pageCacheState() != Document::InPageCache) {</span>
<span class="udiff-line-modified-added">+     if (neededClear &amp;&amp; m_frame.document()-&gt;pageCacheState() != Document::InPageCache) {</span>
          m_frame.document()-&gt;cancelParsing();
          m_frame.document()-&gt;stopActiveDOMObjects();
          bool hadLivingRenderTree = m_frame.document()-&gt;hasLivingRenderTree();
          m_frame.document()-&gt;prepareForDestruction();
          if (hadLivingRenderTree)
              m_frame.document()-&gt;adjustFocusedNodeOnNodeRemoval(*m_frame.document());
      }
  
<span class="udiff-line-added">+     if (handleDOMWindowCreation)</span>
<span class="udiff-line-added">+         handleDOMWindowCreation();</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     if (!neededClear)</span>
<span class="udiff-line-added">+         return;</span>
<span class="udiff-line-added">+ </span>
      // Do this after detaching the document so that the unload event works.
      if (clearWindowProperties) {
          InspectorInstrumentation::frameWindowDiscarded(m_frame, m_frame.document()-&gt;domWindow());
          m_frame.document()-&gt;domWindow()-&gt;resetUnlessSuspendedForDocumentSuspension();
          m_frame.windowProxy().clearJSWindowProxiesNotMatchingDOMWindow(newDocument-&gt;domWindow(), m_frame.document()-&gt;pageCacheState() == Document::AboutToEnterPageCache);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -973,11 +977,11 @@</span>
      // of this child frame with whatever was there at that point.
      auto* parentItem = history().currentItem();
      if (parentItem &amp;&amp; parentItem-&gt;children().size() &amp;&amp; isBackForwardLoadType(loadType()) &amp;&amp; !m_frame.document()-&gt;loadEventFinished()) {
          if (auto* childItem = parentItem-&gt;childItemWithTarget(childFrame-&gt;tree().uniqueName())) {
              childFrame-&gt;loader().m_requestedHistoryItem = childItem;
<span class="udiff-line-modified-removed">-             childFrame-&gt;loader().loadDifferentDocumentItem(*childItem, loadType(), MayAttemptCacheOnlyLoadForFormSubmissionItem, ShouldTreatAsContinuingLoad::No);</span>
<span class="udiff-line-modified-added">+             childFrame-&gt;loader().loadDifferentDocumentItem(*childItem, nullptr, loadType(), MayAttemptCacheOnlyLoadForFormSubmissionItem, ShouldTreatAsContinuingLoad::No);</span>
              return;
          }
      }
  
      auto* lexicalFrame = lexicalFrameFromCommonVM();
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1106,13 +1110,13 @@</span>
  void FrameLoader::setFirstPartyForCookies(const URL&amp; url)
  {
      for (Frame* frame = &amp;m_frame; frame; frame = frame-&gt;tree().traverseNext(&amp;m_frame))
          frame-&gt;document()-&gt;setFirstPartyForCookies(url);
  
<span class="udiff-line-modified-removed">-     String registrableDomain = ResourceRequest::partitionName(url.host().toString());</span>
<span class="udiff-line-modified-added">+     RegistrableDomain registrableDomain(url);</span>
      for (Frame* frame = &amp;m_frame; frame; frame = frame-&gt;tree().traverseNext(&amp;m_frame)) {
<span class="udiff-line-modified-removed">-         if (SecurityPolicy::shouldInheritSecurityOriginFromOwner(frame-&gt;document()-&gt;url()) || registrableDomainsAreEqual(frame-&gt;document()-&gt;url(), registrableDomain))</span>
<span class="udiff-line-modified-added">+         if (SecurityPolicy::shouldInheritSecurityOriginFromOwner(frame-&gt;document()-&gt;url()) || registrableDomain.matches(frame-&gt;document()-&gt;url()))</span>
              frame-&gt;document()-&gt;setSiteForCookies(url);
      }
  }
  
  // This does the same kind of work that didOpenURL does, except it relies on the fact
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1319,11 +1323,11 @@</span>
      documentLoader.setShouldOpenExternalURLsPolicy(shouldOpenExternalURLsPolicyToApply(frame, frameLoadRequest));
  }
  
  bool FrameLoader::isNavigationAllowed() const
  {
<span class="udiff-line-modified-removed">-     return m_pageDismissalEventBeingDispatched == PageDismissalType::None &amp;&amp; NavigationDisabler::isNavigationAllowed(m_frame);</span>
<span class="udiff-line-modified-added">+     return m_pageDismissalEventBeingDispatched == PageDismissalType::None &amp;&amp; !m_frame.script().willReplaceWithResultOfExecutingJavascriptURL() &amp;&amp; NavigationDisabler::isNavigationAllowed(m_frame);</span>
  }
  
  bool FrameLoader::isStopLoadingAllowed() const
  {
      return m_pageDismissalEventBeingDispatched == PageDismissalType::None;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1414,11 +1418,11 @@</span>
      bool isSystemPreview = frameLoadRequest.isSystemPreview();
      request.setSystemPreview(isSystemPreview);
      if (isSystemPreview)
          request.setSystemPreviewRect(frameLoadRequest.systemPreviewRect());
  #endif
<span class="udiff-line-modified-removed">-     loadWithNavigationAction(request, WTFMove(action), lockHistory, newLoadType, WTFMove(formState), allowNavigationToInvalidURL, [this, isRedirect, sameURL, newLoadType, protectedFrame = makeRef(m_frame), completionHandler = completionHandlerCaller.release()] () mutable {</span>
<span class="udiff-line-modified-added">+     loadWithNavigationAction(request, WTFMove(action), lockHistory, newLoadType, WTFMove(formState), allowNavigationToInvalidURL, frameLoadRequest.downloadAttribute(), [this, isRedirect, sameURL, newLoadType, protectedFrame = makeRef(m_frame), completionHandler = completionHandlerCaller.release()] () mutable {</span>
          if (isRedirect) {
              m_quickRedirectComing = false;
              if (m_provisionalDocumentLoader)
                  m_provisionalDocumentLoader-&gt;setIsClientRedirect(true);
              else if (m_policyDocumentLoader)
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1490,15 +1494,16 @@</span>
  
      SetForScope&lt;LoadContinuingState&gt; continuingLoadGuard(m_currentLoadContinuingState, request.shouldTreatAsContinuingLoad() ? LoadContinuingState::ContinuingWithRequest : LoadContinuingState::NotContinuing);
      load(loader.get());
  }
  
<span class="udiff-line-modified-removed">- void FrameLoader::loadWithNavigationAction(const ResourceRequest&amp; request, NavigationAction&amp;&amp; action, LockHistory lockHistory, FrameLoadType type, RefPtr&lt;FormState&gt;&amp;&amp; formState, AllowNavigationToInvalidURL allowNavigationToInvalidURL, CompletionHandler&lt;void()&gt;&amp;&amp; completionHandler)</span>
<span class="udiff-line-modified-added">+ void FrameLoader::loadWithNavigationAction(const ResourceRequest&amp; request, NavigationAction&amp;&amp; action, LockHistory lockHistory, FrameLoadType type, RefPtr&lt;FormState&gt;&amp;&amp; formState, AllowNavigationToInvalidURL allowNavigationToInvalidURL, const String&amp; downloadAttribute, CompletionHandler&lt;void()&gt;&amp;&amp; completionHandler)</span>
  {
      RELEASE_LOG_IF_ALLOWED(&quot;loadWithNavigationAction: frame load started (frame = %p, main = %d)&quot;, &amp;m_frame, m_frame.isMainFrame());
  
      Ref&lt;DocumentLoader&gt; loader = m_client.createDocumentLoader(request, defaultSubstituteDataForURL(request.url()));
<span class="udiff-line-added">+     loader-&gt;setDownloadAttribute(downloadAttribute);</span>
      applyShouldOpenExternalURLsPolicyToNewDocumentLoader(m_frame, loader, action.initiatedByMainFrame(), action.shouldOpenExternalURLsPolicy());
  
      if (lockHistory == LockHistory::Yes &amp;&amp; m_documentLoader)
          loader-&gt;setClientRedirectSourceForHistory(m_documentLoader-&gt;didCreateGlobalHistoryEntry() ? m_documentLoader-&gt;urlForHistory().string() : m_documentLoader-&gt;clientRedirectSourceForHistory());
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -1801,16 +1806,16 @@</span>
      };
  
      loadWithDocumentLoader(loader.ptr(), frameLoadTypeForReloadOptions(options), { }, AllowNavigationToInvalidURL::Yes, ShouldTreatAsContinuingLoad::No);
  }
  
<span class="udiff-line-modified-removed">- void FrameLoader::stopAllLoaders(ClearProvisionalItemPolicy clearProvisionalItemPolicy)</span>
<span class="udiff-line-modified-added">+ void FrameLoader::stopAllLoaders(ClearProvisionalItemPolicy clearProvisionalItemPolicy, StopLoadingPolicy stopLoadingPolicy)</span>
  {
      if (m_frame.document() &amp;&amp; m_frame.document()-&gt;pageCacheState() == Document::InPageCache)
          return;
  
<span class="udiff-line-modified-removed">-     if (!isStopLoadingAllowed())</span>
<span class="udiff-line-modified-added">+     if (stopLoadingPolicy == StopLoadingPolicy::PreventDuringUnloadEvents &amp;&amp; !isStopLoadingAllowed())</span>
          return;
  
      // If this method is called from within this method, infinite recursion can occur (3442218). Avoid this.
      if (m_inStopAllLoaders)
          return;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -2291,22 +2296,22 @@</span>
      // FIXME: I suspect this block of code doesn&#39;t do anything.
      if (url.protocolIsInHTTPFamily() &amp;&amp; !url.host().isEmpty() &amp;&amp; url.path().isEmpty())
          url.setPath(&quot;/&quot;);
  
      started();
<span class="udiff-line-modified-removed">-     Document* document = cachedFrame.document();</span>
<span class="udiff-line-removed">-     ASSERT(document);</span>
<span class="udiff-line-modified-added">+     auto document = makeRef(*cachedFrame.document());</span>
      ASSERT(document-&gt;domWindow());
  
<span class="udiff-line-modified-removed">-     clear(document, true, true, cachedFrame.isMainFrame());</span>
<span class="udiff-line-modified-added">+     clear(document.ptr(), true, true, cachedFrame.isMainFrame());</span>
  
<span class="udiff-line-added">+     document-&gt;attachToCachedFrame(cachedFrame);</span>
      document-&gt;setPageCacheState(Document::NotInPageCache);
  
      m_needsClear = true;
      m_isComplete = false;
      m_didCallImplicitClose = false;
<span class="udiff-line-modified-removed">-     m_outgoingReferrer = url.string();</span>
<span class="udiff-line-modified-added">+     setOutgoingReferrer(url);</span>
  
      FrameView* view = cachedFrame.view();
  
      // When navigating to a CachedFrame its FrameView should never be null.  If it is we&#39;ll crash in creative ways downstream.
      ASSERT(view);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -2317,17 +2322,19 @@</span>
  
      // Use the previous ScrollView&#39;s frame rect.
      if (previousViewFrameRect)
          view-&gt;setFrameRect(previousViewFrameRect.value());
  
<span class="udiff-line-modified-removed">-     {</span>
<span class="udiff-line-modified-removed">-         // Setting the document builds the render tree and runs post style resolution callbacks that can do anything,</span>
<span class="udiff-line-modified-removed">-         // including loading a child frame before its been re-attached to the frame tree as part of this restore.</span>
<span class="udiff-line-modified-removed">-         // For example, the HTML object element may load its content into a frame in a post style resolution callback.</span>
<span class="udiff-line-modified-removed">-         NavigationDisabler disableNavigation { &amp;m_frame };</span>
<span class="udiff-line-modified-removed">-         m_frame.setDocument(document);</span>
<span class="udiff-line-modified-removed">-     }</span>
<span class="udiff-line-modified-added">+ </span>
<span class="udiff-line-modified-added">+     // Setting the document builds the render tree and runs post style resolution callbacks that can do anything,</span>
<span class="udiff-line-modified-added">+     // including loading a child frame before its been re-attached to the frame tree as part of this restore.</span>
<span class="udiff-line-modified-added">+     // For example, the HTML object element may load its content into a frame in a post style resolution callback.</span>
<span class="udiff-line-modified-added">+     Style::PostResolutionCallbackDisabler disabler(document.get());</span>
<span class="udiff-line-modified-added">+     WidgetHierarchyUpdatesSuspensionScope suspendWidgetHierarchyUpdates;</span>
<span class="udiff-line-modified-added">+     NavigationDisabler disableNavigation { &amp;m_frame };</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     m_frame.setDocument(document.copyRef());</span>
  
      document-&gt;domWindow()-&gt;resumeFromPageCache();
  
      updateFirstPartyForCookies();
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -2421,10 +2428,39 @@</span>
  
      RELEASE_ASSERT_NOT_REACHED();
      return CachePolicyVerify;
  }
  
<span class="udiff-line-added">+ void FrameLoader::dispatchDidFailProvisionalLoad(DocumentLoader&amp; provisionalDocumentLoader, const ResourceError&amp; error)</span>
<span class="udiff-line-added">+ {</span>
<span class="udiff-line-added">+     m_provisionalLoadErrorBeingHandledURL = provisionalDocumentLoader.url();</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ #if ENABLE(CONTENT_FILTERING)</span>
<span class="udiff-line-added">+     auto contentFilter = provisionalDocumentLoader.contentFilter();</span>
<span class="udiff-line-added">+     auto contentFilterWillContinueLoading = false;</span>
<span class="udiff-line-added">+ #endif</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     auto willContinueLoading = WillContinueLoading::No;</span>
<span class="udiff-line-added">+     if (history().provisionalItem())</span>
<span class="udiff-line-added">+         willContinueLoading = WillContinueLoading::Yes;</span>
<span class="udiff-line-added">+ #if ENABLE(CONTENT_FILTERING)</span>
<span class="udiff-line-added">+     if (contentFilter &amp;&amp; contentFilter-&gt;willHandleProvisionalLoadFailure(error)) {</span>
<span class="udiff-line-added">+         willContinueLoading = WillContinueLoading::Yes;</span>
<span class="udiff-line-added">+         contentFilterWillContinueLoading = true;</span>
<span class="udiff-line-added">+     }</span>
<span class="udiff-line-added">+ #endif</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     m_client.dispatchDidFailProvisionalLoad(error, willContinueLoading);</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+ #if ENABLE(CONTENT_FILTERING)</span>
<span class="udiff-line-added">+     if (contentFilterWillContinueLoading)</span>
<span class="udiff-line-added">+         contentFilter-&gt;handleProvisionalLoadFailure(error);</span>
<span class="udiff-line-added">+ #endif</span>
<span class="udiff-line-added">+ </span>
<span class="udiff-line-added">+     m_provisionalLoadErrorBeingHandledURL = { };</span>
<span class="udiff-line-added">+ }</span>
<span class="udiff-line-added">+ </span>
  void FrameLoader::checkLoadCompleteForThisFrame()
  {
      ASSERT(m_client.hasWebView());
  
      // FIXME: Should this check be done in checkLoadComplete instead of here?
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -2459,18 +2495,12 @@</span>
  
              // Only reset if we aren&#39;t already going to a new provisional item.
              bool shouldReset = !history().provisionalItem();
              if (!pdl-&gt;isLoadingInAPISense() || pdl-&gt;isStopping()) {
                  RELEASE_LOG_IF_ALLOWED(&quot;checkLoadCompleteForThisFrame: Failed provisional load (frame = %p, main = %d, isTimeout = %d, isCancellation = %d, errorCode = %d)&quot;, &amp;m_frame, m_frame.isMainFrame(), error.isTimeout(), error.isCancellation(), error.errorCode());
<span class="udiff-line-removed">-                 m_provisionalLoadErrorBeingHandledURL = m_provisionalDocumentLoader-&gt;url();</span>
<span class="udiff-line-removed">-                 m_client.dispatchDidFailProvisionalLoad(error);</span>
<span class="udiff-line-removed">- #if ENABLE(CONTENT_FILTERING)</span>
<span class="udiff-line-removed">-                 if (auto contentFilter = pdl-&gt;contentFilter())</span>
<span class="udiff-line-removed">-                     contentFilter-&gt;handleProvisionalLoadFailure(error);</span>
<span class="udiff-line-removed">- #endif</span>
<span class="udiff-line-removed">-                 m_provisionalLoadErrorBeingHandledURL = { };</span>
  
<span class="udiff-line-added">+                 dispatchDidFailProvisionalLoad(*pdl, error);</span>
                  ASSERT(!pdl-&gt;isLoading());
  
                  // If we&#39;re in the middle of loading multipart data, we need to restore the document loader.
                  if (isReplacing() &amp;&amp; !m_documentLoader.get())
                      setDocumentLoader(m_provisionalDocumentLoader.get());
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -2641,10 +2671,17 @@</span>
      // HTML specification states that the parent document&#39;s ignore-opens-during-unload counter while
      // this event is being fired in its subframes:
      // https://html.spec.whatwg.org/multipage/browsers.html#unload-a-document
      IgnoreOpensDuringUnloadCountIncrementer ignoreOpensDuringUnloadCountIncrementer(m_frame.document());
  
<span class="udiff-line-added">+     // detachChildren() will fire the unload event in each subframe and the</span>
<span class="udiff-line-added">+     // HTML specification states that navigations should be prevented during the prompt to unload algorithm:</span>
<span class="udiff-line-added">+     // https://html.spec.whatwg.org/multipage/browsing-the-web.html#navigate</span>
<span class="udiff-line-added">+     std::unique_ptr&lt;NavigationDisabler&gt; navigationDisabler;</span>
<span class="udiff-line-added">+     if (m_frame.isMainFrame())</span>
<span class="udiff-line-added">+         navigationDisabler = makeUnique&lt;NavigationDisabler&gt;(&amp;m_frame);</span>
<span class="udiff-line-added">+ </span>
      // Any subframe inserted by unload event handlers executed in the loop below will not get unloaded
      // because we create a copy of the subframes list before looping. Therefore, it would be unsafe to
      // allow loading of subframes at this point.
      SubframeLoadingDisabler subframeLoadingDisabler(m_frame.document());
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -2783,11 +2820,11 @@</span>
      detachChildren();
      if (m_frame.document()-&gt;pageCacheState() != Document::InPageCache) {
          // stopAllLoaders() needs to be called after detachChildren() if the document is not in the page cache,
          // because detachedChildren() will trigger the unload event handlers of any child frames, and those event
          // handlers might start a new subresource load in this frame.
<span class="udiff-line-modified-removed">-         stopAllLoaders();</span>
<span class="udiff-line-modified-added">+         stopAllLoaders(ShouldClearProvisionalItem, StopLoadingPolicy::AlwaysStopLoading);</span>
      }
  
      InspectorInstrumentation::frameDetachedFromParent(m_frame);
  
      detachViewsAndDocumentLoader();
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -2969,11 +3006,11 @@</span>
      }
      if (SecurityPolicy::shouldInheritSecurityOriginFromOwner(request.url())) {
          request.setIsSameSite(true);
          return;
      }
<span class="udiff-line-modified-removed">-     request.setIsSameSite(registrableDomainsAreEqual(initiator-&gt;siteForCookies(), request.url()));</span>
<span class="udiff-line-modified-added">+     request.setIsSameSite(areRegistrableDomainsEqual(initiator-&gt;siteForCookies(), request.url()));</span>
  }
  
  void FrameLoader::addHTTPUpgradeInsecureRequestsIfNeeded(ResourceRequest&amp; request)
  {
      if (request.url().protocolIs(&quot;https&quot;)) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -3014,11 +3051,11 @@</span>
      NavigationAction action { request.requester(), workingResourceRequest, request.initiatedByMainFrame(), loadType, true, event, request.shouldOpenExternalURLsPolicy(), request.downloadAttribute() };
  
      if (!frameName.isEmpty()) {
          // The search for a target frame is done earlier in the case of form submission.
          if (auto* targetFrame = formState ? nullptr : findFrameForNavigation(frameName)) {
<span class="udiff-line-modified-removed">-             targetFrame-&gt;loader().loadWithNavigationAction(workingResourceRequest, WTFMove(action), lockHistory, loadType, WTFMove(formState), allowNavigationToInvalidURL, WTFMove(completionHandler));</span>
<span class="udiff-line-modified-added">+             targetFrame-&gt;loader().loadWithNavigationAction(workingResourceRequest, WTFMove(action), lockHistory, loadType, WTFMove(formState), allowNavigationToInvalidURL, { }, WTFMove(completionHandler));</span>
              return;
          }
  
          policyChecker().checkNewWindowPolicy(WTFMove(action), WTFMove(workingResourceRequest), WTFMove(formState), frameName, [this, allowNavigationToInvalidURL, openerPolicy, completionHandler = WTFMove(completionHandler)] (const ResourceRequest&amp; request, WeakPtr&lt;FormState&gt;&amp;&amp; formState, const String&amp; frameName, const NavigationAction&amp; action, ShouldContinue shouldContinue) mutable {
              continueLoadAfterNewWindowPolicy(request, formState.get(), frameName, action, shouldContinue, allowNavigationToInvalidURL, openerPolicy);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -3027,11 +3064,11 @@</span>
          return;
      }
  
      // must grab this now, since this load may stop the previous load and clear this flag
      bool isRedirect = m_quickRedirectComing;
<span class="udiff-line-modified-removed">-     loadWithNavigationAction(workingResourceRequest, WTFMove(action), lockHistory, loadType, WTFMove(formState), allowNavigationToInvalidURL, [this, isRedirect, protectedFrame = makeRef(m_frame), completionHandler = WTFMove(completionHandler)] () mutable {</span>
<span class="udiff-line-modified-added">+     loadWithNavigationAction(workingResourceRequest, WTFMove(action), lockHistory, loadType, WTFMove(formState), allowNavigationToInvalidURL, { }, [this, isRedirect, protectedFrame = makeRef(m_frame), completionHandler = WTFMove(completionHandler)] () mutable {</span>
          if (isRedirect) {
              m_quickRedirectComing = false;
              if (m_provisionalDocumentLoader)
                  m_provisionalDocumentLoader-&gt;setIsClientRedirect(true);
              else if (m_policyDocumentLoader)
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -3063,13 +3100,14 @@</span>
  
  #if ENABLE(CONTENT_EXTENSIONS)
      if (error.isNull()) {
          if (auto* page = m_frame.page()) {
              if (m_documentLoader) {
<span class="udiff-line-modified-removed">-                 auto blockedStatus = page-&gt;userContentProvider().processContentExtensionRulesForLoad(newRequest.url(), ResourceType::Raw, *m_documentLoader);</span>
<span class="udiff-line-modified-removed">-                 applyBlockedStatusToRequest(blockedStatus, page, newRequest);</span>
<span class="udiff-line-modified-removed">-                 if (blockedStatus.blockedLoad) {</span>
<span class="udiff-line-modified-added">+                 auto results = page-&gt;userContentProvider().processContentRuleListsForLoad(newRequest.url(), ContentExtensions::ResourceType::Raw, *m_documentLoader);</span>
<span class="udiff-line-modified-added">+                 bool blockedLoad = results.summary.blockedLoad;</span>
<span class="udiff-line-modified-added">+                 ContentExtensions::applyResultsToRequest(WTFMove(results), page, newRequest);</span>
<span class="udiff-line-added">+                 if (blockedLoad) {</span>
                      newRequest = { };
                      error = ResourceError(errorDomainWebKitInternal, 0, initialRequest.url(), emptyString());
                      response = { };
                      data = nullptr;
                  }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -3235,10 +3273,13 @@</span>
  void FrameLoader::dispatchUnloadEvents(UnloadEventPolicy unloadEventPolicy)
  {
      if (!m_frame.document())
          return;
  
<span class="udiff-line-added">+     if (m_pageDismissalEventBeingDispatched != PageDismissalType::None)</span>
<span class="udiff-line-added">+         return;</span>
<span class="udiff-line-added">+ </span>
      // We store the frame&#39;s page in a local variable because the frame might get detached inside dispatchEvent.
      ForbidPromptsScope forbidPrompts(m_frame.page());
      IgnoreOpensDuringUnloadCountIncrementer ignoreOpensDuringUnloadCountIncrementer(m_frame.document());
  
      if (m_didCallImplicitClose &amp;&amp; !m_wasUnloadEventEmitted) {
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -3313,19 +3354,17 @@</span>
      RefPtr&lt;Document&gt; document = m_frame.document();
      if (!document-&gt;bodyOrFrameset())
          return true;
  
      Ref&lt;BeforeUnloadEvent&gt; beforeUnloadEvent = BeforeUnloadEvent::create();
<span class="udiff-line-removed">-     m_pageDismissalEventBeingDispatched = PageDismissalType::BeforeUnload;</span>
  
      {
<span class="udiff-line-added">+         SetForScope&lt;PageDismissalType&gt; change(m_pageDismissalEventBeingDispatched, PageDismissalType::BeforeUnload);</span>
          ForbidPromptsScope forbidPrompts(m_frame.page());
          domWindow-&gt;dispatchEvent(beforeUnloadEvent, domWindow-&gt;document());
      }
  
<span class="udiff-line-removed">-     m_pageDismissalEventBeingDispatched = PageDismissalType::None;</span>
<span class="udiff-line-removed">- </span>
      if (!beforeUnloadEvent-&gt;defaultPrevented())
          document-&gt;defaultEventHandler(beforeUnloadEvent.get());
  
      if (!shouldAskForNavigationConfirmation(*document, beforeUnloadEvent))
          return true;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -3438,11 +3477,11 @@</span>
  
      setPolicyDocumentLoader(nullptr);
  
      if (isBackForwardLoadType(type)) {
          auto&amp; diagnosticLoggingClient = m_frame.page()-&gt;diagnosticLoggingClient();
<span class="udiff-line-modified-removed">-         if (history().provisionalItem()-&gt;isInPageCache()) {</span>
<span class="udiff-line-modified-added">+         if (history().provisionalItem() &amp;&amp; history().provisionalItem()-&gt;isInPageCache()) {</span>
              diagnosticLoggingClient.logDiagnosticMessageWithResult(DiagnosticLoggingKeys::pageCacheKey(), DiagnosticLoggingKeys::retrievalKey(), DiagnosticLoggingResultPass, ShouldSample::Yes);
              loadProvisionalItemFromCachedPage();
              RELEASE_LOG_IF_ALLOWED(&quot;continueLoadAfterNavigationPolicy: can&#39;t continue loading frame because it will be loaded from cache (frame = %p, main = %d)&quot;, &amp;m_frame, m_frame.isMainFrame());
              return;
          }
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -3647,11 +3686,11 @@</span>
      if (!ownerElement-&gt;hasTagName(iframeTag))
          return false;
      return ownerElement-&gt;hasAttributeWithoutSynchronization(srcdocAttr);
  }
  
<span class="udiff-line-modified-removed">- Frame* FrameLoader::findFrameForNavigation(const AtomicString&amp; name, Document* activeDocument)</span>
<span class="udiff-line-modified-added">+ Frame* FrameLoader::findFrameForNavigation(const AtomString&amp; name, Document* activeDocument)</span>
  {
      // FIXME: Eventually all callers should supply the actual activeDocument so we can call canNavigate with the right document.
      if (!activeDocument)
          activeDocument = m_frame.document();
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -3685,11 +3724,11 @@</span>
  }
  
  // FIXME: This function should really be split into a couple pieces, some of
  // which should be methods of HistoryController and some of which should be
  // methods of FrameLoader.
<span class="udiff-line-modified-removed">- void FrameLoader::loadDifferentDocumentItem(HistoryItem&amp; item, FrameLoadType loadType, FormSubmissionCacheLoadPolicy cacheLoadPolicy, ShouldTreatAsContinuingLoad shouldTreatAsContinuingLoad)</span>
<span class="udiff-line-modified-added">+ void FrameLoader::loadDifferentDocumentItem(HistoryItem&amp; item, HistoryItem* fromItem, FrameLoadType loadType, FormSubmissionCacheLoadPolicy cacheLoadPolicy, ShouldTreatAsContinuingLoad shouldTreatAsContinuingLoad)</span>
  {
      RELEASE_LOG_IF_ALLOWED(&quot;loadDifferentDocumentItem: frame load started (frame = %p, main = %d)&quot;, &amp;m_frame, m_frame.isMainFrame());
  
      Ref&lt;Frame&gt; protectedFrame(m_frame);
  
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -3707,10 +3746,11 @@</span>
          auto documentLoader = cachedPage-&gt;documentLoader();
          m_client.updateCachedDocumentLoader(*documentLoader);
  
          auto action = NavigationAction { *m_frame.document(), documentLoader-&gt;request(), initiatedByMainFrame, loadType, false };
          action.setTargetBackForwardItem(item);
<span class="udiff-line-added">+         action.setSourceBackForwardItem(fromItem);</span>
          documentLoader-&gt;setTriggeringAction(WTFMove(action));
  
          documentLoader-&gt;setLastCheckedRequest(ResourceRequest());
          loadWithDocumentLoader(documentLoader, loadType, { }, AllowNavigationToInvalidURL::Yes, shouldTreatAsContinuingLoad);
          return;
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -3733,12 +3773,10 @@</span>
      Event* event = nullptr;
  
      // If this was a repost that failed the page cache, we might try to repost the form.
      NavigationAction action;
      if (formData) {
<span class="udiff-line-removed">-         formData-&gt;generateFiles(m_frame.document());</span>
<span class="udiff-line-removed">- </span>
          request.setHTTPMethod(&quot;POST&quot;);
          request.setHTTPBody(WTFMove(formData));
          request.setHTTPContentType(item.formContentType());
          auto securityOrigin = SecurityOrigin::createFromString(item.referrer());
          addHTTPOriginIfNeeded(request, securityOrigin-&gt;toString());
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -3797,25 +3835,26 @@</span>
          requestForOriginalURL.setURL(itemOriginalURL);
          action = { *m_frame.document(), requestForOriginalURL, initiatedByMainFrame, loadType, isFormSubmission, event, shouldOpenExternalURLsPolicy };
      }
  
      action.setTargetBackForwardItem(item);
<span class="udiff-line-added">+     action.setSourceBackForwardItem(fromItem);</span>
  
      loadWithNavigationAction(request, WTFMove(action), LockHistory::No, loadType, { }, AllowNavigationToInvalidURL::Yes);
  }
  
  // Loads content into this frame, as specified by history item
<span class="udiff-line-modified-removed">- void FrameLoader::loadItem(HistoryItem&amp; item, FrameLoadType loadType, ShouldTreatAsContinuingLoad shouldTreatAsContinuingLoad)</span>
<span class="udiff-line-modified-added">+ void FrameLoader::loadItem(HistoryItem&amp; item, HistoryItem* fromItem, FrameLoadType loadType, ShouldTreatAsContinuingLoad shouldTreatAsContinuingLoad)</span>
  {
      m_requestedHistoryItem = &amp;item;
      HistoryItem* currentItem = history().currentItem();
      bool sameDocumentNavigation = currentItem &amp;&amp; item.shouldDoSameDocumentNavigationTo(*currentItem);
  
      if (sameDocumentNavigation)
          loadSameDocumentItem(item);
      else
<span class="udiff-line-modified-removed">-         loadDifferentDocumentItem(item, loadType, MayAttemptCacheOnlyLoadForFormSubmissionItem, shouldTreatAsContinuingLoad);</span>
<span class="udiff-line-modified-added">+         loadDifferentDocumentItem(item, fromItem, loadType, MayAttemptCacheOnlyLoadForFormSubmissionItem, shouldTreatAsContinuingLoad);</span>
  }
  
  void FrameLoader::retryAfterFailedCacheOnlyMainResourceLoad()
  {
      ASSERT(m_state == FrameStateProvisional);
</pre>
<hr />
<pre>
<span class="line-new-header">@@ -3823,14 +3862,19 @@</span>
      ASSERT(history().provisionalItem());
      ASSERT(history().provisionalItem()-&gt;formData());
      ASSERT(history().provisionalItem() == m_requestedHistoryItem.get());
  
      FrameLoadType loadType = m_loadType;
<span class="udiff-line-modified-removed">-     HistoryItem&amp; item = *history().provisionalItem();</span>
<span class="udiff-line-modified-added">+     HistoryItem* item = history().provisionalItem();</span>
  
      stopAllLoaders(ShouldNotClearProvisionalItem);
<span class="udiff-line-modified-removed">-     loadDifferentDocumentItem(item, loadType, MayNotAttemptCacheOnlyLoadForFormSubmissionItem, ShouldTreatAsContinuingLoad::No);</span>
<span class="udiff-line-modified-added">+     if (item)</span>
<span class="udiff-line-added">+         loadDifferentDocumentItem(*item, history().currentItem(), loadType, MayNotAttemptCacheOnlyLoadForFormSubmissionItem, ShouldTreatAsContinuingLoad::No);</span>
<span class="udiff-line-added">+     else {</span>
<span class="udiff-line-added">+         ASSERT_NOT_REACHED();</span>
<span class="udiff-line-added">+         RELEASE_LOG_ERROR(ResourceLoading, &quot;Retrying load after failed cache-only main resource load failed because there is no provisional history item.&quot;);</span>
<span class="udiff-line-added">+     }</span>
  }
  
  ResourceError FrameLoader::cancelledError(const ResourceRequest&amp; request) const
  {
      ResourceError error = m_client.cancelledError(request);
</pre>
<center><a href="FrameLoadRequest.h.udiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="FrameLoader.h.udiff.html" target="_top">next &gt;</a></center>  </body>
</html>