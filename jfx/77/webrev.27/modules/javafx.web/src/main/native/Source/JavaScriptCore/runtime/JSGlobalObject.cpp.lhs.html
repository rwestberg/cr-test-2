<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames modules/javafx.web/src/main/native/Source/JavaScriptCore/runtime/JSGlobalObject.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>   1 /*
   2  * Copyright (C) 2007-2019 Apple Inc. All rights reserved.
   3  * Copyright (C) 2008 Cameron Zwarich (cwzwarich@uwaterloo.ca)
   4  *
   5  * Redistribution and use in source and binary forms, with or without
   6  * modification, are permitted provided that the following conditions
   7  * are met:
   8  *
   9  * 1.  Redistributions of source code must retain the above copyright
  10  *     notice, this list of conditions and the following disclaimer.
  11  * 2.  Redistributions in binary form must reproduce the above copyright
  12  *     notice, this list of conditions and the following disclaimer in the
  13  *     documentation and/or other materials provided with the distribution.
  14  * 3.  Neither the name of Apple Inc. (&quot;Apple&quot;) nor the names of
  15  *     its contributors may be used to endorse or promote products derived
  16  *     from this software without specific prior written permission.
  17  *
  18  * THIS SOFTWARE IS PROVIDED BY APPLE AND ITS CONTRIBUTORS &quot;AS IS&quot; AND ANY
  19  * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
  20  * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
  21  * DISCLAIMED. IN NO EVENT SHALL APPLE OR ITS CONTRIBUTORS BE LIABLE FOR ANY
  22  * DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
  23  * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
  24  * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
  25  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
  26  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF
  27  * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
  28  */
  29 
  30 #include &quot;config.h&quot;
  31 #include &quot;JSGlobalObject.h&quot;
  32 
  33 #include &quot;ArrayConstructor.h&quot;
  34 #include &quot;ArrayIteratorPrototype.h&quot;
  35 #include &quot;ArrayPrototype.h&quot;
  36 #include &quot;AsyncFromSyncIteratorPrototype.h&quot;
  37 #include &quot;AtomicsObject.h&quot;
  38 #include &quot;AsyncFunctionConstructor.h&quot;
  39 #include &quot;AsyncFunctionPrototype.h&quot;
  40 #include &quot;AsyncGeneratorFunctionConstructor.h&quot;
  41 #include &quot;AsyncGeneratorFunctionPrototype.h&quot;
  42 #include &quot;AsyncGeneratorPrototype.h&quot;
  43 #include &quot;AsyncIteratorPrototype.h&quot;
  44 #include &quot;BigIntConstructor.h&quot;
  45 #include &quot;BigIntObject.h&quot;
  46 #include &quot;BigIntPrototype.h&quot;
  47 #include &quot;BooleanConstructor.h&quot;
  48 #include &quot;BooleanPrototype.h&quot;
  49 #include &quot;BuiltinNames.h&quot;
  50 #include &quot;CatchScope.h&quot;
  51 #include &quot;ClonedArguments.h&quot;
  52 #include &quot;CodeBlock.h&quot;
  53 #include &quot;CodeBlockSetInlines.h&quot;
  54 #include &quot;CodeCache.h&quot;
  55 #include &quot;ConsoleObject.h&quot;
  56 #include &quot;DateConstructor.h&quot;
  57 #include &quot;DatePrototype.h&quot;
  58 #include &quot;Debugger.h&quot;
  59 #include &quot;DebuggerScope.h&quot;
  60 #include &quot;DirectArguments.h&quot;
  61 #include &quot;DirectEvalExecutable.h&quot;
  62 #include &quot;ECMAScriptSpecInternalFunctions.h&quot;
  63 #include &quot;Error.h&quot;
  64 #include &quot;ErrorConstructor.h&quot;
  65 #include &quot;ErrorPrototype.h&quot;
  66 #include &quot;Exception.h&quot;
  67 #include &quot;FunctionConstructor.h&quot;
  68 #include &quot;FunctionPrototype.h&quot;
  69 #include &quot;GeneratorFunctionConstructor.h&quot;
  70 #include &quot;GeneratorFunctionPrototype.h&quot;
  71 #include &quot;GeneratorPrototype.h&quot;
  72 #include &quot;GetterSetter.h&quot;
  73 #include &quot;HeapIterationScope.h&quot;
  74 #include &quot;IndirectEvalExecutable.h&quot;
  75 #include &quot;InspectorInstrumentationObject.h&quot;
  76 #include &quot;Interpreter.h&quot;
  77 #include &quot;IteratorPrototype.h&quot;
  78 #include &quot;JSAPIWrapperObject.h&quot;
  79 #include &quot;JSArrayBuffer.h&quot;
  80 #include &quot;JSArrayBufferConstructor.h&quot;
  81 #include &quot;JSArrayBufferPrototype.h&quot;
  82 #include &quot;JSAsyncFunction.h&quot;
  83 #include &quot;JSAsyncGeneratorFunction.h&quot;
  84 #include &quot;JSBigInt.h&quot;
  85 #include &quot;JSBoundFunction.h&quot;
  86 #include &quot;JSCInlines.h&quot;
  87 #include &quot;JSCallbackConstructor.h&quot;
  88 #include &quot;JSCallbackFunction.h&quot;
  89 #include &quot;JSCallbackObject.h&quot;
  90 #include &quot;JSCustomGetterSetterFunction.h&quot;
  91 #include &quot;JSDataView.h&quot;
  92 #include &quot;JSDataViewPrototype.h&quot;
  93 #include &quot;JSDollarVM.h&quot;
  94 #include &quot;JSFunction.h&quot;
  95 #include &quot;JSGeneratorFunction.h&quot;
  96 #include &quot;JSGenericTypedArrayViewConstructorInlines.h&quot;
  97 #include &quot;JSGenericTypedArrayViewInlines.h&quot;
  98 #include &quot;JSGenericTypedArrayViewPrototypeInlines.h&quot;
  99 #include &quot;JSGlobalObjectFunctions.h&quot;
 100 #include &quot;JSInternalPromise.h&quot;
 101 #include &quot;JSInternalPromiseConstructor.h&quot;
 102 #include &quot;JSInternalPromisePrototype.h&quot;
 103 #include &quot;JSLexicalEnvironment.h&quot;
 104 #include &quot;JSLock.h&quot;
 105 #include &quot;JSMap.h&quot;
 106 #include &quot;JSMicrotask.h&quot;
 107 #include &quot;JSModuleEnvironment.h&quot;
 108 #include &quot;JSModuleLoader.h&quot;
 109 #include &quot;JSModuleNamespaceObject.h&quot;
 110 #include &quot;JSModuleRecord.h&quot;
 111 #include &quot;JSNativeStdFunction.h&quot;
 112 #include &quot;JSNonDestructibleProxy.h&quot;
 113 #include &quot;JSONObject.h&quot;
 114 #include &quot;JSPromise.h&quot;
 115 #include &quot;JSPromiseConstructor.h&quot;
 116 #include &quot;JSPromisePrototype.h&quot;
 117 #include &quot;JSSet.h&quot;
 118 #include &quot;JSStringIterator.h&quot;
 119 #include &quot;JSTypedArrayConstructors.h&quot;
 120 #include &quot;JSTypedArrayPrototypes.h&quot;
 121 #include &quot;JSTypedArrayViewConstructor.h&quot;
 122 #include &quot;JSTypedArrayViewPrototype.h&quot;
 123 #include &quot;JSTypedArrays.h&quot;
 124 #include &quot;JSWeakMap.h&quot;
<a name="1" id="anc1"></a>
 125 #include &quot;JSWeakSet.h&quot;
 126 #include &quot;JSWebAssembly.h&quot;
<a name="2" id="anc2"></a>






 127 #include &quot;JSWithScope.h&quot;
 128 #include &quot;LazyClassStructureInlines.h&quot;
 129 #include &quot;LazyPropertyInlines.h&quot;
 130 #include &quot;Lookup.h&quot;
 131 #include &quot;MapConstructor.h&quot;
 132 #include &quot;MapIteratorPrototype.h&quot;
 133 #include &quot;MapPrototype.h&quot;
 134 #include &quot;MarkedSpaceInlines.h&quot;
 135 #include &quot;MathObject.h&quot;
 136 #include &quot;Microtask.h&quot;
 137 #include &quot;NativeErrorConstructor.h&quot;
 138 #include &quot;NativeErrorPrototype.h&quot;
 139 #include &quot;NullGetterFunction.h&quot;
 140 #include &quot;NullSetterFunction.h&quot;
 141 #include &quot;NumberConstructor.h&quot;
 142 #include &quot;NumberPrototype.h&quot;
 143 #include &quot;ObjCCallbackFunction.h&quot;
 144 #include &quot;ObjectConstructor.h&quot;
 145 #include &quot;ObjectPropertyChangeAdaptiveWatchpoint.h&quot;
 146 #include &quot;ObjectPropertyConditionSet.h&quot;
 147 #include &quot;ObjectPrototype.h&quot;
 148 #include &quot;ParserError.h&quot;
 149 #include &quot;ProxyConstructor.h&quot;
 150 #include &quot;ProxyObject.h&quot;
 151 #include &quot;ProxyRevoke.h&quot;
 152 #include &quot;ReflectObject.h&quot;
 153 #include &quot;RegExpCache.h&quot;
 154 #include &quot;RegExpConstructor.h&quot;
 155 #include &quot;RegExpMatchesArray.h&quot;
 156 #include &quot;RegExpObject.h&quot;
 157 #include &quot;RegExpPrototype.h&quot;
<a name="3" id="anc3"></a>
 158 #include &quot;ScopedArguments.h&quot;
 159 #include &quot;SetConstructor.h&quot;
 160 #include &quot;SetIteratorPrototype.h&quot;
 161 #include &quot;SetPrototype.h&quot;
 162 #include &quot;StrictEvalActivation.h&quot;
 163 #include &quot;StringConstructor.h&quot;
 164 #include &quot;StringIteratorPrototype.h&quot;
 165 #include &quot;StringPrototype.h&quot;
 166 #include &quot;Symbol.h&quot;
 167 #include &quot;SymbolConstructor.h&quot;
 168 #include &quot;SymbolObject.h&quot;
 169 #include &quot;SymbolPrototype.h&quot;
 170 #include &quot;VariableWriteFireDetail.h&quot;
<a name="4" id="anc4"></a>
 171 #include &quot;WeakGCMapInlines.h&quot;
 172 #include &quot;WeakMapConstructor.h&quot;
 173 #include &quot;WeakMapPrototype.h&quot;
<a name="5" id="anc5"></a>

 174 #include &quot;WeakSetConstructor.h&quot;
 175 #include &quot;WeakSetPrototype.h&quot;
<a name="6" id="anc6"></a><span class="line-modified"> 176 #include &quot;WebAssemblyPrototype.h&quot;</span>















 177 #include &quot;WebAssemblyToJSCallee.h&quot;
 178 #include &lt;wtf/RandomNumber.h&gt;
 179 
 180 #if ENABLE(INTL)
 181 #include &quot;IntlCollator.h&quot;
 182 #include &quot;IntlCollatorPrototype.h&quot;
 183 #include &quot;IntlDateTimeFormat.h&quot;
 184 #include &quot;IntlDateTimeFormatPrototype.h&quot;
 185 #include &quot;IntlNumberFormat.h&quot;
 186 #include &quot;IntlNumberFormatPrototype.h&quot;
 187 #include &quot;IntlObject.h&quot;
 188 #include &quot;IntlPluralRules.h&quot;
 189 #include &quot;IntlPluralRulesPrototype.h&quot;
 190 #include &lt;unicode/ucol.h&gt;
 191 #include &lt;unicode/udat.h&gt;
 192 #include &lt;unicode/unum.h&gt;
 193 #endif // ENABLE(INTL)
 194 
 195 #if ENABLE(REMOTE_INSPECTOR)
 196 #include &quot;JSGlobalObjectDebuggable.h&quot;
 197 #include &quot;JSGlobalObjectInspectorController.h&quot;
 198 #endif
 199 
 200 #ifdef JSC_GLIB_API_ENABLED
 201 #include &quot;JSCCallbackFunction.h&quot;
 202 #include &quot;JSCWrapperMap.h&quot;
 203 #endif
 204 
 205 namespace JSC {
 206 
<a name="7" id="anc7"></a>






 207 static JSValue createProxyProperty(VM&amp; vm, JSObject* object)
 208 {
 209     JSGlobalObject* global = jsCast&lt;JSGlobalObject*&gt;(object);
 210     return ProxyConstructor::create(vm, ProxyConstructor::createStructure(vm, global, global-&gt;functionPrototype()));
 211 }
 212 
 213 static JSValue createJSONProperty(VM&amp; vm, JSObject* object)
 214 {
 215     JSGlobalObject* global = jsCast&lt;JSGlobalObject*&gt;(object);
 216     return JSONObject::create(vm, JSONObject::createStructure(vm, global, global-&gt;objectPrototype()));
 217 }
 218 
 219 static JSValue createMathProperty(VM&amp; vm, JSObject* object)
 220 {
 221     JSGlobalObject* global = jsCast&lt;JSGlobalObject*&gt;(object);
 222     return MathObject::create(vm, global, MathObject::createStructure(vm, global, global-&gt;objectPrototype()));
 223 }
 224 
<a name="8" id="anc8"></a>





 225 static JSValue createConsoleProperty(VM&amp; vm, JSObject* object)
 226 {
 227     JSGlobalObject* global = jsCast&lt;JSGlobalObject*&gt;(object);
 228     return ConsoleObject::create(vm, global, ConsoleObject::createStructure(vm, global, constructEmptyObject(global-&gt;globalExec())));
 229 }
 230 
 231 static EncodedJSValue JSC_HOST_CALL makeBoundFunction(ExecState* exec)
 232 {
 233     VM&amp; vm = exec-&gt;vm();
<a name="9" id="anc9"></a>

 234     JSGlobalObject* globalObject = exec-&gt;lexicalGlobalObject();
 235 
 236     JSObject* target = asObject(exec-&gt;uncheckedArgument(0));
 237     JSValue boundThis = exec-&gt;uncheckedArgument(1);
 238     JSValue boundArgs = exec-&gt;uncheckedArgument(2);
<a name="10" id="anc10"></a><span class="line-modified"> 239     JSValue length = exec-&gt;uncheckedArgument(3);</span>
<span class="line-modified"> 240     JSString* name = asString(exec-&gt;uncheckedArgument(4));</span>



 241 
<a name="11" id="anc11"></a><span class="line-modified"> 242     return JSValue::encode(JSBoundFunction::create(</span>
<span class="line-modified"> 243         vm, exec, globalObject, target, boundThis, boundArgs.isCell() ? jsCast&lt;JSArray*&gt;(boundArgs) : nullptr, length.asInt32(), name-&gt;value(exec)));</span>


 244 }
 245 
 246 static EncodedJSValue JSC_HOST_CALL hasOwnLengthProperty(ExecState* exec)
 247 {
 248     VM&amp; vm = exec-&gt;vm();
 249     JSObject* target = asObject(exec-&gt;uncheckedArgument(0));
 250     return JSValue::encode(jsBoolean(target-&gt;hasOwnProperty(exec, vm.propertyNames-&gt;length)));
 251 }
 252 
 253 #if !ASSERT_DISABLED
 254 static EncodedJSValue JSC_HOST_CALL assertCall(ExecState* exec)
 255 {
 256     RELEASE_ASSERT(exec-&gt;argument(0).isBoolean());
 257     if (exec-&gt;argument(0).asBoolean())
 258         return JSValue::encode(jsUndefined());
 259 
 260     bool iteratedOnce = false;
 261     CodeBlock* codeBlock = nullptr;
 262     unsigned line;
 263     exec-&gt;iterate([&amp;] (StackVisitor&amp; visitor) {
 264         if (!iteratedOnce) {
 265             iteratedOnce = true;
 266             return StackVisitor::Continue;
 267         }
 268 
 269         RELEASE_ASSERT(visitor-&gt;hasLineAndColumnInfo());
 270         unsigned column;
 271         visitor-&gt;computeLineAndColumn(line, column);
 272         codeBlock = visitor-&gt;codeBlock();
 273         return StackVisitor::Done;
 274     });
 275     RELEASE_ASSERT(!!codeBlock);
 276     RELEASE_ASSERT_WITH_MESSAGE(false, &quot;JS assertion failed at line %u in:\n%s\n&quot;, line, codeBlock-&gt;sourceCodeForTools().data());
 277     return JSValue::encode(jsUndefined());
 278 }
 279 #endif
 280 
 281 } // namespace JSC
 282 
 283 #include &quot;JSGlobalObject.lut.h&quot;
 284 
 285 namespace JSC {
 286 
 287 const ClassInfo JSGlobalObject::s_info = { &quot;GlobalObject&quot;, &amp;Base::s_info, &amp;globalObjectTable, nullptr, CREATE_METHOD_TABLE(JSGlobalObject) };
 288 
 289 const GlobalObjectMethodTable JSGlobalObject::s_globalObjectMethodTable = {
 290     &amp;supportsRichSourceInfo,
 291     &amp;shouldInterruptScript,
 292     &amp;javaScriptRuntimeFlags,
 293     nullptr, // queueTaskToEventLoop
 294     &amp;shouldInterruptScriptBeforeTimeout,
 295     nullptr, // moduleLoaderImportModule
 296     nullptr, // moduleLoaderResolve
 297     nullptr, // moduleLoaderFetch
 298     nullptr, // moduleLoaderCreateImportMetaProperties
 299     nullptr, // moduleLoaderEvaluate
 300     nullptr, // promiseRejectionTracker
 301     nullptr, // defaultLanguage
 302     nullptr, // compileStreaming
 303     nullptr, // instantiateStreaming
 304 };
 305 
 306 /* Source for JSGlobalObject.lut.h
 307 @begin globalObjectTable
 308   isNaN                 JSBuiltin                                    DontEnum|Function 1
 309   isFinite              JSBuiltin                                    DontEnum|Function 1
 310   escape                globalFuncEscape                             DontEnum|Function 1
 311   unescape              globalFuncUnescape                           DontEnum|Function 1
 312   decodeURI             globalFuncDecodeURI                          DontEnum|Function 1
 313   decodeURIComponent    globalFuncDecodeURIComponent                 DontEnum|Function 1
 314   encodeURI             globalFuncEncodeURI                          DontEnum|Function 1
 315   encodeURIComponent    globalFuncEncodeURIComponent                 DontEnum|Function 1
<a name="12" id="anc12"></a>
 316   globalThis            JSGlobalObject::m_globalThis                 DontEnum|CellProperty
<a name="13" id="anc13"></a>


 317   EvalError             JSGlobalObject::m_evalErrorStructure         DontEnum|ClassStructure
 318   RangeError            JSGlobalObject::m_rangeErrorStructure        DontEnum|ClassStructure
 319   ReferenceError        JSGlobalObject::m_referenceErrorStructure    DontEnum|ClassStructure
 320   SyntaxError           JSGlobalObject::m_syntaxErrorStructure       DontEnum|ClassStructure
 321   TypeError             JSGlobalObject::m_typeErrorStructure         DontEnum|ClassStructure
 322   URIError              JSGlobalObject::m_URIErrorStructure          DontEnum|ClassStructure
 323   Proxy                 createProxyProperty                          DontEnum|PropertyCallback
<a name="14" id="anc14"></a>
 324   JSON                  createJSONProperty                           DontEnum|PropertyCallback
 325   Math                  createMathProperty                           DontEnum|PropertyCallback
 326   console               createConsoleProperty                        DontEnum|PropertyCallback
 327   Int8Array             JSGlobalObject::m_typedArrayInt8             DontEnum|ClassStructure
 328   Int16Array            JSGlobalObject::m_typedArrayInt16            DontEnum|ClassStructure
 329   Int32Array            JSGlobalObject::m_typedArrayInt32            DontEnum|ClassStructure
 330   Uint8Array            JSGlobalObject::m_typedArrayUint8            DontEnum|ClassStructure
 331   Uint8ClampedArray     JSGlobalObject::m_typedArrayUint8Clamped     DontEnum|ClassStructure
 332   Uint16Array           JSGlobalObject::m_typedArrayUint16           DontEnum|ClassStructure
 333   Uint32Array           JSGlobalObject::m_typedArrayUint32           DontEnum|ClassStructure
 334   Float32Array          JSGlobalObject::m_typedArrayFloat32          DontEnum|ClassStructure
 335   Float64Array          JSGlobalObject::m_typedArrayFloat64          DontEnum|ClassStructure
 336   DataView              JSGlobalObject::m_typedArrayDataView         DontEnum|ClassStructure
 337   Date                  JSGlobalObject::m_dateStructure              DontEnum|ClassStructure
<a name="15" id="anc15"></a>
 338   Boolean               JSGlobalObject::m_booleanObjectStructure     DontEnum|ClassStructure
 339   Number                JSGlobalObject::m_numberObjectStructure      DontEnum|ClassStructure
 340   Symbol                JSGlobalObject::m_symbolObjectStructure      DontEnum|ClassStructure
 341   WeakMap               JSGlobalObject::m_weakMapStructure           DontEnum|ClassStructure
 342   WeakSet               JSGlobalObject::m_weakSetStructure           DontEnum|ClassStructure
 343 @end
 344 */
 345 
 346 static EncodedJSValue JSC_HOST_CALL enqueueJob(ExecState* exec)
 347 {
 348     VM&amp; vm = exec-&gt;vm();
 349     JSGlobalObject* globalObject = exec-&gt;lexicalGlobalObject();
 350 
 351     JSValue job = exec-&gt;argument(0);
 352     JSValue arguments = exec-&gt;argument(1);
 353     ASSERT(arguments.inherits&lt;JSArray&gt;(vm));
 354 
 355     globalObject-&gt;queueMicrotask(createJSMicrotask(vm, job, jsCast&lt;JSArray*&gt;(arguments)));
 356 
 357     return JSValue::encode(jsUndefined());
 358 }
 359 
 360 JSGlobalObject::JSGlobalObject(VM&amp; vm, Structure* structure, const GlobalObjectMethodTable* globalObjectMethodTable)
 361     : Base(vm, structure, 0)
 362     , m_vm(vm)
 363     , m_masqueradesAsUndefinedWatchpoint(adoptRef(new WatchpointSet(IsWatched)))
 364     , m_havingABadTimeWatchpoint(adoptRef(new WatchpointSet(IsWatched)))
 365     , m_varInjectionWatchpoint(adoptRef(new WatchpointSet(IsWatched)))
 366     , m_weakRandom(Options::forceWeakRandomSeed() ? Options::forcedWeakRandomSeed() : static_cast&lt;unsigned&gt;(randomNumber() * (std::numeric_limits&lt;unsigned&gt;::max() + 1.0)))
<a name="16" id="anc16"></a><span class="line-modified"> 367     , m_arrayIteratorProtocolWatchpoint(IsWatched)</span>
<span class="line-modified"> 368     , m_mapIteratorProtocolWatchpoint(IsWatched)</span>
<span class="line-modified"> 369     , m_setIteratorProtocolWatchpoint(IsWatched)</span>
<span class="line-modified"> 370     , m_stringIteratorProtocolWatchpoint(IsWatched)</span>
<span class="line-modified"> 371     , m_mapSetWatchpoint(IsWatched)</span>
<span class="line-modified"> 372     , m_setAddWatchpoint(IsWatched)</span>
<span class="line-modified"> 373     , m_arraySpeciesWatchpoint(ClearWatchpoint)</span>
<span class="line-modified"> 374     , m_numberToStringWatchpoint(IsWatched)</span>

 375     , m_runtimeFlags()
 376     , m_stackTraceLimit(Options::defaultErrorStackTraceLimit())
 377     , m_globalObjectMethodTable(globalObjectMethodTable ? globalObjectMethodTable : &amp;s_globalObjectMethodTable)
 378 {
 379 }
 380 
 381 JSGlobalObject::~JSGlobalObject()
 382 {
 383 #if ENABLE(REMOTE_INSPECTOR)
 384     m_inspectorController-&gt;globalObjectDestroyed();
 385 #endif
 386 
 387     if (m_debugger)
 388         m_debugger-&gt;detach(this, Debugger::GlobalObjectIsDestructing);
 389 }
 390 
 391 void JSGlobalObject::destroy(JSCell* cell)
 392 {
 393     static_cast&lt;JSGlobalObject*&gt;(cell)-&gt;JSGlobalObject::~JSGlobalObject();
 394 }
 395 
 396 void JSGlobalObject::setGlobalThis(VM&amp; vm, JSObject* globalThis)
 397 {
 398     m_globalThis.set(vm, this, globalThis);
 399 }
 400 
 401 static JSObject* getGetterById(ExecState* exec, JSObject* base, const Identifier&amp; ident)
 402 {
 403     JSValue baseValue = JSValue(base);
 404     PropertySlot slot(baseValue, PropertySlot::InternalMethodType::VMInquiry);
 405     baseValue.getPropertySlot(exec, ident, slot);
 406     return slot.getPureResult().toObject(exec);
 407 }
 408 
 409 template&lt;ErrorType errorType&gt;
 410 void JSGlobalObject::initializeErrorConstructor(LazyClassStructure::Initializer&amp; init)
 411 {
<a name="17" id="anc17"></a><span class="line-modified"> 412     init.setPrototype(NativeErrorPrototype::create(init.vm, NativeErrorPrototype::createStructure(init.vm, this, m_errorPrototype.get()), errorTypeName(errorType)));</span>
 413     init.setStructure(ErrorInstance::createStructure(init.vm, this, init.prototype));
<a name="18" id="anc18"></a><span class="line-modified"> 414     init.setConstructor(NativeErrorConstructor&lt;errorType&gt;::create(init.vm, NativeErrorConstructor&lt;errorType&gt;::createStructure(init.vm, this, m_errorConstructor.get()), jsCast&lt;NativeErrorPrototype*&gt;(init.prototype)));</span>
 415 }
 416 
 417 void JSGlobalObject::init(VM&amp; vm)
 418 {
 419     ASSERT(vm.currentThreadIsHoldingAPILock());
 420     auto catchScope = DECLARE_CATCH_SCOPE(vm);
 421 
 422     Base::setStructure(vm, Structure::toCacheableDictionaryTransition(vm, structure(vm)));
 423 
 424     m_debugger = 0;
 425 
 426 #if ENABLE(REMOTE_INSPECTOR)
<a name="19" id="anc19"></a><span class="line-modified"> 427     m_inspectorController = std::make_unique&lt;Inspector::JSGlobalObjectInspectorController&gt;(*this);</span>
<span class="line-modified"> 428     m_inspectorDebuggable = std::make_unique&lt;JSGlobalObjectDebuggable&gt;(*this);</span>
 429     m_inspectorDebuggable-&gt;init();
 430     m_consoleClient = m_inspectorController-&gt;consoleClient();
 431 #endif
 432 
 433     m_functionPrototype.set(vm, this, FunctionPrototype::create(vm, FunctionPrototype::createStructure(vm, this, jsNull()))); // The real prototype will be set once ObjectPrototype is created.
 434     m_calleeStructure.set(vm, this, JSCallee::createStructure(vm, this, jsNull()));
 435 
 436     m_globalLexicalEnvironment.set(vm, this, JSGlobalLexicalEnvironment::create(vm, JSGlobalLexicalEnvironment::createStructure(vm, this), this));
 437     // Need to create the callee structure (above) before creating the callee.
 438     JSCallee* globalCallee = JSCallee::create(vm, this, globalScope());
 439     m_globalCallee.set(vm, this, globalCallee);
 440 
 441     ExecState::initGlobalExec(JSGlobalObject::globalExec(), globalCallee);
 442     ExecState* exec = JSGlobalObject::globalExec();
 443 
 444     JSCallee* stackOverflowFrameCallee = JSCallee::create(vm, this, globalScope());
 445     m_stackOverflowFrameCallee.set(vm, this, stackOverflowFrameCallee);
 446 
 447     m_hostFunctionStructure.set(vm, this, JSFunction::createStructure(vm, this, m_functionPrototype.get()));
 448 
 449     auto initFunctionStructures = [&amp;] (FunctionStructures&amp; structures) {
<a name="20" id="anc20"></a><span class="line-modified"> 450         structures.strictFunctionStructure.set(vm, this, JSFunction::createStructure(vm, this, m_functionPrototype.get()));</span>
<span class="line-modified"> 451         structures.sloppyFunctionStructure.set(vm, this, JSFunction::createStructure(vm, this, m_functionPrototype.get()));</span>
<span class="line-modified"> 452         structures.arrowFunctionStructure.set(vm, this, JSFunction::createStructure(vm, this, m_functionPrototype.get()));</span>
 453     };
 454     initFunctionStructures(m_builtinFunctions);
 455     initFunctionStructures(m_ordinaryFunctions);
 456 
 457     m_customGetterSetterFunctionStructure.initLater(
 458         [] (const Initializer&lt;Structure&gt;&amp; init) {
 459             init.set(JSCustomGetterSetterFunction::createStructure(init.vm, init.owner, init.owner-&gt;m_functionPrototype.get()));
 460         });
 461     m_boundFunctionStructure.initLater(
 462         [] (const Initializer&lt;Structure&gt;&amp; init) {
 463             init.set(JSBoundFunction::createStructure(init.vm, init.owner, init.owner-&gt;m_functionPrototype.get()));
 464         });
 465     m_getterSetterStructure.set(vm, this, GetterSetter::createStructure(vm, this, jsNull()));
 466     m_nativeStdFunctionStructure.initLater(
 467         [] (const Initializer&lt;Structure&gt;&amp; init) {
 468             init.set(JSNativeStdFunction::createStructure(init.vm, init.owner, init.owner-&gt;m_functionPrototype.get()));
 469         });
 470     JSFunction* callFunction = nullptr;
 471     JSFunction* applyFunction = nullptr;
 472     JSFunction* hasInstanceSymbolFunction = nullptr;
<a name="21" id="anc21"></a><span class="line-modified"> 473     m_functionPrototype-&gt;addFunctionProperties(exec, this, &amp;callFunction, &amp;applyFunction, &amp;hasInstanceSymbolFunction);</span>
 474     m_callFunction.set(vm, this, callFunction);
 475     m_applyFunction.set(vm, this, applyFunction);
 476     m_arrayProtoToStringFunction.initLater(
 477         [] (const Initializer&lt;JSFunction&gt;&amp; init) {
 478             init.set(JSFunction::create(init.vm, init.owner, 0, init.vm.propertyNames-&gt;toString.string(), arrayProtoFuncToString, NoIntrinsic));
 479         });
 480     m_arrayProtoValuesFunction.initLater(
 481         [] (const Initializer&lt;JSFunction&gt;&amp; init) {
 482             init.set(JSFunction::create(init.vm, arrayPrototypeValuesCodeGenerator(init.vm), init.owner));
 483         });
 484     m_initializePromiseFunction.initLater(
 485         [] (const Initializer&lt;JSFunction&gt;&amp; init) {
 486             init.set(JSFunction::create(init.vm, promiseOperationsInitializePromiseCodeGenerator(init.vm), init.owner));
 487         });
 488 
 489     m_iteratorProtocolFunction.initLater(
 490         [] (const Initializer&lt;JSFunction&gt;&amp; init) {
 491             init.set(JSFunction::create(init.vm, iteratorHelpersPerformIterationCodeGenerator(init.vm), init.owner));
 492         });
 493 
 494     m_promiseResolveFunction.initLater(
 495         [] (const Initializer&lt;JSFunction&gt;&amp; init) {
 496             init.set(JSFunction::create(init.vm, promiseConstructorResolveCodeGenerator(init.vm), init.owner));
 497         });
 498 
 499     m_newPromiseCapabilityFunction.set(vm, this, JSFunction::create(vm, promiseOperationsNewPromiseCapabilityCodeGenerator(vm), this));
 500     m_functionProtoHasInstanceSymbolFunction.set(vm, this, hasInstanceSymbolFunction);
 501     m_throwTypeErrorGetterSetter.initLater(
 502         [] (const Initializer&lt;GetterSetter&gt;&amp; init) {
 503             JSFunction* thrower = init.owner-&gt;throwTypeErrorFunction();
 504             GetterSetter* getterSetter = GetterSetter::create(init.vm, init.owner, thrower, thrower);
 505             init.set(getterSetter);
 506         });
 507 
 508     m_nullGetterFunction.set(vm, this, NullGetterFunction::create(vm, NullGetterFunction::createStructure(vm, this, m_functionPrototype.get())));
 509     m_nullSetterFunction.set(vm, this, NullSetterFunction::create(vm, NullSetterFunction::createStructure(vm, this, m_functionPrototype.get())));
 510     m_objectPrototype.set(vm, this, ObjectPrototype::create(vm, this, ObjectPrototype::createStructure(vm, this, jsNull())));
<a name="22" id="anc22"></a>

 511     GetterSetter* protoAccessor = GetterSetter::create(vm, this,
 512         JSFunction::create(vm, this, 0, makeString(&quot;get &quot;, vm.propertyNames-&gt;underscoreProto.string()), globalFuncProtoGetter, UnderscoreProtoIntrinsic),
 513         JSFunction::create(vm, this, 0, makeString(&quot;set &quot;, vm.propertyNames-&gt;underscoreProto.string()), globalFuncProtoSetter));
<a name="23" id="anc23"></a><span class="line-modified"> 514     m_objectPrototype-&gt;putDirectNonIndexAccessor(vm, vm.propertyNames-&gt;underscoreProto, protoAccessor, PropertyAttribute::Accessor | PropertyAttribute::DontEnum);</span>
 515     m_functionPrototype-&gt;structure(vm)-&gt;setPrototypeWithoutTransition(vm, m_objectPrototype.get());
 516     m_objectStructureForObjectConstructor.set(vm, this, vm.structureCache.emptyObjectStructureForPrototype(this, m_objectPrototype.get(), JSFinalObject::defaultInlineCapacity()));
 517     m_objectProtoValueOfFunction.set(vm, this, jsCast&lt;JSFunction*&gt;(objectPrototype()-&gt;getDirect(vm, vm.propertyNames-&gt;valueOf)));
 518 
 519     JSFunction* thrower = JSFunction::create(vm, this, 0, String(), globalFuncThrowTypeErrorArgumentsCalleeAndCaller);
 520     GetterSetter* getterSetter = GetterSetter::create(vm, this, thrower, thrower);
 521     m_throwTypeErrorArgumentsCalleeAndCallerGetterSetter.set(vm, this, getterSetter);
 522 
<a name="24" id="anc24"></a><span class="line-modified"> 523     m_functionPrototype-&gt;initRestrictedProperties(exec, this);</span>
 524 
 525     m_speciesGetterSetter.set(vm, this, GetterSetter::create(vm, this, JSFunction::create(vm, globalOperationsSpeciesGetterCodeGenerator(vm), this), nullptr));
 526 
 527     m_typedArrayProto.initLater(
 528         [] (const Initializer&lt;JSTypedArrayViewPrototype&gt;&amp; init) {
 529             init.set(JSTypedArrayViewPrototype::create(init.vm, init.owner, JSTypedArrayViewPrototype::createStructure(init.vm, init.owner, init.owner-&gt;m_objectPrototype.get())));
 530 
 531             // Make sure that the constructor gets initialized, too.
 532             init.owner-&gt;m_typedArraySuperConstructor.get(init.owner);
 533         });
 534     m_typedArraySuperConstructor.initLater(
 535         [] (const Initializer&lt;JSTypedArrayViewConstructor&gt;&amp; init) {
 536             JSTypedArrayViewPrototype* prototype = init.owner-&gt;m_typedArrayProto.get(init.owner);
 537             JSTypedArrayViewConstructor* constructor = JSTypedArrayViewConstructor::create(init.vm, init.owner, JSTypedArrayViewConstructor::createStructure(init.vm, init.owner, init.owner-&gt;m_functionPrototype.get()), prototype, init.owner-&gt;m_speciesGetterSetter.get());
 538             prototype-&gt;putDirectWithoutTransition(init.vm, init.vm.propertyNames-&gt;constructor, constructor, static_cast&lt;unsigned&gt;(PropertyAttribute::DontEnum));
 539             init.set(constructor);
 540         });
 541 
 542 #define INIT_TYPED_ARRAY_LATER(type) \
 543     m_typedArray ## type.initLater( \
 544         [] (LazyClassStructure::Initializer&amp; init) { \
 545             init.setPrototype(JS ## type ## ArrayPrototype::create(init.vm, init.global, JS ## type ## ArrayPrototype::createStructure(init.vm, init.global, init.global-&gt;m_typedArrayProto.get(init.global)))); \
 546             init.setStructure(JS ## type ## Array::createStructure(init.vm, init.global, init.prototype)); \
 547             init.setConstructor(JS ## type ## ArrayConstructor::create(init.vm, init.global, JS ## type ## ArrayConstructor::createStructure(init.vm, init.global, init.global-&gt;m_typedArraySuperConstructor.get(init.global)), init.prototype, #type &quot;Array&quot;_s, typedArrayConstructorAllocate ## type ## ArrayCodeGenerator(init.vm))); \
 548             init.global-&gt;putDirectWithoutTransition(init.vm, init.vm.propertyNames-&gt;builtinNames().type ## ArrayPrivateName(), init.constructor, static_cast&lt;unsigned&gt;(PropertyAttribute::DontEnum)); \
 549         });
 550     FOR_EACH_TYPED_ARRAY_TYPE_EXCLUDING_DATA_VIEW(INIT_TYPED_ARRAY_LATER)
 551 #undef INIT_TYPED_ARRAY_LATER
 552 
 553     m_typedArrayDataView.initLater(
 554         [] (LazyClassStructure::Initializer&amp; init) {
 555             init.setPrototype(JSDataViewPrototype::create(init.vm, JSDataViewPrototype::createStructure(init.vm, init.global, init.global-&gt;m_objectPrototype.get())));
 556             init.setStructure(JSDataView::createStructure(init.vm, init.global, init.prototype));
 557             init.setConstructor(JSDataViewConstructor::create(init.vm, init.global, JSDataViewConstructor::createStructure(init.vm, init.global, init.global-&gt;m_functionPrototype.get()), init.prototype, &quot;DataView&quot;_s, nullptr));
 558         });
 559 
 560     m_lexicalEnvironmentStructure.set(vm, this, JSLexicalEnvironment::createStructure(vm, this));
 561     m_moduleEnvironmentStructure.initLater(
 562         [] (const Initializer&lt;Structure&gt;&amp; init) {
 563             init.set(JSModuleEnvironment::createStructure(init.vm, init.owner));
 564         });
<a name="25" id="anc25"></a><span class="line-modified"> 565     m_strictEvalActivationStructure.set(vm, this, StrictEvalActivation::createStructure(vm, this, jsNull()));</span>



 566     m_debuggerScopeStructure.initLater(
 567         [] (const Initializer&lt;Structure&gt;&amp; init) {
 568             init.set(DebuggerScope::createStructure(init.vm, init.owner));
 569         });
 570     m_withScopeStructure.initLater(
 571         [] (const Initializer&lt;Structure&gt;&amp; init) {
 572             init.set(JSWithScope::createStructure(init.vm, init.owner, jsNull()));
 573         });
 574 
 575     m_nullPrototypeObjectStructure.set(vm, this, JSFinalObject::createStructure(vm, this, jsNull(), JSFinalObject::defaultInlineCapacity()));
 576 
 577     m_callbackFunctionStructure.initLater(
 578         [] (const Initializer&lt;Structure&gt;&amp; init) {
 579             init.set(JSCallbackFunction::createStructure(init.vm, init.owner, init.owner-&gt;m_functionPrototype.get()));
 580         });
 581     m_directArgumentsStructure.set(vm, this, DirectArguments::createStructure(vm, this, m_objectPrototype.get()));
 582     m_scopedArgumentsStructure.set(vm, this, ScopedArguments::createStructure(vm, this, m_objectPrototype.get()));
 583     m_clonedArgumentsStructure.set(vm, this, ClonedArguments::createStructure(vm, this, m_objectPrototype.get()));
 584     m_callbackConstructorStructure.initLater(
 585         [] (const Initializer&lt;Structure&gt;&amp; init) {
 586             init.set(JSCallbackConstructor::createStructure(init.vm, init.owner, init.owner-&gt;m_objectPrototype.get()));
 587         });
 588     m_callbackObjectStructure.initLater(
 589         [] (const Initializer&lt;Structure&gt;&amp; init) {
 590             init.set(JSCallbackObject&lt;JSDestructibleObject&gt;::createStructure(init.vm, init.owner, init.owner-&gt;m_objectPrototype.get()));
 591         });
 592 
 593 #if JSC_OBJC_API_ENABLED
 594     m_objcCallbackFunctionStructure.initLater(
 595         [] (const Initializer&lt;Structure&gt;&amp; init) {
 596             init.set(ObjCCallbackFunction::createStructure(init.vm, init.owner, init.owner-&gt;m_functionPrototype.get()));
 597         });
 598     m_objcWrapperObjectStructure.initLater(
 599         [] (const Initializer&lt;Structure&gt;&amp; init) {
 600             init.set(JSCallbackObject&lt;JSAPIWrapperObject&gt;::createStructure(init.vm, init.owner, init.owner-&gt;m_objectPrototype.get()));
 601         });
 602 #endif
 603 #ifdef JSC_GLIB_API_ENABLED
 604     m_glibCallbackFunctionStructure.initLater(
 605         [] (const Initializer&lt;Structure&gt;&amp; init) {
 606             init.set(JSCCallbackFunction::createStructure(init.vm, init.owner, init.owner-&gt;m_functionPrototype.get()));
 607         });
 608     m_glibWrapperObjectStructure.initLater(
 609         [] (const Initializer&lt;Structure&gt;&amp; init) {
 610             init.set(JSCallbackObject&lt;JSAPIWrapperObject&gt;::createStructure(init.vm, init.owner, init.owner-&gt;m_objectPrototype.get()));
 611         });
 612 #endif
 613     m_arrayPrototype.set(vm, this, ArrayPrototype::create(vm, this, ArrayPrototype::createStructure(vm, this, m_objectPrototype.get())));
 614 
 615     m_originalArrayStructureForIndexingShape[arrayIndexFromIndexingType(UndecidedShape)].set(vm, this, JSArray::createStructure(vm, this, m_arrayPrototype.get(), ArrayWithUndecided));
 616     m_originalArrayStructureForIndexingShape[arrayIndexFromIndexingType(Int32Shape)].set(vm, this, JSArray::createStructure(vm, this, m_arrayPrototype.get(), ArrayWithInt32));
 617     m_originalArrayStructureForIndexingShape[arrayIndexFromIndexingType(DoubleShape)].set(vm, this, JSArray::createStructure(vm, this, m_arrayPrototype.get(), ArrayWithDouble));
 618     m_originalArrayStructureForIndexingShape[arrayIndexFromIndexingType(ContiguousShape)].set(vm, this, JSArray::createStructure(vm, this, m_arrayPrototype.get(), ArrayWithContiguous));
 619     m_originalArrayStructureForIndexingShape[arrayIndexFromIndexingType(ArrayStorageShape)].set(vm, this, JSArray::createStructure(vm, this, m_arrayPrototype.get(), ArrayWithArrayStorage));
 620     m_originalArrayStructureForIndexingShape[arrayIndexFromIndexingType(SlowPutArrayStorageShape)].set(vm, this, JSArray::createStructure(vm, this, m_arrayPrototype.get(), ArrayWithSlowPutArrayStorage));
 621     m_originalArrayStructureForIndexingShape[arrayIndexFromIndexingType(CopyOnWriteArrayWithInt32)].set(vm, this, JSArray::createStructure(vm, this, m_arrayPrototype.get(), CopyOnWriteArrayWithInt32));
 622     m_originalArrayStructureForIndexingShape[arrayIndexFromIndexingType(CopyOnWriteArrayWithDouble)].set(vm, this, JSArray::createStructure(vm, this, m_arrayPrototype.get(), CopyOnWriteArrayWithDouble));
 623     m_originalArrayStructureForIndexingShape[arrayIndexFromIndexingType(CopyOnWriteArrayWithContiguous)].set(vm, this, JSArray::createStructure(vm, this, m_arrayPrototype.get(), CopyOnWriteArrayWithContiguous));
 624     for (unsigned i = 0; i &lt; NumberOfArrayIndexingModes; ++i)
 625         m_arrayStructureForIndexingShapeDuringAllocation[i] = m_originalArrayStructureForIndexingShape[i];
 626 
 627     m_regExpPrototype.set(vm, this, RegExpPrototype::create(vm, this, RegExpPrototype::createStructure(vm, this, m_objectPrototype.get())));
 628     m_regExpStructure.set(vm, this, RegExpObject::createStructure(vm, this, m_regExpPrototype.get()));
 629     m_regExpMatchesArrayStructure.set(vm, this, createRegExpMatchesArrayStructure(vm, this));
 630     m_regExpMatchesArrayWithGroupsStructure.set(vm, this, createRegExpMatchesArrayWithGroupsStructure(vm, this));
 631 
<a name="26" id="anc26"></a><span class="line-modified"> 632     m_moduleRecordStructure.set(vm, this, JSModuleRecord::createStructure(vm, this, jsNull()));</span>
<span class="line-modified"> 633     m_moduleNamespaceObjectStructure.set(vm, this, JSModuleNamespaceObject::createStructure(vm, this, jsNull()));</span>
<span class="line-modified"> 634     {</span>
<span class="line-modified"> 635         bool isCallable = false;</span>
<span class="line-modified"> 636         m_proxyObjectStructure.set(vm, this, ProxyObject::createStructure(vm, this, jsNull(), isCallable));</span>
<span class="line-modified"> 637         isCallable = true;</span>
<span class="line-modified"> 638         m_callableProxyObjectStructure.set(vm, this, ProxyObject::createStructure(vm, this, jsNull(), isCallable));</span>
<span class="line-modified"> 639     }</span>
<span class="line-modified"> 640     m_proxyRevokeStructure.set(vm, this, ProxyRevoke::createStructure(vm, this, m_functionPrototype.get()));</span>













 641 
<a name="27" id="anc27"></a><span class="line-modified"> 642     m_parseIntFunction.set(vm, this, JSFunction::create(vm, this, 2, vm.propertyNames-&gt;parseInt.string(), globalFuncParseInt, ParseIntIntrinsic));</span>
<span class="line-modified"> 643     putDirectWithoutTransition(vm, vm.propertyNames-&gt;parseInt, m_parseIntFunction.get(), static_cast&lt;unsigned&gt;(PropertyAttribute::DontEnum));</span>
<span class="line-modified"> 644     m_parseFloatFunction.set(vm, this, JSFunction::create(vm, this, 1, vm.propertyNames-&gt;parseFloat.string(), globalFuncParseFloat, NoIntrinsic));</span>
<span class="line-modified"> 645     putDirectWithoutTransition(vm, vm.propertyNames-&gt;parseFloat, m_parseFloatFunction.get(), static_cast&lt;unsigned&gt;(PropertyAttribute::DontEnum));</span>




 646 
<a name="28" id="anc28"></a><span class="line-removed"> 647     m_arrayBufferPrototype.set(vm, this, JSArrayBufferPrototype::create(vm, this, JSArrayBufferPrototype::createStructure(vm, this, m_objectPrototype.get()), ArrayBufferSharingMode::Default));</span>
<span class="line-removed"> 648     m_arrayBufferStructure.set(vm, this, JSArrayBuffer::createStructure(vm, this, m_arrayBufferPrototype.get()));</span>
 649 #if ENABLE(SHARED_ARRAY_BUFFER)
 650     m_sharedArrayBufferPrototype.set(vm, this, JSArrayBufferPrototype::create(vm, this, JSArrayBufferPrototype::createStructure(vm, this, m_objectPrototype.get()), ArrayBufferSharingMode::Shared));
 651     m_sharedArrayBufferStructure.set(vm, this, JSArrayBuffer::createStructure(vm, this, m_sharedArrayBufferPrototype.get()));
 652 #endif
 653 
 654     m_iteratorPrototype.set(vm, this, IteratorPrototype::create(vm, this, IteratorPrototype::createStructure(vm, this, m_objectPrototype.get())));
 655     m_asyncIteratorPrototype.set(vm, this, AsyncIteratorPrototype::create(vm, this, AsyncIteratorPrototype::createStructure(vm, this, m_objectPrototype.get())));
 656 
 657     m_generatorPrototype.set(vm, this, GeneratorPrototype::create(vm, this, GeneratorPrototype::createStructure(vm, this, m_iteratorPrototype.get())));
 658     m_asyncGeneratorPrototype.set(vm, this, AsyncGeneratorPrototype::create(vm, this, AsyncGeneratorPrototype::createStructure(vm, this, m_asyncIteratorPrototype.get())));
 659 
<a name="29" id="anc29"></a><span class="line-modified"> 660 #define CREATE_PROTOTYPE_FOR_SIMPLE_TYPE(capitalName, lowerName, properName, instanceType, jsName, prototypeBase) do { \</span>
 661         m_ ## lowerName ## Prototype.set(vm, this, capitalName##Prototype::create(vm, this, capitalName##Prototype::createStructure(vm, this, m_ ## prototypeBase ## Prototype.get()))); \
 662         m_ ## properName ## Structure.set(vm, this, instanceType::createStructure(vm, this, m_ ## lowerName ## Prototype.get())); \
<a name="30" id="anc30"></a><span class="line-modified"> 663     } while (0);</span>
 664 
 665     FOR_EACH_SIMPLE_BUILTIN_TYPE(CREATE_PROTOTYPE_FOR_SIMPLE_TYPE)
<a name="31" id="anc31"></a><span class="line-removed"> 666 </span>
<span class="line-removed"> 667     if (UNLIKELY(Options::useBigInt()))</span>
<span class="line-removed"> 668         FOR_BIG_INT_BUILTIN_TYPE_WITH_CONSTRUCTOR(CREATE_PROTOTYPE_FOR_SIMPLE_TYPE)</span>
<span class="line-removed"> 669 </span>
 670     FOR_EACH_BUILTIN_DERIVED_ITERATOR_TYPE(CREATE_PROTOTYPE_FOR_SIMPLE_TYPE)
 671 
 672 #undef CREATE_PROTOTYPE_FOR_SIMPLE_TYPE
 673 
<a name="32" id="anc32"></a><span class="line-modified"> 674 #define CREATE_PROTOTYPE_FOR_LAZY_TYPE(capitalName, lowerName, properName, instanceType, jsName, prototypeBase) \</span>
 675     m_ ## properName ## Structure.initLater(\
 676         [] (LazyClassStructure::Initializer&amp; init) { \
 677             init.setPrototype(capitalName##Prototype::create(init.vm, init.global, capitalName##Prototype::createStructure(init.vm, init.global, init.global-&gt;m_ ## prototypeBase ## Prototype.get()))); \
 678             init.setStructure(instanceType::createStructure(init.vm, init.global, init.prototype)); \
 679             init.setConstructor(capitalName ## Constructor::create(init.vm, capitalName ## Constructor::createStructure(init.vm, init.global, init.global-&gt;m_functionPrototype.get()), jsCast&lt;capitalName ## Prototype*&gt;(init.prototype), init.global-&gt;m_speciesGetterSetter.get())); \
<a name="33" id="anc33"></a><span class="line-modified"> 680         });</span>

 681 
 682     FOR_EACH_LAZY_BUILTIN_TYPE(CREATE_PROTOTYPE_FOR_LAZY_TYPE)
 683 
<a name="34" id="anc34"></a><span class="line-removed"> 684 #undef CREATE_PROTOTYPE_FOR_LAZY_TYPE</span>
<span class="line-removed"> 685 </span>
 686     // Constructors
 687 
 688     ObjectConstructor* objectConstructor = ObjectConstructor::create(vm, this, ObjectConstructor::createStructure(vm, this, m_functionPrototype.get()), m_objectPrototype.get());
 689     m_objectConstructor.set(vm, this, objectConstructor);
 690 
 691     JSFunction* throwTypeErrorFunction = JSFunction::create(vm, this, 0, String(), globalFuncThrowTypeError);
 692     m_throwTypeErrorFunction.set(vm, this, throwTypeErrorFunction);
 693 
 694     JSCell* functionConstructor = FunctionConstructor::create(vm, FunctionConstructor::createStructure(vm, this, m_functionPrototype.get()), m_functionPrototype.get());
 695 
 696     ArrayConstructor* arrayConstructor = ArrayConstructor::create(vm, this, ArrayConstructor::createStructure(vm, this, m_functionPrototype.get()), m_arrayPrototype.get(), m_speciesGetterSetter.get());
 697     m_arrayConstructor.set(vm, this, arrayConstructor);
 698 
 699     RegExpConstructor* regExpConstructor = RegExpConstructor::create(vm, RegExpConstructor::createStructure(vm, this, m_functionPrototype.get()), m_regExpPrototype.get(), m_speciesGetterSetter.get());
<a name="35" id="anc35"></a><span class="line-modified"> 700     m_regExpGlobalData.cachedResult().record(vm, this, nullptr, jsEmptyString(&amp;vm), MatchResult(0, 0));</span>
<span class="line-removed"> 701 </span>
<span class="line-removed"> 702     JSArrayBufferConstructor* arrayBufferConstructor = JSArrayBufferConstructor::create(vm, JSArrayBufferConstructor::createStructure(vm, this, m_functionPrototype.get()), m_arrayBufferPrototype.get(), m_speciesGetterSetter.get());</span>
<span class="line-removed"> 703     m_arrayBufferPrototype-&gt;putDirectWithoutTransition(vm, vm.propertyNames-&gt;constructor, arrayBufferConstructor, static_cast&lt;unsigned&gt;(PropertyAttribute::DontEnum));</span>
 704 
 705 #if ENABLE(SHARED_ARRAY_BUFFER)
 706     JSSharedArrayBufferConstructor* sharedArrayBufferConstructor = nullptr;
 707     sharedArrayBufferConstructor = JSSharedArrayBufferConstructor::create(vm, JSSharedArrayBufferConstructor::createStructure(vm, this, m_functionPrototype.get()), m_sharedArrayBufferPrototype.get(), m_speciesGetterSetter.get());
 708     m_sharedArrayBufferPrototype-&gt;putDirectWithoutTransition(vm, vm.propertyNames-&gt;constructor, sharedArrayBufferConstructor, static_cast&lt;unsigned&gt;(PropertyAttribute::DontEnum));
 709 
 710     AtomicsObject* atomicsObject = AtomicsObject::create(vm, this, AtomicsObject::createStructure(vm, this, m_objectPrototype.get()));
 711 #endif
 712 
<a name="36" id="anc36"></a><span class="line-modified"> 713 #define CREATE_CONSTRUCTOR_FOR_SIMPLE_TYPE(capitalName, lowerName, properName, instanceType, jsName, prototypeBase) \</span>
<span class="line-modified"> 714 capitalName ## Constructor* lowerName ## Constructor = capitalName ## Constructor::create(vm, capitalName ## Constructor::createStructure(vm, this, m_functionPrototype.get()), m_ ## lowerName ## Prototype.get(), m_speciesGetterSetter.get()); \</span>
<span class="line-modified"> 715 m_ ## lowerName ## Prototype-&gt;putDirectWithoutTransition(vm, vm.propertyNames-&gt;constructor, lowerName ## Constructor, static_cast&lt;unsigned&gt;(PropertyAttribute::DontEnum)); \</span>

 716 
 717     FOR_EACH_SIMPLE_BUILTIN_TYPE(CREATE_CONSTRUCTOR_FOR_SIMPLE_TYPE)
<a name="37" id="anc37"></a><span class="line-removed"> 718     BigIntConstructor* bigIntConstructor = nullptr;</span>
<span class="line-removed"> 719     if (UNLIKELY(Options::useBigInt())) {</span>
<span class="line-removed"> 720         bigIntConstructor = BigIntConstructor::create(vm, BigIntConstructor::createStructure(vm, this, m_functionPrototype.get()), m_bigIntPrototype.get(), m_speciesGetterSetter.get());</span>
<span class="line-removed"> 721         m_bigIntPrototype-&gt;putDirectWithoutTransition(vm, vm.propertyNames-&gt;constructor, bigIntConstructor, static_cast&lt;unsigned&gt;(PropertyAttribute::DontEnum));</span>
<span class="line-removed"> 722     }</span>
 723 
 724 #undef CREATE_CONSTRUCTOR_FOR_SIMPLE_TYPE
 725 
 726     m_promiseConstructor.set(vm, this, promiseConstructor);
 727     m_internalPromiseConstructor.set(vm, this, internalPromiseConstructor);
 728 
<a name="38" id="anc38"></a><span class="line-removed"> 729     m_errorConstructor.set(vm, this, errorConstructor);</span>
 730     m_evalErrorStructure.initLater(
 731         [] (LazyClassStructure::Initializer&amp; init) {
 732             init.global-&gt;initializeErrorConstructor&lt;ErrorType::EvalError&gt;(init);
 733         });
 734     m_rangeErrorStructure.initLater(
 735         [] (LazyClassStructure::Initializer&amp; init) {
 736             init.global-&gt;initializeErrorConstructor&lt;ErrorType::RangeError&gt;(init);
 737         });
 738     m_referenceErrorStructure.initLater(
 739         [] (LazyClassStructure::Initializer&amp; init) {
 740             init.global-&gt;initializeErrorConstructor&lt;ErrorType::ReferenceError&gt;(init);
 741         });
 742     m_syntaxErrorStructure.initLater(
 743         [] (LazyClassStructure::Initializer&amp; init) {
 744             init.global-&gt;initializeErrorConstructor&lt;ErrorType::SyntaxError&gt;(init);
 745         });
 746     m_typeErrorStructure.initLater(
 747         [] (LazyClassStructure::Initializer&amp; init) {
 748             init.global-&gt;initializeErrorConstructor&lt;ErrorType::TypeError&gt;(init);
 749         });
 750     m_URIErrorStructure.initLater(
 751         [] (LazyClassStructure::Initializer&amp; init) {
 752             init.global-&gt;initializeErrorConstructor&lt;ErrorType::URIError&gt;(init);
 753         });
 754 
 755     m_generatorFunctionPrototype.set(vm, this, GeneratorFunctionPrototype::create(vm, GeneratorFunctionPrototype::createStructure(vm, this, m_functionPrototype.get())));
 756     GeneratorFunctionConstructor* generatorFunctionConstructor = GeneratorFunctionConstructor::create(vm, GeneratorFunctionConstructor::createStructure(vm, this, functionConstructor), m_generatorFunctionPrototype.get());
 757     m_generatorFunctionPrototype-&gt;putDirectWithoutTransition(vm, vm.propertyNames-&gt;constructor, generatorFunctionConstructor, PropertyAttribute::DontEnum | PropertyAttribute::ReadOnly);
 758     m_generatorFunctionStructure.set(vm, this, JSGeneratorFunction::createStructure(vm, this, m_generatorFunctionPrototype.get()));
 759 
 760     m_generatorPrototype-&gt;putDirectWithoutTransition(vm, vm.propertyNames-&gt;constructor, m_generatorFunctionPrototype.get(), PropertyAttribute::DontEnum | PropertyAttribute::ReadOnly);
 761     m_generatorFunctionPrototype-&gt;putDirectWithoutTransition(vm, vm.propertyNames-&gt;prototype, m_generatorPrototype.get(), PropertyAttribute::DontEnum | PropertyAttribute::ReadOnly);
 762 
 763     m_asyncFunctionPrototype.set(vm, this, AsyncFunctionPrototype::create(vm, AsyncFunctionPrototype::createStructure(vm, this, m_functionPrototype.get())));
 764     AsyncFunctionConstructor* asyncFunctionConstructor = AsyncFunctionConstructor::create(vm, AsyncFunctionConstructor::createStructure(vm, this, functionConstructor), m_asyncFunctionPrototype.get());
 765     m_asyncFunctionPrototype-&gt;putDirectWithoutTransition(vm, vm.propertyNames-&gt;constructor, asyncFunctionConstructor, PropertyAttribute::DontEnum | PropertyAttribute::ReadOnly);
 766     m_asyncFunctionStructure.set(vm, this, JSAsyncFunction::createStructure(vm, this, m_asyncFunctionPrototype.get()));
 767 
 768     m_asyncGeneratorFunctionPrototype.set(vm, this, AsyncGeneratorFunctionPrototype::create(vm, AsyncGeneratorFunctionPrototype::createStructure(vm, this, m_functionPrototype.get())));
 769     AsyncGeneratorFunctionConstructor* asyncGeneratorFunctionConstructor = AsyncGeneratorFunctionConstructor::create(vm, AsyncGeneratorFunctionConstructor::createStructure(vm, this, functionConstructor), m_asyncGeneratorFunctionPrototype.get());
 770     m_asyncGeneratorFunctionPrototype-&gt;putDirectWithoutTransition(vm, vm.propertyNames-&gt;constructor, asyncGeneratorFunctionConstructor, PropertyAttribute::DontEnum | PropertyAttribute::ReadOnly);
 771     m_asyncGeneratorFunctionStructure.set(vm, this, JSAsyncGeneratorFunction::createStructure(vm, this, m_asyncGeneratorFunctionPrototype.get()));
 772 
 773     m_asyncGeneratorPrototype-&gt;putDirectWithoutTransition(vm, vm.propertyNames-&gt;constructor, m_asyncGeneratorFunctionPrototype.get(), PropertyAttribute::DontEnum | PropertyAttribute::ReadOnly);
 774     m_asyncGeneratorFunctionPrototype-&gt;putDirectWithoutTransition(vm, vm.propertyNames-&gt;prototype, m_asyncGeneratorPrototype.get(), PropertyAttribute::DontEnum | PropertyAttribute::ReadOnly);
 775 
 776     m_objectPrototype-&gt;putDirectWithoutTransition(vm, vm.propertyNames-&gt;constructor, objectConstructor, static_cast&lt;unsigned&gt;(PropertyAttribute::DontEnum));
 777     m_functionPrototype-&gt;putDirectWithoutTransition(vm, vm.propertyNames-&gt;constructor, functionConstructor, static_cast&lt;unsigned&gt;(PropertyAttribute::DontEnum));
 778     m_arrayPrototype-&gt;putDirectWithoutTransition(vm, vm.propertyNames-&gt;constructor, arrayConstructor, static_cast&lt;unsigned&gt;(PropertyAttribute::DontEnum));
 779     m_regExpPrototype-&gt;putDirectWithoutTransition(vm, vm.propertyNames-&gt;constructor, regExpConstructor, static_cast&lt;unsigned&gt;(PropertyAttribute::DontEnum));
 780 
 781     putDirectWithoutTransition(vm, vm.propertyNames-&gt;Object, objectConstructor, static_cast&lt;unsigned&gt;(PropertyAttribute::DontEnum));
 782     putDirectWithoutTransition(vm, vm.propertyNames-&gt;Function, functionConstructor, static_cast&lt;unsigned&gt;(PropertyAttribute::DontEnum));
 783     putDirectWithoutTransition(vm, vm.propertyNames-&gt;Array, arrayConstructor, static_cast&lt;unsigned&gt;(PropertyAttribute::DontEnum));
 784     putDirectWithoutTransition(vm, vm.propertyNames-&gt;RegExp, regExpConstructor, static_cast&lt;unsigned&gt;(PropertyAttribute::DontEnum));
 785 
 786     putDirectWithoutTransition(vm, vm.propertyNames-&gt;builtinNames().ObjectPrivateName(), objectConstructor, PropertyAttribute::DontEnum | PropertyAttribute::DontDelete | PropertyAttribute::ReadOnly);
 787     putDirectWithoutTransition(vm, vm.propertyNames-&gt;builtinNames().ArrayPrivateName(), arrayConstructor, PropertyAttribute::DontEnum | PropertyAttribute::DontDelete | PropertyAttribute::ReadOnly);
 788 
<a name="39" id="anc39"></a><span class="line-removed"> 789     putDirectWithoutTransition(vm, vm.propertyNames-&gt;ArrayBuffer, arrayBufferConstructor, static_cast&lt;unsigned&gt;(PropertyAttribute::DontEnum));</span>
 790 #if ENABLE(SHARED_ARRAY_BUFFER)
 791     putDirectWithoutTransition(vm, vm.propertyNames-&gt;SharedArrayBuffer, sharedArrayBufferConstructor, static_cast&lt;unsigned&gt;(PropertyAttribute::DontEnum));
<a name="40" id="anc40"></a><span class="line-modified"> 792     putDirectWithoutTransition(vm, Identifier::fromString(exec, &quot;Atomics&quot;), atomicsObject, static_cast&lt;unsigned&gt;(PropertyAttribute::DontEnum));</span>
 793 #endif
 794 
<a name="41" id="anc41"></a><span class="line-modified"> 795 #define PUT_CONSTRUCTOR_FOR_SIMPLE_TYPE(capitalName, lowerName, properName, instanceType, jsName, prototypeBase) \</span>
<span class="line-modified"> 796 putDirectWithoutTransition(vm, vm.propertyNames-&gt; jsName, lowerName ## Constructor, static_cast&lt;unsigned&gt;(PropertyAttribute::DontEnum)); \</span>


 797 
 798     FOR_EACH_SIMPLE_BUILTIN_TYPE_WITH_CONSTRUCTOR(PUT_CONSTRUCTOR_FOR_SIMPLE_TYPE)
<a name="42" id="anc42"></a><span class="line-removed"> 799     if (UNLIKELY(Options::useBigInt()))</span>
<span class="line-removed"> 800         FOR_BIG_INT_BUILTIN_TYPE_WITH_CONSTRUCTOR(PUT_CONSTRUCTOR_FOR_SIMPLE_TYPE)</span>
 801 
 802 #undef PUT_CONSTRUCTOR_FOR_SIMPLE_TYPE
<a name="43" id="anc43"></a><span class="line-modified"> 803     m_iteratorResultObjectStructure.set(vm, this, createIteratorResultObjectStructure(vm, *this));</span>



 804 
<a name="44" id="anc44"></a><span class="line-modified"> 805     m_evalFunction.set(vm, this, JSFunction::create(vm, this, 1, vm.propertyNames-&gt;eval.string(), globalFuncEval));</span>
<span class="line-modified"> 806     putDirectWithoutTransition(vm, vm.propertyNames-&gt;eval, m_evalFunction.get(), static_cast&lt;unsigned&gt;(PropertyAttribute::DontEnum));</span>


 807 
 808 #if ENABLE(INTL)
 809     m_collatorStructure.initLater(
 810         [] (const Initializer&lt;Structure&gt;&amp; init) {
 811             JSGlobalObject* globalObject = jsCast&lt;JSGlobalObject*&gt;(init.owner);
 812             IntlCollatorPrototype* collatorPrototype = IntlCollatorPrototype::create(init.vm, globalObject, IntlCollatorPrototype::createStructure(init.vm, globalObject, globalObject-&gt;objectPrototype()));
 813             init.set(IntlCollator::createStructure(init.vm, globalObject, collatorPrototype));
 814         });
 815     m_numberFormatStructure.initLater(
 816         [] (const Initializer&lt;Structure&gt;&amp; init) {
 817             JSGlobalObject* globalObject = jsCast&lt;JSGlobalObject*&gt;(init.owner);
 818             IntlNumberFormatPrototype* numberFormatPrototype = IntlNumberFormatPrototype::create(init.vm, globalObject, IntlNumberFormatPrototype::createStructure(init.vm, globalObject, globalObject-&gt;objectPrototype()));
 819             init.set(IntlNumberFormat::createStructure(init.vm, globalObject, numberFormatPrototype));
 820         });
 821     m_dateTimeFormatStructure.initLater(
 822         [] (const Initializer&lt;Structure&gt;&amp; init) {
 823             JSGlobalObject* globalObject = jsCast&lt;JSGlobalObject*&gt;(init.owner);
 824             IntlDateTimeFormatPrototype* dateTimeFormatPrototype = IntlDateTimeFormatPrototype::create(init.vm, globalObject, IntlDateTimeFormatPrototype::createStructure(init.vm, globalObject, globalObject-&gt;objectPrototype()));
 825             init.set(IntlDateTimeFormat::createStructure(init.vm, globalObject, dateTimeFormatPrototype));
 826         });
 827     m_pluralRulesStructure.initLater(
 828         [] (const Initializer&lt;Structure&gt;&amp; init) {
 829             JSGlobalObject* globalObject = jsCast&lt;JSGlobalObject*&gt;(init.owner);
 830             IntlPluralRulesPrototype* pluralRulesPrototype = IntlPluralRulesPrototype::create(init.vm, globalObject, IntlPluralRulesPrototype::createStructure(init.vm, globalObject, globalObject-&gt;objectPrototype()));
 831             init.set(IntlPluralRules::createStructure(init.vm, globalObject, pluralRulesPrototype));
 832         });
 833 
 834     IntlObject* intl = IntlObject::create(vm, IntlObject::createStructure(vm, this, m_objectPrototype.get()));
 835     putDirectWithoutTransition(vm, vm.propertyNames-&gt;Intl, intl, static_cast&lt;unsigned&gt;(PropertyAttribute::DontEnum));
<a name="45" id="anc45"></a><span class="line-removed"> 836     m_intlObject.set(vm, this, intl);</span>
 837 #endif // ENABLE(INTL)
<a name="46" id="anc46"></a><span class="line-removed"> 838     ReflectObject* reflectObject = ReflectObject::create(vm, this, ReflectObject::createStructure(vm, this, m_objectPrototype.get()));</span>
<span class="line-removed"> 839     putDirectWithoutTransition(vm, vm.propertyNames-&gt;Reflect, reflectObject, static_cast&lt;unsigned&gt;(PropertyAttribute::DontEnum));</span>
 840 
 841     m_moduleLoader.initLater(
 842         [] (const Initializer&lt;JSModuleLoader&gt;&amp; init) {
 843             auto catchScope = DECLARE_CATCH_SCOPE(init.vm);
 844             init.set(JSModuleLoader::create(init.owner-&gt;globalExec(), init.vm, init.owner, JSModuleLoader::createStructure(init.vm, init.owner, jsNull())));
 845             catchScope.releaseAssertNoException();
 846         });
 847     if (Options::exposeInternalModuleLoader())
 848         putDirectWithoutTransition(vm, vm.propertyNames-&gt;Loader, moduleLoader(), static_cast&lt;unsigned&gt;(PropertyAttribute::DontEnum));
 849 
 850     JSFunction* builtinLog = JSFunction::create(vm, this, 1, vm.propertyNames-&gt;emptyIdentifier.string(), globalFuncBuiltinLog);
 851     JSFunction* builtinDescribe = JSFunction::create(vm, this, 1, vm.propertyNames-&gt;emptyIdentifier.string(), globalFuncBuiltinDescribe);
 852 
 853     JSFunction* privateFuncTrunc = JSFunction::create(vm, this, 0, String(), mathProtoFuncTrunc, TruncIntrinsic);
 854 
 855     JSFunction* privateFuncPropertyIsEnumerable = JSFunction::create(vm, this, 0, String(), globalFuncPropertyIsEnumerable);
<a name="47" id="anc47"></a>
 856     JSFunction* privateFuncImportModule = JSFunction::create(vm, this, 0, String(), globalFuncImportModule);
<a name="48" id="anc48"></a>
 857     JSFunction* privateFuncTypedArrayLength = JSFunction::create(vm, this, 0, String(), typedArrayViewPrivateFuncLength);
 858     JSFunction* privateFuncTypedArrayGetOriginalConstructor = JSFunction::create(vm, this, 0, String(), typedArrayViewPrivateFuncGetOriginalConstructor);
 859     JSFunction* privateFuncTypedArraySort = JSFunction::create(vm, this, 0, String(), typedArrayViewPrivateFuncSort);
 860     JSFunction* privateFuncIsTypedArrayView = JSFunction::create(vm, this, 0, String(), typedArrayViewPrivateFuncIsTypedArrayView, IsTypedArrayViewIntrinsic);
 861     JSFunction* privateFuncTypedArraySubarrayCreate = JSFunction::create(vm, this, 0, String(), typedArrayViewPrivateFuncSubarrayCreate);
 862     JSFunction* privateFuncIsBoundFunction = JSFunction::create(vm, this, 0, String(), isBoundFunction);
 863     JSFunction* privateFuncHasInstanceBoundFunction = JSFunction::create(vm, this, 0, String(), hasInstanceBoundFunction);
 864     JSFunction* privateFuncInstanceOf = JSFunction::create(vm, this, 0, String(), objectPrivateFuncInstanceOf);
 865     JSFunction* privateFuncThisTimeValue = JSFunction::create(vm, this, 0, String(), dateProtoFuncGetTime);
 866 #if ENABLE(INTL)
 867     JSFunction* privateFuncDateTimeFormat = JSFunction::create(vm, this, 0, String(), globalFuncDateTimeFormat);
 868 #endif
<a name="49" id="anc49"></a><span class="line-removed"> 869     JSFunction* privateFuncIsArrayConstructor = JSFunction::create(vm, this, 0, String(), arrayConstructorPrivateFuncIsArrayConstructor);</span>
 870     JSFunction* privateFuncIsArraySlow = JSFunction::create(vm, this, 0, String(), arrayConstructorPrivateFuncIsArraySlow);
 871     JSFunction* privateFuncConcatMemcpy = JSFunction::create(vm, this, 0, String(), arrayProtoPrivateFuncConcatMemcpy);
 872     JSFunction* privateFuncAppendMemcpy = JSFunction::create(vm, this, 0, String(), arrayProtoPrivateFuncAppendMemcpy);
 873     JSFunction* privateFuncMapBucketHead = JSFunction::create(vm, this, 0, String(), mapPrivateFuncMapBucketHead, JSMapBucketHeadIntrinsic);
 874     JSFunction* privateFuncMapBucketNext = JSFunction::create(vm, this, 0, String(), mapPrivateFuncMapBucketNext, JSMapBucketNextIntrinsic);
 875     JSFunction* privateFuncMapBucketKey = JSFunction::create(vm, this, 0, String(), mapPrivateFuncMapBucketKey, JSMapBucketKeyIntrinsic);
 876     JSFunction* privateFuncMapBucketValue = JSFunction::create(vm, this, 0, String(), mapPrivateFuncMapBucketValue, JSMapBucketValueIntrinsic);
 877     JSFunction* privateFuncSetBucketHead = JSFunction::create(vm, this, 0, String(), setPrivateFuncSetBucketHead, JSSetBucketHeadIntrinsic);
 878     JSFunction* privateFuncSetBucketNext = JSFunction::create(vm, this, 0, String(), setPrivateFuncSetBucketNext, JSSetBucketNextIntrinsic);
 879     JSFunction* privateFuncSetBucketKey = JSFunction::create(vm, this, 0, String(), setPrivateFuncSetBucketKey, JSSetBucketKeyIntrinsic);
 880 
 881     JSObject* regExpProtoFlagsGetterObject = getGetterById(exec, m_regExpPrototype.get(), vm.propertyNames-&gt;flags);
 882     catchScope.assertNoException();
 883     JSObject* regExpProtoGlobalGetterObject = getGetterById(exec, m_regExpPrototype.get(), vm.propertyNames-&gt;global);
 884     catchScope.assertNoException();
 885     m_regExpProtoGlobalGetter.set(vm, this, regExpProtoGlobalGetterObject);
 886     JSObject* regExpProtoIgnoreCaseGetterObject = getGetterById(exec, m_regExpPrototype.get(), vm.propertyNames-&gt;ignoreCase);
 887     catchScope.assertNoException();
 888     JSObject* regExpProtoMultilineGetterObject = getGetterById(exec, m_regExpPrototype.get(), vm.propertyNames-&gt;multiline);
 889     catchScope.assertNoException();
 890     JSObject* regExpProtoSourceGetterObject = getGetterById(exec, m_regExpPrototype.get(), vm.propertyNames-&gt;source);
 891     catchScope.assertNoException();
 892     JSObject* regExpProtoStickyGetterObject = getGetterById(exec, m_regExpPrototype.get(), vm.propertyNames-&gt;sticky);
 893     catchScope.assertNoException();
 894     JSObject* regExpProtoUnicodeGetterObject = getGetterById(exec, m_regExpPrototype.get(), vm.propertyNames-&gt;unicode);
 895     catchScope.assertNoException();
 896     m_regExpProtoUnicodeGetter.set(vm, this, regExpProtoUnicodeGetterObject);
 897     JSObject* builtinRegExpExec = asObject(m_regExpPrototype-&gt;getDirect(vm, vm.propertyNames-&gt;exec).asCell());
 898     m_regExpProtoExec.set(vm, this, builtinRegExpExec);
 899     JSObject* regExpSymbolReplace = asObject(m_regExpPrototype-&gt;getDirect(vm, vm.propertyNames-&gt;replaceSymbol).asCell());
 900     m_regExpProtoSymbolReplace.set(vm, this, regExpSymbolReplace);
 901 
<a name="50" id="anc50"></a><span class="line-modified"> 902 #define CREATE_PRIVATE_GLOBAL_FUNCTION(name, code) JSFunction* name ## PrivateFunction = JSFunction::create(vm, code ## CodeGenerator(vm), this);</span>
 903     JSC_FOREACH_BUILTIN_FUNCTION_PRIVATE_GLOBAL_NAME(CREATE_PRIVATE_GLOBAL_FUNCTION)
 904 #undef CREATE_PRIVATE_GLOBAL_FUNCTION
 905 
 906     JSObject* arrayIteratorPrototype = ArrayIteratorPrototype::create(vm, this, ArrayIteratorPrototype::createStructure(vm, this, m_iteratorPrototype.get()));
<a name="51" id="anc51"></a><span class="line-modified"> 907     createArrayIteratorPrivateFunction-&gt;putDirect(vm, vm.propertyNames-&gt;prototype, arrayIteratorPrototype);</span>
 908 
 909     JSObject* asyncFromSyncIteratorPrototype = AsyncFromSyncIteratorPrototype::create(vm, this, AsyncFromSyncIteratorPrototype::createStructure(vm, this, m_iteratorPrototype.get()));
<a name="52" id="anc52"></a><span class="line-modified"> 910     AsyncFromSyncIteratorConstructorPrivateFunction-&gt;putDirect(vm, vm.propertyNames-&gt;prototype, asyncFromSyncIteratorPrototype);</span>
 911 
 912     JSObject* mapIteratorPrototype = MapIteratorPrototype::create(vm, this, MapIteratorPrototype::createStructure(vm, this, m_iteratorPrototype.get()));
<a name="53" id="anc53"></a><span class="line-modified"> 913     createMapIteratorPrivateFunction-&gt;putDirect(vm, vm.propertyNames-&gt;prototype, mapIteratorPrototype);</span>



 914 
 915     JSObject* setIteratorPrototype = SetIteratorPrototype::create(vm, this, SetIteratorPrototype::createStructure(vm, this, m_iteratorPrototype.get()));
<a name="54" id="anc54"></a><span class="line-modified"> 916     createSetIteratorPrivateFunction-&gt;putDirect(vm, vm.propertyNames-&gt;prototype, setIteratorPrototype);</span>
 917 
 918     GlobalPropertyInfo staticGlobals[] = {
<a name="55" id="anc55"></a><span class="line-modified"> 919 #define INIT_PRIVATE_GLOBAL(name, code) GlobalPropertyInfo(vm.propertyNames-&gt;builtinNames().name ## PrivateName(), name ## PrivateFunction, PropertyAttribute::DontEnum | PropertyAttribute::DontDelete | PropertyAttribute::ReadOnly),</span>
 920         JSC_FOREACH_BUILTIN_FUNCTION_PRIVATE_GLOBAL_NAME(INIT_PRIVATE_GLOBAL)
 921 #undef INIT_PRIVATE_GLOBAL
 922         GlobalPropertyInfo(vm.propertyNames-&gt;NaN, jsNaN(), PropertyAttribute::DontEnum | PropertyAttribute::DontDelete | PropertyAttribute::ReadOnly),
 923         GlobalPropertyInfo(vm.propertyNames-&gt;Infinity, jsNumber(std::numeric_limits&lt;double&gt;::infinity()), PropertyAttribute::DontEnum | PropertyAttribute::DontDelete | PropertyAttribute::ReadOnly),
 924         GlobalPropertyInfo(vm.propertyNames-&gt;undefinedKeyword, jsUndefined(), PropertyAttribute::DontEnum | PropertyAttribute::DontDelete | PropertyAttribute::ReadOnly),
 925         GlobalPropertyInfo(vm.propertyNames-&gt;builtinNames().propertyIsEnumerablePrivateName(), privateFuncPropertyIsEnumerable, PropertyAttribute::DontEnum | PropertyAttribute::DontDelete | PropertyAttribute::ReadOnly),
<a name="56" id="anc56"></a>
 926         GlobalPropertyInfo(vm.propertyNames-&gt;builtinNames().importModulePrivateName(), privateFuncImportModule, PropertyAttribute::DontEnum | PropertyAttribute::DontDelete | PropertyAttribute::ReadOnly),
 927         GlobalPropertyInfo(vm.propertyNames-&gt;builtinNames().enqueueJobPrivateName(), JSFunction::create(vm, this, 0, String(), enqueueJob), PropertyAttribute::DontEnum | PropertyAttribute::DontDelete | PropertyAttribute::ReadOnly),
<a name="57" id="anc57"></a><span class="line-modified"> 928         // FIXME: Offer @makeTypeError function instead of exposing @TypeError here.</span>
<span class="line-removed"> 929         // https://bugs.webkit.org/show_bug.cgi?id=193858</span>
<span class="line-removed"> 930         GlobalPropertyInfo(vm.propertyNames-&gt;builtinNames().TypeErrorPrivateName(), m_typeErrorStructure.constructor(this), PropertyAttribute::DontEnum | PropertyAttribute::DontDelete | PropertyAttribute::ReadOnly),</span>
 931         GlobalPropertyInfo(vm.propertyNames-&gt;builtinNames().typedArrayLengthPrivateName(), privateFuncTypedArrayLength, PropertyAttribute::DontEnum | PropertyAttribute::DontDelete | PropertyAttribute::ReadOnly),
 932         GlobalPropertyInfo(vm.propertyNames-&gt;builtinNames().typedArrayGetOriginalConstructorPrivateName(), privateFuncTypedArrayGetOriginalConstructor, PropertyAttribute::DontEnum | PropertyAttribute::DontDelete | PropertyAttribute::ReadOnly),
 933         GlobalPropertyInfo(vm.propertyNames-&gt;builtinNames().typedArraySortPrivateName(), privateFuncTypedArraySort, PropertyAttribute::DontEnum | PropertyAttribute::DontDelete | PropertyAttribute::ReadOnly),
 934         GlobalPropertyInfo(vm.propertyNames-&gt;builtinNames().isTypedArrayViewPrivateName(), privateFuncIsTypedArrayView, PropertyAttribute::DontEnum | PropertyAttribute::DontDelete | PropertyAttribute::ReadOnly),
 935         GlobalPropertyInfo(vm.propertyNames-&gt;builtinNames().typedArraySubarrayCreatePrivateName(), privateFuncTypedArraySubarrayCreate, PropertyAttribute::DontEnum | PropertyAttribute::DontDelete | PropertyAttribute::ReadOnly),
 936         GlobalPropertyInfo(vm.propertyNames-&gt;builtinNames().isBoundFunctionPrivateName(), privateFuncIsBoundFunction, PropertyAttribute::DontEnum | PropertyAttribute::DontDelete | PropertyAttribute::ReadOnly),
 937         GlobalPropertyInfo(vm.propertyNames-&gt;builtinNames().hasInstanceBoundFunctionPrivateName(), privateFuncHasInstanceBoundFunction, PropertyAttribute::DontEnum | PropertyAttribute::DontDelete | PropertyAttribute::ReadOnly),
 938         GlobalPropertyInfo(vm.propertyNames-&gt;builtinNames().instanceOfPrivateName(), privateFuncInstanceOf, PropertyAttribute::DontEnum | PropertyAttribute::DontDelete | PropertyAttribute::ReadOnly),
 939         GlobalPropertyInfo(vm.propertyNames-&gt;builtinNames().BuiltinLogPrivateName(), builtinLog, PropertyAttribute::DontEnum | PropertyAttribute::DontDelete | PropertyAttribute::ReadOnly),
 940         GlobalPropertyInfo(vm.propertyNames-&gt;builtinNames().BuiltinDescribePrivateName(), builtinDescribe, PropertyAttribute::DontEnum | PropertyAttribute::DontDelete | PropertyAttribute::ReadOnly),
 941         GlobalPropertyInfo(vm.propertyNames-&gt;builtinNames().RegExpPrivateName(), regExpConstructor, PropertyAttribute::DontEnum | PropertyAttribute::DontDelete | PropertyAttribute::ReadOnly),
 942         GlobalPropertyInfo(vm.propertyNames-&gt;builtinNames().truncPrivateName(), privateFuncTrunc, PropertyAttribute::DontEnum | PropertyAttribute::DontDelete | PropertyAttribute::ReadOnly),
 943         GlobalPropertyInfo(vm.propertyNames-&gt;builtinNames().PromisePrivateName(), promiseConstructor, PropertyAttribute::DontEnum | PropertyAttribute::DontDelete | PropertyAttribute::ReadOnly),
<a name="58" id="anc58"></a><span class="line-removed"> 944         GlobalPropertyInfo(vm.propertyNames-&gt;builtinNames().ReflectPrivateName(), reflectObject, PropertyAttribute::DontEnum | PropertyAttribute::DontDelete | PropertyAttribute::ReadOnly),</span>
 945         GlobalPropertyInfo(vm.propertyNames-&gt;builtinNames().InternalPromisePrivateName(), internalPromiseConstructor, PropertyAttribute::DontEnum | PropertyAttribute::DontDelete | PropertyAttribute::ReadOnly),
 946 
 947         GlobalPropertyInfo(vm.propertyNames-&gt;builtinNames().repeatCharacterPrivateName(), JSFunction::create(vm, this, 2, String(), stringProtoFuncRepeatCharacter), PropertyAttribute::DontEnum | PropertyAttribute::DontDelete | PropertyAttribute::ReadOnly),
<a name="59" id="anc59"></a>
 948         GlobalPropertyInfo(vm.propertyNames-&gt;builtinNames().isArrayPrivateName(), arrayConstructor-&gt;getDirect(vm, vm.propertyNames-&gt;isArray), PropertyAttribute::DontEnum | PropertyAttribute::DontDelete | PropertyAttribute::ReadOnly),
 949         GlobalPropertyInfo(vm.propertyNames-&gt;builtinNames().isArraySlowPrivateName(), privateFuncIsArraySlow, PropertyAttribute::DontEnum | PropertyAttribute::DontDelete | PropertyAttribute::ReadOnly),
<a name="60" id="anc60"></a><span class="line-removed"> 950         GlobalPropertyInfo(vm.propertyNames-&gt;builtinNames().isArrayConstructorPrivateName(), privateFuncIsArrayConstructor, PropertyAttribute::DontEnum | PropertyAttribute::DontDelete | PropertyAttribute::ReadOnly),</span>
 951         GlobalPropertyInfo(vm.propertyNames-&gt;builtinNames().concatMemcpyPrivateName(), privateFuncConcatMemcpy, PropertyAttribute::DontEnum | PropertyAttribute::DontDelete | PropertyAttribute::ReadOnly),
 952         GlobalPropertyInfo(vm.propertyNames-&gt;builtinNames().appendMemcpyPrivateName(), privateFuncAppendMemcpy, PropertyAttribute::DontEnum | PropertyAttribute::DontDelete | PropertyAttribute::ReadOnly),
 953 
 954         GlobalPropertyInfo(vm.propertyNames-&gt;builtinNames().hostPromiseRejectionTrackerPrivateName(), JSFunction::create(vm, this, 2, String(), globalFuncHostPromiseRejectionTracker), PropertyAttribute::DontEnum | PropertyAttribute::DontDelete | PropertyAttribute::ReadOnly),
 955         GlobalPropertyInfo(vm.propertyNames-&gt;builtinNames().InspectorInstrumentationPrivateName(), InspectorInstrumentationObject::create(vm, this, InspectorInstrumentationObject::createStructure(vm, this, m_objectPrototype.get())), PropertyAttribute::DontEnum | PropertyAttribute::DontDelete | PropertyAttribute::ReadOnly),
 956         GlobalPropertyInfo(vm.propertyNames-&gt;builtinNames().SetPrivateName(), setConstructor, PropertyAttribute::DontEnum | PropertyAttribute::DontDelete | PropertyAttribute::ReadOnly),
 957         GlobalPropertyInfo(vm.propertyNames-&gt;builtinNames().thisTimeValuePrivateName(), privateFuncThisTimeValue, PropertyAttribute::DontEnum | PropertyAttribute::DontDelete | PropertyAttribute::ReadOnly),
 958 #if ENABLE(INTL)
 959         GlobalPropertyInfo(vm.propertyNames-&gt;builtinNames().dateTimeFormatPrivateName(), privateFuncDateTimeFormat, PropertyAttribute::DontEnum | PropertyAttribute::DontDelete | PropertyAttribute::ReadOnly),
 960 #endif // ENABLE(INTL)
 961 
 962         GlobalPropertyInfo(vm.propertyNames-&gt;builtinNames().isConstructorPrivateName(), JSFunction::create(vm, this, 1, String(), esSpecIsConstructor, NoIntrinsic), PropertyAttribute::DontEnum | PropertyAttribute::DontDelete | PropertyAttribute::ReadOnly),
 963 
 964         GlobalPropertyInfo(vm.propertyNames-&gt;builtinNames().regExpProtoFlagsGetterPrivateName(), regExpProtoFlagsGetterObject, PropertyAttribute::DontEnum | PropertyAttribute::DontDelete | PropertyAttribute::ReadOnly),
 965         GlobalPropertyInfo(vm.propertyNames-&gt;builtinNames().regExpProtoGlobalGetterPrivateName(), regExpProtoGlobalGetterObject, PropertyAttribute::DontEnum | PropertyAttribute::DontDelete | PropertyAttribute::ReadOnly),
 966         GlobalPropertyInfo(vm.propertyNames-&gt;builtinNames().regExpProtoIgnoreCaseGetterPrivateName(), regExpProtoIgnoreCaseGetterObject, PropertyAttribute::DontEnum | PropertyAttribute::DontDelete | PropertyAttribute::ReadOnly),
 967         GlobalPropertyInfo(vm.propertyNames-&gt;builtinNames().regExpProtoMultilineGetterPrivateName(), regExpProtoMultilineGetterObject, PropertyAttribute::DontEnum | PropertyAttribute::DontDelete | PropertyAttribute::ReadOnly),
 968         GlobalPropertyInfo(vm.propertyNames-&gt;builtinNames().regExpProtoSourceGetterPrivateName(), regExpProtoSourceGetterObject, PropertyAttribute::DontEnum | PropertyAttribute::DontDelete | PropertyAttribute::ReadOnly),
 969         GlobalPropertyInfo(vm.propertyNames-&gt;builtinNames().regExpProtoStickyGetterPrivateName(), regExpProtoStickyGetterObject, PropertyAttribute::DontEnum | PropertyAttribute::DontDelete | PropertyAttribute::ReadOnly),
 970         GlobalPropertyInfo(vm.propertyNames-&gt;builtinNames().regExpProtoUnicodeGetterPrivateName(), regExpProtoUnicodeGetterObject, PropertyAttribute::DontEnum | PropertyAttribute::DontDelete | PropertyAttribute::ReadOnly),
 971 
 972         // RegExp.prototype helpers.
 973         GlobalPropertyInfo(vm.propertyNames-&gt;builtinNames().regExpBuiltinExecPrivateName(), builtinRegExpExec, PropertyAttribute::DontEnum | PropertyAttribute::DontDelete | PropertyAttribute::ReadOnly),
 974         GlobalPropertyInfo(vm.propertyNames-&gt;builtinNames().regExpCreatePrivateName(), JSFunction::create(vm, this, 2, String(), esSpecRegExpCreate, NoIntrinsic), PropertyAttribute::DontEnum | PropertyAttribute::DontDelete | PropertyAttribute::ReadOnly),
 975         GlobalPropertyInfo(vm.propertyNames-&gt;builtinNames().regExpMatchFastPrivateName(), JSFunction::create(vm, this, 1, String(), regExpProtoFuncMatchFast, RegExpMatchFastIntrinsic), PropertyAttribute::DontEnum | PropertyAttribute::DontDelete | PropertyAttribute::ReadOnly),
 976         GlobalPropertyInfo(vm.propertyNames-&gt;builtinNames().regExpSearchFastPrivateName(), JSFunction::create(vm, this, 1, String(), regExpProtoFuncSearchFast), PropertyAttribute::DontEnum | PropertyAttribute::DontDelete | PropertyAttribute::ReadOnly),
 977         GlobalPropertyInfo(vm.propertyNames-&gt;builtinNames().regExpSplitFastPrivateName(), JSFunction::create(vm, this, 2, String(), regExpProtoFuncSplitFast), PropertyAttribute::DontEnum | PropertyAttribute::DontDelete | PropertyAttribute::ReadOnly),
 978         GlobalPropertyInfo(vm.propertyNames-&gt;builtinNames().regExpPrototypeSymbolReplacePrivateName(), m_regExpPrototype-&gt;getDirect(vm, vm.propertyNames-&gt;replaceSymbol), PropertyAttribute::DontEnum | PropertyAttribute::DontDelete | PropertyAttribute::ReadOnly),
 979         GlobalPropertyInfo(vm.propertyNames-&gt;builtinNames().regExpTestFastPrivateName(), JSFunction::create(vm, this, 1, String(), regExpProtoFuncTestFast, RegExpTestFastIntrinsic), PropertyAttribute::DontEnum | PropertyAttribute::DontDelete | PropertyAttribute::ReadOnly),
 980 
 981         // String.prototype helpers.
 982         GlobalPropertyInfo(vm.propertyNames-&gt;builtinNames().stringIncludesInternalPrivateName(), JSFunction::create(vm, this, 1, String(), builtinStringIncludesInternal), PropertyAttribute::DontEnum | PropertyAttribute::DontDelete | PropertyAttribute::ReadOnly),
 983         GlobalPropertyInfo(vm.propertyNames-&gt;builtinNames().stringSplitFastPrivateName(), JSFunction::create(vm, this, 2, String(), stringProtoFuncSplitFast), PropertyAttribute::DontEnum | PropertyAttribute::DontDelete | PropertyAttribute::ReadOnly),
 984         GlobalPropertyInfo(vm.propertyNames-&gt;builtinNames().stringSubstrInternalPrivateName(), JSFunction::create(vm, this, 2, String(), builtinStringSubstrInternal), PropertyAttribute::DontEnum | PropertyAttribute::DontDelete | PropertyAttribute::ReadOnly),
 985 
 986         // Function prototype helpers.
 987         GlobalPropertyInfo(vm.propertyNames-&gt;builtinNames().makeBoundFunctionPrivateName(), JSFunction::create(vm, this, 5, String(), makeBoundFunction), PropertyAttribute::DontEnum | PropertyAttribute::DontDelete | PropertyAttribute::ReadOnly),
 988         GlobalPropertyInfo(vm.propertyNames-&gt;builtinNames().hasOwnLengthPropertyPrivateName(), JSFunction::create(vm, this, 1, String(), hasOwnLengthProperty), PropertyAttribute::DontEnum | PropertyAttribute::DontDelete | PropertyAttribute::ReadOnly),
 989 
 990         // Map and Set helpers.
 991         GlobalPropertyInfo(vm.propertyNames-&gt;builtinNames().mapBucketHeadPrivateName(), privateFuncMapBucketHead, PropertyAttribute::DontEnum | PropertyAttribute::DontDelete | PropertyAttribute::ReadOnly),
 992         GlobalPropertyInfo(vm.propertyNames-&gt;builtinNames().mapBucketNextPrivateName(), privateFuncMapBucketNext, PropertyAttribute::DontEnum | PropertyAttribute::DontDelete | PropertyAttribute::ReadOnly),
 993         GlobalPropertyInfo(vm.propertyNames-&gt;builtinNames().mapBucketKeyPrivateName(), privateFuncMapBucketKey, PropertyAttribute::DontEnum | PropertyAttribute::DontDelete | PropertyAttribute::ReadOnly),
 994         GlobalPropertyInfo(vm.propertyNames-&gt;builtinNames().mapBucketValuePrivateName(), privateFuncMapBucketValue, PropertyAttribute::DontEnum | PropertyAttribute::DontDelete | PropertyAttribute::ReadOnly),
 995         GlobalPropertyInfo(vm.propertyNames-&gt;builtinNames().setBucketHeadPrivateName(), privateFuncSetBucketHead, PropertyAttribute::DontEnum | PropertyAttribute::DontDelete | PropertyAttribute::ReadOnly),
 996         GlobalPropertyInfo(vm.propertyNames-&gt;builtinNames().setBucketNextPrivateName(), privateFuncSetBucketNext, PropertyAttribute::DontEnum | PropertyAttribute::DontDelete | PropertyAttribute::ReadOnly),
 997         GlobalPropertyInfo(vm.propertyNames-&gt;builtinNames().setBucketKeyPrivateName(), privateFuncSetBucketKey, PropertyAttribute::DontEnum | PropertyAttribute::DontDelete | PropertyAttribute::ReadOnly),
 998 #if ENABLE(WEBASSEMBLY) &amp;&amp; ENABLE(WEBASSEMBLY_STREAMING_API)
 999         // WebAssembly Streaming API
1000         GlobalPropertyInfo(vm.propertyNames-&gt;builtinNames().webAssemblyCompileStreamingInternalPrivateName(), JSFunction::create(vm, this, 1, String(), webAssemblyCompileStreamingInternal), PropertyAttribute::DontEnum | PropertyAttribute::DontDelete | PropertyAttribute::ReadOnly),
1001         GlobalPropertyInfo(vm.propertyNames-&gt;builtinNames().webAssemblyInstantiateStreamingInternalPrivateName(), JSFunction::create(vm, this, 1, String(), webAssemblyInstantiateStreamingInternal), PropertyAttribute::DontEnum | PropertyAttribute::DontDelete | PropertyAttribute::ReadOnly),
1002 #endif
1003 #if !ASSERT_DISABLED
1004         GlobalPropertyInfo(vm.propertyNames-&gt;builtinNames().assertPrivateName(), JSFunction::create(vm, this, 1, String(), assertCall), PropertyAttribute::DontEnum | PropertyAttribute::DontDelete | PropertyAttribute::ReadOnly),
1005 #endif
1006     };
1007     addStaticGlobals(staticGlobals, WTF_ARRAY_LENGTH(staticGlobals));
1008 
1009     m_specialPointers[Special::CallFunction] = m_callFunction.get();
1010     m_specialPointers[Special::ApplyFunction] = m_applyFunction.get();
1011     m_specialPointers[Special::ObjectConstructor] = objectConstructor;
1012     m_specialPointers[Special::ArrayConstructor] = arrayConstructor;
1013 
1014     m_linkTimeConstants[static_cast&lt;unsigned&gt;(LinkTimeConstant::ThrowTypeErrorFunction)] = m_throwTypeErrorFunction.get();
1015 
1016     if (UNLIKELY(Options::useDollarVM()))
1017         exposeDollarVM(vm);
1018 
1019 #if ENABLE(WEBASSEMBLY)
<a name="61" id="anc61"></a><span class="line-modified">1020     if (Options::useWebAssembly()) {</span>
<span class="line-modified">1021         auto* webAssemblyPrototype = WebAssemblyPrototype::create(vm, this, WebAssemblyPrototype::createStructure(vm, this, m_objectPrototype.get()));</span>
<span class="line-modified">1022         m_webAssemblyStructure.set(vm, this, JSWebAssembly::createStructure(vm, this, webAssemblyPrototype));</span>
<span class="line-modified">1023         m_webAssemblyModuleRecordStructure.set(vm, this, WebAssemblyModuleRecord::createStructure(vm, this, m_objectPrototype.get()));</span>
<span class="line-modified">1024         m_webAssemblyFunctionStructure.set(vm, this, WebAssemblyFunction::createStructure(vm, this, m_functionPrototype.get()));</span>
<span class="line-modified">1025         m_webAssemblyWrapperFunctionStructure.set(vm, this, WebAssemblyWrapperFunction::createStructure(vm, this, m_functionPrototype.get()));</span>
<span class="line-modified">1026         m_webAssemblyToJSCalleeStructure.set(vm, this, WebAssemblyToJSCallee::createStructure(vm, this, jsNull()));</span>
<span class="line-modified">1027         auto* webAssembly = JSWebAssembly::create(vm, this, m_webAssemblyStructure.get());</span>
<span class="line-modified">1028         putDirectWithoutTransition(vm, Identifier::fromString(exec, &quot;WebAssembly&quot;), webAssembly, static_cast&lt;unsigned&gt;(PropertyAttribute::DontEnum));</span>
<span class="line-modified">1029 </span>
<span class="line-modified">1030 #define CREATE_WEBASSEMBLY_CONSTRUCTOR(capitalName, lowerName, properName, instanceType, jsName, prototypeBase) do { \</span>
<span class="line-modified">1031         typedef capitalName ## Prototype Prototype; \</span>
<span class="line-modified">1032         typedef capitalName ## Constructor Constructor; \</span>
<span class="line-modified">1033         typedef JS ## capitalName JSObj; \</span>
<span class="line-modified">1034         auto* base = m_ ## prototypeBase ## Prototype.get(); \</span>
<span class="line-modified">1035         auto* prototype = Prototype::create(vm, this, Prototype::createStructure(vm, this, base)); \</span>
<span class="line-modified">1036         auto* structure = JSObj::createStructure(vm, this, prototype); \</span>
<span class="line-modified">1037         auto* constructor = Constructor::create(vm, Constructor::createStructure(vm, this, this-&gt;functionPrototype()), prototype); \</span>
<span class="line-modified">1038         prototype-&gt;putDirectWithoutTransition(vm, vm.propertyNames-&gt;constructor, constructor, static_cast&lt;unsigned&gt;(PropertyAttribute::DontEnum)); \</span>
<span class="line-modified">1039         m_ ## lowerName ## Prototype.set(vm, this, prototype); \</span>
<span class="line-modified">1040         m_ ## properName ## Structure.set(vm, this, structure); \</span>
<span class="line-modified">1041         webAssembly-&gt;putDirectWithoutTransition(vm, Identifier::fromString(this-&gt;globalExec(), #jsName), constructor, static_cast&lt;unsigned&gt;(PropertyAttribute::DontEnum)); \</span>
<span class="line-modified">1042     } while (0);</span>
<span class="line-modified">1043 </span>
<span class="line-modified">1044         FOR_EACH_WEBASSEMBLY_CONSTRUCTOR_TYPE(CREATE_WEBASSEMBLY_CONSTRUCTOR)</span>










1045 
1046 #undef CREATE_WEBASSEMBLY_CONSTRUCTOR
1047     }
1048 #endif // ENABLE(WEBASSEMBLY)
1049 
<a name="62" id="anc62"></a>

1050     auto setupAdaptiveWatchpoint = [&amp;] (JSObject* base, const Identifier&amp; ident) -&gt; ObjectPropertyCondition {
1051         // Performing these gets should not throw.
1052         ExecState* exec = globalExec();
1053         PropertySlot slot(base, PropertySlot::InternalMethodType::Get);
1054         bool result = base-&gt;getOwnPropertySlot(base, exec, ident, slot);
1055         ASSERT_UNUSED(result, result);
1056         catchScope.assertNoException();
1057         RELEASE_ASSERT(slot.isCacheableValue());
1058         JSValue functionValue = slot.getValue(exec, ident);
1059         catchScope.assertNoException();
1060         ASSERT(jsDynamicCast&lt;JSFunction*&gt;(vm, functionValue));
1061 
1062         ObjectPropertyCondition condition = generateConditionForSelfEquivalence(m_vm, nullptr, base, ident.impl());
1063         RELEASE_ASSERT(condition.requiredValue() == functionValue);
1064 
1065         bool isWatchable = condition.isWatchable(PropertyCondition::EnsureWatchability);
1066         RELEASE_ASSERT(isWatchable); // We allow this to install the necessary watchpoints.
1067 
1068         return condition;
1069     };
1070 
1071     {
1072         ObjectPropertyCondition condition = setupAdaptiveWatchpoint(arrayIteratorPrototype, m_vm.propertyNames-&gt;next);
<a name="63" id="anc63"></a><span class="line-modified">1073         m_arrayIteratorPrototypeNext = std::make_unique&lt;ObjectPropertyChangeAdaptiveWatchpoint&lt;InlineWatchpointSet&gt;&gt;(condition, m_arrayIteratorProtocolWatchpoint);</span>
1074         m_arrayIteratorPrototypeNext-&gt;install(vm);
1075     }
1076     {
1077         ObjectPropertyCondition condition = setupAdaptiveWatchpoint(this-&gt;arrayPrototype(), m_vm.propertyNames-&gt;iteratorSymbol);
<a name="64" id="anc64"></a><span class="line-modified">1078         m_arrayPrototypeSymbolIteratorWatchpoint = std::make_unique&lt;ObjectPropertyChangeAdaptiveWatchpoint&lt;InlineWatchpointSet&gt;&gt;(condition, m_arrayIteratorProtocolWatchpoint);</span>
1079         m_arrayPrototypeSymbolIteratorWatchpoint-&gt;install(vm);
1080     }
<a name="65" id="anc65"></a>




1081 
1082     {
1083         ObjectPropertyCondition condition = setupAdaptiveWatchpoint(mapIteratorPrototype, m_vm.propertyNames-&gt;next);
<a name="66" id="anc66"></a><span class="line-modified">1084         m_mapIteratorPrototypeNextWatchpoint = std::make_unique&lt;ObjectPropertyChangeAdaptiveWatchpoint&lt;InlineWatchpointSet&gt;&gt;(condition, m_mapIteratorProtocolWatchpoint);</span>
1085         m_mapIteratorPrototypeNextWatchpoint-&gt;install(vm);
1086     }
1087     {
1088         ObjectPropertyCondition condition = setupAdaptiveWatchpoint(m_mapPrototype.get(), m_vm.propertyNames-&gt;iteratorSymbol);
<a name="67" id="anc67"></a><span class="line-modified">1089         m_mapPrototypeSymbolIteratorWatchpoint = std::make_unique&lt;ObjectPropertyChangeAdaptiveWatchpoint&lt;InlineWatchpointSet&gt;&gt;(condition, m_mapIteratorProtocolWatchpoint);</span>
1090         m_mapPrototypeSymbolIteratorWatchpoint-&gt;install(vm);
1091     }
1092 
1093     {
1094         ObjectPropertyCondition condition = setupAdaptiveWatchpoint(setIteratorPrototype, m_vm.propertyNames-&gt;next);
<a name="68" id="anc68"></a><span class="line-modified">1095         m_setIteratorPrototypeNextWatchpoint = std::make_unique&lt;ObjectPropertyChangeAdaptiveWatchpoint&lt;InlineWatchpointSet&gt;&gt;(condition, m_setIteratorProtocolWatchpoint);</span>
1096         m_setIteratorPrototypeNextWatchpoint-&gt;install(vm);
1097     }
1098     {
1099         ObjectPropertyCondition condition = setupAdaptiveWatchpoint(m_setPrototype.get(), m_vm.propertyNames-&gt;iteratorSymbol);
<a name="69" id="anc69"></a><span class="line-modified">1100         m_setPrototypeSymbolIteratorWatchpoint = std::make_unique&lt;ObjectPropertyChangeAdaptiveWatchpoint&lt;InlineWatchpointSet&gt;&gt;(condition, m_setIteratorProtocolWatchpoint);</span>
1101         m_setPrototypeSymbolIteratorWatchpoint-&gt;install(vm);
1102     }
1103 
1104     {
1105         ObjectPropertyCondition condition = setupAdaptiveWatchpoint(m_stringIteratorPrototype.get(), m_vm.propertyNames-&gt;next);
<a name="70" id="anc70"></a><span class="line-modified">1106         m_stringIteratorPrototypeNextWatchpoint = std::make_unique&lt;ObjectPropertyChangeAdaptiveWatchpoint&lt;InlineWatchpointSet&gt;&gt;(condition, m_stringIteratorProtocolWatchpoint);</span>
1107         m_stringIteratorPrototypeNextWatchpoint-&gt;install(vm);
1108     }
1109     {
1110         ObjectPropertyCondition condition = setupAdaptiveWatchpoint(m_stringPrototype.get(), m_vm.propertyNames-&gt;iteratorSymbol);
<a name="71" id="anc71"></a><span class="line-modified">1111         m_stringPrototypeSymbolIteratorWatchpoint = std::make_unique&lt;ObjectPropertyChangeAdaptiveWatchpoint&lt;InlineWatchpointSet&gt;&gt;(condition, m_stringIteratorProtocolWatchpoint);</span>
1112         m_stringPrototypeSymbolIteratorWatchpoint-&gt;install(vm);
1113     }
1114 
1115     {
1116         ObjectPropertyCondition condition = setupAdaptiveWatchpoint(m_mapPrototype.get(), m_vm.propertyNames-&gt;set);
<a name="72" id="anc72"></a><span class="line-modified">1117         m_mapPrototypeSetWatchpoint = std::make_unique&lt;ObjectPropertyChangeAdaptiveWatchpoint&lt;InlineWatchpointSet&gt;&gt;(condition, m_mapSetWatchpoint);</span>
1118         m_mapPrototypeSetWatchpoint-&gt;install(vm);
1119     }
1120 
1121     {
1122         ObjectPropertyCondition condition = setupAdaptiveWatchpoint(m_setPrototype.get(), m_vm.propertyNames-&gt;add);
<a name="73" id="anc73"></a><span class="line-modified">1123         m_setPrototypeAddWatchpoint = std::make_unique&lt;ObjectPropertyChangeAdaptiveWatchpoint&lt;InlineWatchpointSet&gt;&gt;(condition, m_setAddWatchpoint);</span>
1124         m_setPrototypeAddWatchpoint-&gt;install(vm);
1125     }
1126 
1127     // Unfortunately, the prototype objects of the builtin objects can be touched from concurrent compilers. So eagerly initialize them only if we use JIT.
1128     if (VM::canUseJIT()) {
1129         this-&gt;booleanPrototype();
1130         auto* numberPrototype = this-&gt;numberPrototype();
1131         this-&gt;symbolPrototype();
1132 
1133         ObjectPropertyCondition condition = setupAdaptiveWatchpoint(numberPrototype, m_vm.propertyNames-&gt;toString);
<a name="74" id="anc74"></a><span class="line-modified">1134         m_numberPrototypeToStringWatchpoint = std::make_unique&lt;ObjectPropertyChangeAdaptiveWatchpoint&lt;InlineWatchpointSet&gt;&gt;(condition, m_numberToStringWatchpoint);</span>
1135         m_numberPrototypeToStringWatchpoint-&gt;install(vm);
1136         m_numberProtoToStringFunction.set(vm, this, jsCast&lt;JSFunction*&gt;(numberPrototype-&gt;getDirect(vm, vm.propertyNames-&gt;toString)));
1137     }
1138 
<a name="75" id="anc75"></a><span class="line-modified">1139     resetPrototype(vm, getPrototypeDirect(vm));</span>
1140 }
1141 
1142 bool JSGlobalObject::put(JSCell* cell, ExecState* exec, PropertyName propertyName, JSValue value, PutPropertySlot&amp; slot)
1143 {
1144     VM&amp; vm = exec-&gt;vm();
1145     auto scope = DECLARE_THROW_SCOPE(vm);
1146     JSGlobalObject* thisObject = jsCast&lt;JSGlobalObject*&gt;(cell);
1147     ASSERT(!Heap::heap(value) || Heap::heap(value) == Heap::heap(thisObject));
1148 
1149     if (UNLIKELY(isThisValueAltered(slot, thisObject)))
1150         RELEASE_AND_RETURN(scope, ordinarySetSlow(exec, thisObject, propertyName, value, slot.thisValue(), slot.isStrictMode()));
1151 
1152     bool shouldThrowReadOnlyError = slot.isStrictMode();
1153     bool ignoreReadOnlyErrors = false;
1154     bool putResult = false;
1155     bool done = symbolTablePutTouchWatchpointSet(thisObject, exec, propertyName, value, shouldThrowReadOnlyError, ignoreReadOnlyErrors, putResult);
1156     EXCEPTION_ASSERT((!!scope.exception() == (done &amp;&amp; !putResult)) || !shouldThrowReadOnlyError);
1157     if (done)
1158         return putResult;
1159     RELEASE_AND_RETURN(scope, Base::put(thisObject, exec, propertyName, value, slot));
1160 }
1161 
1162 bool JSGlobalObject::defineOwnProperty(JSObject* object, ExecState* exec, PropertyName propertyName, const PropertyDescriptor&amp; descriptor, bool shouldThrow)
1163 {
1164     JSGlobalObject* thisObject = jsCast&lt;JSGlobalObject*&gt;(object);
1165     PropertySlot slot(thisObject, PropertySlot::InternalMethodType::VMInquiry);
1166     // silently ignore attempts to add accessors aliasing vars.
1167     if (descriptor.isAccessorDescriptor() &amp;&amp; symbolTableGet(thisObject, propertyName, slot))
1168         return false;
1169     return Base::defineOwnProperty(thisObject, exec, propertyName, descriptor, shouldThrow);
1170 }
1171 
1172 void JSGlobalObject::addGlobalVar(const Identifier&amp; ident)
1173 {
1174     ConcurrentJSLocker locker(symbolTable()-&gt;m_lock);
1175     SymbolTableEntry entry = symbolTable()-&gt;get(locker, ident.impl());
1176     if (!entry.isNull())
1177         return;
1178 
1179     ScopeOffset offset = symbolTable()-&gt;takeNextScopeOffset(locker);
1180     SymbolTableEntry newEntry(VarOffset(offset), 0);
1181     newEntry.prepareToWatch();
1182     symbolTable()-&gt;add(locker, ident.impl(), WTFMove(newEntry));
1183 
1184     ScopeOffset offsetForAssert = addVariables(1, jsUndefined());
1185     RELEASE_ASSERT(offsetForAssert == offset);
1186 }
1187 
1188 void JSGlobalObject::addFunction(ExecState* exec, const Identifier&amp; propertyName)
1189 {
1190     VM&amp; vm = exec-&gt;vm();
1191     VM::DeletePropertyModeScope scope(vm, VM::DeletePropertyMode::IgnoreConfigurable);
1192     methodTable(vm)-&gt;deleteProperty(this, exec, propertyName);
1193     addGlobalVar(propertyName);
1194 }
1195 
1196 void JSGlobalObject::setGlobalScopeExtension(JSScope* scope)
1197 {
1198     m_globalScopeExtension.set(vm(), this, scope);
1199 }
1200 
1201 void JSGlobalObject::clearGlobalScopeExtension()
1202 {
1203     m_globalScopeExtension.clear();
1204 }
1205 
1206 static inline JSObject* lastInPrototypeChain(VM&amp; vm, JSObject* object)
1207 {
1208     JSObject* o = object;
1209     while (o-&gt;getPrototypeDirect(vm).isObject())
1210         o = asObject(o-&gt;getPrototypeDirect(vm));
1211     return o;
1212 }
1213 
1214 // Private namespace for helpers for JSGlobalObject::haveABadTime()
1215 namespace {
1216 
1217 class GlobalObjectDependencyFinder : public MarkedBlock::VoidFunctor {
1218 public:
1219     GlobalObjectDependencyFinder(VM&amp; vm)
1220         : m_vm(vm)
1221     { }
1222 
1223     IterationStatus operator()(HeapCell*, HeapCell::Kind) const;
1224 
1225     void addDependency(JSGlobalObject* key, JSGlobalObject* dependent);
1226     HashSet&lt;JSGlobalObject*&gt;* dependentsFor(JSGlobalObject* key);
1227 
1228 private:
1229     void visit(JSObject*);
1230 
1231     VM&amp; m_vm;
1232     HashMap&lt;JSGlobalObject*, HashSet&lt;JSGlobalObject*&gt;&gt; m_dependencies;
1233 };
1234 
1235 inline void GlobalObjectDependencyFinder::addDependency(JSGlobalObject* key, JSGlobalObject* dependent)
1236 {
1237     auto keyResult = m_dependencies.add(key, HashSet&lt;JSGlobalObject*&gt;());
1238     keyResult.iterator-&gt;value.add(dependent);
1239 }
1240 
1241 inline HashSet&lt;JSGlobalObject*&gt;* GlobalObjectDependencyFinder::dependentsFor(JSGlobalObject* key)
1242 {
1243     auto iterator = m_dependencies.find(key);
1244     if (iterator == m_dependencies.end())
1245         return nullptr;
1246     return &amp;iterator-&gt;value;
1247 }
1248 
1249 inline void GlobalObjectDependencyFinder::visit(JSObject* object)
1250 {
1251     VM&amp; vm = m_vm;
1252 
1253     if (!object-&gt;mayBePrototype())
1254         return;
1255 
1256     JSObject* current = object;
1257     JSGlobalObject* objectGlobalObject = object-&gt;globalObject(vm);
1258     do {
1259         JSValue prototypeValue = current-&gt;getPrototypeDirect(vm);
1260         if (prototypeValue.isNull())
1261             return;
1262         current = asObject(prototypeValue);
1263 
1264         JSGlobalObject* protoGlobalObject = current-&gt;globalObject(vm);
1265         if (protoGlobalObject != objectGlobalObject)
1266             addDependency(protoGlobalObject, objectGlobalObject);
1267     } while (true);
1268 }
1269 
1270 IterationStatus GlobalObjectDependencyFinder::operator()(HeapCell* cell, HeapCell::Kind kind) const
1271 {
1272     if (isJSCellKind(kind) &amp;&amp; static_cast&lt;JSCell*&gt;(cell)-&gt;isObject()) {
1273         // FIXME: This const_cast exists because this isn&#39;t a C++ lambda.
1274         // https://bugs.webkit.org/show_bug.cgi?id=159644
1275         const_cast&lt;GlobalObjectDependencyFinder*&gt;(this)-&gt;visit(jsCast&lt;JSObject*&gt;(static_cast&lt;JSCell*&gt;(cell)));
1276     }
1277     return IterationStatus::Continue;
1278 }
1279 
1280 enum class BadTimeFinderMode {
1281     SingleGlobal,
1282     MultipleGlobals
1283 };
1284 
1285 template&lt;BadTimeFinderMode mode&gt;
1286 class ObjectsWithBrokenIndexingFinder : public MarkedBlock::VoidFunctor {
1287 public:
1288     ObjectsWithBrokenIndexingFinder(VM&amp;, Vector&lt;JSObject*&gt;&amp;, JSGlobalObject*);
1289     ObjectsWithBrokenIndexingFinder(VM&amp;, Vector&lt;JSObject*&gt;&amp;, HashSet&lt;JSGlobalObject*&gt;&amp;);
1290 
1291     bool needsMultiGlobalsScan() const { return m_needsMultiGlobalsScan; }
1292     IterationStatus operator()(HeapCell*, HeapCell::Kind) const;
1293 
1294 private:
1295     IterationStatus visit(JSObject*);
1296 
1297     VM&amp; m_vm;
1298     Vector&lt;JSObject*&gt;&amp; m_foundObjects;
1299     JSGlobalObject* m_globalObject { nullptr }; // Only used for SingleBadTimeGlobal mode.
1300     HashSet&lt;JSGlobalObject*&gt;* m_globalObjects { nullptr }; // Only used for BadTimeGlobalGraph mode;
1301     bool m_needsMultiGlobalsScan { false };
1302 };
1303 
1304 template&lt;&gt;
1305 ObjectsWithBrokenIndexingFinder&lt;BadTimeFinderMode::SingleGlobal&gt;::ObjectsWithBrokenIndexingFinder(
1306     VM&amp; vm, Vector&lt;JSObject*&gt;&amp; foundObjects, JSGlobalObject* globalObject)
1307     : m_vm(vm)
1308     , m_foundObjects(foundObjects)
1309     , m_globalObject(globalObject)
1310 {
1311 }
1312 
1313 template&lt;&gt;
1314 ObjectsWithBrokenIndexingFinder&lt;BadTimeFinderMode::MultipleGlobals&gt;::ObjectsWithBrokenIndexingFinder(
1315     VM&amp; vm, Vector&lt;JSObject*&gt;&amp; foundObjects, HashSet&lt;JSGlobalObject*&gt;&amp; globalObjects)
1316     : m_vm(vm)
1317     , m_foundObjects(foundObjects)
1318     , m_globalObjects(&amp;globalObjects)
1319 {
1320 }
1321 
1322 inline bool hasBrokenIndexing(IndexingType type)
1323 {
1324     return type &amp;&amp; !hasSlowPutArrayStorage(type);
1325 }
1326 
1327 inline bool hasBrokenIndexing(JSObject* object)
1328 {
1329     IndexingType type = object-&gt;indexingType();
1330     return hasBrokenIndexing(type);
1331 }
1332 
1333 template&lt;BadTimeFinderMode mode&gt;
1334 inline IterationStatus ObjectsWithBrokenIndexingFinder&lt;mode&gt;::visit(JSObject* object)
1335 {
1336     VM&amp; vm = m_vm;
1337 
1338     // We only want to have a bad time in the affected global object, not in the entire
1339     // VM. But we have to be careful, since there may be objects that claim to belong to
1340     // a different global object that have prototypes from our global object.
1341     auto isInAffectedGlobalObject = [&amp;] (JSObject* object) {
1342         JSGlobalObject* objectGlobalObject { nullptr };
1343         bool objectMayBePrototype { false };
1344 
1345         if (mode == BadTimeFinderMode::SingleGlobal) {
1346             objectGlobalObject = object-&gt;globalObject(vm);
1347             if (objectGlobalObject == m_globalObject)
1348                 return true;
1349 
1350             objectMayBePrototype = object-&gt;mayBePrototype();
1351         }
1352 
1353         for (JSObject* current = object; ;) {
1354             JSGlobalObject* currentGlobalObject = current-&gt;globalObject(vm);
1355             if (mode == BadTimeFinderMode::SingleGlobal) {
1356                 if (objectMayBePrototype &amp;&amp; currentGlobalObject != objectGlobalObject)
1357                     m_needsMultiGlobalsScan = true;
1358                 if (currentGlobalObject == m_globalObject)
1359                     return true;
1360             } else {
1361                 if (m_globalObjects-&gt;contains(currentGlobalObject))
1362                     return true;
1363             }
1364 
1365             JSValue prototypeValue = current-&gt;getPrototypeDirect(vm);
1366             if (prototypeValue.isNull())
1367                 return false;
1368             current = asObject(prototypeValue);
1369         }
1370         RELEASE_ASSERT_NOT_REACHED();
1371     };
1372 
1373     if (JSFunction* function = jsDynamicCast&lt;JSFunction*&gt;(vm, object)) {
1374         if (FunctionRareData* rareData = function-&gt;rareData()) {
1375             // We only use this to cache JSFinalObjects. They do not start off with a broken indexing type.
1376             ASSERT(!(rareData-&gt;objectAllocationStructure() &amp;&amp; hasBrokenIndexing(rareData-&gt;objectAllocationStructure()-&gt;indexingType())));
1377 
1378             if (Structure* structure = rareData-&gt;internalFunctionAllocationStructure()) {
1379                 if (hasBrokenIndexing(structure-&gt;indexingType())) {
1380                     bool isRelevantGlobalObject =
1381                         (mode == BadTimeFinderMode::SingleGlobal
1382                             ? m_globalObject == structure-&gt;globalObject()
1383                             : m_globalObjects-&gt;contains(structure-&gt;globalObject()))
1384                         || (structure-&gt;hasMonoProto() &amp;&amp; !structure-&gt;storedPrototype().isNull() &amp;&amp; isInAffectedGlobalObject(asObject(structure-&gt;storedPrototype())));
1385                     if (mode == BadTimeFinderMode::SingleGlobal &amp;&amp; m_needsMultiGlobalsScan)
1386                         return IterationStatus::Done; // Bailing early and let the MultipleGlobals path handle everything.
1387                     if (isRelevantGlobalObject)
1388                         rareData-&gt;clearInternalFunctionAllocationProfile();
1389                 }
1390             }
1391         }
1392     }
1393 
1394     // Run this filter first, since it&#39;s cheap, and ought to filter out a lot of objects.
1395     if (!hasBrokenIndexing(object))
1396         return IterationStatus::Continue;
1397 
1398     if (isInAffectedGlobalObject(object))
1399         m_foundObjects.append(object);
1400 
1401     if (mode == BadTimeFinderMode::SingleGlobal &amp;&amp; m_needsMultiGlobalsScan)
1402         return IterationStatus::Done; // Bailing early and let the MultipleGlobals path handle everything.
1403 
1404     return IterationStatus::Continue;
1405 }
1406 
1407 template&lt;BadTimeFinderMode mode&gt;
1408 IterationStatus ObjectsWithBrokenIndexingFinder&lt;mode&gt;::operator()(HeapCell* cell, HeapCell::Kind kind) const
1409 {
1410     if (isJSCellKind(kind) &amp;&amp; static_cast&lt;JSCell*&gt;(cell)-&gt;isObject()) {
1411         // FIXME: This const_cast exists because this isn&#39;t a C++ lambda.
1412         // https://bugs.webkit.org/show_bug.cgi?id=159644
1413         return const_cast&lt;ObjectsWithBrokenIndexingFinder*&gt;(this)-&gt;visit(jsCast&lt;JSObject*&gt;(static_cast&lt;JSCell*&gt;(cell)));
1414     }
1415     return IterationStatus::Continue;
1416 }
1417 
1418 } // end private namespace for helpers for JSGlobalObject::haveABadTime()
1419 
1420 void JSGlobalObject::fireWatchpointAndMakeAllArrayStructuresSlowPut(VM&amp; vm)
1421 {
1422     if (isHavingABadTime())
1423         return;
1424 
1425     // Make sure that all allocations or indexed storage transitions that are inlining
1426     // the assumption that it&#39;s safe to transition to a non-SlowPut array storage don&#39;t
1427     // do so anymore.
1428     m_havingABadTimeWatchpoint-&gt;fireAll(vm, &quot;Having a bad time&quot;);
1429     ASSERT(isHavingABadTime()); // The watchpoint is what tells us that we&#39;re having a bad time.
1430 
1431     // Make sure that all JSArray allocations that load the appropriate structure from
1432     // this object now load a structure that uses SlowPut.
1433     for (unsigned i = 0; i &lt; NumberOfArrayIndexingModes; ++i)
1434         m_arrayStructureForIndexingShapeDuringAllocation[i].set(vm, this, originalArrayStructureForIndexingType(ArrayWithSlowPutArrayStorage));
1435 
1436     // Same for any special array structures.
1437     Structure* slowPutStructure;
1438     slowPutStructure = createRegExpMatchesArraySlowPutStructure(vm, this);
1439     m_regExpMatchesArrayStructure.set(vm, this, slowPutStructure);
1440     slowPutStructure = createRegExpMatchesArrayWithGroupsSlowPutStructure(vm, this);
1441     m_regExpMatchesArrayWithGroupsStructure.set(vm, this, slowPutStructure);
1442     slowPutStructure = ClonedArguments::createSlowPutStructure(vm, this, m_objectPrototype.get());
1443     m_clonedArgumentsStructure.set(vm, this, slowPutStructure);
1444 };
1445 
1446 void JSGlobalObject::haveABadTime(VM&amp; vm)
1447 {
1448     ASSERT(&amp;vm == &amp;this-&gt;vm());
1449 
1450     if (isHavingABadTime())
1451         return;
1452 
1453     vm.structureCache.clear(); // We may be caching array structures in here.
1454 
1455     DeferGC deferGC(vm.heap);
1456 
1457     // Consider the following objects and prototype chains:
1458     //    O (of global G1) -&gt; A (of global G1)
1459     //    B (of global G2) where G2 has a bad time
1460     //
1461     // If we set B as the prototype of A, G1 will need to have a bad time.
1462     // See comments in Structure::mayInterceptIndexedAccesses() for why.
1463     //
1464     // Now, consider the following objects and prototype chains:
1465     //    O1 (of global G1) -&gt; A1 (of global G1) -&gt; B1 (of global G2)
1466     //    O2 (of global G2) -&gt; A2 (of global G2)
1467     //    B2 (of global G3) where G3 has a bad time.
1468     //
1469     // G1 and G2 does not have a bad time, but G3 already has a bad time.
1470     // If we set B2 as the prototype of A2, then G2 needs to have a bad time.
1471     // Note that by induction, G1 also now needs to have a bad time because of
1472     // O1 -&gt; A1 -&gt; B1.
1473     //
1474     // We describe this as global G1 being affected by global G2, and G2 by G3.
1475     // Similarly, we say that G1 is dependent on G2, and G2 on G3.
1476     // Hence, when G3 has a bad time, we need to ensure that all globals that
1477     // are transitively dependent on it also have a bad time (G2 and G1 in this
1478     // example).
1479     //
1480     // Apart from clearing the VM structure cache above, there are 2 more things
1481     // that we have to do when globals have a bad time:
1482     // 1. For each affected global:
1483     //    a. Fire its HaveABadTime watchpoint.
1484     //    b. Convert all of its array structures to SlowPutArrayStorage.
1485     // 2. Make sure that all affected objects  switch to the slow kind of
1486     //    indexed storage. An object is considered to be affected if it has
1487     //    indexed storage and has a prototype object which may have indexed
1488     //    accessors. If the prototype object belongs to a global having a bad
1489     //    time, then the prototype object is considered to possibly have indexed
1490     //    accessors. See comments in Structure::mayInterceptIndexedAccesses()
1491     //    for details.
1492     //
1493     // Note: step 1 must be completed before step 2 because step 2 relies on
1494     // the HaveABadTime watchpoint having already been fired on all affected
1495     // globals.
1496     //
1497     // In the common case, only this global will start having a bad time here,
1498     // and no other globals are affected by it. So, we first proceed on this assumption
1499     // with a simpler ObjectsWithBrokenIndexingFinder scan to find heap objects
1500     // affected by this global that need to be converted to SlowPutArrayStorage.
1501     // We&#39;ll also have the finder check for the presence of other global objects
1502     // depending on this one.
1503     //
1504     // If we do discover other globals depending on this one, we&#39;ll abort this
1505     // first ObjectsWithBrokenIndexingFinder scan because it will be insufficient
1506     // to find all affected objects that need to be converted to SlowPutArrayStorage.
1507     // It also does not make dependent globals have a bad time. Instead, we&#39;ll
1508     // take a more comprehensive approach of first creating a dependency graph
1509     // between globals, and then using that graph to determine all affected
1510     // globals and objects. With that, we can make all affected globals have a
1511     // bad time, and convert all affected objects to SlowPutArrayStorage.
1512 
1513     fireWatchpointAndMakeAllArrayStructuresSlowPut(vm); // Step 1 above.
1514 
1515     Vector&lt;JSObject*&gt; foundObjects;
1516     ObjectsWithBrokenIndexingFinder&lt;BadTimeFinderMode::SingleGlobal&gt; finder(vm, foundObjects, this);
1517     {
1518         HeapIterationScope iterationScope(vm.heap);
1519         vm.heap.objectSpace().forEachLiveCell(iterationScope, finder); // Attempt step 2 above.
1520     }
1521 
1522     if (finder.needsMultiGlobalsScan()) {
1523         foundObjects.clear();
1524 
1525         // Find all globals that will also have a bad time as a side effect of
1526         // this global having a bad time.
1527         GlobalObjectDependencyFinder dependencies(vm);
1528         {
1529             HeapIterationScope iterationScope(vm.heap);
1530             vm.heap.objectSpace().forEachLiveCell(iterationScope, dependencies);
1531         }
1532 
1533         HashSet&lt;JSGlobalObject*&gt; globalsHavingABadTime;
1534         Deque&lt;JSGlobalObject*&gt; globals;
1535 
1536         globals.append(this);
1537         while (!globals.isEmpty()) {
1538             JSGlobalObject* global = globals.takeFirst();
1539             global-&gt;fireWatchpointAndMakeAllArrayStructuresSlowPut(vm); // Step 1 above.
1540             auto result = globalsHavingABadTime.add(global);
1541             if (result.isNewEntry) {
1542                 if (HashSet&lt;JSGlobalObject*&gt;* dependents = dependencies.dependentsFor(global)) {
1543                     for (JSGlobalObject* dependentGlobal : *dependents)
1544                         globals.append(dependentGlobal);
1545                 }
1546             }
1547         }
1548 
1549         ObjectsWithBrokenIndexingFinder&lt;BadTimeFinderMode::MultipleGlobals&gt; finder(vm, foundObjects, globalsHavingABadTime);
1550         {
1551             HeapIterationScope iterationScope(vm.heap);
1552             vm.heap.objectSpace().forEachLiveCell(iterationScope, finder); // Step 2 above.
1553         }
1554     }
1555 
1556     while (!foundObjects.isEmpty()) {
1557         JSObject* object = asObject(foundObjects.last());
1558         foundObjects.removeLast();
1559         ASSERT(hasBrokenIndexing(object));
1560         object-&gt;switchToSlowPutArrayStorage(vm);
1561     }
1562 }
1563 
<a name="76" id="anc76"></a><span class="line-modified">1564 // Set prototype, and also insert the object prototype at the end of the chain.</span>
<span class="line-removed">1565 void JSGlobalObject::resetPrototype(VM&amp; vm, JSValue prototype)</span>
1566 {
<a name="77" id="anc77"></a><span class="line-removed">1567     setPrototypeDirect(vm, prototype);</span>
<span class="line-removed">1568 </span>
1569     JSObject* oldLastInPrototypeChain = lastInPrototypeChain(vm, this);
1570     JSObject* objectPrototype = m_objectPrototype.get();
1571     if (oldLastInPrototypeChain != objectPrototype)
1572         oldLastInPrototypeChain-&gt;setPrototypeDirect(vm, objectPrototype);
<a name="78" id="anc78"></a>
1573 
<a name="79" id="anc79"></a>






1574     // Whenever we change the prototype of the global object, we need to create a new JSProxy with the correct prototype.
1575     setGlobalThis(vm, JSNonDestructibleProxy::create(vm, JSNonDestructibleProxy::createStructure(vm, this, prototype, PureForwardingProxyType), this));
1576 }
1577 
1578 void JSGlobalObject::visitChildren(JSCell* cell, SlotVisitor&amp; visitor)
1579 {
1580     JSGlobalObject* thisObject = jsCast&lt;JSGlobalObject*&gt;(cell);
1581     ASSERT_GC_OBJECT_INHERITS(thisObject, info());
1582     Base::visitChildren(thisObject, visitor);
1583 
1584     visitor.append(thisObject-&gt;m_globalThis);
1585 
1586     visitor.append(thisObject-&gt;m_globalLexicalEnvironment);
1587     visitor.append(thisObject-&gt;m_globalScopeExtension);
1588     visitor.append(thisObject-&gt;m_globalCallee);
1589     visitor.append(thisObject-&gt;m_stackOverflowFrameCallee);
<a name="80" id="anc80"></a><span class="line-removed">1590     visitor.append(thisObject-&gt;m_errorConstructor);</span>
1591     thisObject-&gt;m_evalErrorStructure.visit(visitor);
1592     thisObject-&gt;m_rangeErrorStructure.visit(visitor);
1593     thisObject-&gt;m_referenceErrorStructure.visit(visitor);
1594     thisObject-&gt;m_syntaxErrorStructure.visit(visitor);
1595     thisObject-&gt;m_typeErrorStructure.visit(visitor);
1596     thisObject-&gt;m_URIErrorStructure.visit(visitor);
1597     visitor.append(thisObject-&gt;m_objectConstructor);
1598     visitor.append(thisObject-&gt;m_promiseConstructor);
1599 
1600 #if ENABLE(INTL)
<a name="81" id="anc81"></a><span class="line-removed">1601     visitor.append(thisObject-&gt;m_intlObject);</span>
1602     visitor.append(thisObject-&gt;m_defaultCollator);
1603     thisObject-&gt;m_collatorStructure.visit(visitor);
1604     thisObject-&gt;m_numberFormatStructure.visit(visitor);
1605     thisObject-&gt;m_dateTimeFormatStructure.visit(visitor);
1606     thisObject-&gt;m_pluralRulesStructure.visit(visitor);
1607 #endif
1608     visitor.append(thisObject-&gt;m_nullGetterFunction);
1609     visitor.append(thisObject-&gt;m_nullSetterFunction);
1610 
<a name="82" id="anc82"></a><span class="line-modified">1611     visitor.append(thisObject-&gt;m_parseIntFunction);</span>
<span class="line-modified">1612     visitor.append(thisObject-&gt;m_parseFloatFunction);</span>
<span class="line-removed">1613     visitor.append(thisObject-&gt;m_evalFunction);</span>
1614     visitor.append(thisObject-&gt;m_callFunction);
1615     visitor.append(thisObject-&gt;m_applyFunction);
1616     visitor.append(thisObject-&gt;m_throwTypeErrorFunction);
1617     thisObject-&gt;m_arrayProtoToStringFunction.visit(visitor);
1618     thisObject-&gt;m_arrayProtoValuesFunction.visit(visitor);
<a name="83" id="anc83"></a>
1619     thisObject-&gt;m_initializePromiseFunction.visit(visitor);
1620     thisObject-&gt;m_iteratorProtocolFunction.visit(visitor);
1621     thisObject-&gt;m_promiseResolveFunction.visit(visitor);
1622     visitor.append(thisObject-&gt;m_objectProtoValueOfFunction);
1623     visitor.append(thisObject-&gt;m_numberProtoToStringFunction);
1624     visitor.append(thisObject-&gt;m_newPromiseCapabilityFunction);
1625     visitor.append(thisObject-&gt;m_functionProtoHasInstanceSymbolFunction);
1626     thisObject-&gt;m_throwTypeErrorGetterSetter.visit(visitor);
1627     visitor.append(thisObject-&gt;m_throwTypeErrorArgumentsCalleeAndCallerGetterSetter);
1628     thisObject-&gt;m_moduleLoader.visit(visitor);
1629 
1630     visitor.append(thisObject-&gt;m_objectPrototype);
1631     visitor.append(thisObject-&gt;m_functionPrototype);
1632     visitor.append(thisObject-&gt;m_arrayPrototype);
<a name="84" id="anc84"></a><span class="line-removed">1633     visitor.append(thisObject-&gt;m_errorPrototype);</span>
1634     visitor.append(thisObject-&gt;m_iteratorPrototype);
1635     visitor.append(thisObject-&gt;m_generatorFunctionPrototype);
1636     visitor.append(thisObject-&gt;m_generatorPrototype);
1637     visitor.append(thisObject-&gt;m_asyncFunctionPrototype);
1638     visitor.append(thisObject-&gt;m_asyncGeneratorPrototype);
1639     visitor.append(thisObject-&gt;m_asyncIteratorPrototype);
1640     visitor.append(thisObject-&gt;m_asyncGeneratorFunctionPrototype);
1641 
1642     thisObject-&gt;m_debuggerScopeStructure.visit(visitor);
1643     thisObject-&gt;m_withScopeStructure.visit(visitor);
<a name="85" id="anc85"></a><span class="line-modified">1644     visitor.append(thisObject-&gt;m_strictEvalActivationStructure);</span>
1645     visitor.append(thisObject-&gt;m_lexicalEnvironmentStructure);
1646     thisObject-&gt;m_moduleEnvironmentStructure.visit(visitor);
1647     visitor.append(thisObject-&gt;m_directArgumentsStructure);
1648     visitor.append(thisObject-&gt;m_scopedArgumentsStructure);
1649     visitor.append(thisObject-&gt;m_clonedArgumentsStructure);
1650     visitor.append(thisObject-&gt;m_objectStructureForObjectConstructor);
1651     for (unsigned i = 0; i &lt; NumberOfArrayIndexingModes; ++i)
1652         visitor.append(thisObject-&gt;m_originalArrayStructureForIndexingShape[i]);
1653     for (unsigned i = 0; i &lt; NumberOfArrayIndexingModes; ++i)
1654         visitor.append(thisObject-&gt;m_arrayStructureForIndexingShapeDuringAllocation[i]);
1655     thisObject-&gt;m_callbackConstructorStructure.visit(visitor);
1656     thisObject-&gt;m_callbackFunctionStructure.visit(visitor);
1657     thisObject-&gt;m_callbackObjectStructure.visit(visitor);
1658 #if JSC_OBJC_API_ENABLED
1659     thisObject-&gt;m_objcCallbackFunctionStructure.visit(visitor);
1660     thisObject-&gt;m_objcWrapperObjectStructure.visit(visitor);
1661 #endif
1662 #ifdef JSC_GLIB_API_ENABLED
1663     thisObject-&gt;m_glibCallbackFunctionStructure.visit(visitor);
1664     thisObject-&gt;m_glibWrapperObjectStructure.visit(visitor);
1665 #endif
1666     visitor.append(thisObject-&gt;m_nullPrototypeObjectStructure);
<a name="86" id="anc86"></a><span class="line-removed">1667     visitor.append(thisObject-&gt;m_errorStructure);</span>
1668     visitor.append(thisObject-&gt;m_calleeStructure);
1669 
1670     visitor.append(thisObject-&gt;m_hostFunctionStructure);
1671     auto visitFunctionStructures = [&amp;] (FunctionStructures&amp; structures) {
1672         visitor.append(structures.arrowFunctionStructure);
1673         visitor.append(structures.sloppyFunctionStructure);
1674         visitor.append(structures.strictFunctionStructure);
1675     };
1676     visitFunctionStructures(thisObject-&gt;m_builtinFunctions);
1677     visitFunctionStructures(thisObject-&gt;m_ordinaryFunctions);
1678 
1679     thisObject-&gt;m_customGetterSetterFunctionStructure.visit(visitor);
1680     thisObject-&gt;m_boundFunctionStructure.visit(visitor);
1681     visitor.append(thisObject-&gt;m_getterSetterStructure);
1682     thisObject-&gt;m_nativeStdFunctionStructure.visit(visitor);
<a name="87" id="anc87"></a><span class="line-removed">1683     visitor.append(thisObject-&gt;m_bigIntObjectStructure);</span>
1684     visitor.append(thisObject-&gt;m_regExpStructure);
1685     visitor.append(thisObject-&gt;m_generatorFunctionStructure);
1686     visitor.append(thisObject-&gt;m_asyncFunctionStructure);
1687     visitor.append(thisObject-&gt;m_asyncGeneratorFunctionStructure);
<a name="88" id="anc88"></a><span class="line-modified">1688     visitor.append(thisObject-&gt;m_iteratorResultObjectStructure);</span>
1689     visitor.append(thisObject-&gt;m_regExpMatchesArrayStructure);
1690     visitor.append(thisObject-&gt;m_regExpMatchesArrayWithGroupsStructure);
<a name="89" id="anc89"></a><span class="line-modified">1691     visitor.append(thisObject-&gt;m_moduleRecordStructure);</span>
<span class="line-modified">1692     visitor.append(thisObject-&gt;m_moduleNamespaceObjectStructure);</span>
<span class="line-modified">1693     visitor.append(thisObject-&gt;m_proxyObjectStructure);</span>
<span class="line-modified">1694     visitor.append(thisObject-&gt;m_callableProxyObjectStructure);</span>
<span class="line-modified">1695     visitor.append(thisObject-&gt;m_proxyRevokeStructure);</span>
<span class="line-modified">1696 </span>
<span class="line-removed">1697     visitor.append(thisObject-&gt;m_arrayBufferPrototype);</span>
<span class="line-removed">1698     visitor.append(thisObject-&gt;m_arrayBufferStructure);</span>
1699 #if ENABLE(SHARED_ARRAY_BUFFER)
1700     visitor.append(thisObject-&gt;m_sharedArrayBufferPrototype);
1701     visitor.append(thisObject-&gt;m_sharedArrayBufferStructure);
1702 #endif
1703 
<a name="90" id="anc90"></a><span class="line-modified">1704 #define VISIT_SIMPLE_TYPE(CapitalName, lowerName, properName, instanceType, jsName, prototypeBase) do { \</span>
1705         visitor.append(thisObject-&gt;m_ ## lowerName ## Prototype); \
1706         visitor.append(thisObject-&gt;m_ ## properName ## Structure); \
<a name="91" id="anc91"></a><span class="line-modified">1707     } while (0);</span>
1708 
1709     FOR_EACH_SIMPLE_BUILTIN_TYPE(VISIT_SIMPLE_TYPE)
<a name="92" id="anc92"></a><span class="line-removed">1710     if (UNLIKELY(Options::useBigInt()))</span>
<span class="line-removed">1711         FOR_BIG_INT_BUILTIN_TYPE_WITH_CONSTRUCTOR(VISIT_SIMPLE_TYPE)</span>
1712     FOR_EACH_BUILTIN_DERIVED_ITERATOR_TYPE(VISIT_SIMPLE_TYPE)
1713 
<a name="93" id="anc93"></a>




1714 #if ENABLE(WEBASSEMBLY)
<a name="94" id="anc94"></a><span class="line-modified">1715     visitor.append(thisObject-&gt;m_webAssemblyStructure);</span>
<span class="line-modified">1716     visitor.append(thisObject-&gt;m_webAssemblyModuleRecordStructure);</span>
<span class="line-modified">1717     visitor.append(thisObject-&gt;m_webAssemblyFunctionStructure);</span>
<span class="line-modified">1718     visitor.append(thisObject-&gt;m_webAssemblyWrapperFunctionStructure);</span>
<span class="line-modified">1719     visitor.append(thisObject-&gt;m_webAssemblyToJSCalleeStructure);</span>
<span class="line-modified">1720     FOR_EACH_WEBASSEMBLY_CONSTRUCTOR_TYPE(VISIT_SIMPLE_TYPE)</span>
1721 #endif // ENABLE(WEBASSEMBLY)
1722 
1723 #undef VISIT_SIMPLE_TYPE
<a name="95" id="anc95"></a><span class="line-removed">1724 </span>
<span class="line-removed">1725 #define VISIT_LAZY_TYPE(CapitalName, lowerName, properName, instanceType, jsName, prototypeBase) \</span>
<span class="line-removed">1726     thisObject-&gt;m_ ## properName ## Structure.visit(visitor);</span>
<span class="line-removed">1727 </span>
<span class="line-removed">1728     FOR_EACH_LAZY_BUILTIN_TYPE(VISIT_LAZY_TYPE)</span>
<span class="line-removed">1729 </span>
1730 #undef VISIT_LAZY_TYPE
1731 
1732     for (unsigned i = NumberOfTypedArrayTypes; i--;)
1733         thisObject-&gt;lazyTypedArrayStructure(indexToTypedArrayType(i)).visit(visitor);
1734 
1735     visitor.append(thisObject-&gt;m_speciesGetterSetter);
1736     thisObject-&gt;m_typedArrayProto.visit(visitor);
1737     thisObject-&gt;m_typedArraySuperConstructor.visit(visitor);
1738     thisObject-&gt;m_regExpGlobalData.visitAggregate(visitor);
1739 }
1740 
1741 ExecState* JSGlobalObject::globalExec()
1742 {
1743     return CallFrame::create(m_globalCallFrame);
1744 }
1745 
1746 void JSGlobalObject::exposeDollarVM(VM&amp; vm)
1747 {
1748     if (hasOwnProperty(globalExec(), vm.propertyNames-&gt;builtinNames().dollarVMPrivateName()))
1749         return;
1750 
1751     JSDollarVM* dollarVM = JSDollarVM::create(vm, JSDollarVM::createStructure(vm, this, m_objectPrototype.get()));
1752 
1753     GlobalPropertyInfo extraStaticGlobals[] = {
1754         GlobalPropertyInfo(vm.propertyNames-&gt;builtinNames().dollarVMPrivateName(), dollarVM, PropertyAttribute::DontEnum | PropertyAttribute::DontDelete | PropertyAttribute::ReadOnly),
1755     };
1756     addStaticGlobals(extraStaticGlobals, WTF_ARRAY_LENGTH(extraStaticGlobals));
1757 
<a name="96" id="anc96"></a><span class="line-modified">1758     putDirect(vm, Identifier::fromString(globalExec(), &quot;$vm&quot;), dollarVM, static_cast&lt;unsigned&gt;(PropertyAttribute::DontEnum));</span>
1759 }
1760 
1761 void JSGlobalObject::addStaticGlobals(GlobalPropertyInfo* globals, int count)
1762 {
1763     ScopeOffset startOffset = addVariables(count, jsUndefined());
1764 
1765     for (int i = 0; i &lt; count; ++i) {
1766         GlobalPropertyInfo&amp; global = globals[i];
1767         // This `configurable = false` is necessary condition for static globals,
1768         // otherwise lexical bindings can change the result of GlobalVar queries too.
1769         // We won&#39;t be able to declare a global lexical variable with the sanem name to
1770         // the static globals because configurable = false.
1771         ASSERT(global.attributes &amp; PropertyAttribute::DontDelete);
1772 
1773         WatchpointSet* watchpointSet = nullptr;
1774         WriteBarrierBase&lt;Unknown&gt;* variable = nullptr;
1775         {
1776             ConcurrentJSLocker locker(symbolTable()-&gt;m_lock);
1777             ScopeOffset offset = symbolTable()-&gt;takeNextScopeOffset(locker);
1778             RELEASE_ASSERT(offset == startOffset + i);
1779             SymbolTableEntry newEntry(VarOffset(offset), global.attributes);
1780             newEntry.prepareToWatch();
1781             watchpointSet = newEntry.watchpointSet();
1782             symbolTable()-&gt;add(locker, global.identifier.impl(), WTFMove(newEntry));
1783             variable = &amp;variableAt(offset);
1784         }
1785         symbolTablePutTouchWatchpointSet(vm(), this, global.identifier, global.value, variable, watchpointSet);
1786     }
1787 }
1788 
1789 bool JSGlobalObject::getOwnPropertySlot(JSObject* object, ExecState* exec, PropertyName propertyName, PropertySlot&amp; slot)
1790 {
1791     if (Base::getOwnPropertySlot(object, exec, propertyName, slot))
1792         return true;
1793     return symbolTableGet(jsCast&lt;JSGlobalObject*&gt;(object), propertyName, slot);
1794 }
1795 
1796 void JSGlobalObject::clearRareData(JSCell* cell)
1797 {
1798     jsCast&lt;JSGlobalObject*&gt;(cell)-&gt;m_rareData = nullptr;
1799 }
1800 
<a name="97" id="anc97"></a>






































































1801 void slowValidateCell(JSGlobalObject* globalObject)
1802 {
1803     RELEASE_ASSERT(globalObject-&gt;isGlobalObject());
1804     ASSERT_GC_OBJECT_INHERITS(globalObject, JSGlobalObject::info());
1805 }
1806 
1807 void JSGlobalObject::setRemoteDebuggingEnabled(bool enabled)
1808 {
1809 #if ENABLE(REMOTE_INSPECTOR)
1810     m_inspectorDebuggable-&gt;setRemoteDebuggingAllowed(enabled);
1811 #else
1812     UNUSED_PARAM(enabled);
1813 #endif
1814 }
1815 
1816 bool JSGlobalObject::remoteDebuggingEnabled() const
1817 {
1818 #if ENABLE(REMOTE_INSPECTOR)
1819     return m_inspectorDebuggable-&gt;remoteDebuggingAllowed();
1820 #else
1821     return false;
1822 #endif
1823 }
1824 
1825 void JSGlobalObject::setName(const String&amp; name)
1826 {
1827     m_name = name;
1828 
1829 #if ENABLE(REMOTE_INSPECTOR)
1830     m_inspectorDebuggable-&gt;update();
1831 #endif
1832 }
1833 
1834 # if ENABLE(INTL)
1835 static void addMissingScriptLocales(HashSet&lt;String&gt;&amp; availableLocales)
1836 {
1837     if (availableLocales.contains(&quot;pa-Arab-PK&quot;))
1838         availableLocales.add(&quot;pa-PK&quot;_s);
1839     if (availableLocales.contains(&quot;zh-Hans-CN&quot;))
1840         availableLocales.add(&quot;zh-CN&quot;_s);
1841     if (availableLocales.contains(&quot;zh-Hant-HK&quot;))
1842         availableLocales.add(&quot;zh-HK&quot;_s);
1843     if (availableLocales.contains(&quot;zh-Hans-SG&quot;))
1844         availableLocales.add(&quot;zh-SG&quot;_s);
1845     if (availableLocales.contains(&quot;zh-Hant-TW&quot;))
1846         availableLocales.add(&quot;zh-TW&quot;_s);
1847 }
1848 
1849 const HashSet&lt;String&gt;&amp; JSGlobalObject::intlCollatorAvailableLocales()
1850 {
1851     if (m_intlCollatorAvailableLocales.isEmpty()) {
1852         int32_t count = ucol_countAvailable();
1853         for (int32_t i = 0; i &lt; count; ++i) {
1854             String locale = convertICULocaleToBCP47LanguageTag(ucol_getAvailable(i));
1855             if (!locale.isEmpty())
1856                 m_intlCollatorAvailableLocales.add(locale);
1857         }
1858         addMissingScriptLocales(m_intlCollatorAvailableLocales);
1859     }
1860     return m_intlCollatorAvailableLocales;
1861 }
1862 
1863 const HashSet&lt;String&gt;&amp; JSGlobalObject::intlDateTimeFormatAvailableLocales()
1864 {
1865     if (m_intlDateTimeFormatAvailableLocales.isEmpty()) {
1866         int32_t count = udat_countAvailable();
1867         for (int32_t i = 0; i &lt; count; ++i) {
1868             String locale = convertICULocaleToBCP47LanguageTag(udat_getAvailable(i));
1869             if (!locale.isEmpty())
1870                 m_intlDateTimeFormatAvailableLocales.add(locale);
1871         }
1872         addMissingScriptLocales(m_intlDateTimeFormatAvailableLocales);
1873     }
1874     return m_intlDateTimeFormatAvailableLocales;
1875 }
1876 
1877 const HashSet&lt;String&gt;&amp; JSGlobalObject::intlNumberFormatAvailableLocales()
1878 {
1879     if (m_intlNumberFormatAvailableLocales.isEmpty()) {
1880         int32_t count = unum_countAvailable();
1881         for (int32_t i = 0; i &lt; count; ++i) {
1882             String locale = convertICULocaleToBCP47LanguageTag(unum_getAvailable(i));
1883             if (!locale.isEmpty())
1884                 m_intlNumberFormatAvailableLocales.add(locale);
1885         }
1886         addMissingScriptLocales(m_intlNumberFormatAvailableLocales);
1887     }
1888     return m_intlNumberFormatAvailableLocales;
1889 }
1890 
1891 const HashSet&lt;String&gt;&amp; JSGlobalObject::intlPluralRulesAvailableLocales()
1892 {
1893     if (m_intlPluralRulesAvailableLocales.isEmpty()) {
1894         int32_t count = uloc_countAvailable();
1895         for (int32_t i = 0; i &lt; count; ++i) {
1896             String locale = convertICULocaleToBCP47LanguageTag(uloc_getAvailable(i));
1897             if (!locale.isEmpty())
1898                 m_intlPluralRulesAvailableLocales.add(locale);
1899         }
1900         addMissingScriptLocales(m_intlPluralRulesAvailableLocales);
1901     }
1902     return m_intlPluralRulesAvailableLocales;
1903 }
1904 
1905 IntlCollator* JSGlobalObject::defaultCollator(ExecState* exec)
1906 {
1907     VM&amp; vm = exec-&gt;vm();
1908     auto scope = DECLARE_THROW_SCOPE(vm);
1909 
1910     if (m_defaultCollator)
1911         return m_defaultCollator.get();
1912 
1913     IntlCollator* collator = IntlCollator::create(vm, collatorStructure());
1914     collator-&gt;initializeCollator(*exec, jsUndefined(), jsUndefined());
1915     RETURN_IF_EXCEPTION(scope, nullptr);
1916     m_defaultCollator.set(vm, this, collator);
1917     return collator;
1918 }
1919 
1920 #endif // ENABLE(INTL)
1921 
1922 void JSGlobalObject::bumpGlobalLexicalBindingEpoch(VM&amp; vm)
1923 {
1924     if (++m_globalLexicalBindingEpoch == Options::thresholdForGlobalLexicalBindingEpoch()) {
1925         // Since the epoch overflows, we should rewrite all the CodeBlock to adjust to the newly started generation.
1926         m_globalLexicalBindingEpoch = 1;
1927         vm.heap.codeBlockSet().iterate([&amp;] (CodeBlock* codeBlock) {
1928             if (codeBlock-&gt;globalObject() != this)
1929                 return;
1930             codeBlock-&gt;notifyLexicalBindingUpdate();
1931         });
1932     }
1933 }
1934 
1935 void JSGlobalObject::queueMicrotask(Ref&lt;Microtask&gt;&amp;&amp; task)
1936 {
1937     if (globalObjectMethodTable()-&gt;queueTaskToEventLoop) {
1938         globalObjectMethodTable()-&gt;queueTaskToEventLoop(*this, WTFMove(task));
1939         return;
1940     }
1941 
1942     vm().queueMicrotask(*this, WTFMove(task));
1943 }
1944 
1945 void JSGlobalObject::setDebugger(Debugger* debugger)
1946 {
1947     m_debugger = debugger;
1948     if (debugger)
1949         vm().ensureShadowChicken();
1950 }
1951 
1952 bool JSGlobalObject::hasDebugger() const
1953 {
1954     return m_debugger;
1955 }
1956 
1957 bool JSGlobalObject::hasInteractiveDebugger() const
1958 {
1959     return m_debugger &amp;&amp; m_debugger-&gt;isInteractivelyDebugging();
1960 }
1961 
1962 #if ENABLE(DFG_JIT)
1963 WatchpointSet* JSGlobalObject::getReferencedPropertyWatchpointSet(UniquedStringImpl* uid)
1964 {
1965     ConcurrentJSLocker locker(m_referencedGlobalPropertyWatchpointSetsLock);
1966     return m_referencedGlobalPropertyWatchpointSets.get(uid);
1967 }
1968 
1969 WatchpointSet&amp; JSGlobalObject::ensureReferencedPropertyWatchpointSet(UniquedStringImpl* uid)
1970 {
1971     ConcurrentJSLocker locker(m_referencedGlobalPropertyWatchpointSetsLock);
1972     return m_referencedGlobalPropertyWatchpointSets.ensure(uid, [] {
1973         return WatchpointSet::create(IsWatched);
1974     }).iterator-&gt;value.get();
1975 }
1976 #endif
1977 
1978 JSGlobalObject* JSGlobalObject::create(VM&amp; vm, Structure* structure)
1979 {
1980     JSGlobalObject* globalObject = new (NotNull, allocateCell&lt;JSGlobalObject&gt;(vm.heap)) JSGlobalObject(vm, structure);
1981     globalObject-&gt;finishCreation(vm);
1982     return globalObject;
1983 }
1984 
1985 void JSGlobalObject::finishCreation(VM&amp; vm)
1986 {
1987     Base::finishCreation(vm);
1988     structure(vm)-&gt;setGlobalObject(vm, this);
1989     m_runtimeFlags = m_globalObjectMethodTable-&gt;javaScriptRuntimeFlags(this);
1990     init(vm);
1991     setGlobalThis(vm, JSNonDestructibleProxy::create(vm, JSNonDestructibleProxy::createStructure(vm, this, getPrototypeDirect(vm), PureForwardingProxyType), this));
1992     ASSERT(type() == GlobalObjectType);
1993 }
1994 
1995 void JSGlobalObject::finishCreation(VM&amp; vm, JSObject* thisValue)
1996 {
1997     Base::finishCreation(vm);
1998     structure(vm)-&gt;setGlobalObject(vm, this);
1999     m_runtimeFlags = m_globalObjectMethodTable-&gt;javaScriptRuntimeFlags(this);
2000     init(vm);
2001     setGlobalThis(vm, thisValue);
2002     ASSERT(type() == GlobalObjectType);
2003 }
2004 
2005 #ifdef JSC_GLIB_API_ENABLED
2006 void JSGlobalObject::setWrapperMap(std::unique_ptr&lt;WrapperMap&gt;&amp;&amp; map)
2007 {
2008     m_wrapperMap = WTFMove(map);
2009 }
2010 #endif
2011 
2012 } // namespace JSC
<a name="98" id="anc98"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="98" type="hidden" />
</body>
</html>