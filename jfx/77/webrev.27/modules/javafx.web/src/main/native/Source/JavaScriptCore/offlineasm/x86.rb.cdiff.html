<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff modules/javafx.web/src/main/native/Source/JavaScriptCore/offlineasm/x86.rb</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="registers.rb.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="../parser/ASTBuilder.h.cdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/JavaScriptCore/offlineasm/x86.rb</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 47,11 ***</span>
  # rdi =&gt;     a0
  # rsi =&gt; t1, a1
  # rdx =&gt; t2, a2, r1
  # rcx =&gt; t3, a3
  #  r8 =&gt; t4
<span class="line-modified">! # r10 =&gt; t5</span>
  # rbx =&gt;             csr0 (callee-save, PB, unused in baseline)
  # r12 =&gt;             csr1 (callee-save)
  # r13 =&gt;             csr2 (callee-save)
  # r14 =&gt;             csr3 (callee-save, tagTypeNumber)
  # r15 =&gt;             csr4 (callee-save, tagMask)
<span class="line-new-header">--- 47,12 ---</span>
  # rdi =&gt;     a0
  # rsi =&gt; t1, a1
  # rdx =&gt; t2, a2, r1
  # rcx =&gt; t3, a3
  #  r8 =&gt; t4
<span class="line-modified">! #  r9 =&gt; t5</span>
<span class="line-added">+ # r10 =&gt; t6</span>
  # rbx =&gt;             csr0 (callee-save, PB, unused in baseline)
  # r12 =&gt;             csr1 (callee-save)
  # r13 =&gt;             csr2 (callee-save)
  # r14 =&gt;             csr3 (callee-save, tagTypeNumber)
  # r15 =&gt;             csr4 (callee-save, tagMask)
</pre>
<hr />
<pre>
<span class="line-old-header">*** 62,11 ***</span>
  # On x86-64 windows
  # Arguments need to be push/pop&#39;d on the stack in addition to being stored in
  # the registers. Also, &gt;8 return types are returned in a weird way.
  #
  # rax =&gt; t0,     r0
<span class="line-modified">! # rcx =&gt;     a0</span>
  # rdx =&gt; t1, a1, r1
  #  r8 =&gt; t2, a2
  #  r9 =&gt; t3, a3
  # r10 =&gt; t4
  # rbx =&gt;             csr0 (callee-save, PB, unused in baseline)
<span class="line-new-header">--- 63,11 ---</span>
  # On x86-64 windows
  # Arguments need to be push/pop&#39;d on the stack in addition to being stored in
  # the registers. Also, &gt;8 return types are returned in a weird way.
  #
  # rax =&gt; t0,     r0
<span class="line-modified">! # rcx =&gt; t5, a0</span>
  # rdx =&gt; t1, a1, r1
  #  r8 =&gt; t2, a2
  #  r9 =&gt; t3, a3
  # r10 =&gt; t4
  # rbx =&gt;             csr0 (callee-save, PB, unused in baseline)
</pre>
<hr />
<pre>
<span class="line-old-header">*** 108,25 ***</span>
      else
          raise &quot;bad value for $activeBackend: #{$activeBackend}&quot;
      end
  end
  
<span class="line-removed">- def useX87</span>
<span class="line-removed">-     case $activeBackend</span>
<span class="line-removed">-     when &quot;X86&quot;</span>
<span class="line-removed">-         true</span>
<span class="line-removed">-     when &quot;X86_WIN&quot;</span>
<span class="line-removed">-         true</span>
<span class="line-removed">-     when &quot;X86_64&quot;</span>
<span class="line-removed">-         false</span>
<span class="line-removed">-     when &quot;X86_64_WIN&quot;</span>
<span class="line-removed">-         false</span>
<span class="line-removed">-     else</span>
<span class="line-removed">-         raise &quot;bad value for $activeBackend: #{$activeBackend}&quot;</span>
<span class="line-removed">-     end</span>
<span class="line-removed">- end</span>
<span class="line-removed">- </span>
  def isMSVC
      $options.has_key?(:assembler) &amp;&amp; $options[:assembler] == &quot;MASM&quot;
  end
  
  def isIntelSyntax
<span class="line-new-header">--- 109,10 ---</span>
</pre>
<hr />
<pre>
<span class="line-old-header">*** 339,11 ***</span>
  end
  
  class FPRegisterID
      def x86Operand(kind)
          raise unless kind == :double
<span class="line-removed">-         raise if useX87</span>
          case name
          when &quot;ft0&quot;, &quot;fa0&quot;, &quot;fr&quot;
              register(&quot;xmm0&quot;)
          when &quot;ft1&quot;, &quot;fa1&quot;
              register(&quot;xmm1&quot;)
<span class="line-new-header">--- 325,10 ---</span>
</pre>
<hr />
<pre>
<span class="line-old-header">*** 357,27 ***</span>
              register(&quot;xmm5&quot;)
          else
              raise &quot;Bad register #{name} for X86 at #{codeOriginString}&quot;
          end
      end
<span class="line-removed">-     def x87DefaultStackPosition</span>
<span class="line-removed">-         case name</span>
<span class="line-removed">-         when &quot;ft0&quot;, &quot;fr&quot;</span>
<span class="line-removed">-             0</span>
<span class="line-removed">-         when &quot;ft1&quot;</span>
<span class="line-removed">-             1</span>
<span class="line-removed">-         when &quot;ft2&quot;, &quot;ft3&quot;, &quot;ft4&quot;, &quot;ft5&quot;</span>
<span class="line-removed">-             raise &quot;Unimplemented register #{name} for X86 at #{codeOriginString}&quot;</span>
<span class="line-removed">-         else</span>
<span class="line-removed">-             raise &quot;Bad register #{name} for X86 at #{codeOriginString}&quot;</span>
<span class="line-removed">-         end</span>
<span class="line-removed">-     end</span>
<span class="line-removed">-     def x87Operand(offset)</span>
<span class="line-removed">-         raise unless useX87</span>
<span class="line-removed">-         raise unless offset == 0 or offset == 1</span>
<span class="line-removed">-         &quot;#{register(&quot;st&quot;)}(#{x87DefaultStackPosition + offset})&quot;</span>
<span class="line-removed">-     end</span>
      def x86CallOperand(kind)
          &quot;#{callPrefix}#{x86Operand(kind)}&quot;
      end
  end
  
<span class="line-new-header">--- 342,10 ---</span>
</pre>
<hr />
<pre>
<span class="line-old-header">*** 559,11 ***</span>
          when :ptr
              isX64 ? &quot;q&quot; : &quot;l&quot;
          when :quad
              isX64 ? &quot;q&quot; : raise
          when :double
<span class="line-modified">!             not useX87 ? &quot;sd&quot; : raise</span>
          else
              raise
          end
      end
      
<span class="line-new-header">--- 527,11 ---</span>
          when :ptr
              isX64 ? &quot;q&quot; : &quot;l&quot;
          when :quad
              isX64 ? &quot;q&quot; : raise
          when :double
<span class="line-modified">!             &quot;sd&quot;</span>
          else
              raise
          end
      end
      
</pre>
<hr />
<pre>
<span class="line-old-header">*** 631,21 ***</span>
              $asm.puts &quot;xchg#{x86Suffix(:ptr)} #{operands[0].x86Operand(:ptr)}, #{x86GPRName(&quot;ecx&quot;, :ptr)}&quot;
          end
      end
      
      def handleX86DoubleBranch(branchOpcode, mode)
<span class="line-modified">!         if useX87</span>
<span class="line-modified">!             handleX87Compare(mode)</span>
          else
<span class="line-modified">!             case mode</span>
<span class="line-removed">-             when :normal</span>
<span class="line-removed">-                 $asm.puts &quot;ucomisd #{orderOperands(operands[1].x86Operand(:double), operands[0].x86Operand(:double))}&quot;</span>
<span class="line-removed">-             when :reverse</span>
<span class="line-removed">-                 $asm.puts &quot;ucomisd #{orderOperands(operands[0].x86Operand(:double), operands[1].x86Operand(:double))}&quot;</span>
<span class="line-removed">-             else</span>
<span class="line-removed">-                 raise mode.inspect</span>
<span class="line-removed">-             end</span>
          end
          $asm.puts &quot;#{branchOpcode} #{operands[2].asmLabel}&quot;
      end
      
      def handleX86IntCompare(opcodeSuffix, kind)
<span class="line-new-header">--- 599,17 ---</span>
              $asm.puts &quot;xchg#{x86Suffix(:ptr)} #{operands[0].x86Operand(:ptr)}, #{x86GPRName(&quot;ecx&quot;, :ptr)}&quot;
          end
      end
      
      def handleX86DoubleBranch(branchOpcode, mode)
<span class="line-modified">!         case mode</span>
<span class="line-modified">!         when :normal</span>
<span class="line-added">+             $asm.puts &quot;ucomisd #{orderOperands(operands[1].x86Operand(:double), operands[0].x86Operand(:double))}&quot;</span>
<span class="line-added">+         when :reverse</span>
<span class="line-added">+             $asm.puts &quot;ucomisd #{orderOperands(operands[0].x86Operand(:double), operands[1].x86Operand(:double))}&quot;</span>
          else
<span class="line-modified">!             raise mode.inspect</span>
          end
          $asm.puts &quot;#{branchOpcode} #{operands[2].asmLabel}&quot;
      end
      
      def handleX86IntCompare(opcodeSuffix, kind)
</pre>
<hr />
<pre>
<span class="line-old-header">*** 859,47 ***</span>
                  $asm.puts &quot;mov#{x86Suffix(:ptr)} #{x86Operands(:ptr, :ptr)}&quot;
              end
          end
      end
  
<span class="line-removed">-     def handleX87Compare(mode)</span>
<span class="line-removed">-         floatingPointCompareImplicitOperand = getImplicitOperandString</span>
<span class="line-removed">-         case mode</span>
<span class="line-removed">-         when :normal</span>
<span class="line-removed">-             if (operands[0].x87DefaultStackPosition == 0)</span>
<span class="line-removed">-                 $asm.puts &quot;fucomi #{floatingPointCompareImplicitOperand}#{operands[1].x87Operand(0)}&quot;</span>
<span class="line-removed">-             else</span>
<span class="line-removed">-                 $asm.puts &quot;fld #{operands[0].x87Operand(0)}&quot;</span>
<span class="line-removed">-                 $asm.puts &quot;fucomip #{floatingPointCompareImplicitOperand}#{operands[1].x87Operand(1)}&quot;</span>
<span class="line-removed">-             end</span>
<span class="line-removed">-         when :reverse</span>
<span class="line-removed">-             if (operands[1].x87DefaultStackPosition == 0)</span>
<span class="line-removed">-                 $asm.puts &quot;fucomi #{floatingPointCompareImplicitOperand}#{operands[0].x87Operand(0)}&quot;</span>
<span class="line-removed">-             else</span>
<span class="line-removed">-                 $asm.puts &quot;fld #{operands[1].x87Operand(0)}&quot;</span>
<span class="line-removed">-                 $asm.puts &quot;fucomip #{floatingPointCompareImplicitOperand}#{operands[0].x87Operand(1)}&quot;</span>
<span class="line-removed">-             end</span>
<span class="line-removed">-         else</span>
<span class="line-removed">-             raise mode.inspect</span>
<span class="line-removed">-         end</span>
<span class="line-removed">-     end</span>
<span class="line-removed">- </span>
<span class="line-removed">-     def handleX87BinOp(opcode, opcodereverse)</span>
<span class="line-removed">-         if (operands[1].x87DefaultStackPosition == 0)</span>
<span class="line-removed">-             $asm.puts &quot;#{opcode} #{orderOperands(operands[0].x87Operand(0), register(&quot;st&quot;))}&quot;</span>
<span class="line-removed">-         elsif (operands[0].x87DefaultStackPosition == 0)</span>
<span class="line-removed">-             if !isIntelSyntax</span>
<span class="line-removed">-                 $asm.puts &quot;#{opcodereverse} #{register(&quot;st&quot;)}, #{operands[1].x87Operand(0)}&quot;</span>
<span class="line-removed">-             else</span>
<span class="line-removed">-                 $asm.puts &quot;#{opcode} #{operands[1].x87Operand(0)}, #{register(&quot;st&quot;)}&quot;</span>
<span class="line-removed">-             end</span>
<span class="line-removed">-         else</span>
<span class="line-removed">-             $asm.puts &quot;fld #{operands[0].x87Operand(0)}&quot;</span>
<span class="line-removed">-             $asm.puts &quot;#{opcodereverse}p #{orderOperands(register(&quot;st&quot;), operands[1].x87Operand(1))}&quot;</span>
<span class="line-removed">-         end</span>
<span class="line-removed">-     end</span>
<span class="line-removed">- </span>
      def lowerX86
          raise unless $activeBackend == &quot;X86&quot;
          lowerX86Common
      end
  
<span class="line-new-header">--- 823,10 ---</span>
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1010,120 ***</span>
              if !isIntelSyntax
                  $asm.puts &quot;movzbl #{x86LoadOperands(:byte, :int)}&quot;
              else
                  $asm.puts &quot;movzx #{x86LoadOperands(:byte, :int)}&quot;
              end
<span class="line-modified">!         when &quot;loadbs&quot;</span>
              if !isIntelSyntax
                  $asm.puts &quot;movsbl #{x86LoadOperands(:byte, :int)}&quot;
              else
                  $asm.puts &quot;movsx #{x86LoadOperands(:byte, :int)}&quot;
              end
<span class="line-modified">!         when &quot;loadbsp&quot;</span>
              if !isIntelSyntax
<span class="line-modified">!                 $asm.puts &quot;movsb#{x86Suffix(:ptr)} #{x86LoadOperands(:byte, :ptr)}&quot;</span>
              else
<span class="line-modified">!                 $asm.puts &quot;movsx #{x86LoadOperands(:byte, :ptr)}&quot;</span>
              end
          when &quot;loadh&quot;
              if !isIntelSyntax
                  $asm.puts &quot;movzwl #{x86LoadOperands(:half, :int)}&quot;
              else
                  $asm.puts &quot;movzx #{x86LoadOperands(:half, :int)}&quot;
              end
<span class="line-modified">!         when &quot;loadhs&quot;</span>
              if !isIntelSyntax
                  $asm.puts &quot;movswl #{x86LoadOperands(:half, :int)}&quot;
              else
                  $asm.puts &quot;movsx #{x86LoadOperands(:half, :int)}&quot;
              end
          when &quot;storeb&quot;
              $asm.puts &quot;mov#{x86Suffix(:byte)} #{x86Operands(:byte, :byte)}&quot;
          when &quot;loadd&quot;
<span class="line-modified">!             if useX87</span>
<span class="line-removed">-                 if !isIntelSyntax</span>
<span class="line-removed">-                     $asm.puts &quot;fldl #{operands[0].x86Operand(:double)}&quot;</span>
<span class="line-removed">-                 else</span>
<span class="line-removed">-                     $asm.puts &quot;fld #{operands[0].x86Operand(:double)}&quot;</span>
<span class="line-removed">-                 end</span>
<span class="line-removed">-                 $asm.puts &quot;fstp #{operands[1].x87Operand(1)}&quot;</span>
<span class="line-removed">-             else</span>
<span class="line-removed">-                 $asm.puts &quot;movsd #{x86Operands(:double, :double)}&quot;</span>
<span class="line-removed">-             end</span>
          when &quot;moved&quot;
<span class="line-modified">!             if useX87</span>
<span class="line-removed">-                 if (operands[0].x87DefaultStackPosition == 0)</span>
<span class="line-removed">-                     $asm.puts &quot;fst #{operands[1].x87Operand(0)}&quot;</span>
<span class="line-removed">-                 else</span>
<span class="line-removed">-                     $asm.puts &quot;fld #{operands[0].x87Operand(0)}&quot;</span>
<span class="line-removed">-                     $asm.puts &quot;fstp #{operands[1].x87Operand(1)}&quot;</span>
<span class="line-removed">-                 end</span>
<span class="line-removed">-             else</span>
<span class="line-removed">-                 $asm.puts &quot;movsd #{x86Operands(:double, :double)}&quot;</span>
<span class="line-removed">-             end</span>
          when &quot;stored&quot;
<span class="line-modified">!             if useX87</span>
<span class="line-removed">-                 if (operands[0].x87DefaultStackPosition == 0)</span>
<span class="line-removed">-                     $asm.puts &quot;fst#{x86Suffix(:int)} #{operands[1].x86Operand(:double)}&quot;</span>
<span class="line-removed">-                 else</span>
<span class="line-removed">-                     $asm.puts &quot;fld #{operands[0].x87Operand(0)}&quot;</span>
<span class="line-removed">-                     if !isIntelSyntax</span>
<span class="line-removed">-                         $asm.puts &quot;fstpl #{operands[1].x86Operand(:double)}&quot;</span>
<span class="line-removed">-                     else</span>
<span class="line-removed">-                         $asm.puts &quot;fstp #{operands[1].x86Operand(:double)}&quot;</span>
<span class="line-removed">-                     end</span>
<span class="line-removed">-                 end</span>
<span class="line-removed">-             else</span>
<span class="line-removed">-                 $asm.puts &quot;movsd #{x86Operands(:double, :double)}&quot;</span>
<span class="line-removed">-             end</span>
          when &quot;addd&quot;
<span class="line-modified">!             if useX87</span>
<span class="line-removed">-                 handleX87BinOp(&quot;fadd&quot;, &quot;fadd&quot;)</span>
<span class="line-removed">-             else</span>
<span class="line-removed">-                 $asm.puts &quot;addsd #{x86Operands(:double, :double)}&quot;</span>
<span class="line-removed">-             end</span>
          when &quot;muld&quot;
<span class="line-modified">!             if useX87</span>
<span class="line-removed">-                 handleX87BinOp(&quot;fmul&quot;, &quot;fmul&quot;)</span>
<span class="line-removed">-             else</span>
<span class="line-removed">-                 $asm.puts &quot;mulsd #{x86Operands(:double, :double)}&quot;</span>
<span class="line-removed">-             end</span>
          when &quot;subd&quot;
<span class="line-modified">!             if useX87</span>
<span class="line-removed">-                 handleX87BinOp(&quot;fsub&quot;, &quot;fsubr&quot;)</span>
<span class="line-removed">-             else</span>
<span class="line-removed">-                 $asm.puts &quot;subsd #{x86Operands(:double, :double)}&quot;</span>
<span class="line-removed">-             end</span>
          when &quot;divd&quot;
<span class="line-modified">!             if useX87</span>
<span class="line-removed">-                 handleX87BinOp(&quot;fdiv&quot;, &quot;fdivr&quot;)</span>
<span class="line-removed">-             else</span>
<span class="line-removed">-                 $asm.puts &quot;divsd #{x86Operands(:double, :double)}&quot;</span>
<span class="line-removed">-             end</span>
          when &quot;sqrtd&quot;
<span class="line-modified">!             if useX87</span>
<span class="line-removed">-                 $asm.puts &quot;fld #{operands[0].x87Operand(0)}&quot;</span>
<span class="line-removed">-                 $asm.puts &quot;fsqrtl&quot;</span>
<span class="line-removed">-                 $asm.puts &quot;fstp #{operands[1].x87Operand(1)}&quot;</span>
<span class="line-removed">-             else</span>
<span class="line-removed">-                 $asm.puts &quot;sqrtsd #{operands[0].x86Operand(:double)}, #{operands[1].x86Operand(:double)}&quot;</span>
<span class="line-removed">-             end</span>
          when &quot;ci2d&quot;
<span class="line-modified">!             if useX87</span>
<span class="line-removed">-                 sp = RegisterID.new(nil, &quot;sp&quot;)</span>
<span class="line-removed">-                 $asm.puts &quot;mov#{x86Suffix(:int)} #{orderOperands(operands[0].x86Operand(:int), offsetRegister(-4, sp.x86Operand(:ptr)))}&quot;</span>
<span class="line-removed">-                 $asm.puts &quot;fild#{x86Suffix(:ptr)} #{getSizeString(:ptr)}#{offsetRegister(-4, sp.x86Operand(:ptr))}&quot;</span>
<span class="line-removed">-                 $asm.puts &quot;fstp #{operands[1].x87Operand(1)}&quot;</span>
<span class="line-removed">-             else</span>
<span class="line-removed">-                 $asm.puts &quot;cvtsi2sd #{orderOperands(operands[0].x86Operand(:int), operands[1].x86Operand(:double))}&quot;</span>
<span class="line-removed">-             end</span>
          when &quot;bdeq&quot;
<span class="line-modified">!             if useX87</span>
<span class="line-removed">-                 handleX87Compare(:normal)</span>
<span class="line-removed">-             else</span>
<span class="line-removed">-                 $asm.puts &quot;ucomisd #{orderOperands(operands[0].x86Operand(:double), operands[1].x86Operand(:double))}&quot;</span>
<span class="line-removed">-             end</span>
              if operands[0] == operands[1]
                  # This is just a jump ordered, which is a jnp.
                  $asm.puts &quot;jnp #{operands[2].asmLabel}&quot;
              else
                  isUnordered = LocalLabel.unique(&quot;bdeq&quot;)
<span class="line-new-header">--- 937,62 ---</span>
              if !isIntelSyntax
                  $asm.puts &quot;movzbl #{x86LoadOperands(:byte, :int)}&quot;
              else
                  $asm.puts &quot;movzx #{x86LoadOperands(:byte, :int)}&quot;
              end
<span class="line-modified">!         when &quot;loadbsi&quot;</span>
              if !isIntelSyntax
                  $asm.puts &quot;movsbl #{x86LoadOperands(:byte, :int)}&quot;
              else
                  $asm.puts &quot;movsx #{x86LoadOperands(:byte, :int)}&quot;
              end
<span class="line-modified">!         when &quot;loadbsq&quot;</span>
              if !isIntelSyntax
<span class="line-modified">!                 $asm.puts &quot;movsbq #{x86LoadOperands(:byte, :quad)}&quot;</span>
              else
<span class="line-modified">!                 $asm.puts &quot;movsx #{x86LoadOperands(:byte, :quad)}&quot;</span>
              end
          when &quot;loadh&quot;
              if !isIntelSyntax
                  $asm.puts &quot;movzwl #{x86LoadOperands(:half, :int)}&quot;
              else
                  $asm.puts &quot;movzx #{x86LoadOperands(:half, :int)}&quot;
              end
<span class="line-modified">!         when &quot;loadhsi&quot;</span>
              if !isIntelSyntax
                  $asm.puts &quot;movswl #{x86LoadOperands(:half, :int)}&quot;
              else
                  $asm.puts &quot;movsx #{x86LoadOperands(:half, :int)}&quot;
              end
<span class="line-added">+         when &quot;loadhsq&quot;</span>
<span class="line-added">+             if !isIntelSyntax</span>
<span class="line-added">+                 $asm.puts &quot;movswq #{x86LoadOperands(:half, :quad)}&quot;</span>
<span class="line-added">+             else</span>
<span class="line-added">+                 $asm.puts &quot;movsx #{x86LoadOperands(:half, :quad)}&quot;</span>
<span class="line-added">+             end</span>
          when &quot;storeb&quot;
              $asm.puts &quot;mov#{x86Suffix(:byte)} #{x86Operands(:byte, :byte)}&quot;
          when &quot;loadd&quot;
<span class="line-modified">!             $asm.puts &quot;movsd #{x86Operands(:double, :double)}&quot;</span>
          when &quot;moved&quot;
<span class="line-modified">!             $asm.puts &quot;movsd #{x86Operands(:double, :double)}&quot;</span>
          when &quot;stored&quot;
<span class="line-modified">!             $asm.puts &quot;movsd #{x86Operands(:double, :double)}&quot;</span>
          when &quot;addd&quot;
<span class="line-modified">!             $asm.puts &quot;addsd #{x86Operands(:double, :double)}&quot;</span>
          when &quot;muld&quot;
<span class="line-modified">!             $asm.puts &quot;mulsd #{x86Operands(:double, :double)}&quot;</span>
          when &quot;subd&quot;
<span class="line-modified">!             $asm.puts &quot;subsd #{x86Operands(:double, :double)}&quot;</span>
          when &quot;divd&quot;
<span class="line-modified">!             $asm.puts &quot;divsd #{x86Operands(:double, :double)}&quot;</span>
          when &quot;sqrtd&quot;
<span class="line-modified">!             $asm.puts &quot;sqrtsd #{operands[0].x86Operand(:double)}, #{operands[1].x86Operand(:double)}&quot;</span>
          when &quot;ci2d&quot;
<span class="line-modified">!             $asm.puts &quot;cvtsi2sd #{orderOperands(operands[0].x86Operand(:int), operands[1].x86Operand(:double))}&quot;</span>
          when &quot;bdeq&quot;
<span class="line-modified">!             $asm.puts &quot;ucomisd #{orderOperands(operands[0].x86Operand(:double), operands[1].x86Operand(:double))}&quot;</span>
              if operands[0] == operands[1]
                  # This is just a jump ordered, which is a jnp.
                  $asm.puts &quot;jnp #{operands[2].asmLabel}&quot;
              else
                  isUnordered = LocalLabel.unique(&quot;bdeq&quot;)
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1142,15 ***</span>
          when &quot;bdlteq&quot;
              handleX86DoubleBranch(&quot;jae&quot;, :reverse)
          when &quot;bdequn&quot;
              handleX86DoubleBranch(&quot;je&quot;, :normal)
          when &quot;bdnequn&quot;
<span class="line-modified">!             if useX87</span>
<span class="line-removed">-                 handleX87Compare(:normal)</span>
<span class="line-removed">-             else</span>
<span class="line-removed">-                 $asm.puts &quot;ucomisd #{orderOperands(operands[0].x86Operand(:double), operands[1].x86Operand(:double))}&quot;</span>
<span class="line-removed">-             end</span>
              if operands[0] == operands[1]
                  # This is just a jump unordered, which is a jp.
                  $asm.puts &quot;jp #{operands[2].asmLabel}&quot;
              else
                  isUnordered = LocalLabel.unique(&quot;bdnequn&quot;)
<span class="line-new-header">--- 1011,11 ---</span>
          when &quot;bdlteq&quot;
              handleX86DoubleBranch(&quot;jae&quot;, :reverse)
          when &quot;bdequn&quot;
              handleX86DoubleBranch(&quot;je&quot;, :normal)
          when &quot;bdnequn&quot;
<span class="line-modified">!             $asm.puts &quot;ucomisd #{orderOperands(operands[0].x86Operand(:double), operands[1].x86Operand(:double))}&quot;</span>
              if operands[0] == operands[1]
                  # This is just a jump unordered, which is a jp.
                  $asm.puts &quot;jp #{operands[2].asmLabel}&quot;
              else
                  isUnordered = LocalLabel.unique(&quot;bdnequn&quot;)
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1168,52 ***</span>
          when &quot;bdltun&quot;
              handleX86DoubleBranch(&quot;jb&quot;, :normal)
          when &quot;bdltequn&quot;
              handleX86DoubleBranch(&quot;jbe&quot;, :normal)
          when &quot;btd2i&quot;
<span class="line-removed">-             # FIXME: unused and unimplemented for x87</span>
<span class="line-removed">-             raise if useX87</span>
              $asm.puts &quot;cvttsd2si #{operands[0].x86Operand(:double)}, #{operands[1].x86Operand(:int)}&quot;
              $asm.puts &quot;cmpl $0x80000000 #{operands[1].x86Operand(:int)}&quot;
              $asm.puts &quot;je #{operands[2].asmLabel}&quot;
          when &quot;td2i&quot;
<span class="line-removed">-             # FIXME: unused and unimplemented for x87</span>
<span class="line-removed">-             raise if useX87</span>
              $asm.puts &quot;cvttsd2si #{operands[0].x86Operand(:double)}, #{operands[1].x86Operand(:int)}&quot;
          when &quot;bcd2i&quot;
<span class="line-modified">!             if useX87</span>
<span class="line-modified">!                 floatingPointCompareImplicitOperand = getImplicitOperandString</span>
<span class="line-modified">!                 sp = RegisterID.new(nil, &quot;sp&quot;)</span>
<span class="line-modified">!                 if (operands[0].x87DefaultStackPosition == 0)</span>
<span class="line-modified">!                     $asm.puts &quot;fistl -4(#{sp.x86Operand(:ptr)})&quot;</span>
<span class="line-modified">!                 else</span>
<span class="line-modified">!                     $asm.puts &quot;fld #{operands[0].x87Operand(0)}&quot;</span>
<span class="line-removed">-                     $asm.puts &quot;fistp#{x86Suffix(:ptr)} #{getSizeString(:ptr)}#{offsetRegister(-4, sp.x86Operand(:ptr))}&quot;</span>
<span class="line-removed">-                 end</span>
<span class="line-removed">-                 $asm.puts &quot;mov#{x86Suffix(:int)} #{orderOperands(offsetRegister(-4, sp.x86Operand(:ptr)), operands[1].x86Operand(:int))}&quot;</span>
<span class="line-removed">-                 $asm.puts &quot;test#{x86Suffix(:int)} #{operands[1].x86Operand(:int)}, #{operands[1].x86Operand(:int)}&quot;</span>
<span class="line-removed">-                 $asm.puts &quot;je #{operands[2].asmLabel}&quot;</span>
<span class="line-removed">-                 $asm.puts &quot;fild#{x86Suffix(:int)} #{getSizeString(:int)}#{offsetRegister(-4, sp.x86Operand(:ptr))}&quot;</span>
<span class="line-removed">-                 $asm.puts &quot;fucomip #{floatingPointCompareImplicitOperand}#{operands[0].x87Operand(1)}&quot;</span>
<span class="line-removed">-                 $asm.puts &quot;jp #{operands[2].asmLabel}&quot;</span>
<span class="line-removed">-                 $asm.puts &quot;jne #{operands[2].asmLabel}&quot;</span>
<span class="line-removed">-             else</span>
<span class="line-removed">-                 $asm.puts &quot;cvttsd2si #{operands[0].x86Operand(:double)}, #{operands[1].x86Operand(:int)}&quot;</span>
<span class="line-removed">-                 $asm.puts &quot;test#{x86Suffix(:int)} #{operands[1].x86Operand(:int)}, #{operands[1].x86Operand(:int)}&quot;</span>
<span class="line-removed">-                 $asm.puts &quot;je #{operands[2].asmLabel}&quot;</span>
<span class="line-removed">-                 $asm.puts &quot;cvtsi2sd #{operands[1].x86Operand(:int)}, %xmm7&quot;</span>
<span class="line-removed">-                 $asm.puts &quot;ucomisd #{operands[0].x86Operand(:double)}, %xmm7&quot;</span>
<span class="line-removed">-                 $asm.puts &quot;jp #{operands[2].asmLabel}&quot;</span>
<span class="line-removed">-                 $asm.puts &quot;jne #{operands[2].asmLabel}&quot;</span>
<span class="line-removed">-             end</span>
          when &quot;movdz&quot;
<span class="line-modified">!             if useX87</span>
<span class="line-removed">-                 $asm.puts &quot;fldzl&quot;</span>
<span class="line-removed">-                 $asm.puts &quot;fstp #{operands[0].x87Operand(1)}&quot;</span>
<span class="line-removed">-             else</span>
<span class="line-removed">-                 $asm.puts &quot;xorpd #{operands[0].x86Operand(:double)}, #{operands[0].x86Operand(:double)}&quot;</span>
<span class="line-removed">-             end</span>
          when &quot;pop&quot;
              operands.each {
                  | op |
                  $asm.puts &quot;pop #{op.x86Operand(:ptr)}&quot;
              }
<span class="line-new-header">--- 1033,25 ---</span>
          when &quot;bdltun&quot;
              handleX86DoubleBranch(&quot;jb&quot;, :normal)
          when &quot;bdltequn&quot;
              handleX86DoubleBranch(&quot;jbe&quot;, :normal)
          when &quot;btd2i&quot;
              $asm.puts &quot;cvttsd2si #{operands[0].x86Operand(:double)}, #{operands[1].x86Operand(:int)}&quot;
              $asm.puts &quot;cmpl $0x80000000 #{operands[1].x86Operand(:int)}&quot;
              $asm.puts &quot;je #{operands[2].asmLabel}&quot;
          when &quot;td2i&quot;
              $asm.puts &quot;cvttsd2si #{operands[0].x86Operand(:double)}, #{operands[1].x86Operand(:int)}&quot;
          when &quot;bcd2i&quot;
<span class="line-modified">!             $asm.puts &quot;cvttsd2si #{operands[0].x86Operand(:double)}, #{operands[1].x86Operand(:int)}&quot;</span>
<span class="line-modified">!             $asm.puts &quot;test#{x86Suffix(:int)} #{operands[1].x86Operand(:int)}, #{operands[1].x86Operand(:int)}&quot;</span>
<span class="line-modified">!             $asm.puts &quot;je #{operands[2].asmLabel}&quot;</span>
<span class="line-modified">!             $asm.puts &quot;cvtsi2sd #{operands[1].x86Operand(:int)}, %xmm7&quot;</span>
<span class="line-modified">!             $asm.puts &quot;ucomisd #{operands[0].x86Operand(:double)}, %xmm7&quot;</span>
<span class="line-modified">!             $asm.puts &quot;jp #{operands[2].asmLabel}&quot;</span>
<span class="line-modified">!             $asm.puts &quot;jne #{operands[2].asmLabel}&quot;</span>
          when &quot;movdz&quot;
<span class="line-modified">!             $asm.puts &quot;xorpd #{operands[0].x86Operand(:double)}, #{operands[0].x86Operand(:double)}&quot;</span>
          when &quot;pop&quot;
              operands.each {
                  | op |
                  $asm.puts &quot;pop #{op.x86Operand(:ptr)}&quot;
              }
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1389,16 ***</span>
          when &quot;borinz&quot;
              handleX86OpBranch(&quot;orl&quot;, &quot;jnz&quot;, :int)
          when &quot;break&quot;
              $asm.puts &quot;int #{const(3)}&quot;
          when &quot;call&quot;
<span class="line-removed">-             if useX87</span>
<span class="line-removed">-                 2.times {</span>
<span class="line-removed">-                     | offset |</span>
<span class="line-removed">-                     $asm.puts &quot;ffree #{register(&quot;st&quot;)}(#{offset})&quot;</span>
<span class="line-removed">-                 }</span>
<span class="line-removed">-             end</span>
              op = operands[0].x86CallOperand(:ptr)
              if operands[0].is_a? LabelReference
                  operands[0].used
              end
              $asm.puts &quot;call #{op}&quot;
<span class="line-new-header">--- 1227,10 ---</span>
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1515,72 ***</span>
          when &quot;cdqi&quot;
              $asm.puts &quot;cdq&quot;
          when &quot;idivi&quot;
              $asm.puts &quot;idiv#{x86Suffix(:int)} #{operands[0].x86Operand(:int)}&quot;
          when &quot;fii2d&quot;
<span class="line-modified">!             if useX87</span>
<span class="line-modified">!                 sp = RegisterID.new(nil, &quot;sp&quot;)</span>
<span class="line-modified">!                 $asm.puts &quot;mov#{x86Suffix(:int)} #{orderOperands(operands[0].x86Operand(:int), offsetRegister(-8, sp.x86Operand(:ptr)))}&quot;</span>
<span class="line-modified">!                 $asm.puts &quot;mov#{x86Suffix(:int)} #{orderOperands(operands[1].x86Operand(:int), offsetRegister(-4, sp.x86Operand(:ptr)))}&quot;</span>
<span class="line-removed">-                 $asm.puts &quot;fld#{x86Suffix(:ptr)} #{getSizeString(:double)}#{offsetRegister(-8, sp.x86Operand(:ptr))}&quot;</span>
<span class="line-removed">-                 $asm.puts &quot;fstp #{operands[2].x87Operand(1)}&quot;</span>
<span class="line-removed">-             else</span>
<span class="line-removed">-                 $asm.puts &quot;movd #{operands[0].x86Operand(:int)}, #{operands[2].x86Operand(:double)}&quot;</span>
<span class="line-removed">-                 $asm.puts &quot;movd #{operands[1].x86Operand(:int)}, %xmm7&quot;</span>
<span class="line-removed">-                 $asm.puts &quot;psllq $32, %xmm7&quot;</span>
<span class="line-removed">-                 $asm.puts &quot;por %xmm7, #{operands[2].x86Operand(:double)}&quot;</span>
<span class="line-removed">-             end</span>
          when &quot;fd2ii&quot;
<span class="line-modified">!             if useX87</span>
<span class="line-modified">!                 sp = RegisterID.new(nil, &quot;sp&quot;)</span>
<span class="line-modified">!                 if (operands[0].x87DefaultStackPosition == 0)</span>
<span class="line-modified">!                     $asm.puts &quot;fst#{x86Suffix(:ptr)} #{getSizeString(:double)}#{offsetRegister(-8, sp.x86Operand(:ptr))}&quot;</span>
<span class="line-removed">-                 else</span>
<span class="line-removed">-                     $asm.puts &quot;fld #{operands[0].x87Operand(0)}&quot;</span>
<span class="line-removed">-                     $asm.puts &quot;fstpl -8(#{sp.x86Operand(:ptr)})&quot;</span>
<span class="line-removed">-                 end</span>
<span class="line-removed">-                 $asm.puts &quot;mov#{x86Suffix(:int)} #{orderOperands(offsetRegister(-8, sp.x86Operand(:ptr)), operands[1].x86Operand(:int))}&quot;</span>
<span class="line-removed">-                 $asm.puts &quot;mov#{x86Suffix(:int)} #{orderOperands(offsetRegister(-4, sp.x86Operand(:ptr)), operands[2].x86Operand(:int))}&quot;</span>
<span class="line-removed">-             else</span>
<span class="line-removed">-                 $asm.puts &quot;movd #{operands[0].x86Operand(:double)}, #{operands[1].x86Operand(:int)}&quot;</span>
<span class="line-removed">-                 $asm.puts &quot;movsd #{operands[0].x86Operand(:double)}, %xmm7&quot;</span>
<span class="line-removed">-                 $asm.puts &quot;psrlq $32, %xmm7&quot;</span>
<span class="line-removed">-                 $asm.puts &quot;movd %xmm7, #{operands[2].x86Operand(:int)}&quot;</span>
<span class="line-removed">-             end</span>
          when &quot;fq2d&quot;
<span class="line-modified">!             if useX87</span>
<span class="line-modified">!                 sp = RegisterID.new(nil, &quot;sp&quot;)</span>
<span class="line-removed">-                 $asm.puts &quot;movq #{operands[0].x86Operand(:quad)}, -8(#{sp.x86Operand(:ptr)})&quot;</span>
<span class="line-removed">-                 $asm.puts &quot;fldl -8(#{sp.x86Operand(:ptr)})&quot;</span>
<span class="line-removed">-                 $asm.puts &quot;fstp #{operands[1].x87Operand(1)}&quot;</span>
              else
<span class="line-modified">!                 if !isIntelSyntax</span>
<span class="line-modified">!                     $asm.puts &quot;movq #{operands[0].x86Operand(:quad)}, #{operands[1].x86Operand(:double)}&quot;</span>
<span class="line-modified">!                 else</span>
<span class="line-removed">-                     # MASM does not accept register operands with movq.</span>
<span class="line-removed">-                     # Debugging shows that movd actually moves a qword when using MASM.</span>
<span class="line-removed">-                     $asm.puts &quot;movd #{operands[1].x86Operand(:double)}, #{operands[0].x86Operand(:quad)}&quot;</span>
<span class="line-removed">-                 end</span>
              end
          when &quot;fd2q&quot;
<span class="line-modified">!             if useX87</span>
<span class="line-modified">!                 sp = RegisterID.new(nil, &quot;sp&quot;)</span>
<span class="line-removed">-                 if (operands[0].x87DefaultStackPosition == 0)</span>
<span class="line-removed">-                     $asm.puts &quot;fst#{x86Suffix(:int)} #{getSizeString(:int)}#{offsetRegister(-8, sp.x86Operand(:ptr))}&quot;</span>
<span class="line-removed">-                 else</span>
<span class="line-removed">-                     $asm.puts &quot;fld #{operands[0].x87Operand(0)}&quot;</span>
<span class="line-removed">-                     $asm.puts &quot;fstpl -8(#{sp.x86Operand(:ptr)})&quot;</span>
<span class="line-removed">-                 end</span>
<span class="line-removed">-                 $asm.puts &quot;movq -8(#{sp.x86Operand(:ptr)}), #{operands[1].x86Operand(:quad)}&quot;</span>
              else
<span class="line-modified">!                 if !isIntelSyntax</span>
<span class="line-modified">!                     $asm.puts &quot;movq #{operands[0].x86Operand(:double)}, #{operands[1].x86Operand(:quad)}&quot;</span>
<span class="line-modified">!                 else</span>
<span class="line-removed">-                     # MASM does not accept register operands with movq.</span>
<span class="line-removed">-                     # Debugging shows that movd actually moves a qword when using MASM.</span>
<span class="line-removed">-                     $asm.puts &quot;movd #{operands[1].x86Operand(:quad)}, #{operands[0].x86Operand(:double)}&quot;</span>
<span class="line-removed">-                 end</span>
              end
          when &quot;bo&quot;
              $asm.puts &quot;jo #{operands[0].asmLabel}&quot;
          when &quot;bs&quot;
              $asm.puts &quot;js #{operands[0].asmLabel}&quot;
<span class="line-new-header">--- 1347,34 ---</span>
          when &quot;cdqi&quot;
              $asm.puts &quot;cdq&quot;
          when &quot;idivi&quot;
              $asm.puts &quot;idiv#{x86Suffix(:int)} #{operands[0].x86Operand(:int)}&quot;
          when &quot;fii2d&quot;
<span class="line-modified">!             $asm.puts &quot;movd #{operands[0].x86Operand(:int)}, #{operands[2].x86Operand(:double)}&quot;</span>
<span class="line-modified">!             $asm.puts &quot;movd #{operands[1].x86Operand(:int)}, %xmm7&quot;</span>
<span class="line-modified">!             $asm.puts &quot;psllq $32, %xmm7&quot;</span>
<span class="line-modified">!             $asm.puts &quot;por %xmm7, #{operands[2].x86Operand(:double)}&quot;</span>
          when &quot;fd2ii&quot;
<span class="line-modified">!             $asm.puts &quot;movd #{operands[0].x86Operand(:double)}, #{operands[1].x86Operand(:int)}&quot;</span>
<span class="line-modified">!             $asm.puts &quot;movsd #{operands[0].x86Operand(:double)}, %xmm7&quot;</span>
<span class="line-modified">!             $asm.puts &quot;psrlq $32, %xmm7&quot;</span>
<span class="line-modified">!             $asm.puts &quot;movd %xmm7, #{operands[2].x86Operand(:int)}&quot;</span>
          when &quot;fq2d&quot;
<span class="line-modified">!             if !isIntelSyntax</span>
<span class="line-modified">!                 $asm.puts &quot;movq #{operands[0].x86Operand(:quad)}, #{operands[1].x86Operand(:double)}&quot;</span>
              else
<span class="line-modified">!                 # MASM does not accept register operands with movq.</span>
<span class="line-modified">!                 # Debugging shows that movd actually moves a qword when using MASM.</span>
<span class="line-modified">!                 $asm.puts &quot;movd #{operands[1].x86Operand(:double)}, #{operands[0].x86Operand(:quad)}&quot;</span>
              end
          when &quot;fd2q&quot;
<span class="line-modified">!             if !isIntelSyntax</span>
<span class="line-modified">!                 $asm.puts &quot;movq #{operands[0].x86Operand(:double)}, #{operands[1].x86Operand(:quad)}&quot;</span>
              else
<span class="line-modified">!                 # MASM does not accept register operands with movq.</span>
<span class="line-modified">!                 # Debugging shows that movd actually moves a qword when using MASM.</span>
<span class="line-modified">!                 $asm.puts &quot;movd #{operands[1].x86Operand(:quad)}, #{operands[0].x86Operand(:double)}&quot;</span>
              end
          when &quot;bo&quot;
              $asm.puts &quot;jo #{operands[0].asmLabel}&quot;
          when &quot;bs&quot;
              $asm.puts &quot;js #{operands[0].asmLabel}&quot;
</pre>
<center><a href="registers.rb.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="../parser/ASTBuilder.h.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>