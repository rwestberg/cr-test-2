<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames modules/javafx.web/src/main/native/Source/WebCore/inspector/agents/InspectorCSSAgent.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>  1 /*
  2  * Copyright (C) 2010 Google Inc. All rights reserved.
  3  * Copyright (C) 2015-2017 Apple Inc. All rights reserved.
  4  *
  5  * Redistribution and use in source and binary forms, with or without
  6  * modification, are permitted provided that the following conditions
  7  * are met:
  8  * 1.  Redistributions of source code must retain the above copyright
  9  *     notice, this list of conditions and the following disclaimer.
 10  * 2.  Redistributions in binary form must reproduce the above copyright
 11  *     notice, this list of conditions and the following disclaimer in the
 12  *     documentation and/or other materials provided with the distribution.
 13  *
 14  * THIS SOFTWARE IS PROVIDED BY APPLE INC. AND ITS CONTRIBUTORS ``AS IS&#39;&#39; AND ANY
 15  * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
 16  * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
 17  * DISCLAIMED. IN NO EVENT SHALL APPLE INC. OR ITS CONTRIBUTORS BE LIABLE FOR ANY
 18  * DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
 19  * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
 20  * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON
 21  * ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 22  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
 23  * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 24  */
 25 
 26 #include &quot;config.h&quot;
 27 #include &quot;InspectorCSSAgent.h&quot;
 28 
 29 #include &quot;CSSComputedStyleDeclaration.h&quot;
 30 #include &quot;CSSImportRule.h&quot;
 31 #include &quot;CSSParserFastPaths.h&quot;
 32 #include &quot;CSSParserMode.h&quot;
 33 #include &quot;CSSPropertyNames.h&quot;
 34 #include &quot;CSSPropertySourceData.h&quot;
 35 #include &quot;CSSRule.h&quot;
 36 #include &quot;CSSRuleList.h&quot;
 37 #include &quot;CSSStyleRule.h&quot;
 38 #include &quot;CSSStyleSheet.h&quot;
 39 #include &quot;CSSValueKeywords.h&quot;
 40 #include &quot;ContentSecurityPolicy.h&quot;
 41 #include &quot;DOMWindow.h&quot;
 42 #include &quot;FontCache.h&quot;
 43 #include &quot;Frame.h&quot;
 44 #include &quot;HTMLHeadElement.h&quot;
 45 #include &quot;HTMLStyleElement.h&quot;
<a name="1" id="anc1"></a>
 46 #include &quot;InspectorHistory.h&quot;
 47 #include &quot;InspectorPageAgent.h&quot;
 48 #include &quot;InstrumentingAgents.h&quot;
 49 #include &quot;Node.h&quot;
 50 #include &quot;NodeList.h&quot;
 51 #include &quot;PseudoElement.h&quot;
<a name="2" id="anc2"></a>
 52 #include &quot;SVGStyleElement.h&quot;
 53 #include &quot;SelectorChecker.h&quot;
 54 #include &quot;ShadowRoot.h&quot;
 55 #include &quot;StyleProperties.h&quot;
 56 #include &quot;StylePropertyShorthand.h&quot;
 57 #include &quot;StyleResolver.h&quot;
 58 #include &quot;StyleRule.h&quot;
 59 #include &quot;StyleScope.h&quot;
 60 #include &quot;StyleSheetList.h&quot;
 61 #include &lt;JavaScriptCore/InspectorProtocolObjects.h&gt;
<a name="3" id="anc3"></a>
 62 #include &lt;wtf/Ref.h&gt;
 63 #include &lt;wtf/Vector.h&gt;
 64 #include &lt;wtf/text/CString.h&gt;
 65 #include &lt;wtf/text/StringConcatenateNumbers.h&gt;
 66 
 67 namespace WebCore {
 68 
 69 using namespace Inspector;
 70 
 71 enum ForcePseudoClassFlags {
 72     PseudoClassNone = 0,
 73     PseudoClassHover = 1 &lt;&lt; 0,
 74     PseudoClassFocus = 1 &lt;&lt; 1,
 75     PseudoClassActive = 1 &lt;&lt; 2,
 76     PseudoClassVisited = 1 &lt;&lt; 3
 77 };
 78 
 79 static unsigned computePseudoClassMask(const JSON::Array&amp; pseudoClassArray)
 80 {
 81     static NeverDestroyed&lt;String&gt; active(MAKE_STATIC_STRING_IMPL(&quot;active&quot;));
 82     static NeverDestroyed&lt;String&gt; hover(MAKE_STATIC_STRING_IMPL(&quot;hover&quot;));
 83     static NeverDestroyed&lt;String&gt; focus(MAKE_STATIC_STRING_IMPL(&quot;focus&quot;));
 84     static NeverDestroyed&lt;String&gt; visited(MAKE_STATIC_STRING_IMPL(&quot;visited&quot;));
 85     if (!pseudoClassArray.length())
 86         return PseudoClassNone;
 87 
 88     unsigned result = PseudoClassNone;
 89     for (auto&amp; pseudoClassValue : pseudoClassArray) {
 90         String pseudoClass;
 91         bool success = pseudoClassValue-&gt;asString(pseudoClass);
 92         if (!success)
 93             continue;
 94         if (pseudoClass == active)
 95             result |= PseudoClassActive;
 96         else if (pseudoClass == hover)
 97             result |= PseudoClassHover;
 98         else if (pseudoClass == focus)
 99             result |= PseudoClassFocus;
100         else if (pseudoClass == visited)
101             result |= PseudoClassVisited;
102     }
103 
104     return result;
105 }
106 
107 class InspectorCSSAgent::StyleSheetAction : public InspectorHistory::Action {
108     WTF_MAKE_NONCOPYABLE(StyleSheetAction);
109 public:
110     StyleSheetAction(InspectorStyleSheet* styleSheet)
111         : InspectorHistory::Action()
112         , m_styleSheet(styleSheet)
113     {
114     }
115 
116 protected:
117     RefPtr&lt;InspectorStyleSheet&gt; m_styleSheet;
118 };
119 
120 class InspectorCSSAgent::SetStyleSheetTextAction final : public InspectorCSSAgent::StyleSheetAction {
121     WTF_MAKE_NONCOPYABLE(SetStyleSheetTextAction);
122 public:
123     SetStyleSheetTextAction(InspectorStyleSheet* styleSheet, const String&amp; text)
124         : InspectorCSSAgent::StyleSheetAction(styleSheet)
125         , m_text(text)
126     {
127     }
128 
129 private:
130     ExceptionOr&lt;void&gt; perform() final
131     {
132         auto result = m_styleSheet-&gt;text();
133         if (result.hasException())
134             return result.releaseException();
135         m_oldText = result.releaseReturnValue();
136         return redo();
137     }
138 
139     ExceptionOr&lt;void&gt; undo() final
140     {
141         auto result = m_styleSheet-&gt;setText(m_oldText);
142         if (result.hasException())
143             return result.releaseException();
144         m_styleSheet-&gt;reparseStyleSheet(m_oldText);
145         return { };
146     }
147 
148     ExceptionOr&lt;void&gt; redo() final
149     {
150         auto result = m_styleSheet-&gt;setText(m_text);
151         if (result.hasException())
152             return result.releaseException();
153         m_styleSheet-&gt;reparseStyleSheet(m_text);
154         return { };
155     }
156 
157     String mergeId() final
158     {
159         return &quot;SetStyleSheetText &quot; + m_styleSheet-&gt;id();
160     }
161 
162     void merge(std::unique_ptr&lt;Action&gt; action) override
163     {
164         ASSERT(action-&gt;mergeId() == mergeId());
165         m_text = static_cast&lt;SetStyleSheetTextAction&amp;&gt;(*action).m_text;
166     }
167 
168     String m_text;
169     String m_oldText;
170 };
171 
172 class InspectorCSSAgent::SetStyleTextAction final : public InspectorCSSAgent::StyleSheetAction {
173     WTF_MAKE_NONCOPYABLE(SetStyleTextAction);
174 public:
175     SetStyleTextAction(InspectorStyleSheet* styleSheet, const InspectorCSSId&amp; cssId, const String&amp; text)
176         : InspectorCSSAgent::StyleSheetAction(styleSheet)
177         , m_cssId(cssId)
178         , m_text(text)
179     {
180     }
181 
182     ExceptionOr&lt;void&gt; perform() override
183     {
184         return redo();
185     }
186 
187     ExceptionOr&lt;void&gt; undo() override
188     {
189         return m_styleSheet-&gt;setStyleText(m_cssId, m_oldText, nullptr);
190     }
191 
192     ExceptionOr&lt;void&gt; redo() override
193     {
194         return m_styleSheet-&gt;setStyleText(m_cssId, m_text, &amp;m_oldText);
195     }
196 
197     String mergeId() override
198     {
199         ASSERT(m_styleSheet-&gt;id() == m_cssId.styleSheetId());
200         return makeString(&quot;SetStyleText &quot;, m_styleSheet-&gt;id(), &#39;:&#39;, m_cssId.ordinal());
201     }
202 
203     void merge(std::unique_ptr&lt;Action&gt; action) override
204     {
205         ASSERT(action-&gt;mergeId() == mergeId());
206 
207         SetStyleTextAction* other = static_cast&lt;SetStyleTextAction*&gt;(action.get());
208         m_text = other-&gt;m_text;
209     }
210 
211 private:
212     InspectorCSSId m_cssId;
213     String m_text;
214     String m_oldText;
215 };
216 
217 class InspectorCSSAgent::SetRuleSelectorAction final : public InspectorCSSAgent::StyleSheetAction {
218     WTF_MAKE_NONCOPYABLE(SetRuleSelectorAction);
219 public:
220     SetRuleSelectorAction(InspectorStyleSheet* styleSheet, const InspectorCSSId&amp; cssId, const String&amp; selector)
221         : InspectorCSSAgent::StyleSheetAction(styleSheet)
222         , m_cssId(cssId)
223         , m_selector(selector)
224     {
225     }
226 
227 private:
228     ExceptionOr&lt;void&gt; perform() final
229     {
230         auto result = m_styleSheet-&gt;ruleSelector(m_cssId);
231         if (result.hasException())
232             return result.releaseException();
233         m_oldSelector = result.releaseReturnValue();
234         return redo();
235     }
236 
237     ExceptionOr&lt;void&gt; undo() final
238     {
239         return m_styleSheet-&gt;setRuleSelector(m_cssId, m_oldSelector);
240     }
241 
242     ExceptionOr&lt;void&gt; redo() final
243     {
244         return m_styleSheet-&gt;setRuleSelector(m_cssId, m_selector);
245     }
246 
247     InspectorCSSId m_cssId;
248     String m_selector;
249     String m_oldSelector;
250 };
251 
252 class InspectorCSSAgent::AddRuleAction final : public InspectorCSSAgent::StyleSheetAction {
253     WTF_MAKE_NONCOPYABLE(AddRuleAction);
254 public:
255     AddRuleAction(InspectorStyleSheet* styleSheet, const String&amp; selector)
256         : InspectorCSSAgent::StyleSheetAction(styleSheet)
257         , m_selector(selector)
258     {
259     }
260 
261     InspectorCSSId newRuleId() const { return m_newId; }
262 
263 private:
264     ExceptionOr&lt;void&gt; perform() final
265     {
266         return redo();
267     }
268 
269     ExceptionOr&lt;void&gt; undo() final
270     {
271         return m_styleSheet-&gt;deleteRule(m_newId);
272     }
273 
274     ExceptionOr&lt;void&gt; redo() final
275     {
276         auto result = m_styleSheet-&gt;addRule(m_selector);
277         if (result.hasException())
278             return result.releaseException();
279         m_newId = m_styleSheet-&gt;ruleId(result.releaseReturnValue());
280         return { };
281     }
282 
283     InspectorCSSId m_newId;
284     String m_selector;
285     String m_oldSelector;
286 };
287 
288 CSSStyleRule* InspectorCSSAgent::asCSSStyleRule(CSSRule&amp; rule)
289 {
290     if (!is&lt;CSSStyleRule&gt;(rule))
291         return nullptr;
292     return downcast&lt;CSSStyleRule&gt;(&amp;rule);
293 }
294 
<a name="4" id="anc4"></a><span class="line-modified">295 InspectorCSSAgent::InspectorCSSAgent(WebAgentContext&amp; context, InspectorDOMAgent* domAgent)</span>
296     : InspectorAgentBase(&quot;CSS&quot;_s, context)
<a name="5" id="anc5"></a><span class="line-modified">297     , m_frontendDispatcher(std::make_unique&lt;CSSFrontendDispatcher&gt;(context.frontendRouter))</span>
298     , m_backendDispatcher(CSSBackendDispatcher::create(context.backendDispatcher, this))
<a name="6" id="anc6"></a><span class="line-removed">299     , m_domAgent(domAgent)</span>
300 {
<a name="7" id="anc7"></a><span class="line-removed">301     m_domAgent-&gt;setDOMListener(this);</span>
302 }
303 
<a name="8" id="anc8"></a><span class="line-modified">304 InspectorCSSAgent::~InspectorCSSAgent()</span>
<span class="line-removed">305 {</span>
<span class="line-removed">306     ASSERT(!m_domAgent);</span>
<span class="line-removed">307     reset();</span>
<span class="line-removed">308 }</span>
309 
310 void InspectorCSSAgent::didCreateFrontendAndBackend(Inspector::FrontendRouter*, Inspector::BackendDispatcher*)
311 {
312 }
313 
314 void InspectorCSSAgent::willDestroyFrontendAndBackend(Inspector::DisconnectReason)
315 {
<a name="9" id="anc9"></a><span class="line-removed">316     resetNonPersistentData();</span>
<span class="line-removed">317 </span>
318     String unused;
319     disable(unused);
320 }
321 
<a name="10" id="anc10"></a><span class="line-removed">322 void InspectorCSSAgent::discardAgent()</span>
<span class="line-removed">323 {</span>
<span class="line-removed">324     m_domAgent-&gt;setDOMListener(nullptr);</span>
<span class="line-removed">325     m_domAgent = nullptr;</span>
<span class="line-removed">326 }</span>
<span class="line-removed">327 </span>
328 void InspectorCSSAgent::reset()
329 {
330     // FIXME: Should we be resetting on main frame navigations?
331     m_idToInspectorStyleSheet.clear();
332     m_cssStyleSheetToInspectorStyleSheet.clear();
333     m_nodeToInspectorStyleSheet.clear();
334     m_documentToInspectorStyleSheet.clear();
335     m_documentToKnownCSSStyleSheets.clear();
<a name="11" id="anc11"></a><span class="line-removed">336     resetNonPersistentData();</span>
<span class="line-removed">337 }</span>
<span class="line-removed">338 </span>
<span class="line-removed">339 void InspectorCSSAgent::resetNonPersistentData()</span>
<span class="line-removed">340 {</span>
341     resetPseudoStates();
342 }
343 
344 void InspectorCSSAgent::enable(ErrorString&amp;)
345 {
<a name="12" id="anc12"></a>


346     m_instrumentingAgents.setInspectorCSSAgent(this);
347 
<a name="13" id="anc13"></a><span class="line-modified">348     for (auto* document : m_domAgent-&gt;documents())</span>
<span class="line-modified">349         activeStyleSheetsUpdated(*document);</span>


350 }
351 
352 void InspectorCSSAgent::disable(ErrorString&amp;)
353 {
354     m_instrumentingAgents.setInspectorCSSAgent(nullptr);
<a name="14" id="anc14"></a>

355 }
356 
357 void InspectorCSSAgent::documentDetached(Document&amp; document)
358 {
359     Vector&lt;CSSStyleSheet*&gt; emptyList;
360     setActiveStyleSheetsForDocument(document, emptyList);
361 
362     m_documentToKnownCSSStyleSheets.remove(&amp;document);
363     m_documentToInspectorStyleSheet.remove(&amp;document);
364     m_documentsWithForcedPseudoStates.remove(&amp;document);
365 }
366 
367 void InspectorCSSAgent::mediaQueryResultChanged()
368 {
369     m_frontendDispatcher-&gt;mediaQueryResultChanged();
370 }
371 
372 void InspectorCSSAgent::activeStyleSheetsUpdated(Document&amp; document)
373 {
374     Vector&lt;CSSStyleSheet*&gt; cssStyleSheets;
375     collectAllDocumentStyleSheets(document, cssStyleSheets);
376 
377     setActiveStyleSheetsForDocument(document, cssStyleSheets);
378 }
379 
380 void InspectorCSSAgent::setActiveStyleSheetsForDocument(Document&amp; document, Vector&lt;CSSStyleSheet*&gt;&amp; activeStyleSheets)
381 {
382     HashSet&lt;CSSStyleSheet*&gt;&amp; previouslyKnownActiveStyleSheets = m_documentToKnownCSSStyleSheets.add(&amp;document, HashSet&lt;CSSStyleSheet*&gt;()).iterator-&gt;value;
383 
384     HashSet&lt;CSSStyleSheet*&gt; removedStyleSheets(previouslyKnownActiveStyleSheets);
385     Vector&lt;CSSStyleSheet*&gt; addedStyleSheets;
386     for (auto&amp; activeStyleSheet : activeStyleSheets) {
387         if (removedStyleSheets.contains(activeStyleSheet))
388             removedStyleSheets.remove(activeStyleSheet);
389         else
390             addedStyleSheets.append(activeStyleSheet);
391     }
392 
393     for (auto* cssStyleSheet : removedStyleSheets) {
394         previouslyKnownActiveStyleSheets.remove(cssStyleSheet);
395         RefPtr&lt;InspectorStyleSheet&gt; inspectorStyleSheet = m_cssStyleSheetToInspectorStyleSheet.get(cssStyleSheet);
396         if (m_idToInspectorStyleSheet.contains(inspectorStyleSheet-&gt;id())) {
397             String id = unbindStyleSheet(inspectorStyleSheet.get());
398             m_frontendDispatcher-&gt;styleSheetRemoved(id);
399         }
400     }
401 
402     for (auto* cssStyleSheet : addedStyleSheets) {
403         previouslyKnownActiveStyleSheets.add(cssStyleSheet);
404         if (!m_cssStyleSheetToInspectorStyleSheet.contains(cssStyleSheet)) {
405             InspectorStyleSheet* inspectorStyleSheet = bindStyleSheet(cssStyleSheet);
406             m_frontendDispatcher-&gt;styleSheetAdded(inspectorStyleSheet-&gt;buildObjectForStyleSheetInfo());
407         }
408     }
409 }
410 
411 bool InspectorCSSAgent::forcePseudoState(const Element&amp; element, CSSSelector::PseudoClassType pseudoClassType)
412 {
413     if (m_nodeIdToForcedPseudoState.isEmpty())
414         return false;
415 
<a name="15" id="anc15"></a><span class="line-modified">416     int nodeId = m_domAgent-&gt;boundNodeId(&amp;element);</span>




417     if (!nodeId)
418         return false;
419 
420     unsigned forcedPseudoState = m_nodeIdToForcedPseudoState.get(nodeId);
421     switch (pseudoClassType) {
422     case CSSSelector::PseudoClassActive:
423         return forcedPseudoState &amp; PseudoClassActive;
424     case CSSSelector::PseudoClassFocus:
425         return forcedPseudoState &amp; PseudoClassFocus;
426     case CSSSelector::PseudoClassHover:
427         return forcedPseudoState &amp; PseudoClassHover;
428     case CSSSelector::PseudoClassVisited:
429         return forcedPseudoState &amp; PseudoClassVisited;
430     default:
431         return false;
432     }
433 }
434 
<a name="16" id="anc16"></a>



































435 void InspectorCSSAgent::getMatchedStylesForNode(ErrorString&amp; errorString, int nodeId, const bool* includePseudo, const bool* includeInherited, RefPtr&lt;JSON::ArrayOf&lt;Inspector::Protocol::CSS::RuleMatch&gt;&gt;&amp; matchedCSSRules, RefPtr&lt;JSON::ArrayOf&lt;Inspector::Protocol::CSS::PseudoIdMatches&gt;&gt;&amp; pseudoIdMatches, RefPtr&lt;JSON::ArrayOf&lt;Inspector::Protocol::CSS::InheritedStyleEntry&gt;&gt;&amp; inheritedEntries)
436 {
437     Element* element = elementForId(errorString, nodeId);
438     if (!element)
439         return;
440 
441     Element* originalElement = element;
442     PseudoId elementPseudoId = element-&gt;pseudoId();
443     if (elementPseudoId != PseudoId::None) {
444         element = downcast&lt;PseudoElement&gt;(*element).hostElement();
445         if (!element) {
<a name="17" id="anc17"></a><span class="line-modified">446             errorString = &quot;Pseudo element has no parent&quot;_s;</span>
447             return;
448         }
449     }
450 
451     // Matched rules.
452     StyleResolver&amp; styleResolver = element-&gt;styleResolver();
453     auto matchedRules = styleResolver.pseudoStyleRulesForElement(element, elementPseudoId, StyleResolver::AllCSSRules);
454     matchedCSSRules = buildArrayForMatchedRuleList(matchedRules, styleResolver, *element, elementPseudoId);
455 
456     if (!originalElement-&gt;isPseudoElement()) {
457         // Pseudo elements.
458         if (!includePseudo || *includePseudo) {
459             auto pseudoElements = JSON::ArrayOf&lt;Inspector::Protocol::CSS::PseudoIdMatches&gt;::create();
460             for (PseudoId pseudoId = PseudoId::FirstPublicPseudoId; pseudoId &lt; PseudoId::AfterLastInternalPseudoId; pseudoId = static_cast&lt;PseudoId&gt;(static_cast&lt;unsigned&gt;(pseudoId) + 1)) {
<a name="18" id="anc18"></a><span class="line-modified">461                 auto matchedRules = styleResolver.pseudoStyleRulesForElement(element, pseudoId, StyleResolver::AllCSSRules);</span>
<span class="line-modified">462                 if (!matchedRules.isEmpty()) {</span>
<span class="line-modified">463                     auto matches = Inspector::Protocol::CSS::PseudoIdMatches::create()</span>
<span class="line-modified">464                         .setPseudoId(static_cast&lt;int&gt;(pseudoId))</span>
<span class="line-modified">465                         .setMatches(buildArrayForMatchedRuleList(matchedRules, styleResolver, *element, pseudoId))</span>
<span class="line-modified">466                         .release();</span>
<span class="line-modified">467                     pseudoElements-&gt;addItem(WTFMove(matches));</span>


468                 }
469             }
470 
471             pseudoIdMatches = WTFMove(pseudoElements);
472         }
473 
474         // Inherited styles.
475         if (!includeInherited || *includeInherited) {
476             auto entries = JSON::ArrayOf&lt;Inspector::Protocol::CSS::InheritedStyleEntry&gt;::create();
477             Element* parentElement = element-&gt;parentElement();
478             while (parentElement) {
479                 StyleResolver&amp; parentStyleResolver = parentElement-&gt;styleResolver();
480                 auto parentMatchedRules = parentStyleResolver.styleRulesForElement(parentElement, StyleResolver::AllCSSRules);
481                 auto entry = Inspector::Protocol::CSS::InheritedStyleEntry::create()
482                     .setMatchedCSSRules(buildArrayForMatchedRuleList(parentMatchedRules, styleResolver, *parentElement, PseudoId::None))
483                     .release();
484                 if (is&lt;StyledElement&gt;(*parentElement) &amp;&amp; downcast&lt;StyledElement&gt;(*parentElement).cssomStyle().length()) {
485                     auto&amp; styleSheet = asInspectorStyleSheet(downcast&lt;StyledElement&gt;(*parentElement));
486                     entry-&gt;setInlineStyle(styleSheet.buildObjectForStyle(styleSheet.styleForId(InspectorCSSId(styleSheet.id(), 0))));
487                 }
488 
489                 entries-&gt;addItem(WTFMove(entry));
490                 parentElement = parentElement-&gt;parentElement();
491             }
492 
493             inheritedEntries = WTFMove(entries);
494         }
495     }
496 }
497 
498 void InspectorCSSAgent::getInlineStylesForNode(ErrorString&amp; errorString, int nodeId, RefPtr&lt;Inspector::Protocol::CSS::CSSStyle&gt;&amp; inlineStyle, RefPtr&lt;Inspector::Protocol::CSS::CSSStyle&gt;&amp; attributesStyle)
499 {
500     auto* element = elementForId(errorString, nodeId);
501     if (!is&lt;StyledElement&gt;(element))
502         return;
503 
504     auto&amp; styledElement = downcast&lt;StyledElement&gt;(*element);
505     auto&amp; styleSheet = asInspectorStyleSheet(styledElement);
506     inlineStyle = styleSheet.buildObjectForStyle(&amp;styledElement.cssomStyle());
507     if (auto attributes = buildObjectForAttributesStyle(styledElement))
508         attributesStyle = WTFMove(attributes);
509     else
510         attributesStyle = nullptr;
511 }
512 
513 void InspectorCSSAgent::getComputedStyleForNode(ErrorString&amp; errorString, int nodeId, RefPtr&lt;JSON::ArrayOf&lt;Inspector::Protocol::CSS::CSSComputedStyleProperty&gt;&gt;&amp; style)
514 {
515     auto* element = elementForId(errorString, nodeId);
516     if (!element)
517         return;
518 
519     auto computedStyleInfo = CSSComputedStyleDeclaration::create(*element, true);
520     auto inspectorStyle = InspectorStyle::create(InspectorCSSId(), WTFMove(computedStyleInfo), nullptr);
521     style = inspectorStyle-&gt;buildArrayForComputedStyle();
522 }
523 
524 void InspectorCSSAgent::getAllStyleSheets(ErrorString&amp;, RefPtr&lt;JSON::ArrayOf&lt;Inspector::Protocol::CSS::CSSStyleSheetHeader&gt;&gt;&amp; styleInfos)
525 {
526     styleInfos = JSON::ArrayOf&lt;Inspector::Protocol::CSS::CSSStyleSheetHeader&gt;::create();
527 
528     Vector&lt;InspectorStyleSheet*&gt; inspectorStyleSheets;
529     collectAllStyleSheets(inspectorStyleSheets);
530     for (auto* inspectorStyleSheet : inspectorStyleSheets)
531         styleInfos-&gt;addItem(inspectorStyleSheet-&gt;buildObjectForStyleSheetInfo());
532 }
533 
534 void InspectorCSSAgent::collectAllStyleSheets(Vector&lt;InspectorStyleSheet*&gt;&amp; result)
535 {
536     Vector&lt;CSSStyleSheet*&gt; cssStyleSheets;
<a name="19" id="anc19"></a><span class="line-modified">537     for (auto* document : m_domAgent-&gt;documents())</span>
<span class="line-modified">538         collectAllDocumentStyleSheets(*document, cssStyleSheets);</span>


539 
540     for (auto* cssStyleSheet : cssStyleSheets)
541         result.append(bindStyleSheet(cssStyleSheet));
542 }
543 
544 void InspectorCSSAgent::collectAllDocumentStyleSheets(Document&amp; document, Vector&lt;CSSStyleSheet*&gt;&amp; result)
545 {
546     auto cssStyleSheets = document.styleScope().activeStyleSheetsForInspector();
547     for (auto&amp; cssStyleSheet : cssStyleSheets)
548         collectStyleSheets(cssStyleSheet.get(), result);
549 }
550 
551 void InspectorCSSAgent::collectStyleSheets(CSSStyleSheet* styleSheet, Vector&lt;CSSStyleSheet*&gt;&amp; result)
552 {
553     result.append(styleSheet);
554 
555     for (unsigned i = 0, size = styleSheet-&gt;length(); i &lt; size; ++i) {
556         CSSRule* rule = styleSheet-&gt;item(i);
557         if (is&lt;CSSImportRule&gt;(*rule)) {
558             if (CSSStyleSheet* importedStyleSheet = downcast&lt;CSSImportRule&gt;(*rule).styleSheet())
559                 collectStyleSheets(importedStyleSheet, result);
560         }
561     }
562 }
563 
564 void InspectorCSSAgent::getStyleSheet(ErrorString&amp; errorString, const String&amp; styleSheetId, RefPtr&lt;Inspector::Protocol::CSS::CSSStyleSheetBody&gt;&amp; styleSheetObject)
565 {
566     InspectorStyleSheet* inspectorStyleSheet = assertStyleSheetForId(errorString, styleSheetId);
567     if (!inspectorStyleSheet)
568         return;
569 
570     styleSheetObject = inspectorStyleSheet-&gt;buildObjectForStyleSheet();
571 }
572 
573 void InspectorCSSAgent::getStyleSheetText(ErrorString&amp; errorString, const String&amp; styleSheetId, String* result)
574 {
575     InspectorStyleSheet* inspectorStyleSheet = assertStyleSheetForId(errorString, styleSheetId);
576     if (!inspectorStyleSheet)
577         return;
578 
579     auto text = inspectorStyleSheet-&gt;text();
580     if (!text.hasException())
581         *result = text.releaseReturnValue();
582 }
583 
584 void InspectorCSSAgent::setStyleSheetText(ErrorString&amp; errorString, const String&amp; styleSheetId, const String&amp; text)
585 {
586     InspectorStyleSheet* inspectorStyleSheet = assertStyleSheetForId(errorString, styleSheetId);
587     if (!inspectorStyleSheet)
588         return;
589 
<a name="20" id="anc20"></a><span class="line-modified">590     auto result = m_domAgent-&gt;history()-&gt;perform(std::make_unique&lt;SetStyleSheetTextAction&gt;(inspectorStyleSheet, text));</span>






591     if (result.hasException())
592         errorString = InspectorDOMAgent::toErrorString(result.releaseException());
593 }
594 
595 void InspectorCSSAgent::setStyleText(ErrorString&amp; errorString, const JSON::Object&amp; fullStyleId, const String&amp; text, RefPtr&lt;Inspector::Protocol::CSS::CSSStyle&gt;&amp; result)
596 {
597     InspectorCSSId compoundId(fullStyleId);
598     ASSERT(!compoundId.isEmpty());
599 
600     InspectorStyleSheet* inspectorStyleSheet = assertStyleSheetForId(errorString, compoundId.styleSheetId());
601     if (!inspectorStyleSheet)
602         return;
603 
<a name="21" id="anc21"></a><span class="line-modified">604     auto performResult = m_domAgent-&gt;history()-&gt;perform(std::make_unique&lt;SetStyleTextAction&gt;(inspectorStyleSheet, compoundId, text));</span>






605     if (performResult.hasException()) {
606         errorString = InspectorDOMAgent::toErrorString(performResult.releaseException());
607         return;
608     }
609 
610     result = inspectorStyleSheet-&gt;buildObjectForStyle(inspectorStyleSheet-&gt;styleForId(compoundId));
611 }
612 
613 void InspectorCSSAgent::setRuleSelector(ErrorString&amp; errorString, const JSON::Object&amp; fullRuleId, const String&amp; selector, RefPtr&lt;Inspector::Protocol::CSS::CSSRule&gt;&amp; result)
614 {
615     InspectorCSSId compoundId(fullRuleId);
616     ASSERT(!compoundId.isEmpty());
617 
618     InspectorStyleSheet* inspectorStyleSheet = assertStyleSheetForId(errorString, compoundId.styleSheetId());
619     if (!inspectorStyleSheet)
620         return;
621 
<a name="22" id="anc22"></a><span class="line-modified">622     auto performResult = m_domAgent-&gt;history()-&gt;perform(std::make_unique&lt;SetRuleSelectorAction&gt;(inspectorStyleSheet, compoundId, selector));</span>






623     if (performResult.hasException()) {
624         errorString = InspectorDOMAgent::toErrorString(performResult.releaseException());
625         return;
626     }
627 
628     result = inspectorStyleSheet-&gt;buildObjectForRule(inspectorStyleSheet-&gt;ruleForId(compoundId), nullptr);
629 }
630 
631 void InspectorCSSAgent::createStyleSheet(ErrorString&amp; errorString, const String&amp; frameId, String* styleSheetId)
632 {
<a name="23" id="anc23"></a><span class="line-modified">633     Frame* frame = m_domAgent-&gt;pageAgent()-&gt;frameForId(frameId);</span>
<span class="line-modified">634     if (!frame) {</span>
<span class="line-modified">635         errorString = &quot;No frame for given id found&quot;_s;</span>
636         return;
637     }
638 
<a name="24" id="anc24"></a>



639     Document* document = frame-&gt;document();
640     if (!document) {
<a name="25" id="anc25"></a><span class="line-modified">641         errorString = &quot;No document for frame&quot;_s;</span>
642         return;
643     }
644 
645     InspectorStyleSheet* inspectorStyleSheet = createInspectorStyleSheetForDocument(*document);
646     if (!inspectorStyleSheet) {
<a name="26" id="anc26"></a><span class="line-modified">647         errorString = &quot;Could not create stylesheet for the frame.&quot;_s;</span>
648         return;
649     }
650 
651     *styleSheetId = inspectorStyleSheet-&gt;id();
652 }
653 
654 InspectorStyleSheet* InspectorCSSAgent::createInspectorStyleSheetForDocument(Document&amp; document)
655 {
656     if (!document.isHTMLDocument() &amp;&amp; !document.isSVGDocument())
657         return nullptr;
658 
659     auto styleElement = HTMLStyleElement::create(document);
<a name="27" id="anc27"></a><span class="line-modified">660     styleElement-&gt;setAttributeWithoutSynchronization(HTMLNames::typeAttr, AtomicString(&quot;text/css&quot;, AtomicString::ConstructFromLiteral));</span>
661 
662     ContainerNode* targetNode;
663     // HEAD is absent in ImageDocuments, for example.
664     if (auto* head = document.head())
665         targetNode = head;
666     else if (auto* body = document.bodyOrFrameset())
667         targetNode = body;
668     else
669         return nullptr;
670 
671     // Inserting this &lt;style&gt; into the document will trigger activeStyleSheetsUpdated
672     // and we will create an InspectorStyleSheet for this &lt;style&gt;&#39;s CSSStyleSheet.
673     // Set this flag, so when we create it, we put it into the via inspector map.
674     m_creatingViaInspectorStyleSheet = true;
675     InlineStyleOverrideScope overrideScope(document);
676     auto appendResult = targetNode-&gt;appendChild(styleElement);
677     document.styleScope().flushPendingUpdate();
678     m_creatingViaInspectorStyleSheet = false;
679     if (appendResult.hasException())
680         return nullptr;
681 
682     auto iterator = m_documentToInspectorStyleSheet.find(&amp;document);
683     ASSERT(iterator != m_documentToInspectorStyleSheet.end());
684     if (iterator == m_documentToInspectorStyleSheet.end())
685         return nullptr;
686 
687     auto&amp; inspectorStyleSheetsForDocument = iterator-&gt;value;
688     ASSERT(!inspectorStyleSheetsForDocument.isEmpty());
689     if (inspectorStyleSheetsForDocument.isEmpty())
690         return nullptr;
691 
692     return inspectorStyleSheetsForDocument.last().get();
693 }
694 
695 void InspectorCSSAgent::addRule(ErrorString&amp; errorString, const String&amp; styleSheetId, const String&amp; selector, RefPtr&lt;Inspector::Protocol::CSS::CSSRule&gt;&amp; result)
696 {
697     InspectorStyleSheet* inspectorStyleSheet = assertStyleSheetForId(errorString, styleSheetId);
<a name="28" id="anc28"></a><span class="line-modified">698     if (!inspectorStyleSheet) {</span>
<span class="line-modified">699         errorString = &quot;No target stylesheet found&quot;_s;</span>




700         return;
701     }
702 
<a name="29" id="anc29"></a><span class="line-modified">703     auto action = std::make_unique&lt;AddRuleAction&gt;(inspectorStyleSheet, selector);</span>
704     auto&amp; rawAction = *action;
<a name="30" id="anc30"></a><span class="line-modified">705     auto performResult = m_domAgent-&gt;history()-&gt;perform(WTFMove(action));</span>
706     if (performResult.hasException()) {
707         errorString = InspectorDOMAgent::toErrorString(performResult.releaseException());
708         return;
709     }
710 
711     InspectorCSSId ruleId = rawAction.newRuleId();
712     CSSStyleRule* rule = inspectorStyleSheet-&gt;ruleForId(ruleId);
713     result = inspectorStyleSheet-&gt;buildObjectForRule(rule, nullptr);
714 }
715 
716 void InspectorCSSAgent::getSupportedCSSProperties(ErrorString&amp;, RefPtr&lt;JSON::ArrayOf&lt;Inspector::Protocol::CSS::CSSPropertyInfo&gt;&gt;&amp; cssProperties)
717 {
718     auto properties = JSON::ArrayOf&lt;Inspector::Protocol::CSS::CSSPropertyInfo&gt;::create();
719     for (int i = firstCSSProperty; i &lt;= lastCSSProperty; ++i) {
720         CSSPropertyID propertyID = convertToCSSPropertyID(i);
721         if (isInternalCSSProperty(propertyID) || !isEnabledCSSProperty(propertyID))
722             continue;
723 
724         auto property = Inspector::Protocol::CSS::CSSPropertyInfo::create()
725             .setName(getPropertyNameString(propertyID))
726             .release();
727 
728         auto aliases = CSSProperty::aliasesForProperty(propertyID);
729         if (!aliases.isEmpty()) {
730             auto aliasesArray = JSON::ArrayOf&lt;String&gt;::create();
731             for (auto&amp; alias : aliases)
732                 aliasesArray-&gt;addItem(alias);
733             property-&gt;setAliases(WTFMove(aliasesArray));
734         }
735 
736         const StylePropertyShorthand&amp; shorthand = shorthandForProperty(propertyID);
737         if (shorthand.length()) {
738             auto longhands = JSON::ArrayOf&lt;String&gt;::create();
739             for (unsigned j = 0; j &lt; shorthand.length(); ++j) {
740                 CSSPropertyID longhandID = shorthand.properties()[j];
741                 if (isEnabledCSSProperty(longhandID))
742                     longhands-&gt;addItem(getPropertyNameString(longhandID));
743             }
744             property-&gt;setLonghands(WTFMove(longhands));
745         }
746 
747         if (CSSParserFastPaths::isKeywordPropertyID(propertyID)) {
748             auto values = JSON::ArrayOf&lt;String&gt;::create();
749             for (int j = firstCSSValueKeyword; j &lt;= lastCSSValueKeyword; ++j) {
750                 CSSValueID valueID = convertToCSSValueID(j);
<a name="31" id="anc31"></a><span class="line-modified">751                 if (CSSParserFastPaths::isValidKeywordPropertyAndValue(propertyID, valueID, HTMLStandardMode))</span>
752                     values-&gt;addItem(getValueNameString(valueID));
753             }
754             if (values-&gt;length())
755                 property-&gt;setValues(WTFMove(values));
756         }
757 
758         if (CSSProperty::isInheritedProperty(propertyID))
759             property-&gt;setInherited(true);
760 
761         properties-&gt;addItem(WTFMove(property));
762     }
763     cssProperties = WTFMove(properties);
764 }
765 
766 void InspectorCSSAgent::getSupportedSystemFontFamilyNames(ErrorString&amp;, RefPtr&lt;JSON::ArrayOf&lt;String&gt;&gt;&amp; fontFamilyNames)
767 {
768     auto families = JSON::ArrayOf&lt;String&gt;::create();
769 
770     Vector&lt;String&gt; systemFontFamilies = FontCache::singleton().systemFontFamilies();
771     for (const auto&amp; familyName : systemFontFamilies)
772         families-&gt;addItem(familyName);
773 
774     fontFamilyNames = WTFMove(families);
775 }
776 
777 void InspectorCSSAgent::forcePseudoState(ErrorString&amp; errorString, int nodeId, const JSON::Array&amp; forcedPseudoClasses)
778 {
<a name="32" id="anc32"></a><span class="line-modified">779     Element* element = m_domAgent-&gt;assertElement(errorString, nodeId);</span>






780     if (!element)
781         return;
782 
783     // Return early if the forced pseudo state was already set correctly.
784     unsigned forcedPseudoState = computePseudoClassMask(forcedPseudoClasses);
785     if (forcedPseudoState) {
786         auto iterator = m_nodeIdToForcedPseudoState.add(nodeId, 0).iterator;
787         if (forcedPseudoState == iterator-&gt;value)
788             return;
789         iterator-&gt;value = forcedPseudoState;
790         m_documentsWithForcedPseudoStates.add(&amp;element-&gt;document());
791     } else {
792         if (!m_nodeIdToForcedPseudoState.remove(nodeId))
793             return;
794         if (m_nodeIdToForcedPseudoState.isEmpty())
795             m_documentsWithForcedPseudoStates.clear();
796     }
797 
798     element-&gt;document().styleScope().didChangeStyleSheetEnvironment();
799 }
800 
801 InspectorStyleSheetForInlineStyle&amp; InspectorCSSAgent::asInspectorStyleSheet(StyledElement&amp; element)
802 {
803     return m_nodeToInspectorStyleSheet.ensure(&amp;element, [this, &amp;element] {
804         String newStyleSheetId = String::number(m_lastStyleSheetId++);
<a name="33" id="anc33"></a><span class="line-modified">805         auto inspectorStyleSheet = InspectorStyleSheetForInlineStyle::create(m_domAgent-&gt;pageAgent(), newStyleSheetId, element, Inspector::Protocol::CSS::StyleSheetOrigin::Regular, this);</span>
806         m_idToInspectorStyleSheet.set(newStyleSheetId, inspectorStyleSheet.copyRef());
807         return inspectorStyleSheet;
808     }).iterator-&gt;value;
809 }
810 
811 Element* InspectorCSSAgent::elementForId(ErrorString&amp; errorString, int nodeId)
812 {
<a name="34" id="anc34"></a><span class="line-modified">813     Node* node = m_domAgent-&gt;nodeForId(nodeId);</span>
<span class="line-modified">814     if (!node) {</span>
<span class="line-modified">815         errorString = &quot;No node with given id found&quot;_s;</span>
<span class="line-removed">816         return nullptr;</span>
<span class="line-removed">817     }</span>
<span class="line-removed">818     if (!is&lt;Element&gt;(*node)) {</span>
<span class="line-removed">819         errorString = &quot;Not an element node&quot;_s;</span>
820         return nullptr;
821     }
<a name="35" id="anc35"></a><span class="line-modified">822     return downcast&lt;Element&gt;(node);</span>

823 }
824 
825 String InspectorCSSAgent::unbindStyleSheet(InspectorStyleSheet* inspectorStyleSheet)
826 {
827     String id = inspectorStyleSheet-&gt;id();
828     m_idToInspectorStyleSheet.remove(id);
829     if (inspectorStyleSheet-&gt;pageStyleSheet())
830         m_cssStyleSheetToInspectorStyleSheet.remove(inspectorStyleSheet-&gt;pageStyleSheet());
831     return id;
832 }
833 
834 InspectorStyleSheet* InspectorCSSAgent::bindStyleSheet(CSSStyleSheet* styleSheet)
835 {
836     RefPtr&lt;InspectorStyleSheet&gt; inspectorStyleSheet = m_cssStyleSheetToInspectorStyleSheet.get(styleSheet);
837     if (!inspectorStyleSheet) {
838         String id = String::number(m_lastStyleSheetId++);
839         Document* document = styleSheet-&gt;ownerDocument();
<a name="36" id="anc36"></a><span class="line-modified">840         inspectorStyleSheet = InspectorStyleSheet::create(m_domAgent-&gt;pageAgent(), id, styleSheet, detectOrigin(styleSheet, document), InspectorDOMAgent::documentURLString(document), this);</span>
841         m_idToInspectorStyleSheet.set(id, inspectorStyleSheet);
842         m_cssStyleSheetToInspectorStyleSheet.set(styleSheet, inspectorStyleSheet);
843         if (m_creatingViaInspectorStyleSheet) {
844             auto&amp; inspectorStyleSheetsForDocument = m_documentToInspectorStyleSheet.add(document, Vector&lt;RefPtr&lt;InspectorStyleSheet&gt;&gt;()).iterator-&gt;value;
845             inspectorStyleSheetsForDocument.append(inspectorStyleSheet);
846         }
847     }
848     return inspectorStyleSheet.get();
849 }
850 
851 InspectorStyleSheet* InspectorCSSAgent::assertStyleSheetForId(ErrorString&amp; errorString, const String&amp; styleSheetId)
852 {
853     IdToInspectorStyleSheet::iterator it = m_idToInspectorStyleSheet.find(styleSheetId);
854     if (it == m_idToInspectorStyleSheet.end()) {
<a name="37" id="anc37"></a><span class="line-modified">855         errorString = &quot;No stylesheet with given id found&quot;_s;</span>
856         return nullptr;
857     }
858     return it-&gt;value.get();
859 }
860 
861 Inspector::Protocol::CSS::StyleSheetOrigin InspectorCSSAgent::detectOrigin(CSSStyleSheet* pageStyleSheet, Document* ownerDocument)
862 {
863     if (m_creatingViaInspectorStyleSheet)
864         return Inspector::Protocol::CSS::StyleSheetOrigin::Inspector;
865 
866     if (pageStyleSheet &amp;&amp; !pageStyleSheet-&gt;ownerNode() &amp;&amp; pageStyleSheet-&gt;href().isEmpty())
867         return Inspector::Protocol::CSS::StyleSheetOrigin::UserAgent;
868 
869     if (pageStyleSheet &amp;&amp; pageStyleSheet-&gt;ownerNode() &amp;&amp; pageStyleSheet-&gt;ownerNode()-&gt;nodeName() == &quot;#document&quot;)
870         return Inspector::Protocol::CSS::StyleSheetOrigin::User;
871 
872     auto iterator = m_documentToInspectorStyleSheet.find(ownerDocument);
873     if (iterator != m_documentToInspectorStyleSheet.end()) {
874         for (auto&amp; inspectorStyleSheet : iterator-&gt;value) {
875             if (pageStyleSheet == inspectorStyleSheet-&gt;pageStyleSheet())
876                 return Inspector::Protocol::CSS::StyleSheetOrigin::Inspector;
877         }
878     }
879 
880     return Inspector::Protocol::CSS::StyleSheetOrigin::Regular;
881 }
882 
883 RefPtr&lt;Inspector::Protocol::CSS::CSSRule&gt; InspectorCSSAgent::buildObjectForRule(StyleRule* styleRule, StyleResolver&amp; styleResolver, Element&amp; element)
884 {
885     if (!styleRule)
886         return nullptr;
887 
888     // StyleRules returned by StyleResolver::styleRulesForElement lack parent pointers since that infomation is not cheaply available.
889     // Since the inspector wants to walk the parent chain, we construct the full wrappers here.
890     styleResolver.inspectorCSSOMWrappers().collectDocumentWrappers(styleResolver.document().extensionStyleSheets());
891     styleResolver.inspectorCSSOMWrappers().collectScopeWrappers(Style::Scope::forNode(element));
892 
893     // Possiblity of :host styles if this element has a shadow root.
894     if (ShadowRoot* shadowRoot = element.shadowRoot())
895         styleResolver.inspectorCSSOMWrappers().collectScopeWrappers(shadowRoot-&gt;styleScope());
896 
897     CSSStyleRule* cssomWrapper = styleResolver.inspectorCSSOMWrappers().getWrapperForRuleInSheets(styleRule);
898     if (!cssomWrapper)
899         return nullptr;
900 
901     InspectorStyleSheet* inspectorStyleSheet = bindStyleSheet(cssomWrapper-&gt;parentStyleSheet());
902     return inspectorStyleSheet ? inspectorStyleSheet-&gt;buildObjectForRule(cssomWrapper, &amp;element) : nullptr;
903 }
904 
905 RefPtr&lt;Inspector::Protocol::CSS::CSSRule&gt; InspectorCSSAgent::buildObjectForRule(CSSStyleRule* rule)
906 {
907     if (!rule)
908         return nullptr;
909 
910     ASSERT(rule-&gt;parentStyleSheet());
911     InspectorStyleSheet* inspectorStyleSheet = bindStyleSheet(rule-&gt;parentStyleSheet());
912     return inspectorStyleSheet ? inspectorStyleSheet-&gt;buildObjectForRule(rule, nullptr) : nullptr;
913 }
914 
915 RefPtr&lt;JSON::ArrayOf&lt;Inspector::Protocol::CSS::RuleMatch&gt;&gt; InspectorCSSAgent::buildArrayForMatchedRuleList(const Vector&lt;RefPtr&lt;StyleRule&gt;&gt;&amp; matchedRules, StyleResolver&amp; styleResolver, Element&amp; element, PseudoId pseudoId)
916 {
917     auto result = JSON::ArrayOf&lt;Inspector::Protocol::CSS::RuleMatch&gt;::create();
918 
919     SelectorChecker::CheckingContext context(SelectorChecker::Mode::CollectingRules);
920     context.pseudoId = pseudoId != PseudoId::None ? pseudoId : element.pseudoId();
921     SelectorChecker selectorChecker(element.document());
922 
923     for (auto&amp; matchedRule : matchedRules) {
924         RefPtr&lt;Inspector::Protocol::CSS::CSSRule&gt; ruleObject = buildObjectForRule(matchedRule.get(), styleResolver, element);
925         if (!ruleObject)
926             continue;
927 
928         auto matchingSelectors = JSON::ArrayOf&lt;int&gt;::create();
929         const CSSSelectorList&amp; selectorList = matchedRule-&gt;selectorList();
930         int index = 0;
931         for (const CSSSelector* selector = selectorList.first(); selector; selector = CSSSelectorList::next(selector)) {
932             unsigned ignoredSpecificity;
933             bool matched = selectorChecker.match(*selector, element, context, ignoredSpecificity);
934             if (matched)
935                 matchingSelectors-&gt;addItem(index);
936             ++index;
937         }
938 
939         auto match = Inspector::Protocol::CSS::RuleMatch::create()
940             .setRule(WTFMove(ruleObject))
941             .setMatchingSelectors(WTFMove(matchingSelectors))
942             .release();
943         result-&gt;addItem(WTFMove(match));
944     }
945 
<a name="38" id="anc38"></a><span class="line-modified">946     return WTFMove(result);</span>
947 }
948 
949 RefPtr&lt;Inspector::Protocol::CSS::CSSStyle&gt; InspectorCSSAgent::buildObjectForAttributesStyle(StyledElement&amp; element)
950 {
951     // FIXME: Ugliness below.
952     auto* attributeStyle = const_cast&lt;StyleProperties*&gt;(element.presentationAttributeStyle());
953     if (!attributeStyle)
954         return nullptr;
955 
956     auto&amp; mutableAttributeStyle = downcast&lt;MutableStyleProperties&gt;(*attributeStyle);
957     auto inspectorStyle = InspectorStyle::create(InspectorCSSId(), mutableAttributeStyle.ensureCSSStyleDeclaration(), nullptr);
958     return inspectorStyle-&gt;buildObjectForStyle();
959 }
960 
961 void InspectorCSSAgent::didRemoveDOMNode(Node&amp; node, int nodeId)
962 {
963     m_nodeIdToForcedPseudoState.remove(nodeId);
964 
965     auto sheet = m_nodeToInspectorStyleSheet.take(&amp;node);
966     if (!sheet)
967         return;
968     m_idToInspectorStyleSheet.remove(sheet.value()-&gt;id());
969 }
970 
971 void InspectorCSSAgent::didModifyDOMAttr(Element&amp; element)
972 {
973     auto sheet = m_nodeToInspectorStyleSheet.get(&amp;element);
974     if (!sheet)
975         return;
976     sheet-&gt;didModifyElementAttribute();
977 }
978 
979 void InspectorCSSAgent::styleSheetChanged(InspectorStyleSheet* styleSheet)
980 {
981     m_frontendDispatcher-&gt;styleSheetChanged(styleSheet-&gt;id());
982 }
983 
984 void InspectorCSSAgent::resetPseudoStates()
985 {
986     for (auto&amp; document : m_documentsWithForcedPseudoStates)
987         document-&gt;styleScope().didChangeStyleSheetEnvironment();
988 
989     m_nodeIdToForcedPseudoState.clear();
990     m_documentsWithForcedPseudoStates.clear();
991 }
992 
993 } // namespace WebCore
<a name="39" id="anc39"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="39" type="hidden" />
</body>
</html>