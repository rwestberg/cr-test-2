<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff modules/javafx.web/src/main/native/Source/WebCore/page/DOMWindow.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="DOMTimer.h.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="DOMWindow.h.cdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/page/DOMWindow.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 35,20 ***</span>
  #include &quot;Chrome.h&quot;
  #include &quot;ChromeClient.h&quot;
  #include &quot;ComposedTreeIterator.h&quot;
  #include &quot;ContentExtensionActions.h&quot;
  #include &quot;ContentExtensionRule.h&quot;
  #include &quot;Crypto.h&quot;
  #include &quot;CustomElementRegistry.h&quot;
  #include &quot;DOMApplicationCache.h&quot;
  #include &quot;DOMSelection.h&quot;
  #include &quot;DOMStringList.h&quot;
  #include &quot;DOMTimer.h&quot;
  #include &quot;DOMTokenList.h&quot;
  #include &quot;DOMURL.h&quot;
<span class="line-removed">- #include &quot;DOMWindowExtension.h&quot;</span>
  #include &quot;DeviceMotionController.h&quot;
  #include &quot;DeviceOrientationController.h&quot;
  #include &quot;Document.h&quot;
  #include &quot;DocumentLoader.h&quot;
  #include &quot;Editor.h&quot;
  #include &quot;Element.h&quot;
<span class="line-new-header">--- 35,23 ---</span>
  #include &quot;Chrome.h&quot;
  #include &quot;ChromeClient.h&quot;
  #include &quot;ComposedTreeIterator.h&quot;
  #include &quot;ContentExtensionActions.h&quot;
  #include &quot;ContentExtensionRule.h&quot;
<span class="line-added">+ #include &quot;ContentRuleListResults.h&quot;</span>
  #include &quot;Crypto.h&quot;
  #include &quot;CustomElementRegistry.h&quot;
  #include &quot;DOMApplicationCache.h&quot;
  #include &quot;DOMSelection.h&quot;
  #include &quot;DOMStringList.h&quot;
  #include &quot;DOMTimer.h&quot;
  #include &quot;DOMTokenList.h&quot;
  #include &quot;DOMURL.h&quot;
  #include &quot;DeviceMotionController.h&quot;
<span class="line-added">+ #include &quot;DeviceMotionData.h&quot;</span>
<span class="line-added">+ #include &quot;DeviceMotionEvent.h&quot;</span>
<span class="line-added">+ #include &quot;DeviceOrientationAndMotionAccessController.h&quot;</span>
  #include &quot;DeviceOrientationController.h&quot;
  #include &quot;Document.h&quot;
  #include &quot;DocumentLoader.h&quot;
  #include &quot;Editor.h&quot;
  #include &quot;Element.h&quot;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 110,15 ***</span>
<span class="line-new-header">--- 113,17 ---</span>
  #include &quot;WindowProxy.h&quot;
  #include &lt;JavaScriptCore/ScriptCallStack.h&gt;
  #include &lt;JavaScriptCore/ScriptCallStackFactory.h&gt;
  #include &lt;algorithm&gt;
  #include &lt;memory&gt;
<span class="line-added">+ #include &lt;wtf/IsoMallocInlines.h&gt;</span>
  #include &lt;wtf/Language.h&gt;
  #include &lt;wtf/MainThread.h&gt;
  #include &lt;wtf/MathExtras.h&gt;
  #include &lt;wtf/NeverDestroyed.h&gt;
  #include &lt;wtf/Ref.h&gt;
<span class="line-added">+ #include &lt;wtf/SetForScope.h&gt;</span>
  #include &lt;wtf/Variant.h&gt;
  #include &lt;wtf/text/WTFString.h&gt;
  
  #if ENABLE(USER_MESSAGE_HANDLERS)
  #include &quot;UserContentController.h&quot;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 136,19 ***</span>
  
  #if ENABLE(POINTER_LOCK)
  #include &quot;PointerLockController.h&quot;
  #endif
  
<span class="line-removed">- #if PLATFORM(IOS_FAMILY)</span>
<span class="line-removed">- #include &quot;WKContentObservation.h&quot;</span>
<span class="line-removed">- #include &quot;WKContentObservationInternal.h&quot;</span>
<span class="line-removed">- #endif</span>
<span class="line-removed">- </span>
<span class="line-removed">- </span>
  namespace WebCore {
  using namespace Inspector;
  
  class PostMessageTimer : public TimerBase {
  public:
      PostMessageTimer(DOMWindow&amp; window, MessageWithMessagePorts&amp;&amp; message, const String&amp; sourceOrigin, RefPtr&lt;WindowProxy&gt;&amp;&amp; source, RefPtr&lt;SecurityOrigin&gt;&amp;&amp; targetOrigin, RefPtr&lt;ScriptCallStack&gt;&amp;&amp; stackTrace)
          : m_window(window)
          , m_message(WTFMove(message))
<span class="line-new-header">--- 141,15 ---</span>
  
  #if ENABLE(POINTER_LOCK)
  #include &quot;PointerLockController.h&quot;
  #endif
  
  namespace WebCore {
  using namespace Inspector;
  
<span class="line-added">+ WTF_MAKE_ISO_ALLOCATED_IMPL(DOMWindow);</span>
<span class="line-added">+ </span>
  class PostMessageTimer : public TimerBase {
  public:
      PostMessageTimer(DOMWindow&amp; window, MessageWithMessagePorts&amp;&amp; message, const String&amp; sourceOrigin, RefPtr&lt;WindowProxy&gt;&amp;&amp; source, RefPtr&lt;SecurityOrigin&gt;&amp;&amp; targetOrigin, RefPtr&lt;ScriptCallStack&gt;&amp;&amp; stackTrace)
          : m_window(window)
          , m_message(WTFMove(message))
</pre>
<hr />
<pre>
<span class="line-old-header">*** 412,10 ***</span>
<span class="line-new-header">--- 413,38 ---</span>
  }
  
  void DOMWindow::didSecureTransitionTo(Document&amp; document)
  {
      observeContext(&amp;document);
<span class="line-added">+ </span>
<span class="line-added">+     // The Window is being transferred from one document to another so we need to reset data</span>
<span class="line-added">+     // members that store the window&#39;s document (rather than the window itself).</span>
<span class="line-added">+     m_crypto = nullptr;</span>
<span class="line-added">+     m_navigator = nullptr;</span>
<span class="line-added">+     m_performance = nullptr;</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
<span class="line-added">+ void DOMWindow::prewarmLocalStorageIfNecessary()</span>
<span class="line-added">+ {</span>
<span class="line-added">+     auto* page = this-&gt;page();</span>
<span class="line-added">+ </span>
<span class="line-added">+     // No need to prewarm for ephemeral sessions since the data is in memory only.</span>
<span class="line-added">+     if (!page || page-&gt;usesEphemeralSession())</span>
<span class="line-added">+         return;</span>
<span class="line-added">+ </span>
<span class="line-added">+     if (!page-&gt;mainFrame().mayPrewarmLocalStorage())</span>
<span class="line-added">+         return;</span>
<span class="line-added">+ </span>
<span class="line-added">+     auto localStorageResult = this-&gt;localStorage();</span>
<span class="line-added">+     if (localStorageResult.hasException())</span>
<span class="line-added">+         return;</span>
<span class="line-added">+ </span>
<span class="line-added">+     auto* localStorage = localStorageResult.returnValue();</span>
<span class="line-added">+     if (!localStorage)</span>
<span class="line-added">+         return;</span>
<span class="line-added">+ </span>
<span class="line-added">+     page-&gt;mainFrame().didPrewarmLocalStorage();</span>
  }
  
  DOMWindow::~DOMWindow()
  {
      if (m_suspendedForDocumentSuspension)
</pre>
<hr />
<pre>
<span class="line-old-header">*** 452,38 ***</span>
      JSDOMWindowBase::fireFrameClearedWatchpointsForWindow(this);
  }
  
  void DOMWindow::willDestroyCachedFrame()
  {
<span class="line-modified">!     // It is necessary to copy m_properties to a separate vector because the DOMWindowProperties may</span>
      // unregister themselves from the DOMWindow as a result of the call to willDestroyGlobalObjectInCachedFrame.
<span class="line-modified">!     for (auto* property : copyToVector(m_properties)) {</span>
<span class="line-modified">!         if (m_properties.contains(property))</span>
<span class="line-modified">!         property-&gt;willDestroyGlobalObjectInCachedFrame();</span>
      }
  }
  
  void DOMWindow::willDestroyDocumentInFrame()
  {
<span class="line-modified">!     // It is necessary to copy m_properties to a separate vector because the DOMWindowProperties may</span>
      // unregister themselves from the DOMWindow as a result of the call to willDestroyGlobalObjectInFrame.
<span class="line-modified">!     for (auto* property : copyToVector(m_properties)) {</span>
<span class="line-modified">!         if (m_properties.contains(property))</span>
<span class="line-modified">!         property-&gt;willDestroyGlobalObjectInFrame();</span>
      }
  }
  
  void DOMWindow::willDetachDocumentFromFrame()
  {
      if (!frame())
          return;
  
<span class="line-modified">!     // It is necessary to copy m_properties to a separate vector because the DOMWindowProperties may</span>
      // unregister themselves from the DOMWindow as a result of the call to willDetachGlobalObjectFromFrame.
<span class="line-modified">!     for (auto&amp; property : copyToVector(m_properties)) {</span>
<span class="line-modified">!         if (m_properties.contains(property))</span>
<span class="line-modified">!         property-&gt;willDetachGlobalObjectFromFrame();</span>
      }
  
      if (m_performance)
          m_performance-&gt;clearResourceTimings();
  
<span class="line-new-header">--- 481,40 ---</span>
      JSDOMWindowBase::fireFrameClearedWatchpointsForWindow(this);
  }
  
  void DOMWindow::willDestroyCachedFrame()
  {
<span class="line-modified">!     // It is necessary to copy m_observers to a separate vector because the Observer may</span>
      // unregister themselves from the DOMWindow as a result of the call to willDestroyGlobalObjectInCachedFrame.
<span class="line-modified">!     for (auto* observer : copyToVector(m_observers)) {</span>
<span class="line-modified">!         if (m_observers.contains(observer))</span>
<span class="line-modified">!             observer-&gt;willDestroyGlobalObjectInCachedFrame();</span>
      }
  }
  
  void DOMWindow::willDestroyDocumentInFrame()
  {
<span class="line-modified">!     // It is necessary to copy m_observers to a separate vector because the Observer may</span>
      // unregister themselves from the DOMWindow as a result of the call to willDestroyGlobalObjectInFrame.
<span class="line-modified">!     for (auto* observer : copyToVector(m_observers)) {</span>
<span class="line-modified">!         if (m_observers.contains(observer))</span>
<span class="line-modified">!             observer-&gt;willDestroyGlobalObjectInFrame();</span>
      }
  }
  
  void DOMWindow::willDetachDocumentFromFrame()
  {
      if (!frame())
          return;
  
<span class="line-modified">!     RELEASE_ASSERT(!m_isSuspendingObservers);</span>
<span class="line-added">+ </span>
<span class="line-added">+     // It is necessary to copy m_observers to a separate vector because the Observer may</span>
      // unregister themselves from the DOMWindow as a result of the call to willDetachGlobalObjectFromFrame.
<span class="line-modified">!     for (auto&amp; observer : copyToVector(m_observers)) {</span>
<span class="line-modified">!         if (m_observers.contains(observer))</span>
<span class="line-modified">!             observer-&gt;willDetachGlobalObjectFromFrame();</span>
      }
  
      if (m_performance)
          m_performance-&gt;clearResourceTimings();
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 507,72 ***</span>
          GamepadManager::singleton().unregisterDOMWindow(this);
  }
  
  #endif
  
<span class="line-modified">! void DOMWindow::registerProperty(DOMWindowProperty&amp; property)</span>
  {
<span class="line-modified">!     m_properties.add(&amp;property);</span>
  }
  
<span class="line-modified">! void DOMWindow::unregisterProperty(DOMWindowProperty&amp; property)</span>
  {
<span class="line-modified">!     m_properties.remove(&amp;property);</span>
  }
  
  void DOMWindow::resetUnlessSuspendedForDocumentSuspension()
  {
      if (m_suspendedForDocumentSuspension)
          return;
      willDestroyDocumentInFrame();
<span class="line-removed">-     resetDOMWindowProperties();</span>
  }
  
  void DOMWindow::suspendForPageCache()
  {
<span class="line-modified">!     for (auto* property : copyToVector(m_properties)) {</span>
<span class="line-modified">!         if (m_properties.contains(property))</span>
<span class="line-modified">!         property-&gt;suspendForPageCache();</span>
      }
  
      m_suspendedForDocumentSuspension = true;
  }
  
  void DOMWindow::resumeFromPageCache()
  {
<span class="line-modified">!     for (auto* property : copyToVector(m_properties)) {</span>
<span class="line-modified">!         if (m_properties.contains(property))</span>
<span class="line-modified">!         property-&gt;resumeFromPageCache();</span>
      }
  
      m_suspendedForDocumentSuspension = false;
  }
  
<span class="line-removed">- void DOMWindow::resetDOMWindowProperties()</span>
<span class="line-removed">- {</span>
<span class="line-removed">-     m_properties.clear();</span>
<span class="line-removed">- </span>
<span class="line-removed">-     m_applicationCache = nullptr;</span>
<span class="line-removed">-     m_crypto = nullptr;</span>
<span class="line-removed">-     m_history = nullptr;</span>
<span class="line-removed">-     m_localStorage = nullptr;</span>
<span class="line-removed">-     m_location = nullptr;</span>
<span class="line-removed">-     m_locationbar = nullptr;</span>
<span class="line-removed">-     m_media = nullptr;</span>
<span class="line-removed">-     m_menubar = nullptr;</span>
<span class="line-removed">-     m_navigator = nullptr;</span>
<span class="line-removed">-     m_personalbar = nullptr;</span>
<span class="line-removed">-     m_screen = nullptr;</span>
<span class="line-removed">-     m_scrollbars = nullptr;</span>
<span class="line-removed">-     m_selection = nullptr;</span>
<span class="line-removed">-     m_sessionStorage = nullptr;</span>
<span class="line-removed">-     m_statusbar = nullptr;</span>
<span class="line-removed">-     m_toolbar = nullptr;</span>
<span class="line-removed">-     m_performance = nullptr;</span>
<span class="line-removed">-     m_visualViewport = nullptr;</span>
<span class="line-removed">- }</span>
<span class="line-removed">- </span>
  bool DOMWindow::isCurrentlyDisplayedInFrame() const
  {
      auto* frame = this-&gt;frame();
      return frame &amp;&amp; frame-&gt;document()-&gt;domWindow() == this;
  }
<span class="line-new-header">--- 538,51 ---</span>
          GamepadManager::singleton().unregisterDOMWindow(this);
  }
  
  #endif
  
<span class="line-modified">! void DOMWindow::registerObserver(Observer&amp; observer)</span>
  {
<span class="line-modified">!     m_observers.add(&amp;observer);</span>
  }
  
<span class="line-modified">! void DOMWindow::unregisterObserver(Observer&amp; observer)</span>
  {
<span class="line-modified">!     m_observers.remove(&amp;observer);</span>
  }
  
  void DOMWindow::resetUnlessSuspendedForDocumentSuspension()
  {
      if (m_suspendedForDocumentSuspension)
          return;
      willDestroyDocumentInFrame();
  }
  
  void DOMWindow::suspendForPageCache()
  {
<span class="line-modified">!     SetForScope&lt;bool&gt; isSuspendingObservers(m_isSuspendingObservers, true);</span>
<span class="line-modified">!     RELEASE_ASSERT(frame());</span>
<span class="line-modified">! </span>
<span class="line-added">+     for (auto* observer : copyToVector(m_observers)) {</span>
<span class="line-added">+         if (m_observers.contains(observer))</span>
<span class="line-added">+             observer-&gt;suspendForPageCache();</span>
      }
<span class="line-added">+     RELEASE_ASSERT(frame());</span>
  
      m_suspendedForDocumentSuspension = true;
  }
  
  void DOMWindow::resumeFromPageCache()
  {
<span class="line-modified">!     for (auto* observer : copyToVector(m_observers)) {</span>
<span class="line-modified">!         if (m_observers.contains(observer))</span>
<span class="line-modified">!             observer-&gt;resumeFromPageCache();</span>
      }
  
      m_suspendedForDocumentSuspension = false;
  }
  
  bool DOMWindow::isCurrentlyDisplayedInFrame() const
  {
      auto* frame = this-&gt;frame();
      return frame &amp;&amp; frame-&gt;document()-&gt;domWindow() == this;
  }
</pre>
<hr />
<pre>
<span class="line-old-header">*** 664,10 ***</span>
<span class="line-new-header">--- 674,11 ---</span>
  
  Crypto&amp; DOMWindow::crypto() const
  {
      if (!m_crypto)
          m_crypto = Crypto::create(document());
<span class="line-added">+     ASSERT(m_crypto-&gt;scriptExecutionContext() == document());</span>
      return *m_crypto;
  }
  
  BarProp&amp; DOMWindow::locationbar()
  {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 729,20 ***</span>
<span class="line-new-header">--- 740,22 ---</span>
  
  Navigator&amp; DOMWindow::navigator()
  {
      if (!m_navigator)
          m_navigator = Navigator::create(scriptExecutionContext(), *this);
<span class="line-added">+     ASSERT(m_navigator-&gt;scriptExecutionContext() == document());</span>
  
      return *m_navigator;
  }
  
  Performance&amp; DOMWindow::performance() const
  {
      if (!m_performance) {
          MonotonicTime timeOrigin = document() &amp;&amp; document()-&gt;loader() ? document()-&gt;loader()-&gt;timing().referenceMonotonicTime() : MonotonicTime::now();
          m_performance = Performance::create(document(), timeOrigin);
      }
<span class="line-added">+     ASSERT(m_performance-&gt;scriptExecutionContext() == document());</span>
      return *m_performance;
  }
  
  double DOMWindow::nowTimestamp() const
  {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 959,12 ***</span>
      return frame-&gt;ownerElement();
  }
  
  void DOMWindow::focus(DOMWindow&amp; incumbentWindow)
  {
<span class="line-modified">!     auto* opener = this-&gt;opener();</span>
<span class="line-modified">!     focus(opener &amp;&amp; opener != self() &amp;&amp; incumbentWindow.self() == opener);</span>
  }
  
  void DOMWindow::focus(bool allowFocus)
  {
      if (!frame())
<span class="line-new-header">--- 972,13 ---</span>
      return frame-&gt;ownerElement();
  }
  
  void DOMWindow::focus(DOMWindow&amp; incumbentWindow)
  {
<span class="line-modified">!     auto* frame = this-&gt;frame();</span>
<span class="line-modified">!     auto* openerFrame = frame ? frame-&gt;loader().opener() : nullptr;</span>
<span class="line-added">+     focus(openerFrame &amp;&amp; openerFrame != frame &amp;&amp; incumbentWindow.frame() == openerFrame);</span>
  }
  
  void DOMWindow::focus(bool allowFocus)
  {
      if (!frame())
</pre>
<hr />
<pre>
<span class="line-old-header">*** 981,10 ***</span>
<span class="line-new-header">--- 995,13 ---</span>
          page-&gt;chrome().focus();
  
      if (!frame())
          return;
  
<span class="line-added">+     if (!frame()-&gt;hasHadUserInteraction() &amp;&amp; !isSameSecurityOriginAsMainFrame())</span>
<span class="line-added">+         return;</span>
<span class="line-added">+ </span>
      // Clear the current frame&#39;s focused node if a new frame is about to be focused.
      Frame* focusedFrame = page-&gt;focusController().focusedFrame();
      if (focusedFrame &amp;&amp; focusedFrame != frame())
          focusedFrame-&gt;document()-&gt;setFocusedElement(nullptr);
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1239,18 ***</span>
  {
      if (!frame())
          return 0;
  
      // Force enough layout in the parent document to ensure that the FrameView has been resized.
<span class="line-modified">!     if (auto* frameElement = this-&gt;frameElement())</span>
<span class="line-modified">!         frameElement-&gt;document().updateLayoutIfDimensionsOutOfDate(*frameElement, HeightDimensionsCheck);</span>
  
<span class="line-modified">!     auto* frame = this-&gt;frame();</span>
      if (!frame)
          return 0;
  
<span class="line-modified">!     FrameView* view = frame-&gt;view();</span>
      if (!view)
          return 0;
  
      return view-&gt;mapFromLayoutToCSSUnits(static_cast&lt;int&gt;(view-&gt;unobscuredContentRectIncludingScrollbars().height()));
  }
<span class="line-new-header">--- 1256,18 ---</span>
  {
      if (!frame())
          return 0;
  
      // Force enough layout in the parent document to ensure that the FrameView has been resized.
<span class="line-modified">!     if (auto ownerElement = makeRefPtr(frameElement()))</span>
<span class="line-modified">!         ownerElement-&gt;document().updateLayoutIfDimensionsOutOfDate(*ownerElement, HeightDimensionsCheck);</span>
  
<span class="line-modified">!     auto frame = makeRefPtr(this-&gt;frame());</span>
      if (!frame)
          return 0;
  
<span class="line-modified">!     auto view = makeRefPtr(frame-&gt;view());</span>
      if (!view)
          return 0;
  
      return view-&gt;mapFromLayoutToCSSUnits(static_cast&lt;int&gt;(view-&gt;unobscuredContentRectIncludingScrollbars().height()));
  }
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1259,27 ***</span>
  {
      if (!frame())
          return 0;
  
      // Force enough layout in the parent document to ensure that the FrameView has been resized.
<span class="line-modified">!     if (auto* frameElement = this-&gt;frameElement())</span>
<span class="line-modified">!         frameElement-&gt;document().updateLayoutIfDimensionsOutOfDate(*frameElement, WidthDimensionsCheck);</span>
  
<span class="line-modified">!     auto* frame = this-&gt;frame();</span>
      if (!frame)
          return 0;
  
<span class="line-modified">!     FrameView* view = frame-&gt;view();</span>
      if (!view)
          return 0;
  
      return view-&gt;mapFromLayoutToCSSUnits(static_cast&lt;int&gt;(view-&gt;unobscuredContentRectIncludingScrollbars().width()));
  }
  
  int DOMWindow::screenX() const
  {
<span class="line-modified">!     auto* frame = this-&gt;frame();</span>
      if (!frame)
          return 0;
  
      Page* page = frame-&gt;page();
      if (!page)
<span class="line-new-header">--- 1276,27 ---</span>
  {
      if (!frame())
          return 0;
  
      // Force enough layout in the parent document to ensure that the FrameView has been resized.
<span class="line-modified">!     if (auto ownerElement = makeRefPtr(frameElement()))</span>
<span class="line-modified">!         ownerElement-&gt;document().updateLayoutIfDimensionsOutOfDate(*ownerElement, WidthDimensionsCheck);</span>
  
<span class="line-modified">!     auto frame = makeRefPtr(this-&gt;frame());</span>
      if (!frame)
          return 0;
  
<span class="line-modified">!     auto view = makeRefPtr(frame-&gt;view());</span>
      if (!view)
          return 0;
  
      return view-&gt;mapFromLayoutToCSSUnits(static_cast&lt;int&gt;(view-&gt;unobscuredContentRectIncludingScrollbars().width()));
  }
  
  int DOMWindow::screenX() const
  {
<span class="line-modified">!     auto frame = makeRefPtr(this-&gt;frame());</span>
      if (!frame)
          return 0;
  
      Page* page = frame-&gt;page();
      if (!page)
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1288,11 ***</span>
      return static_cast&lt;int&gt;(page-&gt;chrome().windowRect().x());
  }
  
  int DOMWindow::screenY() const
  {
<span class="line-modified">!     auto* frame = this-&gt;frame();</span>
      if (!frame)
          return 0;
  
      Page* page = frame-&gt;page();
      if (!page)
<span class="line-new-header">--- 1305,11 ---</span>
      return static_cast&lt;int&gt;(page-&gt;chrome().windowRect().x());
  }
  
  int DOMWindow::screenY() const
  {
<span class="line-modified">!     auto frame = makeRefPtr(this-&gt;frame());</span>
      if (!frame)
          return 0;
  
      Page* page = frame-&gt;page();
      if (!page)
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1301,67 ***</span>
      return static_cast&lt;int&gt;(page-&gt;chrome().windowRect().y());
  }
  
  int DOMWindow::scrollX() const
  {
<span class="line-modified">!     auto* frame = this-&gt;frame();</span>
      if (!frame)
          return 0;
  
<span class="line-modified">!     FrameView* view = frame-&gt;view();</span>
      if (!view)
          return 0;
  
      int scrollX = view-&gt;contentsScrollPosition().x();
      if (!scrollX)
          return 0;
  
      frame-&gt;document()-&gt;updateLayoutIgnorePendingStylesheets();
  
      // Layout may have affected the current frame:
<span class="line-modified">!     auto* frameAfterLayout = this-&gt;frame();</span>
      if (!frameAfterLayout)
          return 0;
  
<span class="line-modified">!     FrameView* viewAfterLayout = frameAfterLayout-&gt;view();</span>
      if (!viewAfterLayout)
          return 0;
  
      return viewAfterLayout-&gt;mapFromLayoutToCSSUnits(viewAfterLayout-&gt;contentsScrollPosition().x());
  }
  
  int DOMWindow::scrollY() const
  {
<span class="line-modified">!     auto* frame = this-&gt;frame();</span>
      if (!frame)
          return 0;
  
<span class="line-modified">!     FrameView* view = frame-&gt;view();</span>
      if (!view)
          return 0;
  
      int scrollY = view-&gt;contentsScrollPosition().y();
      if (!scrollY)
          return 0;
  
      frame-&gt;document()-&gt;updateLayoutIgnorePendingStylesheets();
  
      // Layout may have affected the current frame:
<span class="line-modified">!     auto* frameAfterLayout = this-&gt;frame();</span>
      if (!frameAfterLayout)
          return 0;
  
<span class="line-modified">!     FrameView* viewAfterLayout = frameAfterLayout-&gt;view();</span>
      if (!viewAfterLayout)
          return 0;
  
      return viewAfterLayout-&gt;mapFromLayoutToCSSUnits(viewAfterLayout-&gt;contentsScrollPosition().y());
  }
  
  bool DOMWindow::closed() const
  {
<span class="line-modified">!     return !frame();</span>
  }
  
  unsigned DOMWindow::length() const
  {
      if (!isCurrentlyDisplayedInFrame())
<span class="line-new-header">--- 1318,72 ---</span>
      return static_cast&lt;int&gt;(page-&gt;chrome().windowRect().y());
  }
  
  int DOMWindow::scrollX() const
  {
<span class="line-modified">!     auto frame = makeRefPtr(this-&gt;frame());</span>
      if (!frame)
          return 0;
  
<span class="line-modified">!     auto view = makeRefPtr(frame-&gt;view());</span>
      if (!view)
          return 0;
  
      int scrollX = view-&gt;contentsScrollPosition().x();
      if (!scrollX)
          return 0;
  
      frame-&gt;document()-&gt;updateLayoutIgnorePendingStylesheets();
  
      // Layout may have affected the current frame:
<span class="line-modified">!     auto frameAfterLayout = makeRefPtr(this-&gt;frame());</span>
      if (!frameAfterLayout)
          return 0;
  
<span class="line-modified">!     auto viewAfterLayout = makeRefPtr(frameAfterLayout-&gt;view());</span>
      if (!viewAfterLayout)
          return 0;
  
      return viewAfterLayout-&gt;mapFromLayoutToCSSUnits(viewAfterLayout-&gt;contentsScrollPosition().x());
  }
  
  int DOMWindow::scrollY() const
  {
<span class="line-modified">!     auto frame = makeRefPtr(this-&gt;frame());</span>
      if (!frame)
          return 0;
  
<span class="line-modified">!     auto view = makeRefPtr(frame-&gt;view());</span>
      if (!view)
          return 0;
  
      int scrollY = view-&gt;contentsScrollPosition().y();
      if (!scrollY)
          return 0;
  
      frame-&gt;document()-&gt;updateLayoutIgnorePendingStylesheets();
  
      // Layout may have affected the current frame:
<span class="line-modified">!     auto frameAfterLayout = makeRefPtr(this-&gt;frame());</span>
      if (!frameAfterLayout)
          return 0;
  
<span class="line-modified">!     auto viewAfterLayout = makeRefPtr(frameAfterLayout-&gt;view());</span>
      if (!viewAfterLayout)
          return 0;
  
      return viewAfterLayout-&gt;mapFromLayoutToCSSUnits(viewAfterLayout-&gt;contentsScrollPosition().y());
  }
  
  bool DOMWindow::closed() const
  {
<span class="line-modified">!     auto* frame = this-&gt;frame();</span>
<span class="line-added">+     if (!frame)</span>
<span class="line-added">+         return true;</span>
<span class="line-added">+ </span>
<span class="line-added">+     auto* page = frame-&gt;page();</span>
<span class="line-added">+     return !page || page-&gt;isClosing();</span>
  }
  
  unsigned DOMWindow::length() const
  {
      if (!isCurrentlyDisplayedInFrame())
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1418,19 ***</span>
  
      ASSERT(frame-&gt;document()); // Client calls shouldn&#39;t be made when the frame is in inconsistent state.
      page-&gt;chrome().setStatusbarText(*frame, m_defaultStatus);
  }
  
<span class="line-removed">- WindowProxy* DOMWindow::self() const</span>
<span class="line-removed">- {</span>
<span class="line-removed">-     auto* frame = this-&gt;frame();</span>
<span class="line-removed">-     if (!frame)</span>
<span class="line-removed">-         return nullptr;</span>
<span class="line-removed">- </span>
<span class="line-removed">-     return &amp;frame-&gt;windowProxy();</span>
<span class="line-removed">- }</span>
<span class="line-removed">- </span>
  WindowProxy* DOMWindow::opener() const
  {
      auto* frame = this-&gt;frame();
      if (!frame)
          return nullptr;
<span class="line-new-header">--- 1440,10 ---</span>
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1500,11 ***</span>
  {
      if (!isCurrentlyDisplayedInFrame())
          return nullptr;
  
      unsigned colonStart = pseudoElement[0] == &#39;:&#39; ? (pseudoElement[1] == &#39;:&#39; ? 2 : 1) : 0;
<span class="line-modified">!     CSSSelector::PseudoElementType pseudoType = CSSSelector::parsePseudoElementType(pseudoElement.substringSharingImpl(colonStart));</span>
      if (pseudoType == CSSSelector::PseudoElementUnknown &amp;&amp; !pseudoElement.isEmpty())
          return nullptr;
  
      auto* frame = this-&gt;frame();
      frame-&gt;document()-&gt;styleScope().flushPendingUpdate();
<span class="line-new-header">--- 1513,11 ---</span>
  {
      if (!isCurrentlyDisplayedInFrame())
          return nullptr;
  
      unsigned colonStart = pseudoElement[0] == &#39;:&#39; ? (pseudoElement[1] == &#39;:&#39; ? 2 : 1) : 0;
<span class="line-modified">!     auto pseudoType = CSSSelector::parsePseudoElementType(StringView { pseudoElement }.substring(colonStart));</span>
      if (pseudoType == CSSSelector::PseudoElementUnknown &amp;&amp; !pseudoElement.isEmpty())
          return nullptr;
  
      auto* frame = this-&gt;frame();
      frame-&gt;document()-&gt;styleScope().flushPendingUpdate();
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1529,11 ***</span>
      }
  
      if (ruleList-&gt;rules().isEmpty())
          return nullptr;
  
<span class="line-modified">!     return WTFMove(ruleList);</span>
  }
  
  RefPtr&lt;WebKitPoint&gt; DOMWindow::webkitConvertPointFromNodeToPage(Node* node, const WebKitPoint* p) const
  {
      if (!node || !p)
<span class="line-new-header">--- 1542,11 ---</span>
      }
  
      if (ruleList-&gt;rules().isEmpty())
          return nullptr;
  
<span class="line-modified">!     return ruleList;</span>
  }
  
  RefPtr&lt;WebKitPoint&gt; DOMWindow::webkitConvertPointFromNodeToPage(Node* node, const WebKitPoint* p) const
  {
      if (!node || !p)
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1708,27 ***</span>
      return DOMTimer::install(*context, WTFMove(action), Seconds::fromMilliseconds(timeout), true);
  }
  
  void DOMWindow::clearTimeout(int timeoutId)
  {
<span class="line-removed">- #if PLATFORM(IOS_FAMILY)</span>
<span class="line-removed">-     if (auto* frame = this-&gt;frame()) {</span>
<span class="line-removed">-         Document* document = frame-&gt;document();</span>
<span class="line-removed">-         if (timeoutId &gt; 0 &amp;&amp; document) {</span>
<span class="line-removed">-             DOMTimer* timer = document-&gt;findTimeout(timeoutId);</span>
<span class="line-removed">-             if (timer &amp;&amp; WebThreadContainsObservedDOMTimer(timer)) {</span>
<span class="line-removed">-                 LOG_WITH_STREAM(ContentObservation, stream &lt;&lt; &quot;DOMWindow::clearTimeout: remove registered timer (&quot; &lt;&lt; timer &lt;&lt; &quot;)&quot;);</span>
<span class="line-removed">-                 WebThreadRemoveObservedDOMTimer(timer);</span>
<span class="line-removed">- </span>
<span class="line-removed">-                 if (!WebThreadCountOfObservedDOMTimers()) {</span>
<span class="line-removed">-                     if (Page* page = frame-&gt;page())</span>
<span class="line-removed">-                         page-&gt;chrome().client().observedContentChange(*frame);</span>
<span class="line-removed">-                 }</span>
<span class="line-removed">-             }</span>
<span class="line-removed">-         }</span>
<span class="line-removed">-     }</span>
<span class="line-removed">- #endif</span>
      ScriptExecutionContext* context = scriptExecutionContext();
      if (!context)
          return;
      DOMTimer::removeById(*context, timeoutId);
  }
<span class="line-new-header">--- 1721,10 ---</span>
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1758,24 ***</span>
      DOMTimer::removeById(*context, timeoutId);
  }
  
  int DOMWindow::requestAnimationFrame(Ref&lt;RequestAnimationFrameCallback&gt;&amp;&amp; callback)
  {
<span class="line-removed">-     callback-&gt;m_useLegacyTimeBase = false;</span>
      auto* document = this-&gt;document();
      if (!document)
          return 0;
      return document-&gt;requestAnimationFrame(WTFMove(callback));
  }
  
  int DOMWindow::webkitRequestAnimationFrame(Ref&lt;RequestAnimationFrameCallback&gt;&amp;&amp; callback)
  {
<span class="line-modified">!     callback-&gt;m_useLegacyTimeBase = true;</span>
<span class="line-modified">!     auto* document = this-&gt;document();</span>
<span class="line-modified">!     if (!document)</span>
<span class="line-modified">!         return 0;</span>
<span class="line-modified">!     return document-&gt;requestAnimationFrame(WTFMove(callback));</span>
  }
  
  void DOMWindow::cancelAnimationFrame(int id)
  {
      auto* document = this-&gt;document();
<span class="line-new-header">--- 1754,24 ---</span>
      DOMTimer::removeById(*context, timeoutId);
  }
  
  int DOMWindow::requestAnimationFrame(Ref&lt;RequestAnimationFrameCallback&gt;&amp;&amp; callback)
  {
      auto* document = this-&gt;document();
      if (!document)
          return 0;
      return document-&gt;requestAnimationFrame(WTFMove(callback));
  }
  
  int DOMWindow::webkitRequestAnimationFrame(Ref&lt;RequestAnimationFrameCallback&gt;&amp;&amp; callback)
  {
<span class="line-modified">!     static bool firstTime = true;</span>
<span class="line-modified">!     if (firstTime &amp;&amp; document()) {</span>
<span class="line-modified">!         document()-&gt;addConsoleMessage(MessageSource::JS, MessageLevel::Warning, &quot;webkitRequestAnimationFrame() is deprecated and will be removed. Please use requestAnimationFrame() instead.&quot;_s);</span>
<span class="line-modified">!         firstTime = false;</span>
<span class="line-modified">!     }</span>
<span class="line-added">+     return requestAnimationFrame(WTFMove(callback));</span>
  }
  
  void DOMWindow::cancelAnimationFrame(int id)
  {
      auto* document = this-&gt;document();
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1837,20 ***</span>
          return true;
  
      return false;
  }
  
<span class="line-modified">! bool DOMWindow::addEventListener(const AtomicString&amp; eventType, Ref&lt;EventListener&gt;&amp;&amp; listener, const AddEventListenerOptions&amp; options)</span>
  {
      if (!EventTarget::addEventListener(eventType, WTFMove(listener), options))
          return false;
  
<span class="line-modified">!     if (Document* document = this-&gt;document()) {</span>
          document-&gt;addListenerTypeIfNeeded(eventType);
          if (eventNames().isWheelEventType(eventType))
              document-&gt;didAddWheelEventHandler(*document);
<span class="line-modified">!         else if (eventNames().isTouchEventType(eventType))</span>
              document-&gt;didAddTouchEventHandler(*document);
          else if (eventType == eventNames().storageEvent)
              didAddStorageEventListener(*this);
      }
  
<span class="line-new-header">--- 1833,21 ---</span>
          return true;
  
      return false;
  }
  
<span class="line-modified">! bool DOMWindow::addEventListener(const AtomString&amp; eventType, Ref&lt;EventListener&gt;&amp;&amp; listener, const AddEventListenerOptions&amp; options)</span>
  {
      if (!EventTarget::addEventListener(eventType, WTFMove(listener), options))
          return false;
  
<span class="line-modified">!     auto* document = this-&gt;document();</span>
<span class="line-added">+     if (document) {</span>
          document-&gt;addListenerTypeIfNeeded(eventType);
          if (eventNames().isWheelEventType(eventType))
              document-&gt;didAddWheelEventHandler(*document);
<span class="line-modified">!         else if (eventNames().isTouchRelatedEventType(*document, eventType))</span>
              document-&gt;didAddTouchEventHandler(*document);
          else if (eventType == eventNames().storageEvent)
              didAddStorageEventListener(*this);
      }
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1861,63 ***</span>
  #if PLATFORM(IOS_FAMILY)
      else if (eventType == eventNames().scrollEvent)
          incrementScrollEventListenersCount();
  #endif
  #if ENABLE(IOS_TOUCH_EVENTS)
<span class="line-modified">!     else if (eventNames().isTouchEventType(eventType))</span>
          ++m_touchAndGestureEventListenerCount;
  #endif
  #if ENABLE(IOS_GESTURE_EVENTS)
      else if (eventNames().isGestureEventType(eventType))
          ++m_touchAndGestureEventListenerCount;
  #endif
  #if ENABLE(GAMEPAD)
      else if (eventNames().isGamepadEventType(eventType))
          incrementGamepadEventListenerCount();
  #endif
  
  #if ENABLE(DEVICE_ORIENTATION)
<span class="line-modified">!     if (frame() &amp;&amp; frame()-&gt;settings().deviceOrientationEventEnabled() &amp;&amp; document() &amp;&amp; document()-&gt;loader() &amp;&amp; document()-&gt;loader()-&gt;deviceOrientationEventEnabled()) {</span>
  #if PLATFORM(IOS_FAMILY)
<span class="line-modified">!         if ((eventType == eventNames().devicemotionEvent || eventType == eventNames().deviceorientationEvent)) {</span>
<span class="line-removed">-             if (isSameSecurityOriginAsMainFrame() &amp;&amp; isSecureContext()) {</span>
<span class="line-removed">-                 if (eventType == eventNames().deviceorientationEvent)</span>
<span class="line-removed">-                     document()-&gt;deviceOrientationController().addDeviceEventListener(*this);</span>
<span class="line-removed">-                 else</span>
<span class="line-removed">-                     document()-&gt;deviceMotionController().addDeviceEventListener(*this);</span>
<span class="line-removed">-             } else if (document()) {</span>
<span class="line-removed">-                 if (isSecureContext())</span>
<span class="line-removed">-                     document()-&gt;addConsoleMessage(MessageSource::JS, MessageLevel::Warning, &quot;Blocked attempt to add a device motion or orientation listener from child frame that wasn&#39;t the same security origin as the main page.&quot;_s);</span>
<span class="line-removed">-                 else</span>
<span class="line-removed">-                     document()-&gt;addConsoleMessage(MessageSource::JS, MessageLevel::Warning, &quot;Blocked attempt to add a device motion or orientation listener because the browsing context is not secure.&quot;_s);</span>
<span class="line-removed">-             }</span>
<span class="line-removed">-         }</span>
  #else
<span class="line-modified">!         if (eventType == eventNames().devicemotionEvent) {</span>
<span class="line-modified">!             if (isSameSecurityOriginAsMainFrame() &amp;&amp; isSecureContext()) {</span>
<span class="line-modified">!                 if (DeviceMotionController* controller = DeviceMotionController::from(page()))</span>
<span class="line-modified">!                     controller-&gt;addDeviceEventListener(*this);</span>
<span class="line-modified">!             } else</span>
<span class="line-modified">!                 document()-&gt;addConsoleMessage(MessageSource::JS, MessageLevel::Warning, &quot;Blocked attempt to add a device motion listener from child frame that wasn&#39;t the same security origin as the main page.&quot;_s);</span>
<span class="line-modified">!         } else if (eventType == eventNames().deviceorientationEvent) {</span>
<span class="line-modified">!             if (isSameSecurityOriginAsMainFrame() &amp;&amp; isSecureContext()) {</span>
<span class="line-modified">!                 if (DeviceOrientationController* controller = DeviceOrientationController::from(page()))</span>
<span class="line-modified">!                     controller-&gt;addDeviceEventListener(*this);</span>
<span class="line-modified">!             } else {</span>
<span class="line-modified">!                 if (isSecureContext())</span>
<span class="line-modified">!                     document()-&gt;addConsoleMessage(MessageSource::JS, MessageLevel::Warning, &quot;Blocked attempt to add a device orientation listener from child frame that wasn&#39;t the same security origin as the main page.&quot;_s);</span>
<span class="line-modified">!                 else</span>
<span class="line-modified">!                     document()-&gt;addConsoleMessage(MessageSource::JS, MessageLevel::Warning, &quot;Blocked attempt to add a device motion or orientation listener because the browsing context is not secure.&quot;_s);</span>
<span class="line-modified">!             }</span>
          }
<span class="line-removed">- #endif // PLATFORM(IOS_FAMILY)</span>
      }
<span class="line-removed">- #endif // ENABLE(DEVICE_ORIENTATION)</span>
  
      return true;
  }
  
  #if PLATFORM(IOS_FAMILY)
  
  void DOMWindow::incrementScrollEventListenersCount()
  {
      Document* document = this-&gt;document();
<span class="line-new-header">--- 1858,173 ---</span>
  #if PLATFORM(IOS_FAMILY)
      else if (eventType == eventNames().scrollEvent)
          incrementScrollEventListenersCount();
  #endif
  #if ENABLE(IOS_TOUCH_EVENTS)
<span class="line-modified">!     else if (document &amp;&amp; eventNames().isTouchRelatedEventType(*document, eventType))</span>
          ++m_touchAndGestureEventListenerCount;
  #endif
  #if ENABLE(IOS_GESTURE_EVENTS)
      else if (eventNames().isGestureEventType(eventType))
          ++m_touchAndGestureEventListenerCount;
  #endif
  #if ENABLE(GAMEPAD)
      else if (eventNames().isGamepadEventType(eventType))
          incrementGamepadEventListenerCount();
  #endif
<span class="line-added">+ #if ENABLE(DEVICE_ORIENTATION)</span>
<span class="line-added">+     else if (eventType == eventNames().deviceorientationEvent)</span>
<span class="line-added">+         startListeningForDeviceOrientationIfNecessary();</span>
<span class="line-added">+     else if (eventType == eventNames().devicemotionEvent)</span>
<span class="line-added">+         startListeningForDeviceMotionIfNecessary();</span>
<span class="line-added">+ #endif</span>
<span class="line-added">+ </span>
<span class="line-added">+     return true;</span>
<span class="line-added">+ }</span>
  
  #if ENABLE(DEVICE_ORIENTATION)
<span class="line-modified">! </span>
<span class="line-added">+ DeviceOrientationController* DOMWindow::deviceOrientationController() const</span>
<span class="line-added">+ {</span>
  #if PLATFORM(IOS_FAMILY)
<span class="line-modified">!     return document() ? &amp;document()-&gt;deviceOrientationController() : nullptr;</span>
  #else
<span class="line-modified">!     return DeviceOrientationController::from(page());</span>
<span class="line-modified">! #endif</span>
<span class="line-modified">! }</span>
<span class="line-modified">! </span>
<span class="line-modified">! DeviceMotionController* DOMWindow::deviceMotionController() const</span>
<span class="line-modified">! {</span>
<span class="line-modified">! #if PLATFORM(IOS_FAMILY)</span>
<span class="line-modified">!     return document() ? &amp;document()-&gt;deviceMotionController() : nullptr;</span>
<span class="line-modified">! #else</span>
<span class="line-modified">!     return DeviceMotionController::from(page());</span>
<span class="line-modified">! #endif</span>
<span class="line-modified">! }</span>
<span class="line-modified">! </span>
<span class="line-modified">! bool DOMWindow::isAllowedToUseDeviceMotionOrientation(String&amp; message) const</span>
<span class="line-modified">! {</span>
<span class="line-modified">!     if (!frame() || !frame()-&gt;settings().deviceOrientationEventEnabled()) {</span>
<span class="line-added">+         message = &quot;API is disabled&quot;_s;</span>
<span class="line-added">+         return false;</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     if (!isSecureContext()) {</span>
<span class="line-added">+         message = &quot;Browsing context is not secure&quot;_s;</span>
<span class="line-added">+         return false;</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     if (!isSameSecurityOriginAsMainFrame()) {</span>
<span class="line-added">+         message = &quot;Source frame did not have the same security origin as the main page&quot;_s;</span>
<span class="line-added">+         return false;</span>
<span class="line-added">+     }</span>
<span class="line-added">+     return true;</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
<span class="line-added">+ bool DOMWindow::isAllowedToAddDeviceMotionOrientationListener(String&amp; message) const</span>
<span class="line-added">+ {</span>
<span class="line-added">+     String innerMessage;</span>
<span class="line-added">+     if (!isAllowedToUseDeviceMotionOrientation(innerMessage)) {</span>
<span class="line-added">+         message = makeString(&quot;Blocked attempt to add a device motion or orientation event listener, reason: &quot;, innerMessage, &quot;.&quot;);</span>
<span class="line-added">+         return false;</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     if (frame()-&gt;settings().deviceOrientationPermissionAPIEnabled()) {</span>
<span class="line-added">+         auto accessState = document()-&gt;deviceOrientationAndMotionAccessController().accessState();</span>
<span class="line-added">+         switch (accessState) {</span>
<span class="line-added">+         case DeviceOrientationOrMotionPermissionState::Denied:</span>
<span class="line-added">+             message = &quot;No device motion or orientation events will be fired because permission to use the API was denied.&quot;_s;</span>
<span class="line-added">+             return false;</span>
<span class="line-added">+         case DeviceOrientationOrMotionPermissionState::Prompt:</span>
<span class="line-added">+             message = &quot;No device motion or orientation events will be fired until permission has been requested and granted.&quot;_s;</span>
<span class="line-added">+             return false;</span>
<span class="line-added">+         case DeviceOrientationOrMotionPermissionState::Granted:</span>
<span class="line-added">+             break;</span>
          }
      }
  
      return true;
  }
  
<span class="line-added">+ void DOMWindow::startListeningForDeviceOrientationIfNecessary()</span>
<span class="line-added">+ {</span>
<span class="line-added">+     if (!hasEventListeners(eventNames().deviceorientationEvent))</span>
<span class="line-added">+         return;</span>
<span class="line-added">+ </span>
<span class="line-added">+     auto* deviceController = deviceOrientationController();</span>
<span class="line-added">+     if (!deviceController || deviceController-&gt;hasDeviceEventListener(*this))</span>
<span class="line-added">+         return;</span>
<span class="line-added">+ </span>
<span class="line-added">+     String errorMessage;</span>
<span class="line-added">+     if (!isAllowedToAddDeviceMotionOrientationListener(errorMessage)) {</span>
<span class="line-added">+         if (auto* document = this-&gt;document())</span>
<span class="line-added">+             document-&gt;addConsoleMessage(MessageSource::JS, MessageLevel::Warning, errorMessage);</span>
<span class="line-added">+         return;</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     deviceController-&gt;addDeviceEventListener(*this);</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
<span class="line-added">+ void DOMWindow::stopListeningForDeviceOrientationIfNecessary()</span>
<span class="line-added">+ {</span>
<span class="line-added">+     if (hasEventListeners(eventNames().deviceorientationEvent))</span>
<span class="line-added">+         return;</span>
<span class="line-added">+ </span>
<span class="line-added">+     if (auto* deviceController = deviceOrientationController())</span>
<span class="line-added">+         deviceController-&gt;removeDeviceEventListener(*this);</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
<span class="line-added">+ void DOMWindow::startListeningForDeviceMotionIfNecessary()</span>
<span class="line-added">+ {</span>
<span class="line-added">+     if (!hasEventListeners(eventNames().devicemotionEvent))</span>
<span class="line-added">+         return;</span>
<span class="line-added">+ </span>
<span class="line-added">+     auto* deviceController = deviceMotionController();</span>
<span class="line-added">+     if (!deviceController || deviceController-&gt;hasDeviceEventListener(*this))</span>
<span class="line-added">+         return;</span>
<span class="line-added">+ </span>
<span class="line-added">+     String errorMessage;</span>
<span class="line-added">+     if (!isAllowedToAddDeviceMotionOrientationListener(errorMessage)) {</span>
<span class="line-added">+         failedToRegisterDeviceMotionEventListener();</span>
<span class="line-added">+         if (auto* document = this-&gt;document())</span>
<span class="line-added">+             document-&gt;addConsoleMessage(MessageSource::JS, MessageLevel::Warning, errorMessage);</span>
<span class="line-added">+         return;</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     deviceController-&gt;addDeviceEventListener(*this);</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
<span class="line-added">+ void DOMWindow::stopListeningForDeviceMotionIfNecessary()</span>
<span class="line-added">+ {</span>
<span class="line-added">+     if (hasEventListeners(eventNames().devicemotionEvent))</span>
<span class="line-added">+         return;</span>
<span class="line-added">+ </span>
<span class="line-added">+     if (auto* deviceController = deviceMotionController())</span>
<span class="line-added">+         deviceController-&gt;removeDeviceEventListener(*this);</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
<span class="line-added">+ void DOMWindow::failedToRegisterDeviceMotionEventListener()</span>
<span class="line-added">+ {</span>
<span class="line-added">+ #if PLATFORM(IOS_FAMILY)</span>
<span class="line-added">+     if (!isSameSecurityOriginAsMainFrame() || !isSecureContext())</span>
<span class="line-added">+         return;</span>
<span class="line-added">+ </span>
<span class="line-added">+     // FIXME: This is a quirk for chase.com on iPad (&lt;rdar://problem/48423023&gt;).</span>
<span class="line-added">+     if (RegistrableDomain::uncheckedCreateFromRegistrableDomainString(&quot;chase.com&quot;_s).matches(document()-&gt;url())) {</span>
<span class="line-added">+         // Fire a fake DeviceMotionEvent with acceleration data to unblock the site&#39;s login flow.</span>
<span class="line-added">+         document()-&gt;postTask([](auto&amp; context) {</span>
<span class="line-added">+             if (auto* window = downcast&lt;Document&gt;(context).domWindow()) {</span>
<span class="line-added">+                 auto acceleration = DeviceMotionData::Acceleration::create();</span>
<span class="line-added">+                 window-&gt;dispatchEvent(DeviceMotionEvent::create(eventNames().devicemotionEvent, DeviceMotionData::create(acceleration.copyRef(), acceleration.copyRef(), DeviceMotionData::RotationRate::create(), WTF::nullopt).ptr()));</span>
<span class="line-added">+             }</span>
<span class="line-added">+         });</span>
<span class="line-added">+     }</span>
<span class="line-added">+ #endif // PLATFORM(IOS_FAMILY)</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
<span class="line-added">+ #endif // ENABLE(DEVICE_ORIENTATION)</span>
<span class="line-added">+ </span>
  #if PLATFORM(IOS_FAMILY)
  
  void DOMWindow::incrementScrollEventListenersCount()
  {
      Document* document = this-&gt;document();
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1943,52 ***</span>
  void DOMWindow::resetAllGeolocationPermission()
  {
      // FIXME: Can we remove the PLATFORM(IOS_FAMILY)-guard?
  #if ENABLE(GEOLOCATION) &amp;&amp; PLATFORM(IOS_FAMILY)
      if (m_navigator)
<span class="line-modified">!         NavigatorGeolocation::from(m_navigator.get())-&gt;resetAllGeolocationPermission();</span>
  #endif
  }
  
<span class="line-modified">! bool DOMWindow::removeEventListener(const AtomicString&amp; eventType, EventListener&amp; listener, const ListenerOptions&amp; options)</span>
  {
      if (!EventTarget::removeEventListener(eventType, listener, options.capture))
          return false;
  
<span class="line-modified">!     if (Document* document = this-&gt;document()) {</span>
          if (eventNames().isWheelEventType(eventType))
              document-&gt;didRemoveWheelEventHandler(*document);
<span class="line-modified">!         else if (eventNames().isTouchEventType(eventType))</span>
              document-&gt;didRemoveTouchEventHandler(*document);
      }
  
      if (eventType == eventNames().unloadEvent)
          removeUnloadEventListener(this);
      else if (eventType == eventNames().beforeunloadEvent &amp;&amp; allowsBeforeUnloadListeners(this))
          removeBeforeUnloadEventListener(this);
<span class="line-removed">- #if ENABLE(DEVICE_ORIENTATION)</span>
<span class="line-removed">- #if PLATFORM(IOS_FAMILY)</span>
<span class="line-removed">-     else if (eventType == eventNames().devicemotionEvent &amp;&amp; document())</span>
<span class="line-removed">-         document()-&gt;deviceMotionController().removeDeviceEventListener(*this);</span>
<span class="line-removed">-     else if (eventType == eventNames().deviceorientationEvent &amp;&amp; document())</span>
<span class="line-removed">-         document()-&gt;deviceOrientationController().removeDeviceEventListener(*this);</span>
<span class="line-removed">- #else</span>
<span class="line-removed">-     else if (eventType == eventNames().devicemotionEvent) {</span>
<span class="line-removed">-         if (DeviceMotionController* controller = DeviceMotionController::from(page()))</span>
<span class="line-removed">-             controller-&gt;removeDeviceEventListener(*this);</span>
<span class="line-removed">-     } else if (eventType == eventNames().deviceorientationEvent) {</span>
<span class="line-removed">-         if (DeviceOrientationController* controller = DeviceOrientationController::from(page()))</span>
<span class="line-removed">-             controller-&gt;removeDeviceEventListener(*this);</span>
<span class="line-removed">-     }</span>
<span class="line-removed">- #endif // PLATFORM(IOS_FAMILY)</span>
<span class="line-removed">- #endif // ENABLE(DEVICE_ORIENTATION)</span>
  #if PLATFORM(IOS_FAMILY)
      else if (eventType == eventNames().scrollEvent)
          decrementScrollEventListenersCount();
  #endif
  #if ENABLE(IOS_TOUCH_EVENTS)
<span class="line-modified">!     else if (eventNames().isTouchEventType(eventType)) {</span>
          ASSERT(m_touchAndGestureEventListenerCount &gt; 0);
          --m_touchAndGestureEventListenerCount;
      }
  #endif
  #if ENABLE(IOS_GESTURE_EVENTS)
<span class="line-new-header">--- 2050,37 ---</span>
  void DOMWindow::resetAllGeolocationPermission()
  {
      // FIXME: Can we remove the PLATFORM(IOS_FAMILY)-guard?
  #if ENABLE(GEOLOCATION) &amp;&amp; PLATFORM(IOS_FAMILY)
      if (m_navigator)
<span class="line-modified">!         NavigatorGeolocation::from(*m_navigator)-&gt;resetAllGeolocationPermission();</span>
  #endif
  }
  
<span class="line-modified">! bool DOMWindow::removeEventListener(const AtomString&amp; eventType, EventListener&amp; listener, const ListenerOptions&amp; options)</span>
  {
      if (!EventTarget::removeEventListener(eventType, listener, options.capture))
          return false;
  
<span class="line-modified">!     auto* document = this-&gt;document();</span>
<span class="line-added">+     if (document) {</span>
          if (eventNames().isWheelEventType(eventType))
              document-&gt;didRemoveWheelEventHandler(*document);
<span class="line-modified">!         else if (eventNames().isTouchRelatedEventType(*document, eventType))</span>
              document-&gt;didRemoveTouchEventHandler(*document);
      }
  
      if (eventType == eventNames().unloadEvent)
          removeUnloadEventListener(this);
      else if (eventType == eventNames().beforeunloadEvent &amp;&amp; allowsBeforeUnloadListeners(this))
          removeBeforeUnloadEventListener(this);
  #if PLATFORM(IOS_FAMILY)
      else if (eventType == eventNames().scrollEvent)
          decrementScrollEventListenersCount();
  #endif
  #if ENABLE(IOS_TOUCH_EVENTS)
<span class="line-modified">!     else if (document &amp;&amp; eventNames().isTouchRelatedEventType(*document, eventType)) {</span>
          ASSERT(m_touchAndGestureEventListenerCount &gt; 0);
          --m_touchAndGestureEventListenerCount;
      }
  #endif
  #if ENABLE(IOS_GESTURE_EVENTS)
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1999,10 ***</span>
<span class="line-new-header">--- 2091,16 ---</span>
  #endif
  #if ENABLE(GAMEPAD)
      else if (eventNames().isGamepadEventType(eventType))
          decrementGamepadEventListenerCount();
  #endif
<span class="line-added">+ #if ENABLE(DEVICE_ORIENTATION)</span>
<span class="line-added">+     else if (eventType == eventNames().deviceorientationEvent)</span>
<span class="line-added">+         stopListeningForDeviceOrientationIfNecessary();</span>
<span class="line-added">+     else if (eventType == eventNames().devicemotionEvent)</span>
<span class="line-added">+         stopListeningForDeviceMotionIfNecessary();</span>
<span class="line-added">+ #endif</span>
  
      return true;
  }
  
  void DOMWindow::languagesChanged()
</pre>
<hr />
<pre>
<span class="line-old-header">*** 2072,31 ***</span>
      event.resetBeforeDispatch();
      auto cookie = InspectorInstrumentation::willDispatchEventOnWindow(frame(), event, *this);
      // FIXME: We should use EventDispatcher everywhere.
      fireEventListeners(event, EventInvokePhase::Capturing);
      fireEventListeners(event, EventInvokePhase::Bubbling);
<span class="line-modified">!     InspectorInstrumentation::didDispatchEventOnWindow(cookie);</span>
      event.resetAfterDispatch();
  }
  
  void DOMWindow::removeAllEventListeners()
  {
      EventTarget::removeAllEventListeners();
  
  #if ENABLE(DEVICE_ORIENTATION)
<span class="line-modified">! #if PLATFORM(IOS_FAMILY)</span>
<span class="line-modified">!     if (Document* document = this-&gt;document()) {</span>
<span class="line-modified">!         document-&gt;deviceMotionController().removeAllDeviceEventListeners(*this);</span>
<span class="line-removed">-         document-&gt;deviceOrientationController().removeAllDeviceEventListeners(*this);</span>
<span class="line-removed">-     }</span>
<span class="line-removed">- #else</span>
<span class="line-removed">-     if (DeviceMotionController* controller = DeviceMotionController::from(page()))</span>
<span class="line-removed">-         controller-&gt;removeAllDeviceEventListeners(*this);</span>
<span class="line-removed">-     if (DeviceOrientationController* controller = DeviceOrientationController::from(page()))</span>
<span class="line-removed">-         controller-&gt;removeAllDeviceEventListeners(*this);</span>
<span class="line-removed">- #endif // PLATFORM(IOS_FAMILY)</span>
<span class="line-removed">- #endif // ENABLE(DEVICE_ORIENTATION)</span>
  
  #if PLATFORM(IOS_FAMILY)
      if (m_scrollEventListenerCount) {
          m_scrollEventListenerCount = 1;
          decrementScrollEventListenersCount();
<span class="line-new-header">--- 2170,22 ---</span>
      event.resetBeforeDispatch();
      auto cookie = InspectorInstrumentation::willDispatchEventOnWindow(frame(), event, *this);
      // FIXME: We should use EventDispatcher everywhere.
      fireEventListeners(event, EventInvokePhase::Capturing);
      fireEventListeners(event, EventInvokePhase::Bubbling);
<span class="line-modified">!     InspectorInstrumentation::didDispatchEventOnWindow(cookie, event.defaultPrevented());</span>
      event.resetAfterDispatch();
  }
  
  void DOMWindow::removeAllEventListeners()
  {
      EventTarget::removeAllEventListeners();
  
  #if ENABLE(DEVICE_ORIENTATION)
<span class="line-modified">!         stopListeningForDeviceOrientationIfNecessary();</span>
<span class="line-modified">!         stopListeningForDeviceMotionIfNecessary();</span>
<span class="line-modified">! #endif</span>
  
  #if PLATFORM(IOS_FAMILY)
      if (m_scrollEventListenerCount) {
          m_scrollEventListenerCount = 1;
          decrementScrollEventListenersCount();
</pre>
<hr />
<pre>
<span class="line-old-header">*** 2247,11 ***</span>
  
      printErrorMessage(crossDomainAccessErrorMessage(activeWindow, IncludeTargetOrigin::Yes));
      return true;
  }
  
<span class="line-modified">! ExceptionOr&lt;RefPtr&lt;Frame&gt;&gt; DOMWindow::createWindow(const String&amp; urlString, const AtomicString&amp; frameName, const WindowFeatures&amp; windowFeatures, DOMWindow&amp; activeWindow, Frame&amp; firstFrame, Frame&amp; openerFrame, const WTF::Function&lt;void(DOMWindow&amp;)&gt;&amp; prepareDialogFunction)</span>
  {
      Frame* activeFrame = activeWindow.frame();
      if (!activeFrame)
          return RefPtr&lt;Frame&gt; { nullptr };
  
<span class="line-new-header">--- 2336,11 ---</span>
  
      printErrorMessage(crossDomainAccessErrorMessage(activeWindow, IncludeTargetOrigin::Yes));
      return true;
  }
  
<span class="line-modified">! ExceptionOr&lt;RefPtr&lt;Frame&gt;&gt; DOMWindow::createWindow(const String&amp; urlString, const AtomString&amp; frameName, const WindowFeatures&amp; windowFeatures, DOMWindow&amp; activeWindow, Frame&amp; firstFrame, Frame&amp; openerFrame, const WTF::Function&lt;void(DOMWindow&amp;)&gt;&amp; prepareDialogFunction)</span>
  {
      Frame* activeFrame = activeWindow.frame();
      if (!activeFrame)
          return RefPtr&lt;Frame&gt; { nullptr };
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 2262,11 ***</span>
      URL completedURL = urlString.isEmpty() ? URL({ }, emptyString()) : firstFrame.document()-&gt;completeURL(urlString);
      if (!completedURL.isEmpty() &amp;&amp; !completedURL.isValid())
          return Exception { SyntaxError };
  
      // For whatever reason, Firefox uses the first frame to determine the outgoingReferrer. We replicate that behavior here.
<span class="line-modified">!     String referrer = SecurityPolicy::generateReferrerHeader(firstFrame.document()-&gt;referrerPolicy(), completedURL, firstFrame.loader().outgoingReferrer());</span>
      auto initiatedByMainFrame = activeFrame-&gt;isMainFrame() ? InitiatedByMainFrame::Yes : InitiatedByMainFrame::Unknown;
  
      ResourceRequest resourceRequest { completedURL, referrer };
      FrameLoader::addHTTPOriginIfNeeded(resourceRequest, firstFrame.loader().outgoingOrigin());
      FrameLoadRequest frameLoadRequest { *activeDocument, activeDocument-&gt;securityOrigin(), resourceRequest, frameName, LockHistory::No, LockBackForwardList::No, MaybeSendReferrer, AllowNavigationToInvalidURL::Yes, NewFrameOpenerPolicy::Allow, activeDocument-&gt;shouldOpenExternalURLsPolicyToPropagate(), initiatedByMainFrame };
<span class="line-new-header">--- 2351,11 ---</span>
      URL completedURL = urlString.isEmpty() ? URL({ }, emptyString()) : firstFrame.document()-&gt;completeURL(urlString);
      if (!completedURL.isEmpty() &amp;&amp; !completedURL.isValid())
          return Exception { SyntaxError };
  
      // For whatever reason, Firefox uses the first frame to determine the outgoingReferrer. We replicate that behavior here.
<span class="line-modified">!     String referrer = windowFeatures.noreferrer ? String() : SecurityPolicy::generateReferrerHeader(firstFrame.document()-&gt;referrerPolicy(), completedURL, firstFrame.loader().outgoingReferrer());</span>
      auto initiatedByMainFrame = activeFrame-&gt;isMainFrame() ? InitiatedByMainFrame::Yes : InitiatedByMainFrame::Unknown;
  
      ResourceRequest resourceRequest { completedURL, referrer };
      FrameLoader::addHTTPOriginIfNeeded(resourceRequest, firstFrame.loader().outgoingOrigin());
      FrameLoadRequest frameLoadRequest { *activeDocument, activeDocument-&gt;securityOrigin(), resourceRequest, frameName, LockHistory::No, LockBackForwardList::No, MaybeSendReferrer, AllowNavigationToInvalidURL::Yes, NewFrameOpenerPolicy::Allow, activeDocument-&gt;shouldOpenExternalURLsPolicyToPropagate(), initiatedByMainFrame };
</pre>
<hr />
<pre>
<span class="line-old-header">*** 2276,18 ***</span>
      bool created;
      auto newFrame = WebCore::createWindow(*activeFrame, openerFrame, WTFMove(frameLoadRequest), windowFeatures, created);
      if (!newFrame)
          return RefPtr&lt;Frame&gt; { nullptr };
  
<span class="line-modified">!     if (!windowFeatures.noopener)</span>
          newFrame-&gt;loader().setOpener(&amp;openerFrame);
  
      if (created)
          newFrame-&gt;page()-&gt;setOpenedByDOM();
  
      if (newFrame-&gt;document()-&gt;domWindow()-&gt;isInsecureScriptAccess(activeWindow, completedURL))
<span class="line-modified">!         return windowFeatures.noopener ? RefPtr&lt;Frame&gt; { nullptr } : newFrame;</span>
  
      if (prepareDialogFunction)
          prepareDialogFunction(*newFrame-&gt;document()-&gt;domWindow());
  
      if (created) {
<span class="line-new-header">--- 2365,19 ---</span>
      bool created;
      auto newFrame = WebCore::createWindow(*activeFrame, openerFrame, WTFMove(frameLoadRequest), windowFeatures, created);
      if (!newFrame)
          return RefPtr&lt;Frame&gt; { nullptr };
  
<span class="line-modified">!     bool noopener = windowFeatures.noopener || windowFeatures.noreferrer;</span>
<span class="line-added">+     if (!noopener)</span>
          newFrame-&gt;loader().setOpener(&amp;openerFrame);
  
      if (created)
          newFrame-&gt;page()-&gt;setOpenedByDOM();
  
      if (newFrame-&gt;document()-&gt;domWindow()-&gt;isInsecureScriptAccess(activeWindow, completedURL))
<span class="line-modified">!         return noopener ? RefPtr&lt;Frame&gt; { nullptr } : newFrame;</span>
  
      if (prepareDialogFunction)
          prepareDialogFunction(*newFrame-&gt;document()-&gt;domWindow());
  
      if (created) {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 2302,14 ***</span>
  
      // Navigating the new frame could result in it being detached from its page by a navigation policy delegate.
      if (!newFrame-&gt;page())
          return RefPtr&lt;Frame&gt; { nullptr };
  
<span class="line-modified">!     return windowFeatures.noopener ? RefPtr&lt;Frame&gt; { nullptr } : newFrame;</span>
  }
  
<span class="line-modified">! ExceptionOr&lt;RefPtr&lt;WindowProxy&gt;&gt; DOMWindow::open(DOMWindow&amp; activeWindow, DOMWindow&amp; firstWindow, const String&amp; urlString, const AtomicString&amp; frameName, const String&amp; windowFeaturesString)</span>
  {
      if (!isCurrentlyDisplayedInFrame())
          return RefPtr&lt;WindowProxy&gt; { nullptr };
  
      auto* activeDocument = activeWindow.document();
<span class="line-new-header">--- 2392,14 ---</span>
  
      // Navigating the new frame could result in it being detached from its page by a navigation policy delegate.
      if (!newFrame-&gt;page())
          return RefPtr&lt;Frame&gt; { nullptr };
  
<span class="line-modified">!     return noopener ? RefPtr&lt;Frame&gt; { nullptr } : newFrame;</span>
  }
  
<span class="line-modified">! ExceptionOr&lt;RefPtr&lt;WindowProxy&gt;&gt; DOMWindow::open(DOMWindow&amp; activeWindow, DOMWindow&amp; firstWindow, const String&amp; urlStringToOpen, const AtomString&amp; frameName, const String&amp; windowFeaturesString)</span>
  {
      if (!isCurrentlyDisplayedInFrame())
          return RefPtr&lt;WindowProxy&gt; { nullptr };
  
      auto* activeDocument = activeWindow.document();
</pre>
<hr />
<pre>
<span class="line-old-header">*** 2318,20 ***</span>
  
      auto* firstFrame = firstWindow.frame();
      if (!firstFrame)
          return RefPtr&lt;WindowProxy&gt; { nullptr };
  
  #if ENABLE(CONTENT_EXTENSIONS)
      if (firstFrame-&gt;document()
          &amp;&amp; firstFrame-&gt;page()
          &amp;&amp; firstFrame-&gt;mainFrame().document()
          &amp;&amp; firstFrame-&gt;mainFrame().document()-&gt;loader()) {
<span class="line-modified">!         ResourceLoadInfo resourceLoadInfo { firstFrame-&gt;document()-&gt;completeURL(urlString), firstFrame-&gt;mainFrame().document()-&gt;url(), ResourceType::Popup };</span>
<span class="line-modified">!         for (auto&amp; action : firstFrame-&gt;page()-&gt;userContentProvider().actionsForResourceLoad(resourceLoadInfo, *firstFrame-&gt;mainFrame().document()-&gt;loader()).first) {</span>
<span class="line-modified">!             if (action.type() == ContentExtensions::ActionType::BlockLoad)</span>
<span class="line-removed">-                 return RefPtr&lt;WindowProxy&gt; { nullptr };</span>
<span class="line-removed">-         }</span>
      }
  #endif
  
      auto* frame = this-&gt;frame();
      if (!firstWindow.allowPopUp()) {
<span class="line-new-header">--- 2408,22 ---</span>
  
      auto* firstFrame = firstWindow.frame();
      if (!firstFrame)
          return RefPtr&lt;WindowProxy&gt; { nullptr };
  
<span class="line-added">+     auto urlString = urlStringToOpen;</span>
<span class="line-added">+     if (activeDocument-&gt;quirks().shouldOpenAsAboutBlank(urlStringToOpen))</span>
<span class="line-added">+         urlString = &quot;about:blank&quot;_s;</span>
<span class="line-added">+ </span>
  #if ENABLE(CONTENT_EXTENSIONS)
      if (firstFrame-&gt;document()
          &amp;&amp; firstFrame-&gt;page()
          &amp;&amp; firstFrame-&gt;mainFrame().document()
          &amp;&amp; firstFrame-&gt;mainFrame().document()-&gt;loader()) {
<span class="line-modified">!         auto results = firstFrame-&gt;page()-&gt;userContentProvider().processContentRuleListsForLoad(firstFrame-&gt;document()-&gt;completeURL(urlString), ContentExtensions::ResourceType::Popup, *firstFrame-&gt;mainFrame().document()-&gt;loader());</span>
<span class="line-modified">!         if (results.summary.blockedLoad)</span>
<span class="line-modified">!             return RefPtr&lt;WindowProxy&gt; { nullptr };</span>
      }
  #endif
  
      auto* frame = this-&gt;frame();
      if (!firstWindow.allowPopUp()) {
</pre>
<center><a href="DOMTimer.h.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="DOMWindow.h.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>