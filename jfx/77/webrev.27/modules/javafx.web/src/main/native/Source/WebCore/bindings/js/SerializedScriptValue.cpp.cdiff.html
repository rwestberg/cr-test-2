<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff modules/javafx.web/src/main/native/Source/WebCore/bindings/js/SerializedScriptValue.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="ScriptWrappable.h.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="SerializedScriptValue.h.cdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/bindings/js/SerializedScriptValue.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 1,7 ***</span>
  /*
<span class="line-modified">!  * Copyright (C) 2009-2017 Apple Inc. All rights reserved.</span>
   *
   * Redistribution and use in source and binary forms, with or without
   * modification, are permitted provided that the following conditions
   * are met:
   * 1. Redistributions of source code must retain the above copyright
<span class="line-new-header">--- 1,7 ---</span>
  /*
<span class="line-modified">!  * Copyright (C) 2009-2019 Apple Inc. All rights reserved.</span>
   *
   * Redistribution and use in source and binary forms, with or without
   * modification, are permitted provided that the following conditions
   * are met:
   * 1. Redistributions of source code must retain the above copyright
</pre>
<hr />
<pre>
<span class="line-old-header">*** 56,11 ***</span>
  #include &quot;ScriptExecutionContext.h&quot;
  #include &quot;ScriptState.h&quot;
  #include &quot;SharedBuffer.h&quot;
  #include &quot;WebCoreJSClientData.h&quot;
  #include &lt;JavaScriptCore/APICast.h&gt;
<span class="line-removed">- #include &lt;JavaScriptCore/ArrayBuffer.h&gt;</span>
  #include &lt;JavaScriptCore/BooleanObject.h&gt;
  #include &lt;JavaScriptCore/CatchScope.h&gt;
  #include &lt;JavaScriptCore/DateInstance.h&gt;
  #include &lt;JavaScriptCore/Error.h&gt;
  #include &lt;JavaScriptCore/Exception.h&gt;
<span class="line-new-header">--- 56,10 ---</span>
</pre>
<hr />
<pre>
<span class="line-old-header">*** 81,11 ***</span>
<span class="line-new-header">--- 80,13 ---</span>
  #include &lt;JavaScriptCore/RegExp.h&gt;
  #include &lt;JavaScriptCore/RegExpObject.h&gt;
  #include &lt;JavaScriptCore/TypedArrayInlines.h&gt;
  #include &lt;JavaScriptCore/TypedArrays.h&gt;
  #include &lt;JavaScriptCore/WasmModule.h&gt;
<span class="line-added">+ #include &lt;JavaScriptCore/YarrFlags.h&gt;</span>
  #include &lt;limits&gt;
<span class="line-added">+ #include &lt;wtf/CompletionHandler.h&gt;</span>
  #include &lt;wtf/MainThread.h&gt;
  #include &lt;wtf/RunLoop.h&gt;
  #include &lt;wtf/Vector.h&gt;
  
  #if CPU(BIG_ENDIAN) || CPU(MIDDLE_ENDIAN) || CPU(NEEDS_ALIGNED_ACCESS)
</pre>
<hr />
<pre>
<span class="line-old-header">*** 547,17 ***</span>
  public:
      static SerializationReturnCode serialize(ExecState* exec, JSValue value, Vector&lt;RefPtr&lt;MessagePort&gt;&gt;&amp; messagePorts, Vector&lt;RefPtr&lt;JSC::ArrayBuffer&gt;&gt;&amp; arrayBuffers, const Vector&lt;RefPtr&lt;ImageBitmap&gt;&gt;&amp; imageBitmaps,
  #if ENABLE(WEBASSEMBLY)
              WasmModuleArray&amp; wasmModules,
  #endif
<span class="line-modified">!         Vector&lt;String&gt;&amp; blobURLs, const PAL::SessionID&amp; sessionID, Vector&lt;uint8_t&gt;&amp; out, SerializationContext context, ArrayBufferContentsArray&amp; sharedBuffers)</span>
      {
          CloneSerializer serializer(exec, messagePorts, arrayBuffers, imageBitmaps,
  #if ENABLE(WEBASSEMBLY)
              wasmModules,
  #endif
<span class="line-modified">!             blobURLs, sessionID, out, context, sharedBuffers);</span>
          return serializer.serialize(value);
      }
  
      static bool serialize(StringView string, Vector&lt;uint8_t&gt;&amp; out)
      {
<span class="line-new-header">--- 548,17 ---</span>
  public:
      static SerializationReturnCode serialize(ExecState* exec, JSValue value, Vector&lt;RefPtr&lt;MessagePort&gt;&gt;&amp; messagePorts, Vector&lt;RefPtr&lt;JSC::ArrayBuffer&gt;&gt;&amp; arrayBuffers, const Vector&lt;RefPtr&lt;ImageBitmap&gt;&gt;&amp; imageBitmaps,
  #if ENABLE(WEBASSEMBLY)
              WasmModuleArray&amp; wasmModules,
  #endif
<span class="line-modified">!         Vector&lt;String&gt;&amp; blobURLs, Vector&lt;uint8_t&gt;&amp; out, SerializationContext context, ArrayBufferContentsArray&amp; sharedBuffers)</span>
      {
          CloneSerializer serializer(exec, messagePorts, arrayBuffers, imageBitmaps,
  #if ENABLE(WEBASSEMBLY)
              wasmModules,
  #endif
<span class="line-modified">!             blobURLs, out, context, sharedBuffers);</span>
          return serializer.serialize(value);
      }
  
      static bool serialize(StringView string, Vector&lt;uint8_t&gt;&amp; out)
      {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 580,16 ***</span>
  
      CloneSerializer(ExecState* exec, Vector&lt;RefPtr&lt;MessagePort&gt;&gt;&amp; messagePorts, Vector&lt;RefPtr&lt;JSC::ArrayBuffer&gt;&gt;&amp; arrayBuffers, const Vector&lt;RefPtr&lt;ImageBitmap&gt;&gt;&amp; imageBitmaps,
  #if ENABLE(WEBASSEMBLY)
              WasmModuleArray&amp; wasmModules,
  #endif
<span class="line-modified">!         Vector&lt;String&gt;&amp; blobURLs, const PAL::SessionID&amp; sessionID, Vector&lt;uint8_t&gt;&amp; out, SerializationContext context, ArrayBufferContentsArray&amp; sharedBuffers)</span>
          : CloneBase(exec)
          , m_buffer(out)
          , m_blobURLs(blobURLs)
<span class="line-modified">!         , m_sessionID(sessionID)</span>
<span class="line-removed">-         , m_emptyIdentifier(Identifier::fromString(exec, emptyString()))</span>
          , m_context(context)
          , m_sharedBuffers(sharedBuffers)
  #if ENABLE(WEBASSEMBLY)
          , m_wasmModules(wasmModules)
  #endif
<span class="line-new-header">--- 581,15 ---</span>
  
      CloneSerializer(ExecState* exec, Vector&lt;RefPtr&lt;MessagePort&gt;&gt;&amp; messagePorts, Vector&lt;RefPtr&lt;JSC::ArrayBuffer&gt;&gt;&amp; arrayBuffers, const Vector&lt;RefPtr&lt;ImageBitmap&gt;&gt;&amp; imageBitmaps,
  #if ENABLE(WEBASSEMBLY)
              WasmModuleArray&amp; wasmModules,
  #endif
<span class="line-modified">!         Vector&lt;String&gt;&amp; blobURLs, Vector&lt;uint8_t&gt;&amp; out, SerializationContext context, ArrayBufferContentsArray&amp; sharedBuffers)</span>
          : CloneBase(exec)
          , m_buffer(out)
          , m_blobURLs(blobURLs)
<span class="line-modified">!         , m_emptyIdentifier(Identifier::fromString(exec-&gt;vm(), emptyString()))</span>
          , m_context(context)
          , m_sharedBuffers(sharedBuffers)
  #if ENABLE(WEBASSEMBLY)
          , m_wasmModules(wasmModules)
  #endif
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1057,22 ***</span>
  #if ENABLE(WEB_CRYPTO)
              if (auto* key = JSCryptoKey::toWrapped(vm, obj)) {
                  write(CryptoKeyTag);
                  Vector&lt;uint8_t&gt; serializedKey;
                  Vector&lt;String&gt; dummyBlobURLs;
<span class="line-removed">-                 PAL::SessionID dummySessionID;</span>
                  Vector&lt;RefPtr&lt;MessagePort&gt;&gt; dummyMessagePorts;
                  Vector&lt;RefPtr&lt;JSC::ArrayBuffer&gt;&gt; dummyArrayBuffers;
  #if ENABLE(WEBASSEMBLY)
                  WasmModuleArray dummyModules;
  #endif
                  ArrayBufferContentsArray dummySharedBuffers;
                  CloneSerializer rawKeySerializer(m_exec, dummyMessagePorts, dummyArrayBuffers, { },
  #if ENABLE(WEBASSEMBLY)
                      dummyModules,
  #endif
<span class="line-modified">!                     dummyBlobURLs, dummySessionID, serializedKey, SerializationContext::Default, dummySharedBuffers);</span>
                  rawKeySerializer.write(key);
                  Vector&lt;uint8_t&gt; wrappedKey;
                  if (!wrapCryptoKey(m_exec, serializedKey, wrappedKey))
                      return false;
                  write(wrappedKey);
<span class="line-new-header">--- 1057,21 ---</span>
  #if ENABLE(WEB_CRYPTO)
              if (auto* key = JSCryptoKey::toWrapped(vm, obj)) {
                  write(CryptoKeyTag);
                  Vector&lt;uint8_t&gt; serializedKey;
                  Vector&lt;String&gt; dummyBlobURLs;
                  Vector&lt;RefPtr&lt;MessagePort&gt;&gt; dummyMessagePorts;
                  Vector&lt;RefPtr&lt;JSC::ArrayBuffer&gt;&gt; dummyArrayBuffers;
  #if ENABLE(WEBASSEMBLY)
                  WasmModuleArray dummyModules;
  #endif
                  ArrayBufferContentsArray dummySharedBuffers;
                  CloneSerializer rawKeySerializer(m_exec, dummyMessagePorts, dummyArrayBuffers, { },
  #if ENABLE(WEBASSEMBLY)
                      dummyModules,
  #endif
<span class="line-modified">!                     dummyBlobURLs, serializedKey, SerializationContext::Default, dummySharedBuffers);</span>
                  rawKeySerializer.write(key);
                  Vector&lt;uint8_t&gt; wrappedKey;
                  if (!wrapCryptoKey(m_exec, serializedKey, wrappedKey))
                      return false;
                  write(wrappedKey);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1258,11 ***</span>
      void write(const String&amp; str)
      {
          if (str.isNull())
              write(m_emptyIdentifier);
          else
<span class="line-modified">!             write(Identifier::fromString(m_exec, str));</span>
      }
  
      void write(const Vector&lt;uint8_t&gt;&amp; vector)
      {
          uint32_t size = vector.size();
<span class="line-new-header">--- 1257,11 ---</span>
      void write(const String&amp; str)
      {
          if (str.isNull())
              write(m_emptyIdentifier);
          else
<span class="line-modified">!             write(Identifier::fromString(m_exec-&gt;vm(), str));</span>
      }
  
      void write(const Vector&lt;uint8_t&gt;&amp; vector)
      {
          uint32_t size = vector.size();
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1467,11 ***</span>
          m_buffer.append(data, length);
      }
  
      Vector&lt;uint8_t&gt;&amp; m_buffer;
      Vector&lt;String&gt;&amp; m_blobURLs;
<span class="line-removed">-     PAL::SessionID m_sessionID;</span>
      ObjectPool m_objectPool;
      ObjectPool m_transferredMessagePorts;
      ObjectPool m_transferredArrayBuffers;
      ObjectPool m_transferredImageBitmaps;
      typedef HashMap&lt;RefPtr&lt;UniquedStringImpl&gt;, uint32_t, IdentifierRepHash&gt; StringConstantPool;
<span class="line-new-header">--- 1466,10 ---</span>
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1520,11 ***</span>
                  uint32_t index = indexStack.last();
                  if (index == lengthStack.last()) {
                      indexStack.removeLast();
                      lengthStack.removeLast();
  
<span class="line-modified">!                     propertyStack.append(PropertyNameArray(&amp;vm, PropertyNameMode::Strings, PrivateSymbolMode::Exclude));</span>
                      array-&gt;methodTable(vm)-&gt;getOwnNonIndexPropertyNames(array, m_exec, propertyStack.last(), EnumerationMode());
                      if (propertyStack.last().size()) {
                          write(NonIndexPropertiesTag);
                          indexStack.append(0);
                          goto objectStartVisitMember;
<span class="line-new-header">--- 1518,11 ---</span>
                  uint32_t index = indexStack.last();
                  if (index == lengthStack.last()) {
                      indexStack.removeLast();
                      lengthStack.removeLast();
  
<span class="line-modified">!                     propertyStack.append(PropertyNameArray(vm, PropertyNameMode::Strings, PrivateSymbolMode::Exclude));</span>
                      array-&gt;methodTable(vm)-&gt;getOwnNonIndexPropertyNames(array, m_exec, propertyStack.last(), EnumerationMode());
                      if (propertyStack.last().size()) {
                          write(NonIndexPropertiesTag);
                          indexStack.append(0);
                          goto objectStartVisitMember;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1570,11 ***</span>
                  // a DataCloneError.
                  if (inObject-&gt;classInfo(vm) != JSFinalObject::info())
                      return SerializationReturnCode::DataCloneError;
                  inputObjectStack.append(inObject);
                  indexStack.append(0);
<span class="line-modified">!                 propertyStack.append(PropertyNameArray(&amp;vm, PropertyNameMode::Strings, PrivateSymbolMode::Exclude));</span>
                  inObject-&gt;methodTable(vm)-&gt;getOwnPropertyNames(inObject, m_exec, propertyStack.last(), EnumerationMode());
              }
              objectStartVisitMember:
              FALLTHROUGH;
              case ObjectStartVisitMember: {
<span class="line-new-header">--- 1568,11 ---</span>
                  // a DataCloneError.
                  if (inObject-&gt;classInfo(vm) != JSFinalObject::info())
                      return SerializationReturnCode::DataCloneError;
                  inputObjectStack.append(inObject);
                  indexStack.append(0);
<span class="line-modified">!                 propertyStack.append(PropertyNameArray(vm, PropertyNameMode::Strings, PrivateSymbolMode::Exclude));</span>
                  inObject-&gt;methodTable(vm)-&gt;getOwnPropertyNames(inObject, m_exec, propertyStack.last(), EnumerationMode());
              }
              objectStartVisitMember:
              FALLTHROUGH;
              case ObjectStartVisitMember: {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1623,11 ***</span>
                  if (inputObjectStack.size() &gt; maximumFilterRecursion)
                      return SerializationReturnCode::StackOverflowError;
                  JSMap* inMap = jsCast&lt;JSMap*&gt;(inValue);
                  if (!startMap(inMap))
                      break;
<span class="line-modified">!                 JSMapIterator* iterator = JSMapIterator::create(vm, vm.mapIteratorStructure.get(), inMap, IterateKeyValue);</span>
                  m_gcBuffer.appendWithCrashOnOverflow(inMap);
                  m_gcBuffer.appendWithCrashOnOverflow(iterator);
                  mapIteratorStack.append(iterator);
                  inputObjectStack.append(inMap);
                  goto mapDataStartVisitEntry;
<span class="line-new-header">--- 1621,11 ---</span>
                  if (inputObjectStack.size() &gt; maximumFilterRecursion)
                      return SerializationReturnCode::StackOverflowError;
                  JSMap* inMap = jsCast&lt;JSMap*&gt;(inValue);
                  if (!startMap(inMap))
                      break;
<span class="line-modified">!                 JSMapIterator* iterator = JSMapIterator::create(vm, vm.mapIteratorStructure(), inMap, IterateKeyValue);</span>
                  m_gcBuffer.appendWithCrashOnOverflow(inMap);
                  m_gcBuffer.appendWithCrashOnOverflow(iterator);
                  mapIteratorStack.append(iterator);
                  inputObjectStack.append(inMap);
                  goto mapDataStartVisitEntry;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1638,11 ***</span>
                  JSValue key, value;
                  if (!iterator-&gt;nextKeyValue(m_exec, key, value)) {
                      mapIteratorStack.removeLast();
                      JSObject* object = inputObjectStack.last();
                      ASSERT(jsDynamicCast&lt;JSMap*&gt;(vm, object));
<span class="line-modified">!                     propertyStack.append(PropertyNameArray(&amp;vm, PropertyNameMode::Strings, PrivateSymbolMode::Exclude));</span>
                      object-&gt;methodTable(vm)-&gt;getOwnPropertyNames(object, m_exec, propertyStack.last(), EnumerationMode());
                      write(NonMapPropertiesTag);
                      indexStack.append(0);
                      goto objectStartVisitMember;
                  }
<span class="line-new-header">--- 1636,11 ---</span>
                  JSValue key, value;
                  if (!iterator-&gt;nextKeyValue(m_exec, key, value)) {
                      mapIteratorStack.removeLast();
                      JSObject* object = inputObjectStack.last();
                      ASSERT(jsDynamicCast&lt;JSMap*&gt;(vm, object));
<span class="line-modified">!                     propertyStack.append(PropertyNameArray(vm, PropertyNameMode::Strings, PrivateSymbolMode::Exclude));</span>
                      object-&gt;methodTable(vm)-&gt;getOwnPropertyNames(object, m_exec, propertyStack.last(), EnumerationMode());
                      write(NonMapPropertiesTag);
                      indexStack.append(0);
                      goto objectStartVisitMember;
                  }
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1667,11 ***</span>
                  if (inputObjectStack.size() &gt; maximumFilterRecursion)
                      return SerializationReturnCode::StackOverflowError;
                  JSSet* inSet = jsCast&lt;JSSet*&gt;(inValue);
                  if (!startSet(inSet))
                      break;
<span class="line-modified">!                 JSSetIterator* iterator = JSSetIterator::create(vm, vm.setIteratorStructure.get(), inSet, IterateKey);</span>
                  m_gcBuffer.appendWithCrashOnOverflow(inSet);
                  m_gcBuffer.appendWithCrashOnOverflow(iterator);
                  setIteratorStack.append(iterator);
                  inputObjectStack.append(inSet);
                  goto setDataStartVisitEntry;
<span class="line-new-header">--- 1665,11 ---</span>
                  if (inputObjectStack.size() &gt; maximumFilterRecursion)
                      return SerializationReturnCode::StackOverflowError;
                  JSSet* inSet = jsCast&lt;JSSet*&gt;(inValue);
                  if (!startSet(inSet))
                      break;
<span class="line-modified">!                 JSSetIterator* iterator = JSSetIterator::create(vm, vm.setIteratorStructure(), inSet, IterateKey);</span>
                  m_gcBuffer.appendWithCrashOnOverflow(inSet);
                  m_gcBuffer.appendWithCrashOnOverflow(iterator);
                  setIteratorStack.append(iterator);
                  inputObjectStack.append(inSet);
                  goto setDataStartVisitEntry;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1682,11 ***</span>
                  JSValue key;
                  if (!iterator-&gt;next(m_exec, key)) {
                      setIteratorStack.removeLast();
                      JSObject* object = inputObjectStack.last();
                      ASSERT(jsDynamicCast&lt;JSSet*&gt;(vm, object));
<span class="line-modified">!                     propertyStack.append(PropertyNameArray(&amp;vm, PropertyNameMode::Strings, PrivateSymbolMode::Exclude));</span>
                      object-&gt;methodTable(vm)-&gt;getOwnPropertyNames(object, m_exec, propertyStack.last(), EnumerationMode());
                      write(NonSetPropertiesTag);
                      indexStack.append(0);
                      goto objectStartVisitMember;
                  }
<span class="line-new-header">--- 1680,11 ---</span>
                  JSValue key;
                  if (!iterator-&gt;next(m_exec, key)) {
                      setIteratorStack.removeLast();
                      JSObject* object = inputObjectStack.last();
                      ASSERT(jsDynamicCast&lt;JSSet*&gt;(vm, object));
<span class="line-modified">!                     propertyStack.append(PropertyNameArray(vm, PropertyNameMode::Strings, PrivateSymbolMode::Exclude));</span>
                      object-&gt;methodTable(vm)-&gt;getOwnPropertyNames(object, m_exec, propertyStack.last(), EnumerationMode());
                      write(NonSetPropertiesTag);
                      indexStack.append(0);
                      goto objectStartVisitMember;
                  }
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1751,19 ***</span>
          if (!readString(ptr, end, str, length, is8Bit))
              return String();
          return str;
      }
  
<span class="line-modified">!     static DeserializationResult deserialize(ExecState* exec, JSGlobalObject* globalObject, const Vector&lt;RefPtr&lt;MessagePort&gt;&gt;&amp; messagePorts, Vector&lt;std::pair&lt;std::unique_ptr&lt;ImageBuffer&gt;, bool&gt;&gt;&amp;&amp; imageBuffers, ArrayBufferContentsArray* arrayBufferContentsArray, const Vector&lt;uint8_t&gt;&amp; buffer, const Vector&lt;String&gt;&amp; blobURLs, const PAL::SessionID&amp; sessionID, const Vector&lt;String&gt; blobFilePaths, ArrayBufferContentsArray* sharedBuffers</span>
  #if ENABLE(WEBASSEMBLY)
          , WasmModuleArray* wasmModules
  #endif
          )
      {
          if (!buffer.size())
              return std::make_pair(jsNull(), SerializationReturnCode::UnspecifiedError);
<span class="line-modified">!         CloneDeserializer deserializer(exec, globalObject, messagePorts, arrayBufferContentsArray, buffer, blobURLs, sessionID, blobFilePaths, sharedBuffers, WTFMove(imageBuffers)</span>
  #if ENABLE(WEBASSEMBLY)
              , wasmModules
  #endif
              );
          if (!deserializer.isValid())
<span class="line-new-header">--- 1749,19 ---</span>
          if (!readString(ptr, end, str, length, is8Bit))
              return String();
          return str;
      }
  
<span class="line-modified">!     static DeserializationResult deserialize(ExecState* exec, JSGlobalObject* globalObject, const Vector&lt;RefPtr&lt;MessagePort&gt;&gt;&amp; messagePorts, Vector&lt;std::pair&lt;std::unique_ptr&lt;ImageBuffer&gt;, bool&gt;&gt;&amp;&amp; imageBuffers, ArrayBufferContentsArray* arrayBufferContentsArray, const Vector&lt;uint8_t&gt;&amp; buffer, const Vector&lt;String&gt;&amp; blobURLs, const Vector&lt;String&gt; blobFilePaths, ArrayBufferContentsArray* sharedBuffers</span>
  #if ENABLE(WEBASSEMBLY)
          , WasmModuleArray* wasmModules
  #endif
          )
      {
          if (!buffer.size())
              return std::make_pair(jsNull(), SerializationReturnCode::UnspecifiedError);
<span class="line-modified">!         CloneDeserializer deserializer(exec, globalObject, messagePorts, arrayBufferContentsArray, buffer, blobURLs, blobFilePaths, sharedBuffers, WTFMove(imageBuffers)</span>
  #if ENABLE(WEBASSEMBLY)
              , wasmModules
  #endif
              );
          if (!deserializer.isValid())
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1779,11 ***</span>
          }
  
          JSValue jsString(ExecState* exec)
          {
              if (!m_jsString)
<span class="line-modified">!                 m_jsString = JSC::jsString(exec, m_string);</span>
              return m_jsString;
          }
          const String&amp; string() { return m_string; }
          String takeString() { return WTFMove(m_string); }
  
<span class="line-new-header">--- 1777,11 ---</span>
          }
  
          JSValue jsString(ExecState* exec)
          {
              if (!m_jsString)
<span class="line-modified">!                 m_jsString = JSC::jsString(exec-&gt;vm(), m_string);</span>
              return m_jsString;
          }
          const String&amp; string() { return m_string; }
          String takeString() { return WTFMove(m_string); }
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1833,11 ***</span>
      {
          if (!read(m_version))
              m_version = 0xFFFFFFFF;
      }
  
<span class="line-modified">!     CloneDeserializer(ExecState* exec, JSGlobalObject* globalObject, const Vector&lt;RefPtr&lt;MessagePort&gt;&gt;&amp; messagePorts, ArrayBufferContentsArray* arrayBufferContents, const Vector&lt;uint8_t&gt;&amp; buffer, const Vector&lt;String&gt;&amp; blobURLs, const PAL::SessionID&amp; sessionID, const Vector&lt;String&gt; blobFilePaths, ArrayBufferContentsArray* sharedBuffers, Vector&lt;std::pair&lt;std::unique_ptr&lt;ImageBuffer&gt;, bool&gt;&gt;&amp;&amp; imageBuffers</span>
  #if ENABLE(WEBASSEMBLY)
          , WasmModuleArray* wasmModules
  #endif
          )
          : CloneBase(exec)
<span class="line-new-header">--- 1831,11 ---</span>
      {
          if (!read(m_version))
              m_version = 0xFFFFFFFF;
      }
  
<span class="line-modified">!     CloneDeserializer(ExecState* exec, JSGlobalObject* globalObject, const Vector&lt;RefPtr&lt;MessagePort&gt;&gt;&amp; messagePorts, ArrayBufferContentsArray* arrayBufferContents, const Vector&lt;uint8_t&gt;&amp; buffer, const Vector&lt;String&gt;&amp; blobURLs, const Vector&lt;String&gt; blobFilePaths, ArrayBufferContentsArray* sharedBuffers, Vector&lt;std::pair&lt;std::unique_ptr&lt;ImageBuffer&gt;, bool&gt;&gt;&amp;&amp; imageBuffers</span>
  #if ENABLE(WEBASSEMBLY)
          , WasmModuleArray* wasmModules
  #endif
          )
          : CloneBase(exec)
</pre>
<hr />
<pre>
<span class="line-old-header">*** 1848,11 ***</span>
          , m_version(0xFFFFFFFF)
          , m_messagePorts(messagePorts)
          , m_arrayBufferContents(arrayBufferContents)
          , m_arrayBuffers(arrayBufferContents ? arrayBufferContents-&gt;size() : 0)
          , m_blobURLs(blobURLs)
<span class="line-removed">-         , m_sessionID(sessionID)</span>
          , m_blobFilePaths(blobFilePaths)
          , m_sharedBuffers(sharedBuffers)
          , m_imageBuffers(WTFMove(imageBuffers))
          , m_imageBitmaps(m_imageBuffers.size())
  #if ENABLE(WEBASSEMBLY)
<span class="line-new-header">--- 1846,10 ---</span>
</pre>
<hr />
<pre>
<span class="line-old-header">*** 2094,11 ***</span>
          String filePath = blobFilePathForBlobURL(url-&gt;string());
          if (filePath.isEmpty())
              filePath = path-&gt;string();
  
          if (m_isDOMGlobalObject)
<span class="line-modified">!             file = File::deserialize(filePath, URL(URL(), url-&gt;string()), type-&gt;string(), name-&gt;string(), optionalLastModified);</span>
          return true;
      }
  
      bool readArrayBuffer(RefPtr&lt;ArrayBuffer&gt;&amp; arrayBuffer)
      {
<span class="line-new-header">--- 2091,11 ---</span>
          String filePath = blobFilePathForBlobURL(url-&gt;string());
          if (filePath.isEmpty())
              filePath = path-&gt;string();
  
          if (m_isDOMGlobalObject)
<span class="line-modified">!             file = File::deserialize(jsCast&lt;JSDOMGlobalObject*&gt;(m_globalObject)-&gt;scriptExecutionContext()-&gt;sessionID(), filePath, URL(URL(), url-&gt;string()), type-&gt;string(), name-&gt;string(), optionalLastModified);</span>
          return true;
      }
  
      bool readArrayBuffer(RefPtr&lt;ArrayBuffer&gt;&amp; arrayBuffer)
      {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 2135,11 ***</span>
              return false;
  
          RefPtr&lt;ArrayBuffer&gt; arrayBuffer = toPossiblySharedArrayBuffer(vm, arrayBufferObj);
          switch (arrayBufferViewSubtag) {
          case DataViewTag:
<span class="line-modified">!             arrayBufferView = getJSValue(DataView::create(WTFMove(arrayBuffer), byteOffset, length).get());</span>
              return true;
          case Int8ArrayTag:
              arrayBufferView = toJS(m_exec, m_globalObject, Int8Array::tryCreate(WTFMove(arrayBuffer), byteOffset, length).get());
              return true;
          case Uint8ArrayTag:
<span class="line-new-header">--- 2132,11 ---</span>
              return false;
  
          RefPtr&lt;ArrayBuffer&gt; arrayBuffer = toPossiblySharedArrayBuffer(vm, arrayBufferObj);
          switch (arrayBufferViewSubtag) {
          case DataViewTag:
<span class="line-modified">!             arrayBufferView = toJS(m_exec, m_globalObject, DataView::create(WTFMove(arrayBuffer), byteOffset, length).get());</span>
              return true;
          case Int8ArrayTag:
              arrayBufferView = toJS(m_exec, m_globalObject, Int8Array::tryCreate(WTFMove(arrayBuffer), byteOffset, length).get());
              return true;
          case Uint8ArrayTag:
</pre>
<hr />
<pre>
<span class="line-old-header">*** 2654,11 ***</span>
          if (!read(point.z))
              return WTF::nullopt;
          if (!read(point.w))
              return WTF::nullopt;
  
<span class="line-modified">!         return WTFMove(point);</span>
      }
  
      JSValue readDOMQuad()
      {
          auto p1 = readDOMPointInit();
<span class="line-new-header">--- 2651,11 ---</span>
          if (!read(point.z))
              return WTF::nullopt;
          if (!read(point.w))
              return WTF::nullopt;
  
<span class="line-modified">!         return point;</span>
      }
  
      JSValue readDOMQuad()
      {
          auto p1 = readDOMPointInit();
</pre>
<hr />
<pre>
<span class="line-old-header">*** 2860,45 ***</span>
              unsigned long long size = 0;
              if (!read(size))
                  return JSValue();
              if (!m_isDOMGlobalObject)
                  return jsNull();
<span class="line-modified">!             return getJSValue(Blob::deserialize(URL(URL(), url-&gt;string()), type-&gt;string(), size, blobFilePathForBlobURL(url-&gt;string())).get());</span>
          }
          case StringTag: {
              CachedStringRef cachedString;
              if (!readStringData(cachedString))
                  return JSValue();
              return cachedString-&gt;jsString(m_exec);
          }
          case EmptyStringTag:
<span class="line-modified">!             return jsEmptyString(&amp;m_exec-&gt;vm());</span>
          case StringObjectTag: {
              CachedStringRef cachedString;
              if (!readStringData(cachedString))
                  return JSValue();
              StringObject* obj = constructString(m_exec-&gt;vm(), m_globalObject, cachedString-&gt;jsString(m_exec));
              m_gcBuffer.appendWithCrashOnOverflow(obj);
              return obj;
          }
          case EmptyStringObjectTag: {
              VM&amp; vm = m_exec-&gt;vm();
<span class="line-modified">!             StringObject* obj = constructString(vm, m_globalObject, jsEmptyString(&amp;vm));</span>
              m_gcBuffer.appendWithCrashOnOverflow(obj);
              return obj;
          }
          case RegExpTag: {
              CachedStringRef pattern;
              if (!readStringData(pattern))
                  return JSValue();
              CachedStringRef flags;
              if (!readStringData(flags))
                  return JSValue();
<span class="line-modified">!             RegExpFlags reFlags = regExpFlags(flags-&gt;string());</span>
<span class="line-modified">!             ASSERT(reFlags != InvalidFlags);</span>
              VM&amp; vm = m_exec-&gt;vm();
<span class="line-modified">!             RegExp* regExp = RegExp::create(vm, pattern-&gt;string(), reFlags);</span>
              return RegExpObject::create(vm, m_globalObject-&gt;regExpStructure(), regExp);
          }
          case ObjectReferenceTag: {
              unsigned index = 0;
              if (!readConstantPoolIndex(m_gcBuffer, index)) {
<span class="line-new-header">--- 2857,45 ---</span>
              unsigned long long size = 0;
              if (!read(size))
                  return JSValue();
              if (!m_isDOMGlobalObject)
                  return jsNull();
<span class="line-modified">!             return getJSValue(Blob::deserialize(jsCast&lt;JSDOMGlobalObject*&gt;(m_globalObject)-&gt;scriptExecutionContext()-&gt;sessionID(), URL(URL(), url-&gt;string()), type-&gt;string(), size, blobFilePathForBlobURL(url-&gt;string())).get());</span>
          }
          case StringTag: {
              CachedStringRef cachedString;
              if (!readStringData(cachedString))
                  return JSValue();
              return cachedString-&gt;jsString(m_exec);
          }
          case EmptyStringTag:
<span class="line-modified">!             return jsEmptyString(m_exec-&gt;vm());</span>
          case StringObjectTag: {
              CachedStringRef cachedString;
              if (!readStringData(cachedString))
                  return JSValue();
              StringObject* obj = constructString(m_exec-&gt;vm(), m_globalObject, cachedString-&gt;jsString(m_exec));
              m_gcBuffer.appendWithCrashOnOverflow(obj);
              return obj;
          }
          case EmptyStringObjectTag: {
              VM&amp; vm = m_exec-&gt;vm();
<span class="line-modified">!             StringObject* obj = constructString(vm, m_globalObject, jsEmptyString(vm));</span>
              m_gcBuffer.appendWithCrashOnOverflow(obj);
              return obj;
          }
          case RegExpTag: {
              CachedStringRef pattern;
              if (!readStringData(pattern))
                  return JSValue();
              CachedStringRef flags;
              if (!readStringData(flags))
                  return JSValue();
<span class="line-modified">!             auto reFlags = Yarr::parseFlags(flags-&gt;string());</span>
<span class="line-modified">!             ASSERT(reFlags.hasValue());</span>
              VM&amp; vm = m_exec-&gt;vm();
<span class="line-modified">!             RegExp* regExp = RegExp::create(vm, pattern-&gt;string(), reFlags.value());</span>
              return RegExpObject::create(vm, m_globalObject-&gt;regExpStructure(), regExp);
          }
          case ObjectReferenceTag: {
              unsigned index = 0;
              if (!readConstantPoolIndex(m_gcBuffer, index)) {
</pre>
<hr />
<pre>
<span class="line-old-header">*** 2923,11 ***</span>
              if (!indexSuccessfullyRead || !m_wasmModules || index &gt;= m_wasmModules-&gt;size()) {
                  fail();
                  return JSValue();
              }
              auto scope = DECLARE_THROW_SCOPE(m_exec-&gt;vm());
<span class="line-modified">!             JSValue result = JSC::JSWebAssemblyModule::createStub(m_exec-&gt;vm(), m_exec, m_globalObject-&gt;WebAssemblyModuleStructure(), m_wasmModules-&gt;at(index));</span>
              // Since we are cloning a JSWebAssemblyModule, it&#39;s impossible for that
              // module to not have been a valid module. Therefore, createStub should
              // not trow.
              scope.releaseAssertNoException();
              m_gcBuffer.appendWithCrashOnOverflow(result);
<span class="line-new-header">--- 2920,11 ---</span>
              if (!indexSuccessfullyRead || !m_wasmModules || index &gt;= m_wasmModules-&gt;size()) {
                  fail();
                  return JSValue();
              }
              auto scope = DECLARE_THROW_SCOPE(m_exec-&gt;vm());
<span class="line-modified">!             JSValue result = JSC::JSWebAssemblyModule::createStub(m_exec-&gt;vm(), m_exec, m_globalObject-&gt;webAssemblyModuleStructure(), m_wasmModules-&gt;at(index));</span>
              // Since we are cloning a JSWebAssemblyModule, it&#39;s impossible for that
              // module to not have been a valid module. Therefore, createStub should
              // not trow.
              scope.releaseAssertNoException();
              m_gcBuffer.appendWithCrashOnOverflow(result);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 3058,11 ***</span>
      Vector&lt;CachedString&gt; m_constantPool;
      const Vector&lt;RefPtr&lt;MessagePort&gt;&gt;&amp; m_messagePorts;
      ArrayBufferContentsArray* m_arrayBufferContents;
      Vector&lt;RefPtr&lt;JSC::ArrayBuffer&gt;&gt; m_arrayBuffers;
      Vector&lt;String&gt; m_blobURLs;
<span class="line-removed">-     PAL::SessionID m_sessionID;</span>
      Vector&lt;String&gt; m_blobFilePaths;
      ArrayBufferContentsArray* m_sharedBuffers;
      Vector&lt;std::pair&lt;std::unique_ptr&lt;ImageBuffer&gt;, bool&gt;&gt; m_imageBuffers;
      Vector&lt;RefPtr&lt;ImageBitmap&gt;&gt; m_imageBitmaps;
  #if ENABLE(WEBASSEMBLY)
<span class="line-new-header">--- 3055,10 ---</span>
</pre>
<hr />
<pre>
<span class="line-old-header">*** 3166,15 ***</span>
                  outputObjectStack.removeLast();
                  break;
              }
  
              if (JSValue terminal = readTerminal()) {
<span class="line-modified">!                 putProperty(outputObjectStack.last(), Identifier::fromString(m_exec, cachedString-&gt;string()), terminal);</span>
                  goto objectStartVisitMember;
              }
              stateStack.append(ObjectEndVisitMember);
<span class="line-modified">!             propertyNameStack.append(Identifier::fromString(m_exec, cachedString-&gt;string()));</span>
              goto stateUnknown;
          }
          case ObjectEndVisitMember: {
              putProperty(outputObjectStack.last(), propertyNameStack.last(), outValue);
              propertyNameStack.removeLast();
<span class="line-new-header">--- 3162,15 ---</span>
                  outputObjectStack.removeLast();
                  break;
              }
  
              if (JSValue terminal = readTerminal()) {
<span class="line-modified">!                 putProperty(outputObjectStack.last(), Identifier::fromString(vm, cachedString-&gt;string()), terminal);</span>
                  goto objectStartVisitMember;
              }
              stateStack.append(ObjectEndVisitMember);
<span class="line-modified">!             propertyNameStack.append(Identifier::fromString(vm, cachedString-&gt;string()));</span>
              goto stateUnknown;
          }
          case ObjectEndVisitMember: {
              putProperty(outputObjectStack.last(), propertyNameStack.last(), outValue);
              propertyNameStack.removeLast();
</pre>
<hr />
<pre>
<span class="line-old-header">*** 3279,11 ***</span>
      : m_data(WTFMove(buffer))
      , m_arrayBufferContentsArray(WTFMove(arrayBufferContentsArray))
  {
  }
  
<span class="line-modified">! SerializedScriptValue::SerializedScriptValue(Vector&lt;uint8_t&gt;&amp;&amp; buffer, const Vector&lt;String&gt;&amp; blobURLs, const PAL::SessionID&amp; sessionID,  std::unique_ptr&lt;ArrayBufferContentsArray&gt; arrayBufferContentsArray, std::unique_ptr&lt;ArrayBufferContentsArray&gt; sharedBufferContentsArray, Vector&lt;std::pair&lt;std::unique_ptr&lt;ImageBuffer&gt;, bool&gt;&gt;&amp;&amp; imageBuffers</span>
  #if ENABLE(WEBASSEMBLY)
          , std::unique_ptr&lt;WasmModuleArray&gt; wasmModulesArray
  #endif
          )
      : m_data(WTFMove(buffer))
<span class="line-new-header">--- 3275,11 ---</span>
      : m_data(WTFMove(buffer))
      , m_arrayBufferContentsArray(WTFMove(arrayBufferContentsArray))
  {
  }
  
<span class="line-modified">! SerializedScriptValue::SerializedScriptValue(Vector&lt;uint8_t&gt;&amp;&amp; buffer, const Vector&lt;String&gt;&amp; blobURLs, std::unique_ptr&lt;ArrayBufferContentsArray&gt; arrayBufferContentsArray, std::unique_ptr&lt;ArrayBufferContentsArray&gt; sharedBufferContentsArray, Vector&lt;std::pair&lt;std::unique_ptr&lt;ImageBuffer&gt;, bool&gt;&gt;&amp;&amp; imageBuffers</span>
  #if ENABLE(WEBASSEMBLY)
          , std::unique_ptr&lt;WasmModuleArray&gt; wasmModulesArray
  #endif
          )
      : m_data(WTFMove(buffer))
</pre>
<hr />
<pre>
<span class="line-old-header">*** 3291,11 ***</span>
      , m_sharedBufferContentsArray(WTFMove(sharedBufferContentsArray))
      , m_imageBuffers(WTFMove(imageBuffers))
  #if ENABLE(WEBASSEMBLY)
      , m_wasmModulesArray(WTFMove(wasmModulesArray))
  #endif
<span class="line-removed">-     , m_sessionID(sessionID)</span>
  {
      // Since this SerializedScriptValue is meant to be passed between threads, its String data members
      // need to be isolatedCopies so we don&#39;t run into thread safety issues for the StringImpls.
      m_blobURLs.reserveInitialCapacity(blobURLs.size());
      for (auto&amp; url : blobURLs)
<span class="line-new-header">--- 3287,10 ---</span>
</pre>
<hr />
<pre>
<span class="line-old-header">*** 3305,11 ***</span>
  static ExceptionOr&lt;std::unique_ptr&lt;ArrayBufferContentsArray&gt;&gt; transferArrayBuffers(VM&amp; vm, const Vector&lt;RefPtr&lt;JSC::ArrayBuffer&gt;&gt;&amp; arrayBuffers)
  {
      if (arrayBuffers.isEmpty())
          return nullptr;
  
<span class="line-modified">!     auto contents = std::make_unique&lt;ArrayBufferContentsArray&gt;(arrayBuffers.size());</span>
  
      HashSet&lt;JSC::ArrayBuffer*&gt; visited;
      for (size_t arrayBufferIndex = 0; arrayBufferIndex &lt; arrayBuffers.size(); arrayBufferIndex++) {
          if (visited.contains(arrayBuffers[arrayBufferIndex].get()))
              continue;
<span class="line-new-header">--- 3300,11 ---</span>
  static ExceptionOr&lt;std::unique_ptr&lt;ArrayBufferContentsArray&gt;&gt; transferArrayBuffers(VM&amp; vm, const Vector&lt;RefPtr&lt;JSC::ArrayBuffer&gt;&gt;&amp; arrayBuffers)
  {
      if (arrayBuffers.isEmpty())
          return nullptr;
  
<span class="line-modified">!     auto contents = makeUnique&lt;ArrayBufferContentsArray&gt;(arrayBuffers.size());</span>
  
      HashSet&lt;JSC::ArrayBuffer*&gt; visited;
      for (size_t arrayBufferIndex = 0; arrayBufferIndex &lt; arrayBuffers.size(); arrayBufferIndex++) {
          if (visited.contains(arrayBuffers[arrayBufferIndex].get()))
              continue;
</pre>
<hr />
<pre>
<span class="line-old-header">*** 3318,11 ***</span>
          bool result = arrayBuffers[arrayBufferIndex]-&gt;transferTo(vm, contents-&gt;at(arrayBufferIndex));
          if (!result)
              return Exception { TypeError };
      }
  
<span class="line-modified">!     return WTFMove(contents);</span>
  }
  
  static void maybeThrowExceptionIfSerializationFailed(ExecState&amp; state, SerializationReturnCode code)
  {
      auto&amp; vm = state.vm();
<span class="line-new-header">--- 3313,11 ---</span>
          bool result = arrayBuffers[arrayBufferIndex]-&gt;transferTo(vm, contents-&gt;at(arrayBufferIndex));
          if (!result)
              return Exception { TypeError };
      }
  
<span class="line-modified">!     return contents;</span>
  }
  
  static void maybeThrowExceptionIfSerializationFailed(ExecState&amp; state, SerializationReturnCode code)
  {
      auto&amp; vm = state.vm();
</pre>
<hr />
<pre>
<span class="line-old-header">*** 3374,11 ***</span>
  
  RefPtr&lt;SerializedScriptValue&gt; SerializedScriptValue::create(ExecState&amp; exec, JSValue value, SerializationErrorMode throwExceptions)
  {
      Vector&lt;uint8_t&gt; buffer;
      Vector&lt;String&gt; blobURLs;
<span class="line-removed">-     PAL::SessionID sessionID;</span>
      Vector&lt;RefPtr&lt;MessagePort&gt;&gt; dummyMessagePorts;
      Vector&lt;RefPtr&lt;ImageBitmap&gt;&gt; dummyImageBitmaps;
      Vector&lt;RefPtr&lt;JSC::ArrayBuffer&gt;&gt; dummyArrayBuffers;
  #if ENABLE(WEBASSEMBLY)
      WasmModuleArray dummyModules;
<span class="line-new-header">--- 3369,10 ---</span>
</pre>
<hr />
<pre>
<span class="line-old-header">*** 3386,11 ***</span>
      ArrayBufferContentsArray dummySharedBuffers;
      auto code = CloneSerializer::serialize(&amp;exec, value, dummyMessagePorts, dummyArrayBuffers, dummyImageBitmaps,
  #if ENABLE(WEBASSEMBLY)
          dummyModules,
  #endif
<span class="line-modified">!         blobURLs, sessionID, buffer, SerializationContext::Default, dummySharedBuffers);</span>
  
  #if ENABLE(WEBASSEMBLY)
      ASSERT_WITH_MESSAGE(dummyModules.isEmpty(), &quot;Wasm::Module serialization is only allowed in the postMessage context&quot;);
  #endif
  
<span class="line-new-header">--- 3380,11 ---</span>
      ArrayBufferContentsArray dummySharedBuffers;
      auto code = CloneSerializer::serialize(&amp;exec, value, dummyMessagePorts, dummyArrayBuffers, dummyImageBitmaps,
  #if ENABLE(WEBASSEMBLY)
          dummyModules,
  #endif
<span class="line-modified">!         blobURLs, buffer, SerializationContext::Default, dummySharedBuffers);</span>
  
  #if ENABLE(WEBASSEMBLY)
      ASSERT_WITH_MESSAGE(dummyModules.isEmpty(), &quot;Wasm::Module serialization is only allowed in the postMessage context&quot;);
  #endif
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 3398,11 ***</span>
          maybeThrowExceptionIfSerializationFailed(exec, code);
  
      if (code != SerializationReturnCode::SuccessfullyCompleted)
          return nullptr;
  
<span class="line-modified">!     return adoptRef(*new SerializedScriptValue(WTFMove(buffer), blobURLs, sessionID, nullptr, nullptr, { }</span>
  #if ENABLE(WEBASSEMBLY)
          , nullptr
  #endif
              ));
  }
<span class="line-new-header">--- 3392,11 ---</span>
          maybeThrowExceptionIfSerializationFailed(exec, code);
  
      if (code != SerializationReturnCode::SuccessfullyCompleted)
          return nullptr;
  
<span class="line-modified">!     return adoptRef(*new SerializedScriptValue(WTFMove(buffer), blobURLs, nullptr, nullptr, { }</span>
  #if ENABLE(WEBASSEMBLY)
          , nullptr
  #endif
              ));
  }
</pre>
<hr />
<pre>
<span class="line-old-header">*** 3454,33 ***</span>
      if (containsDuplicates(imageBitmaps))
          return Exception { DataCloneError };
  
      Vector&lt;uint8_t&gt; buffer;
      Vector&lt;String&gt; blobURLs;
<span class="line-removed">-     PAL::SessionID sessionID;</span>
  #if ENABLE(WEBASSEMBLY)
      WasmModuleArray wasmModules;
  #endif
<span class="line-modified">!     std::unique_ptr&lt;ArrayBufferContentsArray&gt; sharedBuffers = std::make_unique&lt;ArrayBufferContentsArray&gt;();</span>
      auto code = CloneSerializer::serialize(&amp;state, value, messagePorts, arrayBuffers, imageBitmaps,
  #if ENABLE(WEBASSEMBLY)
          wasmModules,
  #endif
<span class="line-modified">!         blobURLs, sessionID, buffer, context, *sharedBuffers);</span>
  
      if (code != SerializationReturnCode::SuccessfullyCompleted)
          return exceptionForSerializationFailure(code);
  
      auto arrayBufferContentsArray = transferArrayBuffers(vm, arrayBuffers);
      if (arrayBufferContentsArray.hasException())
          return arrayBufferContentsArray.releaseException();
  
      auto imageBuffers = ImageBitmap::detachBitmaps(WTFMove(imageBitmaps));
  
<span class="line-modified">!     return adoptRef(*new SerializedScriptValue(WTFMove(buffer), blobURLs, sessionID, arrayBufferContentsArray.releaseReturnValue(), context == SerializationContext::WorkerPostMessage ? WTFMove(sharedBuffers) : nullptr, WTFMove(imageBuffers)</span>
  #if ENABLE(WEBASSEMBLY)
<span class="line-modified">!                 , std::make_unique&lt;WasmModuleArray&gt;(wasmModules)</span>
  #endif
                  ));
  }
  
  RefPtr&lt;SerializedScriptValue&gt; SerializedScriptValue::create(StringView string)
<span class="line-new-header">--- 3448,32 ---</span>
      if (containsDuplicates(imageBitmaps))
          return Exception { DataCloneError };
  
      Vector&lt;uint8_t&gt; buffer;
      Vector&lt;String&gt; blobURLs;
  #if ENABLE(WEBASSEMBLY)
      WasmModuleArray wasmModules;
  #endif
<span class="line-modified">!     std::unique_ptr&lt;ArrayBufferContentsArray&gt; sharedBuffers = makeUnique&lt;ArrayBufferContentsArray&gt;();</span>
      auto code = CloneSerializer::serialize(&amp;state, value, messagePorts, arrayBuffers, imageBitmaps,
  #if ENABLE(WEBASSEMBLY)
          wasmModules,
  #endif
<span class="line-modified">!         blobURLs, buffer, context, *sharedBuffers);</span>
  
      if (code != SerializationReturnCode::SuccessfullyCompleted)
          return exceptionForSerializationFailure(code);
  
      auto arrayBufferContentsArray = transferArrayBuffers(vm, arrayBuffers);
      if (arrayBufferContentsArray.hasException())
          return arrayBufferContentsArray.releaseException();
  
      auto imageBuffers = ImageBitmap::detachBitmaps(WTFMove(imageBitmaps));
  
<span class="line-modified">!     return adoptRef(*new SerializedScriptValue(WTFMove(buffer), blobURLs, arrayBufferContentsArray.releaseReturnValue(), context == SerializationContext::WorkerPostMessage ? WTFMove(sharedBuffers) : nullptr, WTFMove(imageBuffers)</span>
  #if ENABLE(WEBASSEMBLY)
<span class="line-modified">!                 , makeUnique&lt;WasmModuleArray&gt;(wasmModules)</span>
  #endif
                  ));
  }
  
  RefPtr&lt;SerializedScriptValue&gt; SerializedScriptValue::create(StringView string)
</pre>
<hr />
<pre>
<span class="line-old-header">*** 3522,17 ***</span>
  
  JSValue SerializedScriptValue::deserialize(ExecState&amp; exec, JSGlobalObject* globalObject, const Vector&lt;RefPtr&lt;MessagePort&gt;&gt;&amp; messagePorts, SerializationErrorMode throwExceptions)
  {
      Vector&lt;String&gt; dummyBlobs;
      Vector&lt;String&gt; dummyPaths;
<span class="line-modified">!     PAL::SessionID dummySessionID;</span>
<span class="line-removed">-     return deserialize(exec, globalObject, messagePorts, dummyBlobs, dummySessionID, dummyPaths, throwExceptions);</span>
  }
  
<span class="line-modified">! JSValue SerializedScriptValue::deserialize(ExecState&amp; exec, JSGlobalObject* globalObject, const Vector&lt;RefPtr&lt;MessagePort&gt;&gt;&amp; messagePorts, const Vector&lt;String&gt;&amp; blobURLs, const PAL::SessionID&amp; sessionID, const Vector&lt;String&gt;&amp; blobFilePaths, SerializationErrorMode throwExceptions)</span>
  {
<span class="line-modified">!     DeserializationResult result = CloneDeserializer::deserialize(&amp;exec, globalObject, messagePorts, WTFMove(m_imageBuffers), m_arrayBufferContentsArray.get(), m_data, blobURLs, sessionID, blobFilePaths, m_sharedBufferContentsArray.get()</span>
  #if ENABLE(WEBASSEMBLY)
          , m_wasmModulesArray.get()
  #endif
          );
      if (throwExceptions == SerializationErrorMode::Throwing)
<span class="line-new-header">--- 3515,16 ---</span>
  
  JSValue SerializedScriptValue::deserialize(ExecState&amp; exec, JSGlobalObject* globalObject, const Vector&lt;RefPtr&lt;MessagePort&gt;&gt;&amp; messagePorts, SerializationErrorMode throwExceptions)
  {
      Vector&lt;String&gt; dummyBlobs;
      Vector&lt;String&gt; dummyPaths;
<span class="line-modified">!     return deserialize(exec, globalObject, messagePorts, dummyBlobs, dummyPaths, throwExceptions);</span>
  }
  
<span class="line-modified">! JSValue SerializedScriptValue::deserialize(ExecState&amp; exec, JSGlobalObject* globalObject, const Vector&lt;RefPtr&lt;MessagePort&gt;&gt;&amp; messagePorts, const Vector&lt;String&gt;&amp; blobURLs, const Vector&lt;String&gt;&amp; blobFilePaths, SerializationErrorMode throwExceptions)</span>
  {
<span class="line-modified">!     DeserializationResult result = CloneDeserializer::deserialize(&amp;exec, globalObject, messagePorts, WTFMove(m_imageBuffers), m_arrayBufferContentsArray.get(), m_data, blobURLs, blobFilePaths, m_sharedBufferContentsArray.get()</span>
  #if ENABLE(WEBASSEMBLY)
          , m_wasmModulesArray.get()
  #endif
          );
      if (throwExceptions == SerializationErrorMode::Throwing)
</pre>
<hr />
<pre>
<span class="line-old-header">*** 3577,17 ***</span>
          result.uncheckedAppend(url.isolatedCopy());
  
      return result;
  }
  
<span class="line-modified">! void SerializedScriptValue::writeBlobsToDiskForIndexedDB(CompletionHandler&lt;void(IDBValue&amp;&amp;)&gt;&amp;&amp; completionHandler)</span>
  {
      ASSERT(isMainThread());
      ASSERT(hasBlobURLs());
  
<span class="line-modified">!     // FIXME: Add m_sessionID as a parameter here.</span>
<span class="line-removed">-     blobRegistry().writeBlobsToTemporaryFiles(m_blobURLs, [completionHandler = WTFMove(completionHandler), this, protectedThis = makeRef(*this)] (auto&amp;&amp; blobFilePaths) mutable {</span>
          ASSERT(isMainThread());
  
          if (blobFilePaths.isEmpty()) {
              // We should have successfully written blobs to temporary files.
              // If we failed, then we can&#39;t successfully store this record.
<span class="line-new-header">--- 3569,16 ---</span>
          result.uncheckedAppend(url.isolatedCopy());
  
      return result;
  }
  
<span class="line-modified">! void SerializedScriptValue::writeBlobsToDiskForIndexedDB(PAL::SessionID sessionID, CompletionHandler&lt;void(IDBValue&amp;&amp;)&gt;&amp;&amp; completionHandler)</span>
  {
      ASSERT(isMainThread());
      ASSERT(hasBlobURLs());
  
<span class="line-modified">!     blobRegistry().writeBlobsToTemporaryFiles(sessionID, m_blobURLs, [completionHandler = WTFMove(completionHandler), this, protectedThis = makeRef(*this)] (auto&amp;&amp; blobFilePaths) mutable {</span>
          ASSERT(isMainThread());
  
          if (blobFilePaths.isEmpty()) {
              // We should have successfully written blobs to temporary files.
              // If we failed, then we can&#39;t successfully store this record.
</pre>
<hr />
<pre>
<span class="line-old-header">*** 3595,25 ***</span>
              return;
          }
  
          ASSERT(m_blobURLs.size() == blobFilePaths.size());
  
<span class="line-modified">!         completionHandler({ *this, m_blobURLs, m_sessionID, blobFilePaths });</span>
      });
  }
  
<span class="line-modified">! IDBValue SerializedScriptValue::writeBlobsToDiskForIndexedDBSynchronously()</span>
  {
      ASSERT(!isMainThread());
  
      IDBValue value;
      Lock lock;
      Condition condition;
      lock.lock();
  
<span class="line-modified">!     RunLoop::main().dispatch([this, conditionPtr = &amp;condition, valuePtr = &amp;value] {</span>
<span class="line-modified">!         writeBlobsToDiskForIndexedDB([conditionPtr, valuePtr](IDBValue&amp;&amp; result) {</span>
              ASSERT(isMainThread());
              valuePtr-&gt;setAsIsolatedCopy(result);
  
              conditionPtr-&gt;notifyAll();
          });
<span class="line-new-header">--- 3586,25 ---</span>
              return;
          }
  
          ASSERT(m_blobURLs.size() == blobFilePaths.size());
  
<span class="line-modified">!         completionHandler({ *this, m_blobURLs, blobFilePaths });</span>
      });
  }
  
<span class="line-modified">! IDBValue SerializedScriptValue::writeBlobsToDiskForIndexedDBSynchronously(PAL::SessionID sessionID)</span>
  {
      ASSERT(!isMainThread());
  
      IDBValue value;
      Lock lock;
      Condition condition;
      lock.lock();
  
<span class="line-modified">!     RunLoop::main().dispatch([this, sessionID, conditionPtr = &amp;condition, valuePtr = &amp;value] {</span>
<span class="line-modified">!         writeBlobsToDiskForIndexedDB(sessionID, [conditionPtr, valuePtr](IDBValue&amp;&amp; result) {</span>
              ASSERT(isMainThread());
              valuePtr-&gt;setAsIsolatedCopy(result);
  
              conditionPtr-&gt;notifyAll();
          });
</pre>
<center><a href="ScriptWrappable.h.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="SerializedScriptValue.h.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>