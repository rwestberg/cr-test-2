<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff modules/javafx.web/src/main/native/Source/WebCore/page/Quirks.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
<body>
<center><a href="ProcessWarming.cpp.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="Quirks.h.cdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/page/Quirks.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 1,7 ***</span>
  /*
<span class="line-modified">!  * Copyright (C) 2018 Apple Inc. All rights reserved.</span>
   *
   * Redistribution and use in source and binary forms, with or without
   * modification, are permitted provided that the following conditions
   * are met:
   * 1. Redistributions of source code must retain the above copyright
<span class="line-new-header">--- 1,7 ---</span>
  /*
<span class="line-modified">!  * Copyright (C) 2018-2019 Apple Inc. All rights reserved.</span>
   *
   * Redistribution and use in source and binary forms, with or without
   * modification, are permitted provided that the following conditions
   * are met:
   * 1. Redistributions of source code must retain the above copyright
</pre>
<hr />
<pre>
<span class="line-old-header">*** 24,36 ***</span>
   */
  
  #include &quot;config.h&quot;
  #include &quot;Quirks.h&quot;
  
  #include &quot;Document.h&quot;
  #include &quot;Settings.h&quot;
  
  namespace WebCore {
  
  Quirks::Quirks(Document&amp; document)
      : m_document(makeWeakPtr(document))
  {
  }
  
  Quirks::~Quirks() = default;
  
  bool Quirks::hasBrokenEncryptedMediaAPISupportQuirk() const
  {
<span class="line-modified">!     if (!m_document || !m_document-&gt;settings().needsSiteSpecificQuirks())</span>
          return false;
  
      if (m_hasBrokenEncryptedMediaAPISupportQuirk)
          return m_hasBrokenEncryptedMediaAPISupportQuirk.value();
  
      auto domain = m_document-&gt;securityOrigin().domain().convertToASCIILowercase();
  
      m_hasBrokenEncryptedMediaAPISupportQuirk = domain == &quot;starz.com&quot;
          || domain.endsWith(&quot;.starz.com&quot;)
          || domain == &quot;hulu.com&quot;
          || domain.endsWith(&quot;hulu.com&quot;);
  
      return m_hasBrokenEncryptedMediaAPISupportQuirk.value();
  }
  
  }
<span class="line-new-header">--- 24,562 ---</span>
   */
  
  #include &quot;config.h&quot;
  #include &quot;Quirks.h&quot;
  
<span class="line-added">+ #include &quot;CustomHeaderFields.h&quot;</span>
<span class="line-added">+ #include &quot;DOMTokenList.h&quot;</span>
  #include &quot;Document.h&quot;
<span class="line-added">+ #include &quot;DocumentLoader.h&quot;</span>
<span class="line-added">+ #include &quot;FrameLoader.h&quot;</span>
<span class="line-added">+ #include &quot;HTMLMetaElement.h&quot;</span>
<span class="line-added">+ #include &quot;HTMLObjectElement.h&quot;</span>
<span class="line-added">+ #include &quot;LayoutUnit.h&quot;</span>
<span class="line-added">+ #include &quot;RuntimeEnabledFeatures.h&quot;</span>
  #include &quot;Settings.h&quot;
<span class="line-added">+ #include &quot;UserAgent.h&quot;</span>
  
  namespace WebCore {
  
<span class="line-added">+ static inline OptionSet&lt;AutoplayQuirk&gt; allowedAutoplayQuirks(Document&amp; document)</span>
<span class="line-added">+ {</span>
<span class="line-added">+     auto* loader = document.loader();</span>
<span class="line-added">+     if (!loader)</span>
<span class="line-added">+         return { };</span>
<span class="line-added">+ </span>
<span class="line-added">+     return loader-&gt;allowedAutoplayQuirks();</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
  Quirks::Quirks(Document&amp; document)
      : m_document(makeWeakPtr(document))
  {
  }
  
  Quirks::~Quirks() = default;
  
<span class="line-added">+ inline bool Quirks::needsQuirks() const</span>
<span class="line-added">+ {</span>
<span class="line-added">+     return m_document &amp;&amp; m_document-&gt;settings().needsSiteSpecificQuirks();</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
<span class="line-added">+ bool Quirks::shouldIgnoreInvalidSignal() const</span>
<span class="line-added">+ {</span>
<span class="line-added">+     return needsQuirks();</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
<span class="line-added">+ bool Quirks::needsFormControlToBeMouseFocusable() const</span>
<span class="line-added">+ {</span>
<span class="line-added">+ #if PLATFORM(MAC)</span>
<span class="line-added">+     if (!needsQuirks())</span>
<span class="line-added">+         return false;</span>
<span class="line-added">+ </span>
<span class="line-added">+     auto host = m_document-&gt;url().host();</span>
<span class="line-added">+     return equalLettersIgnoringASCIICase(host, &quot;ceac.state.gov&quot;) || host.endsWithIgnoringASCIICase(&quot;.ceac.state.gov&quot;);</span>
<span class="line-added">+ #else</span>
<span class="line-added">+     return false;</span>
<span class="line-added">+ #endif</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
<span class="line-added">+ bool Quirks::needsAutoplayPlayPauseEvents() const</span>
<span class="line-added">+ {</span>
<span class="line-added">+     if (!needsQuirks())</span>
<span class="line-added">+         return false;</span>
<span class="line-added">+ </span>
<span class="line-added">+     if (allowedAutoplayQuirks(*m_document).contains(AutoplayQuirk::SynthesizedPauseEvents))</span>
<span class="line-added">+         return true;</span>
<span class="line-added">+ </span>
<span class="line-added">+     return allowedAutoplayQuirks(m_document-&gt;topDocument()).contains(AutoplayQuirk::SynthesizedPauseEvents);</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
<span class="line-added">+ bool Quirks::needsSeekingSupportDisabled() const</span>
<span class="line-added">+ {</span>
<span class="line-added">+     if (!needsQuirks())</span>
<span class="line-added">+         return false;</span>
<span class="line-added">+ </span>
<span class="line-added">+     auto host = m_document-&gt;topDocument().url().host();</span>
<span class="line-added">+     return equalLettersIgnoringASCIICase(host, &quot;netflix.com&quot;) || host.endsWithIgnoringASCIICase(&quot;.netflix.com&quot;);</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
<span class="line-added">+ bool Quirks::needsPerDocumentAutoplayBehavior() const</span>
<span class="line-added">+ {</span>
<span class="line-added">+ #if PLATFORM(MAC)</span>
<span class="line-added">+     ASSERT(m_document == &amp;m_document-&gt;topDocument());</span>
<span class="line-added">+     return needsQuirks() &amp;&amp; allowedAutoplayQuirks(*m_document).contains(AutoplayQuirk::PerDocumentAutoplayBehavior);</span>
<span class="line-added">+ #else</span>
<span class="line-added">+     auto host = m_document-&gt;topDocument().url().host();</span>
<span class="line-added">+     return equalLettersIgnoringASCIICase(host, &quot;netflix.com&quot;) || host.endsWithIgnoringASCIICase(&quot;.netflix.com&quot;);</span>
<span class="line-added">+ #endif</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
<span class="line-added">+ bool Quirks::shouldAutoplayForArbitraryUserGesture() const</span>
<span class="line-added">+ {</span>
<span class="line-added">+ #if PLATFORM(MAC)</span>
<span class="line-added">+     return needsQuirks() &amp;&amp; allowedAutoplayQuirks(*m_document).contains(AutoplayQuirk::ArbitraryUserGestures);</span>
<span class="line-added">+ #else</span>
<span class="line-added">+     return false;</span>
<span class="line-added">+ #endif</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
  bool Quirks::hasBrokenEncryptedMediaAPISupportQuirk() const
  {
<span class="line-modified">!     if (!needsQuirks())</span>
          return false;
  
      if (m_hasBrokenEncryptedMediaAPISupportQuirk)
          return m_hasBrokenEncryptedMediaAPISupportQuirk.value();
  
      auto domain = m_document-&gt;securityOrigin().domain().convertToASCIILowercase();
  
      m_hasBrokenEncryptedMediaAPISupportQuirk = domain == &quot;starz.com&quot;
          || domain.endsWith(&quot;.starz.com&quot;)
<span class="line-added">+         || domain == &quot;youtube.com&quot;</span>
<span class="line-added">+         || domain.endsWith(&quot;.youtube.com&quot;)</span>
          || domain == &quot;hulu.com&quot;
          || domain.endsWith(&quot;hulu.com&quot;);
  
      return m_hasBrokenEncryptedMediaAPISupportQuirk.value();
  }
  
<span class="line-added">+ bool Quirks::shouldDisableContentChangeObserverTouchEventAdjustment() const</span>
<span class="line-added">+ {</span>
<span class="line-added">+     if (!needsQuirks())</span>
<span class="line-added">+         return false;</span>
<span class="line-added">+ </span>
<span class="line-added">+     auto&amp; topDocument = m_document-&gt;topDocument();</span>
<span class="line-added">+     auto* topDocumentLoader = topDocument.loader();</span>
<span class="line-added">+     if (!topDocumentLoader || !topDocumentLoader-&gt;allowContentChangeObserverQuirk())</span>
<span class="line-added">+         return false;</span>
<span class="line-added">+ </span>
<span class="line-added">+     auto host = m_document-&gt;topDocument().url().host();</span>
<span class="line-added">+     return host.endsWith(&quot;.youtube.com&quot;) || host == &quot;youtube.com&quot;;</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
<span class="line-added">+ bool Quirks::shouldStripQuotationMarkInFontFaceSetFamily() const</span>
<span class="line-added">+ {</span>
<span class="line-added">+     if (!needsQuirks())</span>
<span class="line-added">+         return false;</span>
<span class="line-added">+ </span>
<span class="line-added">+     auto host = m_document-&gt;topDocument().url().host();</span>
<span class="line-added">+     return equalLettersIgnoringASCIICase(host, &quot;docs.google.com&quot;);</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
<span class="line-added">+ bool Quirks::isTouchBarUpdateSupressedForHiddenContentEditable() const</span>
<span class="line-added">+ {</span>
<span class="line-added">+ #if PLATFORM(MAC)</span>
<span class="line-added">+     if (!needsQuirks())</span>
<span class="line-added">+         return false;</span>
<span class="line-added">+ </span>
<span class="line-added">+     auto host = m_document-&gt;topDocument().url().host();</span>
<span class="line-added">+     return equalLettersIgnoringASCIICase(host, &quot;docs.google.com&quot;);</span>
<span class="line-added">+ #else</span>
<span class="line-added">+     return false;</span>
<span class="line-added">+ #endif</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
<span class="line-added">+ bool Quirks::isNeverRichlyEditableForTouchBar() const</span>
<span class="line-added">+ {</span>
<span class="line-added">+ #if PLATFORM(MAC)</span>
<span class="line-added">+     if (!needsQuirks())</span>
<span class="line-added">+         return false;</span>
<span class="line-added">+ </span>
<span class="line-added">+     auto&amp; url = m_document-&gt;topDocument().url();</span>
<span class="line-added">+     auto host = url.host();</span>
<span class="line-added">+ </span>
<span class="line-added">+     if (equalLettersIgnoringASCIICase(host, &quot;twitter.com&quot;))</span>
<span class="line-added">+         return true;</span>
<span class="line-added">+ </span>
<span class="line-added">+     if (equalLettersIgnoringASCIICase(host, &quot;onedrive.live.com&quot;))</span>
<span class="line-added">+         return true;</span>
<span class="line-added">+ </span>
<span class="line-added">+     if (equalLettersIgnoringASCIICase(host, &quot;trix-editor.org&quot;))</span>
<span class="line-added">+         return true;</span>
<span class="line-added">+ </span>
<span class="line-added">+     if (equalLettersIgnoringASCIICase(host, &quot;www.icloud.com&quot;)) {</span>
<span class="line-added">+         auto path = url.path();</span>
<span class="line-added">+         if (path.contains(&quot;notes&quot;) || url.fragmentIdentifier().contains(&quot;notes&quot;))</span>
<span class="line-added">+             return true;</span>
<span class="line-added">+     }</span>
<span class="line-added">+ #endif</span>
<span class="line-added">+ </span>
<span class="line-added">+     return false;</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
<span class="line-added">+ static bool shouldSuppressAutocorrectionAndAutocaptializationInHiddenEditableAreasForHost(const StringView&amp; host)</span>
<span class="line-added">+ {</span>
<span class="line-added">+ #if PLATFORM(IOS_FAMILY)</span>
<span class="line-added">+     return equalLettersIgnoringASCIICase(host, &quot;docs.google.com&quot;);</span>
<span class="line-added">+ #else</span>
<span class="line-added">+     UNUSED_PARAM(host);</span>
<span class="line-added">+     return false;</span>
<span class="line-added">+ #endif</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
<span class="line-added">+ bool Quirks::shouldDispatchSyntheticMouseEventsWhenModifyingSelection() const</span>
<span class="line-added">+ {</span>
<span class="line-added">+     if (m_document-&gt;settings().shouldDispatchSyntheticMouseEventsWhenModifyingSelection())</span>
<span class="line-added">+         return true;</span>
<span class="line-added">+ </span>
<span class="line-added">+     if (!needsQuirks())</span>
<span class="line-added">+         return false;</span>
<span class="line-added">+ </span>
<span class="line-added">+     auto host = m_document-&gt;topDocument().url().host();</span>
<span class="line-added">+     if (equalLettersIgnoringASCIICase(host, &quot;medium.com&quot;) || host.endsWithIgnoringASCIICase(&quot;.medium.com&quot;))</span>
<span class="line-added">+         return true;</span>
<span class="line-added">+ </span>
<span class="line-added">+     if (equalLettersIgnoringASCIICase(host, &quot;weebly.com&quot;) || host.endsWithIgnoringASCIICase(&quot;.weebly.com&quot;))</span>
<span class="line-added">+         return true;</span>
<span class="line-added">+ </span>
<span class="line-added">+     return false;</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
<span class="line-added">+ bool Quirks::needsYouTubeMouseOutQuirk() const</span>
<span class="line-added">+ {</span>
<span class="line-added">+ #if PLATFORM(IOS_FAMILY)</span>
<span class="line-added">+     if (m_document-&gt;settings().shouldDispatchSyntheticMouseOutAfterSyntheticClick())</span>
<span class="line-added">+         return true;</span>
<span class="line-added">+ </span>
<span class="line-added">+     if (!needsQuirks())</span>
<span class="line-added">+         return false;</span>
<span class="line-added">+ </span>
<span class="line-added">+     return equalLettersIgnoringASCIICase(m_document-&gt;url().host(), &quot;www.youtube.com&quot;);</span>
<span class="line-added">+ #else</span>
<span class="line-added">+     return false;</span>
<span class="line-added">+ #endif</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
<span class="line-added">+ bool Quirks::shouldAvoidUsingIOS13ForGmail() const</span>
<span class="line-added">+ {</span>
<span class="line-added">+ #if PLATFORM(IOS_FAMILY)</span>
<span class="line-added">+     if (!needsQuirks())</span>
<span class="line-added">+         return false;</span>
<span class="line-added">+ </span>
<span class="line-added">+     auto&amp; url = m_document-&gt;topDocument().url();</span>
<span class="line-added">+     return equalLettersIgnoringASCIICase(url.host(), &quot;mail.google.com&quot;);</span>
<span class="line-added">+ #else</span>
<span class="line-added">+     return false;</span>
<span class="line-added">+ #endif</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
<span class="line-added">+ bool Quirks::shouldSuppressAutocorrectionAndAutocaptializationInHiddenEditableAreas() const</span>
<span class="line-added">+ {</span>
<span class="line-added">+     if (!needsQuirks())</span>
<span class="line-added">+         return false;</span>
<span class="line-added">+ </span>
<span class="line-added">+     return shouldSuppressAutocorrectionAndAutocaptializationInHiddenEditableAreasForHost(m_document-&gt;topDocument().url().host());</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
<span class="line-added">+ #if ENABLE(TOUCH_EVENTS)</span>
<span class="line-added">+ bool Quirks::isAmazon() const</span>
<span class="line-added">+ {</span>
<span class="line-added">+     return topPrivatelyControlledDomain(m_document-&gt;topDocument().url().host().toString()).startsWith(&quot;amazon.&quot;);</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
<span class="line-added">+ bool Quirks::isGoogleMaps() const</span>
<span class="line-added">+ {</span>
<span class="line-added">+     auto&amp; url = m_document-&gt;topDocument().url();</span>
<span class="line-added">+     return topPrivatelyControlledDomain(url.host().toString()).startsWith(&quot;google.&quot;) &amp;&amp; url.path().startsWithIgnoringASCIICase(&quot;/maps/&quot;);</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
<span class="line-added">+ bool Quirks::shouldDispatchSimulatedMouseEvents() const</span>
<span class="line-added">+ {</span>
<span class="line-added">+     if (RuntimeEnabledFeatures::sharedFeatures().mouseEventsSimulationEnabled())</span>
<span class="line-added">+         return true;</span>
<span class="line-added">+ </span>
<span class="line-added">+     if (!needsQuirks())</span>
<span class="line-added">+         return false;</span>
<span class="line-added">+ </span>
<span class="line-added">+     auto* loader = m_document-&gt;loader();</span>
<span class="line-added">+     if (!loader || loader-&gt;simulatedMouseEventsDispatchPolicy() != SimulatedMouseEventsDispatchPolicy::Allow)</span>
<span class="line-added">+         return false;</span>
<span class="line-added">+ </span>
<span class="line-added">+     if (isAmazon())</span>
<span class="line-added">+         return true;</span>
<span class="line-added">+     if (isGoogleMaps())</span>
<span class="line-added">+         return true;</span>
<span class="line-added">+ </span>
<span class="line-added">+     auto&amp; url = m_document-&gt;topDocument().url();</span>
<span class="line-added">+     auto host = url.host();</span>
<span class="line-added">+ </span>
<span class="line-added">+     if (equalLettersIgnoringASCIICase(host, &quot;wix.com&quot;) || host.endsWithIgnoringASCIICase(&quot;.wix.com&quot;)) {</span>
<span class="line-added">+         // Disable simulated mouse dispatching for template selection.</span>
<span class="line-added">+         return !url.path().startsWithIgnoringASCIICase(&quot;/website/templates/&quot;);</span>
<span class="line-added">+     }</span>
<span class="line-added">+     if ((equalLettersIgnoringASCIICase(host, &quot;desmos.com&quot;) || host.endsWithIgnoringASCIICase(&quot;.desmos.com&quot;)) &amp;&amp; url.path().startsWithIgnoringASCIICase(&quot;/calculator/&quot;))</span>
<span class="line-added">+         return true;</span>
<span class="line-added">+     if (equalLettersIgnoringASCIICase(host, &quot;figma.com&quot;) || host.endsWithIgnoringASCIICase(&quot;.figma.com&quot;))</span>
<span class="line-added">+         return true;</span>
<span class="line-added">+     if (equalLettersIgnoringASCIICase(host, &quot;trello.com&quot;) || host.endsWithIgnoringASCIICase(&quot;.trello.com&quot;))</span>
<span class="line-added">+         return true;</span>
<span class="line-added">+     if (equalLettersIgnoringASCIICase(host, &quot;airtable.com&quot;) || host.endsWithIgnoringASCIICase(&quot;.airtable.com&quot;))</span>
<span class="line-added">+         return true;</span>
<span class="line-added">+     if (equalLettersIgnoringASCIICase(host, &quot;msn.com&quot;) || host.endsWithIgnoringASCIICase(&quot;.msn.com&quot;))</span>
<span class="line-added">+         return true;</span>
<span class="line-added">+     if (equalLettersIgnoringASCIICase(host, &quot;flipkart.com&quot;) || host.endsWithIgnoringASCIICase(&quot;.flipkart.com&quot;))</span>
<span class="line-added">+         return true;</span>
<span class="line-added">+     if (equalLettersIgnoringASCIICase(host, &quot;iqiyi.com&quot;) || host.endsWithIgnoringASCIICase(&quot;.iqiyi.com&quot;))</span>
<span class="line-added">+         return true;</span>
<span class="line-added">+     if (equalLettersIgnoringASCIICase(host, &quot;trailers.apple.com&quot;))</span>
<span class="line-added">+         return true;</span>
<span class="line-added">+     if (equalLettersIgnoringASCIICase(host, &quot;soundcloud.com&quot;))</span>
<span class="line-added">+         return true;</span>
<span class="line-added">+     if (equalLettersIgnoringASCIICase(host, &quot;naver.com&quot;))</span>
<span class="line-added">+         return true;</span>
<span class="line-added">+     if (host.endsWithIgnoringASCIICase(&quot;.naver.com&quot;)) {</span>
<span class="line-added">+         // Disable the quirk for tv.naver.com subdomain to be able to simulate hover on videos.</span>
<span class="line-added">+         if (equalLettersIgnoringASCIICase(host, &quot;tv.naver.com&quot;))</span>
<span class="line-added">+             return false;</span>
<span class="line-added">+         // Disable the quirk for mail.naver.com subdomain to be able to tap on mail subjects.</span>
<span class="line-added">+         if (equalLettersIgnoringASCIICase(host, &quot;mail.naver.com&quot;))</span>
<span class="line-added">+             return false;</span>
<span class="line-added">+         // Disable the quirk on the mobile site.</span>
<span class="line-added">+         // FIXME: Maybe this quirk should be disabled for &quot;m.&quot; subdomains on all sites? These are generally mobile sites that don&#39;t need mouse events.</span>
<span class="line-added">+         if (equalLettersIgnoringASCIICase(host, &quot;m.naver.com&quot;))</span>
<span class="line-added">+             return false;</span>
<span class="line-added">+         return true;</span>
<span class="line-added">+     }</span>
<span class="line-added">+     return false;</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
<span class="line-added">+ bool Quirks::shouldDispatchedSimulatedMouseEventsAssumeDefaultPrevented(EventTarget* target) const</span>
<span class="line-added">+ {</span>
<span class="line-added">+     if (!needsQuirks() || !shouldDispatchSimulatedMouseEvents())</span>
<span class="line-added">+         return false;</span>
<span class="line-added">+ </span>
<span class="line-added">+     if (isAmazon() &amp;&amp; is&lt;Element&gt;(target)) {</span>
<span class="line-added">+         // When panning on an Amazon product image, we&#39;re either touching on the #magnifierLens element</span>
<span class="line-added">+         // or its previous sibling.</span>
<span class="line-added">+         auto&amp; element = downcast&lt;Element&gt;(*target);</span>
<span class="line-added">+         if (element.getIdAttribute() == &quot;magnifierLens&quot;)</span>
<span class="line-added">+             return true;</span>
<span class="line-added">+         if (auto* sibling = element.nextElementSibling())</span>
<span class="line-added">+             return sibling-&gt;getIdAttribute() == &quot;magnifierLens&quot;;</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     if (equalLettersIgnoringASCIICase(m_document-&gt;topDocument().url().host(), &quot;soundcloud.com&quot;) &amp;&amp; is&lt;Element&gt;(target))</span>
<span class="line-added">+         return downcast&lt;Element&gt;(*target).classList().contains(&quot;sceneLayer&quot;);</span>
<span class="line-added">+ </span>
<span class="line-added">+     return false;</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
<span class="line-added">+ Optional&lt;Event::IsCancelable&gt; Quirks::simulatedMouseEventTypeForTarget(EventTarget* target) const</span>
<span class="line-added">+ {</span>
<span class="line-added">+     if (!shouldDispatchSimulatedMouseEvents())</span>
<span class="line-added">+         return { };</span>
<span class="line-added">+ </span>
<span class="line-added">+     // On Google Maps, we want to limit simulated mouse events to dragging the little man that allows entering into Street View.</span>
<span class="line-added">+     if (isGoogleMaps()) {</span>
<span class="line-added">+         if (is&lt;Element&gt;(target) &amp;&amp; downcast&lt;Element&gt;(target)-&gt;getAttribute(&quot;class&quot;) == &quot;widget-expand-button-pegman-icon&quot;)</span>
<span class="line-added">+             return Event::IsCancelable::Yes;</span>
<span class="line-added">+         return { };</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     auto host = m_document-&gt;topDocument().url().host();</span>
<span class="line-added">+     if (equalLettersIgnoringASCIICase(host, &quot;desmos.com&quot;) || host.endsWithIgnoringASCIICase(&quot;.desmos.com&quot;))</span>
<span class="line-added">+         return Event::IsCancelable::No;</span>
<span class="line-added">+ </span>
<span class="line-added">+     return Event::IsCancelable::Yes;</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
<span class="line-added">+ bool Quirks::shouldMakeTouchEventNonCancelableForTarget(EventTarget* target) const</span>
<span class="line-added">+ {</span>
<span class="line-added">+     if (!needsQuirks())</span>
<span class="line-added">+         return false;</span>
<span class="line-added">+ </span>
<span class="line-added">+     auto host = m_document-&gt;topDocument().url().host();</span>
<span class="line-added">+ </span>
<span class="line-added">+     if (equalLettersIgnoringASCIICase(host, &quot;www.youtube.com&quot;)) {</span>
<span class="line-added">+         if (is&lt;Element&gt;(target)) {</span>
<span class="line-added">+             unsigned depth = 3;</span>
<span class="line-added">+             for (auto* element = downcast&lt;Element&gt;(target); element &amp;&amp; depth; element = element-&gt;parentElement(), --depth) {</span>
<span class="line-added">+                 if (element-&gt;localName() == &quot;paper-item&quot; &amp;&amp; element-&gt;classList().contains(&quot;yt-dropdown-menu&quot;))</span>
<span class="line-added">+                     return true;</span>
<span class="line-added">+             }</span>
<span class="line-added">+         }</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     return false;</span>
<span class="line-added">+ }</span>
<span class="line-added">+ #endif</span>
<span class="line-added">+ </span>
<span class="line-added">+ bool Quirks::shouldAvoidResizingWhenInputViewBoundsChange() const</span>
<span class="line-added">+ {</span>
<span class="line-added">+     if (!needsQuirks())</span>
<span class="line-added">+         return false;</span>
<span class="line-added">+ </span>
<span class="line-added">+     auto host = m_document-&gt;topDocument().url().host();</span>
<span class="line-added">+     if (equalLettersIgnoringASCIICase(host, &quot;live.com&quot;) || host.endsWithIgnoringASCIICase(&quot;.live.com&quot;))</span>
<span class="line-added">+         return true;</span>
<span class="line-added">+ </span>
<span class="line-added">+     if (host.endsWithIgnoringASCIICase(&quot;.sharepoint.com&quot;))</span>
<span class="line-added">+         return true;</span>
<span class="line-added">+ </span>
<span class="line-added">+     return false;</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
<span class="line-added">+ bool Quirks::shouldDisablePointerEventsQuirk() const</span>
<span class="line-added">+ {</span>
<span class="line-added">+ #if PLATFORM(IOS_FAMILY)</span>
<span class="line-added">+     if (!needsQuirks())</span>
<span class="line-added">+         return false;</span>
<span class="line-added">+ </span>
<span class="line-added">+     auto&amp; url = m_document-&gt;topDocument().url();</span>
<span class="line-added">+     auto host = url.host();</span>
<span class="line-added">+     if (equalLettersIgnoringASCIICase(host, &quot;mailchimp.com&quot;) || host.endsWithIgnoringASCIICase(&quot;.mailchimp.com&quot;))</span>
<span class="line-added">+         return true;</span>
<span class="line-added">+ #endif</span>
<span class="line-added">+     return false;</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
<span class="line-added">+ bool Quirks::needsDeferKeyDownAndKeyPressTimersUntilNextEditingCommand() const</span>
<span class="line-added">+ {</span>
<span class="line-added">+ #if PLATFORM(IOS_FAMILY)</span>
<span class="line-added">+     if (m_document-&gt;settings().needsDeferKeyDownAndKeyPressTimersUntilNextEditingCommandQuirk())</span>
<span class="line-added">+         return true;</span>
<span class="line-added">+ </span>
<span class="line-added">+     if (!needsQuirks())</span>
<span class="line-added">+         return false;</span>
<span class="line-added">+ </span>
<span class="line-added">+     auto&amp; url = m_document-&gt;topDocument().url();</span>
<span class="line-added">+     return equalLettersIgnoringASCIICase(url.host(), &quot;docs.google.com&quot;) &amp;&amp; url.path().startsWithIgnoringASCIICase(&quot;/spreadsheets/&quot;);</span>
<span class="line-added">+ #else</span>
<span class="line-added">+     return false;</span>
<span class="line-added">+ #endif</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
<span class="line-added">+ bool Quirks::shouldLightenJapaneseBoldSansSerif() const</span>
<span class="line-added">+ {</span>
<span class="line-added">+ #if USE(HIRAGINO_SANS_WORKAROUND)</span>
<span class="line-added">+     if (!needsQuirks())</span>
<span class="line-added">+         return false;</span>
<span class="line-added">+ </span>
<span class="line-added">+     // lang=&quot;ja&quot; style=&quot;font: bold sans-serif;&quot; content would naturally get HiraginoSans-W8 here, but that&#39;s visually</span>
<span class="line-added">+     // too bold. Instead, we should pick HiraginoSans-W6 instead.</span>
<span class="line-added">+     // FIXME: webkit.org/b/200047 Remove this quirk.</span>
<span class="line-added">+     auto host = m_document-&gt;topDocument().url().host();</span>
<span class="line-added">+     return equalLettersIgnoringASCIICase(host, &quot;m.yahoo.co.jp&quot;);</span>
<span class="line-added">+ #else</span>
<span class="line-added">+     return false;</span>
<span class="line-added">+ #endif</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
<span class="line-added">+ bool Quirks::shouldIgnoreContentChange(const Element&amp; element) const</span>
<span class="line-added">+ {</span>
<span class="line-added">+ #if PLATFORM(IOS_FAMILY)</span>
<span class="line-added">+     if (!needsQuirks())</span>
<span class="line-added">+         return false;</span>
<span class="line-added">+ </span>
<span class="line-added">+     auto* parentElement = element.parentElement();</span>
<span class="line-added">+     if (!parentElement || !parentElement-&gt;hasClass())</span>
<span class="line-added">+         return false;</span>
<span class="line-added">+ </span>
<span class="line-added">+     DOMTokenList&amp; classList = parentElement-&gt;classList();</span>
<span class="line-added">+     if (!classList.contains(&quot;feedback&quot;) || !classList.contains(&quot;feedback-mid&quot;))</span>
<span class="line-added">+         return false;</span>
<span class="line-added">+ </span>
<span class="line-added">+     if (!equalLettersIgnoringASCIICase(topPrivatelyControlledDomain(m_document-&gt;url().host().toString()), &quot;united.com&quot;))</span>
<span class="line-added">+         return false;</span>
<span class="line-added">+ </span>
<span class="line-added">+     return true;</span>
<span class="line-added">+ #else</span>
<span class="line-added">+     UNUSED_PARAM(element);</span>
<span class="line-added">+     return false;</span>
<span class="line-added">+ #endif</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
<span class="line-added">+ // FIXME(&lt;rdar://problem/50394969&gt;): Remove after desmos.com adopts inputmode=&quot;none&quot;.</span>
<span class="line-added">+ bool Quirks::needsInputModeNoneImplicitly(const HTMLElement&amp; element) const</span>
<span class="line-added">+ {</span>
<span class="line-added">+ #if PLATFORM(IOS_FAMILY)</span>
<span class="line-added">+     if (!needsQuirks())</span>
<span class="line-added">+         return false;</span>
<span class="line-added">+ </span>
<span class="line-added">+     if (element.hasTagName(HTMLNames::inputTag)) {</span>
<span class="line-added">+         if (!equalLettersIgnoringASCIICase(m_document-&gt;url().host(), &quot;calendar.google.com&quot;))</span>
<span class="line-added">+             return false;</span>
<span class="line-added">+         static NeverDestroyed&lt;QualifiedName&gt; dataInitialValueAttr(nullAtom(), &quot;data-initial-value&quot;, nullAtom());</span>
<span class="line-added">+         static NeverDestroyed&lt;QualifiedName&gt; dataPreviousValueAttr(nullAtom(), &quot;data-previous-value&quot;, nullAtom());</span>
<span class="line-added">+ </span>
<span class="line-added">+         return equalLettersIgnoringASCIICase(element.attributeWithoutSynchronization(HTMLNames::autocompleteAttr), &quot;off&quot;)</span>
<span class="line-added">+             &amp;&amp; element.hasAttributeWithoutSynchronization(dataInitialValueAttr)</span>
<span class="line-added">+             &amp;&amp; element.hasAttributeWithoutSynchronization(dataPreviousValueAttr);</span>
<span class="line-added">+     }</span>
<span class="line-added">+ </span>
<span class="line-added">+     if (!element.hasTagName(HTMLNames::textareaTag))</span>
<span class="line-added">+         return false;</span>
<span class="line-added">+ </span>
<span class="line-added">+     auto&amp; url = m_document-&gt;url();</span>
<span class="line-added">+     auto host = url.host();</span>
<span class="line-added">+     if (!host.endsWithIgnoringASCIICase(&quot;.desmos.com&quot;))</span>
<span class="line-added">+         return false;</span>
<span class="line-added">+ </span>
<span class="line-added">+     return element.parentElement() &amp;&amp; element.parentElement()-&gt;classNames().contains(&quot;dcg-mq-textarea&quot;);</span>
<span class="line-added">+ #else</span>
<span class="line-added">+     UNUSED_PARAM(element);</span>
<span class="line-added">+     return false;</span>
<span class="line-added">+ #endif</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
<span class="line-added">+ // FIXME: Remove after the site is fixed, &lt;rdar://problem/50374200&gt;</span>
<span class="line-added">+ bool Quirks::needsGMailOverflowScrollQuirk() const</span>
<span class="line-added">+ {</span>
<span class="line-added">+ #if PLATFORM(IOS_FAMILY)</span>
<span class="line-added">+     if (!needsQuirks())</span>
<span class="line-added">+         return false;</span>
<span class="line-added">+ </span>
<span class="line-added">+     if (!m_needsGMailOverflowScrollQuirk)</span>
<span class="line-added">+         m_needsGMailOverflowScrollQuirk = equalLettersIgnoringASCIICase(m_document-&gt;url().host(), &quot;mail.google.com&quot;);</span>
<span class="line-added">+ </span>
<span class="line-added">+     return *m_needsGMailOverflowScrollQuirk;</span>
<span class="line-added">+ #else</span>
<span class="line-added">+     return false;</span>
<span class="line-added">+ #endif</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
<span class="line-added">+ // FIXME: Remove after the site is fixed, &lt;rdar://problem/50374311&gt;</span>
<span class="line-added">+ bool Quirks::needsYouTubeOverflowScrollQuirk() const</span>
<span class="line-added">+ {</span>
<span class="line-added">+ #if PLATFORM(IOS_FAMILY)</span>
<span class="line-added">+     if (!needsQuirks())</span>
<span class="line-added">+         return false;</span>
<span class="line-added">+ </span>
<span class="line-added">+     if (!m_needsYouTubeOverflowScrollQuirk)</span>
<span class="line-added">+         m_needsYouTubeOverflowScrollQuirk = equalLettersIgnoringASCIICase(m_document-&gt;url().host(), &quot;www.youtube.com&quot;);</span>
<span class="line-added">+ </span>
<span class="line-added">+     return *m_needsYouTubeOverflowScrollQuirk;</span>
<span class="line-added">+ #else</span>
<span class="line-added">+     return false;</span>
<span class="line-added">+ #endif</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
<span class="line-added">+ bool Quirks::shouldAvoidScrollingWhenFocusedContentIsVisible() const</span>
<span class="line-added">+ {</span>
<span class="line-added">+     if (!needsQuirks())</span>
<span class="line-added">+         return false;</span>
<span class="line-added">+ </span>
<span class="line-added">+     return equalLettersIgnoringASCIICase(m_document-&gt;url().host(), &quot;www.zillow.com&quot;);</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
<span class="line-added">+ bool Quirks::shouldOpenAsAboutBlank(const String&amp; stringToOpen) const</span>
<span class="line-added">+ {</span>
<span class="line-added">+ #if PLATFORM(IOS_FAMILY)</span>
<span class="line-added">+     if (!needsQuirks())</span>
<span class="line-added">+         return false;</span>
<span class="line-added">+ </span>
<span class="line-added">+     auto openerURL = m_document-&gt;url();</span>
<span class="line-added">+     if (!equalLettersIgnoringASCIICase(openerURL.host(), &quot;docs.google.com&quot;))</span>
<span class="line-added">+         return false;</span>
<span class="line-added">+ </span>
<span class="line-added">+     if (!m_document-&gt;frame() || !m_document-&gt;frame()-&gt;loader().userAgentForJavaScript(openerURL).contains(&quot;Macintosh&quot;))</span>
<span class="line-added">+         return false;</span>
<span class="line-added">+ </span>
<span class="line-added">+     URL urlToOpen { URL { }, stringToOpen };</span>
<span class="line-added">+     if (!urlToOpen.protocolIsAbout())</span>
<span class="line-added">+         return false;</span>
<span class="line-added">+ </span>
<span class="line-added">+     return !equalLettersIgnoringASCIICase(urlToOpen.host(), &quot;blank&quot;) &amp;&amp; !equalLettersIgnoringASCIICase(urlToOpen.host(), &quot;srcdoc&quot;);</span>
<span class="line-added">+ #else</span>
<span class="line-added">+     UNUSED_PARAM(stringToOpen);</span>
<span class="line-added">+     return false;</span>
<span class="line-added">+ #endif</span>
<span class="line-added">+ }</span>
<span class="line-added">+ </span>
  }
</pre>
<center><a href="ProcessWarming.cpp.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../index.html" target="_top">index</a> <a href="Quirks.h.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>