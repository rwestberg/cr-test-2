<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames modules/javafx.web/src/main/native/Source/WebCore/page/ContextMenuController.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>   1 /*
   2  * Copyright (C) 2006-2016 Apple Inc. All rights reserved.
   3  * Copyright (C) 2010 Igalia S.L
   4  *
   5  * Redistribution and use in source and binary forms, with or without
   6  * modification, are permitted provided that the following conditions
   7  * are met:
   8  * 1. Redistributions of source code must retain the above copyright
   9  *    notice, this list of conditions and the following disclaimer.
  10  * 2. Redistributions in binary form must reproduce the above copyright
  11  *    notice, this list of conditions and the following disclaimer in the
  12  *    documentation and/or other materials provided with the distribution.
  13  *
  14  * THIS SOFTWARE IS PROVIDED BY APPLE INC. ``AS IS&#39;&#39; AND ANY
  15  * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
  16  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
  17  * PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL APPLE INC. OR
  18  * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
  19  * EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
  20  * PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
  21  * PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY
  22  * OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
  23  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
  24  * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
  25  */
  26 
  27 #include &quot;config.h&quot;
  28 #include &quot;ContextMenuController.h&quot;
  29 
  30 #if ENABLE(CONTEXT_MENUS)
  31 
  32 #include &quot;BackForwardController.h&quot;
  33 #include &quot;Chrome.h&quot;
  34 #include &quot;ContextMenu.h&quot;
  35 #include &quot;ContextMenuClient.h&quot;
  36 #include &quot;ContextMenuItem.h&quot;
  37 #include &quot;ContextMenuProvider.h&quot;
<a name="1" id="anc1"></a>
  38 #include &quot;Document.h&quot;
  39 #include &quot;DocumentFragment.h&quot;
  40 #include &quot;DocumentLoader.h&quot;
  41 #include &quot;Editor.h&quot;
  42 #include &quot;EditorClient.h&quot;
  43 #include &quot;Event.h&quot;
  44 #include &quot;EventHandler.h&quot;
  45 #include &quot;FormState.h&quot;
  46 #include &quot;Frame.h&quot;
  47 #include &quot;FrameLoadRequest.h&quot;
  48 #include &quot;FrameLoader.h&quot;
  49 #include &quot;FrameLoaderClient.h&quot;
  50 #include &quot;FrameSelection.h&quot;
  51 #include &quot;HTMLFormControlElement.h&quot;
  52 #include &quot;HTMLFormElement.h&quot;
  53 #include &quot;HitTestRequest.h&quot;
  54 #include &quot;HitTestResult.h&quot;
  55 #include &quot;InspectorController.h&quot;
  56 #include &quot;LocalizedStrings.h&quot;
  57 #include &quot;MouseEvent.h&quot;
  58 #include &quot;NavigationAction.h&quot;
  59 #include &quot;Node.h&quot;
  60 #include &quot;Page.h&quot;
  61 #include &quot;PlatformEvent.h&quot;
  62 #include &quot;RenderImage.h&quot;
  63 #include &quot;ReplaceSelectionCommand.h&quot;
  64 #include &quot;ResourceRequest.h&quot;
  65 #include &quot;Settings.h&quot;
  66 #include &quot;TextIterator.h&quot;
  67 #include &quot;TypingCommand.h&quot;
  68 #include &quot;UserTypingGestureIndicator.h&quot;
  69 #include &quot;WindowFeatures.h&quot;
  70 #include &quot;markup.h&quot;
  71 #include &lt;wtf/SetForScope.h&gt;
  72 #include &lt;wtf/WallTime.h&gt;
  73 #include &lt;wtf/unicode/CharacterNames.h&gt;
  74 
  75 
  76 namespace WebCore {
  77 
  78 using namespace WTF::Unicode;
  79 
  80 ContextMenuController::ContextMenuController(Page&amp; page, ContextMenuClient&amp; client)
  81     : m_page(page)
  82     , m_client(client)
  83 {
  84 }
  85 
  86 ContextMenuController::~ContextMenuController()
  87 {
  88     m_client.contextMenuDestroyed();
  89 }
  90 
  91 void ContextMenuController::clearContextMenu()
  92 {
  93     m_contextMenu = nullptr;
  94     if (m_menuProvider)
  95         m_menuProvider-&gt;contextMenuCleared();
  96     m_menuProvider = nullptr;
  97 }
  98 
  99 void ContextMenuController::handleContextMenuEvent(Event&amp; event)
 100 {
 101     if (m_isHandlingContextMenuEvent)
 102         return;
 103 
 104     SetForScope&lt;bool&gt; isHandlingContextMenuEventForScope(m_isHandlingContextMenuEvent, true);
 105 
 106     m_contextMenu = maybeCreateContextMenu(event);
 107     if (!m_contextMenu)
 108         return;
 109 
 110     populate();
 111 
 112     showContextMenu(event);
 113 }
 114 
 115 static std::unique_ptr&lt;ContextMenuItem&gt; separatorItem()
 116 {
 117     return std::unique_ptr&lt;ContextMenuItem&gt;(new ContextMenuItem(SeparatorType, ContextMenuItemTagNoAction, String()));
 118 }
 119 
 120 void ContextMenuController::showContextMenu(Event&amp; event, ContextMenuProvider&amp; provider)
 121 {
 122     m_menuProvider = &amp;provider;
 123 
 124     m_contextMenu = maybeCreateContextMenu(event);
 125     if (!m_contextMenu) {
 126         clearContextMenu();
 127         return;
 128     }
 129 
 130     provider.populateContextMenu(m_contextMenu.get());
 131     if (m_context.hitTestResult().isSelected()) {
 132         appendItem(*separatorItem(), m_contextMenu.get());
 133         populate();
 134     }
 135     showContextMenu(event);
 136 }
 137 
 138 #if ENABLE(SERVICE_CONTROLS)
 139 
 140 static Image* imageFromImageElementNode(Node&amp; node)
 141 {
 142     auto* renderer = node.renderer();
 143     if (!is&lt;RenderImage&gt;(renderer))
 144         return nullptr;
 145     auto* image = downcast&lt;RenderImage&gt;(*renderer).cachedImage();
 146     if (!image || image-&gt;errorOccurred())
 147         return nullptr;
 148     return image-&gt;imageForRenderer(renderer);
 149 }
 150 
 151 #endif
 152 
 153 std::unique_ptr&lt;ContextMenu&gt; ContextMenuController::maybeCreateContextMenu(Event&amp; event)
 154 {
 155     if (!is&lt;MouseEvent&gt;(event))
 156         return nullptr;
 157 
 158     auto&amp; mouseEvent = downcast&lt;MouseEvent&gt;(event);
 159     if (!is&lt;Node&gt;(mouseEvent.target()))
 160         return nullptr;
 161     auto&amp; node = downcast&lt;Node&gt;(*mouseEvent.target());
 162     auto* frame = node.document().frame();
 163     if (!frame)
 164         return nullptr;
 165 
<a name="2" id="anc2"></a><span class="line-modified"> 166     auto result = frame-&gt;eventHandler().hitTestResultAtPoint(mouseEvent.absoluteLocation());</span>
 167     if (!result.innerNonSharedNode())
 168         return nullptr;
 169 
 170     m_context = ContextMenuContext(result);
 171 
 172 #if ENABLE(SERVICE_CONTROLS)
 173     if (node.isImageControlsButtonElement()) {
 174         if (auto* image = imageFromImageElementNode(*result.innerNonSharedNode()))
 175             m_context.setControlledImage(image);
 176 
 177         // FIXME: If we couldn&#39;t get the image then we shouldn&#39;t try to show the image controls menu for it.
 178         return nullptr;
 179     }
 180 #endif
 181 
<a name="3" id="anc3"></a><span class="line-modified"> 182     return std::make_unique&lt;ContextMenu&gt;();</span>
 183 }
 184 
 185 void ContextMenuController::showContextMenu(Event&amp; event)
 186 {
 187     if (m_page.inspectorController().enabled())
 188         addInspectElementItem();
 189 
 190     event.setDefaultHandled();
 191 }
 192 
 193 static void openNewWindow(const URL&amp; urlToLoad, Frame&amp; frame, ShouldOpenExternalURLsPolicy shouldOpenExternalURLsPolicy)
 194 {
 195     Page* oldPage = frame.page();
 196     if (!oldPage)
 197         return;
 198 
 199     FrameLoadRequest frameLoadRequest { *frame.document(), frame.document()-&gt;securityOrigin(), ResourceRequest(urlToLoad, frame.loader().outgoingReferrer()), { }, LockHistory::No, LockBackForwardList::No, MaybeSendReferrer, AllowNavigationToInvalidURL::Yes, NewFrameOpenerPolicy::Suppress, shouldOpenExternalURLsPolicy, InitiatedByMainFrame::Unknown };
 200 
 201     Page* newPage = oldPage-&gt;chrome().createWindow(frame, frameLoadRequest, { }, { *frame.document(), frameLoadRequest.resourceRequest(), frameLoadRequest.initiatedByMainFrame() });
 202     if (!newPage)
 203         return;
 204     newPage-&gt;chrome().show();
 205     newPage-&gt;mainFrame().loader().loadFrameRequest(WTFMove(frameLoadRequest), nullptr, { });
 206 }
 207 
 208 #if PLATFORM(GTK)
 209 
 210 static void insertUnicodeCharacter(UChar character, Frame&amp; frame)
 211 {
 212     String text(&amp;character, 1);
 213     if (!frame.editor().shouldInsertText(text, frame.selection().toNormalizedRange().get(), EditorInsertAction::Typed))
 214         return;
 215 
 216     ASSERT(frame.document());
 217     TypingCommand::insertText(*frame.document(), text, 0, TypingCommand::TextCompositionNone);
 218 }
 219 
 220 #endif
 221 
 222 void ContextMenuController::contextMenuItemSelected(ContextMenuAction action, const String&amp; title)
 223 {
 224     if (action &gt;= ContextMenuItemBaseCustomTag) {
 225         ASSERT(m_menuProvider);
 226         m_menuProvider-&gt;contextMenuItemSelected(action, title);
 227         return;
 228     }
 229 
 230     Frame* frame = m_context.hitTestResult().innerNonSharedNode()-&gt;document().frame();
 231     if (!frame)
 232         return;
 233 
 234     Ref&lt;Frame&gt; protector(*frame);
 235 
 236     switch (action) {
 237     case ContextMenuItemTagOpenLinkInNewWindow:
 238         openNewWindow(m_context.hitTestResult().absoluteLinkURL(), *frame, ShouldOpenExternalURLsPolicy::ShouldAllowExternalSchemes);
 239         break;
 240     case ContextMenuItemTagDownloadLinkToDisk:
 241         // FIXME: Some day we should be able to do this from within WebCore. (Bug 117709)
 242         m_client.downloadURL(m_context.hitTestResult().absoluteLinkURL());
 243         break;
 244     case ContextMenuItemTagCopyLinkToClipboard:
 245         frame-&gt;editor().copyURL(m_context.hitTestResult().absoluteLinkURL(), m_context.hitTestResult().textContent());
 246         break;
 247     case ContextMenuItemTagOpenImageInNewWindow:
 248         openNewWindow(m_context.hitTestResult().absoluteImageURL(), *frame, ShouldOpenExternalURLsPolicy::ShouldNotAllow);
 249         break;
 250     case ContextMenuItemTagDownloadImageToDisk:
 251         // FIXME: Some day we should be able to do this from within WebCore. (Bug 117709)
 252         m_client.downloadURL(m_context.hitTestResult().absoluteImageURL());
 253         break;
 254     case ContextMenuItemTagCopyImageToClipboard:
 255         // FIXME: The Pasteboard class is not written yet
 256         // For now, call into the client. This is temporary!
 257         frame-&gt;editor().copyImage(m_context.hitTestResult());
 258         break;
 259 #if PLATFORM(GTK)
 260     case ContextMenuItemTagCopyImageUrlToClipboard:
 261         frame-&gt;editor().copyURL(m_context.hitTestResult().absoluteImageURL(), m_context.hitTestResult().textContent());
 262         break;
 263 #endif
 264     case ContextMenuItemTagOpenMediaInNewWindow:
 265         openNewWindow(m_context.hitTestResult().absoluteMediaURL(), *frame, ShouldOpenExternalURLsPolicy::ShouldNotAllow);
 266         break;
 267     case ContextMenuItemTagDownloadMediaToDisk:
 268         // FIXME: Some day we should be able to do this from within WebCore. (Bug 117709)
 269         m_client.downloadURL(m_context.hitTestResult().absoluteMediaURL());
 270         break;
 271     case ContextMenuItemTagCopyMediaLinkToClipboard:
 272         frame-&gt;editor().copyURL(m_context.hitTestResult().absoluteMediaURL(), m_context.hitTestResult().textContent());
 273         break;
 274     case ContextMenuItemTagToggleMediaControls:
 275         m_context.hitTestResult().toggleMediaControlsDisplay();
 276         break;
 277     case ContextMenuItemTagToggleMediaLoop:
 278         m_context.hitTestResult().toggleMediaLoopPlayback();
 279         break;
 280     case ContextMenuItemTagToggleVideoFullscreen:
 281         m_context.hitTestResult().toggleMediaFullscreenState();
 282         break;
 283     case ContextMenuItemTagEnterVideoFullscreen:
 284         m_context.hitTestResult().enterFullscreenForVideo();
 285         break;
 286     case ContextMenuItemTagMediaPlayPause:
 287         m_context.hitTestResult().toggleMediaPlayState();
 288         break;
 289     case ContextMenuItemTagMediaMute:
 290         m_context.hitTestResult().toggleMediaMuteState();
 291         break;
 292     case ContextMenuItemTagToggleVideoEnhancedFullscreen:
 293         m_context.hitTestResult().toggleEnhancedFullscreenForVideo();
 294         break;
 295     case ContextMenuItemTagOpenFrameInNewWindow: {
 296         DocumentLoader* loader = frame-&gt;loader().documentLoader();
 297         if (!loader-&gt;unreachableURL().isEmpty())
 298             openNewWindow(loader-&gt;unreachableURL(), *frame, ShouldOpenExternalURLsPolicy::ShouldNotAllow);
 299         else
 300             openNewWindow(loader-&gt;url(), *frame, ShouldOpenExternalURLsPolicy::ShouldNotAllow);
 301         break;
 302     }
 303     case ContextMenuItemTagCopy:
 304         frame-&gt;editor().copy();
 305         break;
 306     case ContextMenuItemTagGoBack:
 307         if (Page* page = frame-&gt;page())
 308             page-&gt;backForward().goBackOrForward(-1);
 309         break;
 310     case ContextMenuItemTagGoForward:
 311         if (Page* page = frame-&gt;page())
 312             page-&gt;backForward().goBackOrForward(1);
 313         break;
 314     case ContextMenuItemTagStop:
 315         frame-&gt;loader().stop();
 316         break;
 317     case ContextMenuItemTagReload:
 318         frame-&gt;loader().reload();
 319         break;
 320     case ContextMenuItemTagCut:
 321         frame-&gt;editor().command(&quot;Cut&quot;).execute();
 322         break;
 323     case ContextMenuItemTagPaste:
 324         frame-&gt;editor().command(&quot;Paste&quot;).execute();
 325         break;
 326 #if PLATFORM(GTK)
 327     case ContextMenuItemTagDelete:
 328         frame-&gt;editor().performDelete();
 329         break;
 330     case ContextMenuItemTagUnicodeInsertLRMMark:
 331         insertUnicodeCharacter(leftToRightMark, *frame);
 332         break;
 333     case ContextMenuItemTagUnicodeInsertRLMMark:
 334         insertUnicodeCharacter(rightToLeftMark, *frame);
 335         break;
 336     case ContextMenuItemTagUnicodeInsertLREMark:
 337         insertUnicodeCharacter(leftToRightEmbed, *frame);
 338         break;
 339     case ContextMenuItemTagUnicodeInsertRLEMark:
 340         insertUnicodeCharacter(rightToLeftEmbed, *frame);
 341         break;
 342     case ContextMenuItemTagUnicodeInsertLROMark:
 343         insertUnicodeCharacter(leftToRightOverride, *frame);
 344         break;
 345     case ContextMenuItemTagUnicodeInsertRLOMark:
 346         insertUnicodeCharacter(rightToLeftOverride, *frame);
 347         break;
 348     case ContextMenuItemTagUnicodeInsertPDFMark:
 349         insertUnicodeCharacter(popDirectionalFormatting, *frame);
 350         break;
 351     case ContextMenuItemTagUnicodeInsertZWSMark:
 352         insertUnicodeCharacter(zeroWidthSpace, *frame);
 353         break;
 354     case ContextMenuItemTagUnicodeInsertZWJMark:
 355         insertUnicodeCharacter(zeroWidthJoiner, *frame);
 356         break;
 357     case ContextMenuItemTagUnicodeInsertZWNJMark:
 358         insertUnicodeCharacter(zeroWidthNonJoiner, *frame);
 359         break;
<a name="4" id="anc4"></a><span class="line-removed"> 360 #endif</span>
<span class="line-removed"> 361 #if PLATFORM(GTK)</span>
 362     case ContextMenuItemTagSelectAll:
 363         frame-&gt;editor().command(&quot;SelectAll&quot;).execute();
 364         break;
<a name="5" id="anc5"></a>


 365 #endif
 366     case ContextMenuItemTagSpellingGuess: {
 367         VisibleSelection selection = frame-&gt;selection().selection();
 368         if (frame-&gt;editor().shouldInsertText(title, selection.toNormalizedRange().get(), EditorInsertAction::Pasted)) {
 369             OptionSet&lt;ReplaceSelectionCommand::CommandOption&gt; replaceOptions { ReplaceSelectionCommand::MatchStyle, ReplaceSelectionCommand::PreventNesting };
 370 
 371             if (frame-&gt;editor().behavior().shouldAllowSpellingSuggestionsWithoutSelection()) {
 372                 ASSERT(selection.isCaretOrRange());
 373                 VisibleSelection wordSelection(selection.base());
 374                 wordSelection.expandUsingGranularity(WordGranularity);
 375                 frame-&gt;selection().setSelection(wordSelection);
 376             } else {
 377                 ASSERT(frame-&gt;editor().selectedText().length());
 378                 replaceOptions.add(ReplaceSelectionCommand::SelectReplacement);
 379             }
 380 
 381             Document* document = frame-&gt;document();
 382             ASSERT(document);
 383             auto command = ReplaceSelectionCommand::create(*document, createFragmentFromMarkup(*document, title, emptyString()), replaceOptions);
 384             command-&gt;apply();
 385             frame-&gt;selection().revealSelection(SelectionRevealMode::Reveal, ScrollAlignment::alignToEdgeIfNeeded);
 386         }
 387         break;
 388     }
 389     case ContextMenuItemTagIgnoreSpelling:
 390         frame-&gt;editor().ignoreSpelling();
 391         break;
 392     case ContextMenuItemTagLearnSpelling:
 393         frame-&gt;editor().learnSpelling();
 394         break;
 395     case ContextMenuItemTagSearchWeb:
 396         m_client.searchWithGoogle(frame);
 397         break;
 398     case ContextMenuItemTagLookUpInDictionary:
 399         // FIXME: Some day we may be able to do this from within WebCore.
 400         m_client.lookUpInDictionary(frame);
 401         break;
 402     case ContextMenuItemTagOpenLink:
 403         if (Frame* targetFrame = m_context.hitTestResult().targetFrame()) {
 404             ResourceRequest resourceRequest { m_context.hitTestResult().absoluteLinkURL(), frame-&gt;loader().outgoingReferrer() };
 405             FrameLoadRequest frameLoadRequest { *frame-&gt;document(), frame-&gt;document()-&gt;securityOrigin(), resourceRequest, { }, LockHistory::No, LockBackForwardList::No, MaybeSendReferrer, AllowNavigationToInvalidURL::Yes, NewFrameOpenerPolicy::Suppress, targetFrame-&gt;isMainFrame() ? ShouldOpenExternalURLsPolicy::ShouldAllow : ShouldOpenExternalURLsPolicy::ShouldNotAllow, InitiatedByMainFrame::Unknown };
 406             targetFrame-&gt;loader().loadFrameRequest(WTFMove(frameLoadRequest), nullptr,  { });
 407         } else
 408             openNewWindow(m_context.hitTestResult().absoluteLinkURL(), *frame, ShouldOpenExternalURLsPolicy::ShouldAllow);
 409         break;
 410     case ContextMenuItemTagBold:
 411         frame-&gt;editor().command(&quot;ToggleBold&quot;).execute();
 412         break;
 413     case ContextMenuItemTagItalic:
 414         frame-&gt;editor().command(&quot;ToggleItalic&quot;).execute();
 415         break;
 416     case ContextMenuItemTagUnderline:
 417         frame-&gt;editor().toggleUnderline();
 418         break;
 419     case ContextMenuItemTagOutline:
 420         // We actually never enable this because CSS does not have a way to specify an outline font,
 421         // which may make this difficult to implement. Maybe a special case of text-shadow?
 422         break;
 423     case ContextMenuItemTagStartSpeaking: {
 424         RefPtr&lt;Range&gt; selectedRange = frame-&gt;selection().toNormalizedRange();
 425         if (!selectedRange || selectedRange-&gt;collapsed()) {
 426             auto&amp; document = m_context.hitTestResult().innerNonSharedNode()-&gt;document();
 427             selectedRange = document.createRange();
 428             if (auto* element = document.documentElement())
 429                 selectedRange-&gt;selectNode(*element);
 430         }
 431         m_client.speak(plainText(selectedRange.get()));
 432         break;
 433     }
 434     case ContextMenuItemTagStopSpeaking:
 435         m_client.stopSpeaking();
 436         break;
 437     case ContextMenuItemTagDefaultDirection:
 438         frame-&gt;editor().setBaseWritingDirection(WritingDirection::Natural);
 439         break;
 440     case ContextMenuItemTagLeftToRight:
 441         frame-&gt;editor().setBaseWritingDirection(WritingDirection::LeftToRight);
 442         break;
 443     case ContextMenuItemTagRightToLeft:
 444         frame-&gt;editor().setBaseWritingDirection(WritingDirection::RightToLeft);
 445         break;
 446     case ContextMenuItemTagTextDirectionDefault:
 447         frame-&gt;editor().command(&quot;MakeTextWritingDirectionNatural&quot;).execute();
 448         break;
 449     case ContextMenuItemTagTextDirectionLeftToRight:
 450         frame-&gt;editor().command(&quot;MakeTextWritingDirectionLeftToRight&quot;).execute();
 451         break;
 452     case ContextMenuItemTagTextDirectionRightToLeft:
 453         frame-&gt;editor().command(&quot;MakeTextWritingDirectionRightToLeft&quot;).execute();
 454         break;
 455 #if PLATFORM(COCOA)
 456     case ContextMenuItemTagSearchInSpotlight:
 457         m_client.searchWithSpotlight();
 458         break;
 459 #endif
 460     case ContextMenuItemTagShowSpellingPanel:
 461         frame-&gt;editor().showSpellingGuessPanel();
 462         break;
 463     case ContextMenuItemTagCheckSpelling:
 464         frame-&gt;editor().advanceToNextMisspelling();
 465         break;
 466     case ContextMenuItemTagCheckSpellingWhileTyping:
 467         frame-&gt;editor().toggleContinuousSpellChecking();
 468         break;
 469     case ContextMenuItemTagCheckGrammarWithSpelling:
 470         frame-&gt;editor().toggleGrammarChecking();
 471         break;
 472 #if PLATFORM(COCOA)
 473     case ContextMenuItemTagShowFonts:
 474         frame-&gt;editor().showFontPanel();
 475         break;
 476     case ContextMenuItemTagStyles:
 477         frame-&gt;editor().showStylesPanel();
 478         break;
 479     case ContextMenuItemTagShowColors:
 480         frame-&gt;editor().showColorPanel();
 481         break;
 482 #endif
 483 #if USE(APPKIT)
 484     case ContextMenuItemTagMakeUpperCase:
 485         frame-&gt;editor().uppercaseWord();
 486         break;
 487     case ContextMenuItemTagMakeLowerCase:
 488         frame-&gt;editor().lowercaseWord();
 489         break;
 490     case ContextMenuItemTagCapitalize:
 491         frame-&gt;editor().capitalizeWord();
 492         break;
 493 #endif
 494 #if PLATFORM(COCOA)
 495     case ContextMenuItemTagChangeBack:
 496         frame-&gt;editor().changeBackToReplacedString(m_context.hitTestResult().replacedString());
 497         break;
 498 #endif
 499 #if USE(AUTOMATIC_TEXT_REPLACEMENT)
 500     case ContextMenuItemTagShowSubstitutions:
 501         frame-&gt;editor().showSubstitutionsPanel();
 502         break;
 503     case ContextMenuItemTagSmartCopyPaste:
 504         frame-&gt;editor().toggleSmartInsertDelete();
 505         break;
 506     case ContextMenuItemTagSmartQuotes:
 507         frame-&gt;editor().toggleAutomaticQuoteSubstitution();
 508         break;
 509     case ContextMenuItemTagSmartDashes:
 510         frame-&gt;editor().toggleAutomaticDashSubstitution();
 511         break;
 512     case ContextMenuItemTagSmartLinks:
 513         frame-&gt;editor().toggleAutomaticLinkDetection();
 514         break;
 515     case ContextMenuItemTagTextReplacement:
 516         frame-&gt;editor().toggleAutomaticTextReplacement();
 517         break;
 518     case ContextMenuItemTagCorrectSpellingAutomatically:
 519         frame-&gt;editor().toggleAutomaticSpellingCorrection();
 520         break;
 521 #endif
 522     case ContextMenuItemTagInspectElement:
 523         if (Page* page = frame-&gt;page())
 524             page-&gt;inspectorController().inspect(m_context.hitTestResult().innerNonSharedNode());
 525         break;
 526     case ContextMenuItemTagDictationAlternative:
 527         frame-&gt;editor().applyDictationAlternativelternative(title);
 528         break;
 529     default:
 530         break;
 531     }
 532 }
 533 
 534 void ContextMenuController::appendItem(ContextMenuItem&amp; menuItem, ContextMenu* parentMenu)
 535 {
 536     checkOrEnableIfNeeded(menuItem);
 537     if (parentMenu)
 538         parentMenu-&gt;appendItem(menuItem);
 539 }
 540 
 541 void ContextMenuController::createAndAppendFontSubMenu(ContextMenuItem&amp; fontMenuItem)
 542 {
 543     ContextMenu fontMenu;
 544 
 545 #if PLATFORM(COCOA)
 546     ContextMenuItem showFonts(ActionType, ContextMenuItemTagShowFonts, contextMenuItemTagShowFonts());
 547 #endif
 548     ContextMenuItem bold(CheckableActionType, ContextMenuItemTagBold, contextMenuItemTagBold());
 549     ContextMenuItem italic(CheckableActionType, ContextMenuItemTagItalic, contextMenuItemTagItalic());
 550     ContextMenuItem underline(CheckableActionType, ContextMenuItemTagUnderline, contextMenuItemTagUnderline());
 551     ContextMenuItem outline(ActionType, ContextMenuItemTagOutline, contextMenuItemTagOutline());
 552 #if PLATFORM(COCOA)
 553     ContextMenuItem styles(ActionType, ContextMenuItemTagStyles, contextMenuItemTagStyles());
 554     ContextMenuItem showColors(ActionType, ContextMenuItemTagShowColors, contextMenuItemTagShowColors());
 555 #endif
 556 
 557 #if PLATFORM(COCOA)
 558     appendItem(showFonts, &amp;fontMenu);
 559 #endif
 560     appendItem(bold, &amp;fontMenu);
 561     appendItem(italic, &amp;fontMenu);
 562     appendItem(underline, &amp;fontMenu);
 563     appendItem(outline, &amp;fontMenu);
 564 #if PLATFORM(COCOA)
 565     appendItem(styles, &amp;fontMenu);
 566     appendItem(*separatorItem(), &amp;fontMenu);
 567     appendItem(showColors, &amp;fontMenu);
 568 #endif
 569 
 570     fontMenuItem.setSubMenu(&amp;fontMenu);
 571 }
 572 
 573 
 574 #if !PLATFORM(GTK)
 575 
 576 void ContextMenuController::createAndAppendSpellingAndGrammarSubMenu(ContextMenuItem&amp; spellingAndGrammarMenuItem)
 577 {
 578     ContextMenu spellingAndGrammarMenu;
 579 
 580     ContextMenuItem showSpellingPanel(ActionType, ContextMenuItemTagShowSpellingPanel,
 581         contextMenuItemTagShowSpellingPanel(true));
 582     ContextMenuItem checkSpelling(ActionType, ContextMenuItemTagCheckSpelling,
 583         contextMenuItemTagCheckSpelling());
 584     ContextMenuItem checkAsYouType(CheckableActionType, ContextMenuItemTagCheckSpellingWhileTyping,
 585         contextMenuItemTagCheckSpellingWhileTyping());
 586     ContextMenuItem grammarWithSpelling(CheckableActionType, ContextMenuItemTagCheckGrammarWithSpelling,
 587         contextMenuItemTagCheckGrammarWithSpelling());
 588 #if PLATFORM(COCOA)
 589     ContextMenuItem correctSpelling(CheckableActionType, ContextMenuItemTagCorrectSpellingAutomatically,
 590         contextMenuItemTagCorrectSpellingAutomatically());
 591 #endif
 592 
 593     appendItem(showSpellingPanel, &amp;spellingAndGrammarMenu);
 594     appendItem(checkSpelling, &amp;spellingAndGrammarMenu);
 595 #if PLATFORM(COCOA)
 596     appendItem(*separatorItem(), &amp;spellingAndGrammarMenu);
 597 #endif
 598     appendItem(checkAsYouType, &amp;spellingAndGrammarMenu);
 599     appendItem(grammarWithSpelling, &amp;spellingAndGrammarMenu);
 600 #if PLATFORM(COCOA)
 601     appendItem(correctSpelling, &amp;spellingAndGrammarMenu);
 602 #endif
 603 
 604     spellingAndGrammarMenuItem.setSubMenu(&amp;spellingAndGrammarMenu);
 605 }
 606 
 607 #endif // !PLATFORM(GTK)
 608 
 609 
 610 #if PLATFORM(COCOA)
 611 
 612 void ContextMenuController::createAndAppendSpeechSubMenu(ContextMenuItem&amp; speechMenuItem)
 613 {
 614     ContextMenu speechMenu;
 615 
 616     ContextMenuItem start(ActionType, ContextMenuItemTagStartSpeaking, contextMenuItemTagStartSpeaking());
 617     ContextMenuItem stop(ActionType, ContextMenuItemTagStopSpeaking, contextMenuItemTagStopSpeaking());
 618 
 619     appendItem(start, &amp;speechMenu);
 620     appendItem(stop, &amp;speechMenu);
 621 
 622     speechMenuItem.setSubMenu(&amp;speechMenu);
 623 }
 624 
 625 #endif
 626 
 627 #if PLATFORM(GTK)
 628 
 629 void ContextMenuController::createAndAppendUnicodeSubMenu(ContextMenuItem&amp; unicodeMenuItem)
 630 {
 631     ContextMenu unicodeMenu;
 632 
 633     ContextMenuItem leftToRightMarkMenuItem(ActionType, ContextMenuItemTagUnicodeInsertLRMMark, contextMenuItemTagUnicodeInsertLRMMark());
 634     ContextMenuItem rightToLeftMarkMenuItem(ActionType, ContextMenuItemTagUnicodeInsertRLMMark, contextMenuItemTagUnicodeInsertRLMMark());
 635     ContextMenuItem leftToRightEmbedMenuItem(ActionType, ContextMenuItemTagUnicodeInsertLREMark, contextMenuItemTagUnicodeInsertLREMark());
 636     ContextMenuItem rightToLeftEmbedMenuItem(ActionType, ContextMenuItemTagUnicodeInsertRLEMark, contextMenuItemTagUnicodeInsertRLEMark());
 637     ContextMenuItem leftToRightOverrideMenuItem(ActionType, ContextMenuItemTagUnicodeInsertLROMark, contextMenuItemTagUnicodeInsertLROMark());
 638     ContextMenuItem rightToLeftOverrideMenuItem(ActionType, ContextMenuItemTagUnicodeInsertRLOMark, contextMenuItemTagUnicodeInsertRLOMark());
 639     ContextMenuItem popDirectionalFormattingMenuItem(ActionType, ContextMenuItemTagUnicodeInsertPDFMark, contextMenuItemTagUnicodeInsertPDFMark());
 640     ContextMenuItem zeroWidthSpaceMenuItem(ActionType, ContextMenuItemTagUnicodeInsertZWSMark, contextMenuItemTagUnicodeInsertZWSMark());
 641     ContextMenuItem zeroWidthJoinerMenuItem(ActionType, ContextMenuItemTagUnicodeInsertZWJMark, contextMenuItemTagUnicodeInsertZWJMark());
 642     ContextMenuItem zeroWidthNonJoinerMenuItem(ActionType, ContextMenuItemTagUnicodeInsertZWNJMark, contextMenuItemTagUnicodeInsertZWNJMark());
 643 
 644     appendItem(leftToRightMarkMenuItem, &amp;unicodeMenu);
 645     appendItem(rightToLeftMarkMenuItem, &amp;unicodeMenu);
 646     appendItem(leftToRightEmbedMenuItem, &amp;unicodeMenu);
 647     appendItem(rightToLeftEmbedMenuItem, &amp;unicodeMenu);
 648     appendItem(leftToRightOverrideMenuItem, &amp;unicodeMenu);
 649     appendItem(rightToLeftOverrideMenuItem, &amp;unicodeMenu);
 650     appendItem(popDirectionalFormattingMenuItem, &amp;unicodeMenu);
 651     appendItem(zeroWidthSpaceMenuItem, &amp;unicodeMenu);
 652     appendItem(zeroWidthJoinerMenuItem, &amp;unicodeMenu);
 653     appendItem(zeroWidthNonJoinerMenuItem, &amp;unicodeMenu);
 654 
 655     unicodeMenuItem.setSubMenu(&amp;unicodeMenu);
 656 }
 657 
 658 #else
 659 
 660 void ContextMenuController::createAndAppendWritingDirectionSubMenu(ContextMenuItem&amp; writingDirectionMenuItem)
 661 {
 662     ContextMenu writingDirectionMenu;
 663 
 664     ContextMenuItem defaultItem(ActionType, ContextMenuItemTagDefaultDirection,
 665         contextMenuItemTagDefaultDirection());
 666     ContextMenuItem ltr(CheckableActionType, ContextMenuItemTagLeftToRight, contextMenuItemTagLeftToRight());
 667     ContextMenuItem rtl(CheckableActionType, ContextMenuItemTagRightToLeft, contextMenuItemTagRightToLeft());
 668 
 669     appendItem(defaultItem, &amp;writingDirectionMenu);
 670     appendItem(ltr, &amp;writingDirectionMenu);
 671     appendItem(rtl, &amp;writingDirectionMenu);
 672 
 673     writingDirectionMenuItem.setSubMenu(&amp;writingDirectionMenu);
 674 }
 675 
 676 void ContextMenuController::createAndAppendTextDirectionSubMenu(ContextMenuItem&amp; textDirectionMenuItem)
 677 {
 678     ContextMenu textDirectionMenu;
 679 
 680     ContextMenuItem defaultItem(ActionType, ContextMenuItemTagTextDirectionDefault, contextMenuItemTagDefaultDirection());
 681     ContextMenuItem ltr(CheckableActionType, ContextMenuItemTagTextDirectionLeftToRight, contextMenuItemTagLeftToRight());
 682     ContextMenuItem rtl(CheckableActionType, ContextMenuItemTagTextDirectionRightToLeft, contextMenuItemTagRightToLeft());
 683 
 684     appendItem(defaultItem, &amp;textDirectionMenu);
 685     appendItem(ltr, &amp;textDirectionMenu);
 686     appendItem(rtl, &amp;textDirectionMenu);
 687 
 688     textDirectionMenuItem.setSubMenu(&amp;textDirectionMenu);
 689 }
 690 
 691 #endif
 692 
 693 #if PLATFORM(COCOA)
 694 
 695 void ContextMenuController::createAndAppendSubstitutionsSubMenu(ContextMenuItem&amp; substitutionsMenuItem)
 696 {
 697     ContextMenu substitutionsMenu;
 698 
 699     ContextMenuItem showSubstitutions(ActionType, ContextMenuItemTagShowSubstitutions, contextMenuItemTagShowSubstitutions(true));
 700     ContextMenuItem smartCopyPaste(CheckableActionType, ContextMenuItemTagSmartCopyPaste, contextMenuItemTagSmartCopyPaste());
 701     ContextMenuItem smartQuotes(CheckableActionType, ContextMenuItemTagSmartQuotes, contextMenuItemTagSmartQuotes());
 702     ContextMenuItem smartDashes(CheckableActionType, ContextMenuItemTagSmartDashes, contextMenuItemTagSmartDashes());
 703     ContextMenuItem smartLinks(CheckableActionType, ContextMenuItemTagSmartLinks, contextMenuItemTagSmartLinks());
 704     ContextMenuItem textReplacement(CheckableActionType, ContextMenuItemTagTextReplacement, contextMenuItemTagTextReplacement());
 705 
 706     appendItem(showSubstitutions, &amp;substitutionsMenu);
 707     appendItem(*separatorItem(), &amp;substitutionsMenu);
 708     appendItem(smartCopyPaste, &amp;substitutionsMenu);
 709     appendItem(smartQuotes, &amp;substitutionsMenu);
 710     appendItem(smartDashes, &amp;substitutionsMenu);
 711     appendItem(smartLinks, &amp;substitutionsMenu);
 712     appendItem(textReplacement, &amp;substitutionsMenu);
 713 
 714     substitutionsMenuItem.setSubMenu(&amp;substitutionsMenu);
 715 }
 716 
 717 void ContextMenuController::createAndAppendTransformationsSubMenu(ContextMenuItem&amp; transformationsMenuItem)
 718 {
 719     ContextMenu transformationsMenu;
 720 
 721     ContextMenuItem makeUpperCase(ActionType, ContextMenuItemTagMakeUpperCase, contextMenuItemTagMakeUpperCase());
 722     ContextMenuItem makeLowerCase(ActionType, ContextMenuItemTagMakeLowerCase, contextMenuItemTagMakeLowerCase());
 723     ContextMenuItem capitalize(ActionType, ContextMenuItemTagCapitalize, contextMenuItemTagCapitalize());
 724 
 725     appendItem(makeUpperCase, &amp;transformationsMenu);
 726     appendItem(makeLowerCase, &amp;transformationsMenu);
 727     appendItem(capitalize, &amp;transformationsMenu);
 728 
 729     transformationsMenuItem.setSubMenu(&amp;transformationsMenu);
 730 }
 731 
 732 #endif
 733 
 734 #if PLATFORM(COCOA)
 735 #define SUPPORTS_TOGGLE_VIDEO_FULLSCREEN 1
 736 #else
 737 #define SUPPORTS_TOGGLE_VIDEO_FULLSCREEN 0
 738 #endif
 739 
 740 #if PLATFORM(COCOA)
 741 #define SUPPORTS_TOGGLE_SHOW_HIDE_MEDIA_CONTROLS 1
 742 #else
 743 #define SUPPORTS_TOGGLE_SHOW_HIDE_MEDIA_CONTROLS 0
 744 #endif
 745 
 746 void ContextMenuController::populate()
 747 {
 748     ContextMenuItem OpenLinkItem(ActionType, ContextMenuItemTagOpenLink, contextMenuItemTagOpenLink());
 749     ContextMenuItem OpenLinkInNewWindowItem(ActionType, ContextMenuItemTagOpenLinkInNewWindow,
 750         contextMenuItemTagOpenLinkInNewWindow());
 751     ContextMenuItem DownloadFileItem(ActionType, ContextMenuItemTagDownloadLinkToDisk,
 752         contextMenuItemTagDownloadLinkToDisk());
 753     ContextMenuItem CopyLinkItem(ActionType, ContextMenuItemTagCopyLinkToClipboard,
 754         contextMenuItemTagCopyLinkToClipboard());
 755     ContextMenuItem OpenImageInNewWindowItem(ActionType, ContextMenuItemTagOpenImageInNewWindow,
 756         contextMenuItemTagOpenImageInNewWindow());
 757     ContextMenuItem DownloadImageItem(ActionType, ContextMenuItemTagDownloadImageToDisk,
 758         contextMenuItemTagDownloadImageToDisk());
 759     ContextMenuItem CopyImageItem(ActionType, ContextMenuItemTagCopyImageToClipboard,
 760         contextMenuItemTagCopyImageToClipboard());
 761 #if PLATFORM(GTK)
 762     ContextMenuItem CopyImageUrlItem(ActionType, ContextMenuItemTagCopyImageUrlToClipboard,
 763         contextMenuItemTagCopyImageUrlToClipboard());
 764 #endif
 765     ContextMenuItem OpenMediaInNewWindowItem(ActionType, ContextMenuItemTagOpenMediaInNewWindow, String());
 766     ContextMenuItem DownloadMediaItem(ActionType, ContextMenuItemTagDownloadMediaToDisk, String());
 767     ContextMenuItem CopyMediaLinkItem(ActionType, ContextMenuItemTagCopyMediaLinkToClipboard, String());
 768     ContextMenuItem MediaPlayPause(ActionType, ContextMenuItemTagMediaPlayPause,
 769         contextMenuItemTagMediaPlay());
 770     ContextMenuItem MediaMute(ActionType, ContextMenuItemTagMediaMute,
 771         contextMenuItemTagMediaMute());
 772 #if SUPPORTS_TOGGLE_SHOW_HIDE_MEDIA_CONTROLS
 773     ContextMenuItem ToggleMediaControls(ActionType, ContextMenuItemTagToggleMediaControls,
 774         contextMenuItemTagHideMediaControls());
 775 #else
 776     ContextMenuItem ToggleMediaControls(CheckableActionType, ContextMenuItemTagToggleMediaControls,
 777         contextMenuItemTagToggleMediaControls());
 778 #endif
 779     ContextMenuItem ToggleMediaLoop(CheckableActionType, ContextMenuItemTagToggleMediaLoop,
 780         contextMenuItemTagToggleMediaLoop());
 781     ContextMenuItem EnterVideoFullscreen(ActionType, ContextMenuItemTagEnterVideoFullscreen,
 782         contextMenuItemTagEnterVideoFullscreen());
 783     ContextMenuItem ToggleVideoFullscreen(ActionType, ContextMenuItemTagToggleVideoFullscreen,
 784         contextMenuItemTagEnterVideoFullscreen());
 785 #if PLATFORM(MAC) &amp;&amp; ENABLE(VIDEO_PRESENTATION_MODE)
 786     ContextMenuItem ToggleVideoEnhancedFullscreen(ActionType, ContextMenuItemTagToggleVideoEnhancedFullscreen, contextMenuItemTagEnterVideoEnhancedFullscreen());
 787 #endif
 788 #if PLATFORM(COCOA)
 789     ContextMenuItem SearchSpotlightItem(ActionType, ContextMenuItemTagSearchInSpotlight,
 790         contextMenuItemTagSearchInSpotlight());
 791 #endif
 792 #if !PLATFORM(GTK)
 793     ContextMenuItem SearchWebItem(ActionType, ContextMenuItemTagSearchWeb, contextMenuItemTagSearchWeb());
 794 #endif
 795     ContextMenuItem CopyItem(ActionType, ContextMenuItemTagCopy, contextMenuItemTagCopy());
 796     ContextMenuItem BackItem(ActionType, ContextMenuItemTagGoBack, contextMenuItemTagGoBack());
 797     ContextMenuItem ForwardItem(ActionType, ContextMenuItemTagGoForward,  contextMenuItemTagGoForward());
 798     ContextMenuItem StopItem(ActionType, ContextMenuItemTagStop, contextMenuItemTagStop());
 799     ContextMenuItem ReloadItem(ActionType, ContextMenuItemTagReload, contextMenuItemTagReload());
 800     ContextMenuItem OpenFrameItem(ActionType, ContextMenuItemTagOpenFrameInNewWindow,
 801         contextMenuItemTagOpenFrameInNewWindow());
 802     ContextMenuItem NoGuessesItem(ActionType, ContextMenuItemTagNoGuessesFound,
 803         contextMenuItemTagNoGuessesFound());
 804     ContextMenuItem IgnoreSpellingItem(ActionType, ContextMenuItemTagIgnoreSpelling,
 805         contextMenuItemTagIgnoreSpelling());
 806     ContextMenuItem LearnSpellingItem(ActionType, ContextMenuItemTagLearnSpelling,
 807         contextMenuItemTagLearnSpelling());
 808     ContextMenuItem IgnoreGrammarItem(ActionType, ContextMenuItemTagIgnoreGrammar,
 809         contextMenuItemTagIgnoreGrammar());
 810     ContextMenuItem CutItem(ActionType, ContextMenuItemTagCut, contextMenuItemTagCut());
 811     ContextMenuItem PasteItem(ActionType, ContextMenuItemTagPaste, contextMenuItemTagPaste());
 812 #if PLATFORM(GTK)
 813     ContextMenuItem DeleteItem(ActionType, ContextMenuItemTagDelete, contextMenuItemTagDelete());
<a name="6" id="anc6"></a><span class="line-removed"> 814 #endif</span>
<span class="line-removed"> 815 #if PLATFORM(GTK)</span>
 816     ContextMenuItem SelectAllItem(ActionType, ContextMenuItemTagSelectAll, contextMenuItemTagSelectAll());
<a name="7" id="anc7"></a>
 817 #endif
 818 
 819 #if PLATFORM(GTK) || PLATFORM(WIN)
 820     ContextMenuItem ShareMenuItem;
 821 #else
 822     ContextMenuItem ShareMenuItem(SubmenuType, ContextMenuItemTagShareMenu, emptyString());
 823 #endif
 824 
 825     Node* node = m_context.hitTestResult().innerNonSharedNode();
 826     if (!node)
 827         return;
 828 #if PLATFORM(GTK)
 829     if (!m_context.hitTestResult().isContentEditable() &amp;&amp; is&lt;HTMLFormControlElement&gt;(*node))
 830         return;
 831 #endif
 832     Frame* frame = node-&gt;document().frame();
 833     if (!frame)
 834         return;
 835 
 836 #if ENABLE(SERVICE_CONTROLS)
 837     // The default image control menu gets populated solely by the platform.
 838     if (m_context.controlledImage())
 839         return;
 840 #endif
 841 
 842     if (!m_context.hitTestResult().isContentEditable()) {
 843         String selectedString = m_context.hitTestResult().selectedText();
 844         m_context.setSelectedText(selectedString);
 845 
 846         FrameLoader&amp; loader = frame-&gt;loader();
 847         URL linkURL = m_context.hitTestResult().absoluteLinkURL();
 848         if (!linkURL.isEmpty()) {
 849             if (loader.client().canHandleRequest(ResourceRequest(linkURL))) {
 850                 appendItem(OpenLinkItem, m_contextMenu.get());
 851                 appendItem(OpenLinkInNewWindowItem, m_contextMenu.get());
 852                 appendItem(DownloadFileItem, m_contextMenu.get());
 853             }
 854             appendItem(CopyLinkItem, m_contextMenu.get());
 855         }
 856 
 857         URL imageURL = m_context.hitTestResult().absoluteImageURL();
 858         if (!imageURL.isEmpty()) {
 859             if (!linkURL.isEmpty())
 860                 appendItem(*separatorItem(), m_contextMenu.get());
 861 
 862             appendItem(OpenImageInNewWindowItem, m_contextMenu.get());
 863             appendItem(DownloadImageItem, m_contextMenu.get());
 864             if (imageURL.isLocalFile() || m_context.hitTestResult().image())
 865                 appendItem(CopyImageItem, m_contextMenu.get());
 866 #if PLATFORM(GTK)
 867             appendItem(CopyImageUrlItem, m_contextMenu.get());
 868 #endif
 869         }
 870 
 871         URL mediaURL = m_context.hitTestResult().absoluteMediaURL();
 872         if (!mediaURL.isEmpty()) {
 873             if (!linkURL.isEmpty() || !imageURL.isEmpty())
 874                 appendItem(*separatorItem(), m_contextMenu.get());
 875 
 876             appendItem(MediaPlayPause, m_contextMenu.get());
 877             appendItem(MediaMute, m_contextMenu.get());
 878             appendItem(ToggleMediaControls, m_contextMenu.get());
 879             appendItem(ToggleMediaLoop, m_contextMenu.get());
 880 #if SUPPORTS_TOGGLE_VIDEO_FULLSCREEN
 881             appendItem(ToggleVideoFullscreen, m_contextMenu.get());
 882 #else
 883             appendItem(EnterVideoFullscreen, m_contextMenu.get());
 884 #endif
 885 #if PLATFORM(MAC) &amp;&amp; ENABLE(VIDEO_PRESENTATION_MODE)
 886             appendItem(ToggleVideoEnhancedFullscreen, m_contextMenu.get());
 887 #endif
<a name="8" id="anc8"></a><span class="line-modified"> 888             appendItem(*separatorItem(), m_contextMenu.get());</span>
<span class="line-modified"> 889             appendItem(CopyMediaLinkItem, m_contextMenu.get());</span>
<span class="line-modified"> 890             appendItem(OpenMediaInNewWindowItem, m_contextMenu.get());</span>
<span class="line-modified"> 891             if (m_context.hitTestResult().isDownloadableMedia() &amp;&amp; loader.client().canHandleRequest(ResourceRequest(mediaURL)))</span>
 892                 appendItem(DownloadMediaItem, m_contextMenu.get());
<a name="9" id="anc9"></a>
 893         }
 894 
 895         if (imageURL.isEmpty() &amp;&amp; linkURL.isEmpty() &amp;&amp; mediaURL.isEmpty()) {
 896             if (m_context.hitTestResult().isSelected()) {
 897                 if (!selectedString.isEmpty()) {
 898 #if PLATFORM(COCOA)
 899                     ContextMenuItem LookUpInDictionaryItem(ActionType, ContextMenuItemTagLookUpInDictionary, contextMenuItemTagLookUpInDictionary(selectedString));
 900 
 901                     appendItem(LookUpInDictionaryItem, m_contextMenu.get());
 902 #endif
 903 
 904 #if !PLATFORM(GTK)
 905                     appendItem(SearchWebItem, m_contextMenu.get());
 906                     appendItem(*separatorItem(), m_contextMenu.get());
 907 #endif
 908                 }
 909 
 910                 appendItem(CopyItem, m_contextMenu.get());
 911 #if PLATFORM(COCOA)
 912                 appendItem(*separatorItem(), m_contextMenu.get());
 913 
 914                 appendItem(ShareMenuItem, m_contextMenu.get());
 915                 appendItem(*separatorItem(), m_contextMenu.get());
 916 
 917                 ContextMenuItem SpeechMenuItem(SubmenuType, ContextMenuItemTagSpeechMenu, contextMenuItemTagSpeechMenu());
 918                 createAndAppendSpeechSubMenu(SpeechMenuItem);
 919                 appendItem(SpeechMenuItem, m_contextMenu.get());
 920 #endif
 921             } else {
 922                 if (!(frame-&gt;page() &amp;&amp; (frame-&gt;page()-&gt;inspectorController().inspectionLevel() &gt; 0 || frame-&gt;page()-&gt;inspectorController().hasRemoteFrontend()))) {
 923 
 924                 // In GTK+ unavailable items are not hidden but insensitive.
 925 #if PLATFORM(GTK)
 926                 appendItem(BackItem, m_contextMenu.get());
 927                 appendItem(ForwardItem, m_contextMenu.get());
 928                 appendItem(StopItem, m_contextMenu.get());
 929                 appendItem(ReloadItem, m_contextMenu.get());
 930 #else
 931                 if (frame-&gt;page() &amp;&amp; frame-&gt;page()-&gt;backForward().canGoBackOrForward(-1))
 932                     appendItem(BackItem, m_contextMenu.get());
 933 
 934                 if (frame-&gt;page() &amp;&amp; frame-&gt;page()-&gt;backForward().canGoBackOrForward(1))
 935                     appendItem(ForwardItem, m_contextMenu.get());
 936 
 937                 // use isLoadingInAPISense rather than isLoading because Stop/Reload are
 938                 // intended to match WebKit&#39;s API, not WebCore&#39;s internal notion of loading status
 939                 if (loader.documentLoader()-&gt;isLoadingInAPISense())
 940                     appendItem(StopItem, m_contextMenu.get());
 941                 else
 942                     appendItem(ReloadItem, m_contextMenu.get());
 943 #endif
 944                 }
 945 
 946                 if (frame-&gt;page() &amp;&amp; !frame-&gt;isMainFrame())
 947                     appendItem(OpenFrameItem, m_contextMenu.get());
 948 
 949                 if (!ShareMenuItem.isNull()) {
 950                     appendItem(*separatorItem(), m_contextMenu.get());
 951                     appendItem(ShareMenuItem, m_contextMenu.get());
 952                 }
 953             }
 954         } else if (!ShareMenuItem.isNull()) {
 955             appendItem(*separatorItem(), m_contextMenu.get());
 956             appendItem(ShareMenuItem, m_contextMenu.get());
 957         }
 958     } else { // Make an editing context menu
 959         bool inPasswordField = frame-&gt;selection().selection().isInPasswordField();
 960         if (!inPasswordField) {
 961             bool haveContextMenuItemsForMisspellingOrGrammer = false;
 962             bool spellCheckingEnabled = frame-&gt;editor().isSpellCheckingEnabledFor(node);
 963             if (spellCheckingEnabled) {
 964                 // Consider adding spelling-related or grammar-related context menu items (never both, since a single selected range
 965                 // is never considered a misspelling and bad grammar at the same time)
 966                 bool misspelling;
 967                 bool badGrammar;
 968                 Vector&lt;String&gt; guesses = frame-&gt;editor().guessesForMisspelledOrUngrammatical(misspelling, badGrammar);
 969                 if (misspelling || badGrammar) {
 970                     if (guesses.isEmpty()) {
 971                         // If there&#39;s bad grammar but no suggestions (e.g., repeated word), just leave off the suggestions
 972                         // list and trailing separator rather than adding a &quot;No Guesses Found&quot; item (matches AppKit)
 973                         if (misspelling) {
 974                             appendItem(NoGuessesItem, m_contextMenu.get());
 975                             appendItem(*separatorItem(), m_contextMenu.get());
 976                         }
 977                     } else {
 978                         for (const auto&amp; guess : guesses) {
 979                             if (!guess.isEmpty()) {
 980                                 ContextMenuItem item(ActionType, ContextMenuItemTagSpellingGuess, guess);
 981                                 appendItem(item, m_contextMenu.get());
 982                             }
 983                         }
 984                         appendItem(*separatorItem(), m_contextMenu.get());
 985                     }
 986                     if (misspelling) {
 987                         appendItem(IgnoreSpellingItem, m_contextMenu.get());
 988                         appendItem(LearnSpellingItem, m_contextMenu.get());
 989                     } else
 990                         appendItem(IgnoreGrammarItem, m_contextMenu.get());
 991                     appendItem(*separatorItem(), m_contextMenu.get());
 992                     haveContextMenuItemsForMisspellingOrGrammer = true;
 993 #if PLATFORM(COCOA)
 994                 } else {
 995                     // If the string was autocorrected, generate a contextual menu item allowing it to be changed back.
 996                     String replacedString = m_context.hitTestResult().replacedString();
 997                     if (!replacedString.isEmpty()) {
 998                         ContextMenuItem item(ActionType, ContextMenuItemTagChangeBack, contextMenuItemTagChangeBack(replacedString));
 999                         appendItem(item, m_contextMenu.get());
1000                         appendItem(*separatorItem(), m_contextMenu.get());
1001                         haveContextMenuItemsForMisspellingOrGrammer = true;
1002                     }
1003 #endif
1004                 }
1005             }
1006 
1007             if (!haveContextMenuItemsForMisspellingOrGrammer) {
1008                 // Spelling and grammar checking is mutually exclusive with dictation alternatives.
1009                 Vector&lt;String&gt; dictationAlternatives = m_context.hitTestResult().dictationAlternatives();
1010                 if (!dictationAlternatives.isEmpty()) {
1011                     for (auto&amp; alternative : dictationAlternatives) {
1012                         ContextMenuItem item(ActionType, ContextMenuItemTagDictationAlternative, alternative);
1013                         appendItem(item, m_contextMenu.get());
1014                     }
1015                     appendItem(*separatorItem(), m_contextMenu.get());
1016                 }
1017             }
1018         }
1019 
1020         FrameLoader&amp; loader = frame-&gt;loader();
1021         URL linkURL = m_context.hitTestResult().absoluteLinkURL();
1022         if (!linkURL.isEmpty()) {
1023             if (loader.client().canHandleRequest(ResourceRequest(linkURL))) {
1024                 appendItem(OpenLinkItem, m_contextMenu.get());
1025                 appendItem(OpenLinkInNewWindowItem, m_contextMenu.get());
1026                 appendItem(DownloadFileItem, m_contextMenu.get());
1027             }
1028             appendItem(CopyLinkItem, m_contextMenu.get());
1029             appendItem(*separatorItem(), m_contextMenu.get());
1030         }
1031 
1032         String selectedText = m_context.hitTestResult().selectedText();
1033         if (m_context.hitTestResult().isSelected() &amp;&amp; !inPasswordField &amp;&amp; !selectedText.isEmpty()) {
1034 #if PLATFORM(COCOA)
1035             ContextMenuItem LookUpInDictionaryItem(ActionType, ContextMenuItemTagLookUpInDictionary, contextMenuItemTagLookUpInDictionary(selectedText));
1036 
1037             appendItem(LookUpInDictionaryItem, m_contextMenu.get());
1038 #endif
1039 
1040 #if !PLATFORM(GTK)
1041             appendItem(SearchWebItem, m_contextMenu.get());
1042             appendItem(*separatorItem(), m_contextMenu.get());
1043 #endif
1044         }
1045 
1046         appendItem(CutItem, m_contextMenu.get());
1047         appendItem(CopyItem, m_contextMenu.get());
1048         appendItem(PasteItem, m_contextMenu.get());
1049 #if PLATFORM(GTK)
1050         appendItem(DeleteItem, m_contextMenu.get());
1051         appendItem(*separatorItem(), m_contextMenu.get());
<a name="10" id="anc10"></a><span class="line-removed">1052 #endif</span>
<span class="line-removed">1053 #if PLATFORM(GTK)</span>
1054         appendItem(SelectAllItem, m_contextMenu.get());
<a name="11" id="anc11"></a>
1055 #endif
1056 
1057         if (!inPasswordField) {
1058 #if !PLATFORM(GTK)
1059             appendItem(*separatorItem(), m_contextMenu.get());
1060             ContextMenuItem SpellingAndGrammarMenuItem(SubmenuType, ContextMenuItemTagSpellingMenu,
1061                 contextMenuItemTagSpellingMenu());
1062             createAndAppendSpellingAndGrammarSubMenu(SpellingAndGrammarMenuItem);
1063             appendItem(SpellingAndGrammarMenuItem, m_contextMenu.get());
1064 #endif
1065 #if PLATFORM(COCOA)
1066             ContextMenuItem substitutionsMenuItem(SubmenuType, ContextMenuItemTagSubstitutionsMenu,
1067                 contextMenuItemTagSubstitutionsMenu());
1068             createAndAppendSubstitutionsSubMenu(substitutionsMenuItem);
1069             appendItem(substitutionsMenuItem, m_contextMenu.get());
1070             ContextMenuItem transformationsMenuItem(SubmenuType, ContextMenuItemTagTransformationsMenu,
1071                 contextMenuItemTagTransformationsMenu());
1072             createAndAppendTransformationsSubMenu(transformationsMenuItem);
1073             appendItem(transformationsMenuItem, m_contextMenu.get());
1074 #endif
1075 #if PLATFORM(GTK)
1076             bool shouldShowFontMenu = frame-&gt;editor().canEditRichly();
1077 #else
1078             bool shouldShowFontMenu = true;
1079 #endif
1080             if (shouldShowFontMenu) {
1081                 ContextMenuItem FontMenuItem(SubmenuType, ContextMenuItemTagFontMenu,
1082                     contextMenuItemTagFontMenu());
1083                 createAndAppendFontSubMenu(FontMenuItem);
1084                 appendItem(FontMenuItem, m_contextMenu.get());
1085             }
1086 #if PLATFORM(COCOA)
1087             ContextMenuItem SpeechMenuItem(SubmenuType, ContextMenuItemTagSpeechMenu, contextMenuItemTagSpeechMenu());
1088             createAndAppendSpeechSubMenu(SpeechMenuItem);
1089             appendItem(SpeechMenuItem, m_contextMenu.get());
1090 #endif
1091 #if PLATFORM(GTK)
1092             EditorClient* client = frame-&gt;editor().client();
1093             if (client &amp;&amp; client-&gt;shouldShowUnicodeMenu()) {
1094                 ContextMenuItem UnicodeMenuItem(SubmenuType, ContextMenuItemTagUnicode, contextMenuItemTagUnicode());
1095                 createAndAppendUnicodeSubMenu(UnicodeMenuItem);
1096                 appendItem(*separatorItem(), m_contextMenu.get());
1097                 appendItem(UnicodeMenuItem, m_contextMenu.get());
1098             }
1099 #else
1100             ContextMenuItem WritingDirectionMenuItem(SubmenuType, ContextMenuItemTagWritingDirectionMenu,
1101                 contextMenuItemTagWritingDirectionMenu());
1102             createAndAppendWritingDirectionSubMenu(WritingDirectionMenuItem);
1103             appendItem(WritingDirectionMenuItem, m_contextMenu.get());
1104             if (Page* page = frame-&gt;page()) {
1105                 bool includeTextDirectionSubmenu = page-&gt;settings().textDirectionSubmenuInclusionBehavior() == TextDirectionSubmenuAlwaysIncluded
1106                     || (page-&gt;settings().textDirectionSubmenuInclusionBehavior() == TextDirectionSubmenuAutomaticallyIncluded &amp;&amp; frame-&gt;editor().hasBidiSelection());
1107                 if (includeTextDirectionSubmenu) {
1108                     ContextMenuItem TextDirectionMenuItem(SubmenuType, ContextMenuItemTagTextDirectionMenu, contextMenuItemTagTextDirectionMenu());
1109                     createAndAppendTextDirectionSubMenu(TextDirectionMenuItem);
1110                     appendItem(TextDirectionMenuItem, m_contextMenu.get());
1111                 }
1112             }
1113 #endif
1114         }
1115 
1116         if (!ShareMenuItem.isNull()) {
1117             appendItem(*separatorItem(), m_contextMenu.get());
1118             appendItem(ShareMenuItem, m_contextMenu.get());
1119         }
1120     }
1121 }
1122 
1123 void ContextMenuController::addInspectElementItem()
1124 {
1125     Node* node = m_context.hitTestResult().innerNonSharedNode();
1126     if (!node)
1127         return;
1128 
1129     Frame* frame = node-&gt;document().frame();
1130     if (!frame)
1131         return;
1132 
1133     Page* page = frame-&gt;page();
1134     if (!page)
1135         return;
1136 
1137     ContextMenuItem InspectElementItem(ActionType, ContextMenuItemTagInspectElement, contextMenuItemTagInspectElement());
1138     if (m_contextMenu &amp;&amp; !m_contextMenu-&gt;items().isEmpty())
1139         appendItem(*separatorItem(), m_contextMenu.get());
1140     appendItem(InspectElementItem, m_contextMenu.get());
1141 }
1142 
1143 void ContextMenuController::checkOrEnableIfNeeded(ContextMenuItem&amp; item) const
1144 {
1145     if (item.type() == SeparatorType)
1146         return;
1147 
1148     Frame* frame = m_context.hitTestResult().innerNonSharedNode()-&gt;document().frame();
1149     if (!frame)
1150         return;
1151 
1152     // Custom items already have proper checked and enabled values.
1153     if (ContextMenuItemBaseCustomTag &lt;= item.action() &amp;&amp; item.action() &lt;= ContextMenuItemLastCustomTag)
1154         return;
1155 
1156     bool shouldEnable = true;
1157     bool shouldCheck = false;
1158 
1159     switch (item.action()) {
1160         case ContextMenuItemTagCheckSpelling:
1161             shouldEnable = frame-&gt;editor().canEdit();
1162             break;
1163         case ContextMenuItemTagDefaultDirection:
1164             shouldCheck = false;
1165             shouldEnable = false;
1166             break;
1167         case ContextMenuItemTagLeftToRight:
1168         case ContextMenuItemTagRightToLeft: {
1169             String direction = item.action() == ContextMenuItemTagLeftToRight ? &quot;ltr&quot; : &quot;rtl&quot;;
1170             shouldCheck = frame-&gt;editor().selectionHasStyle(CSSPropertyDirection, direction) != FalseTriState;
1171             shouldEnable = true;
1172             break;
1173         }
1174         case ContextMenuItemTagTextDirectionDefault: {
1175             Editor::Command command = frame-&gt;editor().command(&quot;MakeTextWritingDirectionNatural&quot;);
1176             shouldCheck = command.state() == TrueTriState;
1177             shouldEnable = command.isEnabled();
1178             break;
1179         }
1180         case ContextMenuItemTagTextDirectionLeftToRight: {
1181             Editor::Command command = frame-&gt;editor().command(&quot;MakeTextWritingDirectionLeftToRight&quot;);
1182             shouldCheck = command.state() == TrueTriState;
1183             shouldEnable = command.isEnabled();
1184             break;
1185         }
1186         case ContextMenuItemTagTextDirectionRightToLeft: {
1187             Editor::Command command = frame-&gt;editor().command(&quot;MakeTextWritingDirectionRightToLeft&quot;);
1188             shouldCheck = command.state() == TrueTriState;
1189             shouldEnable = command.isEnabled();
1190             break;
1191         }
1192         case ContextMenuItemTagCopy:
1193             shouldEnable = frame-&gt;editor().canDHTMLCopy() || frame-&gt;editor().canCopy();
1194             break;
1195         case ContextMenuItemTagCut:
1196             shouldEnable = frame-&gt;editor().canDHTMLCut() || frame-&gt;editor().canCut();
1197             break;
1198         case ContextMenuItemTagIgnoreSpelling:
1199         case ContextMenuItemTagLearnSpelling:
1200             shouldEnable = frame-&gt;selection().isRange();
1201             break;
1202         case ContextMenuItemTagPaste:
1203             shouldEnable = frame-&gt;editor().canDHTMLPaste() || frame-&gt;editor().canPaste();
1204             break;
1205 #if PLATFORM(GTK)
1206         case ContextMenuItemTagDelete:
1207             shouldEnable = frame-&gt;editor().canDelete();
1208             break;
<a name="12" id="anc12"></a>



1209         case ContextMenuItemTagInputMethods:
1210         case ContextMenuItemTagUnicode:
1211         case ContextMenuItemTagUnicodeInsertLRMMark:
1212         case ContextMenuItemTagUnicodeInsertRLMMark:
1213         case ContextMenuItemTagUnicodeInsertLREMark:
1214         case ContextMenuItemTagUnicodeInsertRLEMark:
1215         case ContextMenuItemTagUnicodeInsertLROMark:
1216         case ContextMenuItemTagUnicodeInsertRLOMark:
1217         case ContextMenuItemTagUnicodeInsertPDFMark:
1218         case ContextMenuItemTagUnicodeInsertZWSMark:
1219         case ContextMenuItemTagUnicodeInsertZWJMark:
1220         case ContextMenuItemTagUnicodeInsertZWNJMark:
1221             shouldEnable = true;
1222             break;
<a name="13" id="anc13"></a><span class="line-removed">1223 #endif</span>
<span class="line-removed">1224 #if PLATFORM(GTK)</span>
<span class="line-removed">1225         case ContextMenuItemTagSelectAll:</span>
<span class="line-removed">1226             shouldEnable = true;</span>
<span class="line-removed">1227             break;</span>
1228 #endif
1229         case ContextMenuItemTagUnderline: {
1230             shouldCheck = frame-&gt;editor().selectionHasStyle(CSSPropertyWebkitTextDecorationsInEffect, &quot;underline&quot;) != FalseTriState;
1231             shouldEnable = frame-&gt;editor().canEditRichly();
1232             break;
1233         }
1234         case ContextMenuItemTagLookUpInDictionary:
1235             shouldEnable = frame-&gt;selection().isRange();
1236             break;
1237         case ContextMenuItemTagCheckGrammarWithSpelling:
1238             if (frame-&gt;editor().isGrammarCheckingEnabled())
1239                 shouldCheck = true;
1240             shouldEnable = true;
1241             break;
1242         case ContextMenuItemTagItalic: {
1243             shouldCheck = frame-&gt;editor().selectionHasStyle(CSSPropertyFontStyle, &quot;italic&quot;) != FalseTriState;
1244             shouldEnable = frame-&gt;editor().canEditRichly();
1245             break;
1246         }
1247         case ContextMenuItemTagBold: {
1248             shouldCheck = frame-&gt;editor().selectionHasStyle(CSSPropertyFontWeight, &quot;bold&quot;) != FalseTriState;
1249             shouldEnable = frame-&gt;editor().canEditRichly();
1250             break;
1251         }
1252         case ContextMenuItemTagOutline:
1253             shouldEnable = false;
1254             break;
1255         case ContextMenuItemTagShowSpellingPanel:
1256             if (frame-&gt;editor().spellingPanelIsShowing())
1257                 item.setTitle(contextMenuItemTagShowSpellingPanel(false));
1258             else
1259                 item.setTitle(contextMenuItemTagShowSpellingPanel(true));
1260             shouldEnable = frame-&gt;editor().canEdit();
1261             break;
1262         case ContextMenuItemTagNoGuessesFound:
1263             shouldEnable = false;
1264             break;
1265         case ContextMenuItemTagCheckSpellingWhileTyping:
1266             shouldCheck = frame-&gt;editor().isContinuousSpellCheckingEnabled();
1267             break;
1268 #if PLATFORM(COCOA)
1269         case ContextMenuItemTagSubstitutionsMenu:
1270         case ContextMenuItemTagTransformationsMenu:
1271             break;
1272         case ContextMenuItemTagShowSubstitutions:
1273             if (frame-&gt;editor().substitutionsPanelIsShowing())
1274                 item.setTitle(contextMenuItemTagShowSubstitutions(false));
1275             else
1276                 item.setTitle(contextMenuItemTagShowSubstitutions(true));
1277             shouldEnable = frame-&gt;editor().canEdit();
1278             break;
1279         case ContextMenuItemTagMakeUpperCase:
1280         case ContextMenuItemTagMakeLowerCase:
1281         case ContextMenuItemTagCapitalize:
1282         case ContextMenuItemTagChangeBack:
1283             shouldEnable = frame-&gt;editor().canEdit();
1284             break;
1285         case ContextMenuItemTagCorrectSpellingAutomatically:
1286             shouldCheck = frame-&gt;editor().isAutomaticSpellingCorrectionEnabled();
1287             break;
1288         case ContextMenuItemTagSmartCopyPaste:
1289             shouldCheck = frame-&gt;editor().smartInsertDeleteEnabled();
1290             break;
1291         case ContextMenuItemTagSmartQuotes:
1292             shouldCheck = frame-&gt;editor().isAutomaticQuoteSubstitutionEnabled();
1293             break;
1294         case ContextMenuItemTagSmartDashes:
1295             shouldCheck = frame-&gt;editor().isAutomaticDashSubstitutionEnabled();
1296             break;
1297         case ContextMenuItemTagSmartLinks:
1298             shouldCheck = frame-&gt;editor().isAutomaticLinkDetectionEnabled();
1299             break;
1300         case ContextMenuItemTagTextReplacement:
1301             shouldCheck = frame-&gt;editor().isAutomaticTextReplacementEnabled();
1302             break;
1303         case ContextMenuItemTagStopSpeaking:
1304             shouldEnable = m_client.isSpeaking();
1305             break;
1306 #else // PLATFORM(COCOA) ends here
1307         case ContextMenuItemTagStopSpeaking:
1308             break;
1309 #endif
1310 #if PLATFORM(GTK)
1311         case ContextMenuItemTagGoBack:
1312             shouldEnable = frame-&gt;page() &amp;&amp; frame-&gt;page()-&gt;backForward().canGoBackOrForward(-1);
1313             break;
1314         case ContextMenuItemTagGoForward:
1315             shouldEnable = frame-&gt;page() &amp;&amp; frame-&gt;page()-&gt;backForward().canGoBackOrForward(1);
1316             break;
1317         case ContextMenuItemTagStop:
1318             shouldEnable = frame-&gt;loader().documentLoader()-&gt;isLoadingInAPISense();
1319             break;
1320         case ContextMenuItemTagReload:
1321             shouldEnable = !frame-&gt;loader().documentLoader()-&gt;isLoadingInAPISense();
1322             break;
1323         case ContextMenuItemTagFontMenu:
1324             shouldEnable = frame-&gt;editor().canEditRichly();
1325             break;
1326 #else
1327         case ContextMenuItemTagGoBack:
1328         case ContextMenuItemTagGoForward:
1329         case ContextMenuItemTagStop:
1330         case ContextMenuItemTagReload:
1331         case ContextMenuItemTagFontMenu:
1332 #endif
1333         case ContextMenuItemTagNoAction:
1334         case ContextMenuItemTagOpenLinkInNewWindow:
1335         case ContextMenuItemTagDownloadLinkToDisk:
1336         case ContextMenuItemTagCopyLinkToClipboard:
1337         case ContextMenuItemTagOpenImageInNewWindow:
1338         case ContextMenuItemTagCopyImageToClipboard:
1339 #if PLATFORM(GTK)
1340         case ContextMenuItemTagCopyImageUrlToClipboard:
1341 #endif
1342             break;
1343         case ContextMenuItemTagDownloadImageToDisk:
1344 #if PLATFORM(MAC)
1345             if (WTF::protocolIs(m_context.hitTestResult().absoluteImageURL(), &quot;file&quot;))
1346                 shouldEnable = false;
1347 #endif
1348             break;
1349         case ContextMenuItemTagOpenMediaInNewWindow:
1350             if (m_context.hitTestResult().mediaIsVideo())
1351                 item.setTitle(contextMenuItemTagOpenVideoInNewWindow());
1352             else
1353                 item.setTitle(contextMenuItemTagOpenAudioInNewWindow());
1354             break;
1355         case ContextMenuItemTagDownloadMediaToDisk:
1356             if (m_context.hitTestResult().mediaIsVideo())
1357                 item.setTitle(contextMenuItemTagDownloadVideoToDisk());
1358             else
1359                 item.setTitle(contextMenuItemTagDownloadAudioToDisk());
1360             if (WTF::protocolIs(m_context.hitTestResult().absoluteImageURL(), &quot;file&quot;))
1361                 shouldEnable = false;
1362             break;
1363         case ContextMenuItemTagCopyMediaLinkToClipboard:
1364             if (m_context.hitTestResult().mediaIsVideo())
1365                 item.setTitle(contextMenuItemTagCopyVideoLinkToClipboard());
1366             else
1367                 item.setTitle(contextMenuItemTagCopyAudioLinkToClipboard());
1368             break;
1369         case ContextMenuItemTagToggleMediaControls:
1370 #if SUPPORTS_TOGGLE_SHOW_HIDE_MEDIA_CONTROLS
1371             item.setTitle(m_context.hitTestResult().mediaControlsEnabled() ? contextMenuItemTagHideMediaControls() : contextMenuItemTagShowMediaControls());
1372 #else
1373             shouldCheck = m_context.hitTestResult().mediaControlsEnabled();
1374 #endif
1375             break;
1376         case ContextMenuItemTagToggleMediaLoop:
1377             shouldCheck = m_context.hitTestResult().mediaLoopEnabled();
1378             break;
1379         case ContextMenuItemTagToggleVideoFullscreen:
1380 #if SUPPORTS_TOGGLE_VIDEO_FULLSCREEN
1381             item.setTitle(m_context.hitTestResult().mediaIsInFullscreen() ? contextMenuItemTagExitVideoFullscreen() : contextMenuItemTagEnterVideoFullscreen());
1382             break;
1383 #endif
1384         case ContextMenuItemTagEnterVideoFullscreen:
1385             shouldEnable = m_context.hitTestResult().mediaSupportsFullscreen();
1386             break;
1387         case ContextMenuItemTagToggleVideoEnhancedFullscreen:
1388 #if PLATFORM(MAC) &amp;&amp; ENABLE(VIDEO_PRESENTATION_MODE)
1389             item.setTitle(m_context.hitTestResult().mediaIsInEnhancedFullscreen() ? contextMenuItemTagExitVideoEnhancedFullscreen() : contextMenuItemTagEnterVideoEnhancedFullscreen());
1390 #endif
1391             shouldEnable = m_context.hitTestResult().mediaSupportsEnhancedFullscreen();
1392             break;
1393         case ContextMenuItemTagOpenFrameInNewWindow:
1394         case ContextMenuItemTagSpellingGuess:
1395         case ContextMenuItemTagOther:
1396         case ContextMenuItemTagSearchInSpotlight:
1397         case ContextMenuItemTagSearchWeb:
1398         case ContextMenuItemTagOpenWithDefaultApplication:
1399         case ContextMenuItemPDFActualSize:
1400         case ContextMenuItemPDFZoomIn:
1401         case ContextMenuItemPDFZoomOut:
1402         case ContextMenuItemPDFAutoSize:
1403         case ContextMenuItemPDFSinglePage:
1404         case ContextMenuItemPDFFacingPages:
1405         case ContextMenuItemPDFContinuous:
1406         case ContextMenuItemPDFNextPage:
1407         case ContextMenuItemPDFPreviousPage:
1408         case ContextMenuItemTagOpenLink:
1409         case ContextMenuItemTagIgnoreGrammar:
1410         case ContextMenuItemTagSpellingMenu:
1411         case ContextMenuItemTagShowFonts:
1412         case ContextMenuItemTagStyles:
1413         case ContextMenuItemTagShowColors:
1414         case ContextMenuItemTagSpeechMenu:
1415         case ContextMenuItemTagStartSpeaking:
1416         case ContextMenuItemTagWritingDirectionMenu:
1417         case ContextMenuItemTagTextDirectionMenu:
1418         case ContextMenuItemTagPDFSinglePageScrolling:
1419         case ContextMenuItemTagPDFFacingPagesScrolling:
1420         case ContextMenuItemTagInspectElement:
1421         case ContextMenuItemBaseCustomTag:
1422         case ContextMenuItemLastCustomTag:
1423         case ContextMenuItemBaseApplicationTag:
1424         case ContextMenuItemTagDictationAlternative:
1425         case ContextMenuItemTagShareMenu:
1426             break;
1427         case ContextMenuItemTagMediaPlayPause:
1428             if (m_context.hitTestResult().mediaPlaying())
1429                 item.setTitle(contextMenuItemTagMediaPause());
1430             else
1431                 item.setTitle(contextMenuItemTagMediaPlay());
1432             break;
1433         case ContextMenuItemTagMediaMute:
1434             shouldEnable = m_context.hitTestResult().mediaHasAudio();
1435             shouldCheck = shouldEnable &amp;&amp;  m_context.hitTestResult().mediaMuted();
1436             break;
1437     }
1438 
1439     item.setChecked(shouldCheck);
1440     item.setEnabled(shouldEnable);
1441 }
1442 
1443 #if USE(ACCESSIBILITY_CONTEXT_MENUS)
1444 
1445 void ContextMenuController::showContextMenuAt(Frame&amp; frame, const IntPoint&amp; clickPoint)
1446 {
1447     clearContextMenu();
1448 
1449     // Simulate a click in the middle of the accessibility object.
1450     PlatformMouseEvent mouseEvent(clickPoint, clickPoint, RightButton, PlatformEvent::MousePressed, 1, false, false, false, false, WallTime::now(), ForceAtClick, NoTap);
1451     frame.eventHandler().handleMousePressEvent(mouseEvent);
1452     bool handled = frame.eventHandler().sendContextMenuEvent(mouseEvent);
1453     if (handled)
1454         m_client.showContextMenu();
1455 }
1456 
1457 #endif
1458 
1459 #if ENABLE(SERVICE_CONTROLS)
1460 
1461 void ContextMenuController::showImageControlsMenu(Event&amp; event)
1462 {
1463     clearContextMenu();
1464     handleContextMenuEvent(event);
1465     m_client.showContextMenu();
1466 }
1467 
1468 #endif
1469 
1470 } // namespace WebCore
1471 
1472 #endif // ENABLE(CONTEXT_MENUS)
<a name="14" id="anc14"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="14" type="hidden" />
</body>
</html>