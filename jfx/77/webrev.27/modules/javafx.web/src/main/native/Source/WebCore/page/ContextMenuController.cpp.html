<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New modules/javafx.web/src/main/native/Source/WebCore/page/ContextMenuController.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
  <body>
    <pre>
   1 /*
   2  * Copyright (C) 2006-2016 Apple Inc. All rights reserved.
   3  * Copyright (C) 2010 Igalia S.L
   4  *
   5  * Redistribution and use in source and binary forms, with or without
   6  * modification, are permitted provided that the following conditions
   7  * are met:
   8  * 1. Redistributions of source code must retain the above copyright
   9  *    notice, this list of conditions and the following disclaimer.
  10  * 2. Redistributions in binary form must reproduce the above copyright
  11  *    notice, this list of conditions and the following disclaimer in the
  12  *    documentation and/or other materials provided with the distribution.
  13  *
  14  * THIS SOFTWARE IS PROVIDED BY APPLE INC. ``AS IS&#39;&#39; AND ANY
  15  * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
  16  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
  17  * PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL APPLE INC. OR
  18  * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
  19  * EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
  20  * PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
  21  * PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY
  22  * OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
  23  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
  24  * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
  25  */
  26 
  27 #include &quot;config.h&quot;
  28 #include &quot;ContextMenuController.h&quot;
  29 
  30 #if ENABLE(CONTEXT_MENUS)
  31 
  32 #include &quot;BackForwardController.h&quot;
  33 #include &quot;Chrome.h&quot;
  34 #include &quot;ContextMenu.h&quot;
  35 #include &quot;ContextMenuClient.h&quot;
  36 #include &quot;ContextMenuItem.h&quot;
  37 #include &quot;ContextMenuProvider.h&quot;
  38 #include &quot;CustomHeaderFields.h&quot;
  39 #include &quot;Document.h&quot;
  40 #include &quot;DocumentFragment.h&quot;
  41 #include &quot;DocumentLoader.h&quot;
  42 #include &quot;Editor.h&quot;
  43 #include &quot;EditorClient.h&quot;
  44 #include &quot;Event.h&quot;
  45 #include &quot;EventHandler.h&quot;
  46 #include &quot;FormState.h&quot;
  47 #include &quot;Frame.h&quot;
  48 #include &quot;FrameLoadRequest.h&quot;
  49 #include &quot;FrameLoader.h&quot;
  50 #include &quot;FrameLoaderClient.h&quot;
  51 #include &quot;FrameSelection.h&quot;
  52 #include &quot;HTMLFormControlElement.h&quot;
  53 #include &quot;HTMLFormElement.h&quot;
  54 #include &quot;HitTestRequest.h&quot;
  55 #include &quot;HitTestResult.h&quot;
  56 #include &quot;InspectorController.h&quot;
  57 #include &quot;LocalizedStrings.h&quot;
  58 #include &quot;MouseEvent.h&quot;
  59 #include &quot;NavigationAction.h&quot;
  60 #include &quot;Node.h&quot;
  61 #include &quot;Page.h&quot;
  62 #include &quot;PlatformEvent.h&quot;
  63 #include &quot;RenderImage.h&quot;
  64 #include &quot;ReplaceSelectionCommand.h&quot;
  65 #include &quot;ResourceRequest.h&quot;
  66 #include &quot;Settings.h&quot;
  67 #include &quot;TextIterator.h&quot;
  68 #include &quot;TypingCommand.h&quot;
  69 #include &quot;UserTypingGestureIndicator.h&quot;
  70 #include &quot;WindowFeatures.h&quot;
  71 #include &quot;markup.h&quot;
  72 #include &lt;wtf/SetForScope.h&gt;
  73 #include &lt;wtf/WallTime.h&gt;
  74 #include &lt;wtf/unicode/CharacterNames.h&gt;
  75 
  76 
  77 namespace WebCore {
  78 
  79 using namespace WTF::Unicode;
  80 
  81 ContextMenuController::ContextMenuController(Page&amp; page, ContextMenuClient&amp; client)
  82     : m_page(page)
  83     , m_client(client)
  84 {
  85 }
  86 
  87 ContextMenuController::~ContextMenuController()
  88 {
  89     m_client.contextMenuDestroyed();
  90 }
  91 
  92 void ContextMenuController::clearContextMenu()
  93 {
  94     m_contextMenu = nullptr;
  95     if (m_menuProvider)
  96         m_menuProvider-&gt;contextMenuCleared();
  97     m_menuProvider = nullptr;
  98 }
  99 
 100 void ContextMenuController::handleContextMenuEvent(Event&amp; event)
 101 {
 102     if (m_isHandlingContextMenuEvent)
 103         return;
 104 
 105     SetForScope&lt;bool&gt; isHandlingContextMenuEventForScope(m_isHandlingContextMenuEvent, true);
 106 
 107     m_contextMenu = maybeCreateContextMenu(event);
 108     if (!m_contextMenu)
 109         return;
 110 
 111     populate();
 112 
 113     showContextMenu(event);
 114 }
 115 
 116 static std::unique_ptr&lt;ContextMenuItem&gt; separatorItem()
 117 {
 118     return std::unique_ptr&lt;ContextMenuItem&gt;(new ContextMenuItem(SeparatorType, ContextMenuItemTagNoAction, String()));
 119 }
 120 
 121 void ContextMenuController::showContextMenu(Event&amp; event, ContextMenuProvider&amp; provider)
 122 {
 123     m_menuProvider = &amp;provider;
 124 
 125     m_contextMenu = maybeCreateContextMenu(event);
 126     if (!m_contextMenu) {
 127         clearContextMenu();
 128         return;
 129     }
 130 
 131     provider.populateContextMenu(m_contextMenu.get());
 132     if (m_context.hitTestResult().isSelected()) {
 133         appendItem(*separatorItem(), m_contextMenu.get());
 134         populate();
 135     }
 136     showContextMenu(event);
 137 }
 138 
 139 #if ENABLE(SERVICE_CONTROLS)
 140 
 141 static Image* imageFromImageElementNode(Node&amp; node)
 142 {
 143     auto* renderer = node.renderer();
 144     if (!is&lt;RenderImage&gt;(renderer))
 145         return nullptr;
 146     auto* image = downcast&lt;RenderImage&gt;(*renderer).cachedImage();
 147     if (!image || image-&gt;errorOccurred())
 148         return nullptr;
 149     return image-&gt;imageForRenderer(renderer);
 150 }
 151 
 152 #endif
 153 
 154 std::unique_ptr&lt;ContextMenu&gt; ContextMenuController::maybeCreateContextMenu(Event&amp; event)
 155 {
 156     if (!is&lt;MouseEvent&gt;(event))
 157         return nullptr;
 158 
 159     auto&amp; mouseEvent = downcast&lt;MouseEvent&gt;(event);
 160     if (!is&lt;Node&gt;(mouseEvent.target()))
 161         return nullptr;
 162     auto&amp; node = downcast&lt;Node&gt;(*mouseEvent.target());
 163     auto* frame = node.document().frame();
 164     if (!frame)
 165         return nullptr;
 166 
 167     auto result = frame-&gt;eventHandler().hitTestResultAtPoint(mouseEvent.absoluteLocation(), HitTestRequest::ReadOnly | HitTestRequest::Active | HitTestRequest::DisallowUserAgentShadowContent | HitTestRequest::AllowChildFrameContent);
 168     if (!result.innerNonSharedNode())
 169         return nullptr;
 170 
 171     m_context = ContextMenuContext(result);
 172 
 173 #if ENABLE(SERVICE_CONTROLS)
 174     if (node.isImageControlsButtonElement()) {
 175         if (auto* image = imageFromImageElementNode(*result.innerNonSharedNode()))
 176             m_context.setControlledImage(image);
 177 
 178         // FIXME: If we couldn&#39;t get the image then we shouldn&#39;t try to show the image controls menu for it.
 179         return nullptr;
 180     }
 181 #endif
 182 
 183     return makeUnique&lt;ContextMenu&gt;();
 184 }
 185 
 186 void ContextMenuController::showContextMenu(Event&amp; event)
 187 {
 188     if (m_page.inspectorController().enabled())
 189         addInspectElementItem();
 190 
 191     event.setDefaultHandled();
 192 }
 193 
 194 static void openNewWindow(const URL&amp; urlToLoad, Frame&amp; frame, ShouldOpenExternalURLsPolicy shouldOpenExternalURLsPolicy)
 195 {
 196     Page* oldPage = frame.page();
 197     if (!oldPage)
 198         return;
 199 
 200     FrameLoadRequest frameLoadRequest { *frame.document(), frame.document()-&gt;securityOrigin(), ResourceRequest(urlToLoad, frame.loader().outgoingReferrer()), { }, LockHistory::No, LockBackForwardList::No, MaybeSendReferrer, AllowNavigationToInvalidURL::Yes, NewFrameOpenerPolicy::Suppress, shouldOpenExternalURLsPolicy, InitiatedByMainFrame::Unknown };
 201 
 202     Page* newPage = oldPage-&gt;chrome().createWindow(frame, frameLoadRequest, { }, { *frame.document(), frameLoadRequest.resourceRequest(), frameLoadRequest.initiatedByMainFrame() });
 203     if (!newPage)
 204         return;
 205     newPage-&gt;chrome().show();
 206     newPage-&gt;mainFrame().loader().loadFrameRequest(WTFMove(frameLoadRequest), nullptr, { });
 207 }
 208 
 209 #if PLATFORM(GTK)
 210 
 211 static void insertUnicodeCharacter(UChar character, Frame&amp; frame)
 212 {
 213     String text(&amp;character, 1);
 214     if (!frame.editor().shouldInsertText(text, frame.selection().toNormalizedRange().get(), EditorInsertAction::Typed))
 215         return;
 216 
 217     ASSERT(frame.document());
 218     TypingCommand::insertText(*frame.document(), text, 0, TypingCommand::TextCompositionNone);
 219 }
 220 
 221 #endif
 222 
 223 void ContextMenuController::contextMenuItemSelected(ContextMenuAction action, const String&amp; title)
 224 {
 225     if (action &gt;= ContextMenuItemBaseCustomTag) {
 226         ASSERT(m_menuProvider);
 227         m_menuProvider-&gt;contextMenuItemSelected(action, title);
 228         return;
 229     }
 230 
 231     Frame* frame = m_context.hitTestResult().innerNonSharedNode()-&gt;document().frame();
 232     if (!frame)
 233         return;
 234 
 235     Ref&lt;Frame&gt; protector(*frame);
 236 
 237     switch (action) {
 238     case ContextMenuItemTagOpenLinkInNewWindow:
 239         openNewWindow(m_context.hitTestResult().absoluteLinkURL(), *frame, ShouldOpenExternalURLsPolicy::ShouldAllowExternalSchemes);
 240         break;
 241     case ContextMenuItemTagDownloadLinkToDisk:
 242         // FIXME: Some day we should be able to do this from within WebCore. (Bug 117709)
 243         m_client.downloadURL(m_context.hitTestResult().absoluteLinkURL());
 244         break;
 245     case ContextMenuItemTagCopyLinkToClipboard:
 246         frame-&gt;editor().copyURL(m_context.hitTestResult().absoluteLinkURL(), m_context.hitTestResult().textContent());
 247         break;
 248     case ContextMenuItemTagOpenImageInNewWindow:
 249         openNewWindow(m_context.hitTestResult().absoluteImageURL(), *frame, ShouldOpenExternalURLsPolicy::ShouldNotAllow);
 250         break;
 251     case ContextMenuItemTagDownloadImageToDisk:
 252         // FIXME: Some day we should be able to do this from within WebCore. (Bug 117709)
 253         m_client.downloadURL(m_context.hitTestResult().absoluteImageURL());
 254         break;
 255     case ContextMenuItemTagCopyImageToClipboard:
 256         // FIXME: The Pasteboard class is not written yet
 257         // For now, call into the client. This is temporary!
 258         frame-&gt;editor().copyImage(m_context.hitTestResult());
 259         break;
 260 #if PLATFORM(GTK)
 261     case ContextMenuItemTagCopyImageUrlToClipboard:
 262         frame-&gt;editor().copyURL(m_context.hitTestResult().absoluteImageURL(), m_context.hitTestResult().textContent());
 263         break;
 264 #endif
 265     case ContextMenuItemTagOpenMediaInNewWindow:
 266         openNewWindow(m_context.hitTestResult().absoluteMediaURL(), *frame, ShouldOpenExternalURLsPolicy::ShouldNotAllow);
 267         break;
 268     case ContextMenuItemTagDownloadMediaToDisk:
 269         // FIXME: Some day we should be able to do this from within WebCore. (Bug 117709)
 270         m_client.downloadURL(m_context.hitTestResult().absoluteMediaURL());
 271         break;
 272     case ContextMenuItemTagCopyMediaLinkToClipboard:
 273         frame-&gt;editor().copyURL(m_context.hitTestResult().absoluteMediaURL(), m_context.hitTestResult().textContent());
 274         break;
 275     case ContextMenuItemTagToggleMediaControls:
 276         m_context.hitTestResult().toggleMediaControlsDisplay();
 277         break;
 278     case ContextMenuItemTagToggleMediaLoop:
 279         m_context.hitTestResult().toggleMediaLoopPlayback();
 280         break;
 281     case ContextMenuItemTagToggleVideoFullscreen:
 282         m_context.hitTestResult().toggleMediaFullscreenState();
 283         break;
 284     case ContextMenuItemTagEnterVideoFullscreen:
 285         m_context.hitTestResult().enterFullscreenForVideo();
 286         break;
 287     case ContextMenuItemTagMediaPlayPause:
 288         m_context.hitTestResult().toggleMediaPlayState();
 289         break;
 290     case ContextMenuItemTagMediaMute:
 291         m_context.hitTestResult().toggleMediaMuteState();
 292         break;
 293     case ContextMenuItemTagToggleVideoEnhancedFullscreen:
 294         m_context.hitTestResult().toggleEnhancedFullscreenForVideo();
 295         break;
 296     case ContextMenuItemTagOpenFrameInNewWindow: {
 297         DocumentLoader* loader = frame-&gt;loader().documentLoader();
 298         if (!loader-&gt;unreachableURL().isEmpty())
 299             openNewWindow(loader-&gt;unreachableURL(), *frame, ShouldOpenExternalURLsPolicy::ShouldNotAllow);
 300         else
 301             openNewWindow(loader-&gt;url(), *frame, ShouldOpenExternalURLsPolicy::ShouldNotAllow);
 302         break;
 303     }
 304     case ContextMenuItemTagCopy:
 305         frame-&gt;editor().copy();
 306         break;
 307     case ContextMenuItemTagGoBack:
 308         if (Page* page = frame-&gt;page())
 309             page-&gt;backForward().goBackOrForward(-1);
 310         break;
 311     case ContextMenuItemTagGoForward:
 312         if (Page* page = frame-&gt;page())
 313             page-&gt;backForward().goBackOrForward(1);
 314         break;
 315     case ContextMenuItemTagStop:
 316         frame-&gt;loader().stop();
 317         break;
 318     case ContextMenuItemTagReload:
 319         frame-&gt;loader().reload();
 320         break;
 321     case ContextMenuItemTagCut:
 322         frame-&gt;editor().command(&quot;Cut&quot;).execute();
 323         break;
 324     case ContextMenuItemTagPaste:
 325         frame-&gt;editor().command(&quot;Paste&quot;).execute();
 326         break;
 327 #if PLATFORM(GTK)
 328     case ContextMenuItemTagDelete:
 329         frame-&gt;editor().performDelete();
 330         break;
 331     case ContextMenuItemTagUnicodeInsertLRMMark:
 332         insertUnicodeCharacter(leftToRightMark, *frame);
 333         break;
 334     case ContextMenuItemTagUnicodeInsertRLMMark:
 335         insertUnicodeCharacter(rightToLeftMark, *frame);
 336         break;
 337     case ContextMenuItemTagUnicodeInsertLREMark:
 338         insertUnicodeCharacter(leftToRightEmbed, *frame);
 339         break;
 340     case ContextMenuItemTagUnicodeInsertRLEMark:
 341         insertUnicodeCharacter(rightToLeftEmbed, *frame);
 342         break;
 343     case ContextMenuItemTagUnicodeInsertLROMark:
 344         insertUnicodeCharacter(leftToRightOverride, *frame);
 345         break;
 346     case ContextMenuItemTagUnicodeInsertRLOMark:
 347         insertUnicodeCharacter(rightToLeftOverride, *frame);
 348         break;
 349     case ContextMenuItemTagUnicodeInsertPDFMark:
 350         insertUnicodeCharacter(popDirectionalFormatting, *frame);
 351         break;
 352     case ContextMenuItemTagUnicodeInsertZWSMark:
 353         insertUnicodeCharacter(zeroWidthSpace, *frame);
 354         break;
 355     case ContextMenuItemTagUnicodeInsertZWJMark:
 356         insertUnicodeCharacter(zeroWidthJoiner, *frame);
 357         break;
 358     case ContextMenuItemTagUnicodeInsertZWNJMark:
 359         insertUnicodeCharacter(zeroWidthNonJoiner, *frame);
 360         break;
 361     case ContextMenuItemTagSelectAll:
 362         frame-&gt;editor().command(&quot;SelectAll&quot;).execute();
 363         break;
 364     case ContextMenuItemTagInsertEmoji:
 365         m_client.insertEmoji(*frame);
 366         break;
 367 #endif
 368     case ContextMenuItemTagSpellingGuess: {
 369         VisibleSelection selection = frame-&gt;selection().selection();
 370         if (frame-&gt;editor().shouldInsertText(title, selection.toNormalizedRange().get(), EditorInsertAction::Pasted)) {
 371             OptionSet&lt;ReplaceSelectionCommand::CommandOption&gt; replaceOptions { ReplaceSelectionCommand::MatchStyle, ReplaceSelectionCommand::PreventNesting };
 372 
 373             if (frame-&gt;editor().behavior().shouldAllowSpellingSuggestionsWithoutSelection()) {
 374                 ASSERT(selection.isCaretOrRange());
 375                 VisibleSelection wordSelection(selection.base());
 376                 wordSelection.expandUsingGranularity(WordGranularity);
 377                 frame-&gt;selection().setSelection(wordSelection);
 378             } else {
 379                 ASSERT(frame-&gt;editor().selectedText().length());
 380                 replaceOptions.add(ReplaceSelectionCommand::SelectReplacement);
 381             }
 382 
 383             Document* document = frame-&gt;document();
 384             ASSERT(document);
 385             auto command = ReplaceSelectionCommand::create(*document, createFragmentFromMarkup(*document, title, emptyString()), replaceOptions);
 386             command-&gt;apply();
 387             frame-&gt;selection().revealSelection(SelectionRevealMode::Reveal, ScrollAlignment::alignToEdgeIfNeeded);
 388         }
 389         break;
 390     }
 391     case ContextMenuItemTagIgnoreSpelling:
 392         frame-&gt;editor().ignoreSpelling();
 393         break;
 394     case ContextMenuItemTagLearnSpelling:
 395         frame-&gt;editor().learnSpelling();
 396         break;
 397     case ContextMenuItemTagSearchWeb:
 398         m_client.searchWithGoogle(frame);
 399         break;
 400     case ContextMenuItemTagLookUpInDictionary:
 401         // FIXME: Some day we may be able to do this from within WebCore.
 402         m_client.lookUpInDictionary(frame);
 403         break;
 404     case ContextMenuItemTagOpenLink:
 405         if (Frame* targetFrame = m_context.hitTestResult().targetFrame()) {
 406             ResourceRequest resourceRequest { m_context.hitTestResult().absoluteLinkURL(), frame-&gt;loader().outgoingReferrer() };
 407             FrameLoadRequest frameLoadRequest { *frame-&gt;document(), frame-&gt;document()-&gt;securityOrigin(), resourceRequest, { }, LockHistory::No, LockBackForwardList::No, MaybeSendReferrer, AllowNavigationToInvalidURL::Yes, NewFrameOpenerPolicy::Suppress, targetFrame-&gt;isMainFrame() ? ShouldOpenExternalURLsPolicy::ShouldAllow : ShouldOpenExternalURLsPolicy::ShouldNotAllow, InitiatedByMainFrame::Unknown };
 408             targetFrame-&gt;loader().loadFrameRequest(WTFMove(frameLoadRequest), nullptr,  { });
 409         } else
 410             openNewWindow(m_context.hitTestResult().absoluteLinkURL(), *frame, ShouldOpenExternalURLsPolicy::ShouldAllow);
 411         break;
 412     case ContextMenuItemTagBold:
 413         frame-&gt;editor().command(&quot;ToggleBold&quot;).execute();
 414         break;
 415     case ContextMenuItemTagItalic:
 416         frame-&gt;editor().command(&quot;ToggleItalic&quot;).execute();
 417         break;
 418     case ContextMenuItemTagUnderline:
 419         frame-&gt;editor().toggleUnderline();
 420         break;
 421     case ContextMenuItemTagOutline:
 422         // We actually never enable this because CSS does not have a way to specify an outline font,
 423         // which may make this difficult to implement. Maybe a special case of text-shadow?
 424         break;
 425     case ContextMenuItemTagStartSpeaking: {
 426         RefPtr&lt;Range&gt; selectedRange = frame-&gt;selection().toNormalizedRange();
 427         if (!selectedRange || selectedRange-&gt;collapsed()) {
 428             auto&amp; document = m_context.hitTestResult().innerNonSharedNode()-&gt;document();
 429             selectedRange = document.createRange();
 430             if (auto* element = document.documentElement())
 431                 selectedRange-&gt;selectNode(*element);
 432         }
 433         m_client.speak(plainText(selectedRange.get()));
 434         break;
 435     }
 436     case ContextMenuItemTagStopSpeaking:
 437         m_client.stopSpeaking();
 438         break;
 439     case ContextMenuItemTagDefaultDirection:
 440         frame-&gt;editor().setBaseWritingDirection(WritingDirection::Natural);
 441         break;
 442     case ContextMenuItemTagLeftToRight:
 443         frame-&gt;editor().setBaseWritingDirection(WritingDirection::LeftToRight);
 444         break;
 445     case ContextMenuItemTagRightToLeft:
 446         frame-&gt;editor().setBaseWritingDirection(WritingDirection::RightToLeft);
 447         break;
 448     case ContextMenuItemTagTextDirectionDefault:
 449         frame-&gt;editor().command(&quot;MakeTextWritingDirectionNatural&quot;).execute();
 450         break;
 451     case ContextMenuItemTagTextDirectionLeftToRight:
 452         frame-&gt;editor().command(&quot;MakeTextWritingDirectionLeftToRight&quot;).execute();
 453         break;
 454     case ContextMenuItemTagTextDirectionRightToLeft:
 455         frame-&gt;editor().command(&quot;MakeTextWritingDirectionRightToLeft&quot;).execute();
 456         break;
 457 #if PLATFORM(COCOA)
 458     case ContextMenuItemTagSearchInSpotlight:
 459         m_client.searchWithSpotlight();
 460         break;
 461 #endif
 462     case ContextMenuItemTagShowSpellingPanel:
 463         frame-&gt;editor().showSpellingGuessPanel();
 464         break;
 465     case ContextMenuItemTagCheckSpelling:
 466         frame-&gt;editor().advanceToNextMisspelling();
 467         break;
 468     case ContextMenuItemTagCheckSpellingWhileTyping:
 469         frame-&gt;editor().toggleContinuousSpellChecking();
 470         break;
 471     case ContextMenuItemTagCheckGrammarWithSpelling:
 472         frame-&gt;editor().toggleGrammarChecking();
 473         break;
 474 #if PLATFORM(COCOA)
 475     case ContextMenuItemTagShowFonts:
 476         frame-&gt;editor().showFontPanel();
 477         break;
 478     case ContextMenuItemTagStyles:
 479         frame-&gt;editor().showStylesPanel();
 480         break;
 481     case ContextMenuItemTagShowColors:
 482         frame-&gt;editor().showColorPanel();
 483         break;
 484 #endif
 485 #if USE(APPKIT)
 486     case ContextMenuItemTagMakeUpperCase:
 487         frame-&gt;editor().uppercaseWord();
 488         break;
 489     case ContextMenuItemTagMakeLowerCase:
 490         frame-&gt;editor().lowercaseWord();
 491         break;
 492     case ContextMenuItemTagCapitalize:
 493         frame-&gt;editor().capitalizeWord();
 494         break;
 495 #endif
 496 #if PLATFORM(COCOA)
 497     case ContextMenuItemTagChangeBack:
 498         frame-&gt;editor().changeBackToReplacedString(m_context.hitTestResult().replacedString());
 499         break;
 500 #endif
 501 #if USE(AUTOMATIC_TEXT_REPLACEMENT)
 502     case ContextMenuItemTagShowSubstitutions:
 503         frame-&gt;editor().showSubstitutionsPanel();
 504         break;
 505     case ContextMenuItemTagSmartCopyPaste:
 506         frame-&gt;editor().toggleSmartInsertDelete();
 507         break;
 508     case ContextMenuItemTagSmartQuotes:
 509         frame-&gt;editor().toggleAutomaticQuoteSubstitution();
 510         break;
 511     case ContextMenuItemTagSmartDashes:
 512         frame-&gt;editor().toggleAutomaticDashSubstitution();
 513         break;
 514     case ContextMenuItemTagSmartLinks:
 515         frame-&gt;editor().toggleAutomaticLinkDetection();
 516         break;
 517     case ContextMenuItemTagTextReplacement:
 518         frame-&gt;editor().toggleAutomaticTextReplacement();
 519         break;
 520     case ContextMenuItemTagCorrectSpellingAutomatically:
 521         frame-&gt;editor().toggleAutomaticSpellingCorrection();
 522         break;
 523 #endif
 524     case ContextMenuItemTagInspectElement:
 525         if (Page* page = frame-&gt;page())
 526             page-&gt;inspectorController().inspect(m_context.hitTestResult().innerNonSharedNode());
 527         break;
 528     case ContextMenuItemTagDictationAlternative:
 529         frame-&gt;editor().applyDictationAlternativelternative(title);
 530         break;
 531     default:
 532         break;
 533     }
 534 }
 535 
 536 void ContextMenuController::appendItem(ContextMenuItem&amp; menuItem, ContextMenu* parentMenu)
 537 {
 538     checkOrEnableIfNeeded(menuItem);
 539     if (parentMenu)
 540         parentMenu-&gt;appendItem(menuItem);
 541 }
 542 
 543 void ContextMenuController::createAndAppendFontSubMenu(ContextMenuItem&amp; fontMenuItem)
 544 {
 545     ContextMenu fontMenu;
 546 
 547 #if PLATFORM(COCOA)
 548     ContextMenuItem showFonts(ActionType, ContextMenuItemTagShowFonts, contextMenuItemTagShowFonts());
 549 #endif
 550     ContextMenuItem bold(CheckableActionType, ContextMenuItemTagBold, contextMenuItemTagBold());
 551     ContextMenuItem italic(CheckableActionType, ContextMenuItemTagItalic, contextMenuItemTagItalic());
 552     ContextMenuItem underline(CheckableActionType, ContextMenuItemTagUnderline, contextMenuItemTagUnderline());
 553     ContextMenuItem outline(ActionType, ContextMenuItemTagOutline, contextMenuItemTagOutline());
 554 #if PLATFORM(COCOA)
 555     ContextMenuItem styles(ActionType, ContextMenuItemTagStyles, contextMenuItemTagStyles());
 556     ContextMenuItem showColors(ActionType, ContextMenuItemTagShowColors, contextMenuItemTagShowColors());
 557 #endif
 558 
 559 #if PLATFORM(COCOA)
 560     appendItem(showFonts, &amp;fontMenu);
 561 #endif
 562     appendItem(bold, &amp;fontMenu);
 563     appendItem(italic, &amp;fontMenu);
 564     appendItem(underline, &amp;fontMenu);
 565     appendItem(outline, &amp;fontMenu);
 566 #if PLATFORM(COCOA)
 567     appendItem(styles, &amp;fontMenu);
 568     appendItem(*separatorItem(), &amp;fontMenu);
 569     appendItem(showColors, &amp;fontMenu);
 570 #endif
 571 
 572     fontMenuItem.setSubMenu(&amp;fontMenu);
 573 }
 574 
 575 
 576 #if !PLATFORM(GTK)
 577 
 578 void ContextMenuController::createAndAppendSpellingAndGrammarSubMenu(ContextMenuItem&amp; spellingAndGrammarMenuItem)
 579 {
 580     ContextMenu spellingAndGrammarMenu;
 581 
 582     ContextMenuItem showSpellingPanel(ActionType, ContextMenuItemTagShowSpellingPanel,
 583         contextMenuItemTagShowSpellingPanel(true));
 584     ContextMenuItem checkSpelling(ActionType, ContextMenuItemTagCheckSpelling,
 585         contextMenuItemTagCheckSpelling());
 586     ContextMenuItem checkAsYouType(CheckableActionType, ContextMenuItemTagCheckSpellingWhileTyping,
 587         contextMenuItemTagCheckSpellingWhileTyping());
 588     ContextMenuItem grammarWithSpelling(CheckableActionType, ContextMenuItemTagCheckGrammarWithSpelling,
 589         contextMenuItemTagCheckGrammarWithSpelling());
 590 #if PLATFORM(COCOA)
 591     ContextMenuItem correctSpelling(CheckableActionType, ContextMenuItemTagCorrectSpellingAutomatically,
 592         contextMenuItemTagCorrectSpellingAutomatically());
 593 #endif
 594 
 595     appendItem(showSpellingPanel, &amp;spellingAndGrammarMenu);
 596     appendItem(checkSpelling, &amp;spellingAndGrammarMenu);
 597 #if PLATFORM(COCOA)
 598     appendItem(*separatorItem(), &amp;spellingAndGrammarMenu);
 599 #endif
 600     appendItem(checkAsYouType, &amp;spellingAndGrammarMenu);
 601     appendItem(grammarWithSpelling, &amp;spellingAndGrammarMenu);
 602 #if PLATFORM(COCOA)
 603     appendItem(correctSpelling, &amp;spellingAndGrammarMenu);
 604 #endif
 605 
 606     spellingAndGrammarMenuItem.setSubMenu(&amp;spellingAndGrammarMenu);
 607 }
 608 
 609 #endif // !PLATFORM(GTK)
 610 
 611 
 612 #if PLATFORM(COCOA)
 613 
 614 void ContextMenuController::createAndAppendSpeechSubMenu(ContextMenuItem&amp; speechMenuItem)
 615 {
 616     ContextMenu speechMenu;
 617 
 618     ContextMenuItem start(ActionType, ContextMenuItemTagStartSpeaking, contextMenuItemTagStartSpeaking());
 619     ContextMenuItem stop(ActionType, ContextMenuItemTagStopSpeaking, contextMenuItemTagStopSpeaking());
 620 
 621     appendItem(start, &amp;speechMenu);
 622     appendItem(stop, &amp;speechMenu);
 623 
 624     speechMenuItem.setSubMenu(&amp;speechMenu);
 625 }
 626 
 627 #endif
 628 
 629 #if PLATFORM(GTK)
 630 
 631 void ContextMenuController::createAndAppendUnicodeSubMenu(ContextMenuItem&amp; unicodeMenuItem)
 632 {
 633     ContextMenu unicodeMenu;
 634 
 635     ContextMenuItem leftToRightMarkMenuItem(ActionType, ContextMenuItemTagUnicodeInsertLRMMark, contextMenuItemTagUnicodeInsertLRMMark());
 636     ContextMenuItem rightToLeftMarkMenuItem(ActionType, ContextMenuItemTagUnicodeInsertRLMMark, contextMenuItemTagUnicodeInsertRLMMark());
 637     ContextMenuItem leftToRightEmbedMenuItem(ActionType, ContextMenuItemTagUnicodeInsertLREMark, contextMenuItemTagUnicodeInsertLREMark());
 638     ContextMenuItem rightToLeftEmbedMenuItem(ActionType, ContextMenuItemTagUnicodeInsertRLEMark, contextMenuItemTagUnicodeInsertRLEMark());
 639     ContextMenuItem leftToRightOverrideMenuItem(ActionType, ContextMenuItemTagUnicodeInsertLROMark, contextMenuItemTagUnicodeInsertLROMark());
 640     ContextMenuItem rightToLeftOverrideMenuItem(ActionType, ContextMenuItemTagUnicodeInsertRLOMark, contextMenuItemTagUnicodeInsertRLOMark());
 641     ContextMenuItem popDirectionalFormattingMenuItem(ActionType, ContextMenuItemTagUnicodeInsertPDFMark, contextMenuItemTagUnicodeInsertPDFMark());
 642     ContextMenuItem zeroWidthSpaceMenuItem(ActionType, ContextMenuItemTagUnicodeInsertZWSMark, contextMenuItemTagUnicodeInsertZWSMark());
 643     ContextMenuItem zeroWidthJoinerMenuItem(ActionType, ContextMenuItemTagUnicodeInsertZWJMark, contextMenuItemTagUnicodeInsertZWJMark());
 644     ContextMenuItem zeroWidthNonJoinerMenuItem(ActionType, ContextMenuItemTagUnicodeInsertZWNJMark, contextMenuItemTagUnicodeInsertZWNJMark());
 645 
 646     appendItem(leftToRightMarkMenuItem, &amp;unicodeMenu);
 647     appendItem(rightToLeftMarkMenuItem, &amp;unicodeMenu);
 648     appendItem(leftToRightEmbedMenuItem, &amp;unicodeMenu);
 649     appendItem(rightToLeftEmbedMenuItem, &amp;unicodeMenu);
 650     appendItem(leftToRightOverrideMenuItem, &amp;unicodeMenu);
 651     appendItem(rightToLeftOverrideMenuItem, &amp;unicodeMenu);
 652     appendItem(popDirectionalFormattingMenuItem, &amp;unicodeMenu);
 653     appendItem(zeroWidthSpaceMenuItem, &amp;unicodeMenu);
 654     appendItem(zeroWidthJoinerMenuItem, &amp;unicodeMenu);
 655     appendItem(zeroWidthNonJoinerMenuItem, &amp;unicodeMenu);
 656 
 657     unicodeMenuItem.setSubMenu(&amp;unicodeMenu);
 658 }
 659 
 660 #else
 661 
 662 void ContextMenuController::createAndAppendWritingDirectionSubMenu(ContextMenuItem&amp; writingDirectionMenuItem)
 663 {
 664     ContextMenu writingDirectionMenu;
 665 
 666     ContextMenuItem defaultItem(ActionType, ContextMenuItemTagDefaultDirection,
 667         contextMenuItemTagDefaultDirection());
 668     ContextMenuItem ltr(CheckableActionType, ContextMenuItemTagLeftToRight, contextMenuItemTagLeftToRight());
 669     ContextMenuItem rtl(CheckableActionType, ContextMenuItemTagRightToLeft, contextMenuItemTagRightToLeft());
 670 
 671     appendItem(defaultItem, &amp;writingDirectionMenu);
 672     appendItem(ltr, &amp;writingDirectionMenu);
 673     appendItem(rtl, &amp;writingDirectionMenu);
 674 
 675     writingDirectionMenuItem.setSubMenu(&amp;writingDirectionMenu);
 676 }
 677 
 678 void ContextMenuController::createAndAppendTextDirectionSubMenu(ContextMenuItem&amp; textDirectionMenuItem)
 679 {
 680     ContextMenu textDirectionMenu;
 681 
 682     ContextMenuItem defaultItem(ActionType, ContextMenuItemTagTextDirectionDefault, contextMenuItemTagDefaultDirection());
 683     ContextMenuItem ltr(CheckableActionType, ContextMenuItemTagTextDirectionLeftToRight, contextMenuItemTagLeftToRight());
 684     ContextMenuItem rtl(CheckableActionType, ContextMenuItemTagTextDirectionRightToLeft, contextMenuItemTagRightToLeft());
 685 
 686     appendItem(defaultItem, &amp;textDirectionMenu);
 687     appendItem(ltr, &amp;textDirectionMenu);
 688     appendItem(rtl, &amp;textDirectionMenu);
 689 
 690     textDirectionMenuItem.setSubMenu(&amp;textDirectionMenu);
 691 }
 692 
 693 #endif
 694 
 695 #if PLATFORM(COCOA)
 696 
 697 void ContextMenuController::createAndAppendSubstitutionsSubMenu(ContextMenuItem&amp; substitutionsMenuItem)
 698 {
 699     ContextMenu substitutionsMenu;
 700 
 701     ContextMenuItem showSubstitutions(ActionType, ContextMenuItemTagShowSubstitutions, contextMenuItemTagShowSubstitutions(true));
 702     ContextMenuItem smartCopyPaste(CheckableActionType, ContextMenuItemTagSmartCopyPaste, contextMenuItemTagSmartCopyPaste());
 703     ContextMenuItem smartQuotes(CheckableActionType, ContextMenuItemTagSmartQuotes, contextMenuItemTagSmartQuotes());
 704     ContextMenuItem smartDashes(CheckableActionType, ContextMenuItemTagSmartDashes, contextMenuItemTagSmartDashes());
 705     ContextMenuItem smartLinks(CheckableActionType, ContextMenuItemTagSmartLinks, contextMenuItemTagSmartLinks());
 706     ContextMenuItem textReplacement(CheckableActionType, ContextMenuItemTagTextReplacement, contextMenuItemTagTextReplacement());
 707 
 708     appendItem(showSubstitutions, &amp;substitutionsMenu);
 709     appendItem(*separatorItem(), &amp;substitutionsMenu);
 710     appendItem(smartCopyPaste, &amp;substitutionsMenu);
 711     appendItem(smartQuotes, &amp;substitutionsMenu);
 712     appendItem(smartDashes, &amp;substitutionsMenu);
 713     appendItem(smartLinks, &amp;substitutionsMenu);
 714     appendItem(textReplacement, &amp;substitutionsMenu);
 715 
 716     substitutionsMenuItem.setSubMenu(&amp;substitutionsMenu);
 717 }
 718 
 719 void ContextMenuController::createAndAppendTransformationsSubMenu(ContextMenuItem&amp; transformationsMenuItem)
 720 {
 721     ContextMenu transformationsMenu;
 722 
 723     ContextMenuItem makeUpperCase(ActionType, ContextMenuItemTagMakeUpperCase, contextMenuItemTagMakeUpperCase());
 724     ContextMenuItem makeLowerCase(ActionType, ContextMenuItemTagMakeLowerCase, contextMenuItemTagMakeLowerCase());
 725     ContextMenuItem capitalize(ActionType, ContextMenuItemTagCapitalize, contextMenuItemTagCapitalize());
 726 
 727     appendItem(makeUpperCase, &amp;transformationsMenu);
 728     appendItem(makeLowerCase, &amp;transformationsMenu);
 729     appendItem(capitalize, &amp;transformationsMenu);
 730 
 731     transformationsMenuItem.setSubMenu(&amp;transformationsMenu);
 732 }
 733 
 734 #endif
 735 
 736 #if PLATFORM(COCOA)
 737 #define SUPPORTS_TOGGLE_VIDEO_FULLSCREEN 1
 738 #else
 739 #define SUPPORTS_TOGGLE_VIDEO_FULLSCREEN 0
 740 #endif
 741 
 742 #if PLATFORM(COCOA)
 743 #define SUPPORTS_TOGGLE_SHOW_HIDE_MEDIA_CONTROLS 1
 744 #else
 745 #define SUPPORTS_TOGGLE_SHOW_HIDE_MEDIA_CONTROLS 0
 746 #endif
 747 
 748 void ContextMenuController::populate()
 749 {
 750     ContextMenuItem OpenLinkItem(ActionType, ContextMenuItemTagOpenLink, contextMenuItemTagOpenLink());
 751     ContextMenuItem OpenLinkInNewWindowItem(ActionType, ContextMenuItemTagOpenLinkInNewWindow,
 752         contextMenuItemTagOpenLinkInNewWindow());
 753     ContextMenuItem DownloadFileItem(ActionType, ContextMenuItemTagDownloadLinkToDisk,
 754         contextMenuItemTagDownloadLinkToDisk());
 755     ContextMenuItem CopyLinkItem(ActionType, ContextMenuItemTagCopyLinkToClipboard,
 756         contextMenuItemTagCopyLinkToClipboard());
 757     ContextMenuItem OpenImageInNewWindowItem(ActionType, ContextMenuItemTagOpenImageInNewWindow,
 758         contextMenuItemTagOpenImageInNewWindow());
 759     ContextMenuItem DownloadImageItem(ActionType, ContextMenuItemTagDownloadImageToDisk,
 760         contextMenuItemTagDownloadImageToDisk());
 761     ContextMenuItem CopyImageItem(ActionType, ContextMenuItemTagCopyImageToClipboard,
 762         contextMenuItemTagCopyImageToClipboard());
 763 #if PLATFORM(GTK)
 764     ContextMenuItem CopyImageUrlItem(ActionType, ContextMenuItemTagCopyImageUrlToClipboard,
 765         contextMenuItemTagCopyImageUrlToClipboard());
 766 #endif
 767     ContextMenuItem OpenMediaInNewWindowItem(ActionType, ContextMenuItemTagOpenMediaInNewWindow, String());
 768     ContextMenuItem DownloadMediaItem(ActionType, ContextMenuItemTagDownloadMediaToDisk, String());
 769     ContextMenuItem CopyMediaLinkItem(ActionType, ContextMenuItemTagCopyMediaLinkToClipboard, String());
 770     ContextMenuItem MediaPlayPause(ActionType, ContextMenuItemTagMediaPlayPause,
 771         contextMenuItemTagMediaPlay());
 772     ContextMenuItem MediaMute(ActionType, ContextMenuItemTagMediaMute,
 773         contextMenuItemTagMediaMute());
 774 #if SUPPORTS_TOGGLE_SHOW_HIDE_MEDIA_CONTROLS
 775     ContextMenuItem ToggleMediaControls(ActionType, ContextMenuItemTagToggleMediaControls,
 776         contextMenuItemTagHideMediaControls());
 777 #else
 778     ContextMenuItem ToggleMediaControls(CheckableActionType, ContextMenuItemTagToggleMediaControls,
 779         contextMenuItemTagToggleMediaControls());
 780 #endif
 781     ContextMenuItem ToggleMediaLoop(CheckableActionType, ContextMenuItemTagToggleMediaLoop,
 782         contextMenuItemTagToggleMediaLoop());
 783     ContextMenuItem EnterVideoFullscreen(ActionType, ContextMenuItemTagEnterVideoFullscreen,
 784         contextMenuItemTagEnterVideoFullscreen());
 785     ContextMenuItem ToggleVideoFullscreen(ActionType, ContextMenuItemTagToggleVideoFullscreen,
 786         contextMenuItemTagEnterVideoFullscreen());
 787 #if PLATFORM(MAC) &amp;&amp; ENABLE(VIDEO_PRESENTATION_MODE)
 788     ContextMenuItem ToggleVideoEnhancedFullscreen(ActionType, ContextMenuItemTagToggleVideoEnhancedFullscreen, contextMenuItemTagEnterVideoEnhancedFullscreen());
 789 #endif
 790 #if PLATFORM(COCOA)
 791     ContextMenuItem SearchSpotlightItem(ActionType, ContextMenuItemTagSearchInSpotlight,
 792         contextMenuItemTagSearchInSpotlight());
 793 #endif
 794 #if !PLATFORM(GTK)
 795     ContextMenuItem SearchWebItem(ActionType, ContextMenuItemTagSearchWeb, contextMenuItemTagSearchWeb());
 796 #endif
 797     ContextMenuItem CopyItem(ActionType, ContextMenuItemTagCopy, contextMenuItemTagCopy());
 798     ContextMenuItem BackItem(ActionType, ContextMenuItemTagGoBack, contextMenuItemTagGoBack());
 799     ContextMenuItem ForwardItem(ActionType, ContextMenuItemTagGoForward,  contextMenuItemTagGoForward());
 800     ContextMenuItem StopItem(ActionType, ContextMenuItemTagStop, contextMenuItemTagStop());
 801     ContextMenuItem ReloadItem(ActionType, ContextMenuItemTagReload, contextMenuItemTagReload());
 802     ContextMenuItem OpenFrameItem(ActionType, ContextMenuItemTagOpenFrameInNewWindow,
 803         contextMenuItemTagOpenFrameInNewWindow());
 804     ContextMenuItem NoGuessesItem(ActionType, ContextMenuItemTagNoGuessesFound,
 805         contextMenuItemTagNoGuessesFound());
 806     ContextMenuItem IgnoreSpellingItem(ActionType, ContextMenuItemTagIgnoreSpelling,
 807         contextMenuItemTagIgnoreSpelling());
 808     ContextMenuItem LearnSpellingItem(ActionType, ContextMenuItemTagLearnSpelling,
 809         contextMenuItemTagLearnSpelling());
 810     ContextMenuItem IgnoreGrammarItem(ActionType, ContextMenuItemTagIgnoreGrammar,
 811         contextMenuItemTagIgnoreGrammar());
 812     ContextMenuItem CutItem(ActionType, ContextMenuItemTagCut, contextMenuItemTagCut());
 813     ContextMenuItem PasteItem(ActionType, ContextMenuItemTagPaste, contextMenuItemTagPaste());
 814 #if PLATFORM(GTK)
 815     ContextMenuItem DeleteItem(ActionType, ContextMenuItemTagDelete, contextMenuItemTagDelete());
 816     ContextMenuItem SelectAllItem(ActionType, ContextMenuItemTagSelectAll, contextMenuItemTagSelectAll());
 817     ContextMenuItem InsertEmojiItem(ActionType, ContextMenuItemTagInsertEmoji, contextMenuItemTagInsertEmoji());
 818 #endif
 819 
 820 #if PLATFORM(GTK) || PLATFORM(WIN)
 821     ContextMenuItem ShareMenuItem;
 822 #else
 823     ContextMenuItem ShareMenuItem(SubmenuType, ContextMenuItemTagShareMenu, emptyString());
 824 #endif
 825 
 826     Node* node = m_context.hitTestResult().innerNonSharedNode();
 827     if (!node)
 828         return;
 829 #if PLATFORM(GTK)
 830     if (!m_context.hitTestResult().isContentEditable() &amp;&amp; is&lt;HTMLFormControlElement&gt;(*node))
 831         return;
 832 #endif
 833     Frame* frame = node-&gt;document().frame();
 834     if (!frame)
 835         return;
 836 
 837 #if ENABLE(SERVICE_CONTROLS)
 838     // The default image control menu gets populated solely by the platform.
 839     if (m_context.controlledImage())
 840         return;
 841 #endif
 842 
 843     if (!m_context.hitTestResult().isContentEditable()) {
 844         String selectedString = m_context.hitTestResult().selectedText();
 845         m_context.setSelectedText(selectedString);
 846 
 847         FrameLoader&amp; loader = frame-&gt;loader();
 848         URL linkURL = m_context.hitTestResult().absoluteLinkURL();
 849         if (!linkURL.isEmpty()) {
 850             if (loader.client().canHandleRequest(ResourceRequest(linkURL))) {
 851                 appendItem(OpenLinkItem, m_contextMenu.get());
 852                 appendItem(OpenLinkInNewWindowItem, m_contextMenu.get());
 853                 appendItem(DownloadFileItem, m_contextMenu.get());
 854             }
 855             appendItem(CopyLinkItem, m_contextMenu.get());
 856         }
 857 
 858         URL imageURL = m_context.hitTestResult().absoluteImageURL();
 859         if (!imageURL.isEmpty()) {
 860             if (!linkURL.isEmpty())
 861                 appendItem(*separatorItem(), m_contextMenu.get());
 862 
 863             appendItem(OpenImageInNewWindowItem, m_contextMenu.get());
 864             appendItem(DownloadImageItem, m_contextMenu.get());
 865             if (imageURL.isLocalFile() || m_context.hitTestResult().image())
 866                 appendItem(CopyImageItem, m_contextMenu.get());
 867 #if PLATFORM(GTK)
 868             appendItem(CopyImageUrlItem, m_contextMenu.get());
 869 #endif
 870         }
 871 
 872         URL mediaURL = m_context.hitTestResult().absoluteMediaURL();
 873         if (!mediaURL.isEmpty()) {
 874             if (!linkURL.isEmpty() || !imageURL.isEmpty())
 875                 appendItem(*separatorItem(), m_contextMenu.get());
 876 
 877             appendItem(MediaPlayPause, m_contextMenu.get());
 878             appendItem(MediaMute, m_contextMenu.get());
 879             appendItem(ToggleMediaControls, m_contextMenu.get());
 880             appendItem(ToggleMediaLoop, m_contextMenu.get());
 881 #if SUPPORTS_TOGGLE_VIDEO_FULLSCREEN
 882             appendItem(ToggleVideoFullscreen, m_contextMenu.get());
 883 #else
 884             appendItem(EnterVideoFullscreen, m_contextMenu.get());
 885 #endif
 886 #if PLATFORM(MAC) &amp;&amp; ENABLE(VIDEO_PRESENTATION_MODE)
 887             appendItem(ToggleVideoEnhancedFullscreen, m_contextMenu.get());
 888 #endif
 889             if (m_context.hitTestResult().isDownloadableMedia() &amp;&amp; loader.client().canHandleRequest(ResourceRequest(mediaURL))) {
 890                 appendItem(*separatorItem(), m_contextMenu.get());
 891                 appendItem(CopyMediaLinkItem, m_contextMenu.get());
 892                 appendItem(OpenMediaInNewWindowItem, m_contextMenu.get());
 893                 appendItem(DownloadMediaItem, m_contextMenu.get());
 894             }
 895         }
 896 
 897         if (imageURL.isEmpty() &amp;&amp; linkURL.isEmpty() &amp;&amp; mediaURL.isEmpty()) {
 898             if (m_context.hitTestResult().isSelected()) {
 899                 if (!selectedString.isEmpty()) {
 900 #if PLATFORM(COCOA)
 901                     ContextMenuItem LookUpInDictionaryItem(ActionType, ContextMenuItemTagLookUpInDictionary, contextMenuItemTagLookUpInDictionary(selectedString));
 902 
 903                     appendItem(LookUpInDictionaryItem, m_contextMenu.get());
 904 #endif
 905 
 906 #if !PLATFORM(GTK)
 907                     appendItem(SearchWebItem, m_contextMenu.get());
 908                     appendItem(*separatorItem(), m_contextMenu.get());
 909 #endif
 910                 }
 911 
 912                 appendItem(CopyItem, m_contextMenu.get());
 913 #if PLATFORM(COCOA)
 914                 appendItem(*separatorItem(), m_contextMenu.get());
 915 
 916                 appendItem(ShareMenuItem, m_contextMenu.get());
 917                 appendItem(*separatorItem(), m_contextMenu.get());
 918 
 919                 ContextMenuItem SpeechMenuItem(SubmenuType, ContextMenuItemTagSpeechMenu, contextMenuItemTagSpeechMenu());
 920                 createAndAppendSpeechSubMenu(SpeechMenuItem);
 921                 appendItem(SpeechMenuItem, m_contextMenu.get());
 922 #endif
 923             } else {
 924                 if (!(frame-&gt;page() &amp;&amp; (frame-&gt;page()-&gt;inspectorController().inspectionLevel() &gt; 0 || frame-&gt;page()-&gt;inspectorController().hasRemoteFrontend()))) {
 925 
 926                 // In GTK+ unavailable items are not hidden but insensitive.
 927 #if PLATFORM(GTK)
 928                 appendItem(BackItem, m_contextMenu.get());
 929                 appendItem(ForwardItem, m_contextMenu.get());
 930                 appendItem(StopItem, m_contextMenu.get());
 931                 appendItem(ReloadItem, m_contextMenu.get());
 932 #else
 933                 if (frame-&gt;page() &amp;&amp; frame-&gt;page()-&gt;backForward().canGoBackOrForward(-1))
 934                     appendItem(BackItem, m_contextMenu.get());
 935 
 936                 if (frame-&gt;page() &amp;&amp; frame-&gt;page()-&gt;backForward().canGoBackOrForward(1))
 937                     appendItem(ForwardItem, m_contextMenu.get());
 938 
 939                 // use isLoadingInAPISense rather than isLoading because Stop/Reload are
 940                 // intended to match WebKit&#39;s API, not WebCore&#39;s internal notion of loading status
 941                 if (loader.documentLoader()-&gt;isLoadingInAPISense())
 942                     appendItem(StopItem, m_contextMenu.get());
 943                 else
 944                     appendItem(ReloadItem, m_contextMenu.get());
 945 #endif
 946                 }
 947 
 948                 if (frame-&gt;page() &amp;&amp; !frame-&gt;isMainFrame())
 949                     appendItem(OpenFrameItem, m_contextMenu.get());
 950 
 951                 if (!ShareMenuItem.isNull()) {
 952                     appendItem(*separatorItem(), m_contextMenu.get());
 953                     appendItem(ShareMenuItem, m_contextMenu.get());
 954                 }
 955             }
 956         } else if (!ShareMenuItem.isNull()) {
 957             appendItem(*separatorItem(), m_contextMenu.get());
 958             appendItem(ShareMenuItem, m_contextMenu.get());
 959         }
 960     } else { // Make an editing context menu
 961         bool inPasswordField = frame-&gt;selection().selection().isInPasswordField();
 962         if (!inPasswordField) {
 963             bool haveContextMenuItemsForMisspellingOrGrammer = false;
 964             bool spellCheckingEnabled = frame-&gt;editor().isSpellCheckingEnabledFor(node);
 965             if (spellCheckingEnabled) {
 966                 // Consider adding spelling-related or grammar-related context menu items (never both, since a single selected range
 967                 // is never considered a misspelling and bad grammar at the same time)
 968                 bool misspelling;
 969                 bool badGrammar;
 970                 Vector&lt;String&gt; guesses = frame-&gt;editor().guessesForMisspelledOrUngrammatical(misspelling, badGrammar);
 971                 if (misspelling || badGrammar) {
 972                     if (guesses.isEmpty()) {
 973                         // If there&#39;s bad grammar but no suggestions (e.g., repeated word), just leave off the suggestions
 974                         // list and trailing separator rather than adding a &quot;No Guesses Found&quot; item (matches AppKit)
 975                         if (misspelling) {
 976                             appendItem(NoGuessesItem, m_contextMenu.get());
 977                             appendItem(*separatorItem(), m_contextMenu.get());
 978                         }
 979                     } else {
 980                         for (const auto&amp; guess : guesses) {
 981                             if (!guess.isEmpty()) {
 982                                 ContextMenuItem item(ActionType, ContextMenuItemTagSpellingGuess, guess);
 983                                 appendItem(item, m_contextMenu.get());
 984                             }
 985                         }
 986                         appendItem(*separatorItem(), m_contextMenu.get());
 987                     }
 988                     if (misspelling) {
 989                         appendItem(IgnoreSpellingItem, m_contextMenu.get());
 990                         appendItem(LearnSpellingItem, m_contextMenu.get());
 991                     } else
 992                         appendItem(IgnoreGrammarItem, m_contextMenu.get());
 993                     appendItem(*separatorItem(), m_contextMenu.get());
 994                     haveContextMenuItemsForMisspellingOrGrammer = true;
 995 #if PLATFORM(COCOA)
 996                 } else {
 997                     // If the string was autocorrected, generate a contextual menu item allowing it to be changed back.
 998                     String replacedString = m_context.hitTestResult().replacedString();
 999                     if (!replacedString.isEmpty()) {
1000                         ContextMenuItem item(ActionType, ContextMenuItemTagChangeBack, contextMenuItemTagChangeBack(replacedString));
1001                         appendItem(item, m_contextMenu.get());
1002                         appendItem(*separatorItem(), m_contextMenu.get());
1003                         haveContextMenuItemsForMisspellingOrGrammer = true;
1004                     }
1005 #endif
1006                 }
1007             }
1008 
1009             if (!haveContextMenuItemsForMisspellingOrGrammer) {
1010                 // Spelling and grammar checking is mutually exclusive with dictation alternatives.
1011                 Vector&lt;String&gt; dictationAlternatives = m_context.hitTestResult().dictationAlternatives();
1012                 if (!dictationAlternatives.isEmpty()) {
1013                     for (auto&amp; alternative : dictationAlternatives) {
1014                         ContextMenuItem item(ActionType, ContextMenuItemTagDictationAlternative, alternative);
1015                         appendItem(item, m_contextMenu.get());
1016                     }
1017                     appendItem(*separatorItem(), m_contextMenu.get());
1018                 }
1019             }
1020         }
1021 
1022         FrameLoader&amp; loader = frame-&gt;loader();
1023         URL linkURL = m_context.hitTestResult().absoluteLinkURL();
1024         if (!linkURL.isEmpty()) {
1025             if (loader.client().canHandleRequest(ResourceRequest(linkURL))) {
1026                 appendItem(OpenLinkItem, m_contextMenu.get());
1027                 appendItem(OpenLinkInNewWindowItem, m_contextMenu.get());
1028                 appendItem(DownloadFileItem, m_contextMenu.get());
1029             }
1030             appendItem(CopyLinkItem, m_contextMenu.get());
1031             appendItem(*separatorItem(), m_contextMenu.get());
1032         }
1033 
1034         String selectedText = m_context.hitTestResult().selectedText();
1035         if (m_context.hitTestResult().isSelected() &amp;&amp; !inPasswordField &amp;&amp; !selectedText.isEmpty()) {
1036 #if PLATFORM(COCOA)
1037             ContextMenuItem LookUpInDictionaryItem(ActionType, ContextMenuItemTagLookUpInDictionary, contextMenuItemTagLookUpInDictionary(selectedText));
1038 
1039             appendItem(LookUpInDictionaryItem, m_contextMenu.get());
1040 #endif
1041 
1042 #if !PLATFORM(GTK)
1043             appendItem(SearchWebItem, m_contextMenu.get());
1044             appendItem(*separatorItem(), m_contextMenu.get());
1045 #endif
1046         }
1047 
1048         appendItem(CutItem, m_contextMenu.get());
1049         appendItem(CopyItem, m_contextMenu.get());
1050         appendItem(PasteItem, m_contextMenu.get());
1051 #if PLATFORM(GTK)
1052         appendItem(DeleteItem, m_contextMenu.get());
1053         appendItem(*separatorItem(), m_contextMenu.get());
1054         appendItem(SelectAllItem, m_contextMenu.get());
1055         appendItem(InsertEmojiItem, m_contextMenu.get());
1056 #endif
1057 
1058         if (!inPasswordField) {
1059 #if !PLATFORM(GTK)
1060             appendItem(*separatorItem(), m_contextMenu.get());
1061             ContextMenuItem SpellingAndGrammarMenuItem(SubmenuType, ContextMenuItemTagSpellingMenu,
1062                 contextMenuItemTagSpellingMenu());
1063             createAndAppendSpellingAndGrammarSubMenu(SpellingAndGrammarMenuItem);
1064             appendItem(SpellingAndGrammarMenuItem, m_contextMenu.get());
1065 #endif
1066 #if PLATFORM(COCOA)
1067             ContextMenuItem substitutionsMenuItem(SubmenuType, ContextMenuItemTagSubstitutionsMenu,
1068                 contextMenuItemTagSubstitutionsMenu());
1069             createAndAppendSubstitutionsSubMenu(substitutionsMenuItem);
1070             appendItem(substitutionsMenuItem, m_contextMenu.get());
1071             ContextMenuItem transformationsMenuItem(SubmenuType, ContextMenuItemTagTransformationsMenu,
1072                 contextMenuItemTagTransformationsMenu());
1073             createAndAppendTransformationsSubMenu(transformationsMenuItem);
1074             appendItem(transformationsMenuItem, m_contextMenu.get());
1075 #endif
1076 #if PLATFORM(GTK)
1077             bool shouldShowFontMenu = frame-&gt;editor().canEditRichly();
1078 #else
1079             bool shouldShowFontMenu = true;
1080 #endif
1081             if (shouldShowFontMenu) {
1082                 ContextMenuItem FontMenuItem(SubmenuType, ContextMenuItemTagFontMenu,
1083                     contextMenuItemTagFontMenu());
1084                 createAndAppendFontSubMenu(FontMenuItem);
1085                 appendItem(FontMenuItem, m_contextMenu.get());
1086             }
1087 #if PLATFORM(COCOA)
1088             ContextMenuItem SpeechMenuItem(SubmenuType, ContextMenuItemTagSpeechMenu, contextMenuItemTagSpeechMenu());
1089             createAndAppendSpeechSubMenu(SpeechMenuItem);
1090             appendItem(SpeechMenuItem, m_contextMenu.get());
1091 #endif
1092 #if PLATFORM(GTK)
1093             EditorClient* client = frame-&gt;editor().client();
1094             if (client &amp;&amp; client-&gt;shouldShowUnicodeMenu()) {
1095                 ContextMenuItem UnicodeMenuItem(SubmenuType, ContextMenuItemTagUnicode, contextMenuItemTagUnicode());
1096                 createAndAppendUnicodeSubMenu(UnicodeMenuItem);
1097                 appendItem(*separatorItem(), m_contextMenu.get());
1098                 appendItem(UnicodeMenuItem, m_contextMenu.get());
1099             }
1100 #else
1101             ContextMenuItem WritingDirectionMenuItem(SubmenuType, ContextMenuItemTagWritingDirectionMenu,
1102                 contextMenuItemTagWritingDirectionMenu());
1103             createAndAppendWritingDirectionSubMenu(WritingDirectionMenuItem);
1104             appendItem(WritingDirectionMenuItem, m_contextMenu.get());
1105             if (Page* page = frame-&gt;page()) {
1106                 bool includeTextDirectionSubmenu = page-&gt;settings().textDirectionSubmenuInclusionBehavior() == TextDirectionSubmenuAlwaysIncluded
1107                     || (page-&gt;settings().textDirectionSubmenuInclusionBehavior() == TextDirectionSubmenuAutomaticallyIncluded &amp;&amp; frame-&gt;editor().hasBidiSelection());
1108                 if (includeTextDirectionSubmenu) {
1109                     ContextMenuItem TextDirectionMenuItem(SubmenuType, ContextMenuItemTagTextDirectionMenu, contextMenuItemTagTextDirectionMenu());
1110                     createAndAppendTextDirectionSubMenu(TextDirectionMenuItem);
1111                     appendItem(TextDirectionMenuItem, m_contextMenu.get());
1112                 }
1113             }
1114 #endif
1115         }
1116 
1117         if (!ShareMenuItem.isNull()) {
1118             appendItem(*separatorItem(), m_contextMenu.get());
1119             appendItem(ShareMenuItem, m_contextMenu.get());
1120         }
1121     }
1122 }
1123 
1124 void ContextMenuController::addInspectElementItem()
1125 {
1126     Node* node = m_context.hitTestResult().innerNonSharedNode();
1127     if (!node)
1128         return;
1129 
1130     Frame* frame = node-&gt;document().frame();
1131     if (!frame)
1132         return;
1133 
1134     Page* page = frame-&gt;page();
1135     if (!page)
1136         return;
1137 
1138     ContextMenuItem InspectElementItem(ActionType, ContextMenuItemTagInspectElement, contextMenuItemTagInspectElement());
1139     if (m_contextMenu &amp;&amp; !m_contextMenu-&gt;items().isEmpty())
1140         appendItem(*separatorItem(), m_contextMenu.get());
1141     appendItem(InspectElementItem, m_contextMenu.get());
1142 }
1143 
1144 void ContextMenuController::checkOrEnableIfNeeded(ContextMenuItem&amp; item) const
1145 {
1146     if (item.type() == SeparatorType)
1147         return;
1148 
1149     Frame* frame = m_context.hitTestResult().innerNonSharedNode()-&gt;document().frame();
1150     if (!frame)
1151         return;
1152 
1153     // Custom items already have proper checked and enabled values.
1154     if (ContextMenuItemBaseCustomTag &lt;= item.action() &amp;&amp; item.action() &lt;= ContextMenuItemLastCustomTag)
1155         return;
1156 
1157     bool shouldEnable = true;
1158     bool shouldCheck = false;
1159 
1160     switch (item.action()) {
1161         case ContextMenuItemTagCheckSpelling:
1162             shouldEnable = frame-&gt;editor().canEdit();
1163             break;
1164         case ContextMenuItemTagDefaultDirection:
1165             shouldCheck = false;
1166             shouldEnable = false;
1167             break;
1168         case ContextMenuItemTagLeftToRight:
1169         case ContextMenuItemTagRightToLeft: {
1170             String direction = item.action() == ContextMenuItemTagLeftToRight ? &quot;ltr&quot; : &quot;rtl&quot;;
1171             shouldCheck = frame-&gt;editor().selectionHasStyle(CSSPropertyDirection, direction) != FalseTriState;
1172             shouldEnable = true;
1173             break;
1174         }
1175         case ContextMenuItemTagTextDirectionDefault: {
1176             Editor::Command command = frame-&gt;editor().command(&quot;MakeTextWritingDirectionNatural&quot;);
1177             shouldCheck = command.state() == TrueTriState;
1178             shouldEnable = command.isEnabled();
1179             break;
1180         }
1181         case ContextMenuItemTagTextDirectionLeftToRight: {
1182             Editor::Command command = frame-&gt;editor().command(&quot;MakeTextWritingDirectionLeftToRight&quot;);
1183             shouldCheck = command.state() == TrueTriState;
1184             shouldEnable = command.isEnabled();
1185             break;
1186         }
1187         case ContextMenuItemTagTextDirectionRightToLeft: {
1188             Editor::Command command = frame-&gt;editor().command(&quot;MakeTextWritingDirectionRightToLeft&quot;);
1189             shouldCheck = command.state() == TrueTriState;
1190             shouldEnable = command.isEnabled();
1191             break;
1192         }
1193         case ContextMenuItemTagCopy:
1194             shouldEnable = frame-&gt;editor().canDHTMLCopy() || frame-&gt;editor().canCopy();
1195             break;
1196         case ContextMenuItemTagCut:
1197             shouldEnable = frame-&gt;editor().canDHTMLCut() || frame-&gt;editor().canCut();
1198             break;
1199         case ContextMenuItemTagIgnoreSpelling:
1200         case ContextMenuItemTagLearnSpelling:
1201             shouldEnable = frame-&gt;selection().isRange();
1202             break;
1203         case ContextMenuItemTagPaste:
1204             shouldEnable = frame-&gt;editor().canDHTMLPaste() || frame-&gt;editor().canPaste();
1205             break;
1206 #if PLATFORM(GTK)
1207         case ContextMenuItemTagDelete:
1208             shouldEnable = frame-&gt;editor().canDelete();
1209             break;
1210         case ContextMenuItemTagInsertEmoji:
1211             shouldEnable = frame-&gt;editor().canEdit();
1212             break;
1213         case ContextMenuItemTagSelectAll:
1214         case ContextMenuItemTagInputMethods:
1215         case ContextMenuItemTagUnicode:
1216         case ContextMenuItemTagUnicodeInsertLRMMark:
1217         case ContextMenuItemTagUnicodeInsertRLMMark:
1218         case ContextMenuItemTagUnicodeInsertLREMark:
1219         case ContextMenuItemTagUnicodeInsertRLEMark:
1220         case ContextMenuItemTagUnicodeInsertLROMark:
1221         case ContextMenuItemTagUnicodeInsertRLOMark:
1222         case ContextMenuItemTagUnicodeInsertPDFMark:
1223         case ContextMenuItemTagUnicodeInsertZWSMark:
1224         case ContextMenuItemTagUnicodeInsertZWJMark:
1225         case ContextMenuItemTagUnicodeInsertZWNJMark:
1226             shouldEnable = true;
1227             break;
1228 #endif
1229         case ContextMenuItemTagUnderline: {
1230             shouldCheck = frame-&gt;editor().selectionHasStyle(CSSPropertyWebkitTextDecorationsInEffect, &quot;underline&quot;) != FalseTriState;
1231             shouldEnable = frame-&gt;editor().canEditRichly();
1232             break;
1233         }
1234         case ContextMenuItemTagLookUpInDictionary:
1235             shouldEnable = frame-&gt;selection().isRange();
1236             break;
1237         case ContextMenuItemTagCheckGrammarWithSpelling:
1238             if (frame-&gt;editor().isGrammarCheckingEnabled())
1239                 shouldCheck = true;
1240             shouldEnable = true;
1241             break;
1242         case ContextMenuItemTagItalic: {
1243             shouldCheck = frame-&gt;editor().selectionHasStyle(CSSPropertyFontStyle, &quot;italic&quot;) != FalseTriState;
1244             shouldEnable = frame-&gt;editor().canEditRichly();
1245             break;
1246         }
1247         case ContextMenuItemTagBold: {
1248             shouldCheck = frame-&gt;editor().selectionHasStyle(CSSPropertyFontWeight, &quot;bold&quot;) != FalseTriState;
1249             shouldEnable = frame-&gt;editor().canEditRichly();
1250             break;
1251         }
1252         case ContextMenuItemTagOutline:
1253             shouldEnable = false;
1254             break;
1255         case ContextMenuItemTagShowSpellingPanel:
1256             if (frame-&gt;editor().spellingPanelIsShowing())
1257                 item.setTitle(contextMenuItemTagShowSpellingPanel(false));
1258             else
1259                 item.setTitle(contextMenuItemTagShowSpellingPanel(true));
1260             shouldEnable = frame-&gt;editor().canEdit();
1261             break;
1262         case ContextMenuItemTagNoGuessesFound:
1263             shouldEnable = false;
1264             break;
1265         case ContextMenuItemTagCheckSpellingWhileTyping:
1266             shouldCheck = frame-&gt;editor().isContinuousSpellCheckingEnabled();
1267             break;
1268 #if PLATFORM(COCOA)
1269         case ContextMenuItemTagSubstitutionsMenu:
1270         case ContextMenuItemTagTransformationsMenu:
1271             break;
1272         case ContextMenuItemTagShowSubstitutions:
1273             if (frame-&gt;editor().substitutionsPanelIsShowing())
1274                 item.setTitle(contextMenuItemTagShowSubstitutions(false));
1275             else
1276                 item.setTitle(contextMenuItemTagShowSubstitutions(true));
1277             shouldEnable = frame-&gt;editor().canEdit();
1278             break;
1279         case ContextMenuItemTagMakeUpperCase:
1280         case ContextMenuItemTagMakeLowerCase:
1281         case ContextMenuItemTagCapitalize:
1282         case ContextMenuItemTagChangeBack:
1283             shouldEnable = frame-&gt;editor().canEdit();
1284             break;
1285         case ContextMenuItemTagCorrectSpellingAutomatically:
1286             shouldCheck = frame-&gt;editor().isAutomaticSpellingCorrectionEnabled();
1287             break;
1288         case ContextMenuItemTagSmartCopyPaste:
1289             shouldCheck = frame-&gt;editor().smartInsertDeleteEnabled();
1290             break;
1291         case ContextMenuItemTagSmartQuotes:
1292             shouldCheck = frame-&gt;editor().isAutomaticQuoteSubstitutionEnabled();
1293             break;
1294         case ContextMenuItemTagSmartDashes:
1295             shouldCheck = frame-&gt;editor().isAutomaticDashSubstitutionEnabled();
1296             break;
1297         case ContextMenuItemTagSmartLinks:
1298             shouldCheck = frame-&gt;editor().isAutomaticLinkDetectionEnabled();
1299             break;
1300         case ContextMenuItemTagTextReplacement:
1301             shouldCheck = frame-&gt;editor().isAutomaticTextReplacementEnabled();
1302             break;
1303         case ContextMenuItemTagStopSpeaking:
1304             shouldEnable = m_client.isSpeaking();
1305             break;
1306 #else // PLATFORM(COCOA) ends here
1307         case ContextMenuItemTagStopSpeaking:
1308             break;
1309 #endif
1310 #if PLATFORM(GTK)
1311         case ContextMenuItemTagGoBack:
1312             shouldEnable = frame-&gt;page() &amp;&amp; frame-&gt;page()-&gt;backForward().canGoBackOrForward(-1);
1313             break;
1314         case ContextMenuItemTagGoForward:
1315             shouldEnable = frame-&gt;page() &amp;&amp; frame-&gt;page()-&gt;backForward().canGoBackOrForward(1);
1316             break;
1317         case ContextMenuItemTagStop:
1318             shouldEnable = frame-&gt;loader().documentLoader()-&gt;isLoadingInAPISense();
1319             break;
1320         case ContextMenuItemTagReload:
1321             shouldEnable = !frame-&gt;loader().documentLoader()-&gt;isLoadingInAPISense();
1322             break;
1323         case ContextMenuItemTagFontMenu:
1324             shouldEnable = frame-&gt;editor().canEditRichly();
1325             break;
1326 #else
1327         case ContextMenuItemTagGoBack:
1328         case ContextMenuItemTagGoForward:
1329         case ContextMenuItemTagStop:
1330         case ContextMenuItemTagReload:
1331         case ContextMenuItemTagFontMenu:
1332 #endif
1333         case ContextMenuItemTagNoAction:
1334         case ContextMenuItemTagOpenLinkInNewWindow:
1335         case ContextMenuItemTagDownloadLinkToDisk:
1336         case ContextMenuItemTagCopyLinkToClipboard:
1337         case ContextMenuItemTagOpenImageInNewWindow:
1338         case ContextMenuItemTagCopyImageToClipboard:
1339 #if PLATFORM(GTK)
1340         case ContextMenuItemTagCopyImageUrlToClipboard:
1341 #endif
1342             break;
1343         case ContextMenuItemTagDownloadImageToDisk:
1344 #if PLATFORM(MAC)
1345             if (WTF::protocolIs(m_context.hitTestResult().absoluteImageURL(), &quot;file&quot;))
1346                 shouldEnable = false;
1347 #endif
1348             break;
1349         case ContextMenuItemTagOpenMediaInNewWindow:
1350             if (m_context.hitTestResult().mediaIsVideo())
1351                 item.setTitle(contextMenuItemTagOpenVideoInNewWindow());
1352             else
1353                 item.setTitle(contextMenuItemTagOpenAudioInNewWindow());
1354             break;
1355         case ContextMenuItemTagDownloadMediaToDisk:
1356             if (m_context.hitTestResult().mediaIsVideo())
1357                 item.setTitle(contextMenuItemTagDownloadVideoToDisk());
1358             else
1359                 item.setTitle(contextMenuItemTagDownloadAudioToDisk());
1360             if (WTF::protocolIs(m_context.hitTestResult().absoluteImageURL(), &quot;file&quot;))
1361                 shouldEnable = false;
1362             break;
1363         case ContextMenuItemTagCopyMediaLinkToClipboard:
1364             if (m_context.hitTestResult().mediaIsVideo())
1365                 item.setTitle(contextMenuItemTagCopyVideoLinkToClipboard());
1366             else
1367                 item.setTitle(contextMenuItemTagCopyAudioLinkToClipboard());
1368             break;
1369         case ContextMenuItemTagToggleMediaControls:
1370 #if SUPPORTS_TOGGLE_SHOW_HIDE_MEDIA_CONTROLS
1371             item.setTitle(m_context.hitTestResult().mediaControlsEnabled() ? contextMenuItemTagHideMediaControls() : contextMenuItemTagShowMediaControls());
1372 #else
1373             shouldCheck = m_context.hitTestResult().mediaControlsEnabled();
1374 #endif
1375             break;
1376         case ContextMenuItemTagToggleMediaLoop:
1377             shouldCheck = m_context.hitTestResult().mediaLoopEnabled();
1378             break;
1379         case ContextMenuItemTagToggleVideoFullscreen:
1380 #if SUPPORTS_TOGGLE_VIDEO_FULLSCREEN
1381             item.setTitle(m_context.hitTestResult().mediaIsInFullscreen() ? contextMenuItemTagExitVideoFullscreen() : contextMenuItemTagEnterVideoFullscreen());
1382             break;
1383 #endif
1384         case ContextMenuItemTagEnterVideoFullscreen:
1385             shouldEnable = m_context.hitTestResult().mediaSupportsFullscreen();
1386             break;
1387         case ContextMenuItemTagToggleVideoEnhancedFullscreen:
1388 #if PLATFORM(MAC) &amp;&amp; ENABLE(VIDEO_PRESENTATION_MODE)
1389             item.setTitle(m_context.hitTestResult().mediaIsInEnhancedFullscreen() ? contextMenuItemTagExitVideoEnhancedFullscreen() : contextMenuItemTagEnterVideoEnhancedFullscreen());
1390 #endif
1391             shouldEnable = m_context.hitTestResult().mediaSupportsEnhancedFullscreen();
1392             break;
1393         case ContextMenuItemTagOpenFrameInNewWindow:
1394         case ContextMenuItemTagSpellingGuess:
1395         case ContextMenuItemTagOther:
1396         case ContextMenuItemTagSearchInSpotlight:
1397         case ContextMenuItemTagSearchWeb:
1398         case ContextMenuItemTagOpenWithDefaultApplication:
1399         case ContextMenuItemPDFActualSize:
1400         case ContextMenuItemPDFZoomIn:
1401         case ContextMenuItemPDFZoomOut:
1402         case ContextMenuItemPDFAutoSize:
1403         case ContextMenuItemPDFSinglePage:
1404         case ContextMenuItemPDFFacingPages:
1405         case ContextMenuItemPDFContinuous:
1406         case ContextMenuItemPDFNextPage:
1407         case ContextMenuItemPDFPreviousPage:
1408         case ContextMenuItemTagOpenLink:
1409         case ContextMenuItemTagIgnoreGrammar:
1410         case ContextMenuItemTagSpellingMenu:
1411         case ContextMenuItemTagShowFonts:
1412         case ContextMenuItemTagStyles:
1413         case ContextMenuItemTagShowColors:
1414         case ContextMenuItemTagSpeechMenu:
1415         case ContextMenuItemTagStartSpeaking:
1416         case ContextMenuItemTagWritingDirectionMenu:
1417         case ContextMenuItemTagTextDirectionMenu:
1418         case ContextMenuItemTagPDFSinglePageScrolling:
1419         case ContextMenuItemTagPDFFacingPagesScrolling:
1420         case ContextMenuItemTagInspectElement:
1421         case ContextMenuItemBaseCustomTag:
1422         case ContextMenuItemLastCustomTag:
1423         case ContextMenuItemBaseApplicationTag:
1424         case ContextMenuItemTagDictationAlternative:
1425         case ContextMenuItemTagShareMenu:
1426             break;
1427         case ContextMenuItemTagMediaPlayPause:
1428             if (m_context.hitTestResult().mediaPlaying())
1429                 item.setTitle(contextMenuItemTagMediaPause());
1430             else
1431                 item.setTitle(contextMenuItemTagMediaPlay());
1432             break;
1433         case ContextMenuItemTagMediaMute:
1434             shouldEnable = m_context.hitTestResult().mediaHasAudio();
1435             shouldCheck = shouldEnable &amp;&amp;  m_context.hitTestResult().mediaMuted();
1436             break;
1437     }
1438 
1439     item.setChecked(shouldCheck);
1440     item.setEnabled(shouldEnable);
1441 }
1442 
1443 #if USE(ACCESSIBILITY_CONTEXT_MENUS)
1444 
1445 void ContextMenuController::showContextMenuAt(Frame&amp; frame, const IntPoint&amp; clickPoint)
1446 {
1447     clearContextMenu();
1448 
1449     // Simulate a click in the middle of the accessibility object.
1450     PlatformMouseEvent mouseEvent(clickPoint, clickPoint, RightButton, PlatformEvent::MousePressed, 1, false, false, false, false, WallTime::now(), ForceAtClick, NoTap);
1451     frame.eventHandler().handleMousePressEvent(mouseEvent);
1452     bool handled = frame.eventHandler().sendContextMenuEvent(mouseEvent);
1453     if (handled)
1454         m_client.showContextMenu();
1455 }
1456 
1457 #endif
1458 
1459 #if ENABLE(SERVICE_CONTROLS)
1460 
1461 void ContextMenuController::showImageControlsMenu(Event&amp; event)
1462 {
1463     clearContextMenu();
1464     handleContextMenuEvent(event);
1465     m_client.showContextMenu();
1466 }
1467 
1468 #endif
1469 
1470 } // namespace WebCore
1471 
1472 #endif // ENABLE(CONTEXT_MENUS)
    </pre>
  </body>
</html>