<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff modules/javafx.web/src/main/native/Source/WebCore/inspector/agents/InspectorCSSAgent.cpp</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="InspectorCPUProfilerAgent.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="InspectorCSSAgent.h.sdiff.html" target="_top">next &gt;</a></center>    <h2>modules/javafx.web/src/main/native/Source/WebCore/inspector/agents/InspectorCSSAgent.cpp</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  26 #include &quot;config.h&quot;
  27 #include &quot;InspectorCSSAgent.h&quot;
  28 
  29 #include &quot;CSSComputedStyleDeclaration.h&quot;
  30 #include &quot;CSSImportRule.h&quot;
  31 #include &quot;CSSParserFastPaths.h&quot;
  32 #include &quot;CSSParserMode.h&quot;
  33 #include &quot;CSSPropertyNames.h&quot;
  34 #include &quot;CSSPropertySourceData.h&quot;
  35 #include &quot;CSSRule.h&quot;
  36 #include &quot;CSSRuleList.h&quot;
  37 #include &quot;CSSStyleRule.h&quot;
  38 #include &quot;CSSStyleSheet.h&quot;
  39 #include &quot;CSSValueKeywords.h&quot;
  40 #include &quot;ContentSecurityPolicy.h&quot;
  41 #include &quot;DOMWindow.h&quot;
  42 #include &quot;FontCache.h&quot;
  43 #include &quot;Frame.h&quot;
  44 #include &quot;HTMLHeadElement.h&quot;
  45 #include &quot;HTMLStyleElement.h&quot;

  46 #include &quot;InspectorHistory.h&quot;
  47 #include &quot;InspectorPageAgent.h&quot;
  48 #include &quot;InstrumentingAgents.h&quot;
  49 #include &quot;Node.h&quot;
  50 #include &quot;NodeList.h&quot;
  51 #include &quot;PseudoElement.h&quot;

  52 #include &quot;SVGStyleElement.h&quot;
  53 #include &quot;SelectorChecker.h&quot;
  54 #include &quot;ShadowRoot.h&quot;
  55 #include &quot;StyleProperties.h&quot;
  56 #include &quot;StylePropertyShorthand.h&quot;
  57 #include &quot;StyleResolver.h&quot;
  58 #include &quot;StyleRule.h&quot;
  59 #include &quot;StyleScope.h&quot;
  60 #include &quot;StyleSheetList.h&quot;
  61 #include &lt;JavaScriptCore/InspectorProtocolObjects.h&gt;

  62 #include &lt;wtf/Ref.h&gt;
  63 #include &lt;wtf/Vector.h&gt;
  64 #include &lt;wtf/text/CString.h&gt;
  65 #include &lt;wtf/text/StringConcatenateNumbers.h&gt;
  66 
  67 namespace WebCore {
  68 
  69 using namespace Inspector;
  70 
  71 enum ForcePseudoClassFlags {
  72     PseudoClassNone = 0,
  73     PseudoClassHover = 1 &lt;&lt; 0,
  74     PseudoClassFocus = 1 &lt;&lt; 1,
  75     PseudoClassActive = 1 &lt;&lt; 2,
  76     PseudoClassVisited = 1 &lt;&lt; 3
  77 };
  78 
  79 static unsigned computePseudoClassMask(const JSON::Array&amp; pseudoClassArray)
  80 {
  81     static NeverDestroyed&lt;String&gt; active(MAKE_STATIC_STRING_IMPL(&quot;active&quot;));
</pre>
<hr />
<pre>
 275     {
 276         auto result = m_styleSheet-&gt;addRule(m_selector);
 277         if (result.hasException())
 278             return result.releaseException();
 279         m_newId = m_styleSheet-&gt;ruleId(result.releaseReturnValue());
 280         return { };
 281     }
 282 
 283     InspectorCSSId m_newId;
 284     String m_selector;
 285     String m_oldSelector;
 286 };
 287 
 288 CSSStyleRule* InspectorCSSAgent::asCSSStyleRule(CSSRule&amp; rule)
 289 {
 290     if (!is&lt;CSSStyleRule&gt;(rule))
 291         return nullptr;
 292     return downcast&lt;CSSStyleRule&gt;(&amp;rule);
 293 }
 294 
<span class="line-modified"> 295 InspectorCSSAgent::InspectorCSSAgent(WebAgentContext&amp; context, InspectorDOMAgent* domAgent)</span>
 296     : InspectorAgentBase(&quot;CSS&quot;_s, context)
<span class="line-modified"> 297     , m_frontendDispatcher(std::make_unique&lt;CSSFrontendDispatcher&gt;(context.frontendRouter))</span>
 298     , m_backendDispatcher(CSSBackendDispatcher::create(context.backendDispatcher, this))
<span class="line-removed"> 299     , m_domAgent(domAgent)</span>
 300 {
<span class="line-removed"> 301     m_domAgent-&gt;setDOMListener(this);</span>
 302 }
 303 
<span class="line-modified"> 304 InspectorCSSAgent::~InspectorCSSAgent()</span>
<span class="line-removed"> 305 {</span>
<span class="line-removed"> 306     ASSERT(!m_domAgent);</span>
<span class="line-removed"> 307     reset();</span>
<span class="line-removed"> 308 }</span>
 309 
 310 void InspectorCSSAgent::didCreateFrontendAndBackend(Inspector::FrontendRouter*, Inspector::BackendDispatcher*)
 311 {
 312 }
 313 
 314 void InspectorCSSAgent::willDestroyFrontendAndBackend(Inspector::DisconnectReason)
 315 {
<span class="line-removed"> 316     resetNonPersistentData();</span>
<span class="line-removed"> 317 </span>
 318     String unused;
 319     disable(unused);
 320 }
 321 
<span class="line-removed"> 322 void InspectorCSSAgent::discardAgent()</span>
<span class="line-removed"> 323 {</span>
<span class="line-removed"> 324     m_domAgent-&gt;setDOMListener(nullptr);</span>
<span class="line-removed"> 325     m_domAgent = nullptr;</span>
<span class="line-removed"> 326 }</span>
<span class="line-removed"> 327 </span>
 328 void InspectorCSSAgent::reset()
 329 {
 330     // FIXME: Should we be resetting on main frame navigations?
 331     m_idToInspectorStyleSheet.clear();
 332     m_cssStyleSheetToInspectorStyleSheet.clear();
 333     m_nodeToInspectorStyleSheet.clear();
 334     m_documentToInspectorStyleSheet.clear();
 335     m_documentToKnownCSSStyleSheets.clear();
<span class="line-removed"> 336     resetNonPersistentData();</span>
<span class="line-removed"> 337 }</span>
<span class="line-removed"> 338 </span>
<span class="line-removed"> 339 void InspectorCSSAgent::resetNonPersistentData()</span>
<span class="line-removed"> 340 {</span>
 341     resetPseudoStates();
 342 }
 343 
 344 void InspectorCSSAgent::enable(ErrorString&amp;)
 345 {



 346     m_instrumentingAgents.setInspectorCSSAgent(this);
 347 
<span class="line-modified"> 348     for (auto* document : m_domAgent-&gt;documents())</span>
<span class="line-modified"> 349         activeStyleSheetsUpdated(*document);</span>


 350 }
 351 
 352 void InspectorCSSAgent::disable(ErrorString&amp;)
 353 {
 354     m_instrumentingAgents.setInspectorCSSAgent(nullptr);


 355 }
 356 
 357 void InspectorCSSAgent::documentDetached(Document&amp; document)
 358 {
 359     Vector&lt;CSSStyleSheet*&gt; emptyList;
 360     setActiveStyleSheetsForDocument(document, emptyList);
 361 
 362     m_documentToKnownCSSStyleSheets.remove(&amp;document);
 363     m_documentToInspectorStyleSheet.remove(&amp;document);
 364     m_documentsWithForcedPseudoStates.remove(&amp;document);
 365 }
 366 
 367 void InspectorCSSAgent::mediaQueryResultChanged()
 368 {
 369     m_frontendDispatcher-&gt;mediaQueryResultChanged();
 370 }
 371 
 372 void InspectorCSSAgent::activeStyleSheetsUpdated(Document&amp; document)
 373 {
 374     Vector&lt;CSSStyleSheet*&gt; cssStyleSheets;
</pre>
<hr />
<pre>
 396         if (m_idToInspectorStyleSheet.contains(inspectorStyleSheet-&gt;id())) {
 397             String id = unbindStyleSheet(inspectorStyleSheet.get());
 398             m_frontendDispatcher-&gt;styleSheetRemoved(id);
 399         }
 400     }
 401 
 402     for (auto* cssStyleSheet : addedStyleSheets) {
 403         previouslyKnownActiveStyleSheets.add(cssStyleSheet);
 404         if (!m_cssStyleSheetToInspectorStyleSheet.contains(cssStyleSheet)) {
 405             InspectorStyleSheet* inspectorStyleSheet = bindStyleSheet(cssStyleSheet);
 406             m_frontendDispatcher-&gt;styleSheetAdded(inspectorStyleSheet-&gt;buildObjectForStyleSheetInfo());
 407         }
 408     }
 409 }
 410 
 411 bool InspectorCSSAgent::forcePseudoState(const Element&amp; element, CSSSelector::PseudoClassType pseudoClassType)
 412 {
 413     if (m_nodeIdToForcedPseudoState.isEmpty())
 414         return false;
 415 
<span class="line-modified"> 416     int nodeId = m_domAgent-&gt;boundNodeId(&amp;element);</span>




 417     if (!nodeId)
 418         return false;
 419 
 420     unsigned forcedPseudoState = m_nodeIdToForcedPseudoState.get(nodeId);
 421     switch (pseudoClassType) {
 422     case CSSSelector::PseudoClassActive:
 423         return forcedPseudoState &amp; PseudoClassActive;
 424     case CSSSelector::PseudoClassFocus:
 425         return forcedPseudoState &amp; PseudoClassFocus;
 426     case CSSSelector::PseudoClassHover:
 427         return forcedPseudoState &amp; PseudoClassHover;
 428     case CSSSelector::PseudoClassVisited:
 429         return forcedPseudoState &amp; PseudoClassVisited;
 430     default:
 431         return false;
 432     }
 433 }
 434 




































 435 void InspectorCSSAgent::getMatchedStylesForNode(ErrorString&amp; errorString, int nodeId, const bool* includePseudo, const bool* includeInherited, RefPtr&lt;JSON::ArrayOf&lt;Inspector::Protocol::CSS::RuleMatch&gt;&gt;&amp; matchedCSSRules, RefPtr&lt;JSON::ArrayOf&lt;Inspector::Protocol::CSS::PseudoIdMatches&gt;&gt;&amp; pseudoIdMatches, RefPtr&lt;JSON::ArrayOf&lt;Inspector::Protocol::CSS::InheritedStyleEntry&gt;&gt;&amp; inheritedEntries)
 436 {
 437     Element* element = elementForId(errorString, nodeId);
 438     if (!element)
 439         return;
 440 
 441     Element* originalElement = element;
 442     PseudoId elementPseudoId = element-&gt;pseudoId();
 443     if (elementPseudoId != PseudoId::None) {
 444         element = downcast&lt;PseudoElement&gt;(*element).hostElement();
 445         if (!element) {
<span class="line-modified"> 446             errorString = &quot;Pseudo element has no parent&quot;_s;</span>
 447             return;
 448         }
 449     }
 450 
 451     // Matched rules.
 452     StyleResolver&amp; styleResolver = element-&gt;styleResolver();
 453     auto matchedRules = styleResolver.pseudoStyleRulesForElement(element, elementPseudoId, StyleResolver::AllCSSRules);
 454     matchedCSSRules = buildArrayForMatchedRuleList(matchedRules, styleResolver, *element, elementPseudoId);
 455 
 456     if (!originalElement-&gt;isPseudoElement()) {
 457         // Pseudo elements.
 458         if (!includePseudo || *includePseudo) {
 459             auto pseudoElements = JSON::ArrayOf&lt;Inspector::Protocol::CSS::PseudoIdMatches&gt;::create();
 460             for (PseudoId pseudoId = PseudoId::FirstPublicPseudoId; pseudoId &lt; PseudoId::AfterLastInternalPseudoId; pseudoId = static_cast&lt;PseudoId&gt;(static_cast&lt;unsigned&gt;(pseudoId) + 1)) {
<span class="line-modified"> 461                 auto matchedRules = styleResolver.pseudoStyleRulesForElement(element, pseudoId, StyleResolver::AllCSSRules);</span>
<span class="line-modified"> 462                 if (!matchedRules.isEmpty()) {</span>
<span class="line-modified"> 463                     auto matches = Inspector::Protocol::CSS::PseudoIdMatches::create()</span>
<span class="line-modified"> 464                         .setPseudoId(static_cast&lt;int&gt;(pseudoId))</span>
<span class="line-modified"> 465                         .setMatches(buildArrayForMatchedRuleList(matchedRules, styleResolver, *element, pseudoId))</span>
<span class="line-modified"> 466                         .release();</span>
<span class="line-modified"> 467                     pseudoElements-&gt;addItem(WTFMove(matches));</span>


 468                 }
 469             }
 470 
 471             pseudoIdMatches = WTFMove(pseudoElements);
 472         }
 473 
 474         // Inherited styles.
 475         if (!includeInherited || *includeInherited) {
 476             auto entries = JSON::ArrayOf&lt;Inspector::Protocol::CSS::InheritedStyleEntry&gt;::create();
 477             Element* parentElement = element-&gt;parentElement();
 478             while (parentElement) {
 479                 StyleResolver&amp; parentStyleResolver = parentElement-&gt;styleResolver();
 480                 auto parentMatchedRules = parentStyleResolver.styleRulesForElement(parentElement, StyleResolver::AllCSSRules);
 481                 auto entry = Inspector::Protocol::CSS::InheritedStyleEntry::create()
 482                     .setMatchedCSSRules(buildArrayForMatchedRuleList(parentMatchedRules, styleResolver, *parentElement, PseudoId::None))
 483                     .release();
 484                 if (is&lt;StyledElement&gt;(*parentElement) &amp;&amp; downcast&lt;StyledElement&gt;(*parentElement).cssomStyle().length()) {
 485                     auto&amp; styleSheet = asInspectorStyleSheet(downcast&lt;StyledElement&gt;(*parentElement));
 486                     entry-&gt;setInlineStyle(styleSheet.buildObjectForStyle(styleSheet.styleForId(InspectorCSSId(styleSheet.id(), 0))));
 487                 }
</pre>
<hr />
<pre>
 517         return;
 518 
 519     auto computedStyleInfo = CSSComputedStyleDeclaration::create(*element, true);
 520     auto inspectorStyle = InspectorStyle::create(InspectorCSSId(), WTFMove(computedStyleInfo), nullptr);
 521     style = inspectorStyle-&gt;buildArrayForComputedStyle();
 522 }
 523 
 524 void InspectorCSSAgent::getAllStyleSheets(ErrorString&amp;, RefPtr&lt;JSON::ArrayOf&lt;Inspector::Protocol::CSS::CSSStyleSheetHeader&gt;&gt;&amp; styleInfos)
 525 {
 526     styleInfos = JSON::ArrayOf&lt;Inspector::Protocol::CSS::CSSStyleSheetHeader&gt;::create();
 527 
 528     Vector&lt;InspectorStyleSheet*&gt; inspectorStyleSheets;
 529     collectAllStyleSheets(inspectorStyleSheets);
 530     for (auto* inspectorStyleSheet : inspectorStyleSheets)
 531         styleInfos-&gt;addItem(inspectorStyleSheet-&gt;buildObjectForStyleSheetInfo());
 532 }
 533 
 534 void InspectorCSSAgent::collectAllStyleSheets(Vector&lt;InspectorStyleSheet*&gt;&amp; result)
 535 {
 536     Vector&lt;CSSStyleSheet*&gt; cssStyleSheets;
<span class="line-modified"> 537     for (auto* document : m_domAgent-&gt;documents())</span>
<span class="line-modified"> 538         collectAllDocumentStyleSheets(*document, cssStyleSheets);</span>


 539 
 540     for (auto* cssStyleSheet : cssStyleSheets)
 541         result.append(bindStyleSheet(cssStyleSheet));
 542 }
 543 
 544 void InspectorCSSAgent::collectAllDocumentStyleSheets(Document&amp; document, Vector&lt;CSSStyleSheet*&gt;&amp; result)
 545 {
 546     auto cssStyleSheets = document.styleScope().activeStyleSheetsForInspector();
 547     for (auto&amp; cssStyleSheet : cssStyleSheets)
 548         collectStyleSheets(cssStyleSheet.get(), result);
 549 }
 550 
 551 void InspectorCSSAgent::collectStyleSheets(CSSStyleSheet* styleSheet, Vector&lt;CSSStyleSheet*&gt;&amp; result)
 552 {
 553     result.append(styleSheet);
 554 
 555     for (unsigned i = 0, size = styleSheet-&gt;length(); i &lt; size; ++i) {
 556         CSSRule* rule = styleSheet-&gt;item(i);
 557         if (is&lt;CSSImportRule&gt;(*rule)) {
 558             if (CSSStyleSheet* importedStyleSheet = downcast&lt;CSSImportRule&gt;(*rule).styleSheet())
</pre>
<hr />
<pre>
 570     styleSheetObject = inspectorStyleSheet-&gt;buildObjectForStyleSheet();
 571 }
 572 
 573 void InspectorCSSAgent::getStyleSheetText(ErrorString&amp; errorString, const String&amp; styleSheetId, String* result)
 574 {
 575     InspectorStyleSheet* inspectorStyleSheet = assertStyleSheetForId(errorString, styleSheetId);
 576     if (!inspectorStyleSheet)
 577         return;
 578 
 579     auto text = inspectorStyleSheet-&gt;text();
 580     if (!text.hasException())
 581         *result = text.releaseReturnValue();
 582 }
 583 
 584 void InspectorCSSAgent::setStyleSheetText(ErrorString&amp; errorString, const String&amp; styleSheetId, const String&amp; text)
 585 {
 586     InspectorStyleSheet* inspectorStyleSheet = assertStyleSheetForId(errorString, styleSheetId);
 587     if (!inspectorStyleSheet)
 588         return;
 589 
<span class="line-modified"> 590     auto result = m_domAgent-&gt;history()-&gt;perform(std::make_unique&lt;SetStyleSheetTextAction&gt;(inspectorStyleSheet, text));</span>






 591     if (result.hasException())
 592         errorString = InspectorDOMAgent::toErrorString(result.releaseException());
 593 }
 594 
 595 void InspectorCSSAgent::setStyleText(ErrorString&amp; errorString, const JSON::Object&amp; fullStyleId, const String&amp; text, RefPtr&lt;Inspector::Protocol::CSS::CSSStyle&gt;&amp; result)
 596 {
 597     InspectorCSSId compoundId(fullStyleId);
 598     ASSERT(!compoundId.isEmpty());
 599 
 600     InspectorStyleSheet* inspectorStyleSheet = assertStyleSheetForId(errorString, compoundId.styleSheetId());
 601     if (!inspectorStyleSheet)
 602         return;
 603 
<span class="line-modified"> 604     auto performResult = m_domAgent-&gt;history()-&gt;perform(std::make_unique&lt;SetStyleTextAction&gt;(inspectorStyleSheet, compoundId, text));</span>






 605     if (performResult.hasException()) {
 606         errorString = InspectorDOMAgent::toErrorString(performResult.releaseException());
 607         return;
 608     }
 609 
 610     result = inspectorStyleSheet-&gt;buildObjectForStyle(inspectorStyleSheet-&gt;styleForId(compoundId));
 611 }
 612 
 613 void InspectorCSSAgent::setRuleSelector(ErrorString&amp; errorString, const JSON::Object&amp; fullRuleId, const String&amp; selector, RefPtr&lt;Inspector::Protocol::CSS::CSSRule&gt;&amp; result)
 614 {
 615     InspectorCSSId compoundId(fullRuleId);
 616     ASSERT(!compoundId.isEmpty());
 617 
 618     InspectorStyleSheet* inspectorStyleSheet = assertStyleSheetForId(errorString, compoundId.styleSheetId());
 619     if (!inspectorStyleSheet)
 620         return;
 621 
<span class="line-modified"> 622     auto performResult = m_domAgent-&gt;history()-&gt;perform(std::make_unique&lt;SetRuleSelectorAction&gt;(inspectorStyleSheet, compoundId, selector));</span>






 623     if (performResult.hasException()) {
 624         errorString = InspectorDOMAgent::toErrorString(performResult.releaseException());
 625         return;
 626     }
 627 
 628     result = inspectorStyleSheet-&gt;buildObjectForRule(inspectorStyleSheet-&gt;ruleForId(compoundId), nullptr);
 629 }
 630 
 631 void InspectorCSSAgent::createStyleSheet(ErrorString&amp; errorString, const String&amp; frameId, String* styleSheetId)
 632 {
<span class="line-modified"> 633     Frame* frame = m_domAgent-&gt;pageAgent()-&gt;frameForId(frameId);</span>
<span class="line-modified"> 634     if (!frame) {</span>
<span class="line-modified"> 635         errorString = &quot;No frame for given id found&quot;_s;</span>
 636         return;
 637     }
 638 




 639     Document* document = frame-&gt;document();
 640     if (!document) {
<span class="line-modified"> 641         errorString = &quot;No document for frame&quot;_s;</span>
 642         return;
 643     }
 644 
 645     InspectorStyleSheet* inspectorStyleSheet = createInspectorStyleSheetForDocument(*document);
 646     if (!inspectorStyleSheet) {
<span class="line-modified"> 647         errorString = &quot;Could not create stylesheet for the frame.&quot;_s;</span>
 648         return;
 649     }
 650 
 651     *styleSheetId = inspectorStyleSheet-&gt;id();
 652 }
 653 
 654 InspectorStyleSheet* InspectorCSSAgent::createInspectorStyleSheetForDocument(Document&amp; document)
 655 {
 656     if (!document.isHTMLDocument() &amp;&amp; !document.isSVGDocument())
 657         return nullptr;
 658 
 659     auto styleElement = HTMLStyleElement::create(document);
<span class="line-modified"> 660     styleElement-&gt;setAttributeWithoutSynchronization(HTMLNames::typeAttr, AtomicString(&quot;text/css&quot;, AtomicString::ConstructFromLiteral));</span>
 661 
 662     ContainerNode* targetNode;
 663     // HEAD is absent in ImageDocuments, for example.
 664     if (auto* head = document.head())
 665         targetNode = head;
 666     else if (auto* body = document.bodyOrFrameset())
 667         targetNode = body;
 668     else
 669         return nullptr;
 670 
 671     // Inserting this &lt;style&gt; into the document will trigger activeStyleSheetsUpdated
 672     // and we will create an InspectorStyleSheet for this &lt;style&gt;&#39;s CSSStyleSheet.
 673     // Set this flag, so when we create it, we put it into the via inspector map.
 674     m_creatingViaInspectorStyleSheet = true;
 675     InlineStyleOverrideScope overrideScope(document);
 676     auto appendResult = targetNode-&gt;appendChild(styleElement);
 677     document.styleScope().flushPendingUpdate();
 678     m_creatingViaInspectorStyleSheet = false;
 679     if (appendResult.hasException())
 680         return nullptr;
 681 
 682     auto iterator = m_documentToInspectorStyleSheet.find(&amp;document);
 683     ASSERT(iterator != m_documentToInspectorStyleSheet.end());
 684     if (iterator == m_documentToInspectorStyleSheet.end())
 685         return nullptr;
 686 
 687     auto&amp; inspectorStyleSheetsForDocument = iterator-&gt;value;
 688     ASSERT(!inspectorStyleSheetsForDocument.isEmpty());
 689     if (inspectorStyleSheetsForDocument.isEmpty())
 690         return nullptr;
 691 
 692     return inspectorStyleSheetsForDocument.last().get();
 693 }
 694 
 695 void InspectorCSSAgent::addRule(ErrorString&amp; errorString, const String&amp; styleSheetId, const String&amp; selector, RefPtr&lt;Inspector::Protocol::CSS::CSSRule&gt;&amp; result)
 696 {
 697     InspectorStyleSheet* inspectorStyleSheet = assertStyleSheetForId(errorString, styleSheetId);
<span class="line-modified"> 698     if (!inspectorStyleSheet) {</span>
<span class="line-modified"> 699         errorString = &quot;No target stylesheet found&quot;_s;</span>




 700         return;
 701     }
 702 
<span class="line-modified"> 703     auto action = std::make_unique&lt;AddRuleAction&gt;(inspectorStyleSheet, selector);</span>
 704     auto&amp; rawAction = *action;
<span class="line-modified"> 705     auto performResult = m_domAgent-&gt;history()-&gt;perform(WTFMove(action));</span>
 706     if (performResult.hasException()) {
 707         errorString = InspectorDOMAgent::toErrorString(performResult.releaseException());
 708         return;
 709     }
 710 
 711     InspectorCSSId ruleId = rawAction.newRuleId();
 712     CSSStyleRule* rule = inspectorStyleSheet-&gt;ruleForId(ruleId);
 713     result = inspectorStyleSheet-&gt;buildObjectForRule(rule, nullptr);
 714 }
 715 
 716 void InspectorCSSAgent::getSupportedCSSProperties(ErrorString&amp;, RefPtr&lt;JSON::ArrayOf&lt;Inspector::Protocol::CSS::CSSPropertyInfo&gt;&gt;&amp; cssProperties)
 717 {
 718     auto properties = JSON::ArrayOf&lt;Inspector::Protocol::CSS::CSSPropertyInfo&gt;::create();
 719     for (int i = firstCSSProperty; i &lt;= lastCSSProperty; ++i) {
 720         CSSPropertyID propertyID = convertToCSSPropertyID(i);
 721         if (isInternalCSSProperty(propertyID) || !isEnabledCSSProperty(propertyID))
 722             continue;
 723 
 724         auto property = Inspector::Protocol::CSS::CSSPropertyInfo::create()
 725             .setName(getPropertyNameString(propertyID))
</pre>
<hr />
<pre>
 731             for (auto&amp; alias : aliases)
 732                 aliasesArray-&gt;addItem(alias);
 733             property-&gt;setAliases(WTFMove(aliasesArray));
 734         }
 735 
 736         const StylePropertyShorthand&amp; shorthand = shorthandForProperty(propertyID);
 737         if (shorthand.length()) {
 738             auto longhands = JSON::ArrayOf&lt;String&gt;::create();
 739             for (unsigned j = 0; j &lt; shorthand.length(); ++j) {
 740                 CSSPropertyID longhandID = shorthand.properties()[j];
 741                 if (isEnabledCSSProperty(longhandID))
 742                     longhands-&gt;addItem(getPropertyNameString(longhandID));
 743             }
 744             property-&gt;setLonghands(WTFMove(longhands));
 745         }
 746 
 747         if (CSSParserFastPaths::isKeywordPropertyID(propertyID)) {
 748             auto values = JSON::ArrayOf&lt;String&gt;::create();
 749             for (int j = firstCSSValueKeyword; j &lt;= lastCSSValueKeyword; ++j) {
 750                 CSSValueID valueID = convertToCSSValueID(j);
<span class="line-modified"> 751                 if (CSSParserFastPaths::isValidKeywordPropertyAndValue(propertyID, valueID, HTMLStandardMode))</span>
 752                     values-&gt;addItem(getValueNameString(valueID));
 753             }
 754             if (values-&gt;length())
 755                 property-&gt;setValues(WTFMove(values));
 756         }
 757 
 758         if (CSSProperty::isInheritedProperty(propertyID))
 759             property-&gt;setInherited(true);
 760 
 761         properties-&gt;addItem(WTFMove(property));
 762     }
 763     cssProperties = WTFMove(properties);
 764 }
 765 
 766 void InspectorCSSAgent::getSupportedSystemFontFamilyNames(ErrorString&amp;, RefPtr&lt;JSON::ArrayOf&lt;String&gt;&gt;&amp; fontFamilyNames)
 767 {
 768     auto families = JSON::ArrayOf&lt;String&gt;::create();
 769 
 770     Vector&lt;String&gt; systemFontFamilies = FontCache::singleton().systemFontFamilies();
 771     for (const auto&amp; familyName : systemFontFamilies)
 772         families-&gt;addItem(familyName);
 773 
 774     fontFamilyNames = WTFMove(families);
 775 }
 776 
 777 void InspectorCSSAgent::forcePseudoState(ErrorString&amp; errorString, int nodeId, const JSON::Array&amp; forcedPseudoClasses)
 778 {
<span class="line-modified"> 779     Element* element = m_domAgent-&gt;assertElement(errorString, nodeId);</span>






 780     if (!element)
 781         return;
 782 
 783     // Return early if the forced pseudo state was already set correctly.
 784     unsigned forcedPseudoState = computePseudoClassMask(forcedPseudoClasses);
 785     if (forcedPseudoState) {
 786         auto iterator = m_nodeIdToForcedPseudoState.add(nodeId, 0).iterator;
 787         if (forcedPseudoState == iterator-&gt;value)
 788             return;
 789         iterator-&gt;value = forcedPseudoState;
 790         m_documentsWithForcedPseudoStates.add(&amp;element-&gt;document());
 791     } else {
 792         if (!m_nodeIdToForcedPseudoState.remove(nodeId))
 793             return;
 794         if (m_nodeIdToForcedPseudoState.isEmpty())
 795             m_documentsWithForcedPseudoStates.clear();
 796     }
 797 
 798     element-&gt;document().styleScope().didChangeStyleSheetEnvironment();
 799 }
 800 
 801 InspectorStyleSheetForInlineStyle&amp; InspectorCSSAgent::asInspectorStyleSheet(StyledElement&amp; element)
 802 {
 803     return m_nodeToInspectorStyleSheet.ensure(&amp;element, [this, &amp;element] {
 804         String newStyleSheetId = String::number(m_lastStyleSheetId++);
<span class="line-modified"> 805         auto inspectorStyleSheet = InspectorStyleSheetForInlineStyle::create(m_domAgent-&gt;pageAgent(), newStyleSheetId, element, Inspector::Protocol::CSS::StyleSheetOrigin::Regular, this);</span>
 806         m_idToInspectorStyleSheet.set(newStyleSheetId, inspectorStyleSheet.copyRef());
 807         return inspectorStyleSheet;
 808     }).iterator-&gt;value;
 809 }
 810 
 811 Element* InspectorCSSAgent::elementForId(ErrorString&amp; errorString, int nodeId)
 812 {
<span class="line-modified"> 813     Node* node = m_domAgent-&gt;nodeForId(nodeId);</span>
<span class="line-modified"> 814     if (!node) {</span>
<span class="line-modified"> 815         errorString = &quot;No node with given id found&quot;_s;</span>
<span class="line-removed"> 816         return nullptr;</span>
<span class="line-removed"> 817     }</span>
<span class="line-removed"> 818     if (!is&lt;Element&gt;(*node)) {</span>
<span class="line-removed"> 819         errorString = &quot;Not an element node&quot;_s;</span>
 820         return nullptr;
 821     }
<span class="line-modified"> 822     return downcast&lt;Element&gt;(node);</span>

 823 }
 824 
 825 String InspectorCSSAgent::unbindStyleSheet(InspectorStyleSheet* inspectorStyleSheet)
 826 {
 827     String id = inspectorStyleSheet-&gt;id();
 828     m_idToInspectorStyleSheet.remove(id);
 829     if (inspectorStyleSheet-&gt;pageStyleSheet())
 830         m_cssStyleSheetToInspectorStyleSheet.remove(inspectorStyleSheet-&gt;pageStyleSheet());
 831     return id;
 832 }
 833 
 834 InspectorStyleSheet* InspectorCSSAgent::bindStyleSheet(CSSStyleSheet* styleSheet)
 835 {
 836     RefPtr&lt;InspectorStyleSheet&gt; inspectorStyleSheet = m_cssStyleSheetToInspectorStyleSheet.get(styleSheet);
 837     if (!inspectorStyleSheet) {
 838         String id = String::number(m_lastStyleSheetId++);
 839         Document* document = styleSheet-&gt;ownerDocument();
<span class="line-modified"> 840         inspectorStyleSheet = InspectorStyleSheet::create(m_domAgent-&gt;pageAgent(), id, styleSheet, detectOrigin(styleSheet, document), InspectorDOMAgent::documentURLString(document), this);</span>
 841         m_idToInspectorStyleSheet.set(id, inspectorStyleSheet);
 842         m_cssStyleSheetToInspectorStyleSheet.set(styleSheet, inspectorStyleSheet);
 843         if (m_creatingViaInspectorStyleSheet) {
 844             auto&amp; inspectorStyleSheetsForDocument = m_documentToInspectorStyleSheet.add(document, Vector&lt;RefPtr&lt;InspectorStyleSheet&gt;&gt;()).iterator-&gt;value;
 845             inspectorStyleSheetsForDocument.append(inspectorStyleSheet);
 846         }
 847     }
 848     return inspectorStyleSheet.get();
 849 }
 850 
 851 InspectorStyleSheet* InspectorCSSAgent::assertStyleSheetForId(ErrorString&amp; errorString, const String&amp; styleSheetId)
 852 {
 853     IdToInspectorStyleSheet::iterator it = m_idToInspectorStyleSheet.find(styleSheetId);
 854     if (it == m_idToInspectorStyleSheet.end()) {
<span class="line-modified"> 855         errorString = &quot;No stylesheet with given id found&quot;_s;</span>
 856         return nullptr;
 857     }
 858     return it-&gt;value.get();
 859 }
 860 
 861 Inspector::Protocol::CSS::StyleSheetOrigin InspectorCSSAgent::detectOrigin(CSSStyleSheet* pageStyleSheet, Document* ownerDocument)
 862 {
 863     if (m_creatingViaInspectorStyleSheet)
 864         return Inspector::Protocol::CSS::StyleSheetOrigin::Inspector;
 865 
 866     if (pageStyleSheet &amp;&amp; !pageStyleSheet-&gt;ownerNode() &amp;&amp; pageStyleSheet-&gt;href().isEmpty())
 867         return Inspector::Protocol::CSS::StyleSheetOrigin::UserAgent;
 868 
 869     if (pageStyleSheet &amp;&amp; pageStyleSheet-&gt;ownerNode() &amp;&amp; pageStyleSheet-&gt;ownerNode()-&gt;nodeName() == &quot;#document&quot;)
 870         return Inspector::Protocol::CSS::StyleSheetOrigin::User;
 871 
 872     auto iterator = m_documentToInspectorStyleSheet.find(ownerDocument);
 873     if (iterator != m_documentToInspectorStyleSheet.end()) {
 874         for (auto&amp; inspectorStyleSheet : iterator-&gt;value) {
 875             if (pageStyleSheet == inspectorStyleSheet-&gt;pageStyleSheet())
</pre>
<hr />
<pre>
 926             continue;
 927 
 928         auto matchingSelectors = JSON::ArrayOf&lt;int&gt;::create();
 929         const CSSSelectorList&amp; selectorList = matchedRule-&gt;selectorList();
 930         int index = 0;
 931         for (const CSSSelector* selector = selectorList.first(); selector; selector = CSSSelectorList::next(selector)) {
 932             unsigned ignoredSpecificity;
 933             bool matched = selectorChecker.match(*selector, element, context, ignoredSpecificity);
 934             if (matched)
 935                 matchingSelectors-&gt;addItem(index);
 936             ++index;
 937         }
 938 
 939         auto match = Inspector::Protocol::CSS::RuleMatch::create()
 940             .setRule(WTFMove(ruleObject))
 941             .setMatchingSelectors(WTFMove(matchingSelectors))
 942             .release();
 943         result-&gt;addItem(WTFMove(match));
 944     }
 945 
<span class="line-modified"> 946     return WTFMove(result);</span>
 947 }
 948 
 949 RefPtr&lt;Inspector::Protocol::CSS::CSSStyle&gt; InspectorCSSAgent::buildObjectForAttributesStyle(StyledElement&amp; element)
 950 {
 951     // FIXME: Ugliness below.
 952     auto* attributeStyle = const_cast&lt;StyleProperties*&gt;(element.presentationAttributeStyle());
 953     if (!attributeStyle)
 954         return nullptr;
 955 
 956     auto&amp; mutableAttributeStyle = downcast&lt;MutableStyleProperties&gt;(*attributeStyle);
 957     auto inspectorStyle = InspectorStyle::create(InspectorCSSId(), mutableAttributeStyle.ensureCSSStyleDeclaration(), nullptr);
 958     return inspectorStyle-&gt;buildObjectForStyle();
 959 }
 960 
 961 void InspectorCSSAgent::didRemoveDOMNode(Node&amp; node, int nodeId)
 962 {
 963     m_nodeIdToForcedPseudoState.remove(nodeId);
 964 
 965     auto sheet = m_nodeToInspectorStyleSheet.take(&amp;node);
 966     if (!sheet)
</pre>
</td>
<td>
<hr />
<pre>
  26 #include &quot;config.h&quot;
  27 #include &quot;InspectorCSSAgent.h&quot;
  28 
  29 #include &quot;CSSComputedStyleDeclaration.h&quot;
  30 #include &quot;CSSImportRule.h&quot;
  31 #include &quot;CSSParserFastPaths.h&quot;
  32 #include &quot;CSSParserMode.h&quot;
  33 #include &quot;CSSPropertyNames.h&quot;
  34 #include &quot;CSSPropertySourceData.h&quot;
  35 #include &quot;CSSRule.h&quot;
  36 #include &quot;CSSRuleList.h&quot;
  37 #include &quot;CSSStyleRule.h&quot;
  38 #include &quot;CSSStyleSheet.h&quot;
  39 #include &quot;CSSValueKeywords.h&quot;
  40 #include &quot;ContentSecurityPolicy.h&quot;
  41 #include &quot;DOMWindow.h&quot;
  42 #include &quot;FontCache.h&quot;
  43 #include &quot;Frame.h&quot;
  44 #include &quot;HTMLHeadElement.h&quot;
  45 #include &quot;HTMLStyleElement.h&quot;
<span class="line-added">  46 #include &quot;InspectorDOMAgent.h&quot;</span>
  47 #include &quot;InspectorHistory.h&quot;
  48 #include &quot;InspectorPageAgent.h&quot;
  49 #include &quot;InstrumentingAgents.h&quot;
  50 #include &quot;Node.h&quot;
  51 #include &quot;NodeList.h&quot;
  52 #include &quot;PseudoElement.h&quot;
<span class="line-added">  53 #include &quot;RenderStyleConstants.h&quot;</span>
  54 #include &quot;SVGStyleElement.h&quot;
  55 #include &quot;SelectorChecker.h&quot;
  56 #include &quot;ShadowRoot.h&quot;
  57 #include &quot;StyleProperties.h&quot;
  58 #include &quot;StylePropertyShorthand.h&quot;
  59 #include &quot;StyleResolver.h&quot;
  60 #include &quot;StyleRule.h&quot;
  61 #include &quot;StyleScope.h&quot;
  62 #include &quot;StyleSheetList.h&quot;
  63 #include &lt;JavaScriptCore/InspectorProtocolObjects.h&gt;
<span class="line-added">  64 #include &lt;wtf/Optional.h&gt;</span>
  65 #include &lt;wtf/Ref.h&gt;
  66 #include &lt;wtf/Vector.h&gt;
  67 #include &lt;wtf/text/CString.h&gt;
  68 #include &lt;wtf/text/StringConcatenateNumbers.h&gt;
  69 
  70 namespace WebCore {
  71 
  72 using namespace Inspector;
  73 
  74 enum ForcePseudoClassFlags {
  75     PseudoClassNone = 0,
  76     PseudoClassHover = 1 &lt;&lt; 0,
  77     PseudoClassFocus = 1 &lt;&lt; 1,
  78     PseudoClassActive = 1 &lt;&lt; 2,
  79     PseudoClassVisited = 1 &lt;&lt; 3
  80 };
  81 
  82 static unsigned computePseudoClassMask(const JSON::Array&amp; pseudoClassArray)
  83 {
  84     static NeverDestroyed&lt;String&gt; active(MAKE_STATIC_STRING_IMPL(&quot;active&quot;));
</pre>
<hr />
<pre>
 278     {
 279         auto result = m_styleSheet-&gt;addRule(m_selector);
 280         if (result.hasException())
 281             return result.releaseException();
 282         m_newId = m_styleSheet-&gt;ruleId(result.releaseReturnValue());
 283         return { };
 284     }
 285 
 286     InspectorCSSId m_newId;
 287     String m_selector;
 288     String m_oldSelector;
 289 };
 290 
 291 CSSStyleRule* InspectorCSSAgent::asCSSStyleRule(CSSRule&amp; rule)
 292 {
 293     if (!is&lt;CSSStyleRule&gt;(rule))
 294         return nullptr;
 295     return downcast&lt;CSSStyleRule&gt;(&amp;rule);
 296 }
 297 
<span class="line-modified"> 298 InspectorCSSAgent::InspectorCSSAgent(WebAgentContext&amp; context)</span>
 299     : InspectorAgentBase(&quot;CSS&quot;_s, context)
<span class="line-modified"> 300     , m_frontendDispatcher(makeUnique&lt;CSSFrontendDispatcher&gt;(context.frontendRouter))</span>
 301     , m_backendDispatcher(CSSBackendDispatcher::create(context.backendDispatcher, this))

 302 {

 303 }
 304 
<span class="line-modified"> 305 InspectorCSSAgent::~InspectorCSSAgent() = default;</span>




 306 
 307 void InspectorCSSAgent::didCreateFrontendAndBackend(Inspector::FrontendRouter*, Inspector::BackendDispatcher*)
 308 {
 309 }
 310 
 311 void InspectorCSSAgent::willDestroyFrontendAndBackend(Inspector::DisconnectReason)
 312 {


 313     String unused;
 314     disable(unused);
 315 }
 316 






 317 void InspectorCSSAgent::reset()
 318 {
 319     // FIXME: Should we be resetting on main frame navigations?
 320     m_idToInspectorStyleSheet.clear();
 321     m_cssStyleSheetToInspectorStyleSheet.clear();
 322     m_nodeToInspectorStyleSheet.clear();
 323     m_documentToInspectorStyleSheet.clear();
 324     m_documentToKnownCSSStyleSheets.clear();





 325     resetPseudoStates();
 326 }
 327 
 328 void InspectorCSSAgent::enable(ErrorString&amp;)
 329 {
<span class="line-added"> 330     if (m_instrumentingAgents.inspectorCSSAgent() == this)</span>
<span class="line-added"> 331         return;</span>
<span class="line-added"> 332 </span>
 333     m_instrumentingAgents.setInspectorCSSAgent(this);
 334 
<span class="line-modified"> 335     if (auto* domAgent = m_instrumentingAgents.inspectorDOMAgent()) {</span>
<span class="line-modified"> 336         for (auto* document : domAgent-&gt;documents())</span>
<span class="line-added"> 337             activeStyleSheetsUpdated(*document);</span>
<span class="line-added"> 338     }</span>
 339 }
 340 
 341 void InspectorCSSAgent::disable(ErrorString&amp;)
 342 {
 343     m_instrumentingAgents.setInspectorCSSAgent(nullptr);
<span class="line-added"> 344 </span>
<span class="line-added"> 345     reset();</span>
 346 }
 347 
 348 void InspectorCSSAgent::documentDetached(Document&amp; document)
 349 {
 350     Vector&lt;CSSStyleSheet*&gt; emptyList;
 351     setActiveStyleSheetsForDocument(document, emptyList);
 352 
 353     m_documentToKnownCSSStyleSheets.remove(&amp;document);
 354     m_documentToInspectorStyleSheet.remove(&amp;document);
 355     m_documentsWithForcedPseudoStates.remove(&amp;document);
 356 }
 357 
 358 void InspectorCSSAgent::mediaQueryResultChanged()
 359 {
 360     m_frontendDispatcher-&gt;mediaQueryResultChanged();
 361 }
 362 
 363 void InspectorCSSAgent::activeStyleSheetsUpdated(Document&amp; document)
 364 {
 365     Vector&lt;CSSStyleSheet*&gt; cssStyleSheets;
</pre>
<hr />
<pre>
 387         if (m_idToInspectorStyleSheet.contains(inspectorStyleSheet-&gt;id())) {
 388             String id = unbindStyleSheet(inspectorStyleSheet.get());
 389             m_frontendDispatcher-&gt;styleSheetRemoved(id);
 390         }
 391     }
 392 
 393     for (auto* cssStyleSheet : addedStyleSheets) {
 394         previouslyKnownActiveStyleSheets.add(cssStyleSheet);
 395         if (!m_cssStyleSheetToInspectorStyleSheet.contains(cssStyleSheet)) {
 396             InspectorStyleSheet* inspectorStyleSheet = bindStyleSheet(cssStyleSheet);
 397             m_frontendDispatcher-&gt;styleSheetAdded(inspectorStyleSheet-&gt;buildObjectForStyleSheetInfo());
 398         }
 399     }
 400 }
 401 
 402 bool InspectorCSSAgent::forcePseudoState(const Element&amp; element, CSSSelector::PseudoClassType pseudoClassType)
 403 {
 404     if (m_nodeIdToForcedPseudoState.isEmpty())
 405         return false;
 406 
<span class="line-modified"> 407     auto* domAgent = m_instrumentingAgents.inspectorDOMAgent();</span>
<span class="line-added"> 408     if (!domAgent)</span>
<span class="line-added"> 409         return false;</span>
<span class="line-added"> 410 </span>
<span class="line-added"> 411     int nodeId = domAgent-&gt;boundNodeId(&amp;element);</span>
 412     if (!nodeId)
 413         return false;
 414 
 415     unsigned forcedPseudoState = m_nodeIdToForcedPseudoState.get(nodeId);
 416     switch (pseudoClassType) {
 417     case CSSSelector::PseudoClassActive:
 418         return forcedPseudoState &amp; PseudoClassActive;
 419     case CSSSelector::PseudoClassFocus:
 420         return forcedPseudoState &amp; PseudoClassFocus;
 421     case CSSSelector::PseudoClassHover:
 422         return forcedPseudoState &amp; PseudoClassHover;
 423     case CSSSelector::PseudoClassVisited:
 424         return forcedPseudoState &amp; PseudoClassVisited;
 425     default:
 426         return false;
 427     }
 428 }
 429 
<span class="line-added"> 430 static Optional&lt;Inspector::Protocol::CSS::PseudoId&gt; protocolValueForPseudoId(PseudoId pseudoId)</span>
<span class="line-added"> 431 {</span>
<span class="line-added"> 432     switch (pseudoId) {</span>
<span class="line-added"> 433     case PseudoId::FirstLine:</span>
<span class="line-added"> 434         return Inspector::Protocol::CSS::PseudoId::FirstLine;</span>
<span class="line-added"> 435     case PseudoId::FirstLetter:</span>
<span class="line-added"> 436         return Inspector::Protocol::CSS::PseudoId::FirstLetter;</span>
<span class="line-added"> 437     case PseudoId::Marker:</span>
<span class="line-added"> 438         return Inspector::Protocol::CSS::PseudoId::Marker;</span>
<span class="line-added"> 439     case PseudoId::Before:</span>
<span class="line-added"> 440         return Inspector::Protocol::CSS::PseudoId::Before;</span>
<span class="line-added"> 441     case PseudoId::After:</span>
<span class="line-added"> 442         return Inspector::Protocol::CSS::PseudoId::After;</span>
<span class="line-added"> 443     case PseudoId::Selection:</span>
<span class="line-added"> 444         return Inspector::Protocol::CSS::PseudoId::Selection;</span>
<span class="line-added"> 445     case PseudoId::Scrollbar:</span>
<span class="line-added"> 446         return Inspector::Protocol::CSS::PseudoId::Scrollbar;</span>
<span class="line-added"> 447     case PseudoId::ScrollbarThumb:</span>
<span class="line-added"> 448         return Inspector::Protocol::CSS::PseudoId::ScrollbarThumb;</span>
<span class="line-added"> 449     case PseudoId::ScrollbarButton:</span>
<span class="line-added"> 450         return Inspector::Protocol::CSS::PseudoId::ScrollbarButton;</span>
<span class="line-added"> 451     case PseudoId::ScrollbarTrack:</span>
<span class="line-added"> 452         return Inspector::Protocol::CSS::PseudoId::ScrollbarTrack;</span>
<span class="line-added"> 453     case PseudoId::ScrollbarTrackPiece:</span>
<span class="line-added"> 454         return Inspector::Protocol::CSS::PseudoId::ScrollbarTrackPiece;</span>
<span class="line-added"> 455     case PseudoId::ScrollbarCorner:</span>
<span class="line-added"> 456         return Inspector::Protocol::CSS::PseudoId::ScrollbarCorner;</span>
<span class="line-added"> 457     case PseudoId::Resizer:</span>
<span class="line-added"> 458         return Inspector::Protocol::CSS::PseudoId::Resizer;</span>
<span class="line-added"> 459 </span>
<span class="line-added"> 460     default:</span>
<span class="line-added"> 461         ASSERT_NOT_REACHED();</span>
<span class="line-added"> 462         return { };</span>
<span class="line-added"> 463     }</span>
<span class="line-added"> 464 }</span>
<span class="line-added"> 465 </span>
 466 void InspectorCSSAgent::getMatchedStylesForNode(ErrorString&amp; errorString, int nodeId, const bool* includePseudo, const bool* includeInherited, RefPtr&lt;JSON::ArrayOf&lt;Inspector::Protocol::CSS::RuleMatch&gt;&gt;&amp; matchedCSSRules, RefPtr&lt;JSON::ArrayOf&lt;Inspector::Protocol::CSS::PseudoIdMatches&gt;&gt;&amp; pseudoIdMatches, RefPtr&lt;JSON::ArrayOf&lt;Inspector::Protocol::CSS::InheritedStyleEntry&gt;&gt;&amp; inheritedEntries)
 467 {
 468     Element* element = elementForId(errorString, nodeId);
 469     if (!element)
 470         return;
 471 
 472     Element* originalElement = element;
 473     PseudoId elementPseudoId = element-&gt;pseudoId();
 474     if (elementPseudoId != PseudoId::None) {
 475         element = downcast&lt;PseudoElement&gt;(*element).hostElement();
 476         if (!element) {
<span class="line-modified"> 477             errorString = &quot;Missing parent of pseudo-element node for given nodeId&quot;_s;</span>
 478             return;
 479         }
 480     }
 481 
 482     // Matched rules.
 483     StyleResolver&amp; styleResolver = element-&gt;styleResolver();
 484     auto matchedRules = styleResolver.pseudoStyleRulesForElement(element, elementPseudoId, StyleResolver::AllCSSRules);
 485     matchedCSSRules = buildArrayForMatchedRuleList(matchedRules, styleResolver, *element, elementPseudoId);
 486 
 487     if (!originalElement-&gt;isPseudoElement()) {
 488         // Pseudo elements.
 489         if (!includePseudo || *includePseudo) {
 490             auto pseudoElements = JSON::ArrayOf&lt;Inspector::Protocol::CSS::PseudoIdMatches&gt;::create();
 491             for (PseudoId pseudoId = PseudoId::FirstPublicPseudoId; pseudoId &lt; PseudoId::AfterLastInternalPseudoId; pseudoId = static_cast&lt;PseudoId&gt;(static_cast&lt;unsigned&gt;(pseudoId) + 1)) {
<span class="line-modified"> 492                 if (auto protocolPseudoId = protocolValueForPseudoId(pseudoId)) {</span>
<span class="line-modified"> 493                     auto matchedRules = styleResolver.pseudoStyleRulesForElement(element, pseudoId, StyleResolver::AllCSSRules);</span>
<span class="line-modified"> 494                     if (!matchedRules.isEmpty()) {</span>
<span class="line-modified"> 495                         auto matches = Inspector::Protocol::CSS::PseudoIdMatches::create()</span>
<span class="line-modified"> 496                             .setPseudoId(protocolPseudoId.value())</span>
<span class="line-modified"> 497                             .setMatches(buildArrayForMatchedRuleList(matchedRules, styleResolver, *element, pseudoId))</span>
<span class="line-modified"> 498                             .release();</span>
<span class="line-added"> 499                         pseudoElements-&gt;addItem(WTFMove(matches));</span>
<span class="line-added"> 500                     }</span>
 501                 }
 502             }
 503 
 504             pseudoIdMatches = WTFMove(pseudoElements);
 505         }
 506 
 507         // Inherited styles.
 508         if (!includeInherited || *includeInherited) {
 509             auto entries = JSON::ArrayOf&lt;Inspector::Protocol::CSS::InheritedStyleEntry&gt;::create();
 510             Element* parentElement = element-&gt;parentElement();
 511             while (parentElement) {
 512                 StyleResolver&amp; parentStyleResolver = parentElement-&gt;styleResolver();
 513                 auto parentMatchedRules = parentStyleResolver.styleRulesForElement(parentElement, StyleResolver::AllCSSRules);
 514                 auto entry = Inspector::Protocol::CSS::InheritedStyleEntry::create()
 515                     .setMatchedCSSRules(buildArrayForMatchedRuleList(parentMatchedRules, styleResolver, *parentElement, PseudoId::None))
 516                     .release();
 517                 if (is&lt;StyledElement&gt;(*parentElement) &amp;&amp; downcast&lt;StyledElement&gt;(*parentElement).cssomStyle().length()) {
 518                     auto&amp; styleSheet = asInspectorStyleSheet(downcast&lt;StyledElement&gt;(*parentElement));
 519                     entry-&gt;setInlineStyle(styleSheet.buildObjectForStyle(styleSheet.styleForId(InspectorCSSId(styleSheet.id(), 0))));
 520                 }
</pre>
<hr />
<pre>
 550         return;
 551 
 552     auto computedStyleInfo = CSSComputedStyleDeclaration::create(*element, true);
 553     auto inspectorStyle = InspectorStyle::create(InspectorCSSId(), WTFMove(computedStyleInfo), nullptr);
 554     style = inspectorStyle-&gt;buildArrayForComputedStyle();
 555 }
 556 
 557 void InspectorCSSAgent::getAllStyleSheets(ErrorString&amp;, RefPtr&lt;JSON::ArrayOf&lt;Inspector::Protocol::CSS::CSSStyleSheetHeader&gt;&gt;&amp; styleInfos)
 558 {
 559     styleInfos = JSON::ArrayOf&lt;Inspector::Protocol::CSS::CSSStyleSheetHeader&gt;::create();
 560 
 561     Vector&lt;InspectorStyleSheet*&gt; inspectorStyleSheets;
 562     collectAllStyleSheets(inspectorStyleSheets);
 563     for (auto* inspectorStyleSheet : inspectorStyleSheets)
 564         styleInfos-&gt;addItem(inspectorStyleSheet-&gt;buildObjectForStyleSheetInfo());
 565 }
 566 
 567 void InspectorCSSAgent::collectAllStyleSheets(Vector&lt;InspectorStyleSheet*&gt;&amp; result)
 568 {
 569     Vector&lt;CSSStyleSheet*&gt; cssStyleSheets;
<span class="line-modified"> 570     if (auto* domAgent = m_instrumentingAgents.inspectorDOMAgent()) {</span>
<span class="line-modified"> 571         for (auto* document : domAgent-&gt;documents())</span>
<span class="line-added"> 572             collectAllDocumentStyleSheets(*document, cssStyleSheets);</span>
<span class="line-added"> 573     }</span>
 574 
 575     for (auto* cssStyleSheet : cssStyleSheets)
 576         result.append(bindStyleSheet(cssStyleSheet));
 577 }
 578 
 579 void InspectorCSSAgent::collectAllDocumentStyleSheets(Document&amp; document, Vector&lt;CSSStyleSheet*&gt;&amp; result)
 580 {
 581     auto cssStyleSheets = document.styleScope().activeStyleSheetsForInspector();
 582     for (auto&amp; cssStyleSheet : cssStyleSheets)
 583         collectStyleSheets(cssStyleSheet.get(), result);
 584 }
 585 
 586 void InspectorCSSAgent::collectStyleSheets(CSSStyleSheet* styleSheet, Vector&lt;CSSStyleSheet*&gt;&amp; result)
 587 {
 588     result.append(styleSheet);
 589 
 590     for (unsigned i = 0, size = styleSheet-&gt;length(); i &lt; size; ++i) {
 591         CSSRule* rule = styleSheet-&gt;item(i);
 592         if (is&lt;CSSImportRule&gt;(*rule)) {
 593             if (CSSStyleSheet* importedStyleSheet = downcast&lt;CSSImportRule&gt;(*rule).styleSheet())
</pre>
<hr />
<pre>
 605     styleSheetObject = inspectorStyleSheet-&gt;buildObjectForStyleSheet();
 606 }
 607 
 608 void InspectorCSSAgent::getStyleSheetText(ErrorString&amp; errorString, const String&amp; styleSheetId, String* result)
 609 {
 610     InspectorStyleSheet* inspectorStyleSheet = assertStyleSheetForId(errorString, styleSheetId);
 611     if (!inspectorStyleSheet)
 612         return;
 613 
 614     auto text = inspectorStyleSheet-&gt;text();
 615     if (!text.hasException())
 616         *result = text.releaseReturnValue();
 617 }
 618 
 619 void InspectorCSSAgent::setStyleSheetText(ErrorString&amp; errorString, const String&amp; styleSheetId, const String&amp; text)
 620 {
 621     InspectorStyleSheet* inspectorStyleSheet = assertStyleSheetForId(errorString, styleSheetId);
 622     if (!inspectorStyleSheet)
 623         return;
 624 
<span class="line-modified"> 625     auto* domAgent = m_instrumentingAgents.inspectorDOMAgent();</span>
<span class="line-added"> 626     if (!domAgent) {</span>
<span class="line-added"> 627         errorString = &quot;DOM domain must be enabled&quot;_s;</span>
<span class="line-added"> 628         return;</span>
<span class="line-added"> 629     }</span>
<span class="line-added"> 630 </span>
<span class="line-added"> 631     auto result = domAgent-&gt;history()-&gt;perform(makeUnique&lt;SetStyleSheetTextAction&gt;(inspectorStyleSheet, text));</span>
 632     if (result.hasException())
 633         errorString = InspectorDOMAgent::toErrorString(result.releaseException());
 634 }
 635 
 636 void InspectorCSSAgent::setStyleText(ErrorString&amp; errorString, const JSON::Object&amp; fullStyleId, const String&amp; text, RefPtr&lt;Inspector::Protocol::CSS::CSSStyle&gt;&amp; result)
 637 {
 638     InspectorCSSId compoundId(fullStyleId);
 639     ASSERT(!compoundId.isEmpty());
 640 
 641     InspectorStyleSheet* inspectorStyleSheet = assertStyleSheetForId(errorString, compoundId.styleSheetId());
 642     if (!inspectorStyleSheet)
 643         return;
 644 
<span class="line-modified"> 645     auto* domAgent = m_instrumentingAgents.inspectorDOMAgent();</span>
<span class="line-added"> 646     if (!domAgent) {</span>
<span class="line-added"> 647         errorString = &quot;DOM domain must be enabled&quot;_s;</span>
<span class="line-added"> 648         return;</span>
<span class="line-added"> 649     }</span>
<span class="line-added"> 650 </span>
<span class="line-added"> 651     auto performResult = domAgent-&gt;history()-&gt;perform(makeUnique&lt;SetStyleTextAction&gt;(inspectorStyleSheet, compoundId, text));</span>
 652     if (performResult.hasException()) {
 653         errorString = InspectorDOMAgent::toErrorString(performResult.releaseException());
 654         return;
 655     }
 656 
 657     result = inspectorStyleSheet-&gt;buildObjectForStyle(inspectorStyleSheet-&gt;styleForId(compoundId));
 658 }
 659 
 660 void InspectorCSSAgent::setRuleSelector(ErrorString&amp; errorString, const JSON::Object&amp; fullRuleId, const String&amp; selector, RefPtr&lt;Inspector::Protocol::CSS::CSSRule&gt;&amp; result)
 661 {
 662     InspectorCSSId compoundId(fullRuleId);
 663     ASSERT(!compoundId.isEmpty());
 664 
 665     InspectorStyleSheet* inspectorStyleSheet = assertStyleSheetForId(errorString, compoundId.styleSheetId());
 666     if (!inspectorStyleSheet)
 667         return;
 668 
<span class="line-modified"> 669     auto* domAgent = m_instrumentingAgents.inspectorDOMAgent();</span>
<span class="line-added"> 670     if (!domAgent) {</span>
<span class="line-added"> 671         errorString = &quot;DOM domain must be enabled&quot;_s;</span>
<span class="line-added"> 672         return;</span>
<span class="line-added"> 673     }</span>
<span class="line-added"> 674 </span>
<span class="line-added"> 675     auto performResult = domAgent-&gt;history()-&gt;perform(makeUnique&lt;SetRuleSelectorAction&gt;(inspectorStyleSheet, compoundId, selector));</span>
 676     if (performResult.hasException()) {
 677         errorString = InspectorDOMAgent::toErrorString(performResult.releaseException());
 678         return;
 679     }
 680 
 681     result = inspectorStyleSheet-&gt;buildObjectForRule(inspectorStyleSheet-&gt;ruleForId(compoundId), nullptr);
 682 }
 683 
 684 void InspectorCSSAgent::createStyleSheet(ErrorString&amp; errorString, const String&amp; frameId, String* styleSheetId)
 685 {
<span class="line-modified"> 686     auto* pageAgent = m_instrumentingAgents.inspectorPageAgent();</span>
<span class="line-modified"> 687     if (!pageAgent) {</span>
<span class="line-modified"> 688         errorString = &quot;Page domain must be enabled&quot;_s;</span>
 689         return;
 690     }
 691 
<span class="line-added"> 692     auto* frame = pageAgent-&gt;assertFrame(errorString, frameId);</span>
<span class="line-added"> 693     if (!frame)</span>
<span class="line-added"> 694         return;</span>
<span class="line-added"> 695 </span>
 696     Document* document = frame-&gt;document();
 697     if (!document) {
<span class="line-modified"> 698         errorString = &quot;Missing document of frame for given frameId&quot;_s;</span>
 699         return;
 700     }
 701 
 702     InspectorStyleSheet* inspectorStyleSheet = createInspectorStyleSheetForDocument(*document);
 703     if (!inspectorStyleSheet) {
<span class="line-modified"> 704         errorString = &quot;Could not create style sheet for document of frame for given frameId&quot;_s;</span>
 705         return;
 706     }
 707 
 708     *styleSheetId = inspectorStyleSheet-&gt;id();
 709 }
 710 
 711 InspectorStyleSheet* InspectorCSSAgent::createInspectorStyleSheetForDocument(Document&amp; document)
 712 {
 713     if (!document.isHTMLDocument() &amp;&amp; !document.isSVGDocument())
 714         return nullptr;
 715 
 716     auto styleElement = HTMLStyleElement::create(document);
<span class="line-modified"> 717     styleElement-&gt;setAttributeWithoutSynchronization(HTMLNames::typeAttr, AtomString(&quot;text/css&quot;, AtomString::ConstructFromLiteral));</span>
 718 
 719     ContainerNode* targetNode;
 720     // HEAD is absent in ImageDocuments, for example.
 721     if (auto* head = document.head())
 722         targetNode = head;
 723     else if (auto* body = document.bodyOrFrameset())
 724         targetNode = body;
 725     else
 726         return nullptr;
 727 
 728     // Inserting this &lt;style&gt; into the document will trigger activeStyleSheetsUpdated
 729     // and we will create an InspectorStyleSheet for this &lt;style&gt;&#39;s CSSStyleSheet.
 730     // Set this flag, so when we create it, we put it into the via inspector map.
 731     m_creatingViaInspectorStyleSheet = true;
 732     InlineStyleOverrideScope overrideScope(document);
 733     auto appendResult = targetNode-&gt;appendChild(styleElement);
 734     document.styleScope().flushPendingUpdate();
 735     m_creatingViaInspectorStyleSheet = false;
 736     if (appendResult.hasException())
 737         return nullptr;
 738 
 739     auto iterator = m_documentToInspectorStyleSheet.find(&amp;document);
 740     ASSERT(iterator != m_documentToInspectorStyleSheet.end());
 741     if (iterator == m_documentToInspectorStyleSheet.end())
 742         return nullptr;
 743 
 744     auto&amp; inspectorStyleSheetsForDocument = iterator-&gt;value;
 745     ASSERT(!inspectorStyleSheetsForDocument.isEmpty());
 746     if (inspectorStyleSheetsForDocument.isEmpty())
 747         return nullptr;
 748 
 749     return inspectorStyleSheetsForDocument.last().get();
 750 }
 751 
 752 void InspectorCSSAgent::addRule(ErrorString&amp; errorString, const String&amp; styleSheetId, const String&amp; selector, RefPtr&lt;Inspector::Protocol::CSS::CSSRule&gt;&amp; result)
 753 {
 754     InspectorStyleSheet* inspectorStyleSheet = assertStyleSheetForId(errorString, styleSheetId);
<span class="line-modified"> 755     if (!inspectorStyleSheet)</span>
<span class="line-modified"> 756         return;</span>
<span class="line-added"> 757 </span>
<span class="line-added"> 758     auto* domAgent = m_instrumentingAgents.inspectorDOMAgent();</span>
<span class="line-added"> 759     if (!domAgent) {</span>
<span class="line-added"> 760         errorString = &quot;DOM domain must be enabled&quot;_s;</span>
 761         return;
 762     }
 763 
<span class="line-modified"> 764     auto action = makeUnique&lt;AddRuleAction&gt;(inspectorStyleSheet, selector);</span>
 765     auto&amp; rawAction = *action;
<span class="line-modified"> 766     auto performResult = domAgent-&gt;history()-&gt;perform(WTFMove(action));</span>
 767     if (performResult.hasException()) {
 768         errorString = InspectorDOMAgent::toErrorString(performResult.releaseException());
 769         return;
 770     }
 771 
 772     InspectorCSSId ruleId = rawAction.newRuleId();
 773     CSSStyleRule* rule = inspectorStyleSheet-&gt;ruleForId(ruleId);
 774     result = inspectorStyleSheet-&gt;buildObjectForRule(rule, nullptr);
 775 }
 776 
 777 void InspectorCSSAgent::getSupportedCSSProperties(ErrorString&amp;, RefPtr&lt;JSON::ArrayOf&lt;Inspector::Protocol::CSS::CSSPropertyInfo&gt;&gt;&amp; cssProperties)
 778 {
 779     auto properties = JSON::ArrayOf&lt;Inspector::Protocol::CSS::CSSPropertyInfo&gt;::create();
 780     for (int i = firstCSSProperty; i &lt;= lastCSSProperty; ++i) {
 781         CSSPropertyID propertyID = convertToCSSPropertyID(i);
 782         if (isInternalCSSProperty(propertyID) || !isEnabledCSSProperty(propertyID))
 783             continue;
 784 
 785         auto property = Inspector::Protocol::CSS::CSSPropertyInfo::create()
 786             .setName(getPropertyNameString(propertyID))
</pre>
<hr />
<pre>
 792             for (auto&amp; alias : aliases)
 793                 aliasesArray-&gt;addItem(alias);
 794             property-&gt;setAliases(WTFMove(aliasesArray));
 795         }
 796 
 797         const StylePropertyShorthand&amp; shorthand = shorthandForProperty(propertyID);
 798         if (shorthand.length()) {
 799             auto longhands = JSON::ArrayOf&lt;String&gt;::create();
 800             for (unsigned j = 0; j &lt; shorthand.length(); ++j) {
 801                 CSSPropertyID longhandID = shorthand.properties()[j];
 802                 if (isEnabledCSSProperty(longhandID))
 803                     longhands-&gt;addItem(getPropertyNameString(longhandID));
 804             }
 805             property-&gt;setLonghands(WTFMove(longhands));
 806         }
 807 
 808         if (CSSParserFastPaths::isKeywordPropertyID(propertyID)) {
 809             auto values = JSON::ArrayOf&lt;String&gt;::create();
 810             for (int j = firstCSSValueKeyword; j &lt;= lastCSSValueKeyword; ++j) {
 811                 CSSValueID valueID = convertToCSSValueID(j);
<span class="line-modified"> 812                 if (CSSParserFastPaths::isValidKeywordPropertyAndValue(propertyID, valueID, strictCSSParserContext()))</span>
 813                     values-&gt;addItem(getValueNameString(valueID));
 814             }
 815             if (values-&gt;length())
 816                 property-&gt;setValues(WTFMove(values));
 817         }
 818 
 819         if (CSSProperty::isInheritedProperty(propertyID))
 820             property-&gt;setInherited(true);
 821 
 822         properties-&gt;addItem(WTFMove(property));
 823     }
 824     cssProperties = WTFMove(properties);
 825 }
 826 
 827 void InspectorCSSAgent::getSupportedSystemFontFamilyNames(ErrorString&amp;, RefPtr&lt;JSON::ArrayOf&lt;String&gt;&gt;&amp; fontFamilyNames)
 828 {
 829     auto families = JSON::ArrayOf&lt;String&gt;::create();
 830 
 831     Vector&lt;String&gt; systemFontFamilies = FontCache::singleton().systemFontFamilies();
 832     for (const auto&amp; familyName : systemFontFamilies)
 833         families-&gt;addItem(familyName);
 834 
 835     fontFamilyNames = WTFMove(families);
 836 }
 837 
 838 void InspectorCSSAgent::forcePseudoState(ErrorString&amp; errorString, int nodeId, const JSON::Array&amp; forcedPseudoClasses)
 839 {
<span class="line-modified"> 840     auto* domAgent = m_instrumentingAgents.inspectorDOMAgent();</span>
<span class="line-added"> 841     if (!domAgent) {</span>
<span class="line-added"> 842         errorString = &quot;DOM domain must be enabled&quot;_s;</span>
<span class="line-added"> 843         return;</span>
<span class="line-added"> 844     }</span>
<span class="line-added"> 845 </span>
<span class="line-added"> 846     Element* element = domAgent-&gt;assertElement(errorString, nodeId);</span>
 847     if (!element)
 848         return;
 849 
 850     // Return early if the forced pseudo state was already set correctly.
 851     unsigned forcedPseudoState = computePseudoClassMask(forcedPseudoClasses);
 852     if (forcedPseudoState) {
 853         auto iterator = m_nodeIdToForcedPseudoState.add(nodeId, 0).iterator;
 854         if (forcedPseudoState == iterator-&gt;value)
 855             return;
 856         iterator-&gt;value = forcedPseudoState;
 857         m_documentsWithForcedPseudoStates.add(&amp;element-&gt;document());
 858     } else {
 859         if (!m_nodeIdToForcedPseudoState.remove(nodeId))
 860             return;
 861         if (m_nodeIdToForcedPseudoState.isEmpty())
 862             m_documentsWithForcedPseudoStates.clear();
 863     }
 864 
 865     element-&gt;document().styleScope().didChangeStyleSheetEnvironment();
 866 }
 867 
 868 InspectorStyleSheetForInlineStyle&amp; InspectorCSSAgent::asInspectorStyleSheet(StyledElement&amp; element)
 869 {
 870     return m_nodeToInspectorStyleSheet.ensure(&amp;element, [this, &amp;element] {
 871         String newStyleSheetId = String::number(m_lastStyleSheetId++);
<span class="line-modified"> 872         auto inspectorStyleSheet = InspectorStyleSheetForInlineStyle::create(m_instrumentingAgents.inspectorPageAgent(), newStyleSheetId, element, Inspector::Protocol::CSS::StyleSheetOrigin::Regular, this);</span>
 873         m_idToInspectorStyleSheet.set(newStyleSheetId, inspectorStyleSheet.copyRef());
 874         return inspectorStyleSheet;
 875     }).iterator-&gt;value;
 876 }
 877 
 878 Element* InspectorCSSAgent::elementForId(ErrorString&amp; errorString, int nodeId)
 879 {
<span class="line-modified"> 880     auto* domAgent = m_instrumentingAgents.inspectorDOMAgent();</span>
<span class="line-modified"> 881     if (!domAgent) {</span>
<span class="line-modified"> 882         errorString = &quot;DOM domain must be enabled&quot;_s;</span>




 883         return nullptr;
 884     }
<span class="line-modified"> 885 </span>
<span class="line-added"> 886     return domAgent-&gt;assertElement(errorString, nodeId);</span>
 887 }
 888 
 889 String InspectorCSSAgent::unbindStyleSheet(InspectorStyleSheet* inspectorStyleSheet)
 890 {
 891     String id = inspectorStyleSheet-&gt;id();
 892     m_idToInspectorStyleSheet.remove(id);
 893     if (inspectorStyleSheet-&gt;pageStyleSheet())
 894         m_cssStyleSheetToInspectorStyleSheet.remove(inspectorStyleSheet-&gt;pageStyleSheet());
 895     return id;
 896 }
 897 
 898 InspectorStyleSheet* InspectorCSSAgent::bindStyleSheet(CSSStyleSheet* styleSheet)
 899 {
 900     RefPtr&lt;InspectorStyleSheet&gt; inspectorStyleSheet = m_cssStyleSheetToInspectorStyleSheet.get(styleSheet);
 901     if (!inspectorStyleSheet) {
 902         String id = String::number(m_lastStyleSheetId++);
 903         Document* document = styleSheet-&gt;ownerDocument();
<span class="line-modified"> 904         inspectorStyleSheet = InspectorStyleSheet::create(m_instrumentingAgents.inspectorPageAgent(), id, styleSheet, detectOrigin(styleSheet, document), InspectorDOMAgent::documentURLString(document), this);</span>
 905         m_idToInspectorStyleSheet.set(id, inspectorStyleSheet);
 906         m_cssStyleSheetToInspectorStyleSheet.set(styleSheet, inspectorStyleSheet);
 907         if (m_creatingViaInspectorStyleSheet) {
 908             auto&amp; inspectorStyleSheetsForDocument = m_documentToInspectorStyleSheet.add(document, Vector&lt;RefPtr&lt;InspectorStyleSheet&gt;&gt;()).iterator-&gt;value;
 909             inspectorStyleSheetsForDocument.append(inspectorStyleSheet);
 910         }
 911     }
 912     return inspectorStyleSheet.get();
 913 }
 914 
 915 InspectorStyleSheet* InspectorCSSAgent::assertStyleSheetForId(ErrorString&amp; errorString, const String&amp; styleSheetId)
 916 {
 917     IdToInspectorStyleSheet::iterator it = m_idToInspectorStyleSheet.find(styleSheetId);
 918     if (it == m_idToInspectorStyleSheet.end()) {
<span class="line-modified"> 919         errorString = &quot;Missing style sheet for given styleSheetId&quot;_s;</span>
 920         return nullptr;
 921     }
 922     return it-&gt;value.get();
 923 }
 924 
 925 Inspector::Protocol::CSS::StyleSheetOrigin InspectorCSSAgent::detectOrigin(CSSStyleSheet* pageStyleSheet, Document* ownerDocument)
 926 {
 927     if (m_creatingViaInspectorStyleSheet)
 928         return Inspector::Protocol::CSS::StyleSheetOrigin::Inspector;
 929 
 930     if (pageStyleSheet &amp;&amp; !pageStyleSheet-&gt;ownerNode() &amp;&amp; pageStyleSheet-&gt;href().isEmpty())
 931         return Inspector::Protocol::CSS::StyleSheetOrigin::UserAgent;
 932 
 933     if (pageStyleSheet &amp;&amp; pageStyleSheet-&gt;ownerNode() &amp;&amp; pageStyleSheet-&gt;ownerNode()-&gt;nodeName() == &quot;#document&quot;)
 934         return Inspector::Protocol::CSS::StyleSheetOrigin::User;
 935 
 936     auto iterator = m_documentToInspectorStyleSheet.find(ownerDocument);
 937     if (iterator != m_documentToInspectorStyleSheet.end()) {
 938         for (auto&amp; inspectorStyleSheet : iterator-&gt;value) {
 939             if (pageStyleSheet == inspectorStyleSheet-&gt;pageStyleSheet())
</pre>
<hr />
<pre>
 990             continue;
 991 
 992         auto matchingSelectors = JSON::ArrayOf&lt;int&gt;::create();
 993         const CSSSelectorList&amp; selectorList = matchedRule-&gt;selectorList();
 994         int index = 0;
 995         for (const CSSSelector* selector = selectorList.first(); selector; selector = CSSSelectorList::next(selector)) {
 996             unsigned ignoredSpecificity;
 997             bool matched = selectorChecker.match(*selector, element, context, ignoredSpecificity);
 998             if (matched)
 999                 matchingSelectors-&gt;addItem(index);
1000             ++index;
1001         }
1002 
1003         auto match = Inspector::Protocol::CSS::RuleMatch::create()
1004             .setRule(WTFMove(ruleObject))
1005             .setMatchingSelectors(WTFMove(matchingSelectors))
1006             .release();
1007         result-&gt;addItem(WTFMove(match));
1008     }
1009 
<span class="line-modified">1010     return result;</span>
1011 }
1012 
1013 RefPtr&lt;Inspector::Protocol::CSS::CSSStyle&gt; InspectorCSSAgent::buildObjectForAttributesStyle(StyledElement&amp; element)
1014 {
1015     // FIXME: Ugliness below.
1016     auto* attributeStyle = const_cast&lt;StyleProperties*&gt;(element.presentationAttributeStyle());
1017     if (!attributeStyle)
1018         return nullptr;
1019 
1020     auto&amp; mutableAttributeStyle = downcast&lt;MutableStyleProperties&gt;(*attributeStyle);
1021     auto inspectorStyle = InspectorStyle::create(InspectorCSSId(), mutableAttributeStyle.ensureCSSStyleDeclaration(), nullptr);
1022     return inspectorStyle-&gt;buildObjectForStyle();
1023 }
1024 
1025 void InspectorCSSAgent::didRemoveDOMNode(Node&amp; node, int nodeId)
1026 {
1027     m_nodeIdToForcedPseudoState.remove(nodeId);
1028 
1029     auto sheet = m_nodeToInspectorStyleSheet.take(&amp;node);
1030     if (!sheet)
</pre>
</td>
</tr>
</table>
<center><a href="InspectorCPUProfilerAgent.h.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../index.html" target="_top">index</a> <a href="InspectorCSSAgent.h.sdiff.html" target="_top">next &gt;</a></center>  </body>
</html>