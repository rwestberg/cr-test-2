<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New vcs/src/test/java/org/openjdk/skara/vcs/RepositoryTests.java</title>
    <link rel="stylesheet" href="../../../../../../../../style.css" />
  </head>
  <body>
    <pre>
   1 /*
   2  * Copyright (c) 2018, 2019, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  */
  23 package org.openjdk.skara.vcs;
  24 
  25 import org.junit.jupiter.api.Assumptions;
  26 import org.openjdk.skara.test.TemporaryDirectory;
  27 
  28 import org.junit.jupiter.api.Test;
  29 import org.junit.jupiter.params.ParameterizedTest;
  30 import org.junit.jupiter.params.provider.EnumSource;
  31 
  32 import java.io.IOException;
  33 import java.net.URI;
  34 import java.nio.file.*;
  35 import java.nio.file.attribute.*;
  36 import java.time.ZonedDateTime;
  37 import java.util.*;
  38 import java.util.stream.Collectors;
  39 
  40 import static java.nio.file.StandardOpenOption.*;
  41 import static org.junit.jupiter.api.Assertions.*;
  42 import static org.junit.jupiter.api.Assumptions.assumeTrue;
  43 
  44 public class RepositoryTests {
  45 
  46     @ParameterizedTest
  47     @EnumSource(VCS.class)
  48     void testExistsOnMissingDirectory(VCS vcs) throws IOException {
  49         var d = Paths.get(&quot;/&quot;, &quot;this&quot;, &quot;path&quot;, &quot;does&quot;, &quot;not&quot;, &quot;exist&quot;);
  50         var r = Repository.get(d);
  51         assertTrue(r.isEmpty());
  52     }
  53 
  54     @ParameterizedTest
  55     @EnumSource(VCS.class)
  56     void testExistsOnEmptyDirectory(VCS vcs) throws IOException {
  57         try (var dir = new TemporaryDirectory()) {
  58             var r = Repository.get(dir.path());
  59             assertTrue(r.isEmpty());
  60         }
  61     }
  62 
  63     @ParameterizedTest
  64     @EnumSource(VCS.class)
  65     void testExistsOnInitializedRepository(VCS vcs) throws IOException {
  66         try (var dir = new TemporaryDirectory()) {
  67             var r = Repository.init(dir.path(), vcs);
  68             assertTrue(r.exists());
  69         }
  70     }
  71 
  72     @ParameterizedTest
  73     @EnumSource(VCS.class)
  74     void testExistsOnSubdir() throws IOException {
  75         try (var dir = new TemporaryDirectory()) {
  76             var r = Repository.init(dir.path(), VCS.GIT);
  77             assertTrue(r.exists());
  78 
  79             var subdir = Paths.get(dir.toString(), &quot;test&quot;);
  80             Files.createDirectories(subdir);
  81             var r2 = Repository.get(subdir);
  82             assertTrue(r2.get().exists());
  83         }
  84     }
  85 
  86     @ParameterizedTest
  87     @EnumSource(VCS.class)
  88     void testRootOnTopLevel() throws IOException {
  89         try (var dir = new TemporaryDirectory()) {
  90             var r = Repository.init(dir.path(), VCS.GIT);
  91             assertEquals(dir.toString(), r.root().toString());
  92         }
  93     }
  94 
  95     @ParameterizedTest
  96     @EnumSource(VCS.class)
  97     void testRootOnSubdirectory(VCS vcs) throws IOException {
  98         try (var dir = new TemporaryDirectory()) {
  99             var r = Repository.init(dir.path(), vcs);
 100             assertEquals(dir.toString(), r.root().toString());
 101 
 102             var subdir = Paths.get(dir.toString(), &quot;sub&quot;);
 103             Files.createDirectories(subdir);
 104 
 105             var r2 = Repository.get(subdir);
 106             assertEquals(dir.toString(), r2.get().root().toString());
 107         }
 108     }
 109 
 110     @ParameterizedTest
 111     @EnumSource(VCS.class)
 112     void testResolveOnEmptyRepository(VCS vcs) throws IOException {
 113         try (var dir = new TemporaryDirectory()) {
 114             var r = Repository.init(dir.path(), vcs);
 115             assertTrue(r.resolve(&quot;HEAD&quot;).isEmpty());
 116         }
 117     }
 118 
 119     @ParameterizedTest
 120     @EnumSource(VCS.class)
 121     void testResolveWithHEAD(VCS vcs) throws IOException {
 122         try (var dir = new TemporaryDirectory()) {
 123             var r = Repository.init(dir.path(), vcs);
 124 
 125             var readme = dir.path().resolve(&quot;README&quot;);
 126             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 127 
 128             r.add(readme);
 129             var head = r.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 130             assertEquals(head, r.head());
 131         }
 132     }
 133 
 134     @ParameterizedTest
 135     @EnumSource(VCS.class)
 136     void testConfig(VCS vcs) throws IOException {
 137         try (var dir = new TemporaryDirectory()) {
 138             var r = Repository.init(dir.path(), vcs);
 139 
 140             if (vcs == VCS.GIT) {
 141                 var config = dir.path().resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
 142                 Files.write(config, List.of(&quot;[user]&quot;, &quot;name = duke&quot;), WRITE, APPEND);
 143                 assertEquals(List.of(&quot;duke&quot;), r.config(&quot;user.name&quot;));
 144             } else if (vcs == VCS.HG) {
 145                 var config = dir.path().resolve(&quot;.hg&quot;).resolve(&quot;hgrc&quot;);
 146                 Files.write(config, List.of(&quot;[ui]&quot;, &quot;username = duke&quot;), WRITE, CREATE);
 147                 assertEquals(List.of(&quot;duke&quot;), r.config(&quot;ui.username&quot;));
 148             }
 149 
 150             assertEquals(&quot;duke&quot;, r.username().get());
 151         }
 152     }
 153 
 154     @ParameterizedTest
 155     @EnumSource(VCS.class)
 156     void testCurrentBranchOnEmptyRepository(VCS vcs) throws IOException {
 157         try (var dir = new TemporaryDirectory()) {
 158             var r = Repository.init(dir.path(), vcs);
 159             assertEquals(r.defaultBranch(), r.currentBranch().get());
 160         }
 161     }
 162 
 163     @ParameterizedTest
 164     @EnumSource(VCS.class)
 165     void testCheckout(VCS vcs) throws IOException {
 166         try (var dir = new TemporaryDirectory()) {
 167             var r = Repository.init(dir.path(), vcs);
 168 
 169             var readme = dir.path().resolve(&quot;README&quot;);
 170             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 171             r.add(readme);
 172 
 173             var head1 = r.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 174             assertEquals(head1, r.head());
 175 
 176             Files.write(readme, List.of(&quot;Another line&quot;), WRITE, APPEND);
 177             r.add(readme);
 178 
 179             var head2 = r.commit(&quot;Add one more line&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 180             assertEquals(head2, r.head());
 181 
 182             r.checkout(head1, false);
 183             assertEquals(head1, r.head());
 184 
 185             r.checkout(head2, false);
 186             assertEquals(head2, r.head());
 187         }
 188     }
 189 
 190     @ParameterizedTest
 191     @EnumSource(VCS.class)
 192     void testLines(VCS vcs) throws IOException {
 193         try (var dir = new TemporaryDirectory()) {
 194             var r = Repository.init(dir.path(), vcs);
 195 
 196             var readme = dir.path().resolve(&quot;README&quot;);
 197             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 198             r.add(readme);
 199 
 200             var head1 = r.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 201             assertEquals(List.of(&quot;Hello, readme!&quot;),
 202                          r.lines(readme, head1).orElseThrow());
 203 
 204             Files.write(readme, List.of(&quot;Another line&quot;), WRITE, APPEND);
 205             r.add(readme);
 206 
 207             var head2 = r.commit(&quot;Add one more line&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 208             assertEquals(List.of(&quot;Hello, readme!&quot;, &quot;Another line&quot;),
 209                          r.lines(readme, head2).orElseThrow());
 210         }
 211     }
 212 
 213     @ParameterizedTest
 214     @EnumSource(VCS.class)
 215     void testLinesInSubdir(VCS vcs) throws IOException {
 216         try (var dir = new TemporaryDirectory()) {
 217             Repository.init(dir.path(), vcs);
 218 
 219             var subdir = dir.path().resolve(&quot;sub&quot;);
 220             Files.createDirectories(subdir);
 221             var r = Repository.get(subdir).get();
 222 
 223             var readme = subdir.getParent().resolve(&quot;README&quot;);
 224             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 225             r.add(readme);
 226 
 227             var head = r.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 228             assertEquals(List.of(&quot;Hello, readme!&quot;),
 229                          r.lines(readme, head).orElseThrow());
 230 
 231             var example = subdir.resolve(&quot;EXAMPLE&quot;);
 232             Files.write(example, List.of(&quot;An example&quot;));
 233             r.add(example);
 234 
 235             var head2 = r.commit(&quot;Add EXAMPLE&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 236             assertEquals(List.of(&quot;An example&quot;),
 237                          r.lines(example, head2).orElseThrow());
 238         }
 239     }
 240 
 241     @ParameterizedTest
 242     @EnumSource(VCS.class)
 243     void testCommitListingOnEmptyRepo(VCS vcs) throws IOException {
 244         try (var dir = new TemporaryDirectory()) {
 245             var r = Repository.init(dir.path(), vcs);
 246             assertTrue(r.commits().asList().isEmpty());
 247         }
 248     }
 249 
 250     @ParameterizedTest
 251     @EnumSource(VCS.class)
 252     void testCommitListingWithSingleCommit(VCS vcs) throws IOException {
 253         try (var dir = new TemporaryDirectory()) {
 254             var r = Repository.init(dir.path(), vcs);
 255 
 256             var readme = dir.path().resolve(&quot;README&quot;);
 257             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 258 
 259             r.add(readme);
 260 
 261             var committerName = vcs == VCS.GIT ? &quot;bot&quot; : &quot;duke&quot;;
 262             var committerEmail = vcs == VCS.GIT ? &quot;bot@openjdk.java.net&quot; : &quot;duke@openjdk.java.net&quot;;
 263             var hash = r.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;, committerName, committerEmail);
 264 
 265             var commits = r.commits().asList();
 266             assertEquals(1, commits.size());
 267 
 268             var commit = commits.get(0);
 269             assertEquals(&quot;duke&quot;, commit.author().name());
 270             assertEquals(&quot;duke@openjdk.java.net&quot;, commit.author().email());
 271             assertEquals(committerName, commit.committer().name());
 272             assertEquals(committerEmail, commit.committer().email());
 273 
 274             assertEquals(List.of(&quot;Add README&quot;), commit.message());
 275 
 276             assertEquals(1, commit.numParents());
 277             assertEquals(1, commit.parents().size());
 278 
 279             var nullHash = &quot;0&quot;.repeat(40);
 280             var parent = commit.parents().get(0);
 281             assertEquals(nullHash, parent.hex());
 282 
 283             assertTrue(commit.isInitialCommit());
 284             assertFalse(commit.isMerge());
 285             assertEquals(hash, commit.hash());
 286 
 287             var diffs = commit.parentDiffs();
 288             assertEquals(1, diffs.size());
 289 
 290             var diff = diffs.get(0);
 291             assertEquals(nullHash, diff.from().hex());
 292             assertEquals(hash, diff.to());
 293 
 294             assertEquals(0, diff.removed());
 295             assertEquals(0, diff.modified());
 296             assertEquals(1, diff.added());
 297 
 298             var patches = diff.patches();
 299             assertEquals(1, patches.size());
 300 
 301             var patch = patches.get(0).asTextualPatch();
 302             assertTrue(patch.status().isAdded());
 303 
 304             assertTrue(patch.source().path().isEmpty());
 305             assertTrue(patch.source().type().isEmpty());
 306 
 307             assertEquals(Path.of(&quot;README&quot;), patch.target().path().get());
 308             assertTrue(patch.target().type().get().isRegularNonExecutable());
 309 
 310             var hunks = patch.hunks();
 311             assertEquals(1, hunks.size());
 312 
 313             var hunk = hunks.get(0);
 314             assertEquals(new Range(0, 0), hunk.source().range());
 315             assertEquals(new Range(1, 1), hunk.target().range());
 316 
 317             assertLinesEquals(List.of(), hunk.source().lines());
 318             assertLinesEquals(List.of(&quot;Hello, readme!&quot;), hunk.target().lines());
 319         }
 320     }
 321 
 322     static String stripTrailingCR(String line) {
 323         return line.endsWith(&quot;\r&quot;) ? line.substring(0, line.length() - 1) : line;
 324     }
 325 
 326     static void assertLinesEquals(List&lt;String&gt; expected, List&lt;String&gt; actual) {
 327         assertEquals(expected, actual.stream().map(RepositoryTests::stripTrailingCR).collect(Collectors.toList()));
 328     }
 329 
 330     @ParameterizedTest
 331     @EnumSource(VCS.class)
 332     void testCommitListingWithMultipleCommits(VCS vcs) throws IOException {
 333         try (var dir = new TemporaryDirectory()) {
 334             var r = Repository.init(dir.path(), vcs);
 335 
 336             var readme = dir.path().resolve(&quot;README&quot;);
 337             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 338 
 339             r.add(readme);
 340             var hash1 = r.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 341 
 342             Files.write(readme, List.of(&quot;Another line&quot;), WRITE, APPEND);
 343             r.add(readme);
 344             var hash2 = r.commit(&quot;Modify README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 345 
 346             var commits = r.commits().asList();
 347             assertEquals(2, commits.size());
 348 
 349             var commit = commits.get(0);
 350             assertEquals(&quot;duke&quot;, commit.author().name());
 351             assertEquals(&quot;duke@openjdk.java.net&quot;, commit.author().email());
 352 
 353             assertEquals(List.of(&quot;Modify README&quot;), commit.message());
 354 
 355             assertEquals(1, commit.numParents());
 356             assertEquals(1, commit.parents().size());
 357 
 358             var parent = commit.parents().get(0);
 359             assertEquals(hash1, parent);
 360 
 361             assertFalse(commit.isInitialCommit());
 362             assertFalse(commit.isMerge());
 363             assertEquals(hash2, commit.hash());
 364 
 365             var diffs = commit.parentDiffs();
 366             assertEquals(1, diffs.size());
 367 
 368             var diff = diffs.get(0);
 369             assertEquals(hash1, diff.from());
 370             assertEquals(hash2, diff.to());
 371 
 372             assertEquals(0, diff.removed());
 373             assertEquals(0, diff.modified());
 374             assertEquals(1, diff.added());
 375 
 376             var patches = diff.patches();
 377             assertEquals(1, patches.size());
 378 
 379             var patch = patches.get(0).asTextualPatch();
 380             assertTrue(patch.status().isModified());
 381             assertEquals(Path.of(&quot;README&quot;), patch.source().path().get());
 382             assertTrue(patch.source().type().get().isRegularNonExecutable());
 383             assertEquals(Path.of(&quot;README&quot;), patch.target().path().get());
 384             assertTrue(patch.target().type().get().isRegularNonExecutable());
 385 
 386             var hunks = patch.hunks();
 387             assertEquals(1, hunks.size());
 388 
 389             var hunk = hunks.get(0);
 390             assertEquals(new Range(2, 0), hunk.source().range());
 391             assertEquals(new Range(2, 1), hunk.target().range());
 392 
 393             assertLinesEquals(List.of(), hunk.source().lines());
 394             assertLinesEquals(List.of(&quot;Another line&quot;), hunk.target().lines());
 395         }
 396     }
 397 
 398     @ParameterizedTest
 399     @EnumSource(VCS.class)
 400     void testSquashDeletes(VCS vcs) throws IOException {
 401         try (var dir = new TemporaryDirectory()) {
 402             var r = Repository.init(dir.path(), vcs);
 403 
 404             var file1 = dir.path().resolve(&quot;file1.txt&quot;);
 405             Files.write(file1, List.of(&quot;Hello, file 1!&quot;));
 406             var file2 = dir.path().resolve(&quot;file2.txt&quot;);
 407             Files.write(file2, List.of(&quot;Hello, file 2!&quot;));
 408             var file3 = dir.path().resolve(&quot;file3.txt&quot;);
 409             Files.write(file3, List.of(&quot;Hello, file 3!&quot;));
 410 
 411             r.add(file1, file2, file3);
 412             var hash1 = r.commit(&quot;Add files&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 413 
 414             Files.delete(file2);
 415             r.remove(file2);
 416             var hash2 = r.commit(&quot;Remove file 2&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 417 
 418             Files.delete(file3);
 419             r.remove(file3);
 420             var hash3 = r.commit(&quot;Remove file 3&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 421 
 422             var refspec = vcs == VCS.GIT ? r.head().hex() : r.head().hex() + &quot;:0&quot;;
 423             assertEquals(3, r.commits(refspec).asList().size());
 424 
 425             r.checkout(hash1, false);
 426             r.squash(hash3);
 427             r.commit(&quot;Squashed remove of file 2 and 3&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 428 
 429             refspec = vcs == VCS.GIT ? r.head().hex() : r.head().hex() + &quot;:0&quot;;
 430             var commits = r.commits(refspec).asList();
 431             assertEquals(2, commits.size());
 432 
 433             assertEquals(hash1, commits.get(1).hash());
 434 
 435             var head = commits.get(0);
 436             assertNotEquals(hash2, head);
 437             assertNotEquals(hash3, head);
 438 
 439             assertEquals(hash1, head.parents().get(0));
 440             assertFalse(head.isInitialCommit());
 441             assertFalse(head.isMerge());
 442 
 443             var diffs = head.parentDiffs();
 444             assertEquals(1, diffs.size());
 445 
 446             var diff = diffs.get(0);
 447             assertEquals(hash1, diff.from());
 448             assertEquals(head.hash(), diff.to());
 449 
 450             assertEquals(2, diff.removed());
 451             assertEquals(0, diff.modified());
 452             assertEquals(0, diff.added());
 453         }
 454     }
 455 
 456     @ParameterizedTest
 457     @EnumSource(VCS.class)
 458     void testSquash(VCS vcs) throws IOException {
 459         try (var dir = new TemporaryDirectory()) {
 460             var r = Repository.init(dir.path(), vcs);
 461 
 462             var readme = dir.path().resolve(&quot;README&quot;);
 463             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 464 
 465             r.add(readme);
 466             var hash1 = r.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 467 
 468             Files.write(readme, List.of(&quot;Another line&quot;), WRITE, APPEND);
 469             r.add(readme);
 470             var hash2 = r.commit(&quot;Modify README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 471 
 472             Files.write(readme, List.of(&quot;A final line&quot;), WRITE, APPEND);
 473             r.add(readme);
 474             var hash3 = r.commit(&quot;Modify README again&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 475 
 476             var refspec = vcs == VCS.GIT ? r.head().hex() : r.head().hex() + &quot;:0&quot;;
 477             assertEquals(3, r.commits(refspec).asList().size());
 478 
 479             r.checkout(hash1, false);
 480             r.squash(hash3);
 481             r.commit(&quot;Squashed commits 2 and 3&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 482 
 483             refspec = vcs == VCS.GIT ? r.head().hex() : r.head().hex() + &quot;:0&quot;;
 484             var commits = r.commits(refspec).asList();
 485             assertEquals(2, commits.size());
 486 
 487             assertEquals(hash1, commits.get(1).hash());
 488 
 489             var head = commits.get(0);
 490             assertNotEquals(hash2, head);
 491             assertNotEquals(hash3, head);
 492 
 493             assertEquals(hash1, head.parents().get(0));
 494             assertFalse(head.isInitialCommit());
 495             assertFalse(head.isMerge());
 496 
 497             var diffs = head.parentDiffs();
 498             assertEquals(1, diffs.size());
 499 
 500             var diff = diffs.get(0);
 501             assertEquals(hash1, diff.from());
 502             assertEquals(head.hash(), diff.to());
 503 
 504             assertEquals(0, diff.removed());
 505             assertEquals(0, diff.modified());
 506             assertEquals(2, diff.added());
 507 
 508             var patches = diff.patches();
 509             assertEquals(1, patches.size());
 510 
 511             var patch = patches.get(0).asTextualPatch();
 512             assertTrue(patch.status().isModified());
 513             assertEquals(Path.of(&quot;README&quot;), patch.source().path().get());
 514             assertTrue(patch.source().type().get().isRegularNonExecutable());
 515             assertEquals(Path.of(&quot;README&quot;), patch.target().path().get());
 516             assertTrue(patch.target().type().get().isRegularNonExecutable());
 517 
 518             var hunks = patch.hunks();
 519             assertEquals(1, hunks.size());
 520 
 521             var hunk = hunks.get(0);
 522             assertEquals(new Range(2, 0), hunk.source().range());
 523             assertEquals(new Range(2, 2), hunk.target().range());
 524 
 525             assertLinesEquals(List.of(), hunk.source().lines());
 526             assertLinesEquals(List.of(&quot;Another line&quot;, &quot;A final line&quot;), hunk.target().lines());
 527         }
 528     }
 529 
 530     @ParameterizedTest
 531     @EnumSource(VCS.class)
 532     void testMergeBase(VCS vcs) throws IOException {
 533         try (var dir = new TemporaryDirectory()) {
 534             var r = Repository.init(dir.path(), vcs);
 535 
 536             var readme = dir.path().resolve(&quot;README&quot;);
 537             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 538 
 539             r.add(readme);
 540             var hash1 = r.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 541 
 542             Files.write(readme, List.of(&quot;Another line&quot;), WRITE, APPEND);
 543             r.add(readme);
 544             var hash2 = r.commit(&quot;Modify README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 545 
 546             r.checkout(hash1, false);
 547             Files.write(readme, List.of(&quot;A conflicting line&quot;), WRITE, APPEND);
 548             r.add(readme);
 549             var hash3 = r.commit(&quot;Branching README modification&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 550 
 551             assertEquals(hash1, r.mergeBase(hash2, hash3));
 552         }
 553     }
 554 
 555     @ParameterizedTest
 556     @EnumSource(VCS.class)
 557     void testRebase(VCS vcs) throws IOException {
 558         try (var dir = new TemporaryDirectory()) {
 559             var r = Repository.init(dir.path(), vcs);
 560 
 561             var readme = dir.path().resolve(&quot;README&quot;);
 562             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 563 
 564             r.add(readme);
 565             var hash1 = r.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 566 
 567             Files.write(readme, List.of(&quot;Another line&quot;), WRITE, APPEND);
 568             r.add(readme);
 569             var hash2 = r.commit(&quot;Modify README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 570 
 571             r.checkout(hash1, false);
 572 
 573             var contributing = dir.path().resolve(&quot;CONTRIBUTING&quot;);
 574             Files.write(contributing, List.of(&quot;Keep the patches coming&quot;));
 575             r.add(contributing);
 576             var hash3 = r.commit(&quot;Add independent change&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 577 
 578             var committerName = vcs == VCS.GIT ? &quot;bot&quot; : &quot;duke&quot;;
 579             var committerEmail = vcs == VCS.GIT ? &quot;bot@openjdk.java.net&quot; : &quot;duke@openjdk.java.net&quot;;
 580             r.rebase(hash2, committerName, committerEmail);
 581 
 582             var refspec = vcs == VCS.GIT ? r.head().hex() : r.head().hex() + &quot;:0&quot;;
 583             var commits = r.commits(refspec).asList();
 584             assertEquals(3, commits.size());
 585             assertEquals(hash2, commits.get(1).hash());
 586             assertEquals(hash1, commits.get(2).hash());
 587 
 588             assertEquals(&quot;duke&quot;, commits.get(0).author().name());
 589             assertEquals(&quot;duke@openjdk.java.net&quot;, commits.get(0).author().email());
 590             assertEquals(committerName, commits.get(0).committer().name());
 591             assertEquals(committerEmail, commits.get(0).committer().email());
 592 
 593             assertEquals(&quot;duke&quot;, commits.get(1).author().name());
 594             assertEquals(&quot;duke@openjdk.java.net&quot;, commits.get(1).author().email());
 595             assertEquals(&quot;duke&quot;, commits.get(1).committer().name());
 596             assertEquals(&quot;duke@openjdk.java.net&quot;, commits.get(1).committer().email());
 597 
 598             assertEquals(&quot;duke&quot;, commits.get(2).author().name());
 599             assertEquals(&quot;duke@openjdk.java.net&quot;, commits.get(2).author().email());
 600             assertEquals(&quot;duke&quot;, commits.get(2).committer().name());
 601             assertEquals(&quot;duke@openjdk.java.net&quot;, commits.get(2).committer().email());
 602 
 603             var head = commits.get(0);
 604             assertEquals(hash2, head.parents().get(0));
 605             assertEquals(List.of(&quot;Add independent change&quot;), head.message());
 606 
 607             var diffs = head.parentDiffs();
 608             assertEquals(1, diffs.size());
 609             var diff = diffs.get(0);
 610 
 611             assertEquals(0, diff.removed());
 612             assertEquals(0, diff.modified());
 613             assertEquals(1, diff.added());
 614 
 615             var patches = diff.patches();
 616             assertEquals(1, patches.size());
 617             var patch = patches.get(0).asTextualPatch();
 618             assertEquals(Path.of(&quot;CONTRIBUTING&quot;), patch.target().path().get());
 619 
 620             var hunks = patch.hunks();
 621             assertEquals(1, hunks.size());
 622             var hunk = hunks.get(0);
 623             assertLinesEquals(List.of(&quot;Keep the patches coming&quot;), hunk.target().lines());
 624         }
 625     }
 626 
 627     @ParameterizedTest
 628     @EnumSource(VCS.class)
 629     void testInitializedRepositoryIsEmpty(VCS vcs) throws IOException {
 630         try (var dir = new TemporaryDirectory()) {
 631             var r = Repository.init(dir.path(), vcs);
 632             assertTrue(r.isEmpty());
 633         }
 634     }
 635 
 636     @ParameterizedTest
 637     @EnumSource(VCS.class)
 638     void testRepositoryWithCommitIsNonEmpty(VCS vcs) throws IOException {
 639         try (var dir = new TemporaryDirectory()) {
 640             var r = Repository.init(dir.path(), vcs);
 641 
 642             var readme = dir.path().resolve(&quot;README&quot;);
 643             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 644 
 645             r.add(readme);
 646             r.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 647 
 648             assertFalse(r.isEmpty());
 649         }
 650     }
 651 
 652     @ParameterizedTest
 653     @EnumSource(VCS.class)
 654     void testEmptyRepositoryIsHealthy(VCS vcs) throws IOException {
 655         try (var dir = new TemporaryDirectory()) {
 656             var r = Repository.init(dir.path(), vcs);
 657             assertTrue(r.isHealthy());
 658         }
 659     }
 660 
 661     @ParameterizedTest
 662     @EnumSource(VCS.class)
 663     void testNonEmptyRepositoryIsHealthy(VCS vcs) throws IOException {
 664         try (var dir = new TemporaryDirectory()) {
 665             var r = Repository.init(dir.path(), vcs);
 666 
 667             var readme = dir.path().resolve(&quot;README&quot;);
 668             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 669 
 670             r.add(readme);
 671             r.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 672 
 673             assertTrue(r.isHealthy());
 674         }
 675     }
 676 
 677     @ParameterizedTest
 678     @EnumSource(VCS.class)
 679     void testNonCheckedOutRepositoryIsHealthy(VCS vcs) throws IOException {
 680         try (var dir1 = new TemporaryDirectory();
 681              var dir2 = new TemporaryDirectory()) {
 682             var r1 = Repository.init(dir1.path(), vcs);
 683 
 684             var readme = dir1.path().resolve(&quot;README&quot;);
 685             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 686 
 687             r1.add(readme);
 688             var hash = r1.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 689             r1.tag(hash, &quot;tag&quot;, &quot;tagging&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 690 
 691             var r2 = Repository.init(dir2.path(), vcs);
 692             r2.fetch(r1.root().toUri(), r1.defaultBranch().name());
 693 
 694             assertTrue(r2.isHealthy());
 695         }
 696     }
 697 
 698     @ParameterizedTest
 699     @EnumSource(VCS.class)
 700     void testBranchesOnEmptyRepository(VCS vcs) throws IOException {
 701         try (var dir = new TemporaryDirectory()) {
 702             var r = Repository.init(dir.path(), vcs);
 703             var expected = vcs == VCS.GIT ? List.of() : List.of(new Branch(&quot;default&quot;));
 704             assertEquals(List.of(), r.branches());
 705         }
 706     }
 707 
 708     @ParameterizedTest
 709     @EnumSource(VCS.class)
 710     void testBranchesOnNonEmptyRepository(VCS vcs) throws IOException {
 711         try (var dir = new TemporaryDirectory()) {
 712             var r = Repository.init(dir.path(), vcs);
 713 
 714             var readme = dir.path().resolve(&quot;README&quot;);
 715             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 716 
 717             r.add(readme);
 718             r.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 719 
 720             assertEquals(List.of(r.defaultBranch()), r.branches());
 721         }
 722     }
 723 
 724     @ParameterizedTest
 725     @EnumSource(VCS.class)
 726     void testTagsOnEmptyRepository(VCS vcs) throws IOException {
 727         try (var dir = new TemporaryDirectory()) {
 728             var r = Repository.init(dir.path(), vcs);
 729             var expected = vcs == VCS.GIT ? List.of() : List.of(new Tag(&quot;tip&quot;));
 730             assertEquals(expected, r.tags());
 731         }
 732     }
 733 
 734     @ParameterizedTest
 735     @EnumSource(VCS.class)
 736     void testTagsOnNonEmptyRepository(VCS vcs) throws IOException {
 737         try (var dir = new TemporaryDirectory()) {
 738             var r = Repository.init(dir.path(), vcs);
 739 
 740             var readme = dir.path().resolve(&quot;README&quot;);
 741             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 742 
 743             r.add(readme);
 744             r.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 745 
 746             var expected = vcs == VCS.GIT ? List.of() : List.of(new Tag(&quot;tip&quot;));
 747             assertEquals(expected, r.tags());
 748         }
 749     }
 750 
 751     @ParameterizedTest
 752     @EnumSource(VCS.class)
 753     void testFetchAndPush(VCS vcs) throws IOException {
 754         try (var dir = new TemporaryDirectory()) {
 755             var upstream = Repository.init(dir.path(), vcs);
 756 
 757             if (vcs == VCS.GIT) {
 758                 Files.write(upstream.root().resolve(&quot;.git&quot;).resolve(&quot;config&quot;),
 759                             List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch=ignore&quot;),
 760                             WRITE, APPEND);
 761             }
 762 
 763             var readme = dir.path().resolve(&quot;README&quot;);
 764             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 765 
 766             upstream.add(readme);
 767             upstream.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 768 
 769             try (var dir2 = new TemporaryDirectory()) {
 770                 var downstream = Repository.init(dir2.path(), vcs);
 771 
 772                  // note: forcing unix path separators for URI
 773                 var upstreamURI = URI.create(&quot;file:///&quot; + dir.toString().replace(&#39;\\&#39;, &#39;/&#39;));
 774 
 775                 var fetchHead = downstream.fetch(upstreamURI, downstream.defaultBranch().name());
 776                 downstream.checkout(fetchHead, false);
 777 
 778                 var downstreamReadme = dir2.path().resolve(&quot;README&quot;);
 779                 Files.write(downstreamReadme, List.of(&quot;Downstream change&quot;), WRITE, APPEND);
 780 
 781                 downstream.add(downstreamReadme);
 782                 var head = downstream.commit(&quot;Modify README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 783 
 784                 downstream.push(head, upstreamURI, downstream.defaultBranch().name());
 785             }
 786 
 787             upstream.checkout(upstream.resolve(upstream.defaultBranch().name()).get(), false);
 788 
 789             var commits = upstream.commits().asList();
 790             assertEquals(2, commits.size());
 791         }
 792     }
 793 
 794     @ParameterizedTest
 795     @EnumSource(VCS.class)
 796     void testClean(VCS vcs) throws IOException {
 797         try (var dir = new TemporaryDirectory()) {
 798             var r = Repository.init(dir.path(), vcs);
 799             r.clean();
 800 
 801             var readme = dir.path().resolve(&quot;README&quot;);
 802             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 803 
 804             r.add(readme);
 805             var hash1 = r.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 806 
 807             r.clean();
 808 
 809             assertEquals(hash1, r.head());
 810 
 811             Files.write(readme, List.of(&quot;A random change&quot;), WRITE, APPEND);
 812 
 813             r.clean();
 814 
 815             assertEquals(List.of(&quot;Hello, readme!&quot;), Files.readAllLines(readme));
 816 
 817             var untracked = dir.path().resolve(&quot;UNTRACKED&quot;);
 818             Files.write(untracked, List.of(&quot;Random text&quot;));
 819 
 820             r.clean();
 821 
 822             assertFalse(Files.exists(untracked));
 823 
 824             // Mercurial cannot currently deal with this situation
 825             if (vcs != VCS.HG) {
 826                 var subRepo = Repository.init(dir.path().resolve(&quot;submodule&quot;), vcs);
 827                 var subRepoFile = subRepo.root().resolve(&quot;file.txt&quot;);
 828                 Files.write(subRepoFile, List.of(&quot;Looks like a file in a submodule&quot;));
 829 
 830                 r.clean();
 831 
 832                 assertFalse(Files.exists(subRepoFile));
 833             }
 834         }
 835     }
 836 
 837     @ParameterizedTest
 838     @EnumSource(VCS.class)
 839     void testCleanIgnored(VCS vcs) throws IOException {
 840         try (var dir = new TemporaryDirectory()) {
 841             var r = Repository.init(dir.path(), vcs);
 842             r.clean();
 843 
 844             var readme = dir.path().resolve(&quot;README&quot;);
 845             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 846             Files.write(dir.path().resolve(&quot;.gitignore&quot;), List.of(&quot;*.txt&quot;));
 847             Files.write(dir.path().resolve(&quot;.hgignore&quot;), List.of(&quot;.*txt&quot;));
 848 
 849             r.add(readme);
 850             var hash1 = r.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 851 
 852             var ignored = dir.path().resolve(&quot;ignored.txt&quot;);
 853             Files.write(ignored, List.of(&quot;Random text&quot;));
 854 
 855             r.clean();
 856 
 857             assertFalse(Files.exists(ignored));
 858         }
 859     }
 860 
 861     @ParameterizedTest
 862     @EnumSource(VCS.class)
 863     void testDiffBetweenCommits(VCS vcs) throws IOException {
 864         try (var dir = new TemporaryDirectory()) {
 865             var r = Repository.init(dir.path(), vcs);
 866 
 867             var readme = dir.path().resolve(&quot;README&quot;);
 868             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 869 
 870             r.add(readme);
 871             var first = r.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 872 
 873             Files.write(readme, List.of(&quot;One more line&quot;), WRITE, APPEND);
 874             r.add(readme);
 875             var second = r.commit(&quot;Add one more line&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 876 
 877             var diff = r.diff(first, second);
 878             assertEquals(first, diff.from());
 879             assertEquals(second, diff.to());
 880 
 881             var patches = diff.patches();
 882             assertEquals(1, patches.size());
 883 
 884             var patch = patches.get(0).asTextualPatch();
 885             assertEquals(Path.of(&quot;README&quot;), patch.source().path().get());
 886             assertEquals(Path.of(&quot;README&quot;), patch.target().path().get());
 887             assertTrue(patch.source().type().get().isRegularNonExecutable());
 888             assertTrue(patch.target().type().get().isRegularNonExecutable());
 889             assertTrue(patch.status().isModified());
 890 
 891             var hunks = patch.hunks();
 892             assertEquals(1, hunks.size());
 893 
 894             var hunk = hunks.get(0);
 895             assertEquals(2, hunk.source().range().start());
 896             assertEquals(0, hunk.source().range().count());
 897             assertEquals(0, hunk.source().lines().size());
 898 
 899             assertEquals(2, hunk.target().range().start());
 900             assertEquals(1, hunk.target().range().count());
 901             assertLinesEquals(List.of(&quot;One more line&quot;), hunk.target().lines());
 902 
 903             assertEquals(1, hunk.added());
 904             assertEquals(0, hunk.removed());
 905             assertEquals(0, hunk.modified());
 906         }
 907     }
 908 
 909     @ParameterizedTest
 910     @EnumSource(VCS.class)
 911     void testDiffBetweenCommitsWithMultiplePatches(VCS vcs) throws IOException {
 912         try (var dir = new TemporaryDirectory()) {
 913             var r = Repository.init(dir.path(), vcs);
 914 
 915             var readme = dir.path().resolve(&quot;README&quot;);
 916             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
 917 
 918             var building = dir.path().resolve(&quot;BUILDING&quot;);
 919             Files.write(building, List.of(&quot;make&quot;));
 920 
 921             r.add(readme);
 922             r.add(building);
 923             var first = r.commit(&quot;Add README and BUILDING&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 924 
 925             Files.write(readme, List.of(&quot;Hello, Skara!&quot;), WRITE, TRUNCATE_EXISTING);
 926             Files.write(building, List.of(&quot;make images&quot;), WRITE, TRUNCATE_EXISTING);
 927             r.add(readme);
 928             r.add(building);
 929             var second = r.commit(&quot;Modify README and BUILDING&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 930 
 931             var diff = r.diff(first, second);
 932             assertEquals(first, diff.from());
 933             assertEquals(second, diff.to());
 934 
 935             var patches = diff.patches();
 936             assertEquals(2, patches.size());
 937 
 938             var patch1 = patches.get(0).asTextualPatch();
 939             assertEquals(Path.of(&quot;BUILDING&quot;), patch1.source().path().get());
 940             assertEquals(Path.of(&quot;BUILDING&quot;), patch1.target().path().get());
 941             assertTrue(patch1.source().type().get().isRegularNonExecutable());
 942             assertTrue(patch1.target().type().get().isRegularNonExecutable());
 943             assertTrue(patch1.status().isModified());
 944 
 945             var hunks1 = patch1.hunks();
 946             assertEquals(1, hunks1.size());
 947 
 948             var hunk1 = hunks1.get(0);
 949             assertEquals(1, hunk1.source().range().start());
 950             assertEquals(1, hunk1.source().range().count());
 951             assertLinesEquals(List.of(&quot;make&quot;), hunk1.source().lines());
 952 
 953             assertEquals(1, hunk1.target().range().start());
 954             assertEquals(1, hunk1.target().range().count());
 955             assertLinesEquals(List.of(&quot;make images&quot;), hunk1.target().lines());
 956 
 957             var patch2 = patches.get(1).asTextualPatch();
 958             assertEquals(Path.of(&quot;README&quot;), patch2.source().path().get());
 959             assertEquals(Path.of(&quot;README&quot;), patch2.target().path().get());
 960             assertTrue(patch2.source().type().get().isRegularNonExecutable());
 961             assertTrue(patch2.target().type().get().isRegularNonExecutable());
 962             assertTrue(patch2.status().isModified());
 963 
 964             var hunks2 = patch2.hunks();
 965             assertEquals(1, hunks2.size());
 966 
 967             var hunk2 = hunks2.get(0);
 968             assertEquals(1, hunk2.source().range().start());
 969             assertEquals(1, hunk2.source().range().count());
 970             assertLinesEquals(List.of(&quot;Hello, readme!&quot;), hunk2.source().lines());
 971 
 972             assertEquals(1, hunk2.target().range().start());
 973             assertEquals(1, hunk2.target().range().count());
 974             assertLinesEquals(List.of(&quot;Hello, Skara!&quot;), hunk2.target().lines());
 975         }
 976     }
 977 
 978     @ParameterizedTest
 979     @EnumSource(VCS.class)
 980     void testDiffBetweenCommitsWithMultipleHunks(VCS vcs) throws IOException {
 981         try (var dir = new TemporaryDirectory()) {
 982             var r = Repository.init(dir.path(), vcs);
 983 
 984             var abc = dir.path().resolve(&quot;abc.txt&quot;);
 985             Files.write(abc, List.of(&quot;A&quot;, &quot;B&quot;, &quot;C&quot;));
 986 
 987             r.add(abc);
 988             var first = r.commit(&quot;Added ABC&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 989 
 990             Files.write(abc, List.of(&quot;1&quot;, &quot;2&quot;, &quot;B&quot;, &quot;3&quot;), WRITE, TRUNCATE_EXISTING);
 991             r.add(abc);
 992             var second = r.commit(&quot;Modify A and C&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
 993 
 994             var diff = r.diff(first, second);
 995             assertEquals(first, diff.from());
 996             assertEquals(second, diff.to());
 997 
 998             var patches = diff.patches();
 999             assertEquals(1, patches.size());
1000 
1001             var patch = patches.get(0).asTextualPatch();
1002             assertEquals(Path.of(&quot;abc.txt&quot;), patch.source().path().get());
1003             assertEquals(Path.of(&quot;abc.txt&quot;), patch.target().path().get());
1004             assertTrue(patch.source().type().get().isRegularNonExecutable());
1005             assertTrue(patch.target().type().get().isRegularNonExecutable());
1006             assertTrue(patch.status().isModified());
1007 
1008             var hunks = patch.hunks();
1009             assertEquals(2, hunks.size());
1010 
1011             var hunk1 = hunks.get(0);
1012             assertEquals(1, hunk1.source().range().start());
1013             assertEquals(1, hunk1.source().range().count());
1014             assertLinesEquals(List.of(&quot;A&quot;), hunk1.source().lines());
1015 
1016             assertEquals(1, hunk1.target().range().start());
1017             assertEquals(2, hunk1.target().range().count());
1018             assertLinesEquals(List.of(&quot;1&quot;, &quot;2&quot;), hunk1.target().lines());
1019 
1020             assertEquals(1, hunk1.added());
1021             assertEquals(0, hunk1.removed());
1022             assertEquals(1, hunk1.modified());
1023 
1024             var hunk2 = hunks.get(1);
1025             assertEquals(3, hunk2.source().range().start());
1026             assertEquals(1, hunk2.source().range().count());
1027             assertLinesEquals(List.of(&quot;C&quot;), hunk2.source().lines());
1028 
1029             assertEquals(4, hunk2.target().range().start());
1030             assertEquals(1, hunk2.target().range().count());
1031             assertLinesEquals(List.of(&quot;3&quot;), hunk2.target().lines());
1032 
1033             assertEquals(0, hunk2.added());
1034             assertEquals(0, hunk2.removed());
1035             assertEquals(1, hunk2.modified());
1036         }
1037     }
1038 
1039     @ParameterizedTest
1040     @EnumSource(VCS.class)
1041     void testDiffWithRemoval(VCS vcs) throws IOException {
1042         try (var dir = new TemporaryDirectory()) {
1043             var r = Repository.init(dir.path(), vcs);
1044 
1045             var readme = dir.path().resolve(&quot;README&quot;);
1046             Files.write(readme, List.of(&quot;Hello, world!&quot;));
1047 
1048             r.add(readme);
1049             var first = r.commit(&quot;Added README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1050 
1051             Files.delete(readme);
1052             r.remove(readme);
1053             var second = r.commit(&quot;Removed README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1054 
1055             var diff = r.diff(first, second);
1056             assertEquals(first, diff.from());
1057             assertEquals(second, diff.to());
1058 
1059             var patches = diff.patches();
1060             assertEquals(1, patches.size());
1061 
1062             var patch = patches.get(0).asTextualPatch();
1063             assertEquals(Path.of(&quot;README&quot;), patch.source().path().get());
1064             assertTrue(patch.target().path().isEmpty());
1065             assertTrue(patch.source().type().get().isRegularNonExecutable());
1066             assertTrue(patch.target().type().isEmpty());
1067             assertTrue(patch.status().isDeleted());
1068 
1069             var hunks = patch.hunks();
1070             assertEquals(1, hunks.size());
1071 
1072             var hunk = hunks.get(0);
1073             assertEquals(1, hunk.source().range().start());
1074             assertEquals(1, hunk.source().range().count());
1075             assertLinesEquals(List.of(&quot;Hello, world!&quot;), hunk.source().lines());
1076 
1077             assertEquals(0, hunk.target().range().start());
1078             assertEquals(0, hunk.target().range().count());
1079             assertLinesEquals(List.of(), hunk.target().lines());
1080 
1081             assertEquals(0, hunk.added());
1082             assertEquals(1, hunk.removed());
1083             assertEquals(0, hunk.modified());
1084         }
1085     }
1086 
1087     @ParameterizedTest
1088     @EnumSource(VCS.class)
1089     void testDiffWithAddition(VCS vcs) throws IOException {
1090         try (var dir = new TemporaryDirectory()) {
1091             var r = Repository.init(dir.path(), vcs);
1092 
1093             var readme = dir.path().resolve(&quot;README&quot;);
1094             Files.write(readme, List.of(&quot;Hello, world!&quot;));
1095 
1096             r.add(readme);
1097             var first = r.commit(&quot;Added README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1098 
1099             var building = dir.path().resolve(&quot;BUILDING&quot;);
1100             Files.write(building, List.of(&quot;make&quot;));
1101             r.add(building);
1102             var second = r.commit(&quot;Added BUILDING&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1103 
1104             var diff = r.diff(first, second);
1105             assertEquals(first, diff.from());
1106             assertEquals(second, diff.to());
1107 
1108             var patches = diff.patches();
1109             assertEquals(1, patches.size());
1110 
1111             var patch = patches.get(0).asTextualPatch();
1112             assertTrue(patch.source().path().isEmpty());
1113             assertEquals(Path.of(&quot;BUILDING&quot;), patch.target().path().get());
1114             assertTrue(patch.source().type().isEmpty());
1115             assertTrue(patch.target().type().get().isRegularNonExecutable());
1116             assertTrue(patch.status().isAdded());
1117 
1118             var hunks = patch.hunks();
1119             assertEquals(1, hunks.size());
1120 
1121             var hunk = hunks.get(0);
1122             assertEquals(0, hunk.source().range().start());
1123             assertEquals(0, hunk.source().range().count());
1124             assertLinesEquals(List.of(), hunk.source().lines());
1125 
1126             assertEquals(1, hunk.target().range().start());
1127             assertEquals(1, hunk.target().range().count());
1128             assertLinesEquals(List.of(&quot;make&quot;), hunk.target().lines());
1129 
1130             assertEquals(1, hunk.added());
1131             assertEquals(0, hunk.removed());
1132             assertEquals(0, hunk.modified());
1133         }
1134     }
1135 
1136     @ParameterizedTest
1137     @EnumSource(VCS.class)
1138     void testDiffWithWorkingDir(VCS vcs) throws IOException {
1139         try (var dir = new TemporaryDirectory()) {
1140             var r = Repository.init(dir.path(), vcs);
1141 
1142             var readme = dir.path().resolve(&quot;README&quot;);
1143             Files.write(readme, List.of(&quot;Hello, world!&quot;));
1144 
1145             r.add(readme);
1146             var first = r.commit(&quot;Added README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1147 
1148             Files.write(readme, List.of(&quot;One more line&quot;), WRITE, APPEND);
1149             var diff = r.diff(first);
1150 
1151             assertEquals(first, diff.from());
1152             assertNull(diff.to());
1153 
1154             var patches = diff.patches();
1155             assertEquals(1, patches.size());
1156 
1157             var patch = patches.get(0).asTextualPatch();
1158             assertEquals(Path.of(&quot;README&quot;), patch.source().path().get());
1159             assertEquals(Path.of(&quot;README&quot;), patch.target().path().get());
1160             assertTrue(patch.source().type().get().isRegularNonExecutable());
1161             assertTrue(patch.target().type().get().isRegularNonExecutable());
1162             assertTrue(patch.status().isModified());
1163 
1164             var hunks = patch.hunks();
1165             assertEquals(1, hunks.size());
1166 
1167             var hunk = hunks.get(0);
1168             assertEquals(2, hunk.source().range().start());
1169             assertEquals(0, hunk.source().range().count());
1170             assertLinesEquals(List.of(), hunk.source().lines());
1171 
1172             assertEquals(2, hunk.target().range().start());
1173             assertEquals(1, hunk.target().range().count());
1174             assertLinesEquals(List.of(&quot;One more line&quot;), hunk.target().lines());
1175 
1176             assertEquals(1, hunk.added());
1177             assertEquals(0, hunk.removed());
1178             assertEquals(0, hunk.modified());
1179         }
1180     }
1181 
1182     @ParameterizedTest
1183     @EnumSource(VCS.class)
1184     void testCommitMetadata(VCS vcs) throws IOException {
1185         try (var dir = new TemporaryDirectory()) {
1186             var r = Repository.init(dir.path(), vcs);
1187 
1188             var readme = dir.path().resolve(&quot;README&quot;);
1189             Files.write(readme, List.of(&quot;Hello, world!&quot;));
1190             r.add(readme);
1191             var first = r.commit(&quot;Added README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1192 
1193             Files.write(readme, List.of(&quot;One more line&quot;), WRITE, APPEND);
1194             r.add(readme);
1195             var second = r.commit(&quot;Modified README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1196 
1197             var metadata = r.commitMetadata();
1198             assertEquals(2, metadata.size());
1199 
1200             assertEquals(second, metadata.get(0).hash());
1201             assertEquals(List.of(&quot;Modified README&quot;), metadata.get(0).message());
1202 
1203             assertEquals(first, metadata.get(1).hash());
1204             assertEquals(List.of(&quot;Added README&quot;), metadata.get(1).message());
1205         }
1206     }
1207 
1208     @ParameterizedTest
1209     @EnumSource(VCS.class)
1210     void testCommitMetadataWithFiles(VCS vcs) throws IOException {
1211         try (var dir = new TemporaryDirectory()) {
1212             var r = Repository.init(dir.path(), vcs);
1213 
1214             var readme1 = dir.path().resolve(&quot;README_1&quot;);
1215             Files.write(readme1, List.of(&quot;1&quot;));
1216             r.add(readme1);
1217             var first = r.commit(&quot;Added README_1&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1218 
1219             var readme2 = dir.path().resolve(&quot;README_2&quot;);
1220             Files.write(readme2, List.of(&quot;2&quot;));
1221             r.add(readme2);
1222             var second = r.commit(&quot;Added README_2&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1223 
1224             Files.write(readme2, List.of(&quot;3&quot;), WRITE, APPEND);
1225             r.add(readme2);
1226             var third = r.commit(&quot;Modified README_2&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1227 
1228             var metadata = r.commitMetadata(List.of(Path.of(&quot;README_1&quot;)));
1229             assertEquals(1, metadata.size());
1230             assertEquals(first, metadata.get(0).hash());
1231 
1232             metadata = r.commitMetadata(List.of(Path.of(&quot;README_2&quot;)));
1233             assertEquals(2, metadata.size());
1234             assertEquals(third, metadata.get(0).hash());
1235             assertEquals(second, metadata.get(1).hash());
1236 
1237             metadata = r.commitMetadata(List.of(Path.of(&quot;README_1&quot;), Path.of(&quot;README_2&quot;)));
1238             assertEquals(3, metadata.size());
1239             assertEquals(third, metadata.get(0).hash());
1240             assertEquals(second, metadata.get(1).hash());
1241             assertEquals(first, metadata.get(2).hash());
1242         }
1243     }
1244 
1245     @ParameterizedTest
1246     @EnumSource(VCS.class)
1247     void testCommitMetadataWithReverse(VCS vcs) throws IOException {
1248         try (var dir = new TemporaryDirectory()) {
1249             var r = Repository.init(dir.path(), vcs);
1250 
1251             var readme = dir.path().resolve(&quot;README&quot;);
1252             Files.write(readme, List.of(&quot;Hello, world!&quot;));
1253             r.add(readme);
1254             var first = r.commit(&quot;Added README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1255 
1256             Files.write(readme, List.of(&quot;One more line&quot;), WRITE, APPEND);
1257             r.add(readme);
1258             var second = r.commit(&quot;Modified README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1259 
1260             var metadata = r.commitMetadata();
1261             assertEquals(2, metadata.size());
1262             assertEquals(second, metadata.get(0).hash());
1263             assertEquals(first, metadata.get(1).hash());
1264 
1265             metadata = r.commitMetadata(true);
1266             assertEquals(2, metadata.size());
1267             assertEquals(first, metadata.get(0).hash());
1268             assertEquals(second, metadata.get(1).hash());
1269         }
1270     }
1271 
1272     @ParameterizedTest
1273     @EnumSource(VCS.class)
1274     void testTrivialMerge(VCS vcs) throws IOException {
1275         try (var dir = new TemporaryDirectory()) {
1276             var r = Repository.init(dir.path(), vcs);
1277 
1278             var readme = dir.path().resolve(&quot;README&quot;);
1279             Files.write(readme, List.of(&quot;Hello, world!&quot;));
1280             r.add(readme);
1281             var first = r.commit(&quot;Added README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1282 
1283             Files.write(readme, List.of(&quot;One more line&quot;), WRITE, APPEND);
1284             r.add(readme);
1285             var second = r.commit(&quot;Modified README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1286 
1287             r.checkout(first, false);
1288 
1289             var contributing = dir.path().resolve(&quot;CONTRIBUTING&quot;);
1290             Files.write(contributing, List.of(&quot;Send those patches!&quot;));
1291             r.add(contributing);
1292             var third = r.commit(&quot;Added contributing&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1293 
1294             r.merge(second);
1295             r.commit(&quot;Merge&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1296 
1297             var refspec = vcs == VCS.GIT ? r.head().hex() : r.head().hex() + &quot;:0&quot;;
1298             var commits = r.commits(refspec).asList();
1299 
1300             assertEquals(4, commits.size());
1301 
1302             var merge = commits.get(0);
1303             assertEquals(List.of(&quot;Merge&quot;), merge.message());
1304 
1305             var parents = new HashSet&lt;&gt;(merge.parents());
1306             assertEquals(2, parents.size());
1307             assertTrue(parents.contains(second));
1308             assertTrue(parents.contains(third));
1309 
1310             var diffs = merge.parentDiffs();
1311             assertEquals(2, diffs.size());
1312 
1313             var diff1 = diffs.get(0);
1314             assertEquals(merge.hash(), diff1.to());
1315             assertEquals(0, diff1.patches().size());
1316             assertTrue(parents.contains(diff1.from()));
1317 
1318             var diff2 = diffs.get(1);
1319             assertEquals(merge.hash(), diff2.to());
1320             assertEquals(0, diff2.patches().size());
1321             assertTrue(parents.contains(diff2.from()));
1322         }
1323     }
1324 
1325     @ParameterizedTest
1326     @EnumSource(VCS.class)
1327     void testMergeWithEdit(VCS vcs) throws IOException {
1328         try (var dir = new TemporaryDirectory()) {
1329             var r = Repository.init(dir.path(), vcs);
1330 
1331             var readme = dir.path().resolve(&quot;README&quot;);
1332             Files.write(readme, List.of(&quot;Hello, world!&quot;));
1333             r.add(readme);
1334             var first = r.commit(&quot;Added README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1335 
1336             Files.write(readme, List.of(&quot;One more line&quot;), WRITE, APPEND);
1337             r.add(readme);
1338             var second = r.commit(&quot;Modified README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1339 
1340             r.checkout(first, false);
1341 
1342             var contributing = dir.path().resolve(&quot;CONTRIBUTING&quot;);
1343             Files.write(contributing, List.of(&quot;Send those patches!&quot;));
1344             r.add(contributing);
1345             var third = r.commit(&quot;Added contributing&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1346 
1347             r.merge(second);
1348 
1349             Files.write(readme, List.of(&quot;One last line&quot;), WRITE, APPEND);
1350             r.add(readme);
1351             r.commit(&quot;Merge&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1352 
1353             var refspec = vcs == VCS.GIT ? r.head().hex() : r.head().hex() + &quot;:0&quot;;
1354             var commits = r.commits(refspec).asList();
1355 
1356             assertEquals(4, commits.size());
1357 
1358             var merge = commits.get(0);
1359             assertEquals(List.of(&quot;Merge&quot;), merge.message());
1360 
1361             var parents = new HashSet&lt;&gt;(merge.parents());
1362             assertEquals(2, parents.size());
1363             assertTrue(parents.contains(second));
1364             assertTrue(parents.contains(third));
1365 
1366             var diffs = merge.parentDiffs();
1367             assertEquals(2, diffs.size());
1368 
1369             var secondDiff = diffs.stream().filter(d -&gt; d.from().equals(second)).findFirst().get();
1370             assertEquals(merge.hash(), secondDiff.to());
1371             assertEquals(1, secondDiff.patches().size());
1372             var secondPatch = secondDiff.patches().get(0).asTextualPatch();
1373 
1374             assertEquals(Path.of(&quot;README&quot;), secondPatch.source().path().get());
1375             assertEquals(Path.of(&quot;README&quot;), secondPatch.target().path().get());
1376             assertTrue(secondPatch.status().isModified());
1377             assertEquals(1, secondPatch.hunks().size());
1378 
1379             var secondHunk = secondPatch.hunks().get(0);
1380             assertLinesEquals(List.of(), secondHunk.source().lines());
1381             assertLinesEquals(List.of(&quot;One last line&quot;), secondHunk.target().lines());
1382 
1383             assertEquals(3, secondHunk.source().range().start());
1384             assertEquals(0, secondHunk.source().range().count());
1385             assertEquals(3, secondHunk.target().range().start());
1386             assertEquals(1, secondHunk.target().range().count());
1387 
1388             var thirdDiff = diffs.stream().filter(d -&gt; d.from().equals(third)).findFirst().get();
1389             assertEquals(merge.hash(), thirdDiff.to());
1390             assertEquals(1, thirdDiff.patches().size());
1391             var thirdPatch = thirdDiff.patches().get(0).asTextualPatch();
1392 
1393             assertEquals(Path.of(&quot;README&quot;), thirdPatch.source().path().get());
1394             assertEquals(Path.of(&quot;README&quot;), thirdPatch.target().path().get());
1395             assertTrue(thirdPatch.status().isModified());
1396             assertEquals(1, thirdPatch.hunks().size());
1397 
1398             var thirdHunk = thirdPatch.hunks().get(0);
1399             assertLinesEquals(List.of(), thirdHunk.source().lines());
1400             assertLinesEquals(List.of(&quot;One more line&quot;, &quot;One last line&quot;), thirdHunk.target().lines());
1401 
1402             assertEquals(2, thirdHunk.source().range().start());
1403             assertEquals(0, thirdHunk.source().range().count());
1404             assertEquals(2, thirdHunk.target().range().start());
1405             assertEquals(2, thirdHunk.target().range().count());
1406         }
1407     }
1408 
1409     @ParameterizedTest
1410     @EnumSource(VCS.class)
1411     void testDefaultBranch(VCS vcs) throws IOException {
1412         try (var dir = new TemporaryDirectory()) {
1413             var r = Repository.init(dir.path(), vcs);
1414             var expected = vcs == VCS.GIT ? &quot;master&quot; : &quot;default&quot;;
1415             assertEquals(expected, r.defaultBranch().name());
1416         }
1417     }
1418 
1419     @ParameterizedTest
1420     @EnumSource(VCS.class)
1421     void testPaths(VCS vcs) throws IOException {
1422         try (var dir = new TemporaryDirectory()) {
1423             var r = Repository.init(dir.path(), vcs);
1424             var remote = vcs == VCS.GIT ? &quot;origin&quot; : &quot;default&quot;;
1425             r.setPaths(remote, &quot;http://pull&quot;, &quot;http://push&quot;);
1426             assertEquals(&quot;http://pull&quot;, r.pullPath(remote));
1427             assertEquals(&quot;http://push&quot;, r.pushPath(remote));
1428         }
1429     }
1430 
1431     @ParameterizedTest
1432     @EnumSource(VCS.class)
1433     void testIsValidRevisionRange(VCS vcs) throws IOException {
1434         try (var dir = new TemporaryDirectory()) {
1435             var r = Repository.init(dir.path(), vcs);
1436             assertFalse(r.isValidRevisionRange(&quot;foo&quot;));
1437 
1438             var readme = dir.path().resolve(&quot;README&quot;);
1439             Files.write(readme, List.of(&quot;Hello, world!&quot;));
1440             r.add(readme);
1441             r.commit(&quot;Added README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1442 
1443             assertTrue(r.isValidRevisionRange(r.defaultBranch().toString()));
1444         }
1445     }
1446 
1447     @ParameterizedTest
1448     @EnumSource(VCS.class)
1449     void testDefaultTag(VCS vcs) throws IOException {
1450         try (var dir = new TemporaryDirectory()) {
1451             var r = Repository.init(dir.path(), vcs);
1452             var expected = vcs == VCS.GIT ? Optional.empty() : Optional.of(new Tag(&quot;tip&quot;));
1453             assertEquals(expected, r.defaultTag());
1454         }
1455     }
1456 
1457     @ParameterizedTest
1458     @EnumSource(VCS.class)
1459     void testTag(VCS vcs) throws IOException {
1460         try (var dir = new TemporaryDirectory()) {
1461             var r = Repository.init(dir.path(), vcs);
1462 
1463             var readme = dir.path().resolve(&quot;README&quot;);
1464             Files.write(readme, List.of(&quot;Hello, world!&quot;));
1465             r.add(readme);
1466             var first = r.commit(&quot;Added README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1467 
1468             r.tag(first, &quot;test&quot;, &quot;Tagging test&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1469             var defaultTag = r.defaultTag().orElse(null);
1470             var nonDefaultTags = r.tags().stream()
1471                                   .filter(tag -&gt; !tag.equals(defaultTag))
1472                                   .map(Tag::toString)
1473                                   .collect(Collectors.toList());
1474             assertEquals(List.of(&quot;test&quot;), nonDefaultTags);
1475         }
1476     }
1477 
1478     @ParameterizedTest
1479     @EnumSource(VCS.class)
1480     void testIsClean(VCS vcs) throws IOException {
1481         try (var dir = new TemporaryDirectory()) {
1482             var r = Repository.init(dir.path(), vcs);
1483             assertTrue(r.isClean());
1484 
1485             var readme = dir.path().resolve(&quot;README&quot;);
1486             Files.write(readme, List.of(&quot;Hello, world!&quot;));
1487             assertFalse(r.isClean());
1488 
1489             r.add(readme);
1490             assertFalse(r.isClean());
1491 
1492             r.commit(&quot;Added README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1493             assertTrue(r.isClean());
1494 
1495             Files.delete(readme);
1496             assertFalse(r.isClean());
1497 
1498             Files.write(readme, List.of(&quot;Hello, world!&quot;));
1499             assertTrue(r.isClean());
1500         }
1501     }
1502 
1503     @ParameterizedTest
1504     @EnumSource(VCS.class)
1505     void testShowOnExecutableFiles(VCS vcs) throws IOException {
1506         try (var dir = new TemporaryDirectory()) {
1507             var r = Repository.init(dir.path(), vcs);
1508             assertTrue(r.isClean());
1509 
1510             var readOnlyExecutableFile = dir.path().resolve(&quot;hello.sh&quot;);
1511             Files.write(readOnlyExecutableFile, List.of(&quot;echo &#39;hello&#39;&quot;));
1512             if (readOnlyExecutableFile.getFileSystem().supportedFileAttributeViews().contains(&quot;posix&quot;)) {
1513                 var permissions = PosixFilePermissions.fromString(&quot;r-xr-xr-x&quot;);
1514                 Files.setPosixFilePermissions(readOnlyExecutableFile, permissions);
1515             }
1516             r.add(readOnlyExecutableFile);
1517             var hash = r.commit(&quot;Added read only executable file&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1518             assertEquals(Optional.of(List.of(&quot;echo &#39;hello&#39;&quot;)), r.lines(readOnlyExecutableFile, hash));
1519 
1520             var readWriteExecutableFile = dir.path().resolve(&quot;goodbye.sh&quot;);
1521             Files.write(readWriteExecutableFile, List.of(&quot;echo &#39;goodbye&#39;&quot;));
1522             if (readOnlyExecutableFile.getFileSystem().supportedFileAttributeViews().contains(&quot;posix&quot;)) {
1523                 var permissions = PosixFilePermissions.fromString(&quot;rwxrwxrwx&quot;);
1524                 Files.setPosixFilePermissions(readWriteExecutableFile, permissions);
1525             }
1526             r.add(readWriteExecutableFile);
1527             var hash2 = r.commit(&quot;Added read-write executable file&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1528             assertEquals(Optional.of(List.of(&quot;echo &#39;goodbye&#39;&quot;)), r.lines(readWriteExecutableFile, hash2));
1529         }
1530     }
1531 
1532     @Test
1533     void testGetAndExistsOnNonExistingDirectory() throws IOException {
1534         var nonExistingDirectory = Path.of(&quot;this&quot;, &quot;does&quot;, &quot;not&quot;, &quot;exist&quot;);
1535         assertEquals(Optional.empty(), Repository.get(nonExistingDirectory));
1536         assertEquals(false, Repository.exists(nonExistingDirectory));
1537     }
1538 
1539     @ParameterizedTest
1540     @EnumSource(VCS.class)
1541     void testDiffOnFilenamesWithSpace(VCS vcs) throws IOException {
1542         try (var dir = new TemporaryDirectory()) {
1543             var r = Repository.init(dir.path(), vcs);
1544             assertTrue(r.isClean());
1545 
1546             var fileWithSpaceInName = dir.path().resolve(&quot;hello world.txt&quot;);
1547             Files.writeString(fileWithSpaceInName, &quot;Hello world\n&quot;);
1548             r.add(fileWithSpaceInName);
1549             var hash1 = r.commit(&quot;Added file with space in name&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1550             Files.writeString(fileWithSpaceInName, &quot;Goodbye world\n&quot;);
1551             r.add(fileWithSpaceInName);
1552             var hash2 = r.commit(&quot;Modified file with space in name&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1553             var diff = r.diff(hash1, hash2);
1554             var patches = diff.patches();
1555             assertEquals(1, patches.size());
1556             var patch = patches.get(0);
1557             assertTrue(patch.target().path().isPresent());
1558             var path = patch.target().path().get();
1559             assertEquals(Path.of(&quot;hello world.txt&quot;), path);
1560         }
1561     }
1562 
1563     @Test
1564     void testSingleEmptyCommit() throws IOException, InterruptedException {
1565         try (var dir = new TemporaryDirectory()) {
1566             var r = Repository.init(dir.path(), VCS.GIT);
1567             assertTrue(r.isClean());
1568 
1569             // must ust git directly to be able to pass --allow-empty
1570             var pb = new ProcessBuilder(&quot;git&quot;, &quot;commit&quot;, &quot;--message&quot;, &quot;An empty commit&quot;, &quot;--allow-empty&quot;);
1571             pb.environment().put(&quot;GIT_AUTHOR_NAME&quot;, &quot;duke&quot;);
1572             pb.environment().put(&quot;GIT_AUTHOR_EMAIL&quot;, &quot;duke@openjdk.org&quot;);
1573             pb.environment().put(&quot;GIT_COMMITTER_NAME&quot;, &quot;duke&quot;);
1574             pb.environment().put(&quot;GIT_COMMITTER_EMAIL&quot;, &quot;duke@openjdk.org&quot;);
1575             pb.directory(dir.path().toFile());
1576 
1577             var res = pb.start().waitFor();
1578             assertEquals(0, res);
1579 
1580             var commits = r.commits().asList();
1581             assertEquals(1, commits.size());
1582             var commit = commits.get(0);
1583             assertEquals(&quot;duke&quot;, commit.author().name());
1584             assertEquals(&quot;duke@openjdk.org&quot;, commit.author().email());
1585             assertEquals(&quot;duke&quot;, commit.committer().name());
1586             assertEquals(&quot;duke@openjdk.org&quot;, commit.committer().email());
1587             assertEquals(List.of(&quot;An empty commit&quot;), commit.message());
1588         }
1589     }
1590 
1591     @Test
1592     void testEmptyCommitWithParent() throws IOException, InterruptedException {
1593         try (var dir = new TemporaryDirectory()) {
1594             var r = Repository.init(dir.path(), VCS.GIT);
1595             assertTrue(r.isClean());
1596 
1597             var f = Files.createFile(dir.path().resolve(&quot;hello.txt&quot;));
1598             Files.writeString(f, &quot;Hello world\n&quot;);
1599             r.add(f);
1600             r.commit(&quot;Initial commit&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
1601 
1602             // must ust git directly to be able to pass --allow-empty
1603             var pb = new ProcessBuilder(&quot;git&quot;, &quot;commit&quot;, &quot;--message&quot;, &quot;An empty commit&quot;, &quot;--allow-empty&quot;);
1604             pb.environment().put(&quot;GIT_AUTHOR_NAME&quot;, &quot;duke&quot;);
1605             pb.environment().put(&quot;GIT_AUTHOR_EMAIL&quot;, &quot;duke@openjdk.org&quot;);
1606             pb.environment().put(&quot;GIT_COMMITTER_NAME&quot;, &quot;duke&quot;);
1607             pb.environment().put(&quot;GIT_COMMITTER_EMAIL&quot;, &quot;duke@openjdk.org&quot;);
1608             pb.directory(dir.path().toFile());
1609 
1610             var res = pb.start().waitFor();
1611             assertEquals(0, res);
1612 
1613             var commits = r.commits().asList();
1614             assertEquals(2, commits.size());
1615             var commit = commits.get(0);
1616             assertEquals(&quot;duke&quot;, commit.author().name());
1617             assertEquals(&quot;duke@openjdk.org&quot;, commit.author().email());
1618             assertEquals(&quot;duke&quot;, commit.committer().name());
1619             assertEquals(&quot;duke@openjdk.org&quot;, commit.committer().email());
1620             assertEquals(List.of(&quot;An empty commit&quot;), commit.message());
1621         }
1622     }
1623 
1624     @ParameterizedTest
1625     @EnumSource(VCS.class)
1626     void testAmend(VCS vcs) throws IOException {
1627         try (var dir = new TemporaryDirectory()) {
1628             var r = Repository.init(dir.path(), vcs);
1629             assertTrue(r.isClean());
1630 
1631             var f = dir.path().resolve(&quot;README&quot;);
1632             Files.writeString(f, &quot;Hello\n&quot;);
1633             r.add(f);
1634             r.commit(&quot;Initial commit&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
1635 
1636             Files.writeString(f, &quot;Hello, world\n&quot;);
1637             r.add(f);
1638             r.amend(&quot;Initial commit corrected&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1639             var commits = r.commits().asList();
1640             assertEquals(1, commits.size());
1641             var commit = commits.get(0);
1642             assertEquals(List.of(&quot;Initial commit corrected&quot;), commit.message());
1643         }
1644     }
1645 
1646     @ParameterizedTest
1647     @EnumSource(VCS.class)
1648     void testRevert(VCS vcs) throws IOException {
1649         try (var dir = new TemporaryDirectory()) {
1650             var r = Repository.init(dir.path(), vcs);
1651             assertTrue(r.isClean());
1652 
1653             var f = dir.path().resolve(&quot;README&quot;);
1654             Files.writeString(f, &quot;Hello\n&quot;);
1655             r.add(f);
1656             var initial = r.commit(&quot;Initial commit&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
1657 
1658             Files.writeString(f, &quot;Hello, world\n&quot;);
1659             r.revert(initial);
1660             Files.writeString(f, &quot;Goodbye, world\n&quot;);
1661             r.add(f);
1662             var hash = r.commit(&quot;Second commit&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
1663             var commit = r.lookup(hash).orElseThrow();
1664             var patches = commit.parentDiffs().get(0).patches();
1665             assertEquals(1, patches.size());
1666             var patch = patches.get(0).asTextualPatch();
1667             assertEquals(1, patch.hunks().size());
1668             var hunk = patch.hunks().get(0);
1669             assertEquals(List.of(&quot;Goodbye, world&quot;), hunk.target().lines());
1670         }
1671     }
1672 
1673     @ParameterizedTest
1674     @EnumSource(VCS.class)
1675     void testFiles(VCS vcs) throws IOException {
1676         try (var dir = new TemporaryDirectory()) {
1677             var r = Repository.init(dir.path(), vcs);
1678             assertTrue(r.isClean());
1679 
1680             var f = dir.path().resolve(&quot;README&quot;);
1681             Files.writeString(f, &quot;Hello\n&quot;);
1682             r.add(f);
1683             var initial = r.commit(&quot;Initial commit&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
1684 
1685             var entries = r.files(initial);
1686             assertEquals(1, entries.size());
1687             var entry = entries.get(0);
1688             assertEquals(Path.of(&quot;README&quot;), entry.path());
1689             assertTrue(entry.type().isRegularNonExecutable());
1690 
1691             var f2 = dir.path().resolve(&quot;CONTRIBUTING&quot;);
1692             Files.writeString(f2, &quot;Hello\n&quot;);
1693             r.add(f2);
1694             var second = r.commit(&quot;Second commit&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
1695 
1696             entries = r.files(second);
1697             assertEquals(2, entries.size());
1698             assertTrue(entries.stream().allMatch(e -&gt; e.type().isRegularNonExecutable()));
1699             var paths = entries.stream().map(FileEntry::path).collect(Collectors.toSet());
1700             assertTrue(paths.contains(Path.of(&quot;README&quot;)));
1701             assertTrue(paths.contains(Path.of(&quot;CONTRIBUTING&quot;)));
1702 
1703             entries = r.files(second, Path.of(&quot;README&quot;));
1704             assertEquals(1, entries.size());
1705             entry = entries.get(0);
1706             assertEquals(Path.of(&quot;README&quot;), entry.path());
1707             assertTrue(entry.type().isRegularNonExecutable());
1708         }
1709     }
1710 
1711     @ParameterizedTest
1712     @EnumSource(VCS.class)
1713     void testDump(VCS vcs) throws IOException {
1714         try (var dir = new TemporaryDirectory()) {
1715             var r = Repository.init(dir.path(), vcs);
1716             assertTrue(r.isClean());
1717 
1718             var f = dir.path().resolve(&quot;README&quot;);
1719             Files.writeString(f, &quot;Hello\n&quot;);
1720             r.add(f);
1721             var initial = r.commit(&quot;Initial commit&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
1722 
1723             var readme = r.files(initial).get(0);
1724 
1725             var tmp = Files.createTempFile(&quot;README&quot;, &quot;txt&quot;);
1726             r.dump(readme, tmp);
1727             assertEquals(&quot;Hello\n&quot;, Files.readString(tmp));
1728             Files.delete(tmp);
1729         }
1730     }
1731 
1732     @ParameterizedTest
1733     @EnumSource(VCS.class)
1734     void testStatus(VCS vcs) throws IOException {
1735         try (var dir = new TemporaryDirectory()) {
1736             var r = Repository.init(dir.path(), vcs);
1737             assertTrue(r.isClean());
1738 
1739             var f = dir.path().resolve(&quot;README&quot;);
1740             Files.writeString(f, &quot;Hello\n&quot;);
1741             r.add(f);
1742             var initial = r.commit(&quot;Initial commit&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
1743 
1744             var f2 = dir.path().resolve(&quot;CONTRIBUTING&quot;);
1745             Files.writeString(f2, &quot;Goodbye\n&quot;);
1746             r.add(f2);
1747             var second = r.commit(&quot;Second commit&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
1748 
1749             var entries = r.status(initial, second);
1750             assertEquals(1, entries.size());
1751             var entry = entries.get(0);
1752             assertTrue(entry.status().isAdded());
1753             assertTrue(entry.source().path().isEmpty());
1754             assertTrue(entry.source().type().isEmpty());
1755 
1756             assertTrue(entry.target().path().isPresent());
1757             assertEquals(Path.of(&quot;CONTRIBUTING&quot;), entry.target().path().get());
1758             assertTrue(entry.target().type().get().isRegular());
1759         }
1760     }
1761 
1762     @ParameterizedTest
1763     @EnumSource(VCS.class)
1764     void testTrackLineEndings(VCS vcs) throws IOException, InterruptedException {
1765         try (var dir = new TemporaryDirectory()) {
1766             var r = Repository.init(dir.path(), vcs);
1767             if (vcs == VCS.GIT) { // turn of git&#39;s meddling
1768                 int exitCode = new ProcessBuilder()
1769                         .command(&quot;git&quot;, &quot;config&quot;, &quot;--local&quot;, &quot;core.autocrlf&quot;, &quot;false&quot;)
1770                         .directory(dir.path().toFile())
1771                         .start()
1772                         .waitFor();
1773                 assertEquals(0, exitCode);
1774             }
1775 
1776             var readme = dir.path().resolve(&quot;README&quot;);
1777             Files.writeString(readme, &quot;Line with Unix line ending\n&quot;);
1778             Files.writeString(readme, &quot;Line with Windows line ending\r\n&quot;, APPEND);
1779 
1780             r.add(readme);
1781             r.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
1782 
1783             var commits = r.commits().asList();
1784             assertEquals(1, commits.size());
1785 
1786             var commit = commits.get(0);
1787             var diffs = commit.parentDiffs();
1788             var diff = diffs.get(0);
1789             assertEquals(2, diff.added());
1790 
1791             var patches = diff.patches();
1792             assertEquals(1, patches.size());
1793 
1794             var patch = patches.get(0).asTextualPatch();
1795             var hunks = patch.hunks();
1796             assertEquals(1, hunks.size());
1797 
1798             var hunk = hunks.get(0);
1799             assertEquals(new Range(0, 0), hunk.source().range());
1800             assertEquals(new Range(1, 2), hunk.target().range());
1801 
1802             assertEquals(
1803                     List.of(&quot;Line with Unix line ending&quot;, &quot;Line with Windows line ending\r&quot;),
1804                     hunk.target().lines());
1805         }
1806     }
1807 
1808     @ParameterizedTest
1809     @EnumSource(VCS.class)
1810     void testContains(VCS vcs) throws IOException {
1811         try (var dir = new TemporaryDirectory()) {
1812             var r = Repository.init(dir.path(), vcs);
1813             assertTrue(r.isClean());
1814 
1815             var f = dir.path().resolve(&quot;README&quot;);
1816             Files.writeString(f, &quot;Hello\n&quot;);
1817             r.add(f);
1818             var initial = r.commit(&quot;Initial commit&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
1819 
1820             assertTrue(r.contains(r.defaultBranch(), initial));
1821 
1822             Files.writeString(f, &quot;Hello again\n&quot;);
1823             r.add(f);
1824             var second = r.commit(&quot;Second commit&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
1825 
1826             assertTrue(r.contains(r.defaultBranch(), initial));
1827         }
1828     }
1829 
1830     @ParameterizedTest
1831     @EnumSource(VCS.class)
1832     void testAbortMerge(VCS vcs) throws IOException {
1833         try (var dir = new TemporaryDirectory()) {
1834             var r = Repository.init(dir.path(), vcs);
1835             assertTrue(r.isClean());
1836 
1837             var f = dir.path().resolve(&quot;README&quot;);
1838             Files.writeString(f, &quot;Hello\n&quot;);
1839             r.add(f);
1840             var initial = r.commit(&quot;Initial commit&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
1841 
1842             Files.writeString(f, &quot;Hello again\n&quot;);
1843             r.add(f);
1844             var second = r.commit(&quot;Second commit&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
1845 
1846             r.checkout(initial);
1847             Files.writeString(f, &quot;Conflicting hello\n&quot;);
1848             r.add(f);
1849             var third = r.commit(&quot;Third commit&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
1850 
1851             assertThrows(IOException.class, () -&gt; { r.merge(second); });
1852 
1853             r.abortMerge();
1854             assertTrue(r.isClean());
1855         }
1856     }
1857 
1858     @ParameterizedTest
1859     @EnumSource(VCS.class)
1860     void testReset(VCS vcs) throws IOException {
1861         assumeTrue(vcs == VCS.GIT); // FIXME reset is not yet implemented for HG
1862 
1863         try (var dir = new TemporaryDirectory()) {
1864             var repo = Repository.init(dir.path(), vcs);
1865             assertTrue(repo.isClean());
1866 
1867             var f = dir.path().resolve(&quot;README&quot;);
1868             Files.writeString(f, &quot;Hello\n&quot;);
1869             repo.add(f);
1870             var initial = repo.commit(&quot;Initial commit&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
1871 
1872             Files.writeString(f, &quot;Hello again\n&quot;);
1873             repo.add(f);
1874             var second = repo.commit(&quot;Second commit&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
1875 
1876             assertEquals(second, repo.head());
1877             assertEquals(2, repo.commits().asList().size());
1878 
1879             repo.reset(initial, true);
1880 
1881             assertEquals(initial, repo.head());
1882             assertEquals(1, repo.commits().asList().size());
1883         }
1884     }
1885 
1886     @ParameterizedTest
1887     @EnumSource(VCS.class)
1888     void testRemotes(VCS vcs) throws IOException {
1889         try (var dir = new TemporaryDirectory()) {
1890             var repo = Repository.init(dir.path(), vcs);
1891             assertEquals(List.of(), repo.remotes());
1892             repo.addRemote(&quot;foobar&quot;, &quot;https://foo/bar&quot;);
1893             assertEquals(List.of(&quot;foobar&quot;), repo.remotes());
1894         }
1895     }
1896 
1897     @ParameterizedTest
1898     @EnumSource(VCS.class)
1899     void testRemoteBranches(VCS vcs) throws IOException {
1900         try (var dir = new TemporaryDirectory()) {
1901             var upstream = Repository.init(dir.path().resolve(&quot;upstream&quot;), vcs);
1902             var readme = upstream.root().resolve(&quot;README&quot;);
1903             Files.writeString(readme, &quot;Hello\n&quot;);
1904             upstream.add(readme);
1905             var head = upstream.commit(&quot;Added README&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
1906 
1907             var fork = Repository.init(dir.path().resolve(&quot;fork&quot;), vcs);
1908             fork.addRemote(&quot;upstream&quot;, upstream.root().toUri().toString());
1909             var refs = fork.remoteBranches(&quot;upstream&quot;);
1910             assertEquals(1, refs.size());
1911             var ref = refs.get(0);
1912             assertEquals(head, ref.hash());
1913             assertEquals(upstream.defaultBranch().name(), ref.name());
1914         }
1915     }
1916 
1917     @ParameterizedTest
1918     @EnumSource(VCS.class)
1919     void testSubmodulesOnEmptyRepo(VCS vcs) throws IOException {
1920         try (var dir = new TemporaryDirectory()) {
1921             var repo = Repository.init(dir.path(), vcs);
1922             assertEquals(List.of(), repo.submodules());
1923         }
1924     }
1925 
1926     @ParameterizedTest
1927     @EnumSource(VCS.class)
1928     void testSubmodulesOnRepoWithNoSubmodules(VCS vcs) throws IOException {
1929         try (var dir = new TemporaryDirectory()) {
1930             var repo = Repository.init(dir.path().resolve(&quot;repo&quot;), vcs);
1931             var readme = repo.root().resolve(&quot;README&quot;);
1932             Files.writeString(readme, &quot;Hello\n&quot;);
1933             repo.add(readme);
1934             repo.commit(&quot;Added README&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
1935             assertEquals(List.of(), repo.submodules());
1936         }
1937     }
1938 
1939     @ParameterizedTest
1940     @EnumSource(VCS.class)
1941     void testSubmodulesOnRepoWithSubmodule(VCS vcs) throws IOException {
1942         try (var dir = new TemporaryDirectory()) {
1943             var submodule = Repository.init(dir.path().resolve(&quot;submodule&quot;), vcs);
1944             var readme = submodule.root().resolve(&quot;README&quot;);
1945             Files.writeString(readme, &quot;Hello\n&quot;);
1946             submodule.add(readme);
1947             var head = submodule.commit(&quot;Added README&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
1948 
1949             var repo = Repository.init(dir.path().resolve(&quot;repo&quot;), vcs);
1950             var pullPath = submodule.root().toAbsolutePath().toString();
1951             repo.addSubmodule(pullPath, Path.of(&quot;sub&quot;));
1952             repo.commit(&quot;Added submodule&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
1953 
1954             var submodules = repo.submodules();
1955             assertEquals(1, submodules.size());
1956             var module = submodules.get(0);
1957             assertEquals(Path.of(&quot;sub&quot;), module.path());
1958             assertEquals(head, module.hash());
1959             assertEquals(pullPath, module.pullPath());
1960         }
1961     }
1962 
1963     @ParameterizedTest
1964     @EnumSource(VCS.class)
1965     void testAnnotateTag(VCS vcs) throws IOException {
1966         try (var dir = new TemporaryDirectory()) {
1967             var repo = Repository.init(dir.path(), vcs);
1968             var readme = repo.root().resolve(&quot;README&quot;);
1969             var now = ZonedDateTime.now();
1970             Files.writeString(readme, &quot;Hello\n&quot;);
1971             repo.add(readme);
1972             var head = repo.commit(&quot;Added README&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
1973             var tag = repo.tag(head, &quot;1.0&quot;, &quot;Added tag 1.0 for HEAD\n&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
1974             var annotated = repo.annotate(tag).get();
1975 
1976             assertEquals(&quot;1.0&quot;, annotated.name());
1977             assertEquals(head, annotated.target());
1978             assertEquals(new Author(&quot;duke&quot;, &quot;duke@openjdk.org&quot;), annotated.author());
1979             assertEquals(now.getYear(), annotated.date().getYear());
1980             assertEquals(now.getMonth(), annotated.date().getMonth());
1981             assertEquals(now.getDayOfYear(), annotated.date().getDayOfYear());
1982             assertEquals(now.getHour(), annotated.date().getHour());
1983             assertEquals(now.getOffset(), annotated.date().getOffset());
1984             assertEquals(&quot;Added tag 1.0 for HEAD\n&quot;, annotated.message());
1985         }
1986     }
1987 
1988     @ParameterizedTest
1989     @EnumSource(VCS.class)
1990     void testAnnotateTagOnMissingTag(VCS vcs) throws IOException {
1991         try (var dir = new TemporaryDirectory()) {
1992             var repo = Repository.init(dir.path(), vcs);
1993             var readme = repo.root().resolve(&quot;README&quot;);
1994             var now = ZonedDateTime.now();
1995             Files.writeString(readme, &quot;Hello\n&quot;);
1996             repo.add(readme);
1997             var head = repo.commit(&quot;Added README&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
1998 
1999             assertEquals(Optional.empty(), repo.annotate(new Tag(&quot;unknown&quot;)));
2000         }
2001     }
2002 
2003     @ParameterizedTest
2004     @EnumSource(VCS.class)
2005     void testAnnotateTagOnEmptyRepo(VCS vcs) throws IOException {
2006         try (var dir = new TemporaryDirectory()) {
2007             var repo = Repository.init(dir.path(), vcs);
2008             assertEquals(Optional.empty(), repo.annotate(new Tag(&quot;unknown&quot;)));
2009         }
2010     }
2011 
2012     @ParameterizedTest
2013     @EnumSource(VCS.class)
2014     void testDiffWithFileList(VCS vcs) throws IOException {
2015         try (var dir = new TemporaryDirectory()) {
2016             var repo = Repository.init(dir.path(), vcs);
2017             var readme = repo.root().resolve(&quot;README&quot;);
2018             Files.writeString(readme, &quot;Hello\n&quot;);
2019             repo.add(readme);
2020 
2021             var contribute = repo.root().resolve(&quot;CONTRIBUTE&quot;);
2022             Files.writeString(contribute, &quot;1. Make changes\n&quot;);
2023             repo.add(contribute);
2024 
2025             var first = repo.commit(&quot;Added README and CONTRIBUTE&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
2026             Files.writeString(readme, &quot;World\n&quot;, WRITE, APPEND);
2027             Files.writeString(contribute, &quot;2. Run git commit&quot;, WRITE, APPEND);
2028 
2029             var diff = repo.diff(first, List.of(Path.of(&quot;README&quot;)));
2030             assertEquals(1, diff.added());
2031             assertEquals(0, diff.modified());
2032             assertEquals(0, diff.removed());
2033             var patches = diff.patches();
2034             assertEquals(1, patches.size());
2035             var patch = patches.get(0);
2036             assertTrue(patch.isTextual());
2037             assertTrue(patch.status().isModified());
2038             assertEquals(Path.of(&quot;README&quot;), patch.source().path().get());
2039             assertEquals(Path.of(&quot;README&quot;), patch.target().path().get());
2040 
2041             repo.add(readme);
2042             repo.add(contribute);
2043             var second = repo.commit(&quot;Updates to both README and CONTRIBUTE&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
2044 
2045             diff = repo.diff(first, second, List.of(Path.of(&quot;CONTRIBUTE&quot;)));
2046             assertEquals(1, diff.added());
2047             assertEquals(0, diff.modified());
2048             assertEquals(0, diff.removed());
2049             patches = diff.patches();
2050             assertEquals(1, patches.size());
2051             patch = patches.get(0);
2052             assertTrue(patch.isTextual());
2053             assertTrue(patch.status().isModified());
2054             assertEquals(Path.of(&quot;CONTRIBUTE&quot;), patch.source().path().get());
2055             assertEquals(Path.of(&quot;CONTRIBUTE&quot;), patch.target().path().get());
2056 
2057             diff = repo.diff(first, second, List.of(Path.of(&quot;DOES_NOT_EXIST&quot;)));
2058             assertEquals(0, diff.patches().size());
2059         }
2060     }
2061 
2062     @ParameterizedTest
2063     @EnumSource(VCS.class)
2064     void testWritingConfigValue(VCS vcs) throws IOException {
2065         try (var dir = new TemporaryDirectory()) {
2066             var repo = Repository.init(dir.path(), vcs);
2067             assertEquals(List.of(), repo.config(&quot;test.key&quot;));
2068             repo.config(&quot;test&quot;, &quot;key&quot;, &quot;value&quot;);
2069             assertEquals(List.of(&quot;value&quot;), repo.config(&quot;test.key&quot;));
2070         }
2071     }
2072 
2073     @ParameterizedTest
2074     @EnumSource(VCS.class)
2075     void testFetchRemote(VCS vcs) throws IOException {
2076         try (var dir = new TemporaryDirectory()) {
2077             var upstream = Repository.init(dir.path(), vcs);
2078             var readme = dir.path().resolve(&quot;README&quot;);
2079             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
2080 
2081             upstream.add(readme);
2082             upstream.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
2083 
2084             try (var dir2 = new TemporaryDirectory()) {
2085                 var downstream = Repository.init(dir2.path(), vcs);
2086 
2087                  // note: forcing unix path separators for URI
2088                 var upstreamURI = URI.create(&quot;file:///&quot; + dir.toString().replace(&#39;\\&#39;, &#39;/&#39;));
2089                 downstream.addRemote(&quot;upstream&quot;, upstreamURI.toString());
2090                 downstream.addRemote(&quot;foobar&quot;, &quot;file:///this/path/does/not/exist&quot;);
2091                 downstream.fetchRemote(&quot;upstream&quot;);
2092             }
2093         }
2094     }
2095 
2096     @ParameterizedTest
2097     @EnumSource(VCS.class)
2098     void testPrune(VCS vcs) throws IOException {
2099         assumeTrue(vcs == VCS.GIT); // FIXME hard to test with hg due to bookmarks and branches
2100         try (var dir = new TemporaryDirectory(false)) {
2101             var upstreamDir = dir.path().resolve(&quot;upstream&quot; + (vcs == VCS.GIT ? &quot;.git&quot; : &quot;.hg&quot;));
2102             var upstream = Repository.init(upstreamDir, vcs);
2103 
2104             Files.write(upstream.root().resolve(&quot;.git&quot;).resolve(&quot;config&quot;),
2105                         List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch=ignore&quot;),
2106                         WRITE, APPEND);
2107 
2108             var readme = upstreamDir.resolve(&quot;README&quot;);
2109             Files.write(readme, List.of(&quot;Hello, readme!&quot;));
2110 
2111             upstream.add(readme);
2112             var head = upstream.commit(&quot;Add README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
2113             var branch = upstream.branch(head, &quot;foo&quot;);
2114             var upstreamBranches = upstream.branches();
2115             assertEquals(2, upstreamBranches.size());
2116             assertTrue(upstreamBranches.contains(branch));
2117 
2118             var upstreamURI = URI.create(&quot;file:///&quot; + upstreamDir.toString().replace(&#39;\\&#39;, &#39;/&#39;));
2119             var downstreamDir = dir.path().resolve(&quot;downstream&quot;);
2120             var downstream = Repository.clone(upstreamURI, downstreamDir);
2121 
2122             // Ensure that &#39;foo&#39; branch is materialized downstream
2123             downstream.checkout(branch);
2124             downstream.checkout(downstream.defaultBranch());
2125 
2126             var remotes = downstream.remotes();
2127             assertEquals(1, remotes.size());
2128             var downstreamBranches = downstream.branches();
2129             assertEquals(2, downstreamBranches.size());
2130             assertEquals(downstreamBranches, upstreamBranches);
2131 
2132             downstream.prune(branch, remotes.get(0));
2133 
2134             downstreamBranches = downstream.branches();
2135             assertEquals(1, downstreamBranches.size());
2136             assertEquals(List.of(downstream.defaultBranch()), downstreamBranches);
2137 
2138             upstreamBranches = upstream.branches();
2139             assertEquals(1, upstreamBranches.size());
2140             assertEquals(List.of(upstream.defaultBranch()), upstreamBranches);
2141         }
2142     }
2143 
2144     @ParameterizedTest
2145     @EnumSource(VCS.class)
2146     void testUnmergedStatus(VCS vcs) throws IOException {
2147         assumeTrue(vcs == VCS.GIT);
2148         try (var dir = new TemporaryDirectory(false)) {
2149             var r = Repository.init(dir.path(), vcs);
2150 
2151             var readme = dir.path().resolve(&quot;README&quot;);
2152             Files.write(readme, List.of(&quot;Hello, world!&quot;));
2153             r.add(readme);
2154             var first = r.commit(&quot;Added README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
2155 
2156             Files.write(readme, List.of(&quot;One more line&quot;), WRITE, APPEND);
2157             r.add(readme);
2158             var second = r.commit(&quot;Modified README&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
2159 
2160             r.checkout(first, false);
2161 
2162             Files.write(readme, List.of(&quot;Another line&quot;), WRITE, APPEND);
2163             r.add(readme);
2164             var third = r.commit(&quot;Modified README again&quot;, &quot;duke&quot;, &quot;duke@openjdk.java.net&quot;);
2165 
2166             assertThrows(IOException.class, () -&gt; { r.merge(second); });
2167 
2168             var status = r.status();
2169             for (var s : status) {
2170                 System.out.println(s.status() + &quot; &quot; + s.source().path().get());
2171             }
2172             assertEquals(2, status.size());
2173             var statusEntry = status.get(0);
2174             assertTrue(statusEntry.status().isUnmerged());
2175             assertEquals(Path.of(&quot;README&quot;), statusEntry.source().path().get());
2176             assertEquals(Optional.empty(), statusEntry.source().type());
2177             assertEquals(&quot;0&quot;.repeat(40), statusEntry.source().hash().hex());
2178         }
2179     }
2180 }
    </pre>
  </body>
</html>