<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Old vcs/src/main/java/org/openjdk/skara/vcs/git/GitRepository.java</title>
    <link rel="stylesheet" href="../../../../../../../../../style.css" />
  </head>
  <body>
    <pre>
   1 /*
   2  * Copyright (c) 2018, 2019, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  */
  23 package org.openjdk.skara.vcs.git;
  24 
  25 import org.openjdk.skara.process.*;
  26 import org.openjdk.skara.process.Process;
  27 import org.openjdk.skara.vcs.*;
  28 import org.openjdk.skara.vcs.tools.*;
  29 
  30 import java.io.*;
  31 import java.net.URI;
  32 import java.nio.file.*;
  33 import java.nio.charset.StandardCharsets;
  34 import java.time.*;
  35 import java.time.format.DateTimeFormatter;
  36 import java.util.*;
  37 import java.util.logging.Logger;
  38 import java.util.stream.Collectors;
  39 
  40 public class GitRepository implements Repository {
  41     private final Path dir;
  42     private final Logger log = Logger.getLogger(&quot;org.openjdk.skara.vcs.git&quot;);
  43     private Path cachedRoot = null;
  44 
  45     private java.lang.Process start(String... cmd) throws IOException {
  46         return start(Arrays.asList(cmd));
  47     }
  48 
  49     private java.lang.Process start(List&lt;String&gt; cmd) throws IOException {
  50         log.fine(&quot;Executing &quot; + String.join(&quot; &quot;, cmd));
  51         var pb = new ProcessBuilder(cmd);
  52         pb.directory(dir.toFile());
  53         pb.redirectError(ProcessBuilder.Redirect.DISCARD);
  54         return pb.start();
  55     }
  56 
  57     private static void stop(java.lang.Process p) throws IOException {
  58         if (p != null &amp;&amp; p.isAlive()) {
  59             var stream = p.getInputStream();
  60             var read = 0;
  61             var buf = new byte[128];
  62             while (read != -1) {
  63                 read = stream.read(buf);
  64             }
  65             try {
  66                 p.waitFor();
  67             } catch (InterruptedException e) {
  68                 throw new IOException(e);
  69             }
  70         }
  71     }
  72 
  73     private Execution capture(List&lt;String&gt; cmd) {
  74         return capture(cmd.toArray(new String[0]));
  75     }
  76 
  77     private Execution capture(String... cmd) {
  78         return capture(dir, cmd);
  79     }
  80 
  81     private static Execution capture(Path cwd, String... cmd) {
  82         return Process.capture(cmd)
  83                       .workdir(cwd)
  84                       .execute();
  85     }
  86 
  87     private static Execution capture(Path cwd, List&lt;String&gt; cmd) {
  88         return capture(cwd, cmd.toArray(new String[0]));
  89     }
  90 
  91     private static Execution.Result await(Execution e) throws IOException {
  92         var result = e.await();
  93         if (result.status() != 0) {
  94             throw new IOException(&quot;Unexpected exit code\n&quot; + result);
  95         }
  96         return result;
  97     }
  98 
  99     private static void await(java.lang.Process p) throws IOException {
 100         try {
 101             var res = p.waitFor();
 102             if (res != 0) {
 103                 throw new IOException(&quot;Unexpected exit code: &quot; + res);
 104             }
 105         } catch (InterruptedException e) {
 106             throw new IOException(e);
 107         }
 108     }
 109 
 110     public GitRepository(Path dir) {
 111         this.dir = dir.toAbsolutePath();
 112     }
 113 
 114     public List&lt;Branch&gt; branches() throws IOException {
 115         try (var p = capture(&quot;git&quot;, &quot;for-each-ref&quot;, &quot;--format=%(refname:short)&quot;, &quot;refs/heads&quot;)) {
 116             return await(p).stdout()
 117                            .stream()
 118                            .map(Branch::new)
 119                            .collect(Collectors.toList());
 120         }
 121     }
 122 
 123     public List&lt;Branch&gt; branches(String remote) throws IOException {
 124         try (var p = capture(&quot;git&quot;, &quot;for-each-ref&quot;, &quot;--format=%(refname:short)&quot;, &quot;refs/remotes/&quot; + remote + &quot;/&quot;)) {
 125             return await(p).stdout()
 126                            .stream()
 127                            .map(Branch::new)
 128                            .collect(Collectors.toList());
 129         }
 130     }
 131 
 132     public List&lt;Tag&gt; tags() throws IOException {
 133         try (var p = capture(&quot;git&quot;, &quot;for-each-ref&quot;, &quot;--format=%(refname:short)&quot;, &quot;refs/tags&quot;)) {
 134             return await(p).stdout()
 135                            .stream()
 136                            .map(Tag::new)
 137                            .collect(Collectors.toList());
 138         }
 139     }
 140 
 141     @Override
 142     public Commits commits() throws IOException {
 143         return new GitCommits(dir, &quot;--all&quot;, false, -1);
 144     }
 145 
 146     @Override
 147     public Commits commits(int n) throws IOException {
 148         return new GitCommits(dir, &quot;--all&quot;, false, n);
 149     }
 150 
 151     @Override
 152     public Commits commits(boolean reverse) throws IOException {
 153         return new GitCommits(dir, &quot;--all&quot;, reverse, -1);
 154     }
 155 
 156     @Override
 157     public Commits commits(int n, boolean reverse) throws IOException {
 158         return new GitCommits(dir, &quot;--all&quot;, reverse, n);
 159     }
 160 
 161     @Override
 162     public Commits commits(String range) throws IOException {
 163         return new GitCommits(dir, range, false, -1);
 164     }
 165 
 166     @Override
 167     public Commits commits(String range, int n) throws IOException {
 168         return new GitCommits(dir, range, false, n);
 169     }
 170 
 171     @Override
 172     public Commits commits(String range, boolean reverse) throws IOException {
 173         return new GitCommits(dir, range, reverse, -1);
 174     }
 175 
 176     @Override
 177     public Commits commits(String range, int n, boolean reverse) throws IOException {
 178         return new GitCommits(dir, range, reverse, n);
 179     }
 180 
 181     @Override
 182     public Optional&lt;Commit&gt; lookup(Hash h) throws IOException {
 183         var commits = commits(h.hex(), 1).asList();
 184         if (commits.size() != 1) {
 185             return Optional.empty();
 186         }
 187         return Optional.of(commits.get(0));
 188     }
 189 
 190     @Override
 191     public Optional&lt;Commit&gt; lookup(Branch b) throws IOException {
 192         var hash = resolve(b.name()).orElseThrow(() -&gt; new IOException(&quot;Branch &quot; + b.name() + &quot; not found&quot;));
 193         return lookup(hash);
 194     }
 195 
 196     @Override
 197     public Optional&lt;Commit&gt; lookup(Tag t) throws IOException {
 198         var hash = resolve(t.name()).orElseThrow(() -&gt; new IOException(&quot;Tag &quot; + t.name() + &quot; not found&quot;));
 199         return lookup(hash);
 200     }
 201 
 202     @Override
 203     public List&lt;CommitMetadata&gt; commitMetadata(String range) throws IOException {
 204         var p = start(&quot;git&quot;, &quot;rev-list&quot;, &quot;--format=&quot; + GitCommitMetadata.FORMAT, &quot;--no-abbrev&quot;, &quot;--reverse&quot;, &quot;--no-color&quot;, range);
 205         var reader = new UnixStreamReader(p.getInputStream());
 206         var result = new ArrayList&lt;CommitMetadata&gt;();
 207 
 208         var line = reader.readLine();
 209         while (line != null) {
 210             if (!line.startsWith(&quot;commit&quot;)) {
 211                 throw new IOException(&quot;Unexpected line: &quot; + line);
 212             }
 213 
 214             result.add(GitCommitMetadata.read(reader));
 215             line = reader.readLine();
 216         }
 217 
 218         await(p);
 219         return result;
 220     }
 221 
 222     @Override
 223     public List&lt;CommitMetadata&gt; commitMetadata() throws IOException {
 224         return commitMetadata(&quot;--all&quot;);
 225     }
 226 
 227     private List&lt;Hash&gt; refs() throws IOException {
 228         try (var p = capture(&quot;git&quot;, &quot;show-ref&quot;, &quot;--hash&quot;, &quot;--abbrev&quot;)) {
 229             var res = p.await();
 230             if (res.status() == -1) {
 231                 if (res.stdout().size() != 0) {
 232                     throw new IOException(&quot;Unexpected output\n&quot; + res);
 233                 }
 234                 return new ArrayList&lt;&gt;();
 235             } else {
 236                 return res.stdout().stream()
 237                           .map(Hash::new)
 238                           .collect(Collectors.toList());
 239             }
 240         }
 241     }
 242 
 243     @Override
 244     public boolean isEmpty() throws IOException {
 245         int numLooseObjects = -1;
 246         int numPackedObjects = -1;
 247 
 248         try (var p = capture(&quot;git&quot;, &quot;count-objects&quot;, &quot;-v&quot;)) {
 249             var res = await(p);
 250             var stdout = res.stdout();
 251 
 252             for (var line : stdout) {
 253                 if (line.startsWith(&quot;count: &quot;)) {
 254                     try {
 255                         numLooseObjects = Integer.parseUnsignedInt(line.split(&quot; &quot;)[1]);
 256                     } catch (NumberFormatException e) {
 257                         throw new IOException(&quot;Unexpected &#39;count&#39; value\n&quot; + res, e);
 258                     }
 259 
 260                 } else if (line.startsWith(&quot;in-pack: &quot;)) {
 261                     try {
 262                         numPackedObjects = Integer.parseUnsignedInt(line.split(&quot; &quot;)[1]);
 263                     } catch (NumberFormatException e) {
 264                         throw new IOException(&quot;Unexpected &#39;in-pack&#39; value\n&quot; + res, e);
 265                     }
 266                 }
 267             }
 268         }
 269 
 270         return numLooseObjects == 0 &amp;&amp; numPackedObjects == 0 &amp;&amp; refs().size() == 0;
 271     }
 272 
 273     @Override
 274 
 275     public boolean isHealthy() throws IOException {
 276         try (var p = capture(&quot;git&quot;, &quot;fsck&quot;, &quot;--connectivity-only&quot;)) {
 277             if (p.await().status() != 0) {
 278                 return false;
 279             }
 280         }
 281         return true;
 282     }
 283 
 284     @Override
 285     public void clean() throws IOException {
 286         cachedRoot = null;
 287 
 288         try (var p = capture(&quot;git&quot;, &quot;clean&quot;, &quot;-x&quot;, &quot;-d&quot;, &quot;--force&quot;, &quot;--force&quot;)) {
 289             await(p);
 290         }
 291 
 292         try (var p = capture(&quot;git&quot;, &quot;reset&quot;, &quot;--hard&quot;)) {
 293             await(p);
 294         }
 295 
 296         try (var p = capture(&quot;git&quot;, &quot;rebase&quot;, &quot;--quit&quot;)) {
 297             p.await(); // Don&#39;t care about the result.
 298         }
 299     }
 300 
 301     @Override
 302     public void reset(Hash target, boolean hard) throws IOException {
 303         var cmd = new ArrayList&lt;&gt;(List.of(&quot;git&quot;, &quot;reset&quot;));
 304         if (hard) {
 305            cmd.add(&quot;--hard&quot;);
 306         }
 307         cmd.add(target.hex());
 308 
 309         try (var p = capture(cmd)) {
 310             await(p);
 311         }
 312     }
 313 
 314 
 315     @Override
 316     public void revert(Hash h) throws IOException {
 317         try (var p = capture(&quot;git&quot;, &quot;checkout&quot;, &quot;--recurse-submodules&quot;, h.hex(), &quot;--&quot;, &quot;.&quot;)) {
 318             await(p);
 319         }
 320     }
 321 
 322     @Override
 323     public Repository reinitialize() throws IOException {
 324         cachedRoot = null;
 325 
 326         Files.walk(dir)
 327              .map(Path::toFile)
 328              .sorted(Comparator.reverseOrder())
 329              .forEach(File::delete);
 330 
 331         return init();
 332     }
 333 
 334     @Override
 335     public Hash fetch(URI uri, String refspec) throws IOException {
 336         try (var p = capture(&quot;git&quot;, &quot;fetch&quot;, &quot;--recurse-submodules=on-demand&quot;, &quot;--tags&quot;, uri.toString(), refspec)) {
 337             await(p);
 338             return resolve(&quot;FETCH_HEAD&quot;).get();
 339         }
 340     }
 341 
 342     @Override
 343     public void fetchAll() throws IOException {
 344         try (var p = capture(&quot;git&quot;, &quot;fetch&quot;, &quot;--recurse-submodules=on-demand&quot;, &quot;--tags&quot;, &quot;--prune&quot;, &quot;--prune-tags&quot;, &quot;--all&quot;)) {
 345             await(p);
 346         }
 347     }
 348 
 349     @Override
 350     public void fetchRemote(String remote) throws IOException {
 351         try (var p = capture(&quot;git&quot;, &quot;fetch&quot;, &quot;--recurse-submodules=on-demand&quot;, &quot;--tags&quot;, &quot;--prune&quot;, &quot;--prune-tags&quot;, remote)) {
 352             await(p);
 353         }
 354     }
 355 
 356     private void checkout(String ref, boolean force) throws IOException {
 357         var cmd = new ArrayList&lt;String&gt;();
 358         cmd.addAll(List.of(&quot;git&quot;, &quot;-c&quot;, &quot;advice.detachedHead=false&quot;, &quot;checkout&quot;, &quot;--recurse-submodules&quot;));
 359         if (force) {
 360             cmd.add(&quot;--force&quot;);
 361         }
 362         cmd.add(ref);
 363         try (var p = capture(cmd)) {
 364             await(p);
 365         }
 366     }
 367 
 368     @Override
 369     public void checkout(Hash h, boolean force) throws IOException {
 370         checkout(h.hex(), force);
 371     }
 372 
 373     @Override
 374     public void checkout(Branch b, boolean force) throws IOException {
 375         checkout(b.name(), force);
 376     }
 377 
 378     @Override
 379     public Repository init() throws IOException {
 380         cachedRoot = null;
 381 
 382         if (!Files.exists(dir)) {
 383             Files.createDirectories(dir);
 384         }
 385 
 386         try (var p = capture(&quot;git&quot;, &quot;init&quot;)) {
 387             await(p);
 388             return this;
 389         }
 390     }
 391 
 392     @Override
 393     public void pushAll(URI uri) throws IOException {
 394         try (var p = capture(&quot;git&quot;, &quot;push&quot;, &quot;--mirror&quot;, uri.toString())) {
 395             await(p);
 396         }
 397     }
 398 
 399     @Override
 400     public void push(Hash hash, URI uri, String ref, boolean force) throws IOException {
 401         String refspec = force ? &quot;+&quot; : &quot;&quot;;
 402         if (!ref.startsWith(&quot;refs/&quot;)) {
 403             ref = &quot;refs/heads/&quot; + ref;
 404         }
 405         refspec += hash.hex() + &quot;:&quot; + ref;
 406 
 407         try (var p = capture(&quot;git&quot;, &quot;push&quot;, uri.toString(), refspec)) {
 408             await(p);
 409         }
 410     }
 411 
 412     @Override
 413     public void push(Branch branch, String remote, boolean setUpstream) throws IOException {
 414         var cmd = new ArrayList&lt;String&gt;();
 415         cmd.addAll(List.of(&quot;git&quot;, &quot;push&quot;, remote, branch.name()));
 416         if (setUpstream) {
 417             cmd.add(&quot;--set-upstream&quot;);
 418         }
 419 
 420         try (var p = capture(cmd)) {
 421             await(p);
 422         }
 423     }
 424 
 425     @Override
 426     public boolean isClean() throws IOException {
 427         try (var p = capture(&quot;git&quot;, &quot;status&quot;, &quot;--porcelain&quot;)) {
 428             var output = await(p);
 429             return output.stdout().size() == 0;
 430         }
 431     }
 432 
 433     @Override
 434     public boolean exists() throws IOException {
 435         if (!Files.exists(dir)) {
 436             return false;
 437         }
 438 
 439         try (var p = capture(&quot;git&quot;, &quot;rev-parse&quot;, &quot;--git-dir&quot;)) {
 440             return p.await().status() == 0;
 441         }
 442     }
 443 
 444     @Override
 445     public Path root() throws IOException {
 446         if (cachedRoot != null) {
 447             return cachedRoot;
 448         }
 449 
 450         try (var p = capture(&quot;git&quot;, &quot;rev-parse&quot;, &quot;--show-toplevel&quot;)) {
 451             var res = p.await();
 452             if (res.status() != 0 || res.stdout().size() != 1) {
 453                 // Perhaps this is a bare repository
 454                 try (var p2 = capture(&quot;git&quot;, &quot;rev-parse&quot;, &quot;--git-dir&quot;)) {
 455                     var res2 = await(p2);
 456                     if (res2.stdout().size() != 1) {
 457                         throw new IOException(&quot;Unexpected output\n&quot; + res2);
 458                     }
 459                     cachedRoot = dir.resolve(Path.of(res2.stdout().get(0)));
 460                     return cachedRoot;
 461                 }
 462             }
 463 
 464             cachedRoot = Path.of(res.stdout().get(0));
 465             return cachedRoot;
 466         }
 467     }
 468 
 469     @Override
 470     public void squash(Hash h) throws IOException {
 471         try (var p = capture(&quot;git&quot;, &quot;merge&quot;, &quot;--squash&quot;, h.hex())) {
 472             await(p);
 473         }
 474     }
 475 
 476     @FunctionalInterface
 477     private static interface Operation {
 478         void execute(List&lt;Path&gt; args) throws IOException;
 479     }
 480 
 481     private void batch(Operation op, List&lt;Path&gt; args) throws IOException {
 482         var batchSize = 64;
 483         var start = 0;
 484         while (start &lt; args.size()) {
 485             var end = start + batchSize;
 486             if (end &gt; args.size()) {
 487                 end = args.size();
 488             }
 489             op.execute(args.subList(start, end));
 490             start = end;
 491         }
 492     }
 493 
 494     private void addAll(List&lt;Path&gt; paths) throws IOException {
 495         var cmd = new ArrayList&lt;&gt;(List.of(&quot;git&quot;, &quot;add&quot;));
 496         for (var path : paths) {
 497             cmd.add(path.toString());
 498         }
 499         try (var p = capture(cmd)) {
 500             await(p);
 501         }
 502     }
 503 
 504     @Override
 505     public void add(List&lt;Path&gt; paths) throws IOException {
 506         batch(this::addAll, paths);
 507     }
 508 
 509     private void removeAll(List&lt;Path&gt; paths) throws IOException {
 510         var cmd = new ArrayList&lt;&gt;(List.of(&quot;git&quot;, &quot;rm&quot;));
 511         for (var path : paths) {
 512             cmd.add(path.toString());
 513         }
 514         try (var p = capture(cmd)) {
 515             await(p);
 516         }
 517     }
 518 
 519     @Override
 520     public void remove(List&lt;Path&gt; paths) throws IOException {
 521         batch(this::removeAll, paths);
 522     }
 523 
 524     @Override
 525     public void delete(Branch b) throws IOException {
 526         try (var p = capture(&quot;git&quot;, &quot;branch&quot;, &quot;-D&quot;, b.name())) {
 527             await(p);
 528         }
 529     }
 530 
 531     @Override
 532     public void addremove() throws IOException {
 533         try (var p = capture(&quot;git&quot;, &quot;add&quot;, &quot;--all&quot;)) {
 534             await(p);
 535         }
 536     }
 537 
 538     @Override
 539     public Hash commit(String message, String authorName, String authorEmail)  throws IOException {
 540         return commit(message, authorName, authorEmail, null);
 541     }
 542 
 543     @Override
 544     public Hash commit(String message, String authorName, String authorEmail, ZonedDateTime authorDate)  throws IOException {
 545         return commit(message, authorName, authorEmail, authorDate, authorName, authorEmail, authorDate);
 546     }
 547 
 548     @Override
 549     public Hash commit(String message,
 550                        String authorName,
 551                        String authorEmail,
 552                        String committerName,
 553                        String committerEmail) throws IOException {
 554         return commit(message, authorName, authorEmail, null, committerName, committerEmail, null);
 555     }
 556 
 557     @Override
 558     public Hash commit(String message,
 559                        String authorName,
 560                        String authorEmail,
 561                        ZonedDateTime authorDate,
 562                        String committerName,
 563                        String committerEmail,
 564                        ZonedDateTime committerDate) throws IOException {
 565         var cmd = Process.capture(&quot;git&quot;, &quot;commit&quot;, &quot;--message=&quot; + message)
 566                          .workdir(dir)
 567                          .environ(&quot;GIT_AUTHOR_NAME&quot;, authorName)
 568                          .environ(&quot;GIT_AUTHOR_EMAIL&quot;, authorEmail)
 569                          .environ(&quot;GIT_COMMITTER_NAME&quot;, committerName)
 570                          .environ(&quot;GIT_COMMITTER_EMAIL&quot;, committerEmail);
 571         if (authorDate != null) {
 572             cmd = cmd.environ(&quot;GIT_AUTHOR_DATE&quot;,
 573                               authorDate.format(DateTimeFormatter.ISO_OFFSET_DATE_TIME));
 574         }
 575         if (committerDate != null) {
 576             cmd = cmd.environ(&quot;GIT_COMMITTER_DATE&quot;,
 577                               committerDate.format(DateTimeFormatter.ISO_OFFSET_DATE_TIME));
 578         }
 579         try (var p = cmd.execute()) {
 580             await(p);
 581             return head();
 582         }
 583     }
 584 
 585     @Override
 586     public Hash amend(String message, String authorName, String authorEmail) throws IOException {
 587         return amend(message, authorName, authorEmail, null, null);
 588     }
 589 
 590     @Override
 591     public Hash amend(String message, String authorName, String authorEmail, String committerName, String committerEmail) throws IOException {
 592         if (committerName == null) {
 593             committerName = authorName;
 594             committerEmail = authorEmail;
 595         }
 596         var cmd = Process.capture(&quot;git&quot;, &quot;commit&quot;, &quot;--amend&quot;, &quot;--reset-author&quot;, &quot;--message=&quot; + message)
 597                          .workdir(dir)
 598                          .environ(&quot;GIT_AUTHOR_NAME&quot;, authorName)
 599                          .environ(&quot;GIT_AUTHOR_EMAIL&quot;, authorEmail)
 600                          .environ(&quot;GIT_COMMITTER_NAME&quot;, committerName)
 601                          .environ(&quot;GIT_COMMITTER_EMAIL&quot;, committerEmail);
 602         try (var p = cmd.execute()) {
 603             await(p);
 604             return head();
 605         }
 606     }
 607 
 608     @Override
 609     public Tag tag(Hash hash, String name, String message, String authorName, String authorEmail) throws IOException {
 610         var cmd = Process.capture(&quot;git&quot;, &quot;tag&quot;, &quot;--annotate&quot;, &quot;--message=&quot; + message, name, hash.hex())
 611                          .workdir(dir)
 612                          .environ(&quot;GIT_AUTHOR_NAME&quot;, authorName)
 613                          .environ(&quot;GIT_AUTHOR_EMAIL&quot;, authorEmail)
 614                          .environ(&quot;GIT_COMMITTER_NAME&quot;, authorName)
 615                          .environ(&quot;GIT_COMMITTER_EMAIL&quot;, authorEmail);
 616         try (var p = cmd.execute()) {
 617             await(p);
 618         }
 619 
 620         return new Tag(name);
 621     }
 622 
 623     @Override
 624     public Branch branch(Hash hash, String name) throws IOException {
 625         try (var p = capture(&quot;git&quot;, &quot;branch&quot;, name, hash.hex())) {
 626             await(p);
 627         }
 628 
 629         return new Branch(name);
 630     }
 631 
 632     @Override
 633     public void prune(Branch branch, String remote) throws IOException {
 634         try (var p = capture(&quot;git&quot;, &quot;push&quot;, &quot;--delete&quot;, remote, branch.name())) {
 635             await(p);
 636         }
 637         try (var p = capture(&quot;git&quot;, &quot;branch&quot;, &quot;--delete&quot;, &quot;--force&quot;, branch.name())) {
 638             await(p);
 639         }
 640     }
 641 
 642     @Override
 643     public Hash mergeBase(Hash first, Hash second) throws IOException {
 644         try (var p = capture(&quot;git&quot;, &quot;merge-base&quot;, first.hex(), second.hex())) {
 645             var res = await(p);
 646             if (res.stdout().size() != 1) {
 647                  throw new IOException(&quot;Unexpected output\n&quot; + res);
 648             }
 649             return new Hash(res.stdout().get(0));
 650         }
 651     }
 652 
 653     @Override
 654     public boolean isAncestor(Hash ancestor, Hash descendant) throws IOException {
 655         try (var p = capture(&quot;git&quot;, &quot;merge-base&quot;, &quot;--is-ancestor&quot;, ancestor.hex(), descendant.hex())) {
 656             var res = p.await();
 657             return res.status() == 0;
 658         }
 659     }
 660 
 661     @Override
 662     public void rebase(Hash hash, String committerName, String committerEmail) throws IOException {
 663         try (var p = Process.capture(&quot;git&quot;, &quot;rebase&quot;, &quot;--onto&quot;, hash.hex(), &quot;--root&quot;, &quot;--rebase-merges&quot;)
 664                             .environ(&quot;GIT_COMMITTER_NAME&quot;, committerName)
 665                             .environ(&quot;GIT_COMMITTER_EMAIL&quot;, committerEmail)
 666                             .workdir(dir)
 667                             .execute()) {
 668             await(p);
 669         }
 670     }
 671 
 672     @Override
 673     public Optional&lt;Hash&gt; resolve(String ref) throws IOException {
 674         try (var p = capture(&quot;git&quot;, &quot;rev-parse&quot;, ref + &quot;^{commit}&quot;)) {
 675             var res = p.await();
 676             if (res.status() == 0 &amp;&amp; res.stdout().size() == 1) {
 677                 return Optional.of(new Hash(res.stdout().get(0)));
 678             }
 679             return Optional.empty();
 680         }
 681     }
 682 
 683     @Override
 684     public Optional&lt;Branch&gt; currentBranch() throws IOException {
 685         try (var p = capture(&quot;git&quot;, &quot;symbolic-ref&quot;, &quot;--short&quot;, &quot;HEAD&quot;)) {
 686             var res = p.await();
 687             if (res.status() == 0 &amp;&amp; res.stdout().size() == 1) {
 688                 return Optional.of(new Branch(res.stdout().get(0)));
 689             }
 690             return Optional.empty();
 691         }
 692     }
 693 
 694     @Override
 695     public Optional&lt;Bookmark&gt; currentBookmark() throws IOException {
 696         throw new RuntimeException(&quot;git does not have bookmarks&quot;);
 697     }
 698 
 699     @Override
 700     public Branch defaultBranch() throws IOException {
 701         try (var p = capture(&quot;git&quot;, &quot;symbolic-ref&quot;, &quot;--short&quot;, &quot;refs/remotes/origin/HEAD&quot;)) {
 702             var res = p.await();
 703             if (res.status() == 0 &amp;&amp; res.stdout().size() == 1) {
 704                 var ref = res.stdout().get(0).substring(&quot;origin/&quot;.length());
 705                 return new Branch(ref);
 706             } else {
 707                 return new Branch(&quot;master&quot;);
 708             }
 709         }
 710     }
 711 
 712     @Override
 713     public Optional&lt;Tag&gt; defaultTag() throws IOException {
 714         return Optional.empty();
 715     }
 716 
 717     @Override
 718     public Optional&lt;String&gt; username() throws IOException {
 719         var lines = config(&quot;user.name&quot;);
 720         return lines.size() == 1 ? Optional.of(lines.get(0)) : Optional.empty();
 721     }
 722 
 723     private String treeEntry(Path path, Hash hash) throws IOException {
 724         try (var p = Process.capture(&quot;git&quot;, &quot;ls-tree&quot;, hash.hex(), path.toString())
 725                             .workdir(root())
 726                             .execute()) {
 727             var res = await(p);
 728             if (res.stdout().size() == 0) {
 729                 return null;
 730             }
 731             if (res.stdout().size() &gt; 1) {
 732                 throw new IOException(&quot;Unexpected output\n&quot; + res);
 733             }
 734             return res.stdout().get(0);
 735         }
 736     }
 737 
 738     private List&lt;FileEntry&gt; allFiles(Hash hash, List&lt;Path&gt; paths) throws IOException {
 739         var cmd = new ArrayList&lt;String&gt;();
 740         cmd.addAll(List.of(&quot;git&quot;, &quot;ls-tree&quot;, &quot;-r&quot;));
 741         cmd.add(hash.hex());
 742         cmd.addAll(paths.stream().map(Path::toString).collect(Collectors.toList()));
 743         try (var p = Process.capture(cmd.toArray(new String[0]))
 744                             .workdir(root())
 745                             .execute()) {
 746             var res = await(p);
 747             var entries = new ArrayList&lt;FileEntry&gt;();
 748             for (var line : res.stdout()) {
 749                 var parts = line.split(&quot;\t&quot;);
 750                 var metadata = parts[0].split(&quot; &quot;);
 751                 var filename = parts[1];
 752 
 753                 var entry = new FileEntry(hash,
 754                                           FileType.fromOctal(metadata[0]),
 755                                           new Hash(metadata[2]),
 756                                           Path.of(filename));
 757                 entries.add(entry);
 758             }
 759             return entries;
 760         }
 761     }
 762 
 763     @Override
 764     public List&lt;FileEntry&gt; files(Hash hash, List&lt;Path&gt; paths) throws IOException {
 765         if (paths.isEmpty()) {
 766             return allFiles(hash, paths);
 767         }
 768 
 769         var entries = new ArrayList&lt;FileEntry&gt;();
 770         var batchSize = 64;
 771         var start = 0;
 772         while (start &lt; paths.size()) {
 773             var end = start + batchSize;
 774             if (end &gt; paths.size()) {
 775                 end = paths.size();
 776             }
 777             entries.addAll(allFiles(hash, paths.subList(start, end)));
 778             start = end;
 779         }
 780         return entries;
 781     }
 782 
 783     private Path unpackFile(String blob) throws IOException {
 784         try (var p = capture(&quot;git&quot;, &quot;unpack-file&quot;, blob)) {
 785             var res = await(p);
 786             if (res.stdout().size() != 1) {
 787                 throw new IOException(&quot;Unexpected output\n&quot; + res);
 788             }
 789 
 790             return Path.of(root().toString(), res.stdout().get(0));
 791         }
 792     }
 793 
 794     @Override
 795     public Optional&lt;byte[]&gt; show(Path path, Hash hash) throws IOException {
 796         var entries = files(hash, path);
 797         if (entries.size() == 0) {
 798             return Optional.empty();
 799         } else if (entries.size() &gt; 1) {
 800             throw new IOException(&quot;Multiple files match path &quot; + path.toString() + &quot; in commit &quot; + hash.hex());
 801         }
 802 
 803         var entry = entries.get(0);
 804         var type = entry.type();
 805         if (type.isVCSLink()) {
 806             var content = &quot;Subproject commit &quot; + entry.hash().hex() + &quot; &quot; + entry.path().toString();
 807             return Optional.of(content.getBytes(StandardCharsets.UTF_8));
 808         } else if (type.isRegular()) {
 809             var tmp = unpackFile(entry.hash().hex());
 810             var content = Files.readAllBytes(tmp);
 811             Files.delete(tmp);
 812             return Optional.of(content);
 813         }
 814 
 815         return Optional.empty();
 816     }
 817 
 818     @Override
 819     public void dump(FileEntry entry, Path to) throws IOException {
 820         var type = entry.type();
 821         if (type.isRegular()) {
 822             var path = unpackFile(entry.hash().hex());
 823             Files.createDirectories(to.getParent());
 824             Files.move(path, to, StandardCopyOption.REPLACE_EXISTING);
 825         }
 826     }
 827 
 828     @Override
 829     public List&lt;StatusEntry&gt; status(Hash from, Hash to) throws IOException {
 830         var cmd = new ArrayList&lt;String&gt;();
 831         cmd.addAll(List.of(&quot;git&quot;, &quot;diff&quot;, &quot;--raw&quot;,
 832                                           &quot;--find-renames=99%&quot;,
 833                                           &quot;--find-copies=99%&quot;,
 834                                           &quot;--find-copies-harder&quot;,
 835                                           &quot;--no-abbrev&quot;,
 836                                           &quot;--no-color&quot;));
 837         if (from != null) {
 838             cmd.add(from.hex());
 839         }
 840         if (to != null) {
 841             cmd.add(to.hex());
 842         }
 843         try (var p = capture(cmd)) {
 844             var res = await(p);
 845             var entries = new ArrayList&lt;StatusEntry&gt;();
 846             for (var line : res.stdout()) {
 847                 entries.add(StatusEntry.fromRawLine(line));
 848             }
 849             return entries;
 850         }
 851     }
 852 
 853     @Override
 854     public List&lt;StatusEntry&gt; status() throws IOException {
 855         return status(null, null);
 856     }
 857 
 858     @Override
 859     public Diff diff(Hash from) throws IOException {
 860         return diff(from, List.of());
 861     }
 862 
 863     @Override
 864     public Diff diff(Hash from, List&lt;Path&gt; files) throws IOException {
 865         return diff(from, null, files);
 866     }
 867 
 868     @Override
 869     public Diff diff(Hash from, Hash to) throws IOException {
 870         return diff(from, to, List.of());
 871     }
 872 
 873     @Override
 874     public Diff diff(Hash from, Hash to, List&lt;Path&gt; files) throws IOException {
 875         var cmd = new ArrayList&lt;&gt;(List.of(&quot;git&quot;, &quot;diff&quot;, &quot;--patch&quot;,
 876                                                          &quot;--find-renames=99%&quot;,
 877                                                          &quot;--find-copies=99%&quot;,
 878                                                          &quot;--find-copies-harder&quot;,
 879                                                          &quot;--binary&quot;,
 880                                                          &quot;--raw&quot;,
 881                                                          &quot;--no-abbrev&quot;,
 882                                                          &quot;--unified=0&quot;,
 883                                                          &quot;--no-color&quot;,
 884                                                          from.hex()));
 885         if (to != null) {
 886             cmd.add(to.hex());
 887         }
 888 
 889         if (files != null &amp;&amp; !files.isEmpty()) {
 890             cmd.add(&quot;--&quot;);
 891             for (var file : files) {
 892                 cmd.add(file.toString());
 893             }
 894         }
 895 
 896         var p = start(cmd);
 897         try {
 898             var patches = UnifiedDiffParser.parseGitRaw(p.getInputStream());
 899             await(p);
 900             return new Diff(from, to, patches);
 901         } catch (Throwable t) {
 902             stop(p);
 903             throw t;
 904         }
 905     }
 906 
 907     @Override
 908     public List&lt;String&gt; config(String key) throws IOException {
 909         try (var p = capture(&quot;git&quot;, &quot;config&quot;, key)) {
 910             var res = p.await();
 911             return res.status() == 0 ? res.stdout() : List.of();
 912         }
 913     }
 914 
 915     @Override
 916     public Hash head() throws IOException {
 917         return resolve(&quot;HEAD&quot;).orElseThrow(() -&gt; new IllegalStateException(&quot;HEAD ref is not present&quot;));
 918     }
 919 
 920     public static Optional&lt;Repository&gt; get(Path p) throws IOException {
 921         if (!Files.exists(p)) {
 922             return Optional.empty();
 923         }
 924 
 925         var r = new GitRepository(p);
 926         return r.exists() ? Optional.of(new GitRepository(r.root())) : Optional.empty();
 927     }
 928 
 929     @Override
 930     public Repository copyTo(Path destination) throws IOException {
 931         try (var p = capture(&quot;git&quot;, &quot;clone&quot;, &quot;--recurse-submodules&quot;, root().toString(), destination.toString())) {
 932             await(p);
 933         }
 934 
 935         return new GitRepository(destination);
 936     }
 937 
 938     @Override
 939     public void merge(Hash h) throws IOException {
 940         merge(h.hex(), null);
 941     }
 942 
 943     @Override
 944     public void merge(Branch b) throws IOException {
 945         merge(b.name(), null);
 946     }
 947 
 948     @Override
 949     public void merge(Hash h, String strategy) throws IOException {
 950         merge(h.hex(), strategy);
 951     }
 952 
 953     private void merge(String ref, String strategy) throws IOException {
 954         var cmd = new ArrayList&lt;String&gt;();
 955         cmd.addAll(List.of(&quot;git&quot;, &quot;-c&quot;, &quot;user.name=unused&quot;, &quot;-c&quot;, &quot;user.email=unused&quot;,
 956                            &quot;merge&quot;, &quot;--no-commit&quot;));
 957         if (strategy != null) {
 958             cmd.add(&quot;-s&quot;);
 959             cmd.add(strategy);
 960         }
 961         cmd.add(ref);
 962         try (var p = capture(cmd)) {
 963             await(p);
 964         }
 965     }
 966 
 967     @Override
 968     public void abortMerge() throws IOException {
 969         try (var p = capture(&quot;git&quot;, &quot;merge&quot;, &quot;--abort&quot;)) {
 970             await(p);
 971         }
 972     }
 973 
 974     @Override
 975     public void addRemote(String name, String pullPath) throws IOException {
 976         try (var p = capture(&quot;git&quot;, &quot;remote&quot;, &quot;add&quot;, name, pullPath)) {
 977             await(p);
 978         }
 979     }
 980 
 981     @Override
 982     public void setPaths(String remote, String pullPath, String pushPath) throws IOException {
 983         pullPath = pullPath == null ? &quot;&quot; : pullPath;
 984         try (var p = capture(&quot;git&quot;, &quot;config&quot;, &quot;remote.&quot; + remote + &quot;.url&quot;, pullPath)) {
 985             await(p);
 986         }
 987 
 988         pushPath = pushPath == null ? &quot;&quot; : pushPath;
 989         try (var p = capture(&quot;git&quot;, &quot;config&quot;, &quot;remote.&quot; + remote + &quot;.pushurl&quot;, pushPath)) {
 990             await(p);
 991         }
 992     }
 993 
 994     @Override
 995     public String pullPath(String remote) throws IOException {
 996         var lines = config(&quot;remote.&quot; + remote + &quot;.url&quot;);
 997         if (lines.size() != 1) {
 998             throw new IOException(&quot;No pull path found for remote &quot; + remote);
 999         }
1000         return lines.get(0);
1001     }
1002 
1003     @Override
1004     public String pushPath(String remote) throws IOException {
1005         var lines = config(&quot;remote.&quot; + remote + &quot;.pushurl&quot;);
1006         if (lines.size() != 1) {
1007             return pullPath(remote);
1008         }
1009         return lines.get(0);
1010     }
1011 
1012     @Override
1013     public boolean isValidRevisionRange(String expression) throws IOException {
1014         try (var p = capture(&quot;git&quot;, &quot;rev-parse&quot;, expression)) {
1015             return p.await().status() == 0;
1016         }
1017     }
1018 
1019     private void applyPatch(Patch patch) throws IOException {
1020         if (patch.isEmpty()) {
1021             return;
1022         }
1023 
1024         if (patch.isTextual()) {
1025         } else {
1026             throw new IllegalArgumentException(&quot;Cannot handle binary patches yet&quot;);
1027         }
1028     }
1029 
1030     @Override
1031     public void apply(Diff diff, boolean force) throws IOException {
1032         // ignore force, no such concept in git
1033         var patchFile = Files.createTempFile(&quot;apply&quot;, &quot;.patch&quot;);
1034         diff.toFile(patchFile);
1035         apply(patchFile, force);
1036         Files.delete(patchFile);
1037     }
1038 
1039     @Override
1040     public void apply(Path patchFile, boolean force)  throws IOException {
1041         var cmd = new ArrayList&lt;String&gt;();
1042         cmd.addAll(List.of(&quot;git&quot;, &quot;apply&quot;, &quot;--index&quot;, &quot;--unidiff-zero&quot;));
1043         cmd.add(patchFile.toAbsolutePath().toString());
1044         try (var p = capture(cmd)) {
1045             await(p);
1046             Files.delete(patchFile);
1047         }
1048     }
1049 
1050     @Override
1051     public void copy(Path from, Path to) throws IOException {
1052         Files.copy(from, to);
1053         add(to);
1054     }
1055 
1056     @Override
1057     public void move(Path from, Path to) throws IOException {
1058         try (var p = capture(&quot;git&quot;, &quot;mv&quot;, from.toString(), to.toString())) {
1059             await(p);
1060         }
1061     }
1062 
1063     @Override
1064     public Optional&lt;String&gt; upstreamFor(Branch b) throws IOException {
1065         try (var p = capture(&quot;git&quot;, &quot;for-each-ref&quot;, &quot;--format=%(upstream:short)&quot;, &quot;refs/heads/&quot; + b.name())) {
1066             var lines = await(p).stdout();
1067             return lines.size() == 1 &amp;&amp; !lines.get(0).isEmpty()? Optional.of(lines.get(0)) : Optional.empty();
1068         }
1069     }
1070 
1071     public static Repository clone(URI from, Path to, boolean isBare, Path seed) throws IOException {
1072         var cmd = new ArrayList&lt;String&gt;();
1073         cmd.addAll(List.of(&quot;git&quot;, &quot;clone&quot;));
1074         if (isBare) {
1075             cmd.add(&quot;--bare&quot;);
1076         } else {
1077             cmd.add(&quot;--recurse-submodules&quot;);
1078         }
1079         if (seed != null) {
1080             cmd.add(&quot;--reference-if-able&quot;);
1081             cmd.add(seed.toString());
1082         }
1083         cmd.addAll(List.of(from.toString(), to.toString()));
1084         try (var p = capture(Path.of(&quot;&quot;).toAbsolutePath(), cmd)) {
1085             await(p);
1086         }
1087         return new GitRepository(to);
1088     }
1089 
1090     public static Repository mirror(URI from, Path to) throws IOException {
1091         var cwd = Path.of(&quot;&quot;).toAbsolutePath();
1092         try (var p = capture(cwd, &quot;git&quot;, &quot;clone&quot;, &quot;--mirror&quot;, from.toString(), to.toString())) {
1093             await(p);
1094         }
1095         return new GitRepository(to);
1096     }
1097 
1098     @Override
1099     public void pull() throws IOException {
1100         pull(null, null);
1101     }
1102 
1103     @Override
1104     public void pull(String remote) throws IOException {
1105         pull(remote, null);
1106     }
1107 
1108 
1109     @Override
1110     public void pull(String remote, String refspec) throws IOException {
1111         var cmd = new ArrayList&lt;String&gt;();
1112         cmd.add(&quot;git&quot;);
1113         cmd.add(&quot;pull&quot;);
1114         if (remote != null) {
1115             cmd.add(remote);
1116         }
1117         if (refspec != null) {
1118             cmd.add(refspec);
1119         }
1120         try (var p = capture(cmd)) {
1121             await(p);
1122         }
1123     }
1124 
1125     @Override
1126     public boolean contains(Branch b, Hash h) throws IOException {
1127         try (var p = capture(&quot;git&quot;, &quot;for-each-ref&quot;, &quot;--contains&quot;, h.hex(), &quot;--format&quot;, &quot;%(refname:short)&quot;)) {
1128             var res = await(p);
1129             for (var line : res.stdout()) {
1130                 if (line.equals(b.name())) {
1131                     return true;
1132                 }
1133             }
1134         }
1135 
1136         return false;
1137     }
1138 
1139     @Override
1140     public List&lt;Reference&gt; remoteBranches(String remote) throws IOException {
1141         var refs = new ArrayList&lt;Reference&gt;();
1142         try (var p = capture(&quot;git&quot;, &quot;ls-remote&quot;, &quot;--heads&quot;, &quot;--refs&quot;, remote)) {
1143             for (var line : await(p).stdout()) {
1144                 var parts = line.split(&quot;\t&quot;);
1145                 var name = parts[1].replace(&quot;refs/heads/&quot;, &quot;&quot;);
1146                 refs.add(new Reference(name, new Hash(parts[0])));
1147             }
1148         }
1149         return refs;
1150     }
1151 
1152     @Override
1153     public List&lt;String&gt; remotes() throws IOException {
1154         var remotes = new ArrayList&lt;String&gt;();
1155         try (var p = capture(&quot;git&quot;, &quot;remote&quot;)) {
1156             for (var line : await(p).stdout()) {
1157                 remotes.add(line);
1158             }
1159         }
1160         return remotes;
1161     }
1162 
1163     @Override
1164     public void addSubmodule(String pullPath, Path path) throws IOException {
1165         try (var p = capture(&quot;git&quot;, &quot;submodule&quot;, &quot;add&quot;, pullPath, path.toString())) {
1166             await(p);
1167         }
1168     }
1169 
1170     @Override
1171     public List&lt;Submodule&gt; submodules() throws IOException {
1172         var gitModules = root().resolve(&quot;.gitmodules&quot;);
1173         if (!Files.exists(gitModules)) {
1174             return List.of();
1175         }
1176 
1177         var urls = new HashMap&lt;String, String&gt;();
1178         var paths = new HashMap&lt;String, String&gt;();
1179         try (var p = capture(&quot;git&quot;, &quot;config&quot;, &quot;--file&quot;, gitModules.toAbsolutePath().toString(),
1180                                               &quot;--list&quot;)) {
1181             for (var line : await(p).stdout()) {
1182                 if (line.startsWith(&quot;submodule.&quot;)) {
1183                     line = line.substring(&quot;submodule.&quot;.length());
1184                     var parts = line.split(&quot;=&quot;);
1185                     var nameAndProperty = parts[0].split(&quot;\\.&quot;);
1186                     var name = nameAndProperty[0];
1187                     var prop = nameAndProperty[1];
1188                     var value = parts[1];
1189                     if (prop.equals(&quot;path&quot;)) {
1190                         paths.put(name, value);
1191                     } else if (prop.equals(&quot;url&quot;)) {
1192                         urls.put(name, value);
1193                     } else {
1194                         throw new IOException(&quot;Unexpected submodule property: &quot; + prop);
1195                     }
1196                 }
1197             }
1198         }
1199 
1200         var hashes = new HashMap&lt;String, String&gt;();
1201         try (var p = capture(&quot;git&quot;, &quot;submodule&quot;, &quot;status&quot;)) {
1202             for (var line : await(p).stdout()) {
1203                 var parts = line.substring(1).split(&quot; &quot;);
1204                 var hash = parts[0];
1205                 var path = parts[1];
1206                 hashes.put(path, hash);
1207             }
1208         }
1209 
1210         var modules = new ArrayList&lt;Submodule&gt;();
1211         for (var name : paths.keySet()) {
1212             var url = urls.get(name);
1213             var path = paths.get(name);
1214             var hash = hashes.get(path);
1215 
1216             modules.add(new Submodule(new Hash(hash), Path.of(path), url));
1217         }
1218 
1219         return modules;
1220     }
1221 
1222     @Override
1223     public Optional&lt;Tag.Annotated&gt; annotate(Tag tag) throws IOException {
1224         var ref = &quot;refs/tags/&quot; + tag.name();
1225         var format = &quot;%(refname:short)%0a%(*objectname)%0a%(taggername) %(taggeremail)%0a%(taggerdate:iso-strict)%0a%(contents)&quot;;
1226         try (var p = capture(&quot;git&quot;, &quot;for-each-ref&quot;, &quot;--format&quot;, format, ref)) {
1227             var lines = await(p).stdout();
1228             if (lines.size() &gt;= 4) {
1229                 var name = lines.get(0);
1230                 var target = new Hash(lines.get(1));
1231                 var author = Author.fromString(lines.get(2));
1232 
1233                 var formatter = DateTimeFormatter.ISO_OFFSET_DATE_TIME;
1234                 var date = ZonedDateTime.parse(lines.get(3), formatter);
1235                 var message = String.join(&quot;\n&quot;, lines.subList(4, lines.size()));
1236 
1237                 return Optional.of(new Tag.Annotated(name, target, author, date, message));
1238             }
1239             return Optional.empty();
1240         }
1241     }
1242 
1243     @Override
1244     public void config(String section, String key, String value, boolean global) throws IOException {
1245         var cmd = new ArrayList&lt;String&gt;();
1246         cmd.addAll(List.of(&quot;git&quot;, &quot;config&quot;));
1247         if (global) {
1248             cmd.add(&quot;--global&quot;);
1249         }
1250         cmd.add(section + &quot;.&quot; + key);
1251         cmd.add(value);
1252         try (var p = capture(cmd)) {
1253             await(p);
1254         }
1255     }
1256 }
    </pre>
  </body>
</html>