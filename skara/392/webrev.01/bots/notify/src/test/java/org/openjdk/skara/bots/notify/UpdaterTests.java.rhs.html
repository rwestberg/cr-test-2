<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames bots/notify/src/test/java/org/openjdk/skara/bots/notify/UpdaterTests.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>   1 /*
   2  * Copyright (c) 2019, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  */
  23 package org.openjdk.skara.bots.notify;
  24 
  25 import org.openjdk.skara.email.*;
  26 import org.openjdk.skara.forge.HostedRepository;
  27 import org.openjdk.skara.issuetracker.Issue;
  28 import org.openjdk.skara.json.*;
  29 import org.openjdk.skara.mailinglist.MailingListServerFactory;
  30 import org.openjdk.skara.storage.StorageBuilder;
  31 import org.openjdk.skara.test.*;
  32 import org.openjdk.skara.vcs.Tag;
  33 
  34 import org.junit.jupiter.api.*;
  35 
  36 import java.io.IOException;
  37 import java.net.URI;
  38 import java.nio.charset.StandardCharsets;
  39 import java.nio.file.*;
  40 import java.time.Duration;
  41 import java.util.*;
  42 import java.util.regex.Pattern;
  43 import java.util.stream.Collectors;
  44 
  45 import static org.junit.jupiter.api.Assertions.*;
  46 import static org.openjdk.skara.issuetracker.Issue.State.*;
  47 
  48 class UpdaterTests {
  49     private List&lt;Path&gt; findJsonFiles(Path folder, String partialName) throws IOException {
  50         return Files.walk(folder)
  51                     .filter(path -&gt; path.toString().endsWith(&quot;.json&quot;))
  52                     .filter(path -&gt; path.toString().contains(partialName))
  53                     .collect(Collectors.toList());
  54     }
  55 
  56     private StorageBuilder&lt;Tag&gt; createTagStorage(HostedRepository repository) {
  57         return new StorageBuilder&lt;Tag&gt;(&quot;tags.txt&quot;)
  58                 .remoteRepository(repository, &quot;history&quot;, &quot;Duke&quot;, &quot;duke@openjdk.java.net&quot;, &quot;Updated tags&quot;);
  59     }
  60 
  61     private StorageBuilder&lt;ResolvedBranch&gt; createBranchStorage(HostedRepository repository) {
  62         return new StorageBuilder&lt;ResolvedBranch&gt;(&quot;branches.txt&quot;)
  63                 .remoteRepository(repository, &quot;history&quot;, &quot;Duke&quot;, &quot;duke@openjdk.java.net&quot;, &quot;Updated branches&quot;);
  64     }
  65 
  66     private StorageBuilder&lt;PullRequestIssues&gt; createPullRequestIssuesStorage(HostedRepository repository) {
  67         return new StorageBuilder&lt;PullRequestIssues&gt;(&quot;prissues.txt&quot;)
  68                 .remoteRepository(repository, &quot;history&quot;, &quot;Duke&quot;, &quot;duke@openjdk.java.net&quot;, &quot;Updated prissues&quot;);
  69     }
  70 
  71     private Set&lt;String&gt; fixVersions(Issue issue) {
  72         if (!issue.properties().containsKey(&quot;fixVersions&quot;)) {
  73             return Set.of();
  74         }
  75         return issue.properties().get(&quot;fixVersions&quot;).stream()
  76                     .map(JSONValue::asString)
  77                     .collect(Collectors.toSet());
  78     }
  79 
  80     @Test
  81     void testJsonUpdaterBranch(TestInfo testInfo) throws IOException {
  82         try (var credentials = new HostCredentials(testInfo);
  83              var tempFolder = new TemporaryDirectory()) {
  84             var repo = credentials.getHostedRepository();
  85             var localRepoFolder = tempFolder.path().resolve(&quot;repo&quot;);
  86             var localRepo = CheckableRepository.init(localRepoFolder, repo.repositoryType());
  87             credentials.commitLock(localRepo);
  88             localRepo.pushAll(repo.url());
  89 
  90             var tagStorage = createTagStorage(repo);
  91             var branchStorage = createBranchStorage(repo);
  92             var prIssuesStorage = createPullRequestIssuesStorage(repo);
  93             var jsonFolder = tempFolder.path().resolve(&quot;json&quot;);
  94             Files.createDirectory(jsonFolder);
  95             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
  96 
  97             var updater = new JsonUpdater(jsonFolder, &quot;12&quot;, &quot;team&quot;);
  98             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,
  99                                           prIssuesStorage, List.of(updater), List.of(), Set.of(), Map.of());
 100 
 101             TestBotRunner.runPeriodicItems(notifyBot);
 102             assertEquals(List.of(), findJsonFiles(jsonFolder, &quot;&quot;));
 103 
 104             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;One more line&quot;, &quot;12345678: Fixes&quot;);
 105             localRepo.push(editHash, repo.url(), &quot;master&quot;);
 106             TestBotRunner.runPeriodicItems(notifyBot);
 107             var jsonFiles = findJsonFiles(jsonFolder, &quot;&quot;);
 108             assertEquals(1, jsonFiles.size());
 109             var jsonData = Files.readString(jsonFiles.get(0), StandardCharsets.UTF_8);
 110             var json = JSON.parse(jsonData);
 111             assertEquals(1, json.asArray().size());
 112             assertEquals(repo.webUrl(editHash).toString(), json.asArray().get(0).get(&quot;url&quot;).asString());
 113             assertEquals(List.of(&quot;12345678&quot;), json.asArray().get(0).get(&quot;issue&quot;).asArray().stream()
 114                                                   .map(JSONValue::asString)
 115                                                   .collect(Collectors.toList()));
 116         }
 117     }
 118 
 119     @Test
 120     void testJsonUpdaterTag(TestInfo testInfo) throws IOException {
 121         try (var credentials = new HostCredentials(testInfo);
 122              var tempFolder = new TemporaryDirectory()) {
 123             var repo = credentials.getHostedRepository();
 124             var localRepoFolder = tempFolder.path().resolve(&quot;repo&quot;);
 125             var localRepo = CheckableRepository.init(localRepoFolder, repo.repositoryType());
 126             credentials.commitLock(localRepo);
 127             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 128             localRepo.tag(masterHash, &quot;jdk-12+1&quot;, &quot;Added tag 1&quot;, &quot;Duke&quot;, &quot;duke@openjdk.java.net&quot;);
 129             localRepo.pushAll(repo.url());
 130 
 131             var tagStorage = createTagStorage(repo);
 132             var branchStorage = createBranchStorage(repo);
 133             var prIssuesStorage = createPullRequestIssuesStorage(repo);
 134             var jsonFolder = tempFolder.path().resolve(&quot;json&quot;);
 135             Files.createDirectory(jsonFolder);
 136             var storageFolder =tempFolder.path().resolve(&quot;storage&quot;);
 137 
 138             var updater = new JsonUpdater(jsonFolder, &quot;12&quot;, &quot;team&quot;);
 139             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,
 140                                           prIssuesStorage, List.of(updater), List.of(), Set.of(), Map.of());
 141 
 142             TestBotRunner.runPeriodicItems(notifyBot);
 143             assertEquals(List.of(), findJsonFiles(jsonFolder, &quot;&quot;));
 144 
 145             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
 146             localRepo.fetch(repo.url(), &quot;history:history&quot;);
 147             localRepo.tag(editHash, &quot;jdk-12+2&quot;, &quot;Added tag 2&quot;, &quot;Duke&quot;, &quot;duke@openjdk.java.net&quot;);
 148             var editHash2 = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;34567890: Even more fixes&quot;);
 149             localRepo.tag(editHash2, &quot;jdk-12+4&quot;, &quot;Added tag 3&quot;, &quot;Duke&quot;, &quot;duke@openjdk.java.net&quot;);
 150             localRepo.pushAll(repo.url());
 151 
 152             TestBotRunner.runPeriodicItems(notifyBot);
 153             var jsonFiles = findJsonFiles(jsonFolder, &quot;&quot;);
 154             assertEquals(3, jsonFiles.size());
 155 
 156             for (var file : jsonFiles) {
 157                 var jsonData = Files.readString(file, StandardCharsets.UTF_8);
 158                 var json = JSON.parse(jsonData);
 159 
 160                 if (json.asArray().get(0).contains(&quot;date&quot;)) {
 161                     assertEquals(2, json.asArray().size());
 162                     assertEquals(List.of(&quot;23456789&quot;), json.asArray().get(0).get(&quot;issue&quot;).asArray().stream()
 163                                                           .map(JSONValue::asString)
 164                                                           .collect(Collectors.toList()));
 165                     assertEquals(repo.webUrl(editHash).toString(), json.asArray().get(0).get(&quot;url&quot;).asString());
 166                     assertEquals(&quot;team&quot;, json.asArray().get(0).get(&quot;build&quot;).asString());
 167                     assertEquals(List.of(&quot;34567890&quot;), json.asArray().get(1).get(&quot;issue&quot;).asArray().stream()
 168                                                           .map(JSONValue::asString)
 169                                                           .collect(Collectors.toList()));
 170                     assertEquals(repo.webUrl(editHash2).toString(), json.asArray().get(1).get(&quot;url&quot;).asString());
 171                     assertEquals(&quot;team&quot;, json.asArray().get(1).get(&quot;build&quot;).asString());
 172                 } else {
 173                     assertEquals(1, json.asArray().size());
 174                     if (json.asArray().get(0).get(&quot;build&quot;).asString().equals(&quot;b02&quot;)) {
 175                         assertEquals(List.of(&quot;23456789&quot;), json.asArray().get(0).get(&quot;issue&quot;).asArray().stream()
 176                                                               .map(JSONValue::asString)
 177                                                               .collect(Collectors.toList()));
 178                     } else {
 179                         assertEquals(&quot;b04&quot;, json.asArray().get(0).get(&quot;build&quot;).asString());
 180                         assertEquals(List.of(&quot;34567890&quot;), json.asArray().get(0).get(&quot;issue&quot;).asArray().stream()
 181                                                               .map(JSONValue::asString)
 182                                                               .collect(Collectors.toList()));
 183                     }
 184                 }
 185             }
 186         }
 187     }
 188 
 189     @Test
 190     void testMailingList(TestInfo testInfo) throws IOException {
 191         try (var listServer = new TestMailmanServer();
 192              var credentials = new HostCredentials(testInfo);
 193              var tempFolder = new TemporaryDirectory()) {
 194             var repo = credentials.getHostedRepository();
 195             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
 196             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
 197             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 198             credentials.commitLock(localRepo);
 199             localRepo.pushAll(repo.url());
 200 
 201             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 202             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 203             var mailmanList = mailmanServer.getList(listAddress.address());
 204             var tagStorage = createTagStorage(repo);
 205             var branchStorage = createBranchStorage(repo);
 206             var prIssuesStorage = createPullRequestIssuesStorage(repo);
 207             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
 208 
 209             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
 210             var updater = new MailingListUpdater(mailmanList, listAddress, sender, null, false, false, false, false,
 211                                                  MailingListUpdater.Mode.ALL,
 212                                                  Map.of(&quot;extra1&quot;, &quot;value1&quot;, &quot;extra2&quot;, &quot;value2&quot;), Pattern.compile(&quot;none&quot;));
 213             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,
 214                                           prIssuesStorage, List.of(updater), List.of(), Set.of(), Map.of());
 215 
 216             // No mail should be sent on the first run as there is no history
 217             TestBotRunner.runPeriodicItems(notifyBot);
 218             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 219 
 220             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
 221             localRepo.push(editHash, repo.url(), &quot;master&quot;);
 222             TestBotRunner.runPeriodicItems(notifyBot);
 223             listServer.processIncoming();
 224 
 225             var conversations = mailmanList.conversations(Duration.ofDays(1));
 226             var email = conversations.get(0).first();
 227             assertEquals(listAddress, email.sender());
 228             assertEquals(sender, email.author());
 229             assertEquals(email.recipients(), List.of(listAddress));
 230             assertTrue(email.subject().contains(&quot;: 23456789: More fixes&quot;));
 231             assertFalse(email.subject().contains(&quot;master&quot;));
 232             assertTrue(email.body().contains(&quot;Changeset: &quot; + editHash.abbreviate()));
 233             assertTrue(email.body().contains(&quot;23456789: More fixes&quot;));
 234             assertFalse(email.body().contains(&quot;Committer&quot;));
 235             assertFalse(email.body().contains(masterHash.abbreviate()));
 236             assertTrue(email.hasHeader(&quot;extra1&quot;));
 237             assertEquals(&quot;value1&quot;, email.headerValue(&quot;extra1&quot;));
 238             assertTrue(email.hasHeader(&quot;extra2&quot;));
 239             assertEquals(&quot;value2&quot;, email.headerValue(&quot;extra2&quot;));
 240         }
 241     }
 242 
 243     @Test
 244     void testMailingListMultiple(TestInfo testInfo) throws IOException {
 245         try (var listServer = new TestMailmanServer();
 246              var credentials = new HostCredentials(testInfo);
 247              var tempFolder = new TemporaryDirectory()) {
 248             var repo = credentials.getHostedRepository();
 249             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
 250             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
 251             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 252             credentials.commitLock(localRepo);
 253             localRepo.pushAll(repo.url());
 254 
 255             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 256             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 257             var mailmanList = mailmanServer.getList(listAddress.address());
 258             var tagStorage = createTagStorage(repo);
 259             var branchStorage = createBranchStorage(repo);
 260             var prIssuesStorage = createPullRequestIssuesStorage(repo);
 261             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
 262 
 263             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
 264             var updater = new MailingListUpdater(mailmanList, listAddress, sender, null,
 265                                                  false, false, false, false,
 266                                                  MailingListUpdater.Mode.ALL, Map.of(), Pattern.compile(&quot;.*&quot;));
 267             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,
 268                                           prIssuesStorage, List.of(updater), List.of(), Set.of(), Map.of());
 269 
 270             // No mail should be sent on the first run as there is no history
 271             TestBotRunner.runPeriodicItems(notifyBot);
 272             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 273 
 274             var editHash1 = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;,
 275                                                                 &quot;first_author&quot;, &quot;first@author.example.com&quot;);
 276             localRepo.push(editHash1, repo.url(), &quot;master&quot;);
 277             var editHash2 = CheckableRepository.appendAndCommit(localRepo, &quot;Yet another line&quot;, &quot;3456789A: Even more fixes&quot;,
 278                                                                 &quot;another_author&quot;, &quot;another@author.example.com&quot;);
 279             localRepo.push(editHash2, repo.url(), &quot;master&quot;);
 280 
 281             TestBotRunner.runPeriodicItems(notifyBot);
 282             listServer.processIncoming();
 283 
 284             var conversations = mailmanList.conversations(Duration.ofDays(1));
 285             var email = conversations.get(0).first();
 286             assertEquals(listAddress, email.sender());
 287             assertEquals(EmailAddress.from(&quot;another_author&quot;, &quot;another@author.example.com&quot;), email.author());
 288             assertEquals(email.recipients(), List.of(listAddress));
 289             assertTrue(email.subject().contains(&quot;: 2 new changesets&quot;));
 290             assertFalse(email.subject().contains(&quot;master&quot;));
 291             assertTrue(email.body().contains(&quot;Changeset: &quot; + editHash1.abbreviate()));
 292             assertTrue(email.body().contains(&quot;23456789: More fixes&quot;));
 293             assertTrue(email.body().contains(&quot;Changeset: &quot; + editHash2.abbreviate()));
 294             assertTrue(email.body().contains(&quot;3456789A: Even more fixes&quot;));
 295             assertFalse(email.body().contains(masterHash.abbreviate()));
 296         }
 297     }
 298 
 299     @Test
 300     void testMailingListSponsored(TestInfo testInfo) throws IOException {
 301         try (var listServer = new TestMailmanServer();
 302              var credentials = new HostCredentials(testInfo);
 303              var tempFolder = new TemporaryDirectory()) {
 304             var repo = credentials.getHostedRepository();
 305             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
 306             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
 307             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 308             credentials.commitLock(localRepo);
 309             localRepo.pushAll(repo.url());
 310 
 311             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 312             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 313             var mailmanList = mailmanServer.getList(listAddress.address());
 314             var tagStorage = createTagStorage(repo);
 315             var branchStorage = createBranchStorage(repo);
 316             var prIssuesStorage = createPullRequestIssuesStorage(repo);
 317             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
 318 
 319             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
 320             var updater = new MailingListUpdater(mailmanList, listAddress, sender, null,
 321                                                  false, false, false, false,
 322                                                  MailingListUpdater.Mode.ALL, Map.of(), Pattern.compile(&quot;.*&quot;));
 323             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,
 324                                           prIssuesStorage, List.of(updater), List.of(), Set.of(), Map.of());
 325 
 326             // No mail should be sent on the first run as there is no history
 327             TestBotRunner.runPeriodicItems(notifyBot);
 328             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 329 
 330             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;,
 331                                                                &quot;author&quot;, &quot;author@test.test&quot;,
 332                                                                &quot;committer&quot;, &quot;committer@test.test&quot;);
 333             localRepo.push(editHash, repo.url(), &quot;master&quot;);
 334             TestBotRunner.runPeriodicItems(notifyBot);
 335             listServer.processIncoming();
 336 
 337             var conversations = mailmanList.conversations(Duration.ofDays(1));
 338             var email = conversations.get(0).first();
 339             assertEquals(listAddress, email.sender());
 340             assertEquals(EmailAddress.from(&quot;committer&quot;, &quot;committer@test.test&quot;), email.author());
 341             assertEquals(email.recipients(), List.of(listAddress));
 342             assertTrue(email.body().contains(&quot;Changeset: &quot; + editHash.abbreviate()));
 343             assertTrue(email.body().contains(&quot;23456789: More fixes&quot;));
 344             assertTrue(email.body().contains(&quot;Author:    author &lt;author@test.test&gt;&quot;));
 345             assertTrue(email.body().contains(&quot;Committer: committer &lt;committer@test.test&gt;&quot;));
 346             assertFalse(email.body().contains(masterHash.abbreviate()));
 347         }
 348     }
 349 
 350     @Test
 351     void testMailingListMultipleBranches(TestInfo testInfo) throws IOException {
 352         try (var listServer = new TestMailmanServer();
 353              var credentials = new HostCredentials(testInfo);
 354              var tempFolder = new TemporaryDirectory()) {
 355             var repo = credentials.getHostedRepository();
 356             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
 357             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
 358             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 359             credentials.commitLock(localRepo);
 360             var branch = localRepo.branch(masterHash, &quot;another&quot;);
 361             localRepo.pushAll(repo.url());
 362 
 363             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 364             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 365             var mailmanList = mailmanServer.getList(listAddress.address());
 366             var tagStorage = createTagStorage(repo);
 367             var branchStorage = createBranchStorage(repo);
 368             var prIssuesStorage = createPullRequestIssuesStorage(repo);
 369             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
 370 
 371             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
 372             var author = EmailAddress.from(&quot;author&quot;, &quot;author@duke.duke&quot;);
 373             var updater = new MailingListUpdater(mailmanList, listAddress, sender, author,
 374                                                  true, false, false, false,
 375                                                  MailingListUpdater.Mode.ALL, Map.of(), Pattern.compile(&quot;.*&quot;));
 376             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;master|another&quot;), tagStorage, branchStorage,
 377                                           prIssuesStorage, List.of(updater), List.of(), Set.of(), Map.of());
 378 
 379             // No mail should be sent on the first run as there is no history
 380             TestBotRunner.runPeriodicItems(notifyBot);
 381             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 382 
 383             var editHash1 = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
 384             localRepo.push(editHash1, repo.url(), &quot;master&quot;);
 385             var editHash2 = CheckableRepository.appendAndCommit(localRepo, &quot;Yet another line&quot;, &quot;3456789A: Even more fixes&quot;);
 386             localRepo.push(editHash2, repo.url(), &quot;master&quot;);
 387 
 388             TestBotRunner.runPeriodicItems(notifyBot);
 389             listServer.processIncoming();
 390 
 391             var conversations = mailmanList.conversations(Duration.ofDays(1));
 392             var email = conversations.get(0).first();
 393             assertEquals(listAddress, email.sender());
 394             assertEquals(author, email.author());
 395             assertEquals(email.recipients(), List.of(listAddress));
 396             assertFalse(email.subject().contains(&quot;another&quot;));
 397             assertTrue(email.subject().contains(&quot;: master: 2 new changesets&quot;));
 398             assertTrue(email.body().contains(&quot;Changeset: &quot; + editHash1.abbreviate()));
 399             assertTrue(email.body().contains(&quot;23456789: More fixes&quot;));
 400             assertTrue(email.body().contains(&quot;Changeset: &quot; + editHash2.abbreviate()));
 401             assertTrue(email.body().contains(&quot;3456789A: Even more fixes&quot;));
 402             assertFalse(email.body().contains(masterHash.abbreviate()));
 403             assertFalse(email.body().contains(&quot;456789AB: Yet more fixes&quot;));
 404 
 405             localRepo.checkout(branch, true);
 406             var editHash3 = CheckableRepository.appendAndCommit(localRepo, &quot;Another branch&quot;, &quot;456789AB: Yet more fixes&quot;);
 407             localRepo.push(editHash3, repo.url(), &quot;another&quot;);
 408 
 409             TestBotRunner.runPeriodicItems(notifyBot);
 410             listServer.processIncoming();
 411 
 412             conversations = mailmanList.conversations(Duration.ofDays(1));
 413             conversations.sort(Comparator.comparing(conversation -&gt; conversation.first().subject()));
 414             email = conversations.get(0).first();
 415             assertEquals(author, email.author());
 416             assertEquals(listAddress, email.sender());
 417             assertEquals(email.recipients(), List.of(listAddress));
 418             assertTrue(email.subject().contains(&quot;: another: 456789AB: Yet more fixes&quot;));
 419             assertFalse(email.subject().contains(&quot;master&quot;));
 420             assertTrue(email.body().contains(&quot;Changeset: &quot; + editHash3.abbreviate()));
 421             assertTrue(email.body().contains(&quot;456789AB: Yet more fixes&quot;));
 422             assertFalse(email.body().contains(&quot;Changeset: &quot; + editHash2.abbreviate()));
 423             assertFalse(email.body().contains(&quot;3456789A: Even more fixes&quot;));
 424         }
 425     }
 426 
 427     @Test
 428     void testMailingListPROnly(TestInfo testInfo) throws IOException {
 429         try (var listServer = new TestMailmanServer();
 430              var credentials = new HostCredentials(testInfo);
 431              var tempFolder = new TemporaryDirectory()) {
 432             var repo = credentials.getHostedRepository();
 433             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
 434             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
 435             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 436             credentials.commitLock(localRepo);
 437             localRepo.pushAll(repo.url());
 438 
 439             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 440             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 441             var mailmanList = mailmanServer.getList(listAddress.address());
 442             var tagStorage = createTagStorage(repo);
 443             var branchStorage = createBranchStorage(repo);
 444             var prIssuesStorage = createPullRequestIssuesStorage(repo);
 445             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
 446 
 447             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
 448             var author = EmailAddress.from(&quot;author&quot;, &quot;author@duke.duke&quot;);
 449             var updater = new MailingListUpdater(mailmanList, listAddress, sender, author,
 450                                                  false, false, false, false,
 451                                                  MailingListUpdater.Mode.PR_ONLY, Map.of(&quot;extra1&quot;, &quot;value1&quot;),
 452                                                  Pattern.compile(&quot;.*&quot;));
 453             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,
 454                                           prIssuesStorage, List.of(updater), List.of(), Set.of(), Map.of());
 455 
 456             // No mail should be sent on the first run as there is no history
 457             TestBotRunner.runPeriodicItems(notifyBot);
 458             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 459 
 460             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
 461             localRepo.push(editHash, repo.url(), &quot;edit&quot;);
 462             var pr = credentials.createPullRequest(repo, &quot;master&quot;, &quot;edit&quot;, &quot;RFR: My PR&quot;);
 463 
 464             // Create a potentially conflicting one
 465             var otherHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
 466             localRepo.push(otherHash, repo.url(), &quot;other&quot;);
 467             var otherPr = credentials.createPullRequest(repo, &quot;master&quot;, &quot;other&quot;, &quot;RFR: My other PR&quot;);
 468 
 469             // PR hasn&#39;t been integrated yet, so there should be no mail
 470             TestBotRunner.runPeriodicItems(notifyBot);
 471             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 472 
 473             // Simulate an RFR email
 474             var rfr = Email.create(sender, &quot;RFR: My PR&quot;, &quot;PR: &quot; + pr.webUrl().toString())
 475                     .recipient(listAddress)
 476                     .build();
 477             mailmanList.post(rfr);
 478             listServer.processIncoming();
 479 
 480             // And an integration
 481             pr.addComment(&quot;Pushed as commit &quot; + editHash.hex() + &quot;.&quot;);
 482             localRepo.push(editHash, repo.url(), &quot;master&quot;);
 483             TestBotRunner.runPeriodicItems(notifyBot);
 484             listServer.processIncoming();
 485 
 486             var conversations = mailmanList.conversations(Duration.ofDays(1));
 487             assertEquals(1, conversations.size());
 488             var first = conversations.get(0).first();
 489             var email = conversations.get(0).replies(first).get(0);
 490             assertEquals(listAddress, email.sender());
 491             assertEquals(author, email.author());
 492             assertEquals(email.recipients(), List.of(listAddress));
 493             assertEquals(&quot;[Integrated] RFR: My PR&quot;, email.subject());
 494             assertFalse(email.subject().contains(&quot;master&quot;));
 495             assertTrue(email.body().contains(&quot;Changeset: &quot; + editHash.abbreviate()));
 496             assertTrue(email.body().contains(&quot;23456789: More fixes&quot;));
 497             assertFalse(email.body().contains(&quot;Committer&quot;));
 498             assertFalse(email.body().contains(masterHash.abbreviate()));
 499             assertTrue(email.hasHeader(&quot;extra1&quot;));
 500             assertEquals(&quot;value1&quot;, email.headerValue(&quot;extra1&quot;));
 501 
 502             // Now push the other one without a matching PR - PR_ONLY will not generate a mail
 503             localRepo.push(otherHash, repo.url(), &quot;master&quot;);
 504             TestBotRunner.runPeriodicItems(notifyBot);
 505             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofSeconds(1)));
 506         }
 507     }
 508 
 509     @Test
 510     void testMailingListPR(TestInfo testInfo) throws IOException {
 511         try (var listServer = new TestMailmanServer();
 512              var credentials = new HostCredentials(testInfo);
 513              var tempFolder = new TemporaryDirectory()) {
 514             var repo = credentials.getHostedRepository();
 515             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
 516             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
 517             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 518             credentials.commitLock(localRepo);
 519             localRepo.pushAll(repo.url());
 520 
 521             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 522             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 523             var mailmanList = mailmanServer.getList(listAddress.address());
 524             var tagStorage = createTagStorage(repo);
 525             var branchStorage = createBranchStorage(repo);
 526             var prIssuesStorage = createPullRequestIssuesStorage(repo);
 527             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
 528 
 529             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
 530             var updater = new MailingListUpdater(mailmanList, listAddress, sender, null,
 531                                                  false, false, false, false,
 532                                                  MailingListUpdater.Mode.PR, Map.of(), Pattern.compile(&quot;.*&quot;));
 533             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,
 534                                           prIssuesStorage, List.of(updater), List.of(), Set.of(), Map.of());
 535 
 536             // No mail should be sent on the first run as there is no history
 537             TestBotRunner.runPeriodicItems(notifyBot);
 538             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 539 
 540             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
 541             localRepo.push(editHash, repo.url(), &quot;edit&quot;);
 542             var pr = credentials.createPullRequest(repo, &quot;master&quot;, &quot;edit&quot;, &quot;RFR: My PR&quot;);
 543 
 544             // Create a potentially conflicting one
 545             var otherHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
 546             localRepo.push(otherHash, repo.url(), &quot;other&quot;);
 547             var otherPr = credentials.createPullRequest(repo, &quot;master&quot;, &quot;other&quot;, &quot;RFR: My other PR&quot;);
 548 
 549             // PR hasn&#39;t been integrated yet, so there should be no mail
 550             TestBotRunner.runPeriodicItems(notifyBot);
 551             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 552 
 553             // Simulate an RFR email
 554             var rfr = Email.create(&quot;RFR: My PR&quot;, &quot;PR:\n&quot; + pr.webUrl().toString())
 555                            .author(EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;))
 556                            .recipient(listAddress)
 557                            .build();
 558             mailmanList.post(rfr);
 559             listServer.processIncoming();
 560 
 561             // And an integration
 562             pr.addComment(&quot;Pushed as commit &quot; + editHash.hex() + &quot;.&quot;);
 563             localRepo.push(editHash, repo.url(), &quot;master&quot;);
 564 
 565             // Push the other one without a matching PR
 566             localRepo.push(otherHash, repo.url(), &quot;master&quot;);
 567 
 568             TestBotRunner.runPeriodicItems(notifyBot);
 569             listServer.processIncoming();
 570             listServer.processIncoming();
 571 
 572             var conversations = mailmanList.conversations(Duration.ofDays(1));
 573             conversations.sort(Comparator.comparing(conversation -&gt; conversation.first().subject()));
 574             assertEquals(2, conversations.size());
 575 
 576             var prConversation = conversations.get(0);
 577             var pushConversation = conversations.get(1);
 578 
 579             var prEmail = prConversation.replies(prConversation.first()).get(0);
 580             assertEquals(listAddress, prEmail.sender());
 581             assertEquals(EmailAddress.from(&quot;testauthor&quot;, &quot;ta@none.none&quot;), prEmail.author());
 582             assertEquals(prEmail.recipients(), List.of(listAddress));
 583             assertEquals(&quot;[Integrated] RFR: My PR&quot;, prEmail.subject());
 584             assertFalse(prEmail.subject().contains(&quot;master&quot;));
 585             assertTrue(prEmail.body().contains(&quot;Changeset: &quot; + editHash.abbreviate()));
 586             assertTrue(prEmail.body().contains(&quot;23456789: More fixes&quot;));
 587             assertFalse(prEmail.body().contains(&quot;Committer&quot;));
 588             assertFalse(prEmail.body().contains(masterHash.abbreviate()));
 589 
 590             var pushEmail = pushConversation.first();
 591             assertEquals(listAddress, pushEmail.sender());
 592             assertEquals(EmailAddress.from(&quot;testauthor&quot;, &quot;ta@none.none&quot;), pushEmail.author());
 593             assertEquals(pushEmail.recipients(), List.of(listAddress));
 594             assertTrue(pushEmail.subject().contains(&quot;23456789: More fixes&quot;));
 595         }
 596     }
 597 
 598     @Test
 599     void testMailingListPROnce(TestInfo testInfo) throws IOException {
 600         try (var listServer = new TestMailmanServer();
 601              var credentials = new HostCredentials(testInfo);
 602              var tempFolder = new TemporaryDirectory()) {
 603             var repo = credentials.getHostedRepository();
 604             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
 605             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
 606             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 607             localRepo.branch(masterHash, &quot;other&quot;);
 608             credentials.commitLock(localRepo);
 609             localRepo.pushAll(repo.url());
 610 
 611             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 612             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 613             var mailmanList = mailmanServer.getList(listAddress.address());
 614             var tagStorage = createTagStorage(repo);
 615             var branchStorage = createBranchStorage(repo);
 616             var prIssuesStorage = createPullRequestIssuesStorage(repo);
 617             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
 618 
 619             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
 620             var updater = new MailingListUpdater(mailmanList, listAddress, sender, null,
 621                                                  false, false, false, false,
 622                                                  MailingListUpdater.Mode.PR, Map.of(), Pattern.compile(&quot;.*&quot;));
 623             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;master|other&quot;), tagStorage, branchStorage,
 624                                           prIssuesStorage, List.of(updater), List.of(), Set.of(), Map.of());
 625 
 626             // No mail should be sent on the first run as there is no history
 627             TestBotRunner.runPeriodicItems(notifyBot);
 628             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 629 
 630             localRepo.checkout(masterHash, true);
 631             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
 632             localRepo.push(editHash, repo.url(), &quot;edit&quot;);
 633             var pr = credentials.createPullRequest(repo, &quot;master&quot;, &quot;edit&quot;, &quot;RFR: My PR&quot;);
 634 
 635             // PR hasn&#39;t been integrated yet, so there should be no mail
 636             TestBotRunner.runPeriodicItems(notifyBot);
 637             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 638 
 639             // Simulate an RFR email
 640             var rfr = Email.create(&quot;RFR: My PR&quot;, &quot;PR:\n&quot; + pr.webUrl().toString())
 641                            .author(EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;))
 642                            .recipient(listAddress)
 643                            .build();
 644             mailmanList.post(rfr);
 645             listServer.processIncoming();
 646 
 647             // And an integration
 648             pr.addComment(&quot;Pushed as commit &quot; + editHash.hex() + &quot;.&quot;);
 649             localRepo.push(editHash, repo.url(), &quot;master&quot;, true);
 650 
 651             TestBotRunner.runPeriodicItems(notifyBot);
 652             listServer.processIncoming();
 653 
 654             var conversations = mailmanList.conversations(Duration.ofDays(1));
 655             assertEquals(1, conversations.size());
 656 
 657             var prConversation = conversations.get(0);
 658             var prEmail = prConversation.replies(prConversation.first()).get(0);
 659             assertEquals(listAddress, prEmail.sender());
 660             assertEquals(EmailAddress.from(&quot;testauthor&quot;, &quot;ta@none.none&quot;), prEmail.author());
 661             assertEquals(prEmail.recipients(), List.of(listAddress));
 662             assertEquals(&quot;[Integrated] RFR: My PR&quot;, prEmail.subject());
 663             assertFalse(prEmail.subject().contains(&quot;master&quot;));
 664             assertTrue(prEmail.body().contains(&quot;Changeset: &quot; + editHash.abbreviate()));
 665             assertTrue(prEmail.body().contains(&quot;23456789: More fixes&quot;));
 666             assertFalse(prEmail.body().contains(&quot;Committer&quot;));
 667             assertFalse(prEmail.body().contains(masterHash.abbreviate()));
 668 
 669             // Now push the change to another monitored branch
 670             localRepo.push(editHash, repo.url(), &quot;other&quot;, true);
 671             TestBotRunner.runPeriodicItems(notifyBot);
 672             listServer.processIncoming();
 673 
 674             // The change should now end up as a separate notification thread
 675             conversations = mailmanList.conversations(Duration.ofDays(1));
 676             conversations.sort(Comparator.comparing(conversation -&gt; conversation.first().subject()));
 677             assertEquals(2, conversations.size());
 678 
 679             var pushConversation = conversations.get(1);
 680             var pushEmail = pushConversation.first();
 681             assertEquals(listAddress, pushEmail.sender());
 682             assertEquals(EmailAddress.from(&quot;testauthor&quot;, &quot;ta@none.none&quot;), pushEmail.author());
 683             assertEquals(pushEmail.recipients(), List.of(listAddress));
 684             assertTrue(pushEmail.subject().contains(&quot;23456789: More fixes&quot;));
 685         }
 686     }
 687 
 688     @Test
 689     void testMailinglistTag(TestInfo testInfo) throws IOException {
 690         try (var credentials = new HostCredentials(testInfo);
 691              var tempFolder = new TemporaryDirectory();
 692              var listServer = new TestMailmanServer()) {
 693             var repo = credentials.getHostedRepository();
 694             var localRepoFolder = tempFolder.path().resolve(&quot;repo&quot;);
 695             var localRepo = CheckableRepository.init(localRepoFolder, repo.repositoryType());
 696             credentials.commitLock(localRepo);
 697             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 698             localRepo.tag(masterHash, &quot;jdk-12+1&quot;, &quot;Added tag 1&quot;, &quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;);
 699             localRepo.pushAll(repo.url());
 700 
 701             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 702             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 703             var mailmanList = mailmanServer.getList(listAddress.address());
 704             var tagStorage = createTagStorage(repo);
 705             var branchStorage = createBranchStorage(repo);
 706             var prIssuesStorage = createPullRequestIssuesStorage(repo);
 707             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
 708 
 709             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
 710             var updater = new MailingListUpdater(mailmanList, listAddress, sender, null,
 711                                                  false, true, false, true,
 712                                                  MailingListUpdater.Mode.ALL,
 713                                                  Map.of(&quot;extra1&quot;, &quot;value1&quot;, &quot;extra2&quot;, &quot;value2&quot;),
 714                                                  Pattern.compile(&quot;.*&quot;));
 715             var prOnlyUpdater = new MailingListUpdater(mailmanList, listAddress, sender, null,
 716                                                        false, false, false, false,
 717                                                        MailingListUpdater.Mode.PR_ONLY, Map.of(), Pattern.compile(&quot;.*&quot;));
 718             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,
 719                                           prIssuesStorage, List.of(updater, prOnlyUpdater), List.of(), Set.of(), Map.of());
 720 
 721             // No mail should be sent on the first run as there is no history
 722             TestBotRunner.runPeriodicItems(notifyBot);
 723             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 724 
 725             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
 726             localRepo.fetch(repo.url(), &quot;history:history&quot;);
 727             localRepo.tag(editHash, &quot;jdk-12+2&quot;, &quot;Added tag 2&quot;, &quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;);
 728             CheckableRepository.appendAndCommit(localRepo, &quot;Another line 1&quot;, &quot;34567890: Even more fixes&quot;);
 729             CheckableRepository.appendAndCommit(localRepo, &quot;Another line 2&quot;, &quot;45678901: Yet even more fixes&quot;);
 730             var editHash2 = CheckableRepository.appendAndCommit(localRepo, &quot;Another line 3&quot;, &quot;56789012: Still even more fixes&quot;);
 731             localRepo.tag(editHash2, &quot;jdk-12+4&quot;, &quot;Added tag 3&quot;, &quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;);
 732             CheckableRepository.appendAndCommit(localRepo, &quot;Another line 4&quot;, &quot;67890123: Brand new fixes&quot;);
 733             var editHash3 = CheckableRepository.appendAndCommit(localRepo, &quot;Another line 5&quot;, &quot;78901234: More brand new fixes&quot;);
 734             localRepo.tag(editHash3, &quot;jdk-13+0&quot;, &quot;Added tag 4&quot;, &quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;);
 735             localRepo.pushAll(repo.url());
 736 
 737             TestBotRunner.runPeriodicItems(notifyBot);
 738             listServer.processIncoming();
 739             listServer.processIncoming();
 740             listServer.processIncoming();
 741             listServer.processIncoming();
 742 
 743             var conversations = mailmanList.conversations(Duration.ofDays(1));
 744             assertEquals(4, conversations.size());
 745 
 746             for (var conversation : conversations) {
 747                 var email = conversation.first();
 748                 if (email.subject().equals(&quot;git: test: Added tag jdk-12+2 for changeset &quot; + editHash.abbreviate())) {
 749                     assertTrue(email.body().contains(&quot;23456789: More fixes&quot;));
 750                     assertFalse(email.body().contains(&quot;34567890: Even more fixes&quot;));
 751                     assertFalse(email.body().contains(&quot;45678901: Yet even more fixes&quot;));
 752                     assertFalse(email.body().contains(&quot;56789012: Still even more fixes&quot;));
 753                     assertFalse(email.body().contains(&quot;67890123: Brand new fixes&quot;));
 754                     assertFalse(email.body().contains(&quot;78901234: More brand new fixes&quot;));
 755                     assertEquals(EmailAddress.from(&quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;), email.author());
 756                 } else if (email.subject().equals(&quot;git: test: Added tag jdk-12+4 for changeset &quot; + editHash2.abbreviate())) {
 757                     assertFalse(email.body().contains(&quot;23456789: More fixes&quot;));
 758                     assertTrue(email.body().contains(&quot;34567890: Even more fixes&quot;));
 759                     assertTrue(email.body().contains(&quot;45678901: Yet even more fixes&quot;));
 760                     assertTrue(email.body().contains(&quot;56789012: Still even more fixes&quot;));
 761                     assertFalse(email.body().contains(&quot;67890123: Brand new fixes&quot;));
 762                     assertFalse(email.body().contains(&quot;78901234: More brand new fixes&quot;));
 763                     assertEquals(EmailAddress.from(&quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;), email.author());
 764                 } else if (email.subject().equals(&quot;git: test: Added tag jdk-13+0 for changeset &quot; + editHash3.abbreviate())) {
 765                     assertFalse(email.body().contains(&quot;23456789: More fixes&quot;));
 766                     assertFalse(email.body().contains(&quot;34567890: Even more fixes&quot;));
 767                     assertFalse(email.body().contains(&quot;45678901: Yet even more fixes&quot;));
 768                     assertFalse(email.body().contains(&quot;56789012: Still even more fixes&quot;));
 769                     assertFalse(email.body().contains(&quot;67890123: Brand new fixes&quot;));
 770                     assertTrue(email.body().contains(&quot;78901234: More brand new fixes&quot;));
 771                     assertEquals(EmailAddress.from(&quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;), email.author());
 772                 } else if (email.subject().equals(&quot;git: test: 6 new changesets&quot;)) {
 773                     assertTrue(email.body().contains(&quot;23456789: More fixes&quot;));
 774                     assertTrue(email.body().contains(&quot;34567890: Even more fixes&quot;));
 775                     assertTrue(email.body().contains(&quot;45678901: Yet even more fixes&quot;));
 776                     assertTrue(email.body().contains(&quot;56789012: Still even more fixes&quot;));
 777                     assertTrue(email.body().contains(&quot;67890123: Brand new fixes&quot;));
 778                     assertTrue(email.body().contains(&quot;78901234: More brand new fixes&quot;));
 779                     assertEquals(EmailAddress.from(&quot;testauthor&quot;, &quot;ta@none.none&quot;), email.author());
 780                 } else {
 781                     fail(&quot;Mismatched subject: &quot; + email.subject());
 782                 }
 783                 assertTrue(email.hasHeader(&quot;extra1&quot;));
 784                 assertEquals(&quot;value1&quot;, email.headerValue(&quot;extra1&quot;));
 785                 assertTrue(email.hasHeader(&quot;extra2&quot;));
 786                 assertEquals(&quot;value2&quot;, email.headerValue(&quot;extra2&quot;));
 787             }
 788         }
 789     }
 790 
 791     @Test
 792     void testMailinglistPlainTags(TestInfo testInfo) throws IOException {
 793         try (var credentials = new HostCredentials(testInfo);
 794              var tempFolder = new TemporaryDirectory();
 795              var listServer = new TestMailmanServer()) {
 796             var repo = credentials.getHostedRepository();
 797             var localRepoFolder = tempFolder.path().resolve(&quot;repo&quot;);
 798             var localRepo = CheckableRepository.init(localRepoFolder, repo.repositoryType());
 799             credentials.commitLock(localRepo);
 800             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 801             localRepo.tag(masterHash, &quot;jdk-12+1&quot;, &quot;Added tag 1&quot;, &quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;);
 802             localRepo.pushAll(repo.url());
 803 
 804             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 805             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 806             var mailmanList = mailmanServer.getList(listAddress.address());
 807             var tagStorage = createTagStorage(repo);
 808             var branchStorage = createBranchStorage(repo);
 809             var prIssuesStorage = createPullRequestIssuesStorage(repo);
 810             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
 811 
 812             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
 813             var updater = new MailingListUpdater(mailmanList, listAddress, sender, null,
 814                                                  false, true, false, false,
 815                                                  MailingListUpdater.Mode.ALL,
 816                                                  Map.of(&quot;extra1&quot;, &quot;value1&quot;, &quot;extra2&quot;, &quot;value2&quot;),
 817                                                  Pattern.compile(&quot;.*&quot;));
 818             var prOnlyUpdater = new MailingListUpdater(mailmanList, listAddress, sender, null,
 819                                                        false, false, false, false,
 820                                                        MailingListUpdater.Mode.PR_ONLY, Map.of(), Pattern.compile(&quot;.*&quot;));
 821             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,
 822                                           prIssuesStorage, List.of(updater, prOnlyUpdater), List.of(), Set.of(), Map.of());
 823 
 824             // No mail should be sent on the first run as there is no history
 825             TestBotRunner.runPeriodicItems(notifyBot);
 826             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 827 
 828             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
 829             localRepo.fetch(repo.url(), &quot;history:history&quot;);
 830             localRepo.tag(editHash, &quot;jdk-12+2&quot;, &quot;Added tag 2&quot;, &quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;);
 831             CheckableRepository.appendAndCommit(localRepo, &quot;Another line 1&quot;, &quot;34567890: Even more fixes&quot;);
 832             CheckableRepository.appendAndCommit(localRepo, &quot;Another line 2&quot;, &quot;45678901: Yet even more fixes&quot;);
 833             var editHash2 = CheckableRepository.appendAndCommit(localRepo, &quot;Another line 3&quot;, &quot;56789012: Still even more fixes&quot;);
 834             localRepo.tag(editHash2, &quot;jdk-12+4&quot;, &quot;Added tag 3&quot;, &quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;);
 835             CheckableRepository.appendAndCommit(localRepo, &quot;Another line 4&quot;, &quot;67890123: Brand new fixes&quot;);
 836             var editHash3 = CheckableRepository.appendAndCommit(localRepo, &quot;Another line 5&quot;, &quot;78901234: More brand new fixes&quot;);
 837             localRepo.tag(editHash3, &quot;jdk-13+0&quot;, &quot;Added tag 4&quot;, &quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;);
 838             localRepo.pushAll(repo.url());
 839 
 840             TestBotRunner.runPeriodicItems(notifyBot);
 841             listServer.processIncoming();
 842             listServer.processIncoming();
 843             listServer.processIncoming();
 844             listServer.processIncoming();
 845 
 846             var conversations = mailmanList.conversations(Duration.ofDays(1));
 847             assertEquals(4, conversations.size());
 848 
 849             for (var conversation : conversations) {
 850                 var email = conversation.first();
 851                 if (email.subject().equals(&quot;git: test: Added tag jdk-12+2 for changeset &quot; + editHash.abbreviate())) {
 852                     assertEquals(EmailAddress.from(&quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;), email.author());
 853                 } else if (email.subject().equals(&quot;git: test: Added tag jdk-12+4 for changeset &quot; + editHash2.abbreviate())) {
 854                     assertEquals(EmailAddress.from(&quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;), email.author());
 855                 } else if (email.subject().equals(&quot;git: test: Added tag jdk-13+0 for changeset &quot; + editHash3.abbreviate())) {
 856                     assertEquals(EmailAddress.from(&quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;), email.author());
 857                 } else if (email.subject().equals(&quot;git: test: 6 new changesets&quot;)) {
 858                     assertEquals(EmailAddress.from(&quot;testauthor&quot;, &quot;ta@none.none&quot;), email.author());
 859                 } else {
 860                     fail(&quot;Mismatched subject: &quot; + email.subject());
 861                 }
 862                 assertTrue(email.hasHeader(&quot;extra1&quot;));
 863                 assertEquals(&quot;value1&quot;, email.headerValue(&quot;extra1&quot;));
 864                 assertTrue(email.hasHeader(&quot;extra2&quot;));
 865                 assertEquals(&quot;value2&quot;, email.headerValue(&quot;extra2&quot;));
 866             }
 867         }
 868     }
 869 
 870     @Test
 871     void testMailingListBranch(TestInfo testInfo) throws IOException {
 872         try (var listServer = new TestMailmanServer();
 873              var credentials = new HostCredentials(testInfo);
 874              var tempFolder = new TemporaryDirectory()) {
 875             var repo = credentials.getHostedRepository();
 876             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
 877             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
 878             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 879             credentials.commitLock(localRepo);
 880             localRepo.pushAll(repo.url());
 881 
 882             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 883             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 884             var mailmanList = mailmanServer.getList(listAddress.address());
 885             var tagStorage = createTagStorage(repo);
 886             var branchStorage = createBranchStorage(repo);
 887             var prIssuesStorage = createPullRequestIssuesStorage(repo);
 888             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
 889 
 890             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
 891             var updater = new MailingListUpdater(mailmanList, listAddress, sender, null,
 892                                                  false, false, true, false,
 893                                                  MailingListUpdater.Mode.ALL,
 894                                                  Map.of(&quot;extra1&quot;, &quot;value1&quot;, &quot;extra2&quot;, &quot;value2&quot;),
 895                                                  Pattern.compile(&quot;.*&quot;));
 896             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;master|newbranch.&quot;), tagStorage, branchStorage,
 897                                           prIssuesStorage, List.of(updater), List.of(), Set.of(), Map.of());
 898 
 899             // No mail should be sent on the first run as there is no history
 900             TestBotRunner.runPeriodicItems(notifyBot);
 901             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 902 
 903             CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;12345678: Some fixes&quot;);
 904             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
 905             localRepo.push(editHash, repo.url(), &quot;newbranch1&quot;);
 906             TestBotRunner.runPeriodicItems(notifyBot);
 907             listServer.processIncoming();
 908 
 909             var conversations = mailmanList.conversations(Duration.ofDays(1));
 910             var email = conversations.get(0).first();
 911             assertEquals(listAddress, email.sender());
 912             assertEquals(EmailAddress.from(&quot;testauthor&quot;, &quot;ta@none.none&quot;), email.author());
 913             assertEquals(email.recipients(), List.of(listAddress));
 914             assertEquals(&quot;git: test: created branch newbranch1 based on the branch master containing 2 unique commits&quot;, email.subject());
 915             assertTrue(email.body().contains(&quot;12345678: Some fixes&quot;));
 916             assertTrue(email.hasHeader(&quot;extra1&quot;));
 917             assertEquals(&quot;value1&quot;, email.headerValue(&quot;extra1&quot;));
 918             assertTrue(email.hasHeader(&quot;extra2&quot;));
 919             assertEquals(&quot;value2&quot;, email.headerValue(&quot;extra2&quot;));
 920 
 921             TestBotRunner.runPeriodicItems(notifyBot);
 922             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 923 
 924             localRepo.push(editHash, repo.url(), &quot;newbranch2&quot;);
 925             TestBotRunner.runPeriodicItems(notifyBot);
 926             listServer.processIncoming();
 927 
 928             var newConversation = mailmanList.conversations(Duration.ofDays(1)).stream()
 929                                              .filter(c -&gt; !c.equals(conversations.get(0)))
 930                                              .findFirst().orElseThrow();
 931             email = newConversation.first();
 932             assertEquals(listAddress, email.sender());
 933             assertEquals(sender, email.author());
 934             assertEquals(email.recipients(), List.of(listAddress));
 935             assertEquals(&quot;git: test: created branch newbranch2 based on the branch newbranch1 containing 0 unique commits&quot;, email.subject());
 936             assertEquals(&quot;The new branch newbranch2 is currently identical to the newbranch1 branch.&quot;, email.body());
 937         }
 938     }
 939 
 940     @Test
 941     void testMailingListNoIdempotence(TestInfo testInfo) throws IOException {
 942         try (var listServer = new TestMailmanServer();
 943              var credentials = new HostCredentials(testInfo);
 944              var tempFolder = new TemporaryDirectory()) {
 945             var repo = credentials.getHostedRepository();
 946             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
 947             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
 948             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 949             credentials.commitLock(localRepo);
 950             localRepo.pushAll(repo.url());
 951 
 952             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 953             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 954             var mailmanList = mailmanServer.getList(listAddress.address());
 955             var tagStorage = createTagStorage(repo);
 956             var branchStorage = createBranchStorage(repo);
 957             var prIssuesStorage = createPullRequestIssuesStorage(repo);
 958             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
 959 
 960             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
 961             var updater = new MailingListUpdater(mailmanList, listAddress, sender, null,
 962                                                  false, false, false, false,
 963                                                  MailingListUpdater.Mode.ALL,
 964                                                  Map.of(&quot;extra1&quot;, &quot;value1&quot;, &quot;extra2&quot;, &quot;value2&quot;), Pattern.compile(&quot;none&quot;));
 965             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,
 966                                           prIssuesStorage, List.of(updater), List.of(), Set.of(), Map.of());
 967 
 968             // No mail should be sent on the first run as there is no history
 969             TestBotRunner.runPeriodicItems(notifyBot);
 970             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 971 
 972             // Save history state
 973             var historyHash = localRepo.fetch(repo.url(), &quot;history&quot;);
 974 
 975             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
 976             localRepo.push(editHash, repo.url(), &quot;master&quot;);
 977             TestBotRunner.runPeriodicItems(notifyBot);
 978             listServer.processIncoming();
 979 
 980             var conversations = mailmanList.conversations(Duration.ofDays(1));
 981             assertEquals(1, conversations.size());
 982 
 983             // Reset the history
 984             localRepo.push(historyHash, repo.url(), &quot;history&quot;, true);
 985             TestBotRunner.runPeriodicItems(notifyBot);
 986             listServer.processIncoming();
 987 
 988             // There should now be a duplicate mail
 989             conversations = mailmanList.conversations(Duration.ofDays(1));
 990             assertEquals(2, conversations.size());
 991         }
 992     }
 993 
 994     @Test
 995     void testIssue(TestInfo testInfo) throws IOException {
 996         try (var credentials = new HostCredentials(testInfo);
 997              var tempFolder = new TemporaryDirectory()) {
 998             var repo = credentials.getHostedRepository();
 999             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
1000             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
1001             credentials.commitLock(localRepo);
1002             localRepo.pushAll(repo.url());
1003 
1004             var tagStorage = createTagStorage(repo);
1005             var branchStorage = createBranchStorage(repo);
1006             var prIssuesStorage = createPullRequestIssuesStorage(repo);
1007             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
1008 
1009             var issueProject = credentials.getIssueProject();
1010             var commitIcon = URI.create(&quot;http://www.example.com/commit.png&quot;);
1011             var updater = new IssueUpdater(issueProject, false, null, true, commitIcon, true, null);
1012             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,
1013                                           prIssuesStorage, List.of(updater), List.of(), Set.of(), Map.of());
1014 
1015             // Initialize history
1016             TestBotRunner.runPeriodicItems(notifyBot);
1017 
1018             // Create an issue and commit a fix
1019             var authorEmailAddress = issueProject.issueTracker().currentUser().userName() + &quot;@openjdk.org&quot;;
1020             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));
1021             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;, &quot;Duke&quot;, authorEmailAddress);
1022             localRepo.push(editHash, repo.url(), &quot;master&quot;);
1023             TestBotRunner.runPeriodicItems(notifyBot);
1024 
1025             // The changeset should be reflected in a comment
1026             var updatedIssue = issueProject.issue(issue.id()).orElseThrow();
1027 
1028             var comments = updatedIssue.comments();
1029             assertEquals(1, comments.size());
1030             var comment = comments.get(0);
1031             assertTrue(comment.body().contains(editHash.abbreviate()));
1032 
1033             // And in a link
1034             var links = updatedIssue.links();
1035             assertEquals(1, links.size());
1036             var link = links.get(0);
1037             assertEquals(commitIcon, link.iconUrl().orElseThrow());
1038             assertEquals(&quot;Commit&quot;, link.title().orElseThrow());
1039             assertEquals(repo.webUrl(editHash), link.uri().orElseThrow());
1040 
1041             // As well as a fixVersion
1042             assertEquals(Set.of(&quot;0.1&quot;), fixVersions(updatedIssue));
1043 
1044             // The issue should be assigned and resolved
1045             assertEquals(RESOLVED, updatedIssue.state());
1046             assertEquals(List.of(issueProject.issueTracker().currentUser()), updatedIssue.assignees());
1047         }
1048     }
1049 
1050     @Test
1051     void testIssueNoVersion(TestInfo testInfo) throws IOException {
1052         try (var credentials = new HostCredentials(testInfo);
1053              var tempFolder = new TemporaryDirectory()) {
1054             var repo = credentials.getHostedRepository();
1055             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
1056             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType(), Path.of(&quot;appendable.txt&quot;), Set.of(), null);
1057             credentials.commitLock(localRepo);
1058             localRepo.pushAll(repo.url());
1059 
1060             var tagStorage = createTagStorage(repo);
1061             var branchStorage = createBranchStorage(repo);
1062             var prIssuesStorage = createPullRequestIssuesStorage(repo);
1063             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
1064 
1065             var issueProject = credentials.getIssueProject();
1066             var commitIcon = URI.create(&quot;http://www.example.com/commit.png&quot;);
1067             var updater = new IssueUpdater(issueProject, false, null, true, commitIcon, true, null);
1068             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,
1069                                           prIssuesStorage, List.of(updater), List.of(), Set.of(), Map.of());
1070 
1071             // Initialize history
1072             TestBotRunner.runPeriodicItems(notifyBot);
1073 
1074             // Create an issue and commit a fix
1075             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));
1076             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;);
1077             localRepo.push(editHash, repo.url(), &quot;master&quot;);
1078             TestBotRunner.runPeriodicItems(notifyBot);
1079 
1080             // The changeset should be reflected in a comment
1081             var comments = issue.comments();
1082             assertEquals(1, comments.size());
1083             var comment = comments.get(0);
1084             assertTrue(comment.body().contains(editHash.abbreviate()));
1085 
1086             // But not in the fixVersion
1087             assertEquals(Set.of(), fixVersions(issue));
1088         }
1089     }
1090 
1091     @Test
1092     void testIssueConfiguredVersionNoCommit(TestInfo testInfo) throws IOException {
1093         try (var credentials = new HostCredentials(testInfo);
1094              var tempFolder = new TemporaryDirectory()) {
1095             var repo = credentials.getHostedRepository();
1096             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
1097             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType(), Path.of(&quot;appendable.txt&quot;), Set.of(), null);
1098             credentials.commitLock(localRepo);
1099             localRepo.pushAll(repo.url());
1100 
1101             var tagStorage = createTagStorage(repo);
1102             var branchStorage = createBranchStorage(repo);
1103             var prIssuesStorage = createPullRequestIssuesStorage(repo);
1104             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
1105 
1106             var issueProject = credentials.getIssueProject();
1107             var commitIcon = URI.create(&quot;http://www.example.com/commit.png&quot;);
1108             var updater = new IssueUpdater(issueProject, false, null, false, commitIcon, true, Map.of(&quot;master&quot;, &quot;2.0&quot;));
1109             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,
1110                                           prIssuesStorage, List.of(updater), List.of(), Set.of(), Map.of());
1111 
1112             // Initialize history
1113             TestBotRunner.runPeriodicItems(notifyBot);
1114 
1115             // Create an issue and commit a fix
1116             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));
1117             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;);
1118             localRepo.push(editHash, repo.url(), &quot;master&quot;);
1119             TestBotRunner.runPeriodicItems(notifyBot);
1120 
1121             // The changeset should not reflected in a comment
1122             var comments = issue.comments();
1123             assertEquals(1, comments.size());
1124             var comment = comments.get(0);
1125             assertTrue(comment.body().contains(editHash.abbreviate()));
1126 
1127             // As well as a fixVersion - but not the one from the repo
1128             assertEquals(Set.of(&quot;2.0&quot;), fixVersions(issue));
1129 
1130             // And no commit link
1131             var links = issue.links();
1132             assertEquals(0, links.size());
1133         }
1134     }
1135 
1136     @Test
1137     void testIssueIdempotence(TestInfo testInfo) throws IOException {
1138         try (var credentials = new HostCredentials(testInfo);
1139              var tempFolder = new TemporaryDirectory()) {
1140             var repo = credentials.getHostedRepository();
1141             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
1142             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
1143             credentials.commitLock(localRepo);
1144             localRepo.pushAll(repo.url());
1145 
1146             var tagStorage = createTagStorage(repo);
1147             var branchStorage = createBranchStorage(repo);
1148             var prIssuesStorage = createPullRequestIssuesStorage(repo);
1149             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
1150 
1151             var issueProject = credentials.getIssueProject();
1152             var commitIcon = URI.create(&quot;http://www.example.com/commit.png&quot;);
1153             var updater = new IssueUpdater(issueProject, false, null, true, commitIcon, true, null);
1154             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,
1155                                           prIssuesStorage, List.of(updater), List.of(), Set.of(), Map.of());
1156 
1157             // Initialize history
1158             TestBotRunner.runPeriodicItems(notifyBot);
1159 
1160             // Save the state
1161             var historyState = localRepo.fetch(repo.url(), &quot;history&quot;);
1162 
1163             // Create an issue and commit a fix
1164             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));
1165             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;);
1166             localRepo.push(editHash, repo.url(), &quot;master&quot;);
1167             TestBotRunner.runPeriodicItems(notifyBot);
1168 
1169             // The changeset should be reflected in a comment
1170             var comments = issue.comments();
1171             assertEquals(1, comments.size());
1172             var comment = comments.get(0);
1173             assertTrue(comment.body().contains(editHash.abbreviate()));
1174 
1175             // And in a link
1176             var links = issue.links();
1177             assertEquals(1, links.size());
1178             var link = links.get(0);
1179             assertEquals(commitIcon, link.iconUrl().orElseThrow());
1180             assertEquals(&quot;Commit&quot;, link.title().orElseThrow());
1181             assertEquals(repo.webUrl(editHash), link.uri().orElseThrow());
1182 
1183             // As well as a fixVersion
1184             assertEquals(Set.of(&quot;0.1&quot;), fixVersions(issue));
1185 
1186             // Wipe the history
1187             localRepo.push(historyState, repo.url(), &quot;history&quot;, true);
1188 
1189             // Run it again
1190             TestBotRunner.runPeriodicItems(notifyBot);
1191 
1192             // There should be no new comments, links or fixVersions
1193             var updatedIssue = issueProject.issue(issue.id()).orElseThrow();
1194             assertEquals(1, updatedIssue.comments().size());
1195             assertEquals(1, updatedIssue.links().size());
1196             assertEquals(Set.of(&quot;0.1&quot;), fixVersions(updatedIssue));
1197         }
1198     }
1199 
1200     @Test
1201     void testIssuePoolVersion(TestInfo testInfo) throws IOException {
1202         try (var credentials = new HostCredentials(testInfo);
1203              var tempFolder = new TemporaryDirectory()) {
1204             var repo = credentials.getHostedRepository();
1205             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
1206             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType(), Path.of(&quot;appendable.txt&quot;), Set.of(), null);
1207             credentials.commitLock(localRepo);
1208             localRepo.pushAll(repo.url());
1209 
1210             var tagStorage = createTagStorage(repo);
1211             var branchStorage = createBranchStorage(repo);
1212             var prIssuesStorage = createPullRequestIssuesStorage(repo);
1213             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
1214 
1215             var issueProject = credentials.getIssueProject();
1216             var updater = new IssueUpdater(issueProject, false, null, false, null, true, Map.of(&quot;master&quot;, &quot;12u14&quot;));
1217             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,
1218                                           prIssuesStorage, List.of(updater), List.of(), Set.of(), Map.of());
1219 
1220             // Initialize history
1221             TestBotRunner.runPeriodicItems(notifyBot);
1222 
1223             // Create an issue and commit a fix
1224             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));
1225             issue.setProperty(&quot;fixVersions&quot;, JSON.array().add(&quot;12-pool&quot;).add(&quot;tbd13&quot;).add(&quot;unknown&quot;));
1226 
1227             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;);
1228             localRepo.push(editHash, repo.url(), &quot;master&quot;);
1229             TestBotRunner.runPeriodicItems(notifyBot);
1230 
1231             // The fixVersion should have been updated
1232             assertEquals(Set.of(&quot;12u14&quot;), fixVersions(issue));
1233         }
1234     }
1235 
1236     @Test
1237     void testIssuePoolOpenVersion(TestInfo testInfo) throws IOException {
1238         try (var credentials = new HostCredentials(testInfo);
1239              var tempFolder = new TemporaryDirectory()) {
1240             var repo = credentials.getHostedRepository();
1241             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
1242             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType(), Path.of(&quot;appendable.txt&quot;), Set.of(), null);
1243             credentials.commitLock(localRepo);
1244             localRepo.pushAll(repo.url());
1245 
1246             var tagStorage = createTagStorage(repo);
1247             var branchStorage = createBranchStorage(repo);
1248             var prIssuesStorage = createPullRequestIssuesStorage(repo);
1249             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
1250 
1251             var issueProject = credentials.getIssueProject();
1252             var updater = new IssueUpdater(issueProject, false, null, false, null, true, Map.of(&quot;master&quot;, &quot;12u14&quot;));
1253             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,
1254                                           prIssuesStorage, List.of(updater), List.of(), Set.of(), Map.of());
1255 
1256             // Initialize history
1257             TestBotRunner.runPeriodicItems(notifyBot);
1258 
1259             // Create an issue and commit a fix
1260             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));
1261             issue.setProperty(&quot;fixVersions&quot;, JSON.array().add(&quot;12-pool&quot;).add(&quot;tbd13&quot;).add(&quot;unknown&quot;));
1262 
1263             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;);
1264             localRepo.push(editHash, repo.url(), &quot;master&quot;);
1265             TestBotRunner.runPeriodicItems(notifyBot);
1266 
1267             // The fixVersion should have been updated
1268             assertEquals(Set.of(&quot;12u14&quot;), fixVersions(issue));
1269         }
1270     }
1271 
1272     @Test
1273     void testIssueBackport(TestInfo testInfo) throws IOException {
1274         try (var credentials = new HostCredentials(testInfo);
1275              var tempFolder = new TemporaryDirectory()) {
1276             var repo = credentials.getHostedRepository();
1277             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
1278             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType(), Path.of(&quot;appendable.txt&quot;), Set.of(), null);
1279             credentials.commitLock(localRepo);
1280             localRepo.pushAll(repo.url());
1281 
1282             var tagStorage = createTagStorage(repo);
1283             var branchStorage = createBranchStorage(repo);
1284             var prIssuesStorage = createPullRequestIssuesStorage(repo);
1285             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
1286 
1287             var issueProject = credentials.getIssueProject();
1288             var updater = new IssueUpdater(issueProject, false, null, false, null, true, Map.of(&quot;master&quot;, &quot;12.0.2&quot;));
1289             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,
1290                                           prIssuesStorage, List.of(updater), List.of(), Set.of(), Map.of());
1291 
1292             // Initialize history
1293             TestBotRunner.runPeriodicItems(notifyBot);
1294 
1295             // Create an issue and commit a fix
<a name="1" id="anc1"></a><span class="line-modified">1296             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;),</span>
<span class="line-added">1297                                                  Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;),</span>
<span class="line-added">1298                                                         &quot;customfield_10008&quot;, JSON.object()</span>
<span class="line-added">1299                                                                                  .put(&quot;id&quot;, 244)</span>
<span class="line-added">1300                                                                                  .put(&quot;name&quot;, &quot;java.io&quot;),</span>
<span class="line-added">1301                                                         &quot;customfield_10005&quot;, JSON.array()</span>
<span class="line-added">1302                                                                                  .add(JSON.object()</span>
<span class="line-added">1303                                                                                           .put(&quot;id&quot;, &quot;17010&quot;)</span>
<span class="line-added">1304                                                                                           .put(&quot;value&quot;, &quot;generic&quot;))</span>
<span class="line-added">1305                                                                                  .add(JSON.object()</span>
<span class="line-added">1306                                                                                           .put(&quot;id&quot;, &quot;17019&quot;)</span>
<span class="line-added">1307                                                                                           .put(&quot;value&quot;, &quot;other&quot;))</span>
<span class="line-added">1308                                                  ));</span>
1309             issue.setProperty(&quot;fixVersions&quot;, JSON.array().add(&quot;13.0.1&quot;));
1310             issue.setProperty(&quot;priority&quot;, JSON.of(&quot;1&quot;));
1311 
1312             var authorEmailAddress = issueProject.issueTracker().currentUser().userName() + &quot;@openjdk.org&quot;;
1313             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;, &quot;Duke&quot;, authorEmailAddress);
1314             localRepo.push(editHash, repo.url(), &quot;master&quot;);
1315             TestBotRunner.runPeriodicItems(notifyBot);
1316 
1317             // The fixVersion should not have been updated
1318             var updatedIssue = issueProject.issue(issue.id()).orElseThrow();
1319             assertEquals(Set.of(&quot;13.0.1&quot;), fixVersions(updatedIssue));
1320             assertEquals(OPEN, updatedIssue.state());
1321             assertEquals(List.of(), updatedIssue.assignees());
1322 
1323             // There should be a link
1324             var links = updatedIssue.links();
1325             assertEquals(1, links.size());
1326             var link = links.get(0);
1327             var backport = link.issue().orElseThrow();
1328 
1329             // The backport issue should have a correct fixVersion and assignee
1330             assertEquals(Set.of(&quot;12.0.2&quot;), fixVersions(backport));
1331             assertEquals(RESOLVED, backport.state());
1332             assertEquals(List.of(issueProject.issueTracker().currentUser()), backport.assignees());
1333 
1334             // Custom properties should also propagate
1335             assertEquals(&quot;1&quot;, backport.properties().get(&quot;priority&quot;).asString());
<a name="2" id="anc2"></a><span class="line-added">1336             assertEquals(244, backport.properties().get(&quot;customfield_10008&quot;).get(&quot;id&quot;).asInt());</span>
<span class="line-added">1337             assertEquals(&quot;java.io&quot;, backport.properties().get(&quot;customfield_10008&quot;).get(&quot;name&quot;).asString());</span>
<span class="line-added">1338             assertEquals(2, backport.properties().get(&quot;customfield_10005&quot;).asArray().size());</span>
1339         }
1340     }
1341 
1342     @Test
1343     void testPullRequest(TestInfo testInfo) throws IOException {
1344         try (var credentials = new HostCredentials(testInfo);
1345              var tempFolder = new TemporaryDirectory()) {
1346             var repo = credentials.getHostedRepository();
1347             var reviewer = credentials.getHostedRepository();
1348             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
1349             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
1350             credentials.commitLock(localRepo);
1351             localRepo.pushAll(repo.url());
1352 
1353             var tagStorage = createTagStorage(repo);
1354             var branchStorage = createBranchStorage(repo);
1355             var prIssuesStorage = createPullRequestIssuesStorage(repo);
1356             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
1357 
1358             var issueProject = credentials.getIssueProject();
1359             var reviewIcon = URI.create(&quot;http://www.example.com/review.png&quot;);
1360             var updater = new IssueUpdater(issueProject, true, reviewIcon, false, null, false, null);
1361             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,
1362                                           prIssuesStorage, List.of(), List.of(updater), Set.of(&quot;rfr&quot;),
1363                                           Map.of(reviewer.forge().currentUser().userName(), Pattern.compile(&quot;This is now ready&quot;)));
1364 
1365             // Initialize history
1366             TestBotRunner.runPeriodicItems(notifyBot);
1367 
1368             // Create an issue and a pull request to fix it
1369             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));
1370             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;Fix that issue&quot;);
1371             localRepo.push(editHash, repo.url(), &quot;edit&quot;, true);
1372             var pr = credentials.createPullRequest(repo, &quot;edit&quot;, &quot;master&quot;, issue.id() + &quot;: Fix that issue&quot;);
1373             pr.setBody(&quot;\n\n## Issue\n[&quot; + issue.id() + &quot;](http://www.test.test/): The issue&quot;);
1374             TestBotRunner.runPeriodicItems(notifyBot);
1375 
1376             // The issue should not yet contain a link to the PR
1377             var links = issue.links();
1378             assertEquals(0, links.size());
1379 
1380             // Just a label isn&#39;t enough
1381             pr.addLabel(&quot;rfr&quot;);
1382             TestBotRunner.runPeriodicItems(notifyBot);
1383             links = issue.links();
1384             assertEquals(0, links.size());
1385 
1386             // Neither is just a comment
1387             pr.removeLabel(&quot;rfr&quot;);
1388             var reviewPr = reviewer.pullRequest(pr.id());
1389             reviewPr.addComment(&quot;This is now ready&quot;);
1390             TestBotRunner.runPeriodicItems(notifyBot);
1391             links = issue.links();
1392             assertEquals(0, links.size());
1393 
1394             // Both are needed
1395             pr.addLabel(&quot;rfr&quot;);
1396             TestBotRunner.runPeriodicItems(notifyBot);
1397 
1398             // The issue should now contain a link to the PR
1399             links = issue.links();
1400             assertEquals(1, links.size());
1401             assertEquals(pr.webUrl(), links.get(0).uri().orElseThrow());
1402             assertEquals(reviewIcon, links.get(0).iconUrl().orElseThrow());
1403 
1404             // Add another issue
1405             var issue2 = issueProject.createIssue(&quot;This is another issue&quot;, List.of(&quot;Yes indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));
1406             pr.setBody(&quot;\n\n## Issues\n[&quot; + issue.id() + &quot;](http://www.test.test/): The issue\n[&quot; + issue2.id() +
1407                                &quot;](http://www.test2.test/): The second issue&quot;);
1408             TestBotRunner.runPeriodicItems(notifyBot);
1409 
1410             // Both issues should contain a link to the PR
1411             var links1 = issue.links();
1412             assertEquals(1, links1.size());
1413             assertEquals(pr.webUrl(), links1.get(0).uri().orElseThrow());
1414             var links2 = issue2.links();
1415             assertEquals(1, links2.size());
1416             assertEquals(pr.webUrl(), links2.get(0).uri().orElseThrow());
1417 
1418             // Drop the first one
1419             pr.setBody(&quot;\n\n## Issue\n[&quot; + issue2.id() + &quot;](http://www.test2.test/): That other issue&quot;);
1420             TestBotRunner.runPeriodicItems(notifyBot);
1421 
1422             // Only the second issue should now contain a link to the PR
1423             links1 = issue.links();
1424             assertEquals(0, links1.size());
1425             links2 = issue2.links();
1426             assertEquals(1, links2.size());
1427             assertEquals(pr.webUrl(), links2.get(0).uri().orElseThrow());
1428         }
1429     }
1430 
1431     @Test
1432     void testPullRequestNoReview(TestInfo testInfo) throws IOException {
1433         try (var credentials = new HostCredentials(testInfo);
1434              var tempFolder = new TemporaryDirectory()) {
1435             var repo = credentials.getHostedRepository();
1436             var reviewer = credentials.getHostedRepository();
1437             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
1438             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
1439             credentials.commitLock(localRepo);
1440             localRepo.pushAll(repo.url());
1441 
1442             var tagStorage = createTagStorage(repo);
1443             var branchStorage = createBranchStorage(repo);
1444             var prIssuesStorage = createPullRequestIssuesStorage(repo);
1445             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
1446 
1447             var issueProject = credentials.getIssueProject();
1448             var reviewIcon = URI.create(&quot;http://www.example.com/review.png&quot;);
1449             var updater = new IssueUpdater(issueProject, false, reviewIcon, false, null, false,null);
1450             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,
1451                                           prIssuesStorage, List.of(), List.of(updater), Set.of(&quot;rfr&quot;),
1452                                           Map.of(reviewer.forge().currentUser().userName(), Pattern.compile(&quot;This is now ready&quot;)));
1453             // Initialize history
1454             TestBotRunner.runPeriodicItems(notifyBot);
1455 
1456             // Create an issue and a pull request to fix it
1457             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));
1458             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;Fix that issue&quot;);
1459             localRepo.push(editHash, repo.url(), &quot;edit&quot;, true);
1460             var pr = credentials.createPullRequest(repo, &quot;edit&quot;, &quot;master&quot;, issue.id() + &quot;: Fix that issue&quot;);
1461             pr.setBody(&quot;\n\n## Issue\n[&quot; + issue.id() + &quot;](http://www.test.test/): The issue&quot;);
1462             TestBotRunner.runPeriodicItems(notifyBot);
1463 
1464             // Add required label
1465             pr.addLabel(&quot;rfr&quot;);
1466             TestBotRunner.runPeriodicItems(notifyBot);
1467 
1468             // And the required comment
1469             var reviewPr = reviewer.pullRequest(pr.id());
1470             reviewPr.addComment(&quot;This is now ready&quot;);
1471             TestBotRunner.runPeriodicItems(notifyBot);
1472 
1473             // The issue should still not contain a link to the PR
1474             var links = issue.links();
1475             assertEquals(0, links.size());
1476         }
1477     }
1478 }
<a name="3" id="anc3"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="3" type="hidden" />
</body>
</html>