<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New bots/notify/src/test/java/org/openjdk/skara/bots/notify/UpdaterTests.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
  <body>
    <pre>
   1 /*
   2  * Copyright (c) 2019, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  */
  23 package org.openjdk.skara.bots.notify;
  24 
  25 import org.openjdk.skara.email.*;
  26 import org.openjdk.skara.forge.HostedRepository;
  27 import org.openjdk.skara.issuetracker.Issue;
  28 import org.openjdk.skara.json.*;
  29 import org.openjdk.skara.mailinglist.MailingListServerFactory;
  30 import org.openjdk.skara.storage.StorageBuilder;
  31 import org.openjdk.skara.test.*;
  32 import org.openjdk.skara.vcs.Tag;
  33 
  34 import org.junit.jupiter.api.*;
  35 
  36 import java.io.IOException;
  37 import java.net.URI;
  38 import java.nio.charset.StandardCharsets;
  39 import java.nio.file.*;
  40 import java.time.Duration;
  41 import java.util.*;
  42 import java.util.regex.Pattern;
  43 import java.util.stream.Collectors;
  44 
  45 import static org.junit.jupiter.api.Assertions.*;
  46 import static org.openjdk.skara.issuetracker.Issue.State.*;
  47 
  48 class UpdaterTests {
  49     private List&lt;Path&gt; findJsonFiles(Path folder, String partialName) throws IOException {
  50         return Files.walk(folder)
  51                     .filter(path -&gt; path.toString().endsWith(&quot;.json&quot;))
  52                     .filter(path -&gt; path.toString().contains(partialName))
  53                     .collect(Collectors.toList());
  54     }
  55 
  56     private StorageBuilder&lt;Tag&gt; createTagStorage(HostedRepository repository) {
  57         return new StorageBuilder&lt;Tag&gt;(&quot;tags.txt&quot;)
  58                 .remoteRepository(repository, &quot;history&quot;, &quot;Duke&quot;, &quot;duke@openjdk.java.net&quot;, &quot;Updated tags&quot;);
  59     }
  60 
  61     private StorageBuilder&lt;ResolvedBranch&gt; createBranchStorage(HostedRepository repository) {
  62         return new StorageBuilder&lt;ResolvedBranch&gt;(&quot;branches.txt&quot;)
  63                 .remoteRepository(repository, &quot;history&quot;, &quot;Duke&quot;, &quot;duke@openjdk.java.net&quot;, &quot;Updated branches&quot;);
  64     }
  65 
  66     private StorageBuilder&lt;PullRequestIssues&gt; createPullRequestIssuesStorage(HostedRepository repository) {
  67         return new StorageBuilder&lt;PullRequestIssues&gt;(&quot;prissues.txt&quot;)
  68                 .remoteRepository(repository, &quot;history&quot;, &quot;Duke&quot;, &quot;duke@openjdk.java.net&quot;, &quot;Updated prissues&quot;);
  69     }
  70 
  71     private Set&lt;String&gt; fixVersions(Issue issue) {
  72         if (!issue.properties().containsKey(&quot;fixVersions&quot;)) {
  73             return Set.of();
  74         }
  75         return issue.properties().get(&quot;fixVersions&quot;).stream()
  76                     .map(JSONValue::asString)
  77                     .collect(Collectors.toSet());
  78     }
  79 
  80     @Test
  81     void testJsonUpdaterBranch(TestInfo testInfo) throws IOException {
  82         try (var credentials = new HostCredentials(testInfo);
  83              var tempFolder = new TemporaryDirectory()) {
  84             var repo = credentials.getHostedRepository();
  85             var localRepoFolder = tempFolder.path().resolve(&quot;repo&quot;);
  86             var localRepo = CheckableRepository.init(localRepoFolder, repo.repositoryType());
  87             credentials.commitLock(localRepo);
  88             localRepo.pushAll(repo.url());
  89 
  90             var tagStorage = createTagStorage(repo);
  91             var branchStorage = createBranchStorage(repo);
  92             var prIssuesStorage = createPullRequestIssuesStorage(repo);
  93             var jsonFolder = tempFolder.path().resolve(&quot;json&quot;);
  94             Files.createDirectory(jsonFolder);
  95             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
  96 
  97             var updater = new JsonUpdater(jsonFolder, &quot;12&quot;, &quot;team&quot;);
  98             var notifyBot = NotifyBot.newBuilder()
  99                                      .repository(repo)
 100                                      .storagePath(storageFolder)
 101                                      .branches(Pattern.compile(&quot;master&quot;))
 102                                      .tagStorageBuilder(tagStorage)
 103                                      .branchStorageBuilder(branchStorage)
 104                                      .prIssuesStorageBuilder(prIssuesStorage)
 105                                      .updaters(List.of(updater))
 106                                      .build();
 107 
 108             TestBotRunner.runPeriodicItems(notifyBot);
 109             assertEquals(List.of(), findJsonFiles(jsonFolder, &quot;&quot;));
 110 
 111             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;One more line&quot;, &quot;12345678: Fixes&quot;);
 112             localRepo.push(editHash, repo.url(), &quot;master&quot;);
 113             TestBotRunner.runPeriodicItems(notifyBot);
 114             var jsonFiles = findJsonFiles(jsonFolder, &quot;&quot;);
 115             assertEquals(1, jsonFiles.size());
 116             var jsonData = Files.readString(jsonFiles.get(0), StandardCharsets.UTF_8);
 117             var json = JSON.parse(jsonData);
 118             assertEquals(1, json.asArray().size());
 119             assertEquals(repo.webUrl(editHash).toString(), json.asArray().get(0).get(&quot;url&quot;).asString());
 120             assertEquals(List.of(&quot;12345678&quot;), json.asArray().get(0).get(&quot;issue&quot;).asArray().stream()
 121                                                   .map(JSONValue::asString)
 122                                                   .collect(Collectors.toList()));
 123         }
 124     }
 125 
 126     @Test
 127     void testJsonUpdaterTag(TestInfo testInfo) throws IOException {
 128         try (var credentials = new HostCredentials(testInfo);
 129              var tempFolder = new TemporaryDirectory()) {
 130             var repo = credentials.getHostedRepository();
 131             var localRepoFolder = tempFolder.path().resolve(&quot;repo&quot;);
 132             var localRepo = CheckableRepository.init(localRepoFolder, repo.repositoryType());
 133             credentials.commitLock(localRepo);
 134             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 135             localRepo.tag(masterHash, &quot;jdk-12+1&quot;, &quot;Added tag 1&quot;, &quot;Duke&quot;, &quot;duke@openjdk.java.net&quot;);
 136             localRepo.pushAll(repo.url());
 137 
 138             var tagStorage = createTagStorage(repo);
 139             var branchStorage = createBranchStorage(repo);
 140             var prIssuesStorage = createPullRequestIssuesStorage(repo);
 141             var jsonFolder = tempFolder.path().resolve(&quot;json&quot;);
 142             Files.createDirectory(jsonFolder);
 143             var storageFolder =tempFolder.path().resolve(&quot;storage&quot;);
 144 
 145             var updater = new JsonUpdater(jsonFolder, &quot;12&quot;, &quot;team&quot;);
 146             var notifyBot = NotifyBot.newBuilder()
 147                                      .repository(repo)
 148                                      .storagePath(storageFolder)
 149                                      .branches(Pattern.compile(&quot;master&quot;))
 150                                      .tagStorageBuilder(tagStorage)
 151                                      .branchStorageBuilder(branchStorage)
 152                                      .prIssuesStorageBuilder(prIssuesStorage)
 153                                      .updaters(List.of(updater))
 154                                      .build();
 155 
 156             TestBotRunner.runPeriodicItems(notifyBot);
 157             assertEquals(List.of(), findJsonFiles(jsonFolder, &quot;&quot;));
 158 
 159             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
 160             localRepo.fetch(repo.url(), &quot;history:history&quot;);
 161             localRepo.tag(editHash, &quot;jdk-12+2&quot;, &quot;Added tag 2&quot;, &quot;Duke&quot;, &quot;duke@openjdk.java.net&quot;);
 162             var editHash2 = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;34567890: Even more fixes&quot;);
 163             localRepo.tag(editHash2, &quot;jdk-12+4&quot;, &quot;Added tag 3&quot;, &quot;Duke&quot;, &quot;duke@openjdk.java.net&quot;);
 164             localRepo.pushAll(repo.url());
 165 
 166             TestBotRunner.runPeriodicItems(notifyBot);
 167             var jsonFiles = findJsonFiles(jsonFolder, &quot;&quot;);
 168             assertEquals(3, jsonFiles.size());
 169 
 170             for (var file : jsonFiles) {
 171                 var jsonData = Files.readString(file, StandardCharsets.UTF_8);
 172                 var json = JSON.parse(jsonData);
 173 
 174                 if (json.asArray().get(0).contains(&quot;date&quot;)) {
 175                     assertEquals(2, json.asArray().size());
 176                     assertEquals(List.of(&quot;23456789&quot;), json.asArray().get(0).get(&quot;issue&quot;).asArray().stream()
 177                                                           .map(JSONValue::asString)
 178                                                           .collect(Collectors.toList()));
 179                     assertEquals(repo.webUrl(editHash).toString(), json.asArray().get(0).get(&quot;url&quot;).asString());
 180                     assertEquals(&quot;team&quot;, json.asArray().get(0).get(&quot;build&quot;).asString());
 181                     assertEquals(List.of(&quot;34567890&quot;), json.asArray().get(1).get(&quot;issue&quot;).asArray().stream()
 182                                                           .map(JSONValue::asString)
 183                                                           .collect(Collectors.toList()));
 184                     assertEquals(repo.webUrl(editHash2).toString(), json.asArray().get(1).get(&quot;url&quot;).asString());
 185                     assertEquals(&quot;team&quot;, json.asArray().get(1).get(&quot;build&quot;).asString());
 186                 } else {
 187                     assertEquals(1, json.asArray().size());
 188                     if (json.asArray().get(0).get(&quot;build&quot;).asString().equals(&quot;b02&quot;)) {
 189                         assertEquals(List.of(&quot;23456789&quot;), json.asArray().get(0).get(&quot;issue&quot;).asArray().stream()
 190                                                               .map(JSONValue::asString)
 191                                                               .collect(Collectors.toList()));
 192                     } else {
 193                         assertEquals(&quot;b04&quot;, json.asArray().get(0).get(&quot;build&quot;).asString());
 194                         assertEquals(List.of(&quot;34567890&quot;), json.asArray().get(0).get(&quot;issue&quot;).asArray().stream()
 195                                                               .map(JSONValue::asString)
 196                                                               .collect(Collectors.toList()));
 197                     }
 198                 }
 199             }
 200         }
 201     }
 202 
 203     @Test
 204     void testMailingList(TestInfo testInfo) throws IOException {
 205         try (var listServer = new TestMailmanServer();
 206              var credentials = new HostCredentials(testInfo);
 207              var tempFolder = new TemporaryDirectory()) {
 208             var repo = credentials.getHostedRepository();
 209             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
 210             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
 211             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 212             credentials.commitLock(localRepo);
 213             localRepo.pushAll(repo.url());
 214 
 215             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 216             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 217             var mailmanList = mailmanServer.getList(listAddress.address());
 218             var tagStorage = createTagStorage(repo);
 219             var branchStorage = createBranchStorage(repo);
 220             var prIssuesStorage = createPullRequestIssuesStorage(repo);
 221             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
 222 
 223             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
 224             var updater = MailingListUpdater.newBuilder()
 225                                             .list(mailmanList)
 226                                             .recipient(listAddress)
 227                                             .sender(sender)
 228                                             .reportNewTags(false)
 229                                             .reportNewBranches(false)
 230                                             .reportNewBuilds(false)
 231                                             .headers(Map.of(&quot;extra1&quot;, &quot;value1&quot;, &quot;extra2&quot;, &quot;value2&quot;))
 232                                             .allowedAuthorDomains(Pattern.compile(&quot;none&quot;))
 233                                             .build();
 234             var notifyBot = NotifyBot.newBuilder()
 235                                      .repository(repo)
 236                                      .storagePath(storageFolder)
 237                                      .branches(Pattern.compile(&quot;master&quot;))
 238                                      .tagStorageBuilder(tagStorage)
 239                                      .branchStorageBuilder(branchStorage)
 240                                      .prIssuesStorageBuilder(prIssuesStorage)
 241                                      .updaters(List.of(updater))
 242                                      .build();
 243 
 244             // No mail should be sent on the first run as there is no history
 245             TestBotRunner.runPeriodicItems(notifyBot);
 246             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 247 
 248             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
 249             localRepo.push(editHash, repo.url(), &quot;master&quot;);
 250             TestBotRunner.runPeriodicItems(notifyBot);
 251             listServer.processIncoming();
 252 
 253             var conversations = mailmanList.conversations(Duration.ofDays(1));
 254             var email = conversations.get(0).first();
 255             assertEquals(listAddress, email.sender());
 256             assertEquals(sender, email.author());
 257             assertEquals(email.recipients(), List.of(listAddress));
 258             assertTrue(email.subject().contains(&quot;: 23456789: More fixes&quot;));
 259             assertFalse(email.subject().contains(&quot;master&quot;));
 260             assertTrue(email.body().contains(&quot;Changeset: &quot; + editHash.abbreviate()));
 261             assertTrue(email.body().contains(&quot;23456789: More fixes&quot;));
 262             assertFalse(email.body().contains(&quot;Committer&quot;));
 263             assertFalse(email.body().contains(masterHash.abbreviate()));
 264             assertTrue(email.hasHeader(&quot;extra1&quot;));
 265             assertEquals(&quot;value1&quot;, email.headerValue(&quot;extra1&quot;));
 266             assertTrue(email.hasHeader(&quot;extra2&quot;));
 267             assertEquals(&quot;value2&quot;, email.headerValue(&quot;extra2&quot;));
 268         }
 269     }
 270 
 271     @Test
 272     void testMailingListMultiple(TestInfo testInfo) throws IOException {
 273         try (var listServer = new TestMailmanServer();
 274              var credentials = new HostCredentials(testInfo);
 275              var tempFolder = new TemporaryDirectory()) {
 276             var repo = credentials.getHostedRepository();
 277             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
 278             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
 279             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 280             credentials.commitLock(localRepo);
 281             localRepo.pushAll(repo.url());
 282 
 283             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 284             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 285             var mailmanList = mailmanServer.getList(listAddress.address());
 286             var tagStorage = createTagStorage(repo);
 287             var branchStorage = createBranchStorage(repo);
 288             var prIssuesStorage = createPullRequestIssuesStorage(repo);
 289             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
 290 
 291             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
 292             var updater = MailingListUpdater.newBuilder()
 293                                             .list(mailmanList)
 294                                             .recipient(listAddress)
 295                                             .sender(sender)
 296                                             .reportNewTags(false)
 297                                             .reportNewBranches(false)
 298                                             .reportNewBuilds(false)
 299                                             .build();
 300             var notifyBot = NotifyBot.newBuilder()
 301                                      .repository(repo)
 302                                      .storagePath(storageFolder)
 303                                      .branches(Pattern.compile(&quot;master&quot;))
 304                                      .tagStorageBuilder(tagStorage)
 305                                      .branchStorageBuilder(branchStorage)
 306                                      .prIssuesStorageBuilder(prIssuesStorage)
 307                                      .updaters(List.of(updater))
 308                                      .build();
 309 
 310             // No mail should be sent on the first run as there is no history
 311             TestBotRunner.runPeriodicItems(notifyBot);
 312             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 313 
 314             var editHash1 = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;,
 315                                                                 &quot;first_author&quot;, &quot;first@author.example.com&quot;);
 316             localRepo.push(editHash1, repo.url(), &quot;master&quot;);
 317             var editHash2 = CheckableRepository.appendAndCommit(localRepo, &quot;Yet another line&quot;, &quot;3456789A: Even more fixes&quot;,
 318                                                                 &quot;another_author&quot;, &quot;another@author.example.com&quot;);
 319             localRepo.push(editHash2, repo.url(), &quot;master&quot;);
 320 
 321             TestBotRunner.runPeriodicItems(notifyBot);
 322             listServer.processIncoming();
 323 
 324             var conversations = mailmanList.conversations(Duration.ofDays(1));
 325             var email = conversations.get(0).first();
 326             assertEquals(listAddress, email.sender());
 327             assertEquals(EmailAddress.from(&quot;another_author&quot;, &quot;another@author.example.com&quot;), email.author());
 328             assertEquals(email.recipients(), List.of(listAddress));
 329             assertTrue(email.subject().contains(&quot;: 2 new changesets&quot;));
 330             assertFalse(email.subject().contains(&quot;master&quot;));
 331             assertTrue(email.body().contains(&quot;Changeset: &quot; + editHash1.abbreviate()));
 332             assertTrue(email.body().contains(&quot;23456789: More fixes&quot;));
 333             assertTrue(email.body().contains(&quot;Changeset: &quot; + editHash2.abbreviate()));
 334             assertTrue(email.body().contains(&quot;3456789A: Even more fixes&quot;));
 335             assertFalse(email.body().contains(masterHash.abbreviate()));
 336         }
 337     }
 338 
 339     @Test
 340     void testMailingListSponsored(TestInfo testInfo) throws IOException {
 341         try (var listServer = new TestMailmanServer();
 342              var credentials = new HostCredentials(testInfo);
 343              var tempFolder = new TemporaryDirectory()) {
 344             var repo = credentials.getHostedRepository();
 345             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
 346             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
 347             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 348             credentials.commitLock(localRepo);
 349             localRepo.pushAll(repo.url());
 350 
 351             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 352             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 353             var mailmanList = mailmanServer.getList(listAddress.address());
 354             var tagStorage = createTagStorage(repo);
 355             var branchStorage = createBranchStorage(repo);
 356             var prIssuesStorage = createPullRequestIssuesStorage(repo);
 357             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
 358 
 359             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
 360             var updater = MailingListUpdater.newBuilder()
 361                                             .list(mailmanList)
 362                                             .recipient(listAddress)
 363                                             .sender(sender)
 364                                             .reportNewTags(false)
 365                                             .reportNewBranches(false)
 366                                             .reportNewBuilds(false)
 367                                             .build();
 368             var notifyBot = NotifyBot.newBuilder()
 369                                      .repository(repo)
 370                                      .storagePath(storageFolder)
 371                                      .branches(Pattern.compile(&quot;master&quot;))
 372                                      .tagStorageBuilder(tagStorage)
 373                                      .branchStorageBuilder(branchStorage)
 374                                      .prIssuesStorageBuilder(prIssuesStorage)
 375                                      .updaters(List.of(updater))
 376                                      .build();
 377 
 378             // No mail should be sent on the first run as there is no history
 379             TestBotRunner.runPeriodicItems(notifyBot);
 380             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 381 
 382             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;,
 383                                                                &quot;author&quot;, &quot;author@test.test&quot;,
 384                                                                &quot;committer&quot;, &quot;committer@test.test&quot;);
 385             localRepo.push(editHash, repo.url(), &quot;master&quot;);
 386             TestBotRunner.runPeriodicItems(notifyBot);
 387             listServer.processIncoming();
 388 
 389             var conversations = mailmanList.conversations(Duration.ofDays(1));
 390             var email = conversations.get(0).first();
 391             assertEquals(listAddress, email.sender());
 392             assertEquals(EmailAddress.from(&quot;committer&quot;, &quot;committer@test.test&quot;), email.author());
 393             assertEquals(email.recipients(), List.of(listAddress));
 394             assertTrue(email.body().contains(&quot;Changeset: &quot; + editHash.abbreviate()));
 395             assertTrue(email.body().contains(&quot;23456789: More fixes&quot;));
 396             assertTrue(email.body().contains(&quot;Author:    author &lt;author@test.test&gt;&quot;));
 397             assertTrue(email.body().contains(&quot;Committer: committer &lt;committer@test.test&gt;&quot;));
 398             assertFalse(email.body().contains(masterHash.abbreviate()));
 399         }
 400     }
 401 
 402     @Test
 403     void testMailingListMultipleBranches(TestInfo testInfo) throws IOException {
 404         try (var listServer = new TestMailmanServer();
 405              var credentials = new HostCredentials(testInfo);
 406              var tempFolder = new TemporaryDirectory()) {
 407             var repo = credentials.getHostedRepository();
 408             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
 409             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
 410             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 411             credentials.commitLock(localRepo);
 412             var branch = localRepo.branch(masterHash, &quot;another&quot;);
 413             localRepo.pushAll(repo.url());
 414 
 415             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 416             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 417             var mailmanList = mailmanServer.getList(listAddress.address());
 418             var tagStorage = createTagStorage(repo);
 419             var branchStorage = createBranchStorage(repo);
 420             var prIssuesStorage = createPullRequestIssuesStorage(repo);
 421             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
 422 
 423             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
 424             var author = EmailAddress.from(&quot;author&quot;, &quot;author@duke.duke&quot;);
 425             var updater = MailingListUpdater.newBuilder()
 426                                             .list(mailmanList)
 427                                             .recipient(listAddress)
 428                                             .sender(sender)
 429                                             .author(author)
 430                                             .includeBranch(true)
 431                                             .reportNewTags(false)
 432                                             .reportNewBranches(false)
 433                                             .reportNewBuilds(false)
 434                                             .build();
 435             var notifyBot = NotifyBot.newBuilder()
 436                                      .repository(repo)
 437                                      .storagePath(storageFolder)
 438                                      .branches(Pattern.compile(&quot;master|another&quot;))
 439                                      .tagStorageBuilder(tagStorage)
 440                                      .branchStorageBuilder(branchStorage)
 441                                      .prIssuesStorageBuilder(prIssuesStorage)
 442                                      .updaters(List.of(updater))
 443                                      .build();
 444 
 445             // No mail should be sent on the first run as there is no history
 446             TestBotRunner.runPeriodicItems(notifyBot);
 447             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 448 
 449             var editHash1 = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
 450             localRepo.push(editHash1, repo.url(), &quot;master&quot;);
 451             var editHash2 = CheckableRepository.appendAndCommit(localRepo, &quot;Yet another line&quot;, &quot;3456789A: Even more fixes&quot;);
 452             localRepo.push(editHash2, repo.url(), &quot;master&quot;);
 453 
 454             TestBotRunner.runPeriodicItems(notifyBot);
 455             listServer.processIncoming();
 456 
 457             var conversations = mailmanList.conversations(Duration.ofDays(1));
 458             var email = conversations.get(0).first();
 459             assertEquals(listAddress, email.sender());
 460             assertEquals(author, email.author());
 461             assertEquals(email.recipients(), List.of(listAddress));
 462             assertFalse(email.subject().contains(&quot;another&quot;));
 463             assertTrue(email.subject().contains(&quot;: master: 2 new changesets&quot;));
 464             assertTrue(email.body().contains(&quot;Changeset: &quot; + editHash1.abbreviate()));
 465             assertTrue(email.body().contains(&quot;23456789: More fixes&quot;));
 466             assertTrue(email.body().contains(&quot;Changeset: &quot; + editHash2.abbreviate()));
 467             assertTrue(email.body().contains(&quot;3456789A: Even more fixes&quot;));
 468             assertFalse(email.body().contains(masterHash.abbreviate()));
 469             assertFalse(email.body().contains(&quot;456789AB: Yet more fixes&quot;));
 470 
 471             localRepo.checkout(branch, true);
 472             var editHash3 = CheckableRepository.appendAndCommit(localRepo, &quot;Another branch&quot;, &quot;456789AB: Yet more fixes&quot;);
 473             localRepo.push(editHash3, repo.url(), &quot;another&quot;);
 474 
 475             TestBotRunner.runPeriodicItems(notifyBot);
 476             listServer.processIncoming();
 477 
 478             conversations = mailmanList.conversations(Duration.ofDays(1));
 479             conversations.sort(Comparator.comparing(conversation -&gt; conversation.first().subject()));
 480             email = conversations.get(0).first();
 481             assertEquals(author, email.author());
 482             assertEquals(listAddress, email.sender());
 483             assertEquals(email.recipients(), List.of(listAddress));
 484             assertTrue(email.subject().contains(&quot;: another: 456789AB: Yet more fixes&quot;));
 485             assertFalse(email.subject().contains(&quot;master&quot;));
 486             assertTrue(email.body().contains(&quot;Changeset: &quot; + editHash3.abbreviate()));
 487             assertTrue(email.body().contains(&quot;456789AB: Yet more fixes&quot;));
 488             assertFalse(email.body().contains(&quot;Changeset: &quot; + editHash2.abbreviate()));
 489             assertFalse(email.body().contains(&quot;3456789A: Even more fixes&quot;));
 490         }
 491     }
 492 
 493     @Test
 494     void testMailingListPROnly(TestInfo testInfo) throws IOException {
 495         try (var listServer = new TestMailmanServer();
 496              var credentials = new HostCredentials(testInfo);
 497              var tempFolder = new TemporaryDirectory()) {
 498             var repo = credentials.getHostedRepository();
 499             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
 500             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
 501             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 502             credentials.commitLock(localRepo);
 503             localRepo.pushAll(repo.url());
 504 
 505             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 506             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 507             var mailmanList = mailmanServer.getList(listAddress.address());
 508             var tagStorage = createTagStorage(repo);
 509             var branchStorage = createBranchStorage(repo);
 510             var prIssuesStorage = createPullRequestIssuesStorage(repo);
 511             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
 512 
 513             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
 514             var author = EmailAddress.from(&quot;author&quot;, &quot;author@duke.duke&quot;);
 515             var updater = MailingListUpdater.newBuilder()
 516                                             .list(mailmanList)
 517                                             .recipient(listAddress)
 518                                             .sender(sender)
 519                                             .author(author)
 520                                             .reportNewTags(false)
 521                                             .reportNewBranches(false)
 522                                             .reportNewBuilds(false)
 523                                             .mode(MailingListUpdater.Mode.PR_ONLY)
 524                                             .headers(Map.of(&quot;extra1&quot;, &quot;value1&quot;))
 525                                             .build();
 526             var notifyBot = NotifyBot.newBuilder()
 527                                      .repository(repo)
 528                                      .storagePath(storageFolder)
 529                                      .branches(Pattern.compile(&quot;master&quot;))
 530                                      .tagStorageBuilder(tagStorage)
 531                                      .branchStorageBuilder(branchStorage)
 532                                      .prIssuesStorageBuilder(prIssuesStorage)
 533                                      .updaters(List.of(updater))
 534                                      .build();
 535 
 536             // No mail should be sent on the first run as there is no history
 537             TestBotRunner.runPeriodicItems(notifyBot);
 538             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 539 
 540             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
 541             localRepo.push(editHash, repo.url(), &quot;edit&quot;);
 542             var pr = credentials.createPullRequest(repo, &quot;master&quot;, &quot;edit&quot;, &quot;RFR: My PR&quot;);
 543 
 544             // Create a potentially conflicting one
 545             var otherHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
 546             localRepo.push(otherHash, repo.url(), &quot;other&quot;);
 547             var otherPr = credentials.createPullRequest(repo, &quot;master&quot;, &quot;other&quot;, &quot;RFR: My other PR&quot;);
 548 
 549             // PR hasn&#39;t been integrated yet, so there should be no mail
 550             TestBotRunner.runPeriodicItems(notifyBot);
 551             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 552 
 553             // Simulate an RFR email
 554             var rfr = Email.create(sender, &quot;RFR: My PR&quot;, &quot;PR: &quot; + pr.webUrl().toString())
 555                     .recipient(listAddress)
 556                     .build();
 557             mailmanList.post(rfr);
 558             listServer.processIncoming();
 559 
 560             // And an integration
 561             pr.addComment(&quot;Pushed as commit &quot; + editHash.hex() + &quot;.&quot;);
 562             localRepo.push(editHash, repo.url(), &quot;master&quot;);
 563             TestBotRunner.runPeriodicItems(notifyBot);
 564             listServer.processIncoming();
 565 
 566             var conversations = mailmanList.conversations(Duration.ofDays(1));
 567             assertEquals(1, conversations.size());
 568             var first = conversations.get(0).first();
 569             var email = conversations.get(0).replies(first).get(0);
 570             assertEquals(listAddress, email.sender());
 571             assertEquals(author, email.author());
 572             assertEquals(email.recipients(), List.of(listAddress));
 573             assertEquals(&quot;[Integrated] RFR: My PR&quot;, email.subject());
 574             assertFalse(email.subject().contains(&quot;master&quot;));
 575             assertTrue(email.body().contains(&quot;Changeset: &quot; + editHash.abbreviate()));
 576             assertTrue(email.body().contains(&quot;23456789: More fixes&quot;));
 577             assertFalse(email.body().contains(&quot;Committer&quot;));
 578             assertFalse(email.body().contains(masterHash.abbreviate()));
 579             assertTrue(email.hasHeader(&quot;extra1&quot;));
 580             assertEquals(&quot;value1&quot;, email.headerValue(&quot;extra1&quot;));
 581 
 582             // Now push the other one without a matching PR - PR_ONLY will not generate a mail
 583             localRepo.push(otherHash, repo.url(), &quot;master&quot;);
 584             TestBotRunner.runPeriodicItems(notifyBot);
 585             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofSeconds(1)));
 586         }
 587     }
 588 
 589     @Test
 590     void testMailingListPR(TestInfo testInfo) throws IOException {
 591         try (var listServer = new TestMailmanServer();
 592              var credentials = new HostCredentials(testInfo);
 593              var tempFolder = new TemporaryDirectory()) {
 594             var repo = credentials.getHostedRepository();
 595             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
 596             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
 597             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 598             credentials.commitLock(localRepo);
 599             localRepo.pushAll(repo.url());
 600 
 601             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 602             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 603             var mailmanList = mailmanServer.getList(listAddress.address());
 604             var tagStorage = createTagStorage(repo);
 605             var branchStorage = createBranchStorage(repo);
 606             var prIssuesStorage = createPullRequestIssuesStorage(repo);
 607             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
 608 
 609             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
 610             var updater = MailingListUpdater.newBuilder()
 611                                             .list(mailmanList)
 612                                             .recipient(listAddress)
 613                                             .sender(sender)
 614                                             .reportNewTags(false)
 615                                             .reportNewBranches(false)
 616                                             .reportNewBuilds(false)
 617                                             .mode(MailingListUpdater.Mode.PR)
 618                                             .build();
 619             var notifyBot = NotifyBot.newBuilder()
 620                                      .repository(repo)
 621                                      .storagePath(storageFolder)
 622                                      .branches(Pattern.compile(&quot;master&quot;))
 623                                      .tagStorageBuilder(tagStorage)
 624                                      .branchStorageBuilder(branchStorage)
 625                                      .prIssuesStorageBuilder(prIssuesStorage)
 626                                      .updaters(List.of(updater))
 627                                      .build();
 628 
 629             // No mail should be sent on the first run as there is no history
 630             TestBotRunner.runPeriodicItems(notifyBot);
 631             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 632 
 633             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
 634             localRepo.push(editHash, repo.url(), &quot;edit&quot;);
 635             var pr = credentials.createPullRequest(repo, &quot;master&quot;, &quot;edit&quot;, &quot;RFR: My PR&quot;);
 636 
 637             // Create a potentially conflicting one
 638             var otherHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
 639             localRepo.push(otherHash, repo.url(), &quot;other&quot;);
 640             var otherPr = credentials.createPullRequest(repo, &quot;master&quot;, &quot;other&quot;, &quot;RFR: My other PR&quot;);
 641 
 642             // PR hasn&#39;t been integrated yet, so there should be no mail
 643             TestBotRunner.runPeriodicItems(notifyBot);
 644             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 645 
 646             // Simulate an RFR email
 647             var rfr = Email.create(&quot;RFR: My PR&quot;, &quot;PR:\n&quot; + pr.webUrl().toString())
 648                            .author(EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;))
 649                            .recipient(listAddress)
 650                            .build();
 651             mailmanList.post(rfr);
 652             listServer.processIncoming();
 653 
 654             // And an integration
 655             pr.addComment(&quot;Pushed as commit &quot; + editHash.hex() + &quot;.&quot;);
 656             localRepo.push(editHash, repo.url(), &quot;master&quot;);
 657 
 658             // Push the other one without a matching PR
 659             localRepo.push(otherHash, repo.url(), &quot;master&quot;);
 660 
 661             TestBotRunner.runPeriodicItems(notifyBot);
 662             listServer.processIncoming();
 663             listServer.processIncoming();
 664 
 665             var conversations = mailmanList.conversations(Duration.ofDays(1));
 666             conversations.sort(Comparator.comparing(conversation -&gt; conversation.first().subject()));
 667             assertEquals(2, conversations.size());
 668 
 669             var prConversation = conversations.get(0);
 670             var pushConversation = conversations.get(1);
 671 
 672             var prEmail = prConversation.replies(prConversation.first()).get(0);
 673             assertEquals(listAddress, prEmail.sender());
 674             assertEquals(EmailAddress.from(&quot;testauthor&quot;, &quot;ta@none.none&quot;), prEmail.author());
 675             assertEquals(prEmail.recipients(), List.of(listAddress));
 676             assertEquals(&quot;[Integrated] RFR: My PR&quot;, prEmail.subject());
 677             assertFalse(prEmail.subject().contains(&quot;master&quot;));
 678             assertTrue(prEmail.body().contains(&quot;Changeset: &quot; + editHash.abbreviate()));
 679             assertTrue(prEmail.body().contains(&quot;23456789: More fixes&quot;));
 680             assertFalse(prEmail.body().contains(&quot;Committer&quot;));
 681             assertFalse(prEmail.body().contains(masterHash.abbreviate()));
 682 
 683             var pushEmail = pushConversation.first();
 684             assertEquals(listAddress, pushEmail.sender());
 685             assertEquals(EmailAddress.from(&quot;testauthor&quot;, &quot;ta@none.none&quot;), pushEmail.author());
 686             assertEquals(pushEmail.recipients(), List.of(listAddress));
 687             assertTrue(pushEmail.subject().contains(&quot;23456789: More fixes&quot;));
 688         }
 689     }
 690 
 691     @Test
 692     void testMailingListPROnce(TestInfo testInfo) throws IOException {
 693         try (var listServer = new TestMailmanServer();
 694              var credentials = new HostCredentials(testInfo);
 695              var tempFolder = new TemporaryDirectory()) {
 696             var repo = credentials.getHostedRepository();
 697             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
 698             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
 699             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 700             localRepo.branch(masterHash, &quot;other&quot;);
 701             credentials.commitLock(localRepo);
 702             localRepo.pushAll(repo.url());
 703 
 704             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 705             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 706             var mailmanList = mailmanServer.getList(listAddress.address());
 707             var tagStorage = createTagStorage(repo);
 708             var branchStorage = createBranchStorage(repo);
 709             var prIssuesStorage = createPullRequestIssuesStorage(repo);
 710             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
 711 
 712             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
 713             var updater = MailingListUpdater.newBuilder()
 714                                             .list(mailmanList)
 715                                             .recipient(listAddress)
 716                                             .sender(sender)
 717                                             .author(null)
 718                                             .reportNewTags(false)
 719                                             .reportNewBranches(false)
 720                                             .reportNewBuilds(false)
 721                                             .mode(MailingListUpdater.Mode.PR)
 722                                             .build();
 723             var notifyBot = NotifyBot.newBuilder()
 724                                      .repository(repo)
 725                                      .storagePath(storageFolder)
 726                                      .branches(Pattern.compile(&quot;master|other&quot;))
 727                                      .tagStorageBuilder(tagStorage)
 728                                      .branchStorageBuilder(branchStorage)
 729                                      .prIssuesStorageBuilder(prIssuesStorage)
 730                                      .updaters(List.of(updater))
 731                                      .build();
 732 
 733             // No mail should be sent on the first run as there is no history
 734             TestBotRunner.runPeriodicItems(notifyBot);
 735             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 736 
 737             localRepo.checkout(masterHash, true);
 738             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
 739             localRepo.push(editHash, repo.url(), &quot;edit&quot;);
 740             var pr = credentials.createPullRequest(repo, &quot;master&quot;, &quot;edit&quot;, &quot;RFR: My PR&quot;);
 741 
 742             // PR hasn&#39;t been integrated yet, so there should be no mail
 743             TestBotRunner.runPeriodicItems(notifyBot);
 744             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 745 
 746             // Simulate an RFR email
 747             var rfr = Email.create(&quot;RFR: My PR&quot;, &quot;PR:\n&quot; + pr.webUrl().toString())
 748                            .author(EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;))
 749                            .recipient(listAddress)
 750                            .build();
 751             mailmanList.post(rfr);
 752             listServer.processIncoming();
 753 
 754             // And an integration
 755             pr.addComment(&quot;Pushed as commit &quot; + editHash.hex() + &quot;.&quot;);
 756             localRepo.push(editHash, repo.url(), &quot;master&quot;, true);
 757 
 758             TestBotRunner.runPeriodicItems(notifyBot);
 759             listServer.processIncoming();
 760 
 761             var conversations = mailmanList.conversations(Duration.ofDays(1));
 762             assertEquals(1, conversations.size());
 763 
 764             var prConversation = conversations.get(0);
 765             var prEmail = prConversation.replies(prConversation.first()).get(0);
 766             assertEquals(listAddress, prEmail.sender());
 767             assertEquals(EmailAddress.from(&quot;testauthor&quot;, &quot;ta@none.none&quot;), prEmail.author());
 768             assertEquals(prEmail.recipients(), List.of(listAddress));
 769             assertEquals(&quot;[Integrated] RFR: My PR&quot;, prEmail.subject());
 770             assertFalse(prEmail.subject().contains(&quot;master&quot;));
 771             assertTrue(prEmail.body().contains(&quot;Changeset: &quot; + editHash.abbreviate()));
 772             assertTrue(prEmail.body().contains(&quot;23456789: More fixes&quot;));
 773             assertFalse(prEmail.body().contains(&quot;Committer&quot;));
 774             assertFalse(prEmail.body().contains(masterHash.abbreviate()));
 775 
 776             // Now push the change to another monitored branch
 777             localRepo.push(editHash, repo.url(), &quot;other&quot;, true);
 778             TestBotRunner.runPeriodicItems(notifyBot);
 779             listServer.processIncoming();
 780 
 781             // The change should now end up as a separate notification thread
 782             conversations = mailmanList.conversations(Duration.ofDays(1));
 783             conversations.sort(Comparator.comparing(conversation -&gt; conversation.first().subject()));
 784             assertEquals(2, conversations.size());
 785 
 786             var pushConversation = conversations.get(1);
 787             var pushEmail = pushConversation.first();
 788             assertEquals(listAddress, pushEmail.sender());
 789             assertEquals(EmailAddress.from(&quot;testauthor&quot;, &quot;ta@none.none&quot;), pushEmail.author());
 790             assertEquals(pushEmail.recipients(), List.of(listAddress));
 791             assertTrue(pushEmail.subject().contains(&quot;23456789: More fixes&quot;));
 792         }
 793     }
 794 
 795     @Test
 796     void testMailinglistTag(TestInfo testInfo) throws IOException {
 797         try (var credentials = new HostCredentials(testInfo);
 798              var tempFolder = new TemporaryDirectory();
 799              var listServer = new TestMailmanServer()) {
 800             var repo = credentials.getHostedRepository();
 801             var localRepoFolder = tempFolder.path().resolve(&quot;repo&quot;);
 802             var localRepo = CheckableRepository.init(localRepoFolder, repo.repositoryType());
 803             credentials.commitLock(localRepo);
 804             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 805             localRepo.tag(masterHash, &quot;jdk-12+1&quot;, &quot;Added tag 1&quot;, &quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;);
 806             localRepo.pushAll(repo.url());
 807 
 808             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 809             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 810             var mailmanList = mailmanServer.getList(listAddress.address());
 811             var tagStorage = createTagStorage(repo);
 812             var branchStorage = createBranchStorage(repo);
 813             var prIssuesStorage = createPullRequestIssuesStorage(repo);
 814             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
 815 
 816             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
 817             var updater = MailingListUpdater.newBuilder()
 818                                             .list(mailmanList)
 819                                             .recipient(listAddress)
 820                                             .sender(sender)
 821                                             .reportNewBranches(false)
 822                                             .headers(Map.of(&quot;extra1&quot;, &quot;value1&quot;, &quot;extra2&quot;, &quot;value2&quot;))
 823                                             .build();
 824             var prOnlyUpdater = MailingListUpdater.newBuilder()
 825                                                   .list(mailmanList)
 826                                                   .recipient(listAddress)
 827                                                   .sender(sender)
 828                                                   .reportNewTags(false)
 829                                                   .reportNewBranches(false)
 830                                                   .reportNewBuilds(false)
 831                                                   .mode(MailingListUpdater.Mode.PR_ONLY)
 832                                                   .build();
 833             var notifyBot = NotifyBot.newBuilder()
 834                                      .repository(repo)
 835                                      .storagePath(storageFolder)
 836                                      .branches(Pattern.compile(&quot;master&quot;))
 837                                      .tagStorageBuilder(tagStorage)
 838                                      .branchStorageBuilder(branchStorage)
 839                                      .prIssuesStorageBuilder(prIssuesStorage)
 840                                      .updaters(List.of(updater, prOnlyUpdater))
 841                                      .build();
 842 
 843             // No mail should be sent on the first run as there is no history
 844             TestBotRunner.runPeriodicItems(notifyBot);
 845             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 846 
 847             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
 848             localRepo.fetch(repo.url(), &quot;history:history&quot;);
 849             localRepo.tag(editHash, &quot;jdk-12+2&quot;, &quot;Added tag 2&quot;, &quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;);
 850             CheckableRepository.appendAndCommit(localRepo, &quot;Another line 1&quot;, &quot;34567890: Even more fixes&quot;);
 851             CheckableRepository.appendAndCommit(localRepo, &quot;Another line 2&quot;, &quot;45678901: Yet even more fixes&quot;);
 852             var editHash2 = CheckableRepository.appendAndCommit(localRepo, &quot;Another line 3&quot;, &quot;56789012: Still even more fixes&quot;);
 853             localRepo.tag(editHash2, &quot;jdk-12+4&quot;, &quot;Added tag 3&quot;, &quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;);
 854             CheckableRepository.appendAndCommit(localRepo, &quot;Another line 4&quot;, &quot;67890123: Brand new fixes&quot;);
 855             var editHash3 = CheckableRepository.appendAndCommit(localRepo, &quot;Another line 5&quot;, &quot;78901234: More brand new fixes&quot;);
 856             localRepo.tag(editHash3, &quot;jdk-13+0&quot;, &quot;Added tag 4&quot;, &quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;);
 857             localRepo.pushAll(repo.url());
 858 
 859             TestBotRunner.runPeriodicItems(notifyBot);
 860             listServer.processIncoming();
 861             listServer.processIncoming();
 862             listServer.processIncoming();
 863             listServer.processIncoming();
 864 
 865             var conversations = mailmanList.conversations(Duration.ofDays(1));
 866             assertEquals(4, conversations.size());
 867 
 868             for (var conversation : conversations) {
 869                 var email = conversation.first();
 870                 if (email.subject().equals(&quot;git: test: Added tag jdk-12+2 for changeset &quot; + editHash.abbreviate())) {
 871                     assertTrue(email.body().contains(&quot;23456789: More fixes&quot;));
 872                     assertFalse(email.body().contains(&quot;34567890: Even more fixes&quot;));
 873                     assertFalse(email.body().contains(&quot;45678901: Yet even more fixes&quot;));
 874                     assertFalse(email.body().contains(&quot;56789012: Still even more fixes&quot;));
 875                     assertFalse(email.body().contains(&quot;67890123: Brand new fixes&quot;));
 876                     assertFalse(email.body().contains(&quot;78901234: More brand new fixes&quot;));
 877                     assertEquals(EmailAddress.from(&quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;), email.author());
 878                 } else if (email.subject().equals(&quot;git: test: Added tag jdk-12+4 for changeset &quot; + editHash2.abbreviate())) {
 879                     assertFalse(email.body().contains(&quot;23456789: More fixes&quot;));
 880                     assertTrue(email.body().contains(&quot;34567890: Even more fixes&quot;));
 881                     assertTrue(email.body().contains(&quot;45678901: Yet even more fixes&quot;));
 882                     assertTrue(email.body().contains(&quot;56789012: Still even more fixes&quot;));
 883                     assertFalse(email.body().contains(&quot;67890123: Brand new fixes&quot;));
 884                     assertFalse(email.body().contains(&quot;78901234: More brand new fixes&quot;));
 885                     assertEquals(EmailAddress.from(&quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;), email.author());
 886                 } else if (email.subject().equals(&quot;git: test: Added tag jdk-13+0 for changeset &quot; + editHash3.abbreviate())) {
 887                     assertFalse(email.body().contains(&quot;23456789: More fixes&quot;));
 888                     assertFalse(email.body().contains(&quot;34567890: Even more fixes&quot;));
 889                     assertFalse(email.body().contains(&quot;45678901: Yet even more fixes&quot;));
 890                     assertFalse(email.body().contains(&quot;56789012: Still even more fixes&quot;));
 891                     assertFalse(email.body().contains(&quot;67890123: Brand new fixes&quot;));
 892                     assertTrue(email.body().contains(&quot;78901234: More brand new fixes&quot;));
 893                     assertEquals(EmailAddress.from(&quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;), email.author());
 894                 } else if (email.subject().equals(&quot;git: test: 6 new changesets&quot;)) {
 895                     assertTrue(email.body().contains(&quot;23456789: More fixes&quot;));
 896                     assertTrue(email.body().contains(&quot;34567890: Even more fixes&quot;));
 897                     assertTrue(email.body().contains(&quot;45678901: Yet even more fixes&quot;));
 898                     assertTrue(email.body().contains(&quot;56789012: Still even more fixes&quot;));
 899                     assertTrue(email.body().contains(&quot;67890123: Brand new fixes&quot;));
 900                     assertTrue(email.body().contains(&quot;78901234: More brand new fixes&quot;));
 901                     assertEquals(EmailAddress.from(&quot;testauthor&quot;, &quot;ta@none.none&quot;), email.author());
 902                 } else {
 903                     fail(&quot;Mismatched subject: &quot; + email.subject());
 904                 }
 905                 assertTrue(email.hasHeader(&quot;extra1&quot;));
 906                 assertEquals(&quot;value1&quot;, email.headerValue(&quot;extra1&quot;));
 907                 assertTrue(email.hasHeader(&quot;extra2&quot;));
 908                 assertEquals(&quot;value2&quot;, email.headerValue(&quot;extra2&quot;));
 909             }
 910         }
 911     }
 912 
 913     @Test
 914     void testMailinglistPlainTags(TestInfo testInfo) throws IOException {
 915         try (var credentials = new HostCredentials(testInfo);
 916              var tempFolder = new TemporaryDirectory();
 917              var listServer = new TestMailmanServer()) {
 918             var repo = credentials.getHostedRepository();
 919             var localRepoFolder = tempFolder.path().resolve(&quot;repo&quot;);
 920             var localRepo = CheckableRepository.init(localRepoFolder, repo.repositoryType());
 921             credentials.commitLock(localRepo);
 922             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 923             localRepo.tag(masterHash, &quot;jdk-12+1&quot;, &quot;Added tag 1&quot;, &quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;);
 924             localRepo.pushAll(repo.url());
 925 
 926             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 927             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 928             var mailmanList = mailmanServer.getList(listAddress.address());
 929             var tagStorage = createTagStorage(repo);
 930             var branchStorage = createBranchStorage(repo);
 931             var prIssuesStorage = createPullRequestIssuesStorage(repo);
 932             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
 933 
 934             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
 935             var updater = MailingListUpdater.newBuilder()
 936                                             .list(mailmanList)
 937                                             .recipient(listAddress)
 938                                             .sender(sender)
 939                                             .reportNewBranches(false)
 940                                             .reportNewBuilds(false)
 941                                             .headers(Map.of(&quot;extra1&quot;, &quot;value1&quot;, &quot;extra2&quot;, &quot;value2&quot;))
 942                                             .build();
 943             var prOnlyUpdater = MailingListUpdater.newBuilder()
 944                                                   .list(mailmanList)
 945                                                   .recipient(listAddress)
 946                                                   .sender(sender)
 947                                                   .reportNewTags(false)
 948                                                   .reportNewBranches(false)
 949                                                   .reportNewBuilds(false)
 950                                                   .mode(MailingListUpdater.Mode.PR_ONLY)
 951                                                   .build();
 952             var notifyBot = NotifyBot.newBuilder()
 953                                      .repository(repo)
 954                                      .storagePath(storageFolder)
 955                                      .branches(Pattern.compile(&quot;master&quot;))
 956                                      .tagStorageBuilder(tagStorage)
 957                                      .branchStorageBuilder(branchStorage)
 958                                      .prIssuesStorageBuilder(prIssuesStorage)
 959                                      .updaters(List.of(updater, prOnlyUpdater))
 960                                      .build();
 961 
 962             // No mail should be sent on the first run as there is no history
 963             TestBotRunner.runPeriodicItems(notifyBot);
 964             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 965 
 966             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
 967             localRepo.fetch(repo.url(), &quot;history:history&quot;);
 968             localRepo.tag(editHash, &quot;jdk-12+2&quot;, &quot;Added tag 2&quot;, &quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;);
 969             CheckableRepository.appendAndCommit(localRepo, &quot;Another line 1&quot;, &quot;34567890: Even more fixes&quot;);
 970             CheckableRepository.appendAndCommit(localRepo, &quot;Another line 2&quot;, &quot;45678901: Yet even more fixes&quot;);
 971             var editHash2 = CheckableRepository.appendAndCommit(localRepo, &quot;Another line 3&quot;, &quot;56789012: Still even more fixes&quot;);
 972             localRepo.tag(editHash2, &quot;jdk-12+4&quot;, &quot;Added tag 3&quot;, &quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;);
 973             CheckableRepository.appendAndCommit(localRepo, &quot;Another line 4&quot;, &quot;67890123: Brand new fixes&quot;);
 974             var editHash3 = CheckableRepository.appendAndCommit(localRepo, &quot;Another line 5&quot;, &quot;78901234: More brand new fixes&quot;);
 975             localRepo.tag(editHash3, &quot;jdk-13+0&quot;, &quot;Added tag 4&quot;, &quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;);
 976             localRepo.pushAll(repo.url());
 977 
 978             TestBotRunner.runPeriodicItems(notifyBot);
 979             listServer.processIncoming();
 980             listServer.processIncoming();
 981             listServer.processIncoming();
 982             listServer.processIncoming();
 983 
 984             var conversations = mailmanList.conversations(Duration.ofDays(1));
 985             assertEquals(4, conversations.size());
 986 
 987             for (var conversation : conversations) {
 988                 var email = conversation.first();
 989                 if (email.subject().equals(&quot;git: test: Added tag jdk-12+2 for changeset &quot; + editHash.abbreviate())) {
 990                     assertEquals(EmailAddress.from(&quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;), email.author());
 991                 } else if (email.subject().equals(&quot;git: test: Added tag jdk-12+4 for changeset &quot; + editHash2.abbreviate())) {
 992                     assertEquals(EmailAddress.from(&quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;), email.author());
 993                 } else if (email.subject().equals(&quot;git: test: Added tag jdk-13+0 for changeset &quot; + editHash3.abbreviate())) {
 994                     assertEquals(EmailAddress.from(&quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;), email.author());
 995                 } else if (email.subject().equals(&quot;git: test: 6 new changesets&quot;)) {
 996                     assertEquals(EmailAddress.from(&quot;testauthor&quot;, &quot;ta@none.none&quot;), email.author());
 997                 } else {
 998                     fail(&quot;Mismatched subject: &quot; + email.subject());
 999                 }
1000                 assertTrue(email.hasHeader(&quot;extra1&quot;));
1001                 assertEquals(&quot;value1&quot;, email.headerValue(&quot;extra1&quot;));
1002                 assertTrue(email.hasHeader(&quot;extra2&quot;));
1003                 assertEquals(&quot;value2&quot;, email.headerValue(&quot;extra2&quot;));
1004             }
1005         }
1006     }
1007 
1008     @Test
1009     void testMailingListBranch(TestInfo testInfo) throws IOException {
1010         try (var listServer = new TestMailmanServer();
1011              var credentials = new HostCredentials(testInfo);
1012              var tempFolder = new TemporaryDirectory()) {
1013             var repo = credentials.getHostedRepository();
1014             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
1015             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
1016             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1017             credentials.commitLock(localRepo);
1018             localRepo.pushAll(repo.url());
1019 
1020             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1021             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
1022             var mailmanList = mailmanServer.getList(listAddress.address());
1023             var tagStorage = createTagStorage(repo);
1024             var branchStorage = createBranchStorage(repo);
1025             var prIssuesStorage = createPullRequestIssuesStorage(repo);
1026             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
1027 
1028             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
1029             var updater = MailingListUpdater.newBuilder()
1030                                             .list(mailmanList)
1031                                             .recipient(listAddress)
1032                                             .sender(sender)
1033                                             .reportNewTags(false)
1034                                             .reportNewBuilds(false)
1035                                             .headers(Map.of(&quot;extra1&quot;, &quot;value1&quot;, &quot;extra2&quot;, &quot;value2&quot;))
1036                                             .build();
1037             var notifyBot = NotifyBot.newBuilder()
1038                                      .repository(repo)
1039                                      .storagePath(storageFolder)
1040                                      .branches(Pattern.compile(&quot;master|newbranch.&quot;))
1041                                      .tagStorageBuilder(tagStorage)
1042                                      .branchStorageBuilder(branchStorage)
1043                                      .prIssuesStorageBuilder(prIssuesStorage)
1044                                      .updaters(List.of(updater))
1045                                      .build();
1046 
1047             // No mail should be sent on the first run as there is no history
1048             TestBotRunner.runPeriodicItems(notifyBot);
1049             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
1050 
1051             CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;12345678: Some fixes&quot;);
1052             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
1053             localRepo.push(editHash, repo.url(), &quot;newbranch1&quot;);
1054             TestBotRunner.runPeriodicItems(notifyBot);
1055             listServer.processIncoming();
1056 
1057             var conversations = mailmanList.conversations(Duration.ofDays(1));
1058             var email = conversations.get(0).first();
1059             assertEquals(listAddress, email.sender());
1060             assertEquals(EmailAddress.from(&quot;testauthor&quot;, &quot;ta@none.none&quot;), email.author());
1061             assertEquals(email.recipients(), List.of(listAddress));
1062             assertEquals(&quot;git: test: created branch newbranch1 based on the branch master containing 2 unique commits&quot;, email.subject());
1063             assertTrue(email.body().contains(&quot;12345678: Some fixes&quot;));
1064             assertTrue(email.hasHeader(&quot;extra1&quot;));
1065             assertEquals(&quot;value1&quot;, email.headerValue(&quot;extra1&quot;));
1066             assertTrue(email.hasHeader(&quot;extra2&quot;));
1067             assertEquals(&quot;value2&quot;, email.headerValue(&quot;extra2&quot;));
1068 
1069             TestBotRunner.runPeriodicItems(notifyBot);
1070             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
1071 
1072             localRepo.push(editHash, repo.url(), &quot;newbranch2&quot;);
1073             TestBotRunner.runPeriodicItems(notifyBot);
1074             listServer.processIncoming();
1075 
1076             var newConversation = mailmanList.conversations(Duration.ofDays(1)).stream()
1077                                              .filter(c -&gt; !c.equals(conversations.get(0)))
1078                                              .findFirst().orElseThrow();
1079             email = newConversation.first();
1080             assertEquals(listAddress, email.sender());
1081             assertEquals(sender, email.author());
1082             assertEquals(email.recipients(), List.of(listAddress));
1083             assertEquals(&quot;git: test: created branch newbranch2 based on the branch newbranch1 containing 0 unique commits&quot;, email.subject());
1084             assertEquals(&quot;The new branch newbranch2 is currently identical to the newbranch1 branch.&quot;, email.body());
1085         }
1086     }
1087 
1088     @Test
1089     void testMailingListBranchPrefix(TestInfo testInfo) throws IOException {
1090         try (var listServer = new TestMailmanServer();
1091              var credentials = new HostCredentials(testInfo);
1092              var tempFolder = new TemporaryDirectory()) {
1093             var repo = credentials.getHostedRepository();
1094             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
1095             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
1096             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1097             credentials.commitLock(localRepo);
1098             localRepo.pushAll(repo.url());
1099 
1100             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1101             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
1102             var mailmanList = mailmanServer.getList(listAddress.address());
1103             var tagStorage = createTagStorage(repo);
1104             var branchStorage = createBranchStorage(repo);
1105             var prIssuesStorage = createPullRequestIssuesStorage(repo);
1106             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
1107 
1108             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
1109             var updater = MailingListUpdater.newBuilder()
1110                                             .list(mailmanList)
1111                                             .recipient(listAddress)
1112                                             .sender(sender)
1113                                             .reportNewTags(false)
1114                                             .reportNewBranches(false)
1115                                             .reportNewBuilds(false)
1116                                             .mode(MailingListUpdater.Mode.PR)
1117                                             .repoInSubject(true)
1118                                             .branchInSubject(Pattern.compile(&quot;.*&quot;))
1119                                             .build();
1120             var notifyBot = NotifyBot.newBuilder()
1121                                      .repository(repo)
1122                                      .storagePath(storageFolder)
1123                                      .branches(Pattern.compile(&quot;master&quot;))
1124                                      .tagStorageBuilder(tagStorage)
1125                                      .branchStorageBuilder(branchStorage)
1126                                      .prIssuesStorageBuilder(prIssuesStorage)
1127                                      .updaters(List.of(updater))
1128                                      .build();
1129 
1130             // No mail should be sent on the first run as there is no history
1131             TestBotRunner.runPeriodicItems(notifyBot);
1132             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
1133 
1134             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
1135             localRepo.push(editHash, repo.url(), &quot;edit&quot;);
1136             var pr = credentials.createPullRequest(repo, &quot;master&quot;, &quot;edit&quot;, &quot;RFR: My PR&quot;);
1137 
1138             // PR hasn&#39;t been integrated yet, so there should be no mail
1139             TestBotRunner.runPeriodicItems(notifyBot);
1140             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
1141 
1142             // Simulate an RFR email
1143             var rfr = Email.create(&quot;RFR: My PR&quot;, &quot;PR:\n&quot; + pr.webUrl().toString())
1144                            .author(EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;))
1145                            .recipient(listAddress)
1146                            .build();
1147             mailmanList.post(rfr);
1148             listServer.processIncoming();
1149 
1150             // And an integration
1151             pr.addComment(&quot;Pushed as commit &quot; + editHash.hex() + &quot;.&quot;);
1152             localRepo.push(editHash, repo.url(), &quot;master&quot;);
1153 
1154             TestBotRunner.runPeriodicItems(notifyBot);
1155             listServer.processIncoming();
1156 
1157             var conversations = mailmanList.conversations(Duration.ofDays(1));
1158             conversations.sort(Comparator.comparing(conversation -&gt; conversation.first().subject()));
1159             assertEquals(1, conversations.size());
1160 
1161             var prConversation = conversations.get(0);
1162 
1163             var prEmail = prConversation.replies(prConversation.first()).get(0);
1164             assertEquals(listAddress, prEmail.sender());
1165             assertEquals(EmailAddress.from(&quot;testauthor&quot;, &quot;ta@none.none&quot;), prEmail.author());
1166             assertEquals(prEmail.recipients(), List.of(listAddress));
1167             assertEquals(&quot;[&quot; + repo.name() + &quot;:master] [Integrated] RFR: My PR&quot;, prEmail.subject());
1168             assertTrue(prEmail.body().contains(&quot;Changeset: &quot; + editHash.abbreviate()));
1169             assertTrue(prEmail.body().contains(&quot;23456789: More fixes&quot;));
1170             assertFalse(prEmail.body().contains(&quot;Committer&quot;));
1171             assertFalse(prEmail.body().contains(masterHash.abbreviate()));
1172         }
1173     }
1174 
1175     @Test
1176     void testMailingListNoIdempotence(TestInfo testInfo) throws IOException {
1177         try (var listServer = new TestMailmanServer();
1178              var credentials = new HostCredentials(testInfo);
1179              var tempFolder = new TemporaryDirectory()) {
1180             var repo = credentials.getHostedRepository();
1181             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
1182             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
1183             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1184             credentials.commitLock(localRepo);
1185             localRepo.pushAll(repo.url());
1186 
1187             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1188             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
1189             var mailmanList = mailmanServer.getList(listAddress.address());
1190             var tagStorage = createTagStorage(repo);
1191             var branchStorage = createBranchStorage(repo);
1192             var prIssuesStorage = createPullRequestIssuesStorage(repo);
1193             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
1194 
1195             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
1196             var updater = MailingListUpdater.newBuilder()
1197                                             .list(mailmanList)
1198                                             .recipient(listAddress)
1199                                             .sender(sender)
1200                                             .reportNewTags(false)
1201                                             .reportNewBranches(false)
1202                                             .reportNewBuilds(false)
1203                                             .headers(Map.of(&quot;extra1&quot;, &quot;value1&quot;, &quot;extra2&quot;, &quot;value2&quot;))
1204                                             .allowedAuthorDomains(Pattern.compile(&quot;none&quot;))
1205                                             .build();
1206             var notifyBot = NotifyBot.newBuilder()
1207                                      .repository(repo)
1208                                      .storagePath(storageFolder)
1209                                      .branches(Pattern.compile(&quot;master&quot;))
1210                                      .tagStorageBuilder(tagStorage)
1211                                      .branchStorageBuilder(branchStorage)
1212                                      .prIssuesStorageBuilder(prIssuesStorage)
1213                                      .updaters(List.of(updater))
1214                                      .build();
1215 
1216             // No mail should be sent on the first run as there is no history
1217             TestBotRunner.runPeriodicItems(notifyBot);
1218             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
1219 
1220             // Save history state
1221             var historyHash = localRepo.fetch(repo.url(), &quot;history&quot;);
1222 
1223             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
1224             localRepo.push(editHash, repo.url(), &quot;master&quot;);
1225             TestBotRunner.runPeriodicItems(notifyBot);
1226             listServer.processIncoming();
1227 
1228             var conversations = mailmanList.conversations(Duration.ofDays(1));
1229             assertEquals(1, conversations.size());
1230 
1231             // Reset the history
1232             localRepo.push(historyHash, repo.url(), &quot;history&quot;, true);
1233             TestBotRunner.runPeriodicItems(notifyBot);
1234             listServer.processIncoming();
1235 
1236             // There should now be a duplicate mail
1237             conversations = mailmanList.conversations(Duration.ofDays(1));
1238             assertEquals(2, conversations.size());
1239         }
1240     }
1241 
1242     @Test
1243     void testIssue(TestInfo testInfo) throws IOException {
1244         try (var credentials = new HostCredentials(testInfo);
1245              var tempFolder = new TemporaryDirectory()) {
1246             var repo = credentials.getHostedRepository();
1247             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
1248             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
1249             credentials.commitLock(localRepo);
1250             localRepo.pushAll(repo.url());
1251 
1252             var tagStorage = createTagStorage(repo);
1253             var branchStorage = createBranchStorage(repo);
1254             var prIssuesStorage = createPullRequestIssuesStorage(repo);
1255             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
1256 
1257             var issueProject = credentials.getIssueProject();
1258             var commitIcon = URI.create(&quot;http://www.example.com/commit.png&quot;);
1259             var updater = IssueUpdater.newBuilder()
1260                                       .issueProject(issueProject)
1261                                       .reviewLink(false)
1262                                       .commitIcon(commitIcon)
1263                                       .setFixVersion(true)
1264                                       .build();
1265             var notifyBot = NotifyBot.newBuilder()
1266                                      .repository(repo)
1267                                      .storagePath(storageFolder)
1268                                      .branches(Pattern.compile(&quot;master&quot;))
1269                                      .tagStorageBuilder(tagStorage)
1270                                      .branchStorageBuilder(branchStorage)
1271                                      .prIssuesStorageBuilder(prIssuesStorage)
1272                                      .updaters(List.of(updater))
1273                                      .build();
1274 
1275             // Initialize history
1276             TestBotRunner.runPeriodicItems(notifyBot);
1277 
1278             // Create an issue and commit a fix
1279             var authorEmailAddress = issueProject.issueTracker().currentUser().userName() + &quot;@openjdk.org&quot;;
1280             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));
1281             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;, &quot;Duke&quot;, authorEmailAddress);
1282             localRepo.push(editHash, repo.url(), &quot;master&quot;);
1283             TestBotRunner.runPeriodicItems(notifyBot);
1284 
1285             // The changeset should be reflected in a comment
1286             var updatedIssue = issueProject.issue(issue.id()).orElseThrow();
1287 
1288             var comments = updatedIssue.comments();
1289             assertEquals(1, comments.size());
1290             var comment = comments.get(0);
1291             assertTrue(comment.body().contains(editHash.abbreviate()));
1292 
1293             // And in a link
1294             var links = updatedIssue.links();
1295             assertEquals(1, links.size());
1296             var link = links.get(0);
1297             assertEquals(commitIcon, link.iconUrl().orElseThrow());
1298             assertEquals(&quot;Commit&quot;, link.title().orElseThrow());
1299             assertEquals(repo.webUrl(editHash), link.uri().orElseThrow());
1300 
1301             // As well as a fixVersion
1302             assertEquals(Set.of(&quot;0.1&quot;), fixVersions(updatedIssue));
1303 
1304             // The issue should be assigned and resolved
1305             assertEquals(RESOLVED, updatedIssue.state());
1306             assertEquals(List.of(issueProject.issueTracker().currentUser()), updatedIssue.assignees());
1307         }
1308     }
1309 
1310     @Test
1311     void testIssueNoVersion(TestInfo testInfo) throws IOException {
1312         try (var credentials = new HostCredentials(testInfo);
1313              var tempFolder = new TemporaryDirectory()) {
1314             var repo = credentials.getHostedRepository();
1315             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
1316             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType(), Path.of(&quot;appendable.txt&quot;), Set.of(), null);
1317             credentials.commitLock(localRepo);
1318             localRepo.pushAll(repo.url());
1319 
1320             var tagStorage = createTagStorage(repo);
1321             var branchStorage = createBranchStorage(repo);
1322             var prIssuesStorage = createPullRequestIssuesStorage(repo);
1323             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
1324 
1325             var issueProject = credentials.getIssueProject();
1326             var commitIcon = URI.create(&quot;http://www.example.com/commit.png&quot;);
1327             var updater = IssueUpdater.newBuilder()
1328                                       .issueProject(issueProject)
1329                                       .reviewLink(false)
1330                                       .commitIcon(commitIcon)
1331                                       .setFixVersion(true)
1332                                       .build();
1333             var notifyBot = NotifyBot.newBuilder()
1334                                      .repository(repo)
1335                                      .storagePath(storageFolder)
1336                                      .branches(Pattern.compile(&quot;master&quot;))
1337                                      .tagStorageBuilder(tagStorage)
1338                                      .branchStorageBuilder(branchStorage)
1339                                      .prIssuesStorageBuilder(prIssuesStorage)
1340                                      .updaters(List.of(updater))
1341                                      .build();
1342 
1343             // Initialize history
1344             TestBotRunner.runPeriodicItems(notifyBot);
1345 
1346             // Create an issue and commit a fix
1347             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));
1348             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;);
1349             localRepo.push(editHash, repo.url(), &quot;master&quot;);
1350             TestBotRunner.runPeriodicItems(notifyBot);
1351 
1352             // The changeset should be reflected in a comment
1353             var comments = issue.comments();
1354             assertEquals(1, comments.size());
1355             var comment = comments.get(0);
1356             assertTrue(comment.body().contains(editHash.abbreviate()));
1357 
1358             // But not in the fixVersion
1359             assertEquals(Set.of(), fixVersions(issue));
1360         }
1361     }
1362 
1363     @Test
1364     void testIssueConfiguredVersionNoCommit(TestInfo testInfo) throws IOException {
1365         try (var credentials = new HostCredentials(testInfo);
1366              var tempFolder = new TemporaryDirectory()) {
1367             var repo = credentials.getHostedRepository();
1368             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
1369             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType(), Path.of(&quot;appendable.txt&quot;), Set.of(), null);
1370             credentials.commitLock(localRepo);
1371             localRepo.pushAll(repo.url());
1372 
1373             var tagStorage = createTagStorage(repo);
1374             var branchStorage = createBranchStorage(repo);
1375             var prIssuesStorage = createPullRequestIssuesStorage(repo);
1376             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
1377 
1378             var issueProject = credentials.getIssueProject();
1379             var commitIcon = URI.create(&quot;http://www.example.com/commit.png&quot;);
1380             var updater = IssueUpdater.newBuilder()
1381                                       .issueProject(issueProject)
1382                                       .reviewLink(false)
1383                                       .commitLink(false)
1384                                       .commitIcon(commitIcon)
1385                                       .setFixVersion(true)
1386                                       .fixVersions(Map.of(&quot;master&quot;, &quot;2.0&quot;))
1387                                       .build();
1388             var notifyBot = NotifyBot.newBuilder()
1389                                      .repository(repo)
1390                                      .storagePath(storageFolder)
1391                                      .branches(Pattern.compile(&quot;master&quot;))
1392                                      .tagStorageBuilder(tagStorage)
1393                                      .branchStorageBuilder(branchStorage)
1394                                      .prIssuesStorageBuilder(prIssuesStorage)
1395                                      .updaters(List.of(updater))
1396                                      .build();
1397 
1398             // Initialize history
1399             TestBotRunner.runPeriodicItems(notifyBot);
1400 
1401             // Create an issue and commit a fix
1402             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));
1403             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;);
1404             localRepo.push(editHash, repo.url(), &quot;master&quot;);
1405             TestBotRunner.runPeriodicItems(notifyBot);
1406 
1407             // The changeset should not reflected in a comment
1408             var comments = issue.comments();
1409             assertEquals(1, comments.size());
1410             var comment = comments.get(0);
1411             assertTrue(comment.body().contains(editHash.abbreviate()));
1412 
1413             // As well as a fixVersion - but not the one from the repo
1414             assertEquals(Set.of(&quot;2.0&quot;), fixVersions(issue));
1415 
1416             // And no commit link
1417             var links = issue.links();
1418             assertEquals(0, links.size());
1419         }
1420     }
1421 
1422     @Test
1423     void testIssueIdempotence(TestInfo testInfo) throws IOException {
1424         try (var credentials = new HostCredentials(testInfo);
1425              var tempFolder = new TemporaryDirectory()) {
1426             var repo = credentials.getHostedRepository();
1427             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
1428             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
1429             credentials.commitLock(localRepo);
1430             localRepo.pushAll(repo.url());
1431 
1432             var tagStorage = createTagStorage(repo);
1433             var branchStorage = createBranchStorage(repo);
1434             var prIssuesStorage = createPullRequestIssuesStorage(repo);
1435             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
1436 
1437             var issueProject = credentials.getIssueProject();
1438             var commitIcon = URI.create(&quot;http://www.example.com/commit.png&quot;);
1439             var updater = IssueUpdater.newBuilder()
1440                                       .issueProject(issueProject)
1441                                       .reviewLink(false)
1442                                       .commitIcon(commitIcon)
1443                                       .setFixVersion(true)
1444                                       .build();
1445             var notifyBot = NotifyBot.newBuilder()
1446                                      .repository(repo)
1447                                      .storagePath(storageFolder)
1448                                      .branches(Pattern.compile(&quot;master&quot;))
1449                                      .tagStorageBuilder(tagStorage)
1450                                      .branchStorageBuilder(branchStorage)
1451                                      .prIssuesStorageBuilder(prIssuesStorage)
1452                                      .updaters(List.of(updater))
1453                                      .build();
1454 
1455             // Initialize history
1456             TestBotRunner.runPeriodicItems(notifyBot);
1457 
1458             // Save the state
1459             var historyState = localRepo.fetch(repo.url(), &quot;history&quot;);
1460 
1461             // Create an issue and commit a fix
1462             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));
1463             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;);
1464             localRepo.push(editHash, repo.url(), &quot;master&quot;);
1465             TestBotRunner.runPeriodicItems(notifyBot);
1466 
1467             // The changeset should be reflected in a comment
1468             var comments = issue.comments();
1469             assertEquals(1, comments.size());
1470             var comment = comments.get(0);
1471             assertTrue(comment.body().contains(editHash.abbreviate()));
1472 
1473             // And in a link
1474             var links = issue.links();
1475             assertEquals(1, links.size());
1476             var link = links.get(0);
1477             assertEquals(commitIcon, link.iconUrl().orElseThrow());
1478             assertEquals(&quot;Commit&quot;, link.title().orElseThrow());
1479             assertEquals(repo.webUrl(editHash), link.uri().orElseThrow());
1480 
1481             // As well as a fixVersion
1482             assertEquals(Set.of(&quot;0.1&quot;), fixVersions(issue));
1483 
1484             // Wipe the history
1485             localRepo.push(historyState, repo.url(), &quot;history&quot;, true);
1486 
1487             // Run it again
1488             TestBotRunner.runPeriodicItems(notifyBot);
1489 
1490             // There should be no new comments, links or fixVersions
1491             var updatedIssue = issueProject.issue(issue.id()).orElseThrow();
1492             assertEquals(1, updatedIssue.comments().size());
1493             assertEquals(1, updatedIssue.links().size());
1494             assertEquals(Set.of(&quot;0.1&quot;), fixVersions(updatedIssue));
1495         }
1496     }
1497 
1498     @Test
1499     void testIssuePoolVersion(TestInfo testInfo) throws IOException {
1500         try (var credentials = new HostCredentials(testInfo);
1501              var tempFolder = new TemporaryDirectory()) {
1502             var repo = credentials.getHostedRepository();
1503             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
1504             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType(), Path.of(&quot;appendable.txt&quot;), Set.of(), null);
1505             credentials.commitLock(localRepo);
1506             localRepo.pushAll(repo.url());
1507 
1508             var tagStorage = createTagStorage(repo);
1509             var branchStorage = createBranchStorage(repo);
1510             var prIssuesStorage = createPullRequestIssuesStorage(repo);
1511             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
1512 
1513             var issueProject = credentials.getIssueProject();
1514             var updater = IssueUpdater.newBuilder()
1515                                       .issueProject(issueProject)
1516                                       .reviewLink(false)
1517                                       .commitLink(false)
1518                                       .setFixVersion(true)
1519                                       .fixVersions(Map.of(&quot;master&quot;, &quot;12u14&quot;))
1520                                       .build();
1521             var notifyBot = NotifyBot.newBuilder()
1522                                      .repository(repo)
1523                                      .storagePath(storageFolder)
1524                                      .branches(Pattern.compile(&quot;master&quot;))
1525                                      .tagStorageBuilder(tagStorage)
1526                                      .branchStorageBuilder(branchStorage)
1527                                      .prIssuesStorageBuilder(prIssuesStorage)
1528                                      .updaters(List.of(updater))
1529                                      .build();
1530 
1531             // Initialize history
1532             TestBotRunner.runPeriodicItems(notifyBot);
1533 
1534             // Create an issue and commit a fix
1535             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));
1536             issue.setProperty(&quot;fixVersions&quot;, JSON.array().add(&quot;12-pool&quot;).add(&quot;tbd13&quot;).add(&quot;unknown&quot;));
1537 
1538             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;);
1539             localRepo.push(editHash, repo.url(), &quot;master&quot;);
1540             TestBotRunner.runPeriodicItems(notifyBot);
1541 
1542             // The fixVersion should have been updated
1543             assertEquals(Set.of(&quot;12u14&quot;), fixVersions(issue));
1544         }
1545     }
1546 
1547     @Test
1548     void testIssuePoolOpenVersion(TestInfo testInfo) throws IOException {
1549         try (var credentials = new HostCredentials(testInfo);
1550              var tempFolder = new TemporaryDirectory()) {
1551             var repo = credentials.getHostedRepository();
1552             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
1553             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType(), Path.of(&quot;appendable.txt&quot;), Set.of(), null);
1554             credentials.commitLock(localRepo);
1555             localRepo.pushAll(repo.url());
1556 
1557             var tagStorage = createTagStorage(repo);
1558             var branchStorage = createBranchStorage(repo);
1559             var prIssuesStorage = createPullRequestIssuesStorage(repo);
1560             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
1561 
1562             var issueProject = credentials.getIssueProject();
1563             var updater = IssueUpdater.newBuilder()
1564                                       .issueProject(issueProject)
1565                                       .reviewLink(false)
1566                                       .commitLink(false)
1567                                       .setFixVersion(true)
1568                                       .fixVersions(Map.of(&quot;master&quot;, &quot;12u14&quot;))
1569                                       .build();
1570             var notifyBot = NotifyBot.newBuilder()
1571                                      .repository(repo)
1572                                      .storagePath(storageFolder)
1573                                      .branches(Pattern.compile(&quot;master&quot;))
1574                                      .tagStorageBuilder(tagStorage)
1575                                      .branchStorageBuilder(branchStorage)
1576                                      .prIssuesStorageBuilder(prIssuesStorage)
1577                                      .updaters(List.of(updater))
1578                                      .build();
1579 
1580             // Initialize history
1581             TestBotRunner.runPeriodicItems(notifyBot);
1582 
1583             // Create an issue and commit a fix
1584             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));
1585             issue.setProperty(&quot;fixVersions&quot;, JSON.array().add(&quot;12-pool&quot;).add(&quot;tbd13&quot;).add(&quot;unknown&quot;));
1586 
1587             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;);
1588             localRepo.push(editHash, repo.url(), &quot;master&quot;);
1589             TestBotRunner.runPeriodicItems(notifyBot);
1590 
1591             // The fixVersion should have been updated
1592             assertEquals(Set.of(&quot;12u14&quot;), fixVersions(issue));
1593         }
1594     }
1595 
1596     @Test
1597     void testIssueBackport(TestInfo testInfo) throws IOException {
1598         try (var credentials = new HostCredentials(testInfo);
1599              var tempFolder = new TemporaryDirectory()) {
1600             var repo = credentials.getHostedRepository();
1601             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
1602             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType(), Path.of(&quot;appendable.txt&quot;), Set.of(), null);
1603             credentials.commitLock(localRepo);
1604             localRepo.pushAll(repo.url());
1605 
1606             var tagStorage = createTagStorage(repo);
1607             var branchStorage = createBranchStorage(repo);
1608             var prIssuesStorage = createPullRequestIssuesStorage(repo);
1609             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
1610 
1611             var issueProject = credentials.getIssueProject();
1612             var updater = IssueUpdater.newBuilder()
1613                                       .issueProject(issueProject)
1614                                       .reviewLink(false)
1615                                       .commitLink(false)
1616                                       .setFixVersion(true)
1617                                       .fixVersions(Map.of(&quot;master&quot;, &quot;12.0.2&quot;))
1618                                       .build();
1619             var notifyBot = NotifyBot.newBuilder()
1620                                      .repository(repo)
1621                                      .storagePath(storageFolder)
1622                                      .branches(Pattern.compile(&quot;master&quot;))
1623                                      .tagStorageBuilder(tagStorage)
1624                                      .branchStorageBuilder(branchStorage)
1625                                      .prIssuesStorageBuilder(prIssuesStorage)
1626                                      .updaters(List.of(updater))
1627                                      .build();
1628 
1629             // Initialize history
1630             TestBotRunner.runPeriodicItems(notifyBot);
1631 
1632             // Create an issue and commit a fix
1633             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;),
1634                                                  Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;),
1635                                                         &quot;customfield_10008&quot;, JSON.object()
1636                                                                                  .put(&quot;id&quot;, 244)
1637                                                                                  .put(&quot;name&quot;, &quot;java.io&quot;),
1638                                                         &quot;customfield_10005&quot;, JSON.array()
1639                                                                                  .add(JSON.object()
1640                                                                                           .put(&quot;id&quot;, &quot;17010&quot;)
1641                                                                                           .put(&quot;value&quot;, &quot;generic&quot;))
1642                                                                                  .add(JSON.object()
1643                                                                                           .put(&quot;id&quot;, &quot;17019&quot;)
1644                                                                                           .put(&quot;value&quot;, &quot;other&quot;))
1645                                                  ));
1646             issue.setProperty(&quot;fixVersions&quot;, JSON.array().add(&quot;13.0.1&quot;));
1647             issue.setProperty(&quot;priority&quot;, JSON.of(&quot;1&quot;));
1648 
1649             var authorEmailAddress = issueProject.issueTracker().currentUser().userName() + &quot;@openjdk.org&quot;;
1650             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;, &quot;Duke&quot;, authorEmailAddress);
1651             localRepo.push(editHash, repo.url(), &quot;master&quot;);
1652             TestBotRunner.runPeriodicItems(notifyBot);
1653 
1654             // The fixVersion should not have been updated
1655             var updatedIssue = issueProject.issue(issue.id()).orElseThrow();
1656             assertEquals(Set.of(&quot;13.0.1&quot;), fixVersions(updatedIssue));
1657             assertEquals(OPEN, updatedIssue.state());
1658             assertEquals(List.of(), updatedIssue.assignees());
1659 
1660             // There should be a link
1661             var links = updatedIssue.links();
1662             assertEquals(1, links.size());
1663             var link = links.get(0);
1664             var backport = link.issue().orElseThrow();
1665 
1666             // The backport issue should have a correct fixVersion and assignee
1667             assertEquals(Set.of(&quot;12.0.2&quot;), fixVersions(backport));
1668             assertEquals(RESOLVED, backport.state());
1669             assertEquals(List.of(issueProject.issueTracker().currentUser()), backport.assignees());
1670 
1671             // Custom properties should also propagate
1672             assertEquals(&quot;1&quot;, backport.properties().get(&quot;priority&quot;).asString());
1673             assertEquals(244, backport.properties().get(&quot;customfield_10008&quot;).get(&quot;id&quot;).asInt());
1674             assertEquals(&quot;java.io&quot;, backport.properties().get(&quot;customfield_10008&quot;).get(&quot;name&quot;).asString());
1675             assertEquals(2, backport.properties().get(&quot;customfield_10005&quot;).asArray().size());
1676         }
1677     }
1678 
1679     @Test
1680     void testPullRequest(TestInfo testInfo) throws IOException {
1681         try (var credentials = new HostCredentials(testInfo);
1682              var tempFolder = new TemporaryDirectory()) {
1683             var repo = credentials.getHostedRepository();
1684             var reviewer = credentials.getHostedRepository();
1685             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
1686             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
1687             credentials.commitLock(localRepo);
1688             localRepo.pushAll(repo.url());
1689 
1690             var tagStorage = createTagStorage(repo);
1691             var branchStorage = createBranchStorage(repo);
1692             var prIssuesStorage = createPullRequestIssuesStorage(repo);
1693             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
1694 
1695             var issueProject = credentials.getIssueProject();
1696             var reviewIcon = URI.create(&quot;http://www.example.com/review.png&quot;);
1697             var updater = IssueUpdater.newBuilder()
1698                                       .issueProject(issueProject)
1699                                       .reviewIcon(reviewIcon)
1700                                       .commitLink(false)
1701                                       .build();
1702             var notifyBot = NotifyBot.newBuilder()
1703                                      .repository(repo)
1704                                      .storagePath(storageFolder)
1705                                      .branches(Pattern.compile(&quot;master&quot;))
1706                                      .tagStorageBuilder(tagStorage)
1707                                      .branchStorageBuilder(branchStorage)
1708                                      .prIssuesStorageBuilder(prIssuesStorage)
1709                                      .prUpdaters(List.of(updater))
1710                                      .readyLabels(Set.of(&quot;rfr&quot;))
1711                                      .readyComments(Map.of(reviewer.forge().currentUser().userName(), Pattern.compile(&quot;This is now ready&quot;)))
1712                                      .build();
1713 
1714             // Initialize history
1715             TestBotRunner.runPeriodicItems(notifyBot);
1716 
1717             // Create an issue and a pull request to fix it
1718             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));
1719             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;Fix that issue&quot;);
1720             localRepo.push(editHash, repo.url(), &quot;edit&quot;, true);
1721             var pr = credentials.createPullRequest(repo, &quot;edit&quot;, &quot;master&quot;, issue.id() + &quot;: Fix that issue&quot;);
1722             pr.setBody(&quot;\n\n## Issue\n[&quot; + issue.id() + &quot;](http://www.test.test/): The issue&quot;);
1723             TestBotRunner.runPeriodicItems(notifyBot);
1724 
1725             // The issue should not yet contain a link to the PR
1726             var links = issue.links();
1727             assertEquals(0, links.size());
1728 
1729             // Just a label isn&#39;t enough
1730             pr.addLabel(&quot;rfr&quot;);
1731             TestBotRunner.runPeriodicItems(notifyBot);
1732             links = issue.links();
1733             assertEquals(0, links.size());
1734 
1735             // Neither is just a comment
1736             pr.removeLabel(&quot;rfr&quot;);
1737             var reviewPr = reviewer.pullRequest(pr.id());
1738             reviewPr.addComment(&quot;This is now ready&quot;);
1739             TestBotRunner.runPeriodicItems(notifyBot);
1740             links = issue.links();
1741             assertEquals(0, links.size());
1742 
1743             // Both are needed
1744             pr.addLabel(&quot;rfr&quot;);
1745             TestBotRunner.runPeriodicItems(notifyBot);
1746 
1747             // The issue should now contain a link to the PR
1748             links = issue.links();
1749             assertEquals(1, links.size());
1750             assertEquals(pr.webUrl(), links.get(0).uri().orElseThrow());
1751             assertEquals(reviewIcon, links.get(0).iconUrl().orElseThrow());
1752 
1753             // Add another issue
1754             var issue2 = issueProject.createIssue(&quot;This is another issue&quot;, List.of(&quot;Yes indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));
1755             pr.setBody(&quot;\n\n## Issues\n[&quot; + issue.id() + &quot;](http://www.test.test/): The issue\n[&quot; + issue2.id() +
1756                                &quot;](http://www.test2.test/): The second issue&quot;);
1757             TestBotRunner.runPeriodicItems(notifyBot);
1758 
1759             // Both issues should contain a link to the PR
1760             var links1 = issue.links();
1761             assertEquals(1, links1.size());
1762             assertEquals(pr.webUrl(), links1.get(0).uri().orElseThrow());
1763             var links2 = issue2.links();
1764             assertEquals(1, links2.size());
1765             assertEquals(pr.webUrl(), links2.get(0).uri().orElseThrow());
1766 
1767             // Drop the first one
1768             pr.setBody(&quot;\n\n## Issue\n[&quot; + issue2.id() + &quot;](http://www.test2.test/): That other issue&quot;);
1769             TestBotRunner.runPeriodicItems(notifyBot);
1770 
1771             // Only the second issue should now contain a link to the PR
1772             links1 = issue.links();
1773             assertEquals(0, links1.size());
1774             links2 = issue2.links();
1775             assertEquals(1, links2.size());
1776             assertEquals(pr.webUrl(), links2.get(0).uri().orElseThrow());
1777         }
1778     }
1779 
1780     @Test
1781     void testPullRequestNoReview(TestInfo testInfo) throws IOException {
1782         try (var credentials = new HostCredentials(testInfo);
1783              var tempFolder = new TemporaryDirectory()) {
1784             var repo = credentials.getHostedRepository();
1785             var reviewer = credentials.getHostedRepository();
1786             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
1787             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
1788             credentials.commitLock(localRepo);
1789             localRepo.pushAll(repo.url());
1790 
1791             var tagStorage = createTagStorage(repo);
1792             var branchStorage = createBranchStorage(repo);
1793             var prIssuesStorage = createPullRequestIssuesStorage(repo);
1794             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
1795 
1796             var issueProject = credentials.getIssueProject();
1797             var reviewIcon = URI.create(&quot;http://www.example.com/review.png&quot;);
1798             var updater = IssueUpdater.newBuilder()
1799                                       .issueProject(issueProject)
1800                                       .reviewLink(false)
1801                                       .reviewIcon(reviewIcon)
1802                                       .commitLink(false)
1803                                       .build();
1804             var notifyBot = NotifyBot.newBuilder()
1805                                      .repository(repo)
1806                                      .storagePath(storageFolder)
1807                                      .branches(Pattern.compile(&quot;master&quot;))
1808                                      .tagStorageBuilder(tagStorage)
1809                                      .branchStorageBuilder(branchStorage)
1810                                      .prIssuesStorageBuilder(prIssuesStorage)
1811                                      .prUpdaters(List.of(updater)).readyLabels(Set.of(&quot;rfr&quot;))
1812                                      .readyComments(Map.of(reviewer.forge().currentUser().userName(), Pattern.compile(&quot;This is now ready&quot;)))
1813                                      .build();
1814             // Initialize history
1815             TestBotRunner.runPeriodicItems(notifyBot);
1816 
1817             // Create an issue and a pull request to fix it
1818             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));
1819             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;Fix that issue&quot;);
1820             localRepo.push(editHash, repo.url(), &quot;edit&quot;, true);
1821             var pr = credentials.createPullRequest(repo, &quot;edit&quot;, &quot;master&quot;, issue.id() + &quot;: Fix that issue&quot;);
1822             pr.setBody(&quot;\n\n## Issue\n[&quot; + issue.id() + &quot;](http://www.test.test/): The issue&quot;);
1823             TestBotRunner.runPeriodicItems(notifyBot);
1824 
1825             // Add required label
1826             pr.addLabel(&quot;rfr&quot;);
1827             TestBotRunner.runPeriodicItems(notifyBot);
1828 
1829             // And the required comment
1830             var reviewPr = reviewer.pullRequest(pr.id());
1831             reviewPr.addComment(&quot;This is now ready&quot;);
1832             TestBotRunner.runPeriodicItems(notifyBot);
1833 
1834             // The issue should still not contain a link to the PR
1835             var links = issue.links();
1836             assertEquals(0, links.size());
1837         }
1838     }
1839 
1840     @Test
1841     void testPullRequestPROnly(TestInfo testInfo) throws IOException {
1842         try (var credentials = new HostCredentials(testInfo);
1843              var tempFolder = new TemporaryDirectory()) {
1844             var repo = credentials.getHostedRepository();
1845             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
1846             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
1847             credentials.commitLock(localRepo);
1848             localRepo.pushAll(repo.url());
1849 
1850             var tagStorage = createTagStorage(repo);
1851             var branchStorage = createBranchStorage(repo);
1852             var prIssuesStorage = createPullRequestIssuesStorage(repo);
1853             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
1854 
1855             var issueProject = credentials.getIssueProject();
1856             var reviewIcon = URI.create(&quot;http://www.example.com/review.png&quot;);
1857             var updater = IssueUpdater.newBuilder()
1858                                       .issueProject(issueProject)
1859                                       .reviewIcon(reviewIcon)
1860                                       .commitLink(false)
1861                                       .prOnly(true)
1862                                       .build();
1863             var notifyBot = NotifyBot.newBuilder()
1864                                      .repository(repo)
1865                                      .storagePath(storageFolder)
1866                                      .branches(Pattern.compile(&quot;.*&quot;))
1867                                      .tagStorageBuilder(tagStorage)
1868                                      .branchStorageBuilder(branchStorage)
1869                                      .prIssuesStorageBuilder(prIssuesStorage)
1870                                      .updaters(List.of(updater))
1871                                      .prUpdaters(List.of(updater))
1872                                      .build();
1873 
1874             // Initialize history
1875             localRepo.push(localRepo.resolve(&quot;master&quot;).orElseThrow(), repo.url(), &quot;other&quot;);
1876             TestBotRunner.runPeriodicItems(notifyBot);
1877 
1878             // Create an issue and a pull request to fix it
1879             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));
1880             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;);
1881             localRepo.push(editHash, repo.url(), &quot;edit&quot;, true);
1882             var pr = credentials.createPullRequest(repo, &quot;other&quot;, &quot;edit&quot;, issue.id() + &quot;: Fix that issue&quot;);
1883             pr.setBody(&quot;\n\n## Issue\n[&quot; + issue.id() + &quot;](http://www.test.test/): The issue&quot;);
1884             TestBotRunner.runPeriodicItems(notifyBot);
1885 
1886             // The issue should now contain a link to the PR
1887             var links = issue.links();
1888             assertEquals(1, links.size());
1889             assertEquals(pr.webUrl(), links.get(0).uri().orElseThrow());
1890             assertEquals(reviewIcon, links.get(0).iconUrl().orElseThrow());
1891 
1892             // Simulate integration
1893             localRepo.push(editHash, repo.url(), &quot;other&quot;);
1894             TestBotRunner.runPeriodicItems(notifyBot);
1895 
1896             // The changeset should be reflected in a comment
1897             var updatedIssue = issueProject.issue(issue.id()).orElseThrow();
1898 
1899             var comments = updatedIssue.comments();
1900             assertEquals(1, comments.size());
1901             var comment = comments.get(0);
1902             assertTrue(comment.body().contains(editHash.abbreviate()));
1903 
1904             // Now simulate a merge to another branch
1905             localRepo.push(editHash, repo.url(), &quot;master&quot;);
1906             TestBotRunner.runPeriodicItems(notifyBot);
1907 
1908             // No additional comment should have been made
1909             updatedIssue = issueProject.issue(issue.id()).orElseThrow();
1910             comments = updatedIssue.comments();
1911             assertEquals(1, comments.size());
1912         }
1913     }
1914 }
    </pre>
  </body>
</html>