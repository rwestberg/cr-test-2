<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff bots/notify/src/test/java/org/openjdk/skara/bots/notify/UpdaterTests.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../../../../../../../main/java/org/openjdk/skara/bots/notify/NotifyBotFactory.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> next &gt;</center>    <h2>bots/notify/src/test/java/org/openjdk/skara/bots/notify/UpdaterTests.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
  78     }
  79 
  80     @Test
  81     void testJsonUpdaterBranch(TestInfo testInfo) throws IOException {
  82         try (var credentials = new HostCredentials(testInfo);
  83              var tempFolder = new TemporaryDirectory()) {
  84             var repo = credentials.getHostedRepository();
  85             var localRepoFolder = tempFolder.path().resolve(&quot;repo&quot;);
  86             var localRepo = CheckableRepository.init(localRepoFolder, repo.repositoryType());
  87             credentials.commitLock(localRepo);
  88             localRepo.pushAll(repo.url());
  89 
  90             var tagStorage = createTagStorage(repo);
  91             var branchStorage = createBranchStorage(repo);
  92             var prIssuesStorage = createPullRequestIssuesStorage(repo);
  93             var jsonFolder = tempFolder.path().resolve(&quot;json&quot;);
  94             Files.createDirectory(jsonFolder);
  95             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
  96 
  97             var updater = new JsonUpdater(jsonFolder, &quot;12&quot;, &quot;team&quot;);
<span class="line-modified">  98             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,</span>
<span class="line-modified">  99                                           prIssuesStorage, List.of(updater), List.of(), Set.of(), Map.of());</span>







 100 
 101             TestBotRunner.runPeriodicItems(notifyBot);
 102             assertEquals(List.of(), findJsonFiles(jsonFolder, &quot;&quot;));
 103 
 104             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;One more line&quot;, &quot;12345678: Fixes&quot;);
 105             localRepo.push(editHash, repo.url(), &quot;master&quot;);
 106             TestBotRunner.runPeriodicItems(notifyBot);
 107             var jsonFiles = findJsonFiles(jsonFolder, &quot;&quot;);
 108             assertEquals(1, jsonFiles.size());
 109             var jsonData = Files.readString(jsonFiles.get(0), StandardCharsets.UTF_8);
 110             var json = JSON.parse(jsonData);
 111             assertEquals(1, json.asArray().size());
 112             assertEquals(repo.webUrl(editHash).toString(), json.asArray().get(0).get(&quot;url&quot;).asString());
 113             assertEquals(List.of(&quot;12345678&quot;), json.asArray().get(0).get(&quot;issue&quot;).asArray().stream()
 114                                                   .map(JSONValue::asString)
 115                                                   .collect(Collectors.toList()));
 116         }
 117     }
 118 
 119     @Test
 120     void testJsonUpdaterTag(TestInfo testInfo) throws IOException {
 121         try (var credentials = new HostCredentials(testInfo);
 122              var tempFolder = new TemporaryDirectory()) {
 123             var repo = credentials.getHostedRepository();
 124             var localRepoFolder = tempFolder.path().resolve(&quot;repo&quot;);
 125             var localRepo = CheckableRepository.init(localRepoFolder, repo.repositoryType());
 126             credentials.commitLock(localRepo);
 127             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 128             localRepo.tag(masterHash, &quot;jdk-12+1&quot;, &quot;Added tag 1&quot;, &quot;Duke&quot;, &quot;duke@openjdk.java.net&quot;);
 129             localRepo.pushAll(repo.url());
 130 
 131             var tagStorage = createTagStorage(repo);
 132             var branchStorage = createBranchStorage(repo);
 133             var prIssuesStorage = createPullRequestIssuesStorage(repo);
 134             var jsonFolder = tempFolder.path().resolve(&quot;json&quot;);
 135             Files.createDirectory(jsonFolder);
 136             var storageFolder =tempFolder.path().resolve(&quot;storage&quot;);
 137 
 138             var updater = new JsonUpdater(jsonFolder, &quot;12&quot;, &quot;team&quot;);
<span class="line-modified"> 139             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,</span>
<span class="line-modified"> 140                                           prIssuesStorage, List.of(updater), List.of(), Set.of(), Map.of());</span>







 141 
 142             TestBotRunner.runPeriodicItems(notifyBot);
 143             assertEquals(List.of(), findJsonFiles(jsonFolder, &quot;&quot;));
 144 
 145             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
 146             localRepo.fetch(repo.url(), &quot;history:history&quot;);
 147             localRepo.tag(editHash, &quot;jdk-12+2&quot;, &quot;Added tag 2&quot;, &quot;Duke&quot;, &quot;duke@openjdk.java.net&quot;);
 148             var editHash2 = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;34567890: Even more fixes&quot;);
 149             localRepo.tag(editHash2, &quot;jdk-12+4&quot;, &quot;Added tag 3&quot;, &quot;Duke&quot;, &quot;duke@openjdk.java.net&quot;);
 150             localRepo.pushAll(repo.url());
 151 
 152             TestBotRunner.runPeriodicItems(notifyBot);
 153             var jsonFiles = findJsonFiles(jsonFolder, &quot;&quot;);
 154             assertEquals(3, jsonFiles.size());
 155 
 156             for (var file : jsonFiles) {
 157                 var jsonData = Files.readString(file, StandardCharsets.UTF_8);
 158                 var json = JSON.parse(jsonData);
 159 
 160                 if (json.asArray().get(0).contains(&quot;date&quot;)) {
</pre>
<hr />
<pre>
 190     void testMailingList(TestInfo testInfo) throws IOException {
 191         try (var listServer = new TestMailmanServer();
 192              var credentials = new HostCredentials(testInfo);
 193              var tempFolder = new TemporaryDirectory()) {
 194             var repo = credentials.getHostedRepository();
 195             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
 196             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
 197             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 198             credentials.commitLock(localRepo);
 199             localRepo.pushAll(repo.url());
 200 
 201             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 202             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 203             var mailmanList = mailmanServer.getList(listAddress.address());
 204             var tagStorage = createTagStorage(repo);
 205             var branchStorage = createBranchStorage(repo);
 206             var prIssuesStorage = createPullRequestIssuesStorage(repo);
 207             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
 208 
 209             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
<span class="line-modified"> 210             var updater = new MailingListUpdater(mailmanList, listAddress, sender, null, false, false, false, false,</span>
<span class="line-modified"> 211                                                  MailingListUpdater.Mode.ALL,</span>
<span class="line-modified"> 212                                                  Map.of(&quot;extra1&quot;, &quot;value1&quot;, &quot;extra2&quot;, &quot;value2&quot;), Pattern.compile(&quot;none&quot;));</span>
<span class="line-modified"> 213             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,</span>
<span class="line-modified"> 214                                           prIssuesStorage, List.of(updater), List.of(), Set.of(), Map.of());</span>














 215 
 216             // No mail should be sent on the first run as there is no history
 217             TestBotRunner.runPeriodicItems(notifyBot);
 218             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 219 
 220             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
 221             localRepo.push(editHash, repo.url(), &quot;master&quot;);
 222             TestBotRunner.runPeriodicItems(notifyBot);
 223             listServer.processIncoming();
 224 
 225             var conversations = mailmanList.conversations(Duration.ofDays(1));
 226             var email = conversations.get(0).first();
 227             assertEquals(listAddress, email.sender());
 228             assertEquals(sender, email.author());
 229             assertEquals(email.recipients(), List.of(listAddress));
 230             assertTrue(email.subject().contains(&quot;: 23456789: More fixes&quot;));
 231             assertFalse(email.subject().contains(&quot;master&quot;));
 232             assertTrue(email.body().contains(&quot;Changeset: &quot; + editHash.abbreviate()));
 233             assertTrue(email.body().contains(&quot;23456789: More fixes&quot;));
 234             assertFalse(email.body().contains(&quot;Committer&quot;));
</pre>
<hr />
<pre>
 244     void testMailingListMultiple(TestInfo testInfo) throws IOException {
 245         try (var listServer = new TestMailmanServer();
 246              var credentials = new HostCredentials(testInfo);
 247              var tempFolder = new TemporaryDirectory()) {
 248             var repo = credentials.getHostedRepository();
 249             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
 250             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
 251             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 252             credentials.commitLock(localRepo);
 253             localRepo.pushAll(repo.url());
 254 
 255             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 256             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 257             var mailmanList = mailmanServer.getList(listAddress.address());
 258             var tagStorage = createTagStorage(repo);
 259             var branchStorage = createBranchStorage(repo);
 260             var prIssuesStorage = createPullRequestIssuesStorage(repo);
 261             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
 262 
 263             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
<span class="line-modified"> 264             var updater = new MailingListUpdater(mailmanList, listAddress, sender, null,</span>
<span class="line-modified"> 265                                                  false, false, false, false,</span>
<span class="line-modified"> 266                                                  MailingListUpdater.Mode.ALL, Map.of(), Pattern.compile(&quot;.*&quot;));</span>
<span class="line-modified"> 267             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,</span>
<span class="line-modified"> 268                                           prIssuesStorage, List.of(updater), List.of(), Set.of(), Map.of());</span>












 269 
 270             // No mail should be sent on the first run as there is no history
 271             TestBotRunner.runPeriodicItems(notifyBot);
 272             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 273 
 274             var editHash1 = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;,
 275                                                                 &quot;first_author&quot;, &quot;first@author.example.com&quot;);
 276             localRepo.push(editHash1, repo.url(), &quot;master&quot;);
 277             var editHash2 = CheckableRepository.appendAndCommit(localRepo, &quot;Yet another line&quot;, &quot;3456789A: Even more fixes&quot;,
 278                                                                 &quot;another_author&quot;, &quot;another@author.example.com&quot;);
 279             localRepo.push(editHash2, repo.url(), &quot;master&quot;);
 280 
 281             TestBotRunner.runPeriodicItems(notifyBot);
 282             listServer.processIncoming();
 283 
 284             var conversations = mailmanList.conversations(Duration.ofDays(1));
 285             var email = conversations.get(0).first();
 286             assertEquals(listAddress, email.sender());
 287             assertEquals(EmailAddress.from(&quot;another_author&quot;, &quot;another@author.example.com&quot;), email.author());
 288             assertEquals(email.recipients(), List.of(listAddress));
</pre>
<hr />
<pre>
 300     void testMailingListSponsored(TestInfo testInfo) throws IOException {
 301         try (var listServer = new TestMailmanServer();
 302              var credentials = new HostCredentials(testInfo);
 303              var tempFolder = new TemporaryDirectory()) {
 304             var repo = credentials.getHostedRepository();
 305             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
 306             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
 307             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 308             credentials.commitLock(localRepo);
 309             localRepo.pushAll(repo.url());
 310 
 311             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 312             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 313             var mailmanList = mailmanServer.getList(listAddress.address());
 314             var tagStorage = createTagStorage(repo);
 315             var branchStorage = createBranchStorage(repo);
 316             var prIssuesStorage = createPullRequestIssuesStorage(repo);
 317             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
 318 
 319             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
<span class="line-modified"> 320             var updater = new MailingListUpdater(mailmanList, listAddress, sender, null,</span>
<span class="line-modified"> 321                                                  false, false, false, false,</span>
<span class="line-modified"> 322                                                  MailingListUpdater.Mode.ALL, Map.of(), Pattern.compile(&quot;.*&quot;));</span>
<span class="line-modified"> 323             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,</span>
<span class="line-modified"> 324                                           prIssuesStorage, List.of(updater), List.of(), Set.of(), Map.of());</span>












 325 
 326             // No mail should be sent on the first run as there is no history
 327             TestBotRunner.runPeriodicItems(notifyBot);
 328             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 329 
 330             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;,
 331                                                                &quot;author&quot;, &quot;author@test.test&quot;,
 332                                                                &quot;committer&quot;, &quot;committer@test.test&quot;);
 333             localRepo.push(editHash, repo.url(), &quot;master&quot;);
 334             TestBotRunner.runPeriodicItems(notifyBot);
 335             listServer.processIncoming();
 336 
 337             var conversations = mailmanList.conversations(Duration.ofDays(1));
 338             var email = conversations.get(0).first();
 339             assertEquals(listAddress, email.sender());
 340             assertEquals(EmailAddress.from(&quot;committer&quot;, &quot;committer@test.test&quot;), email.author());
 341             assertEquals(email.recipients(), List.of(listAddress));
 342             assertTrue(email.body().contains(&quot;Changeset: &quot; + editHash.abbreviate()));
 343             assertTrue(email.body().contains(&quot;23456789: More fixes&quot;));
 344             assertTrue(email.body().contains(&quot;Author:    author &lt;author@test.test&gt;&quot;));
</pre>
<hr />
<pre>
 353              var credentials = new HostCredentials(testInfo);
 354              var tempFolder = new TemporaryDirectory()) {
 355             var repo = credentials.getHostedRepository();
 356             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
 357             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
 358             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 359             credentials.commitLock(localRepo);
 360             var branch = localRepo.branch(masterHash, &quot;another&quot;);
 361             localRepo.pushAll(repo.url());
 362 
 363             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 364             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 365             var mailmanList = mailmanServer.getList(listAddress.address());
 366             var tagStorage = createTagStorage(repo);
 367             var branchStorage = createBranchStorage(repo);
 368             var prIssuesStorage = createPullRequestIssuesStorage(repo);
 369             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
 370 
 371             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
 372             var author = EmailAddress.from(&quot;author&quot;, &quot;author@duke.duke&quot;);
<span class="line-modified"> 373             var updater = new MailingListUpdater(mailmanList, listAddress, sender, author,</span>
<span class="line-modified"> 374                                                  true, false, false, false,</span>
<span class="line-modified"> 375                                                  MailingListUpdater.Mode.ALL, Map.of(), Pattern.compile(&quot;.*&quot;));</span>
<span class="line-modified"> 376             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;master|another&quot;), tagStorage, branchStorage,</span>
<span class="line-modified"> 377                                           prIssuesStorage, List.of(updater), List.of(), Set.of(), Map.of());</span>














 378 
 379             // No mail should be sent on the first run as there is no history
 380             TestBotRunner.runPeriodicItems(notifyBot);
 381             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 382 
 383             var editHash1 = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
 384             localRepo.push(editHash1, repo.url(), &quot;master&quot;);
 385             var editHash2 = CheckableRepository.appendAndCommit(localRepo, &quot;Yet another line&quot;, &quot;3456789A: Even more fixes&quot;);
 386             localRepo.push(editHash2, repo.url(), &quot;master&quot;);
 387 
 388             TestBotRunner.runPeriodicItems(notifyBot);
 389             listServer.processIncoming();
 390 
 391             var conversations = mailmanList.conversations(Duration.ofDays(1));
 392             var email = conversations.get(0).first();
 393             assertEquals(listAddress, email.sender());
 394             assertEquals(author, email.author());
 395             assertEquals(email.recipients(), List.of(listAddress));
 396             assertFalse(email.subject().contains(&quot;another&quot;));
 397             assertTrue(email.subject().contains(&quot;: master: 2 new changesets&quot;));
</pre>
<hr />
<pre>
 429         try (var listServer = new TestMailmanServer();
 430              var credentials = new HostCredentials(testInfo);
 431              var tempFolder = new TemporaryDirectory()) {
 432             var repo = credentials.getHostedRepository();
 433             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
 434             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
 435             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 436             credentials.commitLock(localRepo);
 437             localRepo.pushAll(repo.url());
 438 
 439             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 440             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 441             var mailmanList = mailmanServer.getList(listAddress.address());
 442             var tagStorage = createTagStorage(repo);
 443             var branchStorage = createBranchStorage(repo);
 444             var prIssuesStorage = createPullRequestIssuesStorage(repo);
 445             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
 446 
 447             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
 448             var author = EmailAddress.from(&quot;author&quot;, &quot;author@duke.duke&quot;);
<span class="line-modified"> 449             var updater = new MailingListUpdater(mailmanList, listAddress, sender, author,</span>
<span class="line-modified"> 450                                                  false, false, false, false,</span>
<span class="line-modified"> 451                                                  MailingListUpdater.Mode.PR_ONLY, Map.of(&quot;extra1&quot;, &quot;value1&quot;),</span>
<span class="line-modified"> 452                                                  Pattern.compile(&quot;.*&quot;));</span>
<span class="line-modified"> 453             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,</span>
<span class="line-modified"> 454                                           prIssuesStorage, List.of(updater), List.of(), Set.of(), Map.of());</span>














 455 
 456             // No mail should be sent on the first run as there is no history
 457             TestBotRunner.runPeriodicItems(notifyBot);
 458             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 459 
 460             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
 461             localRepo.push(editHash, repo.url(), &quot;edit&quot;);
 462             var pr = credentials.createPullRequest(repo, &quot;master&quot;, &quot;edit&quot;, &quot;RFR: My PR&quot;);
 463 
 464             // Create a potentially conflicting one
 465             var otherHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
 466             localRepo.push(otherHash, repo.url(), &quot;other&quot;);
 467             var otherPr = credentials.createPullRequest(repo, &quot;master&quot;, &quot;other&quot;, &quot;RFR: My other PR&quot;);
 468 
 469             // PR hasn&#39;t been integrated yet, so there should be no mail
 470             TestBotRunner.runPeriodicItems(notifyBot);
 471             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 472 
 473             // Simulate an RFR email
 474             var rfr = Email.create(sender, &quot;RFR: My PR&quot;, &quot;PR: &quot; + pr.webUrl().toString())
</pre>
<hr />
<pre>
 510     void testMailingListPR(TestInfo testInfo) throws IOException {
 511         try (var listServer = new TestMailmanServer();
 512              var credentials = new HostCredentials(testInfo);
 513              var tempFolder = new TemporaryDirectory()) {
 514             var repo = credentials.getHostedRepository();
 515             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
 516             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
 517             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 518             credentials.commitLock(localRepo);
 519             localRepo.pushAll(repo.url());
 520 
 521             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 522             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 523             var mailmanList = mailmanServer.getList(listAddress.address());
 524             var tagStorage = createTagStorage(repo);
 525             var branchStorage = createBranchStorage(repo);
 526             var prIssuesStorage = createPullRequestIssuesStorage(repo);
 527             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
 528 
 529             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
<span class="line-modified"> 530             var updater = new MailingListUpdater(mailmanList, listAddress, sender, null,</span>
<span class="line-modified"> 531                                                  false, false, false, false,</span>
<span class="line-modified"> 532                                                  MailingListUpdater.Mode.PR, Map.of(), Pattern.compile(&quot;.*&quot;));</span>
<span class="line-modified"> 533             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,</span>
<span class="line-modified"> 534                                           prIssuesStorage, List.of(updater), List.of(), Set.of(), Map.of());</span>













 535 
 536             // No mail should be sent on the first run as there is no history
 537             TestBotRunner.runPeriodicItems(notifyBot);
 538             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 539 
 540             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
 541             localRepo.push(editHash, repo.url(), &quot;edit&quot;);
 542             var pr = credentials.createPullRequest(repo, &quot;master&quot;, &quot;edit&quot;, &quot;RFR: My PR&quot;);
 543 
 544             // Create a potentially conflicting one
 545             var otherHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
 546             localRepo.push(otherHash, repo.url(), &quot;other&quot;);
 547             var otherPr = credentials.createPullRequest(repo, &quot;master&quot;, &quot;other&quot;, &quot;RFR: My other PR&quot;);
 548 
 549             // PR hasn&#39;t been integrated yet, so there should be no mail
 550             TestBotRunner.runPeriodicItems(notifyBot);
 551             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 552 
 553             // Simulate an RFR email
 554             var rfr = Email.create(&quot;RFR: My PR&quot;, &quot;PR:\n&quot; + pr.webUrl().toString())
</pre>
<hr />
<pre>
 600         try (var listServer = new TestMailmanServer();
 601              var credentials = new HostCredentials(testInfo);
 602              var tempFolder = new TemporaryDirectory()) {
 603             var repo = credentials.getHostedRepository();
 604             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
 605             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
 606             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 607             localRepo.branch(masterHash, &quot;other&quot;);
 608             credentials.commitLock(localRepo);
 609             localRepo.pushAll(repo.url());
 610 
 611             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 612             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 613             var mailmanList = mailmanServer.getList(listAddress.address());
 614             var tagStorage = createTagStorage(repo);
 615             var branchStorage = createBranchStorage(repo);
 616             var prIssuesStorage = createPullRequestIssuesStorage(repo);
 617             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
 618 
 619             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
<span class="line-modified"> 620             var updater = new MailingListUpdater(mailmanList, listAddress, sender, null,</span>
<span class="line-modified"> 621                                                  false, false, false, false,</span>
<span class="line-modified"> 622                                                  MailingListUpdater.Mode.PR, Map.of(), Pattern.compile(&quot;.*&quot;));</span>
<span class="line-modified"> 623             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;master|other&quot;), tagStorage, branchStorage,</span>
<span class="line-modified"> 624                                           prIssuesStorage, List.of(updater), List.of(), Set.of(), Map.of());</span>














 625 
 626             // No mail should be sent on the first run as there is no history
 627             TestBotRunner.runPeriodicItems(notifyBot);
 628             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 629 
 630             localRepo.checkout(masterHash, true);
 631             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
 632             localRepo.push(editHash, repo.url(), &quot;edit&quot;);
 633             var pr = credentials.createPullRequest(repo, &quot;master&quot;, &quot;edit&quot;, &quot;RFR: My PR&quot;);
 634 
 635             // PR hasn&#39;t been integrated yet, so there should be no mail
 636             TestBotRunner.runPeriodicItems(notifyBot);
 637             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 638 
 639             // Simulate an RFR email
 640             var rfr = Email.create(&quot;RFR: My PR&quot;, &quot;PR:\n&quot; + pr.webUrl().toString())
 641                            .author(EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;))
 642                            .recipient(listAddress)
 643                            .build();
 644             mailmanList.post(rfr);
</pre>
<hr />
<pre>
 690         try (var credentials = new HostCredentials(testInfo);
 691              var tempFolder = new TemporaryDirectory();
 692              var listServer = new TestMailmanServer()) {
 693             var repo = credentials.getHostedRepository();
 694             var localRepoFolder = tempFolder.path().resolve(&quot;repo&quot;);
 695             var localRepo = CheckableRepository.init(localRepoFolder, repo.repositoryType());
 696             credentials.commitLock(localRepo);
 697             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 698             localRepo.tag(masterHash, &quot;jdk-12+1&quot;, &quot;Added tag 1&quot;, &quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;);
 699             localRepo.pushAll(repo.url());
 700 
 701             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 702             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 703             var mailmanList = mailmanServer.getList(listAddress.address());
 704             var tagStorage = createTagStorage(repo);
 705             var branchStorage = createBranchStorage(repo);
 706             var prIssuesStorage = createPullRequestIssuesStorage(repo);
 707             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
 708 
 709             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
<span class="line-modified"> 710             var updater = new MailingListUpdater(mailmanList, listAddress, sender, null,</span>
<span class="line-modified"> 711                                                  false, true, false, true,</span>
<span class="line-modified"> 712                                                  MailingListUpdater.Mode.ALL,</span>
<span class="line-modified"> 713                                                  Map.of(&quot;extra1&quot;, &quot;value1&quot;, &quot;extra2&quot;, &quot;value2&quot;),</span>
<span class="line-modified"> 714                                                  Pattern.compile(&quot;.*&quot;));</span>
<span class="line-modified"> 715             var prOnlyUpdater = new MailingListUpdater(mailmanList, listAddress, sender, null,</span>
<span class="line-modified"> 716                                                        false, false, false, false,</span>
<span class="line-modified"> 717                                                        MailingListUpdater.Mode.PR_ONLY, Map.of(), Pattern.compile(&quot;.*&quot;));</span>
<span class="line-modified"> 718             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,</span>
<span class="line-modified"> 719                                           prIssuesStorage, List.of(updater, prOnlyUpdater), List.of(), Set.of(), Map.of());</span>















 720 
 721             // No mail should be sent on the first run as there is no history
 722             TestBotRunner.runPeriodicItems(notifyBot);
 723             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 724 
 725             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
 726             localRepo.fetch(repo.url(), &quot;history:history&quot;);
 727             localRepo.tag(editHash, &quot;jdk-12+2&quot;, &quot;Added tag 2&quot;, &quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;);
 728             CheckableRepository.appendAndCommit(localRepo, &quot;Another line 1&quot;, &quot;34567890: Even more fixes&quot;);
 729             CheckableRepository.appendAndCommit(localRepo, &quot;Another line 2&quot;, &quot;45678901: Yet even more fixes&quot;);
 730             var editHash2 = CheckableRepository.appendAndCommit(localRepo, &quot;Another line 3&quot;, &quot;56789012: Still even more fixes&quot;);
 731             localRepo.tag(editHash2, &quot;jdk-12+4&quot;, &quot;Added tag 3&quot;, &quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;);
 732             CheckableRepository.appendAndCommit(localRepo, &quot;Another line 4&quot;, &quot;67890123: Brand new fixes&quot;);
 733             var editHash3 = CheckableRepository.appendAndCommit(localRepo, &quot;Another line 5&quot;, &quot;78901234: More brand new fixes&quot;);
 734             localRepo.tag(editHash3, &quot;jdk-13+0&quot;, &quot;Added tag 4&quot;, &quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;);
 735             localRepo.pushAll(repo.url());
 736 
 737             TestBotRunner.runPeriodicItems(notifyBot);
 738             listServer.processIncoming();
 739             listServer.processIncoming();
</pre>
<hr />
<pre>
 793         try (var credentials = new HostCredentials(testInfo);
 794              var tempFolder = new TemporaryDirectory();
 795              var listServer = new TestMailmanServer()) {
 796             var repo = credentials.getHostedRepository();
 797             var localRepoFolder = tempFolder.path().resolve(&quot;repo&quot;);
 798             var localRepo = CheckableRepository.init(localRepoFolder, repo.repositoryType());
 799             credentials.commitLock(localRepo);
 800             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 801             localRepo.tag(masterHash, &quot;jdk-12+1&quot;, &quot;Added tag 1&quot;, &quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;);
 802             localRepo.pushAll(repo.url());
 803 
 804             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 805             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 806             var mailmanList = mailmanServer.getList(listAddress.address());
 807             var tagStorage = createTagStorage(repo);
 808             var branchStorage = createBranchStorage(repo);
 809             var prIssuesStorage = createPullRequestIssuesStorage(repo);
 810             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
 811 
 812             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
<span class="line-modified"> 813             var updater = new MailingListUpdater(mailmanList, listAddress, sender, null,</span>
<span class="line-modified"> 814                                                  false, true, false, false,</span>
<span class="line-modified"> 815                                                  MailingListUpdater.Mode.ALL,</span>
<span class="line-modified"> 816                                                  Map.of(&quot;extra1&quot;, &quot;value1&quot;, &quot;extra2&quot;, &quot;value2&quot;),</span>
<span class="line-modified"> 817                                                  Pattern.compile(&quot;.*&quot;));</span>
<span class="line-modified"> 818             var prOnlyUpdater = new MailingListUpdater(mailmanList, listAddress, sender, null,</span>
<span class="line-modified"> 819                                                        false, false, false, false,</span>
<span class="line-modified"> 820                                                        MailingListUpdater.Mode.PR_ONLY, Map.of(), Pattern.compile(&quot;.*&quot;));</span>
<span class="line-modified"> 821             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,</span>
<span class="line-modified"> 822                                           prIssuesStorage, List.of(updater, prOnlyUpdater), List.of(), Set.of(), Map.of());</span>
















 823 
 824             // No mail should be sent on the first run as there is no history
 825             TestBotRunner.runPeriodicItems(notifyBot);
 826             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 827 
 828             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
 829             localRepo.fetch(repo.url(), &quot;history:history&quot;);
 830             localRepo.tag(editHash, &quot;jdk-12+2&quot;, &quot;Added tag 2&quot;, &quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;);
 831             CheckableRepository.appendAndCommit(localRepo, &quot;Another line 1&quot;, &quot;34567890: Even more fixes&quot;);
 832             CheckableRepository.appendAndCommit(localRepo, &quot;Another line 2&quot;, &quot;45678901: Yet even more fixes&quot;);
 833             var editHash2 = CheckableRepository.appendAndCommit(localRepo, &quot;Another line 3&quot;, &quot;56789012: Still even more fixes&quot;);
 834             localRepo.tag(editHash2, &quot;jdk-12+4&quot;, &quot;Added tag 3&quot;, &quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;);
 835             CheckableRepository.appendAndCommit(localRepo, &quot;Another line 4&quot;, &quot;67890123: Brand new fixes&quot;);
 836             var editHash3 = CheckableRepository.appendAndCommit(localRepo, &quot;Another line 5&quot;, &quot;78901234: More brand new fixes&quot;);
 837             localRepo.tag(editHash3, &quot;jdk-13+0&quot;, &quot;Added tag 4&quot;, &quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;);
 838             localRepo.pushAll(repo.url());
 839 
 840             TestBotRunner.runPeriodicItems(notifyBot);
 841             listServer.processIncoming();
 842             listServer.processIncoming();
</pre>
<hr />
<pre>
 871     void testMailingListBranch(TestInfo testInfo) throws IOException {
 872         try (var listServer = new TestMailmanServer();
 873              var credentials = new HostCredentials(testInfo);
 874              var tempFolder = new TemporaryDirectory()) {
 875             var repo = credentials.getHostedRepository();
 876             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
 877             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
 878             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 879             credentials.commitLock(localRepo);
 880             localRepo.pushAll(repo.url());
 881 
 882             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 883             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 884             var mailmanList = mailmanServer.getList(listAddress.address());
 885             var tagStorage = createTagStorage(repo);
 886             var branchStorage = createBranchStorage(repo);
 887             var prIssuesStorage = createPullRequestIssuesStorage(repo);
 888             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
 889 
 890             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
<span class="line-modified"> 891             var updater = new MailingListUpdater(mailmanList, listAddress, sender, null,</span>
<span class="line-modified"> 892                                                  false, false, true, false,</span>
<span class="line-modified"> 893                                                  MailingListUpdater.Mode.ALL,</span>
<span class="line-modified"> 894                                                  Map.of(&quot;extra1&quot;, &quot;value1&quot;, &quot;extra2&quot;, &quot;value2&quot;),</span>
<span class="line-modified"> 895                                                  Pattern.compile(&quot;.*&quot;));</span>
<span class="line-modified"> 896             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;master|newbranch.&quot;), tagStorage, branchStorage,</span>
<span class="line-modified"> 897                                           prIssuesStorage, List.of(updater), List.of(), Set.of(), Map.of());</span>










 898 
 899             // No mail should be sent on the first run as there is no history
 900             TestBotRunner.runPeriodicItems(notifyBot);
 901             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 902 
 903             CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;12345678: Some fixes&quot;);
 904             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
 905             localRepo.push(editHash, repo.url(), &quot;newbranch1&quot;);
 906             TestBotRunner.runPeriodicItems(notifyBot);
 907             listServer.processIncoming();
 908 
 909             var conversations = mailmanList.conversations(Duration.ofDays(1));
 910             var email = conversations.get(0).first();
 911             assertEquals(listAddress, email.sender());
 912             assertEquals(EmailAddress.from(&quot;testauthor&quot;, &quot;ta@none.none&quot;), email.author());
 913             assertEquals(email.recipients(), List.of(listAddress));
 914             assertEquals(&quot;git: test: created branch newbranch1 based on the branch master containing 2 unique commits&quot;, email.subject());
 915             assertTrue(email.body().contains(&quot;12345678: Some fixes&quot;));
 916             assertTrue(email.hasHeader(&quot;extra1&quot;));
 917             assertEquals(&quot;value1&quot;, email.headerValue(&quot;extra1&quot;));
</pre>
<hr />
<pre>
 941     void testMailingListNoIdempotence(TestInfo testInfo) throws IOException {
 942         try (var listServer = new TestMailmanServer();
 943              var credentials = new HostCredentials(testInfo);
 944              var tempFolder = new TemporaryDirectory()) {
 945             var repo = credentials.getHostedRepository();
 946             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
 947             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
 948             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 949             credentials.commitLock(localRepo);
 950             localRepo.pushAll(repo.url());
 951 
 952             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 953             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 954             var mailmanList = mailmanServer.getList(listAddress.address());
 955             var tagStorage = createTagStorage(repo);
 956             var branchStorage = createBranchStorage(repo);
 957             var prIssuesStorage = createPullRequestIssuesStorage(repo);
 958             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
 959 
 960             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
<span class="line-modified"> 961             var updater = new MailingListUpdater(mailmanList, listAddress, sender, null,</span>
<span class="line-modified"> 962                                                  false, false, false, false,</span>
<span class="line-modified"> 963                                                  MailingListUpdater.Mode.ALL,</span>
<span class="line-modified"> 964                                                  Map.of(&quot;extra1&quot;, &quot;value1&quot;, &quot;extra2&quot;, &quot;value2&quot;), Pattern.compile(&quot;none&quot;));</span>
<span class="line-modified"> 965             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,</span>
<span class="line-modified"> 966                                           prIssuesStorage, List.of(updater), List.of(), Set.of(), Map.of());</span>













 967 
 968             // No mail should be sent on the first run as there is no history
 969             TestBotRunner.runPeriodicItems(notifyBot);
 970             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 971 
 972             // Save history state
 973             var historyHash = localRepo.fetch(repo.url(), &quot;history&quot;);
 974 
 975             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
 976             localRepo.push(editHash, repo.url(), &quot;master&quot;);
 977             TestBotRunner.runPeriodicItems(notifyBot);
 978             listServer.processIncoming();
 979 
 980             var conversations = mailmanList.conversations(Duration.ofDays(1));
 981             assertEquals(1, conversations.size());
 982 
 983             // Reset the history
 984             localRepo.push(historyHash, repo.url(), &quot;history&quot;, true);
 985             TestBotRunner.runPeriodicItems(notifyBot);
 986             listServer.processIncoming();
</pre>
<hr />
<pre>
 991         }
 992     }
 993 
 994     @Test
 995     void testIssue(TestInfo testInfo) throws IOException {
 996         try (var credentials = new HostCredentials(testInfo);
 997              var tempFolder = new TemporaryDirectory()) {
 998             var repo = credentials.getHostedRepository();
 999             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
1000             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
1001             credentials.commitLock(localRepo);
1002             localRepo.pushAll(repo.url());
1003 
1004             var tagStorage = createTagStorage(repo);
1005             var branchStorage = createBranchStorage(repo);
1006             var prIssuesStorage = createPullRequestIssuesStorage(repo);
1007             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
1008 
1009             var issueProject = credentials.getIssueProject();
1010             var commitIcon = URI.create(&quot;http://www.example.com/commit.png&quot;);
<span class="line-modified">1011             var updater = new IssueUpdater(issueProject, false, null, true, commitIcon, true, null, false);</span>
<span class="line-modified">1012             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,</span>
<span class="line-modified">1013                                           prIssuesStorage, List.of(updater), List.of(), Set.of(), Map.of());</span>












1014 
1015             // Initialize history
1016             TestBotRunner.runPeriodicItems(notifyBot);
1017 
1018             // Create an issue and commit a fix
1019             var authorEmailAddress = issueProject.issueTracker().currentUser().userName() + &quot;@openjdk.org&quot;;
1020             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));
1021             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;, &quot;Duke&quot;, authorEmailAddress);
1022             localRepo.push(editHash, repo.url(), &quot;master&quot;);
1023             TestBotRunner.runPeriodicItems(notifyBot);
1024 
1025             // The changeset should be reflected in a comment
1026             var updatedIssue = issueProject.issue(issue.id()).orElseThrow();
1027 
1028             var comments = updatedIssue.comments();
1029             assertEquals(1, comments.size());
1030             var comment = comments.get(0);
1031             assertTrue(comment.body().contains(editHash.abbreviate()));
1032 
1033             // And in a link
</pre>
<hr />
<pre>
1047         }
1048     }
1049 
1050     @Test
1051     void testIssueNoVersion(TestInfo testInfo) throws IOException {
1052         try (var credentials = new HostCredentials(testInfo);
1053              var tempFolder = new TemporaryDirectory()) {
1054             var repo = credentials.getHostedRepository();
1055             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
1056             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType(), Path.of(&quot;appendable.txt&quot;), Set.of(), null);
1057             credentials.commitLock(localRepo);
1058             localRepo.pushAll(repo.url());
1059 
1060             var tagStorage = createTagStorage(repo);
1061             var branchStorage = createBranchStorage(repo);
1062             var prIssuesStorage = createPullRequestIssuesStorage(repo);
1063             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
1064 
1065             var issueProject = credentials.getIssueProject();
1066             var commitIcon = URI.create(&quot;http://www.example.com/commit.png&quot;);
<span class="line-modified">1067             var updater = new IssueUpdater(issueProject, false, null, true, commitIcon, true, null, false);</span>
<span class="line-modified">1068             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,</span>
<span class="line-modified">1069                                           prIssuesStorage, List.of(updater), List.of(), Set.of(), Map.of());</span>












1070 
1071             // Initialize history
1072             TestBotRunner.runPeriodicItems(notifyBot);
1073 
1074             // Create an issue and commit a fix
1075             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));
1076             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;);
1077             localRepo.push(editHash, repo.url(), &quot;master&quot;);
1078             TestBotRunner.runPeriodicItems(notifyBot);
1079 
1080             // The changeset should be reflected in a comment
1081             var comments = issue.comments();
1082             assertEquals(1, comments.size());
1083             var comment = comments.get(0);
1084             assertTrue(comment.body().contains(editHash.abbreviate()));
1085 
1086             // But not in the fixVersion
1087             assertEquals(Set.of(), fixVersions(issue));
1088         }
1089     }
1090 
1091     @Test
1092     void testIssueConfiguredVersionNoCommit(TestInfo testInfo) throws IOException {
1093         try (var credentials = new HostCredentials(testInfo);
1094              var tempFolder = new TemporaryDirectory()) {
1095             var repo = credentials.getHostedRepository();
1096             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
1097             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType(), Path.of(&quot;appendable.txt&quot;), Set.of(), null);
1098             credentials.commitLock(localRepo);
1099             localRepo.pushAll(repo.url());
1100 
1101             var tagStorage = createTagStorage(repo);
1102             var branchStorage = createBranchStorage(repo);
1103             var prIssuesStorage = createPullRequestIssuesStorage(repo);
1104             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
1105 
1106             var issueProject = credentials.getIssueProject();
1107             var commitIcon = URI.create(&quot;http://www.example.com/commit.png&quot;);
<span class="line-modified">1108             var updater = new IssueUpdater(issueProject, false, null, false, commitIcon, true, Map.of(&quot;master&quot;, &quot;2.0&quot;), false);</span>
<span class="line-modified">1109             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,</span>
<span class="line-modified">1110                                           prIssuesStorage, List.of(updater), List.of(), Set.of(), Map.of());</span>














1111 
1112             // Initialize history
1113             TestBotRunner.runPeriodicItems(notifyBot);
1114 
1115             // Create an issue and commit a fix
1116             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));
1117             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;);
1118             localRepo.push(editHash, repo.url(), &quot;master&quot;);
1119             TestBotRunner.runPeriodicItems(notifyBot);
1120 
1121             // The changeset should not reflected in a comment
1122             var comments = issue.comments();
1123             assertEquals(1, comments.size());
1124             var comment = comments.get(0);
1125             assertTrue(comment.body().contains(editHash.abbreviate()));
1126 
1127             // As well as a fixVersion - but not the one from the repo
1128             assertEquals(Set.of(&quot;2.0&quot;), fixVersions(issue));
1129 
1130             // And no commit link
</pre>
<hr />
<pre>
1133         }
1134     }
1135 
1136     @Test
1137     void testIssueIdempotence(TestInfo testInfo) throws IOException {
1138         try (var credentials = new HostCredentials(testInfo);
1139              var tempFolder = new TemporaryDirectory()) {
1140             var repo = credentials.getHostedRepository();
1141             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
1142             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
1143             credentials.commitLock(localRepo);
1144             localRepo.pushAll(repo.url());
1145 
1146             var tagStorage = createTagStorage(repo);
1147             var branchStorage = createBranchStorage(repo);
1148             var prIssuesStorage = createPullRequestIssuesStorage(repo);
1149             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
1150 
1151             var issueProject = credentials.getIssueProject();
1152             var commitIcon = URI.create(&quot;http://www.example.com/commit.png&quot;);
<span class="line-modified">1153             var updater = new IssueUpdater(issueProject, false, null, true, commitIcon, true, null, false);</span>
<span class="line-modified">1154             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,</span>
<span class="line-modified">1155                                           prIssuesStorage, List.of(updater), List.of(), Set.of(), Map.of());</span>












1156 
1157             // Initialize history
1158             TestBotRunner.runPeriodicItems(notifyBot);
1159 
1160             // Save the state
1161             var historyState = localRepo.fetch(repo.url(), &quot;history&quot;);
1162 
1163             // Create an issue and commit a fix
1164             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));
1165             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;);
1166             localRepo.push(editHash, repo.url(), &quot;master&quot;);
1167             TestBotRunner.runPeriodicItems(notifyBot);
1168 
1169             // The changeset should be reflected in a comment
1170             var comments = issue.comments();
1171             assertEquals(1, comments.size());
1172             var comment = comments.get(0);
1173             assertTrue(comment.body().contains(editHash.abbreviate()));
1174 
1175             // And in a link
</pre>
<hr />
<pre>
1196             assertEquals(Set.of(&quot;0.1&quot;), fixVersions(updatedIssue));
1197         }
1198     }
1199 
1200     @Test
1201     void testIssuePoolVersion(TestInfo testInfo) throws IOException {
1202         try (var credentials = new HostCredentials(testInfo);
1203              var tempFolder = new TemporaryDirectory()) {
1204             var repo = credentials.getHostedRepository();
1205             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
1206             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType(), Path.of(&quot;appendable.txt&quot;), Set.of(), null);
1207             credentials.commitLock(localRepo);
1208             localRepo.pushAll(repo.url());
1209 
1210             var tagStorage = createTagStorage(repo);
1211             var branchStorage = createBranchStorage(repo);
1212             var prIssuesStorage = createPullRequestIssuesStorage(repo);
1213             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
1214 
1215             var issueProject = credentials.getIssueProject();
<span class="line-modified">1216             var updater = new IssueUpdater(issueProject, false, null, false, null, true, Map.of(&quot;master&quot;, &quot;12u14&quot;), false);</span>
<span class="line-modified">1217             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,</span>
<span class="line-modified">1218                                           prIssuesStorage, List.of(updater), List.of(), Set.of(), Map.of());</span>













1219 
1220             // Initialize history
1221             TestBotRunner.runPeriodicItems(notifyBot);
1222 
1223             // Create an issue and commit a fix
1224             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));
1225             issue.setProperty(&quot;fixVersions&quot;, JSON.array().add(&quot;12-pool&quot;).add(&quot;tbd13&quot;).add(&quot;unknown&quot;));
1226 
1227             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;);
1228             localRepo.push(editHash, repo.url(), &quot;master&quot;);
1229             TestBotRunner.runPeriodicItems(notifyBot);
1230 
1231             // The fixVersion should have been updated
1232             assertEquals(Set.of(&quot;12u14&quot;), fixVersions(issue));
1233         }
1234     }
1235 
1236     @Test
1237     void testIssuePoolOpenVersion(TestInfo testInfo) throws IOException {
1238         try (var credentials = new HostCredentials(testInfo);
1239              var tempFolder = new TemporaryDirectory()) {
1240             var repo = credentials.getHostedRepository();
1241             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
1242             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType(), Path.of(&quot;appendable.txt&quot;), Set.of(), null);
1243             credentials.commitLock(localRepo);
1244             localRepo.pushAll(repo.url());
1245 
1246             var tagStorage = createTagStorage(repo);
1247             var branchStorage = createBranchStorage(repo);
1248             var prIssuesStorage = createPullRequestIssuesStorage(repo);
1249             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
1250 
1251             var issueProject = credentials.getIssueProject();
<span class="line-modified">1252             var updater = new IssueUpdater(issueProject, false, null, false, null, true, Map.of(&quot;master&quot;, &quot;12u14&quot;), false);</span>
<span class="line-modified">1253             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,</span>
<span class="line-modified">1254                                           prIssuesStorage, List.of(updater), List.of(), Set.of(), Map.of());</span>













1255 
1256             // Initialize history
1257             TestBotRunner.runPeriodicItems(notifyBot);
1258 
1259             // Create an issue and commit a fix
1260             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));
1261             issue.setProperty(&quot;fixVersions&quot;, JSON.array().add(&quot;12-pool&quot;).add(&quot;tbd13&quot;).add(&quot;unknown&quot;));
1262 
1263             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;);
1264             localRepo.push(editHash, repo.url(), &quot;master&quot;);
1265             TestBotRunner.runPeriodicItems(notifyBot);
1266 
1267             // The fixVersion should have been updated
1268             assertEquals(Set.of(&quot;12u14&quot;), fixVersions(issue));
1269         }
1270     }
1271 
1272     @Test
1273     void testIssueBackport(TestInfo testInfo) throws IOException {
1274         try (var credentials = new HostCredentials(testInfo);
1275              var tempFolder = new TemporaryDirectory()) {
1276             var repo = credentials.getHostedRepository();
1277             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
1278             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType(), Path.of(&quot;appendable.txt&quot;), Set.of(), null);
1279             credentials.commitLock(localRepo);
1280             localRepo.pushAll(repo.url());
1281 
1282             var tagStorage = createTagStorage(repo);
1283             var branchStorage = createBranchStorage(repo);
1284             var prIssuesStorage = createPullRequestIssuesStorage(repo);
1285             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
1286 
1287             var issueProject = credentials.getIssueProject();
<span class="line-modified">1288             var updater = new IssueUpdater(issueProject, false, null, false, null, true, Map.of(&quot;master&quot;, &quot;12.0.2&quot;), false);</span>
<span class="line-modified">1289             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,</span>
<span class="line-modified">1290                                           prIssuesStorage, List.of(updater), List.of(), Set.of(), Map.of());</span>













1291 
1292             // Initialize history
1293             TestBotRunner.runPeriodicItems(notifyBot);
1294 
1295             // Create an issue and commit a fix
1296             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;),
1297                                                  Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;),
1298                                                         &quot;customfield_10008&quot;, JSON.object()
1299                                                                                  .put(&quot;id&quot;, 244)
1300                                                                                  .put(&quot;name&quot;, &quot;java.io&quot;),
1301                                                         &quot;customfield_10005&quot;, JSON.array()
1302                                                                                  .add(JSON.object()
1303                                                                                           .put(&quot;id&quot;, &quot;17010&quot;)
1304                                                                                           .put(&quot;value&quot;, &quot;generic&quot;))
1305                                                                                  .add(JSON.object()
1306                                                                                           .put(&quot;id&quot;, &quot;17019&quot;)
1307                                                                                           .put(&quot;value&quot;, &quot;other&quot;))
1308                                                  ));
1309             issue.setProperty(&quot;fixVersions&quot;, JSON.array().add(&quot;13.0.1&quot;));
1310             issue.setProperty(&quot;priority&quot;, JSON.of(&quot;1&quot;));
</pre>
<hr />
<pre>
1340     }
1341 
1342     @Test
1343     void testPullRequest(TestInfo testInfo) throws IOException {
1344         try (var credentials = new HostCredentials(testInfo);
1345              var tempFolder = new TemporaryDirectory()) {
1346             var repo = credentials.getHostedRepository();
1347             var reviewer = credentials.getHostedRepository();
1348             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
1349             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
1350             credentials.commitLock(localRepo);
1351             localRepo.pushAll(repo.url());
1352 
1353             var tagStorage = createTagStorage(repo);
1354             var branchStorage = createBranchStorage(repo);
1355             var prIssuesStorage = createPullRequestIssuesStorage(repo);
1356             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
1357 
1358             var issueProject = credentials.getIssueProject();
1359             var reviewIcon = URI.create(&quot;http://www.example.com/review.png&quot;);
<span class="line-modified">1360             var updater = new IssueUpdater(issueProject, true, reviewIcon, false, null, false, null, false);</span>
<span class="line-modified">1361             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,</span>
<span class="line-modified">1362                                           prIssuesStorage, List.of(), List.of(updater), Set.of(&quot;rfr&quot;),</span>
<span class="line-modified">1363                                           Map.of(reviewer.forge().currentUser().userName(), Pattern.compile(&quot;This is now ready&quot;)));</span>












1364 
1365             // Initialize history
1366             TestBotRunner.runPeriodicItems(notifyBot);
1367 
1368             // Create an issue and a pull request to fix it
1369             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));
1370             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;Fix that issue&quot;);
1371             localRepo.push(editHash, repo.url(), &quot;edit&quot;, true);
1372             var pr = credentials.createPullRequest(repo, &quot;edit&quot;, &quot;master&quot;, issue.id() + &quot;: Fix that issue&quot;);
1373             pr.setBody(&quot;\n\n## Issue\n[&quot; + issue.id() + &quot;](http://www.test.test/): The issue&quot;);
1374             TestBotRunner.runPeriodicItems(notifyBot);
1375 
1376             // The issue should not yet contain a link to the PR
1377             var links = issue.links();
1378             assertEquals(0, links.size());
1379 
1380             // Just a label isn&#39;t enough
1381             pr.addLabel(&quot;rfr&quot;);
1382             TestBotRunner.runPeriodicItems(notifyBot);
1383             links = issue.links();
</pre>
<hr />
<pre>
1429     }
1430 
1431     @Test
1432     void testPullRequestNoReview(TestInfo testInfo) throws IOException {
1433         try (var credentials = new HostCredentials(testInfo);
1434              var tempFolder = new TemporaryDirectory()) {
1435             var repo = credentials.getHostedRepository();
1436             var reviewer = credentials.getHostedRepository();
1437             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
1438             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
1439             credentials.commitLock(localRepo);
1440             localRepo.pushAll(repo.url());
1441 
1442             var tagStorage = createTagStorage(repo);
1443             var branchStorage = createBranchStorage(repo);
1444             var prIssuesStorage = createPullRequestIssuesStorage(repo);
1445             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
1446 
1447             var issueProject = credentials.getIssueProject();
1448             var reviewIcon = URI.create(&quot;http://www.example.com/review.png&quot;);
<span class="line-modified">1449             var updater = new IssueUpdater(issueProject, false, reviewIcon, false, null, false,null, false);</span>
<span class="line-modified">1450             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,</span>
<span class="line-modified">1451                                           prIssuesStorage, List.of(), List.of(updater), Set.of(&quot;rfr&quot;),</span>
<span class="line-modified">1452                                           Map.of(reviewer.forge().currentUser().userName(), Pattern.compile(&quot;This is now ready&quot;)));</span>












1453             // Initialize history
1454             TestBotRunner.runPeriodicItems(notifyBot);
1455 
1456             // Create an issue and a pull request to fix it
1457             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));
1458             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;Fix that issue&quot;);
1459             localRepo.push(editHash, repo.url(), &quot;edit&quot;, true);
1460             var pr = credentials.createPullRequest(repo, &quot;edit&quot;, &quot;master&quot;, issue.id() + &quot;: Fix that issue&quot;);
1461             pr.setBody(&quot;\n\n## Issue\n[&quot; + issue.id() + &quot;](http://www.test.test/): The issue&quot;);
1462             TestBotRunner.runPeriodicItems(notifyBot);
1463 
1464             // Add required label
1465             pr.addLabel(&quot;rfr&quot;);
1466             TestBotRunner.runPeriodicItems(notifyBot);
1467 
1468             // And the required comment
1469             var reviewPr = reviewer.pullRequest(pr.id());
1470             reviewPr.addComment(&quot;This is now ready&quot;);
1471             TestBotRunner.runPeriodicItems(notifyBot);
1472 
</pre>
<hr />
<pre>
1476         }
1477     }
1478 
1479     @Test
1480     void testPullRequestPROnly(TestInfo testInfo) throws IOException {
1481         try (var credentials = new HostCredentials(testInfo);
1482              var tempFolder = new TemporaryDirectory()) {
1483             var repo = credentials.getHostedRepository();
1484             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
1485             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
1486             credentials.commitLock(localRepo);
1487             localRepo.pushAll(repo.url());
1488 
1489             var tagStorage = createTagStorage(repo);
1490             var branchStorage = createBranchStorage(repo);
1491             var prIssuesStorage = createPullRequestIssuesStorage(repo);
1492             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
1493 
1494             var issueProject = credentials.getIssueProject();
1495             var reviewIcon = URI.create(&quot;http://www.example.com/review.png&quot;);
<span class="line-modified">1496             var updater = new IssueUpdater(issueProject, true, reviewIcon, false, null, false, null, true);</span>
<span class="line-modified">1497             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;.*&quot;), tagStorage, branchStorage,</span>
<span class="line-modified">1498                                           prIssuesStorage, List.of(updater), List.of(updater), Set.of(), Map.of());</span>













1499 
1500             // Initialize history
1501             localRepo.push(localRepo.resolve(&quot;master&quot;).orElseThrow(), repo.url(), &quot;other&quot;);
1502             TestBotRunner.runPeriodicItems(notifyBot);
1503 
1504             // Create an issue and a pull request to fix it
1505             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));
1506             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;);
1507             localRepo.push(editHash, repo.url(), &quot;edit&quot;, true);
1508             var pr = credentials.createPullRequest(repo, &quot;other&quot;, &quot;edit&quot;, issue.id() + &quot;: Fix that issue&quot;);
1509             pr.setBody(&quot;\n\n## Issue\n[&quot; + issue.id() + &quot;](http://www.test.test/): The issue&quot;);
1510             TestBotRunner.runPeriodicItems(notifyBot);
1511 
1512             // The issue should now contain a link to the PR
1513             var links = issue.links();
1514             assertEquals(1, links.size());
1515             assertEquals(pr.webUrl(), links.get(0).uri().orElseThrow());
1516             assertEquals(reviewIcon, links.get(0).iconUrl().orElseThrow());
1517 
1518             // Simulate integration
</pre>
</td>
<td>
<hr />
<pre>
  78     }
  79 
  80     @Test
  81     void testJsonUpdaterBranch(TestInfo testInfo) throws IOException {
  82         try (var credentials = new HostCredentials(testInfo);
  83              var tempFolder = new TemporaryDirectory()) {
  84             var repo = credentials.getHostedRepository();
  85             var localRepoFolder = tempFolder.path().resolve(&quot;repo&quot;);
  86             var localRepo = CheckableRepository.init(localRepoFolder, repo.repositoryType());
  87             credentials.commitLock(localRepo);
  88             localRepo.pushAll(repo.url());
  89 
  90             var tagStorage = createTagStorage(repo);
  91             var branchStorage = createBranchStorage(repo);
  92             var prIssuesStorage = createPullRequestIssuesStorage(repo);
  93             var jsonFolder = tempFolder.path().resolve(&quot;json&quot;);
  94             Files.createDirectory(jsonFolder);
  95             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
  96 
  97             var updater = new JsonUpdater(jsonFolder, &quot;12&quot;, &quot;team&quot;);
<span class="line-modified">  98             var notifyBot = NotifyBot.newBuilder()</span>
<span class="line-modified">  99                                      .repository(repo)</span>
<span class="line-added"> 100                                      .storagePath(storageFolder)</span>
<span class="line-added"> 101                                      .branches(Pattern.compile(&quot;master&quot;))</span>
<span class="line-added"> 102                                      .tagStorageBuilder(tagStorage)</span>
<span class="line-added"> 103                                      .branchStorageBuilder(branchStorage)</span>
<span class="line-added"> 104                                      .prIssuesStorageBuilder(prIssuesStorage)</span>
<span class="line-added"> 105                                      .updaters(List.of(updater))</span>
<span class="line-added"> 106                                      .build();</span>
 107 
 108             TestBotRunner.runPeriodicItems(notifyBot);
 109             assertEquals(List.of(), findJsonFiles(jsonFolder, &quot;&quot;));
 110 
 111             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;One more line&quot;, &quot;12345678: Fixes&quot;);
 112             localRepo.push(editHash, repo.url(), &quot;master&quot;);
 113             TestBotRunner.runPeriodicItems(notifyBot);
 114             var jsonFiles = findJsonFiles(jsonFolder, &quot;&quot;);
 115             assertEquals(1, jsonFiles.size());
 116             var jsonData = Files.readString(jsonFiles.get(0), StandardCharsets.UTF_8);
 117             var json = JSON.parse(jsonData);
 118             assertEquals(1, json.asArray().size());
 119             assertEquals(repo.webUrl(editHash).toString(), json.asArray().get(0).get(&quot;url&quot;).asString());
 120             assertEquals(List.of(&quot;12345678&quot;), json.asArray().get(0).get(&quot;issue&quot;).asArray().stream()
 121                                                   .map(JSONValue::asString)
 122                                                   .collect(Collectors.toList()));
 123         }
 124     }
 125 
 126     @Test
 127     void testJsonUpdaterTag(TestInfo testInfo) throws IOException {
 128         try (var credentials = new HostCredentials(testInfo);
 129              var tempFolder = new TemporaryDirectory()) {
 130             var repo = credentials.getHostedRepository();
 131             var localRepoFolder = tempFolder.path().resolve(&quot;repo&quot;);
 132             var localRepo = CheckableRepository.init(localRepoFolder, repo.repositoryType());
 133             credentials.commitLock(localRepo);
 134             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 135             localRepo.tag(masterHash, &quot;jdk-12+1&quot;, &quot;Added tag 1&quot;, &quot;Duke&quot;, &quot;duke@openjdk.java.net&quot;);
 136             localRepo.pushAll(repo.url());
 137 
 138             var tagStorage = createTagStorage(repo);
 139             var branchStorage = createBranchStorage(repo);
 140             var prIssuesStorage = createPullRequestIssuesStorage(repo);
 141             var jsonFolder = tempFolder.path().resolve(&quot;json&quot;);
 142             Files.createDirectory(jsonFolder);
 143             var storageFolder =tempFolder.path().resolve(&quot;storage&quot;);
 144 
 145             var updater = new JsonUpdater(jsonFolder, &quot;12&quot;, &quot;team&quot;);
<span class="line-modified"> 146             var notifyBot = NotifyBot.newBuilder()</span>
<span class="line-modified"> 147                                      .repository(repo)</span>
<span class="line-added"> 148                                      .storagePath(storageFolder)</span>
<span class="line-added"> 149                                      .branches(Pattern.compile(&quot;master&quot;))</span>
<span class="line-added"> 150                                      .tagStorageBuilder(tagStorage)</span>
<span class="line-added"> 151                                      .branchStorageBuilder(branchStorage)</span>
<span class="line-added"> 152                                      .prIssuesStorageBuilder(prIssuesStorage)</span>
<span class="line-added"> 153                                      .updaters(List.of(updater))</span>
<span class="line-added"> 154                                      .build();</span>
 155 
 156             TestBotRunner.runPeriodicItems(notifyBot);
 157             assertEquals(List.of(), findJsonFiles(jsonFolder, &quot;&quot;));
 158 
 159             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
 160             localRepo.fetch(repo.url(), &quot;history:history&quot;);
 161             localRepo.tag(editHash, &quot;jdk-12+2&quot;, &quot;Added tag 2&quot;, &quot;Duke&quot;, &quot;duke@openjdk.java.net&quot;);
 162             var editHash2 = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;34567890: Even more fixes&quot;);
 163             localRepo.tag(editHash2, &quot;jdk-12+4&quot;, &quot;Added tag 3&quot;, &quot;Duke&quot;, &quot;duke@openjdk.java.net&quot;);
 164             localRepo.pushAll(repo.url());
 165 
 166             TestBotRunner.runPeriodicItems(notifyBot);
 167             var jsonFiles = findJsonFiles(jsonFolder, &quot;&quot;);
 168             assertEquals(3, jsonFiles.size());
 169 
 170             for (var file : jsonFiles) {
 171                 var jsonData = Files.readString(file, StandardCharsets.UTF_8);
 172                 var json = JSON.parse(jsonData);
 173 
 174                 if (json.asArray().get(0).contains(&quot;date&quot;)) {
</pre>
<hr />
<pre>
 204     void testMailingList(TestInfo testInfo) throws IOException {
 205         try (var listServer = new TestMailmanServer();
 206              var credentials = new HostCredentials(testInfo);
 207              var tempFolder = new TemporaryDirectory()) {
 208             var repo = credentials.getHostedRepository();
 209             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
 210             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
 211             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 212             credentials.commitLock(localRepo);
 213             localRepo.pushAll(repo.url());
 214 
 215             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 216             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 217             var mailmanList = mailmanServer.getList(listAddress.address());
 218             var tagStorage = createTagStorage(repo);
 219             var branchStorage = createBranchStorage(repo);
 220             var prIssuesStorage = createPullRequestIssuesStorage(repo);
 221             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
 222 
 223             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
<span class="line-modified"> 224             var updater = MailingListUpdater.newBuilder()</span>
<span class="line-modified"> 225                                             .list(mailmanList)</span>
<span class="line-modified"> 226                                             .recipient(listAddress)</span>
<span class="line-modified"> 227                                             .sender(sender)</span>
<span class="line-modified"> 228                                             .reportNewTags(false)</span>
<span class="line-added"> 229                                             .reportNewBranches(false)</span>
<span class="line-added"> 230                                             .reportNewBuilds(false)</span>
<span class="line-added"> 231                                             .headers(Map.of(&quot;extra1&quot;, &quot;value1&quot;, &quot;extra2&quot;, &quot;value2&quot;))</span>
<span class="line-added"> 232                                             .allowedAuthorDomains(Pattern.compile(&quot;none&quot;))</span>
<span class="line-added"> 233                                             .build();</span>
<span class="line-added"> 234             var notifyBot = NotifyBot.newBuilder()</span>
<span class="line-added"> 235                                      .repository(repo)</span>
<span class="line-added"> 236                                      .storagePath(storageFolder)</span>
<span class="line-added"> 237                                      .branches(Pattern.compile(&quot;master&quot;))</span>
<span class="line-added"> 238                                      .tagStorageBuilder(tagStorage)</span>
<span class="line-added"> 239                                      .branchStorageBuilder(branchStorage)</span>
<span class="line-added"> 240                                      .prIssuesStorageBuilder(prIssuesStorage)</span>
<span class="line-added"> 241                                      .updaters(List.of(updater))</span>
<span class="line-added"> 242                                      .build();</span>
 243 
 244             // No mail should be sent on the first run as there is no history
 245             TestBotRunner.runPeriodicItems(notifyBot);
 246             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 247 
 248             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
 249             localRepo.push(editHash, repo.url(), &quot;master&quot;);
 250             TestBotRunner.runPeriodicItems(notifyBot);
 251             listServer.processIncoming();
 252 
 253             var conversations = mailmanList.conversations(Duration.ofDays(1));
 254             var email = conversations.get(0).first();
 255             assertEquals(listAddress, email.sender());
 256             assertEquals(sender, email.author());
 257             assertEquals(email.recipients(), List.of(listAddress));
 258             assertTrue(email.subject().contains(&quot;: 23456789: More fixes&quot;));
 259             assertFalse(email.subject().contains(&quot;master&quot;));
 260             assertTrue(email.body().contains(&quot;Changeset: &quot; + editHash.abbreviate()));
 261             assertTrue(email.body().contains(&quot;23456789: More fixes&quot;));
 262             assertFalse(email.body().contains(&quot;Committer&quot;));
</pre>
<hr />
<pre>
 272     void testMailingListMultiple(TestInfo testInfo) throws IOException {
 273         try (var listServer = new TestMailmanServer();
 274              var credentials = new HostCredentials(testInfo);
 275              var tempFolder = new TemporaryDirectory()) {
 276             var repo = credentials.getHostedRepository();
 277             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
 278             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
 279             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 280             credentials.commitLock(localRepo);
 281             localRepo.pushAll(repo.url());
 282 
 283             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 284             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 285             var mailmanList = mailmanServer.getList(listAddress.address());
 286             var tagStorage = createTagStorage(repo);
 287             var branchStorage = createBranchStorage(repo);
 288             var prIssuesStorage = createPullRequestIssuesStorage(repo);
 289             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
 290 
 291             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
<span class="line-modified"> 292             var updater = MailingListUpdater.newBuilder()</span>
<span class="line-modified"> 293                                             .list(mailmanList)</span>
<span class="line-modified"> 294                                             .recipient(listAddress)</span>
<span class="line-modified"> 295                                             .sender(sender)</span>
<span class="line-modified"> 296                                             .reportNewTags(false)</span>
<span class="line-added"> 297                                             .reportNewBranches(false)</span>
<span class="line-added"> 298                                             .reportNewBuilds(false)</span>
<span class="line-added"> 299                                             .build();</span>
<span class="line-added"> 300             var notifyBot = NotifyBot.newBuilder()</span>
<span class="line-added"> 301                                      .repository(repo)</span>
<span class="line-added"> 302                                      .storagePath(storageFolder)</span>
<span class="line-added"> 303                                      .branches(Pattern.compile(&quot;master&quot;))</span>
<span class="line-added"> 304                                      .tagStorageBuilder(tagStorage)</span>
<span class="line-added"> 305                                      .branchStorageBuilder(branchStorage)</span>
<span class="line-added"> 306                                      .prIssuesStorageBuilder(prIssuesStorage)</span>
<span class="line-added"> 307                                      .updaters(List.of(updater))</span>
<span class="line-added"> 308                                      .build();</span>
 309 
 310             // No mail should be sent on the first run as there is no history
 311             TestBotRunner.runPeriodicItems(notifyBot);
 312             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 313 
 314             var editHash1 = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;,
 315                                                                 &quot;first_author&quot;, &quot;first@author.example.com&quot;);
 316             localRepo.push(editHash1, repo.url(), &quot;master&quot;);
 317             var editHash2 = CheckableRepository.appendAndCommit(localRepo, &quot;Yet another line&quot;, &quot;3456789A: Even more fixes&quot;,
 318                                                                 &quot;another_author&quot;, &quot;another@author.example.com&quot;);
 319             localRepo.push(editHash2, repo.url(), &quot;master&quot;);
 320 
 321             TestBotRunner.runPeriodicItems(notifyBot);
 322             listServer.processIncoming();
 323 
 324             var conversations = mailmanList.conversations(Duration.ofDays(1));
 325             var email = conversations.get(0).first();
 326             assertEquals(listAddress, email.sender());
 327             assertEquals(EmailAddress.from(&quot;another_author&quot;, &quot;another@author.example.com&quot;), email.author());
 328             assertEquals(email.recipients(), List.of(listAddress));
</pre>
<hr />
<pre>
 340     void testMailingListSponsored(TestInfo testInfo) throws IOException {
 341         try (var listServer = new TestMailmanServer();
 342              var credentials = new HostCredentials(testInfo);
 343              var tempFolder = new TemporaryDirectory()) {
 344             var repo = credentials.getHostedRepository();
 345             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
 346             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
 347             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 348             credentials.commitLock(localRepo);
 349             localRepo.pushAll(repo.url());
 350 
 351             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 352             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 353             var mailmanList = mailmanServer.getList(listAddress.address());
 354             var tagStorage = createTagStorage(repo);
 355             var branchStorage = createBranchStorage(repo);
 356             var prIssuesStorage = createPullRequestIssuesStorage(repo);
 357             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
 358 
 359             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
<span class="line-modified"> 360             var updater = MailingListUpdater.newBuilder()</span>
<span class="line-modified"> 361                                             .list(mailmanList)</span>
<span class="line-modified"> 362                                             .recipient(listAddress)</span>
<span class="line-modified"> 363                                             .sender(sender)</span>
<span class="line-modified"> 364                                             .reportNewTags(false)</span>
<span class="line-added"> 365                                             .reportNewBranches(false)</span>
<span class="line-added"> 366                                             .reportNewBuilds(false)</span>
<span class="line-added"> 367                                             .build();</span>
<span class="line-added"> 368             var notifyBot = NotifyBot.newBuilder()</span>
<span class="line-added"> 369                                      .repository(repo)</span>
<span class="line-added"> 370                                      .storagePath(storageFolder)</span>
<span class="line-added"> 371                                      .branches(Pattern.compile(&quot;master&quot;))</span>
<span class="line-added"> 372                                      .tagStorageBuilder(tagStorage)</span>
<span class="line-added"> 373                                      .branchStorageBuilder(branchStorage)</span>
<span class="line-added"> 374                                      .prIssuesStorageBuilder(prIssuesStorage)</span>
<span class="line-added"> 375                                      .updaters(List.of(updater))</span>
<span class="line-added"> 376                                      .build();</span>
 377 
 378             // No mail should be sent on the first run as there is no history
 379             TestBotRunner.runPeriodicItems(notifyBot);
 380             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 381 
 382             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;,
 383                                                                &quot;author&quot;, &quot;author@test.test&quot;,
 384                                                                &quot;committer&quot;, &quot;committer@test.test&quot;);
 385             localRepo.push(editHash, repo.url(), &quot;master&quot;);
 386             TestBotRunner.runPeriodicItems(notifyBot);
 387             listServer.processIncoming();
 388 
 389             var conversations = mailmanList.conversations(Duration.ofDays(1));
 390             var email = conversations.get(0).first();
 391             assertEquals(listAddress, email.sender());
 392             assertEquals(EmailAddress.from(&quot;committer&quot;, &quot;committer@test.test&quot;), email.author());
 393             assertEquals(email.recipients(), List.of(listAddress));
 394             assertTrue(email.body().contains(&quot;Changeset: &quot; + editHash.abbreviate()));
 395             assertTrue(email.body().contains(&quot;23456789: More fixes&quot;));
 396             assertTrue(email.body().contains(&quot;Author:    author &lt;author@test.test&gt;&quot;));
</pre>
<hr />
<pre>
 405              var credentials = new HostCredentials(testInfo);
 406              var tempFolder = new TemporaryDirectory()) {
 407             var repo = credentials.getHostedRepository();
 408             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
 409             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
 410             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 411             credentials.commitLock(localRepo);
 412             var branch = localRepo.branch(masterHash, &quot;another&quot;);
 413             localRepo.pushAll(repo.url());
 414 
 415             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 416             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 417             var mailmanList = mailmanServer.getList(listAddress.address());
 418             var tagStorage = createTagStorage(repo);
 419             var branchStorage = createBranchStorage(repo);
 420             var prIssuesStorage = createPullRequestIssuesStorage(repo);
 421             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
 422 
 423             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
 424             var author = EmailAddress.from(&quot;author&quot;, &quot;author@duke.duke&quot;);
<span class="line-modified"> 425             var updater = MailingListUpdater.newBuilder()</span>
<span class="line-modified"> 426                                             .list(mailmanList)</span>
<span class="line-modified"> 427                                             .recipient(listAddress)</span>
<span class="line-modified"> 428                                             .sender(sender)</span>
<span class="line-modified"> 429                                             .author(author)</span>
<span class="line-added"> 430                                             .includeBranch(true)</span>
<span class="line-added"> 431                                             .reportNewTags(false)</span>
<span class="line-added"> 432                                             .reportNewBranches(false)</span>
<span class="line-added"> 433                                             .reportNewBuilds(false)</span>
<span class="line-added"> 434                                             .build();</span>
<span class="line-added"> 435             var notifyBot = NotifyBot.newBuilder()</span>
<span class="line-added"> 436                                      .repository(repo)</span>
<span class="line-added"> 437                                      .storagePath(storageFolder)</span>
<span class="line-added"> 438                                      .branches(Pattern.compile(&quot;master|another&quot;))</span>
<span class="line-added"> 439                                      .tagStorageBuilder(tagStorage)</span>
<span class="line-added"> 440                                      .branchStorageBuilder(branchStorage)</span>
<span class="line-added"> 441                                      .prIssuesStorageBuilder(prIssuesStorage)</span>
<span class="line-added"> 442                                      .updaters(List.of(updater))</span>
<span class="line-added"> 443                                      .build();</span>
 444 
 445             // No mail should be sent on the first run as there is no history
 446             TestBotRunner.runPeriodicItems(notifyBot);
 447             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 448 
 449             var editHash1 = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
 450             localRepo.push(editHash1, repo.url(), &quot;master&quot;);
 451             var editHash2 = CheckableRepository.appendAndCommit(localRepo, &quot;Yet another line&quot;, &quot;3456789A: Even more fixes&quot;);
 452             localRepo.push(editHash2, repo.url(), &quot;master&quot;);
 453 
 454             TestBotRunner.runPeriodicItems(notifyBot);
 455             listServer.processIncoming();
 456 
 457             var conversations = mailmanList.conversations(Duration.ofDays(1));
 458             var email = conversations.get(0).first();
 459             assertEquals(listAddress, email.sender());
 460             assertEquals(author, email.author());
 461             assertEquals(email.recipients(), List.of(listAddress));
 462             assertFalse(email.subject().contains(&quot;another&quot;));
 463             assertTrue(email.subject().contains(&quot;: master: 2 new changesets&quot;));
</pre>
<hr />
<pre>
 495         try (var listServer = new TestMailmanServer();
 496              var credentials = new HostCredentials(testInfo);
 497              var tempFolder = new TemporaryDirectory()) {
 498             var repo = credentials.getHostedRepository();
 499             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
 500             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
 501             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 502             credentials.commitLock(localRepo);
 503             localRepo.pushAll(repo.url());
 504 
 505             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 506             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 507             var mailmanList = mailmanServer.getList(listAddress.address());
 508             var tagStorage = createTagStorage(repo);
 509             var branchStorage = createBranchStorage(repo);
 510             var prIssuesStorage = createPullRequestIssuesStorage(repo);
 511             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
 512 
 513             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
 514             var author = EmailAddress.from(&quot;author&quot;, &quot;author@duke.duke&quot;);
<span class="line-modified"> 515             var updater = MailingListUpdater.newBuilder()</span>
<span class="line-modified"> 516                                             .list(mailmanList)</span>
<span class="line-modified"> 517                                             .recipient(listAddress)</span>
<span class="line-modified"> 518                                             .sender(sender)</span>
<span class="line-modified"> 519                                             .author(author)</span>
<span class="line-modified"> 520                                             .reportNewTags(false)</span>
<span class="line-added"> 521                                             .reportNewBranches(false)</span>
<span class="line-added"> 522                                             .reportNewBuilds(false)</span>
<span class="line-added"> 523                                             .mode(MailingListUpdater.Mode.PR_ONLY)</span>
<span class="line-added"> 524                                             .headers(Map.of(&quot;extra1&quot;, &quot;value1&quot;))</span>
<span class="line-added"> 525                                             .build();</span>
<span class="line-added"> 526             var notifyBot = NotifyBot.newBuilder()</span>
<span class="line-added"> 527                                      .repository(repo)</span>
<span class="line-added"> 528                                      .storagePath(storageFolder)</span>
<span class="line-added"> 529                                      .branches(Pattern.compile(&quot;master&quot;))</span>
<span class="line-added"> 530                                      .tagStorageBuilder(tagStorage)</span>
<span class="line-added"> 531                                      .branchStorageBuilder(branchStorage)</span>
<span class="line-added"> 532                                      .prIssuesStorageBuilder(prIssuesStorage)</span>
<span class="line-added"> 533                                      .updaters(List.of(updater))</span>
<span class="line-added"> 534                                      .build();</span>
 535 
 536             // No mail should be sent on the first run as there is no history
 537             TestBotRunner.runPeriodicItems(notifyBot);
 538             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 539 
 540             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
 541             localRepo.push(editHash, repo.url(), &quot;edit&quot;);
 542             var pr = credentials.createPullRequest(repo, &quot;master&quot;, &quot;edit&quot;, &quot;RFR: My PR&quot;);
 543 
 544             // Create a potentially conflicting one
 545             var otherHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
 546             localRepo.push(otherHash, repo.url(), &quot;other&quot;);
 547             var otherPr = credentials.createPullRequest(repo, &quot;master&quot;, &quot;other&quot;, &quot;RFR: My other PR&quot;);
 548 
 549             // PR hasn&#39;t been integrated yet, so there should be no mail
 550             TestBotRunner.runPeriodicItems(notifyBot);
 551             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 552 
 553             // Simulate an RFR email
 554             var rfr = Email.create(sender, &quot;RFR: My PR&quot;, &quot;PR: &quot; + pr.webUrl().toString())
</pre>
<hr />
<pre>
 590     void testMailingListPR(TestInfo testInfo) throws IOException {
 591         try (var listServer = new TestMailmanServer();
 592              var credentials = new HostCredentials(testInfo);
 593              var tempFolder = new TemporaryDirectory()) {
 594             var repo = credentials.getHostedRepository();
 595             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
 596             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
 597             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 598             credentials.commitLock(localRepo);
 599             localRepo.pushAll(repo.url());
 600 
 601             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 602             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 603             var mailmanList = mailmanServer.getList(listAddress.address());
 604             var tagStorage = createTagStorage(repo);
 605             var branchStorage = createBranchStorage(repo);
 606             var prIssuesStorage = createPullRequestIssuesStorage(repo);
 607             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
 608 
 609             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
<span class="line-modified"> 610             var updater = MailingListUpdater.newBuilder()</span>
<span class="line-modified"> 611                                             .list(mailmanList)</span>
<span class="line-modified"> 612                                             .recipient(listAddress)</span>
<span class="line-modified"> 613                                             .sender(sender)</span>
<span class="line-modified"> 614                                             .reportNewTags(false)</span>
<span class="line-added"> 615                                             .reportNewBranches(false)</span>
<span class="line-added"> 616                                             .reportNewBuilds(false)</span>
<span class="line-added"> 617                                             .mode(MailingListUpdater.Mode.PR)</span>
<span class="line-added"> 618                                             .build();</span>
<span class="line-added"> 619             var notifyBot = NotifyBot.newBuilder()</span>
<span class="line-added"> 620                                      .repository(repo)</span>
<span class="line-added"> 621                                      .storagePath(storageFolder)</span>
<span class="line-added"> 622                                      .branches(Pattern.compile(&quot;master&quot;))</span>
<span class="line-added"> 623                                      .tagStorageBuilder(tagStorage)</span>
<span class="line-added"> 624                                      .branchStorageBuilder(branchStorage)</span>
<span class="line-added"> 625                                      .prIssuesStorageBuilder(prIssuesStorage)</span>
<span class="line-added"> 626                                      .updaters(List.of(updater))</span>
<span class="line-added"> 627                                      .build();</span>
 628 
 629             // No mail should be sent on the first run as there is no history
 630             TestBotRunner.runPeriodicItems(notifyBot);
 631             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 632 
 633             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
 634             localRepo.push(editHash, repo.url(), &quot;edit&quot;);
 635             var pr = credentials.createPullRequest(repo, &quot;master&quot;, &quot;edit&quot;, &quot;RFR: My PR&quot;);
 636 
 637             // Create a potentially conflicting one
 638             var otherHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
 639             localRepo.push(otherHash, repo.url(), &quot;other&quot;);
 640             var otherPr = credentials.createPullRequest(repo, &quot;master&quot;, &quot;other&quot;, &quot;RFR: My other PR&quot;);
 641 
 642             // PR hasn&#39;t been integrated yet, so there should be no mail
 643             TestBotRunner.runPeriodicItems(notifyBot);
 644             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 645 
 646             // Simulate an RFR email
 647             var rfr = Email.create(&quot;RFR: My PR&quot;, &quot;PR:\n&quot; + pr.webUrl().toString())
</pre>
<hr />
<pre>
 693         try (var listServer = new TestMailmanServer();
 694              var credentials = new HostCredentials(testInfo);
 695              var tempFolder = new TemporaryDirectory()) {
 696             var repo = credentials.getHostedRepository();
 697             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
 698             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
 699             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 700             localRepo.branch(masterHash, &quot;other&quot;);
 701             credentials.commitLock(localRepo);
 702             localRepo.pushAll(repo.url());
 703 
 704             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 705             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 706             var mailmanList = mailmanServer.getList(listAddress.address());
 707             var tagStorage = createTagStorage(repo);
 708             var branchStorage = createBranchStorage(repo);
 709             var prIssuesStorage = createPullRequestIssuesStorage(repo);
 710             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
 711 
 712             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
<span class="line-modified"> 713             var updater = MailingListUpdater.newBuilder()</span>
<span class="line-modified"> 714                                             .list(mailmanList)</span>
<span class="line-modified"> 715                                             .recipient(listAddress)</span>
<span class="line-modified"> 716                                             .sender(sender)</span>
<span class="line-modified"> 717                                             .author(null)</span>
<span class="line-added"> 718                                             .reportNewTags(false)</span>
<span class="line-added"> 719                                             .reportNewBranches(false)</span>
<span class="line-added"> 720                                             .reportNewBuilds(false)</span>
<span class="line-added"> 721                                             .mode(MailingListUpdater.Mode.PR)</span>
<span class="line-added"> 722                                             .build();</span>
<span class="line-added"> 723             var notifyBot = NotifyBot.newBuilder()</span>
<span class="line-added"> 724                                      .repository(repo)</span>
<span class="line-added"> 725                                      .storagePath(storageFolder)</span>
<span class="line-added"> 726                                      .branches(Pattern.compile(&quot;master|other&quot;))</span>
<span class="line-added"> 727                                      .tagStorageBuilder(tagStorage)</span>
<span class="line-added"> 728                                      .branchStorageBuilder(branchStorage)</span>
<span class="line-added"> 729                                      .prIssuesStorageBuilder(prIssuesStorage)</span>
<span class="line-added"> 730                                      .updaters(List.of(updater))</span>
<span class="line-added"> 731                                      .build();</span>
 732 
 733             // No mail should be sent on the first run as there is no history
 734             TestBotRunner.runPeriodicItems(notifyBot);
 735             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 736 
 737             localRepo.checkout(masterHash, true);
 738             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
 739             localRepo.push(editHash, repo.url(), &quot;edit&quot;);
 740             var pr = credentials.createPullRequest(repo, &quot;master&quot;, &quot;edit&quot;, &quot;RFR: My PR&quot;);
 741 
 742             // PR hasn&#39;t been integrated yet, so there should be no mail
 743             TestBotRunner.runPeriodicItems(notifyBot);
 744             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 745 
 746             // Simulate an RFR email
 747             var rfr = Email.create(&quot;RFR: My PR&quot;, &quot;PR:\n&quot; + pr.webUrl().toString())
 748                            .author(EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;))
 749                            .recipient(listAddress)
 750                            .build();
 751             mailmanList.post(rfr);
</pre>
<hr />
<pre>
 797         try (var credentials = new HostCredentials(testInfo);
 798              var tempFolder = new TemporaryDirectory();
 799              var listServer = new TestMailmanServer()) {
 800             var repo = credentials.getHostedRepository();
 801             var localRepoFolder = tempFolder.path().resolve(&quot;repo&quot;);
 802             var localRepo = CheckableRepository.init(localRepoFolder, repo.repositoryType());
 803             credentials.commitLock(localRepo);
 804             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 805             localRepo.tag(masterHash, &quot;jdk-12+1&quot;, &quot;Added tag 1&quot;, &quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;);
 806             localRepo.pushAll(repo.url());
 807 
 808             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 809             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 810             var mailmanList = mailmanServer.getList(listAddress.address());
 811             var tagStorage = createTagStorage(repo);
 812             var branchStorage = createBranchStorage(repo);
 813             var prIssuesStorage = createPullRequestIssuesStorage(repo);
 814             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
 815 
 816             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
<span class="line-modified"> 817             var updater = MailingListUpdater.newBuilder()</span>
<span class="line-modified"> 818                                             .list(mailmanList)</span>
<span class="line-modified"> 819                                             .recipient(listAddress)</span>
<span class="line-modified"> 820                                             .sender(sender)</span>
<span class="line-modified"> 821                                             .reportNewBranches(false)</span>
<span class="line-modified"> 822                                             .headers(Map.of(&quot;extra1&quot;, &quot;value1&quot;, &quot;extra2&quot;, &quot;value2&quot;))</span>
<span class="line-modified"> 823                                             .build();</span>
<span class="line-modified"> 824             var prOnlyUpdater = MailingListUpdater.newBuilder()</span>
<span class="line-modified"> 825                                                   .list(mailmanList)</span>
<span class="line-modified"> 826                                                   .recipient(listAddress)</span>
<span class="line-added"> 827                                                   .sender(sender)</span>
<span class="line-added"> 828                                                   .reportNewTags(false)</span>
<span class="line-added"> 829                                                   .reportNewBranches(false)</span>
<span class="line-added"> 830                                                   .reportNewBuilds(false)</span>
<span class="line-added"> 831                                                   .mode(MailingListUpdater.Mode.PR_ONLY)</span>
<span class="line-added"> 832                                                   .build();</span>
<span class="line-added"> 833             var notifyBot = NotifyBot.newBuilder()</span>
<span class="line-added"> 834                                      .repository(repo)</span>
<span class="line-added"> 835                                      .storagePath(storageFolder)</span>
<span class="line-added"> 836                                      .branches(Pattern.compile(&quot;master&quot;))</span>
<span class="line-added"> 837                                      .tagStorageBuilder(tagStorage)</span>
<span class="line-added"> 838                                      .branchStorageBuilder(branchStorage)</span>
<span class="line-added"> 839                                      .prIssuesStorageBuilder(prIssuesStorage)</span>
<span class="line-added"> 840                                      .updaters(List.of(updater, prOnlyUpdater))</span>
<span class="line-added"> 841                                      .build();</span>
 842 
 843             // No mail should be sent on the first run as there is no history
 844             TestBotRunner.runPeriodicItems(notifyBot);
 845             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 846 
 847             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
 848             localRepo.fetch(repo.url(), &quot;history:history&quot;);
 849             localRepo.tag(editHash, &quot;jdk-12+2&quot;, &quot;Added tag 2&quot;, &quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;);
 850             CheckableRepository.appendAndCommit(localRepo, &quot;Another line 1&quot;, &quot;34567890: Even more fixes&quot;);
 851             CheckableRepository.appendAndCommit(localRepo, &quot;Another line 2&quot;, &quot;45678901: Yet even more fixes&quot;);
 852             var editHash2 = CheckableRepository.appendAndCommit(localRepo, &quot;Another line 3&quot;, &quot;56789012: Still even more fixes&quot;);
 853             localRepo.tag(editHash2, &quot;jdk-12+4&quot;, &quot;Added tag 3&quot;, &quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;);
 854             CheckableRepository.appendAndCommit(localRepo, &quot;Another line 4&quot;, &quot;67890123: Brand new fixes&quot;);
 855             var editHash3 = CheckableRepository.appendAndCommit(localRepo, &quot;Another line 5&quot;, &quot;78901234: More brand new fixes&quot;);
 856             localRepo.tag(editHash3, &quot;jdk-13+0&quot;, &quot;Added tag 4&quot;, &quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;);
 857             localRepo.pushAll(repo.url());
 858 
 859             TestBotRunner.runPeriodicItems(notifyBot);
 860             listServer.processIncoming();
 861             listServer.processIncoming();
</pre>
<hr />
<pre>
 915         try (var credentials = new HostCredentials(testInfo);
 916              var tempFolder = new TemporaryDirectory();
 917              var listServer = new TestMailmanServer()) {
 918             var repo = credentials.getHostedRepository();
 919             var localRepoFolder = tempFolder.path().resolve(&quot;repo&quot;);
 920             var localRepo = CheckableRepository.init(localRepoFolder, repo.repositoryType());
 921             credentials.commitLock(localRepo);
 922             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
 923             localRepo.tag(masterHash, &quot;jdk-12+1&quot;, &quot;Added tag 1&quot;, &quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;);
 924             localRepo.pushAll(repo.url());
 925 
 926             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
 927             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
 928             var mailmanList = mailmanServer.getList(listAddress.address());
 929             var tagStorage = createTagStorage(repo);
 930             var branchStorage = createBranchStorage(repo);
 931             var prIssuesStorage = createPullRequestIssuesStorage(repo);
 932             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
 933 
 934             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
<span class="line-modified"> 935             var updater = MailingListUpdater.newBuilder()</span>
<span class="line-modified"> 936                                             .list(mailmanList)</span>
<span class="line-modified"> 937                                             .recipient(listAddress)</span>
<span class="line-modified"> 938                                             .sender(sender)</span>
<span class="line-modified"> 939                                             .reportNewBranches(false)</span>
<span class="line-modified"> 940                                             .reportNewBuilds(false)</span>
<span class="line-modified"> 941                                             .headers(Map.of(&quot;extra1&quot;, &quot;value1&quot;, &quot;extra2&quot;, &quot;value2&quot;))</span>
<span class="line-modified"> 942                                             .build();</span>
<span class="line-modified"> 943             var prOnlyUpdater = MailingListUpdater.newBuilder()</span>
<span class="line-modified"> 944                                                   .list(mailmanList)</span>
<span class="line-added"> 945                                                   .recipient(listAddress)</span>
<span class="line-added"> 946                                                   .sender(sender)</span>
<span class="line-added"> 947                                                   .reportNewTags(false)</span>
<span class="line-added"> 948                                                   .reportNewBranches(false)</span>
<span class="line-added"> 949                                                   .reportNewBuilds(false)</span>
<span class="line-added"> 950                                                   .mode(MailingListUpdater.Mode.PR_ONLY)</span>
<span class="line-added"> 951                                                   .build();</span>
<span class="line-added"> 952             var notifyBot = NotifyBot.newBuilder()</span>
<span class="line-added"> 953                                      .repository(repo)</span>
<span class="line-added"> 954                                      .storagePath(storageFolder)</span>
<span class="line-added"> 955                                      .branches(Pattern.compile(&quot;master&quot;))</span>
<span class="line-added"> 956                                      .tagStorageBuilder(tagStorage)</span>
<span class="line-added"> 957                                      .branchStorageBuilder(branchStorage)</span>
<span class="line-added"> 958                                      .prIssuesStorageBuilder(prIssuesStorage)</span>
<span class="line-added"> 959                                      .updaters(List.of(updater, prOnlyUpdater))</span>
<span class="line-added"> 960                                      .build();</span>
 961 
 962             // No mail should be sent on the first run as there is no history
 963             TestBotRunner.runPeriodicItems(notifyBot);
 964             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
 965 
 966             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
 967             localRepo.fetch(repo.url(), &quot;history:history&quot;);
 968             localRepo.tag(editHash, &quot;jdk-12+2&quot;, &quot;Added tag 2&quot;, &quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;);
 969             CheckableRepository.appendAndCommit(localRepo, &quot;Another line 1&quot;, &quot;34567890: Even more fixes&quot;);
 970             CheckableRepository.appendAndCommit(localRepo, &quot;Another line 2&quot;, &quot;45678901: Yet even more fixes&quot;);
 971             var editHash2 = CheckableRepository.appendAndCommit(localRepo, &quot;Another line 3&quot;, &quot;56789012: Still even more fixes&quot;);
 972             localRepo.tag(editHash2, &quot;jdk-12+4&quot;, &quot;Added tag 3&quot;, &quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;);
 973             CheckableRepository.appendAndCommit(localRepo, &quot;Another line 4&quot;, &quot;67890123: Brand new fixes&quot;);
 974             var editHash3 = CheckableRepository.appendAndCommit(localRepo, &quot;Another line 5&quot;, &quot;78901234: More brand new fixes&quot;);
 975             localRepo.tag(editHash3, &quot;jdk-13+0&quot;, &quot;Added tag 4&quot;, &quot;Duke Tagger&quot;, &quot;tagger@openjdk.java.net&quot;);
 976             localRepo.pushAll(repo.url());
 977 
 978             TestBotRunner.runPeriodicItems(notifyBot);
 979             listServer.processIncoming();
 980             listServer.processIncoming();
</pre>
<hr />
<pre>
1009     void testMailingListBranch(TestInfo testInfo) throws IOException {
1010         try (var listServer = new TestMailmanServer();
1011              var credentials = new HostCredentials(testInfo);
1012              var tempFolder = new TemporaryDirectory()) {
1013             var repo = credentials.getHostedRepository();
1014             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
1015             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
1016             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1017             credentials.commitLock(localRepo);
1018             localRepo.pushAll(repo.url());
1019 
1020             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1021             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
1022             var mailmanList = mailmanServer.getList(listAddress.address());
1023             var tagStorage = createTagStorage(repo);
1024             var branchStorage = createBranchStorage(repo);
1025             var prIssuesStorage = createPullRequestIssuesStorage(repo);
1026             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
1027 
1028             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
<span class="line-modified">1029             var updater = MailingListUpdater.newBuilder()</span>
<span class="line-modified">1030                                             .list(mailmanList)</span>
<span class="line-modified">1031                                             .recipient(listAddress)</span>
<span class="line-modified">1032                                             .sender(sender)</span>
<span class="line-modified">1033                                             .reportNewTags(false)</span>
<span class="line-modified">1034                                             .reportNewBuilds(false)</span>
<span class="line-modified">1035                                             .headers(Map.of(&quot;extra1&quot;, &quot;value1&quot;, &quot;extra2&quot;, &quot;value2&quot;))</span>
<span class="line-added">1036                                             .build();</span>
<span class="line-added">1037             var notifyBot = NotifyBot.newBuilder()</span>
<span class="line-added">1038                                      .repository(repo)</span>
<span class="line-added">1039                                      .storagePath(storageFolder)</span>
<span class="line-added">1040                                      .branches(Pattern.compile(&quot;master|newbranch.&quot;))</span>
<span class="line-added">1041                                      .tagStorageBuilder(tagStorage)</span>
<span class="line-added">1042                                      .branchStorageBuilder(branchStorage)</span>
<span class="line-added">1043                                      .prIssuesStorageBuilder(prIssuesStorage)</span>
<span class="line-added">1044                                      .updaters(List.of(updater))</span>
<span class="line-added">1045                                      .build();</span>
1046 
1047             // No mail should be sent on the first run as there is no history
1048             TestBotRunner.runPeriodicItems(notifyBot);
1049             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
1050 
1051             CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;12345678: Some fixes&quot;);
1052             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
1053             localRepo.push(editHash, repo.url(), &quot;newbranch1&quot;);
1054             TestBotRunner.runPeriodicItems(notifyBot);
1055             listServer.processIncoming();
1056 
1057             var conversations = mailmanList.conversations(Duration.ofDays(1));
1058             var email = conversations.get(0).first();
1059             assertEquals(listAddress, email.sender());
1060             assertEquals(EmailAddress.from(&quot;testauthor&quot;, &quot;ta@none.none&quot;), email.author());
1061             assertEquals(email.recipients(), List.of(listAddress));
1062             assertEquals(&quot;git: test: created branch newbranch1 based on the branch master containing 2 unique commits&quot;, email.subject());
1063             assertTrue(email.body().contains(&quot;12345678: Some fixes&quot;));
1064             assertTrue(email.hasHeader(&quot;extra1&quot;));
1065             assertEquals(&quot;value1&quot;, email.headerValue(&quot;extra1&quot;));
</pre>
<hr />
<pre>
1089     void testMailingListNoIdempotence(TestInfo testInfo) throws IOException {
1090         try (var listServer = new TestMailmanServer();
1091              var credentials = new HostCredentials(testInfo);
1092              var tempFolder = new TemporaryDirectory()) {
1093             var repo = credentials.getHostedRepository();
1094             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
1095             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
1096             var masterHash = localRepo.resolve(&quot;master&quot;).orElseThrow();
1097             credentials.commitLock(localRepo);
1098             localRepo.pushAll(repo.url());
1099 
1100             var listAddress = EmailAddress.parse(listServer.createList(&quot;test&quot;));
1101             var mailmanServer = MailingListServerFactory.createMailmanServer(listServer.getArchive(), listServer.getSMTP(), Duration.ZERO);
1102             var mailmanList = mailmanServer.getList(listAddress.address());
1103             var tagStorage = createTagStorage(repo);
1104             var branchStorage = createBranchStorage(repo);
1105             var prIssuesStorage = createPullRequestIssuesStorage(repo);
1106             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
1107 
1108             var sender = EmailAddress.from(&quot;duke&quot;, &quot;duke@duke.duke&quot;);
<span class="line-modified">1109             var updater = MailingListUpdater.newBuilder()</span>
<span class="line-modified">1110                                             .list(mailmanList)</span>
<span class="line-modified">1111                                             .recipient(listAddress)</span>
<span class="line-modified">1112                                             .sender(sender)</span>
<span class="line-modified">1113                                             .reportNewTags(false)</span>
<span class="line-modified">1114                                             .reportNewBranches(false)</span>
<span class="line-added">1115                                             .reportNewBuilds(false)</span>
<span class="line-added">1116                                             .headers(Map.of(&quot;extra1&quot;, &quot;value1&quot;, &quot;extra2&quot;, &quot;value2&quot;))</span>
<span class="line-added">1117                                             .allowedAuthorDomains(Pattern.compile(&quot;none&quot;))</span>
<span class="line-added">1118                                             .build();</span>
<span class="line-added">1119             var notifyBot = NotifyBot.newBuilder()</span>
<span class="line-added">1120                                      .repository(repo)</span>
<span class="line-added">1121                                      .storagePath(storageFolder)</span>
<span class="line-added">1122                                      .branches(Pattern.compile(&quot;master&quot;))</span>
<span class="line-added">1123                                      .tagStorageBuilder(tagStorage)</span>
<span class="line-added">1124                                      .branchStorageBuilder(branchStorage)</span>
<span class="line-added">1125                                      .prIssuesStorageBuilder(prIssuesStorage)</span>
<span class="line-added">1126                                      .updaters(List.of(updater))</span>
<span class="line-added">1127                                      .build();</span>
1128 
1129             // No mail should be sent on the first run as there is no history
1130             TestBotRunner.runPeriodicItems(notifyBot);
1131             assertThrows(RuntimeException.class, () -&gt; listServer.processIncoming(Duration.ofMillis(1)));
1132 
1133             // Save history state
1134             var historyHash = localRepo.fetch(repo.url(), &quot;history&quot;);
1135 
1136             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;23456789: More fixes&quot;);
1137             localRepo.push(editHash, repo.url(), &quot;master&quot;);
1138             TestBotRunner.runPeriodicItems(notifyBot);
1139             listServer.processIncoming();
1140 
1141             var conversations = mailmanList.conversations(Duration.ofDays(1));
1142             assertEquals(1, conversations.size());
1143 
1144             // Reset the history
1145             localRepo.push(historyHash, repo.url(), &quot;history&quot;, true);
1146             TestBotRunner.runPeriodicItems(notifyBot);
1147             listServer.processIncoming();
</pre>
<hr />
<pre>
1152         }
1153     }
1154 
1155     @Test
1156     void testIssue(TestInfo testInfo) throws IOException {
1157         try (var credentials = new HostCredentials(testInfo);
1158              var tempFolder = new TemporaryDirectory()) {
1159             var repo = credentials.getHostedRepository();
1160             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
1161             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
1162             credentials.commitLock(localRepo);
1163             localRepo.pushAll(repo.url());
1164 
1165             var tagStorage = createTagStorage(repo);
1166             var branchStorage = createBranchStorage(repo);
1167             var prIssuesStorage = createPullRequestIssuesStorage(repo);
1168             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
1169 
1170             var issueProject = credentials.getIssueProject();
1171             var commitIcon = URI.create(&quot;http://www.example.com/commit.png&quot;);
<span class="line-modified">1172             var updater = IssueUpdater.newBuilder()</span>
<span class="line-modified">1173                                       .issueProject(issueProject)</span>
<span class="line-modified">1174                                       .reviewLink(false)</span>
<span class="line-added">1175                                       .commitIcon(commitIcon)</span>
<span class="line-added">1176                                       .setFixVersion(true)</span>
<span class="line-added">1177                                       .build();</span>
<span class="line-added">1178             var notifyBot = NotifyBot.newBuilder()</span>
<span class="line-added">1179                                      .repository(repo)</span>
<span class="line-added">1180                                      .storagePath(storageFolder)</span>
<span class="line-added">1181                                      .branches(Pattern.compile(&quot;master&quot;))</span>
<span class="line-added">1182                                      .tagStorageBuilder(tagStorage)</span>
<span class="line-added">1183                                      .branchStorageBuilder(branchStorage)</span>
<span class="line-added">1184                                      .prIssuesStorageBuilder(prIssuesStorage)</span>
<span class="line-added">1185                                      .updaters(List.of(updater))</span>
<span class="line-added">1186                                      .build();</span>
1187 
1188             // Initialize history
1189             TestBotRunner.runPeriodicItems(notifyBot);
1190 
1191             // Create an issue and commit a fix
1192             var authorEmailAddress = issueProject.issueTracker().currentUser().userName() + &quot;@openjdk.org&quot;;
1193             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));
1194             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;, &quot;Duke&quot;, authorEmailAddress);
1195             localRepo.push(editHash, repo.url(), &quot;master&quot;);
1196             TestBotRunner.runPeriodicItems(notifyBot);
1197 
1198             // The changeset should be reflected in a comment
1199             var updatedIssue = issueProject.issue(issue.id()).orElseThrow();
1200 
1201             var comments = updatedIssue.comments();
1202             assertEquals(1, comments.size());
1203             var comment = comments.get(0);
1204             assertTrue(comment.body().contains(editHash.abbreviate()));
1205 
1206             // And in a link
</pre>
<hr />
<pre>
1220         }
1221     }
1222 
1223     @Test
1224     void testIssueNoVersion(TestInfo testInfo) throws IOException {
1225         try (var credentials = new HostCredentials(testInfo);
1226              var tempFolder = new TemporaryDirectory()) {
1227             var repo = credentials.getHostedRepository();
1228             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
1229             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType(), Path.of(&quot;appendable.txt&quot;), Set.of(), null);
1230             credentials.commitLock(localRepo);
1231             localRepo.pushAll(repo.url());
1232 
1233             var tagStorage = createTagStorage(repo);
1234             var branchStorage = createBranchStorage(repo);
1235             var prIssuesStorage = createPullRequestIssuesStorage(repo);
1236             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
1237 
1238             var issueProject = credentials.getIssueProject();
1239             var commitIcon = URI.create(&quot;http://www.example.com/commit.png&quot;);
<span class="line-modified">1240             var updater = IssueUpdater.newBuilder()</span>
<span class="line-modified">1241                                       .issueProject(issueProject)</span>
<span class="line-modified">1242                                       .reviewLink(false)</span>
<span class="line-added">1243                                       .commitIcon(commitIcon)</span>
<span class="line-added">1244                                       .setFixVersion(true)</span>
<span class="line-added">1245                                       .build();</span>
<span class="line-added">1246             var notifyBot = NotifyBot.newBuilder()</span>
<span class="line-added">1247                                      .repository(repo)</span>
<span class="line-added">1248                                      .storagePath(storageFolder)</span>
<span class="line-added">1249                                      .branches(Pattern.compile(&quot;master&quot;))</span>
<span class="line-added">1250                                      .tagStorageBuilder(tagStorage)</span>
<span class="line-added">1251                                      .branchStorageBuilder(branchStorage)</span>
<span class="line-added">1252                                      .prIssuesStorageBuilder(prIssuesStorage)</span>
<span class="line-added">1253                                      .updaters(List.of(updater))</span>
<span class="line-added">1254                                      .build();</span>
1255 
1256             // Initialize history
1257             TestBotRunner.runPeriodicItems(notifyBot);
1258 
1259             // Create an issue and commit a fix
1260             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));
1261             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;);
1262             localRepo.push(editHash, repo.url(), &quot;master&quot;);
1263             TestBotRunner.runPeriodicItems(notifyBot);
1264 
1265             // The changeset should be reflected in a comment
1266             var comments = issue.comments();
1267             assertEquals(1, comments.size());
1268             var comment = comments.get(0);
1269             assertTrue(comment.body().contains(editHash.abbreviate()));
1270 
1271             // But not in the fixVersion
1272             assertEquals(Set.of(), fixVersions(issue));
1273         }
1274     }
1275 
1276     @Test
1277     void testIssueConfiguredVersionNoCommit(TestInfo testInfo) throws IOException {
1278         try (var credentials = new HostCredentials(testInfo);
1279              var tempFolder = new TemporaryDirectory()) {
1280             var repo = credentials.getHostedRepository();
1281             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
1282             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType(), Path.of(&quot;appendable.txt&quot;), Set.of(), null);
1283             credentials.commitLock(localRepo);
1284             localRepo.pushAll(repo.url());
1285 
1286             var tagStorage = createTagStorage(repo);
1287             var branchStorage = createBranchStorage(repo);
1288             var prIssuesStorage = createPullRequestIssuesStorage(repo);
1289             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
1290 
1291             var issueProject = credentials.getIssueProject();
1292             var commitIcon = URI.create(&quot;http://www.example.com/commit.png&quot;);
<span class="line-modified">1293             var updater = IssueUpdater.newBuilder()</span>
<span class="line-modified">1294                                       .issueProject(issueProject)</span>
<span class="line-modified">1295                                       .reviewLink(false)</span>
<span class="line-added">1296                                       .commitLink(false)</span>
<span class="line-added">1297                                       .commitIcon(commitIcon)</span>
<span class="line-added">1298                                       .setFixVersion(true)</span>
<span class="line-added">1299                                       .fixVersions(Map.of(&quot;master&quot;, &quot;2.0&quot;))</span>
<span class="line-added">1300                                       .build();</span>
<span class="line-added">1301             var notifyBot = NotifyBot.newBuilder()</span>
<span class="line-added">1302                                      .repository(repo)</span>
<span class="line-added">1303                                      .storagePath(storageFolder)</span>
<span class="line-added">1304                                      .branches(Pattern.compile(&quot;master&quot;))</span>
<span class="line-added">1305                                      .tagStorageBuilder(tagStorage)</span>
<span class="line-added">1306                                      .branchStorageBuilder(branchStorage)</span>
<span class="line-added">1307                                      .prIssuesStorageBuilder(prIssuesStorage)</span>
<span class="line-added">1308                                      .updaters(List.of(updater))</span>
<span class="line-added">1309                                      .build();</span>
1310 
1311             // Initialize history
1312             TestBotRunner.runPeriodicItems(notifyBot);
1313 
1314             // Create an issue and commit a fix
1315             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));
1316             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;);
1317             localRepo.push(editHash, repo.url(), &quot;master&quot;);
1318             TestBotRunner.runPeriodicItems(notifyBot);
1319 
1320             // The changeset should not reflected in a comment
1321             var comments = issue.comments();
1322             assertEquals(1, comments.size());
1323             var comment = comments.get(0);
1324             assertTrue(comment.body().contains(editHash.abbreviate()));
1325 
1326             // As well as a fixVersion - but not the one from the repo
1327             assertEquals(Set.of(&quot;2.0&quot;), fixVersions(issue));
1328 
1329             // And no commit link
</pre>
<hr />
<pre>
1332         }
1333     }
1334 
1335     @Test
1336     void testIssueIdempotence(TestInfo testInfo) throws IOException {
1337         try (var credentials = new HostCredentials(testInfo);
1338              var tempFolder = new TemporaryDirectory()) {
1339             var repo = credentials.getHostedRepository();
1340             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
1341             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
1342             credentials.commitLock(localRepo);
1343             localRepo.pushAll(repo.url());
1344 
1345             var tagStorage = createTagStorage(repo);
1346             var branchStorage = createBranchStorage(repo);
1347             var prIssuesStorage = createPullRequestIssuesStorage(repo);
1348             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
1349 
1350             var issueProject = credentials.getIssueProject();
1351             var commitIcon = URI.create(&quot;http://www.example.com/commit.png&quot;);
<span class="line-modified">1352             var updater = IssueUpdater.newBuilder()</span>
<span class="line-modified">1353                                       .issueProject(issueProject)</span>
<span class="line-modified">1354                                       .reviewLink(false)</span>
<span class="line-added">1355                                       .commitIcon(commitIcon)</span>
<span class="line-added">1356                                       .setFixVersion(true)</span>
<span class="line-added">1357                                       .build();</span>
<span class="line-added">1358             var notifyBot = NotifyBot.newBuilder()</span>
<span class="line-added">1359                                      .repository(repo)</span>
<span class="line-added">1360                                      .storagePath(storageFolder)</span>
<span class="line-added">1361                                      .branches(Pattern.compile(&quot;master&quot;))</span>
<span class="line-added">1362                                      .tagStorageBuilder(tagStorage)</span>
<span class="line-added">1363                                      .branchStorageBuilder(branchStorage)</span>
<span class="line-added">1364                                      .prIssuesStorageBuilder(prIssuesStorage)</span>
<span class="line-added">1365                                      .updaters(List.of(updater))</span>
<span class="line-added">1366                                      .build();</span>
1367 
1368             // Initialize history
1369             TestBotRunner.runPeriodicItems(notifyBot);
1370 
1371             // Save the state
1372             var historyState = localRepo.fetch(repo.url(), &quot;history&quot;);
1373 
1374             // Create an issue and commit a fix
1375             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));
1376             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;);
1377             localRepo.push(editHash, repo.url(), &quot;master&quot;);
1378             TestBotRunner.runPeriodicItems(notifyBot);
1379 
1380             // The changeset should be reflected in a comment
1381             var comments = issue.comments();
1382             assertEquals(1, comments.size());
1383             var comment = comments.get(0);
1384             assertTrue(comment.body().contains(editHash.abbreviate()));
1385 
1386             // And in a link
</pre>
<hr />
<pre>
1407             assertEquals(Set.of(&quot;0.1&quot;), fixVersions(updatedIssue));
1408         }
1409     }
1410 
1411     @Test
1412     void testIssuePoolVersion(TestInfo testInfo) throws IOException {
1413         try (var credentials = new HostCredentials(testInfo);
1414              var tempFolder = new TemporaryDirectory()) {
1415             var repo = credentials.getHostedRepository();
1416             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
1417             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType(), Path.of(&quot;appendable.txt&quot;), Set.of(), null);
1418             credentials.commitLock(localRepo);
1419             localRepo.pushAll(repo.url());
1420 
1421             var tagStorage = createTagStorage(repo);
1422             var branchStorage = createBranchStorage(repo);
1423             var prIssuesStorage = createPullRequestIssuesStorage(repo);
1424             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
1425 
1426             var issueProject = credentials.getIssueProject();
<span class="line-modified">1427             var updater = IssueUpdater.newBuilder()</span>
<span class="line-modified">1428                                       .issueProject(issueProject)</span>
<span class="line-modified">1429                                       .reviewLink(false)</span>
<span class="line-added">1430                                       .commitLink(false)</span>
<span class="line-added">1431                                       .setFixVersion(true)</span>
<span class="line-added">1432                                       .fixVersions(Map.of(&quot;master&quot;, &quot;12u14&quot;))</span>
<span class="line-added">1433                                       .build();</span>
<span class="line-added">1434             var notifyBot = NotifyBot.newBuilder()</span>
<span class="line-added">1435                                      .repository(repo)</span>
<span class="line-added">1436                                      .storagePath(storageFolder)</span>
<span class="line-added">1437                                      .branches(Pattern.compile(&quot;master&quot;))</span>
<span class="line-added">1438                                      .tagStorageBuilder(tagStorage)</span>
<span class="line-added">1439                                      .branchStorageBuilder(branchStorage)</span>
<span class="line-added">1440                                      .prIssuesStorageBuilder(prIssuesStorage)</span>
<span class="line-added">1441                                      .updaters(List.of(updater))</span>
<span class="line-added">1442                                      .build();</span>
1443 
1444             // Initialize history
1445             TestBotRunner.runPeriodicItems(notifyBot);
1446 
1447             // Create an issue and commit a fix
1448             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));
1449             issue.setProperty(&quot;fixVersions&quot;, JSON.array().add(&quot;12-pool&quot;).add(&quot;tbd13&quot;).add(&quot;unknown&quot;));
1450 
1451             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;);
1452             localRepo.push(editHash, repo.url(), &quot;master&quot;);
1453             TestBotRunner.runPeriodicItems(notifyBot);
1454 
1455             // The fixVersion should have been updated
1456             assertEquals(Set.of(&quot;12u14&quot;), fixVersions(issue));
1457         }
1458     }
1459 
1460     @Test
1461     void testIssuePoolOpenVersion(TestInfo testInfo) throws IOException {
1462         try (var credentials = new HostCredentials(testInfo);
1463              var tempFolder = new TemporaryDirectory()) {
1464             var repo = credentials.getHostedRepository();
1465             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
1466             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType(), Path.of(&quot;appendable.txt&quot;), Set.of(), null);
1467             credentials.commitLock(localRepo);
1468             localRepo.pushAll(repo.url());
1469 
1470             var tagStorage = createTagStorage(repo);
1471             var branchStorage = createBranchStorage(repo);
1472             var prIssuesStorage = createPullRequestIssuesStorage(repo);
1473             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
1474 
1475             var issueProject = credentials.getIssueProject();
<span class="line-modified">1476             var updater = IssueUpdater.newBuilder()</span>
<span class="line-modified">1477                                       .issueProject(issueProject)</span>
<span class="line-modified">1478                                       .reviewLink(false)</span>
<span class="line-added">1479                                       .commitLink(false)</span>
<span class="line-added">1480                                       .setFixVersion(true)</span>
<span class="line-added">1481                                       .fixVersions(Map.of(&quot;master&quot;, &quot;12u14&quot;))</span>
<span class="line-added">1482                                       .build();</span>
<span class="line-added">1483             var notifyBot = NotifyBot.newBuilder()</span>
<span class="line-added">1484                                      .repository(repo)</span>
<span class="line-added">1485                                      .storagePath(storageFolder)</span>
<span class="line-added">1486                                      .branches(Pattern.compile(&quot;master&quot;))</span>
<span class="line-added">1487                                      .tagStorageBuilder(tagStorage)</span>
<span class="line-added">1488                                      .branchStorageBuilder(branchStorage)</span>
<span class="line-added">1489                                      .prIssuesStorageBuilder(prIssuesStorage)</span>
<span class="line-added">1490                                      .updaters(List.of(updater))</span>
<span class="line-added">1491                                      .build();</span>
1492 
1493             // Initialize history
1494             TestBotRunner.runPeriodicItems(notifyBot);
1495 
1496             // Create an issue and commit a fix
1497             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));
1498             issue.setProperty(&quot;fixVersions&quot;, JSON.array().add(&quot;12-pool&quot;).add(&quot;tbd13&quot;).add(&quot;unknown&quot;));
1499 
1500             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;);
1501             localRepo.push(editHash, repo.url(), &quot;master&quot;);
1502             TestBotRunner.runPeriodicItems(notifyBot);
1503 
1504             // The fixVersion should have been updated
1505             assertEquals(Set.of(&quot;12u14&quot;), fixVersions(issue));
1506         }
1507     }
1508 
1509     @Test
1510     void testIssueBackport(TestInfo testInfo) throws IOException {
1511         try (var credentials = new HostCredentials(testInfo);
1512              var tempFolder = new TemporaryDirectory()) {
1513             var repo = credentials.getHostedRepository();
1514             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
1515             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType(), Path.of(&quot;appendable.txt&quot;), Set.of(), null);
1516             credentials.commitLock(localRepo);
1517             localRepo.pushAll(repo.url());
1518 
1519             var tagStorage = createTagStorage(repo);
1520             var branchStorage = createBranchStorage(repo);
1521             var prIssuesStorage = createPullRequestIssuesStorage(repo);
1522             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
1523 
1524             var issueProject = credentials.getIssueProject();
<span class="line-modified">1525             var updater = IssueUpdater.newBuilder()</span>
<span class="line-modified">1526                                       .issueProject(issueProject)</span>
<span class="line-modified">1527                                       .reviewLink(false)</span>
<span class="line-added">1528                                       .commitLink(false)</span>
<span class="line-added">1529                                       .setFixVersion(true)</span>
<span class="line-added">1530                                       .fixVersions(Map.of(&quot;master&quot;, &quot;12.0.2&quot;))</span>
<span class="line-added">1531                                       .build();</span>
<span class="line-added">1532             var notifyBot = NotifyBot.newBuilder()</span>
<span class="line-added">1533                                      .repository(repo)</span>
<span class="line-added">1534                                      .storagePath(storageFolder)</span>
<span class="line-added">1535                                      .branches(Pattern.compile(&quot;master&quot;))</span>
<span class="line-added">1536                                      .tagStorageBuilder(tagStorage)</span>
<span class="line-added">1537                                      .branchStorageBuilder(branchStorage)</span>
<span class="line-added">1538                                      .prIssuesStorageBuilder(prIssuesStorage)</span>
<span class="line-added">1539                                      .updaters(List.of(updater))</span>
<span class="line-added">1540                                      .build();</span>
1541 
1542             // Initialize history
1543             TestBotRunner.runPeriodicItems(notifyBot);
1544 
1545             // Create an issue and commit a fix
1546             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;),
1547                                                  Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;),
1548                                                         &quot;customfield_10008&quot;, JSON.object()
1549                                                                                  .put(&quot;id&quot;, 244)
1550                                                                                  .put(&quot;name&quot;, &quot;java.io&quot;),
1551                                                         &quot;customfield_10005&quot;, JSON.array()
1552                                                                                  .add(JSON.object()
1553                                                                                           .put(&quot;id&quot;, &quot;17010&quot;)
1554                                                                                           .put(&quot;value&quot;, &quot;generic&quot;))
1555                                                                                  .add(JSON.object()
1556                                                                                           .put(&quot;id&quot;, &quot;17019&quot;)
1557                                                                                           .put(&quot;value&quot;, &quot;other&quot;))
1558                                                  ));
1559             issue.setProperty(&quot;fixVersions&quot;, JSON.array().add(&quot;13.0.1&quot;));
1560             issue.setProperty(&quot;priority&quot;, JSON.of(&quot;1&quot;));
</pre>
<hr />
<pre>
1590     }
1591 
1592     @Test
1593     void testPullRequest(TestInfo testInfo) throws IOException {
1594         try (var credentials = new HostCredentials(testInfo);
1595              var tempFolder = new TemporaryDirectory()) {
1596             var repo = credentials.getHostedRepository();
1597             var reviewer = credentials.getHostedRepository();
1598             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
1599             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
1600             credentials.commitLock(localRepo);
1601             localRepo.pushAll(repo.url());
1602 
1603             var tagStorage = createTagStorage(repo);
1604             var branchStorage = createBranchStorage(repo);
1605             var prIssuesStorage = createPullRequestIssuesStorage(repo);
1606             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
1607 
1608             var issueProject = credentials.getIssueProject();
1609             var reviewIcon = URI.create(&quot;http://www.example.com/review.png&quot;);
<span class="line-modified">1610             var updater = IssueUpdater.newBuilder()</span>
<span class="line-modified">1611                                       .issueProject(issueProject)</span>
<span class="line-modified">1612                                       .reviewIcon(reviewIcon)</span>
<span class="line-modified">1613                                       .commitLink(false)</span>
<span class="line-added">1614                                       .build();</span>
<span class="line-added">1615             var notifyBot = NotifyBot.newBuilder()</span>
<span class="line-added">1616                                      .repository(repo)</span>
<span class="line-added">1617                                      .storagePath(storageFolder)</span>
<span class="line-added">1618                                      .branches(Pattern.compile(&quot;master&quot;))</span>
<span class="line-added">1619                                      .tagStorageBuilder(tagStorage)</span>
<span class="line-added">1620                                      .branchStorageBuilder(branchStorage)</span>
<span class="line-added">1621                                      .prIssuesStorageBuilder(prIssuesStorage)</span>
<span class="line-added">1622                                      .prUpdaters(List.of(updater))</span>
<span class="line-added">1623                                      .readyLabels(Set.of(&quot;rfr&quot;))</span>
<span class="line-added">1624                                      .readyComments(Map.of(reviewer.forge().currentUser().userName(), Pattern.compile(&quot;This is now ready&quot;)))</span>
<span class="line-added">1625                                      .build();</span>
1626 
1627             // Initialize history
1628             TestBotRunner.runPeriodicItems(notifyBot);
1629 
1630             // Create an issue and a pull request to fix it
1631             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));
1632             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;Fix that issue&quot;);
1633             localRepo.push(editHash, repo.url(), &quot;edit&quot;, true);
1634             var pr = credentials.createPullRequest(repo, &quot;edit&quot;, &quot;master&quot;, issue.id() + &quot;: Fix that issue&quot;);
1635             pr.setBody(&quot;\n\n## Issue\n[&quot; + issue.id() + &quot;](http://www.test.test/): The issue&quot;);
1636             TestBotRunner.runPeriodicItems(notifyBot);
1637 
1638             // The issue should not yet contain a link to the PR
1639             var links = issue.links();
1640             assertEquals(0, links.size());
1641 
1642             // Just a label isn&#39;t enough
1643             pr.addLabel(&quot;rfr&quot;);
1644             TestBotRunner.runPeriodicItems(notifyBot);
1645             links = issue.links();
</pre>
<hr />
<pre>
1691     }
1692 
1693     @Test
1694     void testPullRequestNoReview(TestInfo testInfo) throws IOException {
1695         try (var credentials = new HostCredentials(testInfo);
1696              var tempFolder = new TemporaryDirectory()) {
1697             var repo = credentials.getHostedRepository();
1698             var reviewer = credentials.getHostedRepository();
1699             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
1700             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
1701             credentials.commitLock(localRepo);
1702             localRepo.pushAll(repo.url());
1703 
1704             var tagStorage = createTagStorage(repo);
1705             var branchStorage = createBranchStorage(repo);
1706             var prIssuesStorage = createPullRequestIssuesStorage(repo);
1707             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
1708 
1709             var issueProject = credentials.getIssueProject();
1710             var reviewIcon = URI.create(&quot;http://www.example.com/review.png&quot;);
<span class="line-modified">1711             var updater = IssueUpdater.newBuilder()</span>
<span class="line-modified">1712                                       .issueProject(issueProject)</span>
<span class="line-modified">1713                                       .reviewLink(false)</span>
<span class="line-modified">1714                                       .reviewIcon(reviewIcon)</span>
<span class="line-added">1715                                       .commitLink(false)</span>
<span class="line-added">1716                                       .build();</span>
<span class="line-added">1717             var notifyBot = NotifyBot.newBuilder()</span>
<span class="line-added">1718                                      .repository(repo)</span>
<span class="line-added">1719                                      .storagePath(storageFolder)</span>
<span class="line-added">1720                                      .branches(Pattern.compile(&quot;master&quot;))</span>
<span class="line-added">1721                                      .tagStorageBuilder(tagStorage)</span>
<span class="line-added">1722                                      .branchStorageBuilder(branchStorage)</span>
<span class="line-added">1723                                      .prIssuesStorageBuilder(prIssuesStorage)</span>
<span class="line-added">1724                                      .prUpdaters(List.of(updater)).readyLabels(Set.of(&quot;rfr&quot;))</span>
<span class="line-added">1725                                      .readyComments(Map.of(reviewer.forge().currentUser().userName(), Pattern.compile(&quot;This is now ready&quot;)))</span>
<span class="line-added">1726                                      .build();</span>
1727             // Initialize history
1728             TestBotRunner.runPeriodicItems(notifyBot);
1729 
1730             // Create an issue and a pull request to fix it
1731             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));
1732             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;Fix that issue&quot;);
1733             localRepo.push(editHash, repo.url(), &quot;edit&quot;, true);
1734             var pr = credentials.createPullRequest(repo, &quot;edit&quot;, &quot;master&quot;, issue.id() + &quot;: Fix that issue&quot;);
1735             pr.setBody(&quot;\n\n## Issue\n[&quot; + issue.id() + &quot;](http://www.test.test/): The issue&quot;);
1736             TestBotRunner.runPeriodicItems(notifyBot);
1737 
1738             // Add required label
1739             pr.addLabel(&quot;rfr&quot;);
1740             TestBotRunner.runPeriodicItems(notifyBot);
1741 
1742             // And the required comment
1743             var reviewPr = reviewer.pullRequest(pr.id());
1744             reviewPr.addComment(&quot;This is now ready&quot;);
1745             TestBotRunner.runPeriodicItems(notifyBot);
1746 
</pre>
<hr />
<pre>
1750         }
1751     }
1752 
1753     @Test
1754     void testPullRequestPROnly(TestInfo testInfo) throws IOException {
1755         try (var credentials = new HostCredentials(testInfo);
1756              var tempFolder = new TemporaryDirectory()) {
1757             var repo = credentials.getHostedRepository();
1758             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
1759             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
1760             credentials.commitLock(localRepo);
1761             localRepo.pushAll(repo.url());
1762 
1763             var tagStorage = createTagStorage(repo);
1764             var branchStorage = createBranchStorage(repo);
1765             var prIssuesStorage = createPullRequestIssuesStorage(repo);
1766             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
1767 
1768             var issueProject = credentials.getIssueProject();
1769             var reviewIcon = URI.create(&quot;http://www.example.com/review.png&quot;);
<span class="line-modified">1770             var updater = IssueUpdater.newBuilder()</span>
<span class="line-modified">1771                                       .issueProject(issueProject)</span>
<span class="line-modified">1772                                       .reviewIcon(reviewIcon)</span>
<span class="line-added">1773                                       .commitLink(false)</span>
<span class="line-added">1774                                       .prOnly(true)</span>
<span class="line-added">1775                                       .build();</span>
<span class="line-added">1776             var notifyBot = NotifyBot.newBuilder()</span>
<span class="line-added">1777                                      .repository(repo)</span>
<span class="line-added">1778                                      .storagePath(storageFolder)</span>
<span class="line-added">1779                                      .branches(Pattern.compile(&quot;.*&quot;))</span>
<span class="line-added">1780                                      .tagStorageBuilder(tagStorage)</span>
<span class="line-added">1781                                      .branchStorageBuilder(branchStorage)</span>
<span class="line-added">1782                                      .prIssuesStorageBuilder(prIssuesStorage)</span>
<span class="line-added">1783                                      .updaters(List.of(updater))</span>
<span class="line-added">1784                                      .prUpdaters(List.of(updater))</span>
<span class="line-added">1785                                      .build();</span>
1786 
1787             // Initialize history
1788             localRepo.push(localRepo.resolve(&quot;master&quot;).orElseThrow(), repo.url(), &quot;other&quot;);
1789             TestBotRunner.runPeriodicItems(notifyBot);
1790 
1791             // Create an issue and a pull request to fix it
1792             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));
1793             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;);
1794             localRepo.push(editHash, repo.url(), &quot;edit&quot;, true);
1795             var pr = credentials.createPullRequest(repo, &quot;other&quot;, &quot;edit&quot;, issue.id() + &quot;: Fix that issue&quot;);
1796             pr.setBody(&quot;\n\n## Issue\n[&quot; + issue.id() + &quot;](http://www.test.test/): The issue&quot;);
1797             TestBotRunner.runPeriodicItems(notifyBot);
1798 
1799             // The issue should now contain a link to the PR
1800             var links = issue.links();
1801             assertEquals(1, links.size());
1802             assertEquals(pr.webUrl(), links.get(0).uri().orElseThrow());
1803             assertEquals(reviewIcon, links.get(0).iconUrl().orElseThrow());
1804 
1805             // Simulate integration
</pre>
</td>
</tr>
</table>
<center><a href="../../../../../../../main/java/org/openjdk/skara/bots/notify/NotifyBotFactory.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> next &gt;</center>  </body>
</html>