<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sdiff bots/notify/src/test/java/org/openjdk/skara/bots/notify/UpdaterTests.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
<body>
<center><a href="../../../../../../../main/java/org/openjdk/skara/bots/notify/NotifyBotFactory.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> next &gt;</center>    <h2>bots/notify/src/test/java/org/openjdk/skara/bots/notify/UpdaterTests.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<table>
<tr valign="top">
<td>
<hr />
<pre>
 991         }
 992     }
 993 
 994     @Test
 995     void testIssue(TestInfo testInfo) throws IOException {
 996         try (var credentials = new HostCredentials(testInfo);
 997              var tempFolder = new TemporaryDirectory()) {
 998             var repo = credentials.getHostedRepository();
 999             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
1000             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
1001             credentials.commitLock(localRepo);
1002             localRepo.pushAll(repo.url());
1003 
1004             var tagStorage = createTagStorage(repo);
1005             var branchStorage = createBranchStorage(repo);
1006             var prIssuesStorage = createPullRequestIssuesStorage(repo);
1007             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
1008 
1009             var issueProject = credentials.getIssueProject();
1010             var commitIcon = URI.create(&quot;http://www.example.com/commit.png&quot;);
<span class="line-modified">1011             var updater = new IssueUpdater(issueProject, false, null, true, commitIcon, true, null);</span>
1012             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,
1013                                           prIssuesStorage, List.of(updater), List.of(), Set.of(), Map.of());
1014 
1015             // Initialize history
1016             TestBotRunner.runPeriodicItems(notifyBot);
1017 
1018             // Create an issue and commit a fix
1019             var authorEmailAddress = issueProject.issueTracker().currentUser().userName() + &quot;@openjdk.org&quot;;
1020             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));
1021             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;, &quot;Duke&quot;, authorEmailAddress);
1022             localRepo.push(editHash, repo.url(), &quot;master&quot;);
1023             TestBotRunner.runPeriodicItems(notifyBot);
1024 
1025             // The changeset should be reflected in a comment
1026             var updatedIssue = issueProject.issue(issue.id()).orElseThrow();
1027 
1028             var comments = updatedIssue.comments();
1029             assertEquals(1, comments.size());
1030             var comment = comments.get(0);
1031             assertTrue(comment.body().contains(editHash.abbreviate()));
</pre>
<hr />
<pre>
1047         }
1048     }
1049 
1050     @Test
1051     void testIssueNoVersion(TestInfo testInfo) throws IOException {
1052         try (var credentials = new HostCredentials(testInfo);
1053              var tempFolder = new TemporaryDirectory()) {
1054             var repo = credentials.getHostedRepository();
1055             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
1056             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType(), Path.of(&quot;appendable.txt&quot;), Set.of(), null);
1057             credentials.commitLock(localRepo);
1058             localRepo.pushAll(repo.url());
1059 
1060             var tagStorage = createTagStorage(repo);
1061             var branchStorage = createBranchStorage(repo);
1062             var prIssuesStorage = createPullRequestIssuesStorage(repo);
1063             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
1064 
1065             var issueProject = credentials.getIssueProject();
1066             var commitIcon = URI.create(&quot;http://www.example.com/commit.png&quot;);
<span class="line-modified">1067             var updater = new IssueUpdater(issueProject, false, null, true, commitIcon, true, null);</span>
1068             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,
1069                                           prIssuesStorage, List.of(updater), List.of(), Set.of(), Map.of());
1070 
1071             // Initialize history
1072             TestBotRunner.runPeriodicItems(notifyBot);
1073 
1074             // Create an issue and commit a fix
1075             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));
1076             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;);
1077             localRepo.push(editHash, repo.url(), &quot;master&quot;);
1078             TestBotRunner.runPeriodicItems(notifyBot);
1079 
1080             // The changeset should be reflected in a comment
1081             var comments = issue.comments();
1082             assertEquals(1, comments.size());
1083             var comment = comments.get(0);
1084             assertTrue(comment.body().contains(editHash.abbreviate()));
1085 
1086             // But not in the fixVersion
1087             assertEquals(Set.of(), fixVersions(issue));
1088         }
1089     }
1090 
1091     @Test
1092     void testIssueConfiguredVersionNoCommit(TestInfo testInfo) throws IOException {
1093         try (var credentials = new HostCredentials(testInfo);
1094              var tempFolder = new TemporaryDirectory()) {
1095             var repo = credentials.getHostedRepository();
1096             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
1097             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType(), Path.of(&quot;appendable.txt&quot;), Set.of(), null);
1098             credentials.commitLock(localRepo);
1099             localRepo.pushAll(repo.url());
1100 
1101             var tagStorage = createTagStorage(repo);
1102             var branchStorage = createBranchStorage(repo);
1103             var prIssuesStorage = createPullRequestIssuesStorage(repo);
1104             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
1105 
1106             var issueProject = credentials.getIssueProject();
1107             var commitIcon = URI.create(&quot;http://www.example.com/commit.png&quot;);
<span class="line-modified">1108             var updater = new IssueUpdater(issueProject, false, null, false, commitIcon, true, Map.of(&quot;master&quot;, &quot;2.0&quot;));</span>
1109             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,
1110                                           prIssuesStorage, List.of(updater), List.of(), Set.of(), Map.of());
1111 
1112             // Initialize history
1113             TestBotRunner.runPeriodicItems(notifyBot);
1114 
1115             // Create an issue and commit a fix
1116             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));
1117             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;);
1118             localRepo.push(editHash, repo.url(), &quot;master&quot;);
1119             TestBotRunner.runPeriodicItems(notifyBot);
1120 
1121             // The changeset should not reflected in a comment
1122             var comments = issue.comments();
1123             assertEquals(1, comments.size());
1124             var comment = comments.get(0);
1125             assertTrue(comment.body().contains(editHash.abbreviate()));
1126 
1127             // As well as a fixVersion - but not the one from the repo
1128             assertEquals(Set.of(&quot;2.0&quot;), fixVersions(issue));
</pre>
<hr />
<pre>
1133         }
1134     }
1135 
1136     @Test
1137     void testIssueIdempotence(TestInfo testInfo) throws IOException {
1138         try (var credentials = new HostCredentials(testInfo);
1139              var tempFolder = new TemporaryDirectory()) {
1140             var repo = credentials.getHostedRepository();
1141             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
1142             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
1143             credentials.commitLock(localRepo);
1144             localRepo.pushAll(repo.url());
1145 
1146             var tagStorage = createTagStorage(repo);
1147             var branchStorage = createBranchStorage(repo);
1148             var prIssuesStorage = createPullRequestIssuesStorage(repo);
1149             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
1150 
1151             var issueProject = credentials.getIssueProject();
1152             var commitIcon = URI.create(&quot;http://www.example.com/commit.png&quot;);
<span class="line-modified">1153             var updater = new IssueUpdater(issueProject, false, null, true, commitIcon, true, null);</span>
1154             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,
1155                                           prIssuesStorage, List.of(updater), List.of(), Set.of(), Map.of());
1156 
1157             // Initialize history
1158             TestBotRunner.runPeriodicItems(notifyBot);
1159 
1160             // Save the state
1161             var historyState = localRepo.fetch(repo.url(), &quot;history&quot;);
1162 
1163             // Create an issue and commit a fix
1164             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));
1165             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;);
1166             localRepo.push(editHash, repo.url(), &quot;master&quot;);
1167             TestBotRunner.runPeriodicItems(notifyBot);
1168 
1169             // The changeset should be reflected in a comment
1170             var comments = issue.comments();
1171             assertEquals(1, comments.size());
1172             var comment = comments.get(0);
1173             assertTrue(comment.body().contains(editHash.abbreviate()));
</pre>
<hr />
<pre>
1196             assertEquals(Set.of(&quot;0.1&quot;), fixVersions(updatedIssue));
1197         }
1198     }
1199 
1200     @Test
1201     void testIssuePoolVersion(TestInfo testInfo) throws IOException {
1202         try (var credentials = new HostCredentials(testInfo);
1203              var tempFolder = new TemporaryDirectory()) {
1204             var repo = credentials.getHostedRepository();
1205             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
1206             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType(), Path.of(&quot;appendable.txt&quot;), Set.of(), null);
1207             credentials.commitLock(localRepo);
1208             localRepo.pushAll(repo.url());
1209 
1210             var tagStorage = createTagStorage(repo);
1211             var branchStorage = createBranchStorage(repo);
1212             var prIssuesStorage = createPullRequestIssuesStorage(repo);
1213             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
1214 
1215             var issueProject = credentials.getIssueProject();
<span class="line-modified">1216             var updater = new IssueUpdater(issueProject, false, null, false, null, true, Map.of(&quot;master&quot;, &quot;12u14&quot;));</span>
1217             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,
1218                                           prIssuesStorage, List.of(updater), List.of(), Set.of(), Map.of());
1219 
1220             // Initialize history
1221             TestBotRunner.runPeriodicItems(notifyBot);
1222 
1223             // Create an issue and commit a fix
1224             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));
1225             issue.setProperty(&quot;fixVersions&quot;, JSON.array().add(&quot;12-pool&quot;).add(&quot;tbd13&quot;).add(&quot;unknown&quot;));
1226 
1227             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;);
1228             localRepo.push(editHash, repo.url(), &quot;master&quot;);
1229             TestBotRunner.runPeriodicItems(notifyBot);
1230 
1231             // The fixVersion should have been updated
1232             assertEquals(Set.of(&quot;12u14&quot;), fixVersions(issue));
1233         }
1234     }
1235 
1236     @Test
1237     void testIssuePoolOpenVersion(TestInfo testInfo) throws IOException {
1238         try (var credentials = new HostCredentials(testInfo);
1239              var tempFolder = new TemporaryDirectory()) {
1240             var repo = credentials.getHostedRepository();
1241             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
1242             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType(), Path.of(&quot;appendable.txt&quot;), Set.of(), null);
1243             credentials.commitLock(localRepo);
1244             localRepo.pushAll(repo.url());
1245 
1246             var tagStorage = createTagStorage(repo);
1247             var branchStorage = createBranchStorage(repo);
1248             var prIssuesStorage = createPullRequestIssuesStorage(repo);
1249             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
1250 
1251             var issueProject = credentials.getIssueProject();
<span class="line-modified">1252             var updater = new IssueUpdater(issueProject, false, null, false, null, true, Map.of(&quot;master&quot;, &quot;12u14&quot;));</span>
1253             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,
1254                                           prIssuesStorage, List.of(updater), List.of(), Set.of(), Map.of());
1255 
1256             // Initialize history
1257             TestBotRunner.runPeriodicItems(notifyBot);
1258 
1259             // Create an issue and commit a fix
1260             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));
1261             issue.setProperty(&quot;fixVersions&quot;, JSON.array().add(&quot;12-pool&quot;).add(&quot;tbd13&quot;).add(&quot;unknown&quot;));
1262 
1263             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;);
1264             localRepo.push(editHash, repo.url(), &quot;master&quot;);
1265             TestBotRunner.runPeriodicItems(notifyBot);
1266 
1267             // The fixVersion should have been updated
1268             assertEquals(Set.of(&quot;12u14&quot;), fixVersions(issue));
1269         }
1270     }
1271 
1272     @Test
1273     void testIssueBackport(TestInfo testInfo) throws IOException {
1274         try (var credentials = new HostCredentials(testInfo);
1275              var tempFolder = new TemporaryDirectory()) {
1276             var repo = credentials.getHostedRepository();
1277             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
1278             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType(), Path.of(&quot;appendable.txt&quot;), Set.of(), null);
1279             credentials.commitLock(localRepo);
1280             localRepo.pushAll(repo.url());
1281 
1282             var tagStorage = createTagStorage(repo);
1283             var branchStorage = createBranchStorage(repo);
1284             var prIssuesStorage = createPullRequestIssuesStorage(repo);
1285             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
1286 
1287             var issueProject = credentials.getIssueProject();
<span class="line-modified">1288             var updater = new IssueUpdater(issueProject, false, null, false, null, true, Map.of(&quot;master&quot;, &quot;12.0.2&quot;));</span>
1289             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,
1290                                           prIssuesStorage, List.of(updater), List.of(), Set.of(), Map.of());
1291 
1292             // Initialize history
1293             TestBotRunner.runPeriodicItems(notifyBot);
1294 
1295             // Create an issue and commit a fix
1296             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;),
1297                                                  Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;),
1298                                                         &quot;customfield_10008&quot;, JSON.object()
1299                                                                                  .put(&quot;id&quot;, 244)
1300                                                                                  .put(&quot;name&quot;, &quot;java.io&quot;),
1301                                                         &quot;customfield_10005&quot;, JSON.array()
1302                                                                                  .add(JSON.object()
1303                                                                                           .put(&quot;id&quot;, &quot;17010&quot;)
1304                                                                                           .put(&quot;value&quot;, &quot;generic&quot;))
1305                                                                                  .add(JSON.object()
1306                                                                                           .put(&quot;id&quot;, &quot;17019&quot;)
1307                                                                                           .put(&quot;value&quot;, &quot;other&quot;))
1308                                                  ));
</pre>
<hr />
<pre>
1340     }
1341 
1342     @Test
1343     void testPullRequest(TestInfo testInfo) throws IOException {
1344         try (var credentials = new HostCredentials(testInfo);
1345              var tempFolder = new TemporaryDirectory()) {
1346             var repo = credentials.getHostedRepository();
1347             var reviewer = credentials.getHostedRepository();
1348             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
1349             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
1350             credentials.commitLock(localRepo);
1351             localRepo.pushAll(repo.url());
1352 
1353             var tagStorage = createTagStorage(repo);
1354             var branchStorage = createBranchStorage(repo);
1355             var prIssuesStorage = createPullRequestIssuesStorage(repo);
1356             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
1357 
1358             var issueProject = credentials.getIssueProject();
1359             var reviewIcon = URI.create(&quot;http://www.example.com/review.png&quot;);
<span class="line-modified">1360             var updater = new IssueUpdater(issueProject, true, reviewIcon, false, null, false, null);</span>
1361             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,
1362                                           prIssuesStorage, List.of(), List.of(updater), Set.of(&quot;rfr&quot;),
1363                                           Map.of(reviewer.forge().currentUser().userName(), Pattern.compile(&quot;This is now ready&quot;)));
1364 
1365             // Initialize history
1366             TestBotRunner.runPeriodicItems(notifyBot);
1367 
1368             // Create an issue and a pull request to fix it
1369             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));
1370             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;Fix that issue&quot;);
1371             localRepo.push(editHash, repo.url(), &quot;edit&quot;, true);
1372             var pr = credentials.createPullRequest(repo, &quot;edit&quot;, &quot;master&quot;, issue.id() + &quot;: Fix that issue&quot;);
1373             pr.setBody(&quot;\n\n## Issue\n[&quot; + issue.id() + &quot;](http://www.test.test/): The issue&quot;);
1374             TestBotRunner.runPeriodicItems(notifyBot);
1375 
1376             // The issue should not yet contain a link to the PR
1377             var links = issue.links();
1378             assertEquals(0, links.size());
1379 
1380             // Just a label isn&#39;t enough
</pre>
<hr />
<pre>
1429     }
1430 
1431     @Test
1432     void testPullRequestNoReview(TestInfo testInfo) throws IOException {
1433         try (var credentials = new HostCredentials(testInfo);
1434              var tempFolder = new TemporaryDirectory()) {
1435             var repo = credentials.getHostedRepository();
1436             var reviewer = credentials.getHostedRepository();
1437             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
1438             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
1439             credentials.commitLock(localRepo);
1440             localRepo.pushAll(repo.url());
1441 
1442             var tagStorage = createTagStorage(repo);
1443             var branchStorage = createBranchStorage(repo);
1444             var prIssuesStorage = createPullRequestIssuesStorage(repo);
1445             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
1446 
1447             var issueProject = credentials.getIssueProject();
1448             var reviewIcon = URI.create(&quot;http://www.example.com/review.png&quot;);
<span class="line-modified">1449             var updater = new IssueUpdater(issueProject, false, reviewIcon, false, null, false,null);</span>
1450             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,
1451                                           prIssuesStorage, List.of(), List.of(updater), Set.of(&quot;rfr&quot;),
1452                                           Map.of(reviewer.forge().currentUser().userName(), Pattern.compile(&quot;This is now ready&quot;)));
1453             // Initialize history
1454             TestBotRunner.runPeriodicItems(notifyBot);
1455 
1456             // Create an issue and a pull request to fix it
1457             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));
1458             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;Fix that issue&quot;);
1459             localRepo.push(editHash, repo.url(), &quot;edit&quot;, true);
1460             var pr = credentials.createPullRequest(repo, &quot;edit&quot;, &quot;master&quot;, issue.id() + &quot;: Fix that issue&quot;);
1461             pr.setBody(&quot;\n\n## Issue\n[&quot; + issue.id() + &quot;](http://www.test.test/): The issue&quot;);
1462             TestBotRunner.runPeriodicItems(notifyBot);
1463 
1464             // Add required label
1465             pr.addLabel(&quot;rfr&quot;);
1466             TestBotRunner.runPeriodicItems(notifyBot);
1467 
1468             // And the required comment
1469             var reviewPr = reviewer.pullRequest(pr.id());
1470             reviewPr.addComment(&quot;This is now ready&quot;);
1471             TestBotRunner.runPeriodicItems(notifyBot);
1472 
1473             // The issue should still not contain a link to the PR
1474             var links = issue.links();
1475             assertEquals(0, links.size());
1476         }
1477     }






























































1478 }
</pre>
</td>
<td>
<hr />
<pre>
 991         }
 992     }
 993 
 994     @Test
 995     void testIssue(TestInfo testInfo) throws IOException {
 996         try (var credentials = new HostCredentials(testInfo);
 997              var tempFolder = new TemporaryDirectory()) {
 998             var repo = credentials.getHostedRepository();
 999             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
1000             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
1001             credentials.commitLock(localRepo);
1002             localRepo.pushAll(repo.url());
1003 
1004             var tagStorage = createTagStorage(repo);
1005             var branchStorage = createBranchStorage(repo);
1006             var prIssuesStorage = createPullRequestIssuesStorage(repo);
1007             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
1008 
1009             var issueProject = credentials.getIssueProject();
1010             var commitIcon = URI.create(&quot;http://www.example.com/commit.png&quot;);
<span class="line-modified">1011             var updater = new IssueUpdater(issueProject, false, null, true, commitIcon, true, null, false);</span>
1012             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,
1013                                           prIssuesStorage, List.of(updater), List.of(), Set.of(), Map.of());
1014 
1015             // Initialize history
1016             TestBotRunner.runPeriodicItems(notifyBot);
1017 
1018             // Create an issue and commit a fix
1019             var authorEmailAddress = issueProject.issueTracker().currentUser().userName() + &quot;@openjdk.org&quot;;
1020             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));
1021             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;, &quot;Duke&quot;, authorEmailAddress);
1022             localRepo.push(editHash, repo.url(), &quot;master&quot;);
1023             TestBotRunner.runPeriodicItems(notifyBot);
1024 
1025             // The changeset should be reflected in a comment
1026             var updatedIssue = issueProject.issue(issue.id()).orElseThrow();
1027 
1028             var comments = updatedIssue.comments();
1029             assertEquals(1, comments.size());
1030             var comment = comments.get(0);
1031             assertTrue(comment.body().contains(editHash.abbreviate()));
</pre>
<hr />
<pre>
1047         }
1048     }
1049 
1050     @Test
1051     void testIssueNoVersion(TestInfo testInfo) throws IOException {
1052         try (var credentials = new HostCredentials(testInfo);
1053              var tempFolder = new TemporaryDirectory()) {
1054             var repo = credentials.getHostedRepository();
1055             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
1056             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType(), Path.of(&quot;appendable.txt&quot;), Set.of(), null);
1057             credentials.commitLock(localRepo);
1058             localRepo.pushAll(repo.url());
1059 
1060             var tagStorage = createTagStorage(repo);
1061             var branchStorage = createBranchStorage(repo);
1062             var prIssuesStorage = createPullRequestIssuesStorage(repo);
1063             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
1064 
1065             var issueProject = credentials.getIssueProject();
1066             var commitIcon = URI.create(&quot;http://www.example.com/commit.png&quot;);
<span class="line-modified">1067             var updater = new IssueUpdater(issueProject, false, null, true, commitIcon, true, null, false);</span>
1068             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,
1069                                           prIssuesStorage, List.of(updater), List.of(), Set.of(), Map.of());
1070 
1071             // Initialize history
1072             TestBotRunner.runPeriodicItems(notifyBot);
1073 
1074             // Create an issue and commit a fix
1075             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));
1076             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;);
1077             localRepo.push(editHash, repo.url(), &quot;master&quot;);
1078             TestBotRunner.runPeriodicItems(notifyBot);
1079 
1080             // The changeset should be reflected in a comment
1081             var comments = issue.comments();
1082             assertEquals(1, comments.size());
1083             var comment = comments.get(0);
1084             assertTrue(comment.body().contains(editHash.abbreviate()));
1085 
1086             // But not in the fixVersion
1087             assertEquals(Set.of(), fixVersions(issue));
1088         }
1089     }
1090 
1091     @Test
1092     void testIssueConfiguredVersionNoCommit(TestInfo testInfo) throws IOException {
1093         try (var credentials = new HostCredentials(testInfo);
1094              var tempFolder = new TemporaryDirectory()) {
1095             var repo = credentials.getHostedRepository();
1096             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
1097             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType(), Path.of(&quot;appendable.txt&quot;), Set.of(), null);
1098             credentials.commitLock(localRepo);
1099             localRepo.pushAll(repo.url());
1100 
1101             var tagStorage = createTagStorage(repo);
1102             var branchStorage = createBranchStorage(repo);
1103             var prIssuesStorage = createPullRequestIssuesStorage(repo);
1104             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
1105 
1106             var issueProject = credentials.getIssueProject();
1107             var commitIcon = URI.create(&quot;http://www.example.com/commit.png&quot;);
<span class="line-modified">1108             var updater = new IssueUpdater(issueProject, false, null, false, commitIcon, true, Map.of(&quot;master&quot;, &quot;2.0&quot;), false);</span>
1109             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,
1110                                           prIssuesStorage, List.of(updater), List.of(), Set.of(), Map.of());
1111 
1112             // Initialize history
1113             TestBotRunner.runPeriodicItems(notifyBot);
1114 
1115             // Create an issue and commit a fix
1116             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));
1117             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;);
1118             localRepo.push(editHash, repo.url(), &quot;master&quot;);
1119             TestBotRunner.runPeriodicItems(notifyBot);
1120 
1121             // The changeset should not reflected in a comment
1122             var comments = issue.comments();
1123             assertEquals(1, comments.size());
1124             var comment = comments.get(0);
1125             assertTrue(comment.body().contains(editHash.abbreviate()));
1126 
1127             // As well as a fixVersion - but not the one from the repo
1128             assertEquals(Set.of(&quot;2.0&quot;), fixVersions(issue));
</pre>
<hr />
<pre>
1133         }
1134     }
1135 
1136     @Test
1137     void testIssueIdempotence(TestInfo testInfo) throws IOException {
1138         try (var credentials = new HostCredentials(testInfo);
1139              var tempFolder = new TemporaryDirectory()) {
1140             var repo = credentials.getHostedRepository();
1141             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
1142             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
1143             credentials.commitLock(localRepo);
1144             localRepo.pushAll(repo.url());
1145 
1146             var tagStorage = createTagStorage(repo);
1147             var branchStorage = createBranchStorage(repo);
1148             var prIssuesStorage = createPullRequestIssuesStorage(repo);
1149             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
1150 
1151             var issueProject = credentials.getIssueProject();
1152             var commitIcon = URI.create(&quot;http://www.example.com/commit.png&quot;);
<span class="line-modified">1153             var updater = new IssueUpdater(issueProject, false, null, true, commitIcon, true, null, false);</span>
1154             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,
1155                                           prIssuesStorage, List.of(updater), List.of(), Set.of(), Map.of());
1156 
1157             // Initialize history
1158             TestBotRunner.runPeriodicItems(notifyBot);
1159 
1160             // Save the state
1161             var historyState = localRepo.fetch(repo.url(), &quot;history&quot;);
1162 
1163             // Create an issue and commit a fix
1164             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));
1165             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;);
1166             localRepo.push(editHash, repo.url(), &quot;master&quot;);
1167             TestBotRunner.runPeriodicItems(notifyBot);
1168 
1169             // The changeset should be reflected in a comment
1170             var comments = issue.comments();
1171             assertEquals(1, comments.size());
1172             var comment = comments.get(0);
1173             assertTrue(comment.body().contains(editHash.abbreviate()));
</pre>
<hr />
<pre>
1196             assertEquals(Set.of(&quot;0.1&quot;), fixVersions(updatedIssue));
1197         }
1198     }
1199 
1200     @Test
1201     void testIssuePoolVersion(TestInfo testInfo) throws IOException {
1202         try (var credentials = new HostCredentials(testInfo);
1203              var tempFolder = new TemporaryDirectory()) {
1204             var repo = credentials.getHostedRepository();
1205             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
1206             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType(), Path.of(&quot;appendable.txt&quot;), Set.of(), null);
1207             credentials.commitLock(localRepo);
1208             localRepo.pushAll(repo.url());
1209 
1210             var tagStorage = createTagStorage(repo);
1211             var branchStorage = createBranchStorage(repo);
1212             var prIssuesStorage = createPullRequestIssuesStorage(repo);
1213             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
1214 
1215             var issueProject = credentials.getIssueProject();
<span class="line-modified">1216             var updater = new IssueUpdater(issueProject, false, null, false, null, true, Map.of(&quot;master&quot;, &quot;12u14&quot;), false);</span>
1217             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,
1218                                           prIssuesStorage, List.of(updater), List.of(), Set.of(), Map.of());
1219 
1220             // Initialize history
1221             TestBotRunner.runPeriodicItems(notifyBot);
1222 
1223             // Create an issue and commit a fix
1224             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));
1225             issue.setProperty(&quot;fixVersions&quot;, JSON.array().add(&quot;12-pool&quot;).add(&quot;tbd13&quot;).add(&quot;unknown&quot;));
1226 
1227             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;);
1228             localRepo.push(editHash, repo.url(), &quot;master&quot;);
1229             TestBotRunner.runPeriodicItems(notifyBot);
1230 
1231             // The fixVersion should have been updated
1232             assertEquals(Set.of(&quot;12u14&quot;), fixVersions(issue));
1233         }
1234     }
1235 
1236     @Test
1237     void testIssuePoolOpenVersion(TestInfo testInfo) throws IOException {
1238         try (var credentials = new HostCredentials(testInfo);
1239              var tempFolder = new TemporaryDirectory()) {
1240             var repo = credentials.getHostedRepository();
1241             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
1242             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType(), Path.of(&quot;appendable.txt&quot;), Set.of(), null);
1243             credentials.commitLock(localRepo);
1244             localRepo.pushAll(repo.url());
1245 
1246             var tagStorage = createTagStorage(repo);
1247             var branchStorage = createBranchStorage(repo);
1248             var prIssuesStorage = createPullRequestIssuesStorage(repo);
1249             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
1250 
1251             var issueProject = credentials.getIssueProject();
<span class="line-modified">1252             var updater = new IssueUpdater(issueProject, false, null, false, null, true, Map.of(&quot;master&quot;, &quot;12u14&quot;), false);</span>
1253             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,
1254                                           prIssuesStorage, List.of(updater), List.of(), Set.of(), Map.of());
1255 
1256             // Initialize history
1257             TestBotRunner.runPeriodicItems(notifyBot);
1258 
1259             // Create an issue and commit a fix
1260             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));
1261             issue.setProperty(&quot;fixVersions&quot;, JSON.array().add(&quot;12-pool&quot;).add(&quot;tbd13&quot;).add(&quot;unknown&quot;));
1262 
1263             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;);
1264             localRepo.push(editHash, repo.url(), &quot;master&quot;);
1265             TestBotRunner.runPeriodicItems(notifyBot);
1266 
1267             // The fixVersion should have been updated
1268             assertEquals(Set.of(&quot;12u14&quot;), fixVersions(issue));
1269         }
1270     }
1271 
1272     @Test
1273     void testIssueBackport(TestInfo testInfo) throws IOException {
1274         try (var credentials = new HostCredentials(testInfo);
1275              var tempFolder = new TemporaryDirectory()) {
1276             var repo = credentials.getHostedRepository();
1277             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
1278             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType(), Path.of(&quot;appendable.txt&quot;), Set.of(), null);
1279             credentials.commitLock(localRepo);
1280             localRepo.pushAll(repo.url());
1281 
1282             var tagStorage = createTagStorage(repo);
1283             var branchStorage = createBranchStorage(repo);
1284             var prIssuesStorage = createPullRequestIssuesStorage(repo);
1285             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
1286 
1287             var issueProject = credentials.getIssueProject();
<span class="line-modified">1288             var updater = new IssueUpdater(issueProject, false, null, false, null, true, Map.of(&quot;master&quot;, &quot;12.0.2&quot;), false);</span>
1289             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,
1290                                           prIssuesStorage, List.of(updater), List.of(), Set.of(), Map.of());
1291 
1292             // Initialize history
1293             TestBotRunner.runPeriodicItems(notifyBot);
1294 
1295             // Create an issue and commit a fix
1296             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;),
1297                                                  Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;),
1298                                                         &quot;customfield_10008&quot;, JSON.object()
1299                                                                                  .put(&quot;id&quot;, 244)
1300                                                                                  .put(&quot;name&quot;, &quot;java.io&quot;),
1301                                                         &quot;customfield_10005&quot;, JSON.array()
1302                                                                                  .add(JSON.object()
1303                                                                                           .put(&quot;id&quot;, &quot;17010&quot;)
1304                                                                                           .put(&quot;value&quot;, &quot;generic&quot;))
1305                                                                                  .add(JSON.object()
1306                                                                                           .put(&quot;id&quot;, &quot;17019&quot;)
1307                                                                                           .put(&quot;value&quot;, &quot;other&quot;))
1308                                                  ));
</pre>
<hr />
<pre>
1340     }
1341 
1342     @Test
1343     void testPullRequest(TestInfo testInfo) throws IOException {
1344         try (var credentials = new HostCredentials(testInfo);
1345              var tempFolder = new TemporaryDirectory()) {
1346             var repo = credentials.getHostedRepository();
1347             var reviewer = credentials.getHostedRepository();
1348             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
1349             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
1350             credentials.commitLock(localRepo);
1351             localRepo.pushAll(repo.url());
1352 
1353             var tagStorage = createTagStorage(repo);
1354             var branchStorage = createBranchStorage(repo);
1355             var prIssuesStorage = createPullRequestIssuesStorage(repo);
1356             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
1357 
1358             var issueProject = credentials.getIssueProject();
1359             var reviewIcon = URI.create(&quot;http://www.example.com/review.png&quot;);
<span class="line-modified">1360             var updater = new IssueUpdater(issueProject, true, reviewIcon, false, null, false, null, false);</span>
1361             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,
1362                                           prIssuesStorage, List.of(), List.of(updater), Set.of(&quot;rfr&quot;),
1363                                           Map.of(reviewer.forge().currentUser().userName(), Pattern.compile(&quot;This is now ready&quot;)));
1364 
1365             // Initialize history
1366             TestBotRunner.runPeriodicItems(notifyBot);
1367 
1368             // Create an issue and a pull request to fix it
1369             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));
1370             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;Fix that issue&quot;);
1371             localRepo.push(editHash, repo.url(), &quot;edit&quot;, true);
1372             var pr = credentials.createPullRequest(repo, &quot;edit&quot;, &quot;master&quot;, issue.id() + &quot;: Fix that issue&quot;);
1373             pr.setBody(&quot;\n\n## Issue\n[&quot; + issue.id() + &quot;](http://www.test.test/): The issue&quot;);
1374             TestBotRunner.runPeriodicItems(notifyBot);
1375 
1376             // The issue should not yet contain a link to the PR
1377             var links = issue.links();
1378             assertEquals(0, links.size());
1379 
1380             // Just a label isn&#39;t enough
</pre>
<hr />
<pre>
1429     }
1430 
1431     @Test
1432     void testPullRequestNoReview(TestInfo testInfo) throws IOException {
1433         try (var credentials = new HostCredentials(testInfo);
1434              var tempFolder = new TemporaryDirectory()) {
1435             var repo = credentials.getHostedRepository();
1436             var reviewer = credentials.getHostedRepository();
1437             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);
1438             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());
1439             credentials.commitLock(localRepo);
1440             localRepo.pushAll(repo.url());
1441 
1442             var tagStorage = createTagStorage(repo);
1443             var branchStorage = createBranchStorage(repo);
1444             var prIssuesStorage = createPullRequestIssuesStorage(repo);
1445             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);
1446 
1447             var issueProject = credentials.getIssueProject();
1448             var reviewIcon = URI.create(&quot;http://www.example.com/review.png&quot;);
<span class="line-modified">1449             var updater = new IssueUpdater(issueProject, false, reviewIcon, false, null, false,null, false);</span>
1450             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;master&quot;), tagStorage, branchStorage,
1451                                           prIssuesStorage, List.of(), List.of(updater), Set.of(&quot;rfr&quot;),
1452                                           Map.of(reviewer.forge().currentUser().userName(), Pattern.compile(&quot;This is now ready&quot;)));
1453             // Initialize history
1454             TestBotRunner.runPeriodicItems(notifyBot);
1455 
1456             // Create an issue and a pull request to fix it
1457             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));
1458             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, &quot;Fix that issue&quot;);
1459             localRepo.push(editHash, repo.url(), &quot;edit&quot;, true);
1460             var pr = credentials.createPullRequest(repo, &quot;edit&quot;, &quot;master&quot;, issue.id() + &quot;: Fix that issue&quot;);
1461             pr.setBody(&quot;\n\n## Issue\n[&quot; + issue.id() + &quot;](http://www.test.test/): The issue&quot;);
1462             TestBotRunner.runPeriodicItems(notifyBot);
1463 
1464             // Add required label
1465             pr.addLabel(&quot;rfr&quot;);
1466             TestBotRunner.runPeriodicItems(notifyBot);
1467 
1468             // And the required comment
1469             var reviewPr = reviewer.pullRequest(pr.id());
1470             reviewPr.addComment(&quot;This is now ready&quot;);
1471             TestBotRunner.runPeriodicItems(notifyBot);
1472 
1473             // The issue should still not contain a link to the PR
1474             var links = issue.links();
1475             assertEquals(0, links.size());
1476         }
1477     }
<span class="line-added">1478 </span>
<span class="line-added">1479     @Test</span>
<span class="line-added">1480     void testPullRequestPROnly(TestInfo testInfo) throws IOException {</span>
<span class="line-added">1481         try (var credentials = new HostCredentials(testInfo);</span>
<span class="line-added">1482              var tempFolder = new TemporaryDirectory()) {</span>
<span class="line-added">1483             var repo = credentials.getHostedRepository();</span>
<span class="line-added">1484             var repoFolder = tempFolder.path().resolve(&quot;repo&quot;);</span>
<span class="line-added">1485             var localRepo = CheckableRepository.init(repoFolder, repo.repositoryType());</span>
<span class="line-added">1486             credentials.commitLock(localRepo);</span>
<span class="line-added">1487             localRepo.pushAll(repo.url());</span>
<span class="line-added">1488 </span>
<span class="line-added">1489             var tagStorage = createTagStorage(repo);</span>
<span class="line-added">1490             var branchStorage = createBranchStorage(repo);</span>
<span class="line-added">1491             var prIssuesStorage = createPullRequestIssuesStorage(repo);</span>
<span class="line-added">1492             var storageFolder = tempFolder.path().resolve(&quot;storage&quot;);</span>
<span class="line-added">1493 </span>
<span class="line-added">1494             var issueProject = credentials.getIssueProject();</span>
<span class="line-added">1495             var reviewIcon = URI.create(&quot;http://www.example.com/review.png&quot;);</span>
<span class="line-added">1496             var updater = new IssueUpdater(issueProject, true, reviewIcon, false, null, false, null, true);</span>
<span class="line-added">1497             var notifyBot = new NotifyBot(repo, storageFolder, Pattern.compile(&quot;.*&quot;), tagStorage, branchStorage,</span>
<span class="line-added">1498                                           prIssuesStorage, List.of(updater), List.of(updater), Set.of(), Map.of());</span>
<span class="line-added">1499 </span>
<span class="line-added">1500             // Initialize history</span>
<span class="line-added">1501             localRepo.push(localRepo.resolve(&quot;master&quot;).orElseThrow(), repo.url(), &quot;other&quot;);</span>
<span class="line-added">1502             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="line-added">1503 </span>
<span class="line-added">1504             // Create an issue and a pull request to fix it</span>
<span class="line-added">1505             var issue = issueProject.createIssue(&quot;This is an issue&quot;, List.of(&quot;Indeed&quot;), Map.of(&quot;issuetype&quot;, JSON.of(&quot;Enhancement&quot;)));</span>
<span class="line-added">1506             var editHash = CheckableRepository.appendAndCommit(localRepo, &quot;Another line&quot;, issue.id() + &quot;: Fix that issue&quot;);</span>
<span class="line-added">1507             localRepo.push(editHash, repo.url(), &quot;edit&quot;, true);</span>
<span class="line-added">1508             var pr = credentials.createPullRequest(repo, &quot;other&quot;, &quot;edit&quot;, issue.id() + &quot;: Fix that issue&quot;);</span>
<span class="line-added">1509             pr.setBody(&quot;\n\n## Issue\n[&quot; + issue.id() + &quot;](http://www.test.test/): The issue&quot;);</span>
<span class="line-added">1510             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="line-added">1511 </span>
<span class="line-added">1512             // The issue should now contain a link to the PR</span>
<span class="line-added">1513             var links = issue.links();</span>
<span class="line-added">1514             assertEquals(1, links.size());</span>
<span class="line-added">1515             assertEquals(pr.webUrl(), links.get(0).uri().orElseThrow());</span>
<span class="line-added">1516             assertEquals(reviewIcon, links.get(0).iconUrl().orElseThrow());</span>
<span class="line-added">1517 </span>
<span class="line-added">1518             // Simulate integration</span>
<span class="line-added">1519             localRepo.push(editHash, repo.url(), &quot;other&quot;);</span>
<span class="line-added">1520             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="line-added">1521 </span>
<span class="line-added">1522             // The changeset should be reflected in a comment</span>
<span class="line-added">1523             var updatedIssue = issueProject.issue(issue.id()).orElseThrow();</span>
<span class="line-added">1524 </span>
<span class="line-added">1525             var comments = updatedIssue.comments();</span>
<span class="line-added">1526             assertEquals(1, comments.size());</span>
<span class="line-added">1527             var comment = comments.get(0);</span>
<span class="line-added">1528             assertTrue(comment.body().contains(editHash.abbreviate()));</span>
<span class="line-added">1529 </span>
<span class="line-added">1530             // Now simulate a merge to another branch</span>
<span class="line-added">1531             localRepo.push(editHash, repo.url(), &quot;master&quot;);</span>
<span class="line-added">1532             TestBotRunner.runPeriodicItems(notifyBot);</span>
<span class="line-added">1533 </span>
<span class="line-added">1534             // No additional comment should have been made</span>
<span class="line-added">1535             updatedIssue = issueProject.issue(issue.id()).orElseThrow();</span>
<span class="line-added">1536             comments = updatedIssue.comments();</span>
<span class="line-added">1537             assertEquals(1, comments.size());</span>
<span class="line-added">1538         }</span>
<span class="line-added">1539     }</span>
1540 }
</pre>
</td>
</tr>
</table>
<center><a href="../../../../../../../main/java/org/openjdk/skara/bots/notify/NotifyBotFactory.java.sdiff.html" target="_top">&lt; prev</a> <a href="../../../../../../../../../../index.html" target="_top">index</a> next &gt;</center>  </body>
</html>