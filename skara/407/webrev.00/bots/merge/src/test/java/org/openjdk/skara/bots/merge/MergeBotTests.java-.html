<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Old bots/merge/src/test/java/org/openjdk/skara/bots/merge/MergeBotTests.java</title>
    <link rel="stylesheet" href="../../../../../../../../../../style.css" />
  </head>
  <body>
    <pre>
   1 /*
   2  * Copyright (c) 2019, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  */
  23 package org.openjdk.skara.bots.merge;
  24 
  25 import org.openjdk.skara.host.*;
  26 import org.openjdk.skara.test.*;
  27 import org.openjdk.skara.vcs.*;
  28 
  29 import org.junit.jupiter.api.Test;
  30 import org.junit.jupiter.api.TestInfo;
  31 
  32 import java.io.IOException;
  33 import java.nio.file.Files;
  34 import java.nio.file.StandardOpenOption;
  35 import java.util.*;
  36 import java.util.stream.Collectors;
  37 import java.time.DayOfWeek;
  38 import java.time.Month;
  39 import java.time.ZonedDateTime;
  40 import java.time.ZoneId;
  41 
  42 import static org.junit.jupiter.api.Assertions.*;
  43 
  44 class MergeBotTests {
  45     @Test
  46     void mergeMasterBranch(TestInfo testInfo) throws IOException {
  47         try (var temp = new TemporaryDirectory(false)) {
  48             var host = TestHost.createNew(List.of(new HostUser(0, &quot;duke&quot;, &quot;J. Duke&quot;)));
  49 
  50             var fromDir = temp.path().resolve(&quot;from.git&quot;);
  51             var fromLocalRepo = Repository.init(fromDir, VCS.GIT);
  52             var fromHostedRepo = new TestHostedRepository(host, &quot;test&quot;, fromLocalRepo);
  53 
  54             var toDir = temp.path().resolve(&quot;to.git&quot;);
  55             var toLocalRepo = Repository.init(toDir, VCS.GIT);
  56             var toGitConfig = toDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
  57             Files.write(toGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
  58                         StandardOpenOption.APPEND);
  59             var toHostedRepo = new TestHostedRepository(host, &quot;test-mirror&quot;, toLocalRepo);
  60 
  61             var forkDir = temp.path().resolve(&quot;fork.git&quot;);
  62             var forkLocalRepo = Repository.init(forkDir, VCS.GIT);
  63             var forkGitConfig = forkDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
  64             Files.write(forkGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
  65                         StandardOpenOption.APPEND);
  66             var toFork = new TestHostedRepository(host, &quot;test-mirror-fork&quot;, forkLocalRepo);
  67 
  68             var now = ZonedDateTime.now();
  69             var fromFileA = fromDir.resolve(&quot;a.txt&quot;);
  70             Files.writeString(fromFileA, &quot;Hello A\n&quot;);
  71             fromLocalRepo.add(fromFileA);
  72             var fromHashA = fromLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
  73             var fromCommits = fromLocalRepo.commits().asList();
  74             assertEquals(1, fromCommits.size());
  75             assertEquals(fromHashA, fromCommits.get(0).hash());
  76 
  77             var toFileA = toDir.resolve(&quot;a.txt&quot;);
  78             Files.writeString(toFileA, &quot;Hello A\n&quot;);
  79             toLocalRepo.add(toFileA);
  80             var toHashA = toLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
  81             var toCommits = toLocalRepo.commits().asList();
  82             assertEquals(1, toCommits.size());
  83             assertEquals(toHashA, toCommits.get(0).hash());
  84             assertEquals(fromHashA, toHashA);
  85 
  86             var fromFileB = fromDir.resolve(&quot;b.txt&quot;);
  87             Files.writeString(fromFileB, &quot;Hello B\n&quot;);
  88             fromLocalRepo.add(fromFileB);
  89             var fromHashB = fromLocalRepo.commit(&quot;Adding b.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
  90 
  91             var toFileC = toDir.resolve(&quot;c.txt&quot;);
  92             Files.writeString(toFileC, &quot;Hello C\n&quot;);
  93             toLocalRepo.add(toFileC);
  94             var toHashC = toLocalRepo.commit(&quot;Adding c.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
  95 
  96             var storage = temp.path().resolve(&quot;storage&quot;);
  97             var master = new Branch(&quot;master&quot;);
  98             var specs = List.of(new MergeBot.Spec(fromHostedRepo, master, master));
  99             var bot = new MergeBot(storage, toHostedRepo, toFork, specs);
 100             TestBotRunner.runPeriodicItems(bot);
 101 
 102             toCommits = toLocalRepo.commits().asList();
 103             assertEquals(4, toCommits.size());
 104             var hashes = toCommits.stream().map(Commit::hash).collect(Collectors.toSet());
 105             assertTrue(hashes.contains(toHashA));
 106             assertTrue(hashes.contains(fromHashB));
 107             assertTrue(hashes.contains(toHashC));
 108 
 109             var known = Set.of(toHashA, fromHashB, toHashC);
 110             var merge = toCommits.stream().filter(c -&gt; !known.contains(c.hash())).findAny().get();
 111             assertTrue(merge.isMerge());
 112             assertEquals(List.of(&quot;Automatic merge of master into master&quot;), merge.message());
 113             assertEquals(&quot;duke&quot;, merge.author().name());
 114             assertEquals(&quot;duke@openjdk.org&quot;, merge.author().email());
 115 
 116             assertEquals(0, toHostedRepo.pullRequests().size());
 117         }
 118     }
 119 
 120     @Test
 121     void failingMergeTest(TestInfo testInfo) throws IOException {
 122         try (var temp = new TemporaryDirectory(false)) {
 123             var host = TestHost.createNew(List.of(new HostUser(0, &quot;duke&quot;, &quot;J. Duke&quot;)));
 124 
 125             var fromDir = temp.path().resolve(&quot;from.git&quot;);
 126             var fromLocalRepo = Repository.init(fromDir, VCS.GIT);
 127             var fromHostedRepo = new TestHostedRepository(host, &quot;test&quot;, fromLocalRepo);
 128 
 129             var toDir = temp.path().resolve(&quot;to.git&quot;);
 130             var toLocalRepo = Repository.init(toDir, VCS.GIT);
 131             var toGitConfig = toDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
 132             Files.write(toGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
 133                         StandardOpenOption.APPEND);
 134             var toHostedRepo = new TestHostedRepository(host, &quot;test-mirror&quot;, toLocalRepo);
 135 
 136             var forkDir = temp.path().resolve(&quot;fork.git&quot;);
 137             var forkLocalRepo = Repository.init(forkDir, VCS.GIT);
 138             var forkGitConfig = forkDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
 139             Files.write(forkGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
 140                         StandardOpenOption.APPEND);
 141             var toFork = new TestHostedRepository(host, &quot;test-mirror-fork&quot;, forkLocalRepo);
 142 
 143             var now = ZonedDateTime.now();
 144             var fromFileA = fromDir.resolve(&quot;a.txt&quot;);
 145             Files.writeString(fromFileA, &quot;Hello A\n&quot;);
 146             fromLocalRepo.add(fromFileA);
 147             var fromHashA = fromLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
 148             var fromCommits = fromLocalRepo.commits().asList();
 149             assertEquals(1, fromCommits.size());
 150             assertEquals(fromHashA, fromCommits.get(0).hash());
 151 
 152             var toFileA = toDir.resolve(&quot;a.txt&quot;);
 153             Files.writeString(toFileA, &quot;Hello A\n&quot;);
 154             toLocalRepo.add(toFileA);
 155             var toHashA = toLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
 156             var toCommits = toLocalRepo.commits().asList();
 157             assertEquals(1, toCommits.size());
 158             assertEquals(toHashA, toCommits.get(0).hash());
 159             assertEquals(fromHashA, toHashA);
 160 
 161             var fromFileB = fromDir.resolve(&quot;b.txt&quot;);
 162             Files.writeString(fromFileB, &quot;Hello B1\n&quot;);
 163             fromLocalRepo.add(fromFileB);
 164             var fromHashB = fromLocalRepo.commit(&quot;Adding b1.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
 165 
 166             var toFileB = toDir.resolve(&quot;b.txt&quot;);
 167             Files.writeString(toFileB, &quot;Hello B2\n&quot;);
 168             toLocalRepo.add(toFileB);
 169             var toHashB = toLocalRepo.commit(&quot;Adding b2.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
 170 
 171             var storage = temp.path().resolve(&quot;storage&quot;);
 172             var master = new Branch(&quot;master&quot;);
 173             var specs = List.of(new MergeBot.Spec(fromHostedRepo, master, master));
 174             var bot = new MergeBot(storage, toHostedRepo, toFork, specs);
 175             TestBotRunner.runPeriodicItems(bot);
 176 
 177             toCommits = toLocalRepo.commits().asList();
 178             assertEquals(2, toCommits.size());
 179             var toHashes = toCommits.stream().map(Commit::hash).collect(Collectors.toSet());
 180             assertTrue(toHashes.contains(toHashA));
 181             assertTrue(toHashes.contains(toHashB));
 182 
 183             var pullRequests = toHostedRepo.pullRequests();
 184             assertEquals(1, pullRequests.size());
 185             var pr = pullRequests.get(0);
 186             assertEquals(&quot;Cannot automatically merge test:master to master&quot;, pr.title());
 187         }
 188     }
 189 
 190     @Test
 191     void failingMergeShouldResultInOnlyOnePR(TestInfo testInfo) throws IOException {
 192         try (var temp = new TemporaryDirectory(false)) {
 193             var host = TestHost.createNew(List.of(new HostUser(0, &quot;duke&quot;, &quot;J. Duke&quot;)));
 194 
 195             var fromDir = temp.path().resolve(&quot;from.git&quot;);
 196             var fromLocalRepo = Repository.init(fromDir, VCS.GIT);
 197             var fromHostedRepo = new TestHostedRepository(host, &quot;test&quot;, fromLocalRepo);
 198 
 199             var toDir = temp.path().resolve(&quot;to.git&quot;);
 200             var toLocalRepo = Repository.init(toDir, VCS.GIT);
 201             var toGitConfig = toDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
 202             Files.write(toGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
 203                         StandardOpenOption.APPEND);
 204             var toHostedRepo = new TestHostedRepository(host, &quot;test-mirror&quot;, toLocalRepo);
 205 
 206             var forkDir = temp.path().resolve(&quot;fork.git&quot;);
 207             var forkLocalRepo = Repository.init(forkDir, VCS.GIT);
 208             var forkGitConfig = forkDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
 209             Files.write(forkGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
 210                         StandardOpenOption.APPEND);
 211             var toFork = new TestHostedRepository(host, &quot;test-mirror-fork&quot;, forkLocalRepo);
 212 
 213             var now = ZonedDateTime.now();
 214             var fromFileA = fromDir.resolve(&quot;a.txt&quot;);
 215             Files.writeString(fromFileA, &quot;Hello A\n&quot;);
 216             fromLocalRepo.add(fromFileA);
 217             var fromHashA = fromLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
 218             var fromCommits = fromLocalRepo.commits().asList();
 219             assertEquals(1, fromCommits.size());
 220             assertEquals(fromHashA, fromCommits.get(0).hash());
 221 
 222             var toFileA = toDir.resolve(&quot;a.txt&quot;);
 223             Files.writeString(toFileA, &quot;Hello A\n&quot;);
 224             toLocalRepo.add(toFileA);
 225             var toHashA = toLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
 226             var toCommits = toLocalRepo.commits().asList();
 227             assertEquals(1, toCommits.size());
 228             assertEquals(toHashA, toCommits.get(0).hash());
 229             assertEquals(fromHashA, toHashA);
 230 
 231             var fromFileB = fromDir.resolve(&quot;b.txt&quot;);
 232             Files.writeString(fromFileB, &quot;Hello B1\n&quot;);
 233             fromLocalRepo.add(fromFileB);
 234             var fromHashB = fromLocalRepo.commit(&quot;Adding b1.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
 235 
 236             var toFileB = toDir.resolve(&quot;b.txt&quot;);
 237             Files.writeString(toFileB, &quot;Hello B2\n&quot;);
 238             toLocalRepo.add(toFileB);
 239             var toHashB = toLocalRepo.commit(&quot;Adding b2.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
 240 
 241             var storage = temp.path().resolve(&quot;storage&quot;);
 242             var master = new Branch(&quot;master&quot;);
 243             var specs = List.of(new MergeBot.Spec(fromHostedRepo, master, master));
 244             var bot = new MergeBot(storage, toHostedRepo, toFork, specs);
 245             TestBotRunner.runPeriodicItems(bot);
 246             TestBotRunner.runPeriodicItems(bot);
 247 
 248             toCommits = toLocalRepo.commits().asList();
 249             assertEquals(2, toCommits.size());
 250             var toHashes = toCommits.stream().map(Commit::hash).collect(Collectors.toSet());
 251             assertTrue(toHashes.contains(toHashA));
 252             assertTrue(toHashes.contains(toHashB));
 253 
 254             var pullRequests = toHostedRepo.pullRequests();
 255             assertEquals(1, pullRequests.size());
 256             var pr = pullRequests.get(0);
 257             assertEquals(&quot;Cannot automatically merge test:master to master&quot;, pr.title());
 258         }
 259     }
 260 
 261     @Test
 262     void resolvedMergeConflictShouldResultInClosedPR(TestInfo testInfo) throws IOException {
 263         try (var temp = new TemporaryDirectory(false)) {
 264             var host = TestHost.createNew(List.of(new HostUser(0, &quot;duke&quot;, &quot;J. Duke&quot;)));
 265 
 266             var fromDir = temp.path().resolve(&quot;from.git&quot;);
 267             var fromLocalRepo = Repository.init(fromDir, VCS.GIT);
 268             var fromHostedRepo = new TestHostedRepository(host, &quot;test&quot;, fromLocalRepo);
 269 
 270             var toDir = temp.path().resolve(&quot;to.git&quot;);
 271             var toLocalRepo = Repository.init(toDir, VCS.GIT);
 272             var toGitConfig = toDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
 273             Files.write(toGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
 274                         StandardOpenOption.APPEND);
 275             var toHostedRepo = new TestHostedRepository(host, &quot;test-mirror&quot;, toLocalRepo);
 276 
 277             var forkDir = temp.path().resolve(&quot;fork.git&quot;);
 278             var forkLocalRepo = Repository.init(forkDir, VCS.GIT);
 279             var forkGitConfig = forkDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
 280             Files.write(forkGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
 281                         StandardOpenOption.APPEND);
 282             var toFork = new TestHostedRepository(host, &quot;test-mirror-fork&quot;, forkLocalRepo);
 283 
 284             var now = ZonedDateTime.now();
 285             var fromFileA = fromDir.resolve(&quot;a.txt&quot;);
 286             Files.writeString(fromFileA, &quot;Hello A\n&quot;);
 287             fromLocalRepo.add(fromFileA);
 288             var fromHashA = fromLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
 289             var fromCommits = fromLocalRepo.commits().asList();
 290             assertEquals(1, fromCommits.size());
 291             assertEquals(fromHashA, fromCommits.get(0).hash());
 292 
 293             var toFileA = toDir.resolve(&quot;a.txt&quot;);
 294             Files.writeString(toFileA, &quot;Hello A\n&quot;);
 295             toLocalRepo.add(toFileA);
 296             var toHashA = toLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
 297             var toCommits = toLocalRepo.commits().asList();
 298             assertEquals(1, toCommits.size());
 299             assertEquals(toHashA, toCommits.get(0).hash());
 300             assertEquals(fromHashA, toHashA);
 301 
 302             var fromFileB = fromDir.resolve(&quot;b.txt&quot;);
 303             Files.writeString(fromFileB, &quot;Hello B1\n&quot;);
 304             fromLocalRepo.add(fromFileB);
 305             var fromHashB = fromLocalRepo.commit(&quot;Adding b1.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
 306 
 307             var toFileB = toDir.resolve(&quot;b.txt&quot;);
 308             Files.writeString(toFileB, &quot;Hello B2\n&quot;);
 309             toLocalRepo.add(toFileB);
 310             var toHashB = toLocalRepo.commit(&quot;Adding b2.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
 311 
 312             var storage = temp.path().resolve(&quot;storage&quot;);
 313             var master = new Branch(&quot;master&quot;);
 314             var specs = List.of(new MergeBot.Spec(fromHostedRepo, master, master));
 315             var bot = new MergeBot(storage, toHostedRepo, toFork, specs);
 316             TestBotRunner.runPeriodicItems(bot);
 317             TestBotRunner.runPeriodicItems(bot);
 318 
 319             toCommits = toLocalRepo.commits().asList();
 320             assertEquals(2, toCommits.size());
 321             var toHashes = toCommits.stream().map(Commit::hash).collect(Collectors.toSet());
 322             assertTrue(toHashes.contains(toHashA));
 323             assertTrue(toHashes.contains(toHashB));
 324 
 325             var pullRequests = toHostedRepo.pullRequests();
 326             assertEquals(1, pullRequests.size());
 327             var pr = pullRequests.get(0);
 328             assertEquals(&quot;Cannot automatically merge test:master to master&quot;, pr.title());
 329 
 330             var fetchHead = toLocalRepo.fetch(fromHostedRepo.webUrl(), &quot;master&quot;);
 331             toLocalRepo.merge(fetchHead, &quot;ours&quot;);
 332             toLocalRepo.commit(&quot;Merge&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
 333 
 334             toCommits = toLocalRepo.commits().asList();
 335             assertEquals(4, toCommits.size());
 336 
 337             TestBotRunner.runPeriodicItems(bot);
 338             pullRequests = toHostedRepo.pullRequests();
 339             assertEquals(0, pullRequests.size());
 340         }
 341     }
 342 
 343     @Test
 344     void resolvedMergeConflictAndThenNewConflict(TestInfo testInfo) throws IOException {
 345         try (var temp = new TemporaryDirectory(false)) {
 346             var host = TestHost.createNew(List.of(new HostUser(0, &quot;duke&quot;, &quot;J. Duke&quot;)));
 347 
 348             var fromDir = temp.path().resolve(&quot;from.git&quot;);
 349             var fromLocalRepo = Repository.init(fromDir, VCS.GIT);
 350             var fromHostedRepo = new TestHostedRepository(host, &quot;test&quot;, fromLocalRepo);
 351 
 352             var toDir = temp.path().resolve(&quot;to.git&quot;);
 353             var toLocalRepo = Repository.init(toDir, VCS.GIT);
 354             var toGitConfig = toDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
 355             Files.write(toGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
 356                         StandardOpenOption.APPEND);
 357             var toHostedRepo = new TestHostedRepository(host, &quot;test-mirror&quot;, toLocalRepo);
 358 
 359             var forkDir = temp.path().resolve(&quot;fork.git&quot;);
 360             var forkLocalRepo = Repository.init(forkDir, VCS.GIT);
 361             var forkGitConfig = forkDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
 362             Files.write(forkGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
 363                         StandardOpenOption.APPEND);
 364             var toFork = new TestHostedRepository(host, &quot;test-mirror-fork&quot;, forkLocalRepo);
 365 
 366             var now = ZonedDateTime.now();
 367             var fromFileA = fromDir.resolve(&quot;a.txt&quot;);
 368             Files.writeString(fromFileA, &quot;Hello A\n&quot;);
 369             fromLocalRepo.add(fromFileA);
 370             var fromHashA = fromLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
 371             var fromCommits = fromLocalRepo.commits().asList();
 372             assertEquals(1, fromCommits.size());
 373             assertEquals(fromHashA, fromCommits.get(0).hash());
 374 
 375             var toFileA = toDir.resolve(&quot;a.txt&quot;);
 376             Files.writeString(toFileA, &quot;Hello A\n&quot;);
 377             toLocalRepo.add(toFileA);
 378             var toHashA = toLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
 379             var toCommits = toLocalRepo.commits().asList();
 380             assertEquals(1, toCommits.size());
 381             assertEquals(toHashA, toCommits.get(0).hash());
 382             assertEquals(fromHashA, toHashA);
 383 
 384             var fromFileB = fromDir.resolve(&quot;b.txt&quot;);
 385             Files.writeString(fromFileB, &quot;Hello B1\n&quot;);
 386             fromLocalRepo.add(fromFileB);
 387             var fromHashB = fromLocalRepo.commit(&quot;Adding b1.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
 388 
 389             var toFileB = toDir.resolve(&quot;b.txt&quot;);
 390             Files.writeString(toFileB, &quot;Hello B2\n&quot;);
 391             toLocalRepo.add(toFileB);
 392             var toHashB = toLocalRepo.commit(&quot;Adding b2.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
 393 
 394             var storage = temp.path().resolve(&quot;storage&quot;);
 395             var master = new Branch(&quot;master&quot;);
 396             var specs = List.of(new MergeBot.Spec(fromHostedRepo, master, master));
 397             var bot = new MergeBot(storage, toHostedRepo, toFork, specs);
 398             TestBotRunner.runPeriodicItems(bot);
 399             TestBotRunner.runPeriodicItems(bot);
 400 
 401             toCommits = toLocalRepo.commits().asList();
 402             assertEquals(2, toCommits.size());
 403             var toHashes = toCommits.stream().map(Commit::hash).collect(Collectors.toSet());
 404             assertTrue(toHashes.contains(toHashA));
 405             assertTrue(toHashes.contains(toHashB));
 406 
 407             var pullRequests = toHostedRepo.pullRequests();
 408             assertEquals(1, pullRequests.size());
 409             var pr = pullRequests.get(0);
 410             assertEquals(&quot;Cannot automatically merge test:master to master&quot;, pr.title());
 411 
 412             var fetchHead = toLocalRepo.fetch(fromHostedRepo.webUrl(), &quot;master&quot;);
 413             toLocalRepo.merge(fetchHead, &quot;ours&quot;);
 414             toLocalRepo.commit(&quot;Merge&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
 415 
 416             toCommits = toLocalRepo.commits().asList();
 417             assertEquals(4, toCommits.size());
 418 
 419             TestBotRunner.runPeriodicItems(bot);
 420             pullRequests = toHostedRepo.pullRequests();
 421             assertEquals(0, pullRequests.size());
 422 
 423             var fromFileC = fromDir.resolve(&quot;c.txt&quot;);
 424             Files.writeString(fromFileC, &quot;Hello C1\n&quot;);
 425             fromLocalRepo.add(fromFileC);
 426             fromLocalRepo.commit(&quot;Adding c1&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
 427 
 428             var toFileC = toDir.resolve(&quot;c.txt&quot;);
 429             Files.writeString(toFileC, &quot;Hello C2\n&quot;);
 430             toLocalRepo.add(toFileC);
 431             toLocalRepo.commit(&quot;Adding c2&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
 432 
 433             TestBotRunner.runPeriodicItems(bot);
 434             pullRequests = toHostedRepo.pullRequests();
 435             assertEquals(1, pullRequests.size());
 436             assertEquals(&quot;Cannot automatically merge test:master to master&quot;, pr.title());
 437         }
 438     }
 439 
 440     final static class TestClock implements Clock {
 441         ZonedDateTime now;
 442 
 443         TestClock() {
 444             this(null);
 445         }
 446 
 447         TestClock(ZonedDateTime now) {
 448             this.now = now;
 449         }
 450 
 451         @Override
 452         public ZonedDateTime now() {
 453             return now;
 454         }
 455     }
 456 
 457     @Test
 458     void testMergeHourly(TestInfo testInfo) throws IOException {
 459         try (var temp = new TemporaryDirectory(false)) {
 460             var host = TestHost.createNew(List.of(new HostUser(0, &quot;duke&quot;, &quot;J. Duke&quot;)));
 461 
 462             var fromDir = temp.path().resolve(&quot;from.git&quot;);
 463             var fromLocalRepo = Repository.init(fromDir, VCS.GIT);
 464             var fromHostedRepo = new TestHostedRepository(host, &quot;test&quot;, fromLocalRepo);
 465 
 466             var toDir = temp.path().resolve(&quot;to.git&quot;);
 467             var toLocalRepo = Repository.init(toDir, VCS.GIT);
 468             var toGitConfig = toDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
 469             Files.write(toGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
 470                         StandardOpenOption.APPEND);
 471             var toHostedRepo = new TestHostedRepository(host, &quot;test-mirror&quot;, toLocalRepo);
 472 
 473             var forkDir = temp.path().resolve(&quot;fork.git&quot;);
 474             var forkLocalRepo = Repository.init(forkDir, VCS.GIT);
 475             var forkGitConfig = forkDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
 476             Files.write(forkGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
 477                         StandardOpenOption.APPEND);
 478             var toFork = new TestHostedRepository(host, &quot;test-mirror-fork&quot;, forkLocalRepo);
 479 
 480             var now = ZonedDateTime.now();
 481             var fromFileA = fromDir.resolve(&quot;a.txt&quot;);
 482             Files.writeString(fromFileA, &quot;Hello A\n&quot;);
 483             fromLocalRepo.add(fromFileA);
 484             var fromHashA = fromLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
 485             var fromCommits = fromLocalRepo.commits().asList();
 486             assertEquals(1, fromCommits.size());
 487             assertEquals(fromHashA, fromCommits.get(0).hash());
 488 
 489             var toFileA = toDir.resolve(&quot;a.txt&quot;);
 490             Files.writeString(toFileA, &quot;Hello A\n&quot;);
 491             toLocalRepo.add(toFileA);
 492             var toHashA = toLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
 493             var toCommits = toLocalRepo.commits().asList();
 494             assertEquals(1, toCommits.size());
 495             assertEquals(toHashA, toCommits.get(0).hash());
 496             assertEquals(fromHashA, toHashA);
 497 
 498             var fromFileB = fromDir.resolve(&quot;b.txt&quot;);
 499             Files.writeString(fromFileB, &quot;Hello B\n&quot;);
 500             fromLocalRepo.add(fromFileB);
 501             var fromHashB = fromLocalRepo.commit(&quot;Adding b.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
 502 
 503             var toFileC = toDir.resolve(&quot;c.txt&quot;);
 504             Files.writeString(toFileC, &quot;Hello C\n&quot;);
 505             toLocalRepo.add(toFileC);
 506             var toHashC = toLocalRepo.commit(&quot;Adding c.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
 507 
 508             var storage = temp.path().resolve(&quot;storage&quot;);
 509             var master = new Branch(&quot;master&quot;);
 510 
 511             // Merge only at most once during the first minute every hour
 512             var freq = MergeBot.Spec.Frequency.hourly(1);
 513             var specs = List.of(new MergeBot.Spec(fromHostedRepo, master, master, freq));
 514 
 515             var clock = new TestClock(ZonedDateTime.of(2020, 1, 23, 15, 0, 0, 0, ZoneId.of(&quot;GMT+1&quot;)));
 516             var bot = new MergeBot(storage, toHostedRepo, toFork, specs, clock);
 517 
 518             TestBotRunner.runPeriodicItems(bot);
 519 
 520             // Ensure nothing has been merged
 521             toCommits = toLocalRepo.commits().asList();
 522             assertEquals(2, toCommits.size());
 523             assertEquals(toHashC, toCommits.get(0).hash());
 524             assertEquals(toHashA, toCommits.get(1).hash());
 525 
 526             // Set the clock to the first minute of the hour
 527             clock.now = ZonedDateTime.of(2020, 1, 23, 15, 1, 0, 0, ZoneId.of(&quot;GMT+1&quot;));
 528             TestBotRunner.runPeriodicItems(bot);
 529 
 530             // Should have merged
 531             toCommits = toLocalRepo.commits().asList();
 532             assertEquals(4, toCommits.size());
 533             var hashes = toCommits.stream().map(Commit::hash).collect(Collectors.toSet());
 534             assertTrue(hashes.contains(toHashA));
 535             assertTrue(hashes.contains(fromHashB));
 536             assertTrue(hashes.contains(toHashC));
 537 
 538             var known = Set.of(toHashA, fromHashB, toHashC);
 539             var merge = toCommits.stream().filter(c -&gt; !known.contains(c.hash())).findAny().get();
 540             assertTrue(merge.isMerge());
 541             assertEquals(List.of(&quot;Automatic merge of master into master&quot;), merge.message());
 542             assertEquals(&quot;duke&quot;, merge.author().name());
 543             assertEquals(&quot;duke@openjdk.org&quot;, merge.author().email());
 544 
 545             assertEquals(0, toHostedRepo.pullRequests().size());
 546 
 547             var fromFileD = fromDir.resolve(&quot;d.txt&quot;);
 548             Files.writeString(fromFileD, &quot;Hello D\n&quot;);
 549             fromLocalRepo.add(fromFileD);
 550             var fromHashD = fromLocalRepo.commit(&quot;Adding d.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
 551 
 552             // Since the time hasn&#39;t changed it should not merge again
 553             TestBotRunner.runPeriodicItems(bot);
 554             toCommits = toLocalRepo.commits().asList();
 555             assertEquals(4, toCommits.size());
 556 
 557             // Move the minutes forward, the bot should not merge
 558             clock.now = ZonedDateTime.of(2020, 1, 23, 15, 45, 0, 0, ZoneId.of(&quot;GMT+1&quot;));
 559             TestBotRunner.runPeriodicItems(bot);
 560             toCommits = toLocalRepo.commits().asList();
 561             assertEquals(4, toCommits.size());
 562 
 563             // Move the clock forward one hour, the bot should merge
 564             clock.now = ZonedDateTime.of(2020, 1, 23, 16, 1, 0, 0, ZoneId.of(&quot;GMT+1&quot;));
 565             TestBotRunner.runPeriodicItems(bot);
 566 
 567             toCommits = toLocalRepo.commits().asList();
 568             assertEquals(6, toCommits.size());
 569         }
 570     }
 571 
 572     @Test
 573     void testMergeDaily(TestInfo testInfo) throws IOException {
 574         try (var temp = new TemporaryDirectory(false)) {
 575             var host = TestHost.createNew(List.of(new HostUser(0, &quot;duke&quot;, &quot;J. Duke&quot;)));
 576 
 577             var fromDir = temp.path().resolve(&quot;from.git&quot;);
 578             var fromLocalRepo = Repository.init(fromDir, VCS.GIT);
 579             var fromHostedRepo = new TestHostedRepository(host, &quot;test&quot;, fromLocalRepo);
 580 
 581             var toDir = temp.path().resolve(&quot;to.git&quot;);
 582             var toLocalRepo = Repository.init(toDir, VCS.GIT);
 583             var toGitConfig = toDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
 584             Files.write(toGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
 585                         StandardOpenOption.APPEND);
 586             var toHostedRepo = new TestHostedRepository(host, &quot;test-mirror&quot;, toLocalRepo);
 587 
 588             var forkDir = temp.path().resolve(&quot;fork.git&quot;);
 589             var forkLocalRepo = Repository.init(forkDir, VCS.GIT);
 590             var forkGitConfig = forkDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
 591             Files.write(forkGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
 592                         StandardOpenOption.APPEND);
 593             var toFork = new TestHostedRepository(host, &quot;test-mirror-fork&quot;, forkLocalRepo);
 594 
 595             var now = ZonedDateTime.now();
 596             var fromFileA = fromDir.resolve(&quot;a.txt&quot;);
 597             Files.writeString(fromFileA, &quot;Hello A\n&quot;);
 598             fromLocalRepo.add(fromFileA);
 599             var fromHashA = fromLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
 600             var fromCommits = fromLocalRepo.commits().asList();
 601             assertEquals(1, fromCommits.size());
 602             assertEquals(fromHashA, fromCommits.get(0).hash());
 603 
 604             var toFileA = toDir.resolve(&quot;a.txt&quot;);
 605             Files.writeString(toFileA, &quot;Hello A\n&quot;);
 606             toLocalRepo.add(toFileA);
 607             var toHashA = toLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
 608             var toCommits = toLocalRepo.commits().asList();
 609             assertEquals(1, toCommits.size());
 610             assertEquals(toHashA, toCommits.get(0).hash());
 611             assertEquals(fromHashA, toHashA);
 612 
 613             var fromFileB = fromDir.resolve(&quot;b.txt&quot;);
 614             Files.writeString(fromFileB, &quot;Hello B\n&quot;);
 615             fromLocalRepo.add(fromFileB);
 616             var fromHashB = fromLocalRepo.commit(&quot;Adding b.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
 617 
 618             var toFileC = toDir.resolve(&quot;c.txt&quot;);
 619             Files.writeString(toFileC, &quot;Hello C\n&quot;);
 620             toLocalRepo.add(toFileC);
 621             var toHashC = toLocalRepo.commit(&quot;Adding c.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
 622 
 623             var storage = temp.path().resolve(&quot;storage&quot;);
 624             var master = new Branch(&quot;master&quot;);
 625 
 626             // Merge only at most once during the third hour every day
 627             var freq = MergeBot.Spec.Frequency.daily(3);
 628             var specs = List.of(new MergeBot.Spec(fromHostedRepo, master, master, freq));
 629 
 630             var clock = new TestClock(ZonedDateTime.of(2020, 1, 23, 2, 45, 0, 0, ZoneId.of(&quot;GMT+1&quot;)));
 631             var bot = new MergeBot(storage, toHostedRepo, toFork, specs, clock);
 632 
 633             TestBotRunner.runPeriodicItems(bot);
 634 
 635             // Ensure nothing has been merged
 636             toCommits = toLocalRepo.commits().asList();
 637             assertEquals(2, toCommits.size());
 638             assertEquals(toHashC, toCommits.get(0).hash());
 639             assertEquals(toHashA, toCommits.get(1).hash());
 640 
 641             // Set the clock to the third hour of the day (minutes should not matter)
 642             clock.now = ZonedDateTime.of(2020, 1, 23, 3, 37, 0, 0, ZoneId.of(&quot;GMT+1&quot;));
 643             TestBotRunner.runPeriodicItems(bot);
 644 
 645             // Should have merged
 646             toCommits = toLocalRepo.commits().asList();
 647             assertEquals(4, toCommits.size());
 648             var hashes = toCommits.stream().map(Commit::hash).collect(Collectors.toSet());
 649             assertTrue(hashes.contains(toHashA));
 650             assertTrue(hashes.contains(fromHashB));
 651             assertTrue(hashes.contains(toHashC));
 652 
 653             var known = Set.of(toHashA, fromHashB, toHashC);
 654             var merge = toCommits.stream().filter(c -&gt; !known.contains(c.hash())).findAny().get();
 655             assertTrue(merge.isMerge());
 656             assertEquals(List.of(&quot;Automatic merge of master into master&quot;), merge.message());
 657             assertEquals(&quot;duke&quot;, merge.author().name());
 658             assertEquals(&quot;duke@openjdk.org&quot;, merge.author().email());
 659 
 660             assertEquals(0, toHostedRepo.pullRequests().size());
 661 
 662             var fromFileD = fromDir.resolve(&quot;d.txt&quot;);
 663             Files.writeString(fromFileD, &quot;Hello D\n&quot;);
 664             fromLocalRepo.add(fromFileD);
 665             var fromHashD = fromLocalRepo.commit(&quot;Adding d.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
 666 
 667             // Since the time hasn&#39;t changed it should not merge
 668             TestBotRunner.runPeriodicItems(bot);
 669             toCommits = toLocalRepo.commits().asList();
 670             assertEquals(4, toCommits.size());
 671 
 672             // Move the minutes forward, the bot should not merge
 673             clock.now = ZonedDateTime.of(2020, 1, 23, 3, 45, 0, 0, ZoneId.of(&quot;GMT+1&quot;));
 674             TestBotRunner.runPeriodicItems(bot);
 675             toCommits = toLocalRepo.commits().asList();
 676             assertEquals(4, toCommits.size());
 677 
 678             // Move the hours forward, the bot should not merge
 679             clock.now = ZonedDateTime.of(2020, 1, 23, 17, 45, 0, 0, ZoneId.of(&quot;GMT+1&quot;));
 680             TestBotRunner.runPeriodicItems(bot);
 681             toCommits = toLocalRepo.commits().asList();
 682             assertEquals(4, toCommits.size());
 683 
 684             // Move the clock forward one day, the bot should merge
 685             clock.now = ZonedDateTime.of(2020, 1, 24, 3, 55, 0, 0, ZoneId.of(&quot;GMT+1&quot;));
 686             TestBotRunner.runPeriodicItems(bot);
 687 
 688             toCommits = toLocalRepo.commits().asList();
 689             assertEquals(6, toCommits.size());
 690         }
 691     }
 692 
 693     @Test
 694     void testMergeWeekly(TestInfo testInfo) throws IOException {
 695         try (var temp = new TemporaryDirectory(false)) {
 696             var host = TestHost.createNew(List.of(new HostUser(0, &quot;duke&quot;, &quot;J. Duke&quot;)));
 697 
 698             var fromDir = temp.path().resolve(&quot;from.git&quot;);
 699             var fromLocalRepo = Repository.init(fromDir, VCS.GIT);
 700             var fromHostedRepo = new TestHostedRepository(host, &quot;test&quot;, fromLocalRepo);
 701 
 702             var toDir = temp.path().resolve(&quot;to.git&quot;);
 703             var toLocalRepo = Repository.init(toDir, VCS.GIT);
 704             var toGitConfig = toDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
 705             Files.write(toGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
 706                         StandardOpenOption.APPEND);
 707             var toHostedRepo = new TestHostedRepository(host, &quot;test-mirror&quot;, toLocalRepo);
 708 
 709             var forkDir = temp.path().resolve(&quot;fork.git&quot;);
 710             var forkLocalRepo = Repository.init(forkDir, VCS.GIT);
 711             var forkGitConfig = forkDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
 712             Files.write(forkGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
 713                         StandardOpenOption.APPEND);
 714             var toFork = new TestHostedRepository(host, &quot;test-mirror-fork&quot;, forkLocalRepo);
 715 
 716             var now = ZonedDateTime.now();
 717             var fromFileA = fromDir.resolve(&quot;a.txt&quot;);
 718             Files.writeString(fromFileA, &quot;Hello A\n&quot;);
 719             fromLocalRepo.add(fromFileA);
 720             var fromHashA = fromLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
 721             var fromCommits = fromLocalRepo.commits().asList();
 722             assertEquals(1, fromCommits.size());
 723             assertEquals(fromHashA, fromCommits.get(0).hash());
 724 
 725             var toFileA = toDir.resolve(&quot;a.txt&quot;);
 726             Files.writeString(toFileA, &quot;Hello A\n&quot;);
 727             toLocalRepo.add(toFileA);
 728             var toHashA = toLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
 729             var toCommits = toLocalRepo.commits().asList();
 730             assertEquals(1, toCommits.size());
 731             assertEquals(toHashA, toCommits.get(0).hash());
 732             assertEquals(fromHashA, toHashA);
 733 
 734             var fromFileB = fromDir.resolve(&quot;b.txt&quot;);
 735             Files.writeString(fromFileB, &quot;Hello B\n&quot;);
 736             fromLocalRepo.add(fromFileB);
 737             var fromHashB = fromLocalRepo.commit(&quot;Adding b.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
 738 
 739             var toFileC = toDir.resolve(&quot;c.txt&quot;);
 740             Files.writeString(toFileC, &quot;Hello C\n&quot;);
 741             toLocalRepo.add(toFileC);
 742             var toHashC = toLocalRepo.commit(&quot;Adding c.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
 743 
 744             var storage = temp.path().resolve(&quot;storage&quot;);
 745             var master = new Branch(&quot;master&quot;);
 746 
 747             // Merge only at most once per week on Friday&#39;s at 12:00
 748             var freq = MergeBot.Spec.Frequency.weekly(DayOfWeek.FRIDAY, 12);
 749             var specs = List.of(new MergeBot.Spec(fromHostedRepo, master, master, freq));
 750 
 751             var clock = new TestClock(ZonedDateTime.of(2020, 1, 24, 11, 45, 0, 0, ZoneId.of(&quot;GMT+1&quot;)));
 752             var bot = new MergeBot(storage, toHostedRepo, toFork, specs, clock);
 753 
 754             TestBotRunner.runPeriodicItems(bot);
 755 
 756             // Ensure nothing has been merged
 757             toCommits = toLocalRepo.commits().asList();
 758             assertEquals(2, toCommits.size());
 759             assertEquals(toHashC, toCommits.get(0).hash());
 760             assertEquals(toHashA, toCommits.get(1).hash());
 761 
 762             // Set the clock to the 12th hour of the day (minutes should not matter)
 763             clock.now = ZonedDateTime.of(2020, 1, 24, 12, 37, 0, 0, ZoneId.of(&quot;GMT+1&quot;));
 764             TestBotRunner.runPeriodicItems(bot);
 765 
 766             // Should have merged
 767             toCommits = toLocalRepo.commits().asList();
 768             assertEquals(4, toCommits.size());
 769             var hashes = toCommits.stream().map(Commit::hash).collect(Collectors.toSet());
 770             assertTrue(hashes.contains(toHashA));
 771             assertTrue(hashes.contains(fromHashB));
 772             assertTrue(hashes.contains(toHashC));
 773 
 774             var known = Set.of(toHashA, fromHashB, toHashC);
 775             var merge = toCommits.stream().filter(c -&gt; !known.contains(c.hash())).findAny().get();
 776             assertTrue(merge.isMerge());
 777             assertEquals(List.of(&quot;Automatic merge of master into master&quot;), merge.message());
 778             assertEquals(&quot;duke&quot;, merge.author().name());
 779             assertEquals(&quot;duke@openjdk.org&quot;, merge.author().email());
 780 
 781             assertEquals(0, toHostedRepo.pullRequests().size());
 782 
 783             var fromFileD = fromDir.resolve(&quot;d.txt&quot;);
 784             Files.writeString(fromFileD, &quot;Hello D\n&quot;);
 785             fromLocalRepo.add(fromFileD);
 786             var fromHashD = fromLocalRepo.commit(&quot;Adding d.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
 787 
 788             // Since the time hasn&#39;t changed it should not merge
 789             TestBotRunner.runPeriodicItems(bot);
 790             toCommits = toLocalRepo.commits().asList();
 791             assertEquals(4, toCommits.size());
 792 
 793             // Move the hours forward, the bot should not merge
 794             clock.now = ZonedDateTime.of(2020, 1, 24, 13, 45, 0, 0, ZoneId.of(&quot;GMT+1&quot;));
 795             TestBotRunner.runPeriodicItems(bot);
 796             toCommits = toLocalRepo.commits().asList();
 797             assertEquals(4, toCommits.size());
 798 
 799             // Move the days forward, the bot should not merge
 800             clock.now = ZonedDateTime.of(2020, 1, 25, 13, 45, 0, 0, ZoneId.of(&quot;GMT+1&quot;));
 801             TestBotRunner.runPeriodicItems(bot);
 802             toCommits = toLocalRepo.commits().asList();
 803             assertEquals(4, toCommits.size());
 804 
 805             // Move the clock forward one week, the bot should merge
 806             clock.now = ZonedDateTime.of(2020, 1, 31, 12, 29, 0, 0, ZoneId.of(&quot;GMT+1&quot;));
 807             TestBotRunner.runPeriodicItems(bot);
 808 
 809             toCommits = toLocalRepo.commits().asList();
 810             assertEquals(6, toCommits.size());
 811         }
 812     }
 813 
 814     @Test
 815     void testMergeMonthly(TestInfo testInfo) throws IOException {
 816         try (var temp = new TemporaryDirectory(false)) {
 817             var host = TestHost.createNew(List.of(new HostUser(0, &quot;duke&quot;, &quot;J. Duke&quot;)));
 818 
 819             var fromDir = temp.path().resolve(&quot;from.git&quot;);
 820             var fromLocalRepo = Repository.init(fromDir, VCS.GIT);
 821             var fromHostedRepo = new TestHostedRepository(host, &quot;test&quot;, fromLocalRepo);
 822 
 823             var toDir = temp.path().resolve(&quot;to.git&quot;);
 824             var toLocalRepo = Repository.init(toDir, VCS.GIT);
 825             var toGitConfig = toDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
 826             Files.write(toGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
 827                         StandardOpenOption.APPEND);
 828             var toHostedRepo = new TestHostedRepository(host, &quot;test-mirror&quot;, toLocalRepo);
 829 
 830             var forkDir = temp.path().resolve(&quot;fork.git&quot;);
 831             var forkLocalRepo = Repository.init(forkDir, VCS.GIT);
 832             var forkGitConfig = forkDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
 833             Files.write(forkGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
 834                         StandardOpenOption.APPEND);
 835             var toFork = new TestHostedRepository(host, &quot;test-mirror-fork&quot;, forkLocalRepo);
 836 
 837             var now = ZonedDateTime.now();
 838             var fromFileA = fromDir.resolve(&quot;a.txt&quot;);
 839             Files.writeString(fromFileA, &quot;Hello A\n&quot;);
 840             fromLocalRepo.add(fromFileA);
 841             var fromHashA = fromLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
 842             var fromCommits = fromLocalRepo.commits().asList();
 843             assertEquals(1, fromCommits.size());
 844             assertEquals(fromHashA, fromCommits.get(0).hash());
 845 
 846             var toFileA = toDir.resolve(&quot;a.txt&quot;);
 847             Files.writeString(toFileA, &quot;Hello A\n&quot;);
 848             toLocalRepo.add(toFileA);
 849             var toHashA = toLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
 850             var toCommits = toLocalRepo.commits().asList();
 851             assertEquals(1, toCommits.size());
 852             assertEquals(toHashA, toCommits.get(0).hash());
 853             assertEquals(fromHashA, toHashA);
 854 
 855             var fromFileB = fromDir.resolve(&quot;b.txt&quot;);
 856             Files.writeString(fromFileB, &quot;Hello B\n&quot;);
 857             fromLocalRepo.add(fromFileB);
 858             var fromHashB = fromLocalRepo.commit(&quot;Adding b.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
 859 
 860             var toFileC = toDir.resolve(&quot;c.txt&quot;);
 861             Files.writeString(toFileC, &quot;Hello C\n&quot;);
 862             toLocalRepo.add(toFileC);
 863             var toHashC = toLocalRepo.commit(&quot;Adding c.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
 864 
 865             var storage = temp.path().resolve(&quot;storage&quot;);
 866             var master = new Branch(&quot;master&quot;);
 867 
 868             // Merge only at most once per month on the 17th day at at 11:00
 869             var freq = MergeBot.Spec.Frequency.monthly(17, 11);
 870             var specs = List.of(new MergeBot.Spec(fromHostedRepo, master, master, freq));
 871 
 872             var clock = new TestClock(ZonedDateTime.of(2020, 1, 16, 11, 0, 0, 0, ZoneId.of(&quot;GMT+1&quot;)));
 873             var bot = new MergeBot(storage, toHostedRepo, toFork, specs, clock);
 874 
 875             TestBotRunner.runPeriodicItems(bot);
 876 
 877             // Ensure nothing has been merged
 878             toCommits = toLocalRepo.commits().asList();
 879             assertEquals(2, toCommits.size());
 880             assertEquals(toHashC, toCommits.get(0).hash());
 881             assertEquals(toHashA, toCommits.get(1).hash());
 882 
 883             // Set the clock to the 17th day and at hour 11 (minutes should not matter)
 884             clock.now = ZonedDateTime.of(2020, 1, 17, 11, 37, 0, 0, ZoneId.of(&quot;GMT+1&quot;));
 885             TestBotRunner.runPeriodicItems(bot);
 886 
 887             // Should have merged
 888             toCommits = toLocalRepo.commits().asList();
 889             assertEquals(4, toCommits.size());
 890             var hashes = toCommits.stream().map(Commit::hash).collect(Collectors.toSet());
 891             assertTrue(hashes.contains(toHashA));
 892             assertTrue(hashes.contains(fromHashB));
 893             assertTrue(hashes.contains(toHashC));
 894 
 895             var known = Set.of(toHashA, fromHashB, toHashC);
 896             var merge = toCommits.stream().filter(c -&gt; !known.contains(c.hash())).findAny().get();
 897             assertTrue(merge.isMerge());
 898             assertEquals(List.of(&quot;Automatic merge of master into master&quot;), merge.message());
 899             assertEquals(&quot;duke&quot;, merge.author().name());
 900             assertEquals(&quot;duke@openjdk.org&quot;, merge.author().email());
 901 
 902             assertEquals(0, toHostedRepo.pullRequests().size());
 903 
 904             var fromFileD = fromDir.resolve(&quot;d.txt&quot;);
 905             Files.writeString(fromFileD, &quot;Hello D\n&quot;);
 906             fromLocalRepo.add(fromFileD);
 907             var fromHashD = fromLocalRepo.commit(&quot;Adding d.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
 908 
 909             // Since the time hasn&#39;t changed it should not merge
 910             TestBotRunner.runPeriodicItems(bot);
 911             toCommits = toLocalRepo.commits().asList();
 912             assertEquals(4, toCommits.size());
 913 
 914             // Move the hours forward, the bot should not merge
 915             clock.now = ZonedDateTime.of(2020, 1, 17, 12, 45, 0, 0, ZoneId.of(&quot;GMT+1&quot;));
 916             TestBotRunner.runPeriodicItems(bot);
 917             toCommits = toLocalRepo.commits().asList();
 918             assertEquals(4, toCommits.size());
 919 
 920             // Move the days forward, the bot should not merge
 921             clock.now = ZonedDateTime.of(2020, 1, 18, 11, 0, 0, 0, ZoneId.of(&quot;GMT+1&quot;));
 922             TestBotRunner.runPeriodicItems(bot);
 923             toCommits = toLocalRepo.commits().asList();
 924             assertEquals(4, toCommits.size());
 925 
 926             // Move the clock forward one month, the bot should merge
 927             clock.now = ZonedDateTime.of(2020, 2, 17, 11, 55, 0, 0, ZoneId.of(&quot;GMT+1&quot;));
 928             TestBotRunner.runPeriodicItems(bot);
 929 
 930             toCommits = toLocalRepo.commits().asList();
 931             assertEquals(6, toCommits.size());
 932         }
 933     }
 934 
 935     @Test
 936     void testMergeYearly(TestInfo testInfo) throws IOException {
 937         try (var temp = new TemporaryDirectory(false)) {
 938             var host = TestHost.createNew(List.of(new HostUser(0, &quot;duke&quot;, &quot;J. Duke&quot;)));
 939 
 940             var fromDir = temp.path().resolve(&quot;from.git&quot;);
 941             var fromLocalRepo = Repository.init(fromDir, VCS.GIT);
 942             var fromHostedRepo = new TestHostedRepository(host, &quot;test&quot;, fromLocalRepo);
 943 
 944             var toDir = temp.path().resolve(&quot;to.git&quot;);
 945             var toLocalRepo = Repository.init(toDir, VCS.GIT);
 946             var toGitConfig = toDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
 947             Files.write(toGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
 948                         StandardOpenOption.APPEND);
 949             var toHostedRepo = new TestHostedRepository(host, &quot;test-mirror&quot;, toLocalRepo);
 950 
 951             var forkDir = temp.path().resolve(&quot;fork.git&quot;);
 952             var forkLocalRepo = Repository.init(forkDir, VCS.GIT);
 953             var forkGitConfig = forkDir.resolve(&quot;.git&quot;).resolve(&quot;config&quot;);
 954             Files.write(forkGitConfig, List.of(&quot;[receive]&quot;, &quot;denyCurrentBranch = ignore&quot;),
 955                         StandardOpenOption.APPEND);
 956             var toFork = new TestHostedRepository(host, &quot;test-mirror-fork&quot;, forkLocalRepo);
 957 
 958             var now = ZonedDateTime.now();
 959             var fromFileA = fromDir.resolve(&quot;a.txt&quot;);
 960             Files.writeString(fromFileA, &quot;Hello A\n&quot;);
 961             fromLocalRepo.add(fromFileA);
 962             var fromHashA = fromLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
 963             var fromCommits = fromLocalRepo.commits().asList();
 964             assertEquals(1, fromCommits.size());
 965             assertEquals(fromHashA, fromCommits.get(0).hash());
 966 
 967             var toFileA = toDir.resolve(&quot;a.txt&quot;);
 968             Files.writeString(toFileA, &quot;Hello A\n&quot;);
 969             toLocalRepo.add(toFileA);
 970             var toHashA = toLocalRepo.commit(&quot;Adding a.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;, now);
 971             var toCommits = toLocalRepo.commits().asList();
 972             assertEquals(1, toCommits.size());
 973             assertEquals(toHashA, toCommits.get(0).hash());
 974             assertEquals(fromHashA, toHashA);
 975 
 976             var fromFileB = fromDir.resolve(&quot;b.txt&quot;);
 977             Files.writeString(fromFileB, &quot;Hello B\n&quot;);
 978             fromLocalRepo.add(fromFileB);
 979             var fromHashB = fromLocalRepo.commit(&quot;Adding b.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
 980 
 981             var toFileC = toDir.resolve(&quot;c.txt&quot;);
 982             Files.writeString(toFileC, &quot;Hello C\n&quot;);
 983             toLocalRepo.add(toFileC);
 984             var toHashC = toLocalRepo.commit(&quot;Adding c.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
 985 
 986             var storage = temp.path().resolve(&quot;storage&quot;);
 987             var master = new Branch(&quot;master&quot;);
 988 
 989             // Merge only at most once per year on the 29th day of May at at 07:00
 990             var freq = MergeBot.Spec.Frequency.yearly(Month.MAY, 29, 07);
 991             var specs = List.of(new MergeBot.Spec(fromHostedRepo, master, master, freq));
 992 
 993             var clock = new TestClock(ZonedDateTime.of(2020, 5, 27, 11, 0, 0, 0, ZoneId.of(&quot;GMT+1&quot;)));
 994             var bot = new MergeBot(storage, toHostedRepo, toFork, specs, clock);
 995 
 996             TestBotRunner.runPeriodicItems(bot);
 997 
 998             // Ensure nothing has been merged
 999             toCommits = toLocalRepo.commits().asList();
1000             assertEquals(2, toCommits.size());
1001             assertEquals(toHashC, toCommits.get(0).hash());
1002             assertEquals(toHashA, toCommits.get(1).hash());
1003 
1004             // Set the clock to the 29th of May and at hour 11 (minutes should not matter)
1005             clock.now = ZonedDateTime.of(2020, 5, 29, 7, 37, 0, 0, ZoneId.of(&quot;GMT+1&quot;));
1006             TestBotRunner.runPeriodicItems(bot);
1007 
1008             // Should have merged
1009             toCommits = toLocalRepo.commits().asList();
1010             assertEquals(4, toCommits.size());
1011             var hashes = toCommits.stream().map(Commit::hash).collect(Collectors.toSet());
1012             assertTrue(hashes.contains(toHashA));
1013             assertTrue(hashes.contains(fromHashB));
1014             assertTrue(hashes.contains(toHashC));
1015 
1016             var known = Set.of(toHashA, fromHashB, toHashC);
1017             var merge = toCommits.stream().filter(c -&gt; !known.contains(c.hash())).findAny().get();
1018             assertTrue(merge.isMerge());
1019             assertEquals(List.of(&quot;Automatic merge of master into master&quot;), merge.message());
1020             assertEquals(&quot;duke&quot;, merge.author().name());
1021             assertEquals(&quot;duke@openjdk.org&quot;, merge.author().email());
1022 
1023             assertEquals(0, toHostedRepo.pullRequests().size());
1024 
1025             var fromFileD = fromDir.resolve(&quot;d.txt&quot;);
1026             Files.writeString(fromFileD, &quot;Hello D\n&quot;);
1027             fromLocalRepo.add(fromFileD);
1028             var fromHashD = fromLocalRepo.commit(&quot;Adding d.txt&quot;, &quot;duke&quot;, &quot;duke@openjdk.org&quot;);
1029 
1030             // Since the time hasn&#39;t changed it should not merge again
1031             TestBotRunner.runPeriodicItems(bot);
1032             toCommits = toLocalRepo.commits().asList();
1033             assertEquals(4, toCommits.size());
1034 
1035             // Move the hours forward, the bot should not merge
1036             clock.now = ZonedDateTime.of(2020, 5, 29, 8, 45, 0, 0, ZoneId.of(&quot;GMT+1&quot;));
1037             TestBotRunner.runPeriodicItems(bot);
1038             toCommits = toLocalRepo.commits().asList();
1039             assertEquals(4, toCommits.size());
1040 
1041             // Move the days forward, the bot should not merge
1042             clock.now = ZonedDateTime.of(2020, 5, 30, 11, 0, 0, 0, ZoneId.of(&quot;GMT+1&quot;));
1043             TestBotRunner.runPeriodicItems(bot);
1044             toCommits = toLocalRepo.commits().asList();
1045             assertEquals(4, toCommits.size());
1046 
1047             // Move the months forward, the bot should not merge
1048             clock.now = ZonedDateTime.of(2020, 7, 29, 7, 0, 0, 0, ZoneId.of(&quot;GMT+1&quot;));
1049             TestBotRunner.runPeriodicItems(bot);
1050             toCommits = toLocalRepo.commits().asList();
1051             assertEquals(4, toCommits.size());
1052 
1053             // Move the clock forward one year, the bot should merge
1054             clock.now = ZonedDateTime.of(2021, 5, 29, 7, 55, 0, 0, ZoneId.of(&quot;GMT+1&quot;));
1055             TestBotRunner.runPeriodicItems(bot);
1056 
1057             toCommits = toLocalRepo.commits().asList();
1058             assertEquals(6, toCommits.size());
1059         }
1060     }
1061 }
    </pre>
  </body>
</html>