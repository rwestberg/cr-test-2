<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames src/java.base/share/classes/java/lang/invoke/X-VarHandleByteArrayView.java.template</title>
    <link rel="stylesheet" href="../../../../../../../style.css" />
    <script type="text/javascript" src="../../../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>   1 /*
   2  * Copyright (c) 2015, 2019, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.  Oracle designates this
   8  * particular file as subject to the &quot;Classpath&quot; exception as provided
   9  * by Oracle in the LICENSE file that accompanied this code.
  10  *
  11  * This code is distributed in the hope that it will be useful, but WITHOUT
  12  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  13  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  14  * version 2 for more details (a copy is included in the LICENSE file that
  15  * accompanied this code).
  16  *
  17  * You should have received a copy of the GNU General Public License version
  18  * 2 along with this work; if not, write to the Free Software Foundation,
  19  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  20  *
  21  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  22  * or visit www.oracle.com if you need additional information or have any
  23  * questions.
  24  */
  25 package java.lang.invoke;
  26 
  27 import jdk.internal.access.JavaNioAccess;
  28 import jdk.internal.access.SharedSecrets;
  29 import jdk.internal.misc.Unsafe;
  30 import jdk.internal.util.Preconditions;
  31 import jdk.internal.vm.annotation.ForceInline;
  32 
  33 import java.nio.ByteBuffer;
  34 import java.nio.ReadOnlyBufferException;
  35 import java.util.Objects;
  36 
  37 import static java.lang.invoke.MethodHandleStatics.UNSAFE;
  38 
  39 #warn
  40 
  41 final class VarHandleByteArrayAs$Type$s extends VarHandleByteArrayBase {
  42 
  43     static JavaNioAccess nioAccess = SharedSecrets.getJavaNioAccess();
  44 
  45     static final int ALIGN = $BoxType$.BYTES - 1;
  46 
  47 #if[floatingPoint]
  48     @ForceInline
  49     static $rawType$ convEndian(boolean big, $type$ v) {
  50         $rawType$ rv = $Type$.$type$ToRaw$RawType$Bits(v);
  51         return big == BE ? rv : $RawBoxType$.reverseBytes(rv);
  52     }
  53 
  54     @ForceInline
  55     static $type$ convEndian(boolean big, $rawType$ rv) {
  56         rv = big == BE ? rv : $RawBoxType$.reverseBytes(rv);
  57         return $Type$.$rawType$BitsTo$Type$(rv);
  58     }
  59 #else[floatingPoint]
  60     @ForceInline
  61     static $type$ convEndian(boolean big, $type$ n) {
  62         return big == BE ? n : $BoxType$.reverseBytes(n);
  63     }
  64 #end[floatingPoint]
  65 
  66 
  67     private static abstract class ByteArrayViewVarHandle extends VarHandle {
  68         final boolean be;
  69 
  70         ByteArrayViewVarHandle(VarForm form, boolean be) {
  71             super(form);
  72             this.be = be;
  73         }
  74     }
  75 
  76     static final class ArrayHandle extends ByteArrayViewVarHandle {
  77 
  78         ArrayHandle(boolean be) {
  79             super(ArrayHandle.FORM, be);
  80         }
  81 
  82         @Override
  83         final MethodType accessModeTypeUncached(AccessMode accessMode) {
  84             return accessMode.at.accessModeType(byte[].class, $type$.class, int.class);
  85         }
  86 
  87         @ForceInline
  88         static int index(byte[] ba, int index) {
  89             return Preconditions.checkIndex(index, ba.length - ALIGN, null);
  90         }
  91 
  92         @ForceInline
  93         static long address(byte[] ba, int index) {
  94             long address = ((long) index) + Unsafe.ARRAY_BYTE_BASE_OFFSET;
  95             if ((address &amp; ALIGN) != 0)
  96                 throw newIllegalStateExceptionForMisalignedAccess(index);
  97             return address;
  98         }
  99 
 100         @ForceInline
<a name="1" id="anc1"></a><span class="line-modified"> 101         static $type$ get(VarHandle ob, Object oba, int index) {</span>
<span class="line-added"> 102             ArrayHandle handle = (ArrayHandle)ob;</span>
 103             byte[] ba = (byte[]) oba;
 104 #if[floatingPoint]
 105             $rawType$ rawValue = UNSAFE.get$RawType$Unaligned(
 106                     ba,
 107                     ((long) index(ba, index)) + Unsafe.ARRAY_BYTE_BASE_OFFSET,
 108                     handle.be);
 109             return $Type$.$rawType$BitsTo$Type$(rawValue);
 110 #else[floatingPoint]
 111             return UNSAFE.get$Type$Unaligned(
 112                     ba,
 113                     ((long) index(ba, index)) + Unsafe.ARRAY_BYTE_BASE_OFFSET,
 114                     handle.be);
 115 #end[floatingPoint]
 116         }
 117 
 118         @ForceInline
<a name="2" id="anc2"></a><span class="line-modified"> 119         static void set(VarHandle ob, Object oba, int index, $type$ value) {</span>
<span class="line-added"> 120             ArrayHandle handle = (ArrayHandle)ob;</span>
 121             byte[] ba = (byte[]) oba;
 122 #if[floatingPoint]
 123             UNSAFE.put$RawType$Unaligned(
 124                     ba,
 125                     ((long) index(ba, index)) + Unsafe.ARRAY_BYTE_BASE_OFFSET,
 126                     $Type$.$type$ToRaw$RawType$Bits(value),
 127                     handle.be);
 128 #else[floatingPoint]
 129             UNSAFE.put$RawType$Unaligned(
 130                     ba,
 131                     ((long) index(ba, index)) + Unsafe.ARRAY_BYTE_BASE_OFFSET,
 132                     value,
 133                     handle.be);
 134 #end[floatingPoint]
 135         }
 136 
 137         @ForceInline
<a name="3" id="anc3"></a><span class="line-modified"> 138         static $type$ getVolatile(VarHandle ob, Object oba, int index) {</span>
<span class="line-added"> 139             ArrayHandle handle = (ArrayHandle)ob;</span>
 140             byte[] ba = (byte[]) oba;
 141             return convEndian(handle.be,
 142                               UNSAFE.get$RawType$Volatile(
 143                                       ba,
 144                                       address(ba, index(ba, index))));
 145         }
 146 
 147         @ForceInline
<a name="4" id="anc4"></a><span class="line-modified"> 148         static void setVolatile(VarHandle ob, Object oba, int index, $type$ value) {</span>
<span class="line-added"> 149             ArrayHandle handle = (ArrayHandle)ob;</span>
 150             byte[] ba = (byte[]) oba;
 151             UNSAFE.put$RawType$Volatile(
 152                     ba,
 153                     address(ba, index(ba, index)),
 154                     convEndian(handle.be, value));
 155         }
 156 
 157         @ForceInline
<a name="5" id="anc5"></a><span class="line-modified"> 158         static $type$ getAcquire(VarHandle ob, Object oba, int index) {</span>
<span class="line-added"> 159             ArrayHandle handle = (ArrayHandle)ob;</span>
 160             byte[] ba = (byte[]) oba;
 161             return convEndian(handle.be,
 162                               UNSAFE.get$RawType$Acquire(
 163                                       ba,
 164                                       address(ba, index(ba, index))));
 165         }
 166 
 167         @ForceInline
<a name="6" id="anc6"></a><span class="line-modified"> 168         static void setRelease(VarHandle ob, Object oba, int index, $type$ value) {</span>
<span class="line-added"> 169             ArrayHandle handle = (ArrayHandle)ob;</span>
 170             byte[] ba = (byte[]) oba;
 171             UNSAFE.put$RawType$Release(
 172                     ba,
 173                     address(ba, index(ba, index)),
 174                     convEndian(handle.be, value));
 175         }
 176 
 177         @ForceInline
<a name="7" id="anc7"></a><span class="line-modified"> 178         static $type$ getOpaque(VarHandle ob, Object oba, int index) {</span>
<span class="line-added"> 179             ArrayHandle handle = (ArrayHandle)ob;</span>
 180             byte[] ba = (byte[]) oba;
 181             return convEndian(handle.be,
 182                               UNSAFE.get$RawType$Opaque(
 183                                       ba,
 184                                       address(ba, index(ba, index))));
 185         }
 186 
 187         @ForceInline
<a name="8" id="anc8"></a><span class="line-modified"> 188         static void setOpaque(VarHandle ob, Object oba, int index, $type$ value) {</span>
<span class="line-added"> 189             ArrayHandle handle = (ArrayHandle)ob;</span>
 190             byte[] ba = (byte[]) oba;
 191             UNSAFE.put$RawType$Opaque(
 192                     ba,
 193                     address(ba, index(ba, index)),
 194                     convEndian(handle.be, value));
 195         }
 196 #if[CAS]
 197 
 198         @ForceInline
<a name="9" id="anc9"></a><span class="line-modified"> 199         static boolean compareAndSet(VarHandle ob, Object oba, int index, $type$ expected, $type$ value) {</span>
<span class="line-added"> 200             ArrayHandle handle = (ArrayHandle)ob;</span>
 201             byte[] ba = (byte[]) oba;
 202 #if[Object]
 203             return UNSAFE.compareAndSetReference(
 204                     ba,
 205                     address(ba, index(ba, index)),
 206                     convEndian(handle.be, expected), convEndian(handle.be, value));
 207 #else[Object]
 208             return UNSAFE.compareAndSet$RawType$(
 209                     ba,
 210                     address(ba, index(ba, index)),
 211                     convEndian(handle.be, expected), convEndian(handle.be, value));
 212 #end[Object]
 213         }
 214 
 215         @ForceInline
<a name="10" id="anc10"></a><span class="line-modified"> 216         static $type$ compareAndExchange(VarHandle ob, Object oba, int index, $type$ expected, $type$ value) {</span>
<span class="line-added"> 217             ArrayHandle handle = (ArrayHandle)ob;</span>
 218             byte[] ba = (byte[]) oba;
 219             return convEndian(handle.be,
 220                               UNSAFE.compareAndExchange$RawType$(
 221                                       ba,
 222                                       address(ba, index(ba, index)),
 223                                       convEndian(handle.be, expected), convEndian(handle.be, value)));
 224         }
 225 
 226         @ForceInline
<a name="11" id="anc11"></a><span class="line-modified"> 227         static $type$ compareAndExchangeAcquire(VarHandle ob, Object oba, int index, $type$ expected, $type$ value) {</span>
<span class="line-added"> 228             ArrayHandle handle = (ArrayHandle)ob;</span>
 229             byte[] ba = (byte[]) oba;
 230             return convEndian(handle.be,
 231                               UNSAFE.compareAndExchange$RawType$Acquire(
 232                                       ba,
 233                                       address(ba, index(ba, index)),
 234                                       convEndian(handle.be, expected), convEndian(handle.be, value)));
 235         }
 236 
 237         @ForceInline
<a name="12" id="anc12"></a><span class="line-modified"> 238         static $type$ compareAndExchangeRelease(VarHandle ob, Object oba, int index, $type$ expected, $type$ value) {</span>
<span class="line-added"> 239             ArrayHandle handle = (ArrayHandle)ob;</span>
 240             byte[] ba = (byte[]) oba;
 241             return convEndian(handle.be,
 242                               UNSAFE.compareAndExchange$RawType$Release(
 243                                       ba,
 244                                       address(ba, index(ba, index)),
 245                                       convEndian(handle.be, expected), convEndian(handle.be, value)));
 246         }
 247 
 248         @ForceInline
<a name="13" id="anc13"></a><span class="line-modified"> 249         static boolean weakCompareAndSetPlain(VarHandle ob, Object oba, int index, $type$ expected, $type$ value) {</span>
<span class="line-added"> 250             ArrayHandle handle = (ArrayHandle)ob;</span>
 251             byte[] ba = (byte[]) oba;
 252             return UNSAFE.weakCompareAndSet$RawType$Plain(
 253                     ba,
 254                     address(ba, index(ba, index)),
 255                     convEndian(handle.be, expected), convEndian(handle.be, value));
 256         }
 257 
 258         @ForceInline
<a name="14" id="anc14"></a><span class="line-modified"> 259         static boolean weakCompareAndSet(VarHandle ob, Object oba, int index, $type$ expected, $type$ value) {</span>
<span class="line-added"> 260             ArrayHandle handle = (ArrayHandle)ob;</span>
 261             byte[] ba = (byte[]) oba;
 262             return UNSAFE.weakCompareAndSet$RawType$(
 263                     ba,
 264                     address(ba, index(ba, index)),
 265                     convEndian(handle.be, expected), convEndian(handle.be, value));
 266         }
 267 
 268         @ForceInline
<a name="15" id="anc15"></a><span class="line-modified"> 269         static boolean weakCompareAndSetAcquire(VarHandle ob, Object oba, int index, $type$ expected, $type$ value) {</span>
<span class="line-added"> 270             ArrayHandle handle = (ArrayHandle)ob;</span>
 271             byte[] ba = (byte[]) oba;
 272             return UNSAFE.weakCompareAndSet$RawType$Acquire(
 273                     ba,
 274                     address(ba, index(ba, index)),
 275                     convEndian(handle.be, expected), convEndian(handle.be, value));
 276         }
 277 
 278         @ForceInline
<a name="16" id="anc16"></a><span class="line-modified"> 279         static boolean weakCompareAndSetRelease(VarHandle ob, Object oba, int index, $type$ expected, $type$ value) {</span>
<span class="line-added"> 280             ArrayHandle handle = (ArrayHandle)ob;</span>
 281             byte[] ba = (byte[]) oba;
 282             return UNSAFE.weakCompareAndSet$RawType$Release(
 283                     ba,
 284                     address(ba, index(ba, index)),
 285                     convEndian(handle.be, expected), convEndian(handle.be, value));
 286         }
 287 
 288         @ForceInline
<a name="17" id="anc17"></a><span class="line-modified"> 289         static $type$ getAndSet(VarHandle ob, Object oba, int index, $type$ value) {</span>
<span class="line-added"> 290             ArrayHandle handle = (ArrayHandle)ob;</span>
 291             byte[] ba = (byte[]) oba;
 292 #if[Object]
 293             return convEndian(handle.be,
 294                               UNSAFE.getAndSetReference(
 295                                       ba,
 296                                       address(ba, index(ba, index)),
 297                                       convEndian(handle.be, value)));
 298 #else[Object]
 299             return convEndian(handle.be,
 300                               UNSAFE.getAndSet$RawType$(
 301                                       ba,
 302                                       address(ba, index(ba, index)),
 303                                       convEndian(handle.be, value)));
 304 #end[Object]
 305         }
 306 
 307         @ForceInline
<a name="18" id="anc18"></a><span class="line-modified"> 308         static $type$ getAndSetAcquire(VarHandle ob, Object oba, int index, $type$ value) {</span>
<span class="line-added"> 309             ArrayHandle handle = (ArrayHandle)ob;</span>
 310             byte[] ba = (byte[]) oba;
 311             return convEndian(handle.be,
 312                               UNSAFE.getAndSet$RawType$Acquire(
 313                                       ba,
 314                                       address(ba, index(ba, index)),
 315                                       convEndian(handle.be, value)));
 316         }
 317 
 318         @ForceInline
<a name="19" id="anc19"></a><span class="line-modified"> 319         static $type$ getAndSetRelease(VarHandle ob, Object oba, int index, $type$ value) {</span>
<span class="line-added"> 320             ArrayHandle handle = (ArrayHandle)ob;</span>
 321             byte[] ba = (byte[]) oba;
 322             return convEndian(handle.be,
 323                               UNSAFE.getAndSet$RawType$Release(
 324                                       ba,
 325                                       address(ba, index(ba, index)),
 326                                       convEndian(handle.be, value)));
 327         }
 328 #end[CAS]
 329 #if[AtomicAdd]
 330 
 331         @ForceInline
<a name="20" id="anc20"></a><span class="line-modified"> 332         static $type$ getAndAdd(VarHandle ob, Object oba, int index, $type$ delta) {</span>
<span class="line-added"> 333             ArrayHandle handle = (ArrayHandle)ob;</span>
 334             byte[] ba = (byte[]) oba;
 335             if (handle.be == BE) {
 336                 return UNSAFE.getAndAdd$RawType$(
 337                         ba,
 338                         address(ba, index(ba, index)),
 339                         delta);
 340             } else {
 341                 return getAndAddConvEndianWithCAS(ba, index, delta);
 342             }
 343         }
 344 
 345         @ForceInline
<a name="21" id="anc21"></a><span class="line-modified"> 346         static $type$ getAndAddAcquire(VarHandle ob, Object oba, int index, $type$ delta) {</span>
<span class="line-added"> 347             ArrayHandle handle = (ArrayHandle)ob;</span>
 348             byte[] ba = (byte[]) oba;
 349             if (handle.be == BE) {
 350                 return UNSAFE.getAndAdd$RawType$Acquire(
 351                         ba,
 352                         address(ba, index(ba, index)),
 353                         delta);
 354             } else {
 355                 return getAndAddConvEndianWithCAS(ba, index, delta);
 356             }
 357         }
 358 
 359         @ForceInline
<a name="22" id="anc22"></a><span class="line-modified"> 360         static $type$ getAndAddRelease(VarHandle ob, Object oba, int index, $type$ delta) {</span>
<span class="line-added"> 361             ArrayHandle handle = (ArrayHandle)ob;</span>
 362             byte[] ba = (byte[]) oba;
 363             if (handle.be == BE) {
 364                 return UNSAFE.getAndAdd$RawType$Release(
 365                         ba,
 366                         address(ba, index(ba, index)),
 367                         delta);
 368             } else {
 369                 return getAndAddConvEndianWithCAS(ba, index, delta);
 370             }
 371         }
 372 
 373         @ForceInline
 374         static $type$ getAndAddConvEndianWithCAS(byte[] ba, int index, $type$ delta) {
 375             $type$ nativeExpectedValue, expectedValue;
 376             long offset = address(ba, index(ba, index));
 377             do {
 378                 nativeExpectedValue = UNSAFE.get$RawType$Volatile(ba, offset);
 379                 expectedValue = $RawBoxType$.reverseBytes(nativeExpectedValue);
 380             } while (!UNSAFE.weakCompareAndSet$RawType$(ba, offset,
 381                     nativeExpectedValue, $RawBoxType$.reverseBytes(expectedValue + delta)));
 382             return expectedValue;
 383         }
 384 #end[AtomicAdd]
 385 #if[Bitwise]
 386 
 387         @ForceInline
<a name="23" id="anc23"></a><span class="line-modified"> 388         static $type$ getAndBitwiseOr(VarHandle ob, Object oba, int index, $type$ value) {</span>
<span class="line-added"> 389             ArrayHandle handle = (ArrayHandle)ob;</span>
 390             byte[] ba = (byte[]) oba;
 391             if (handle.be == BE) {
 392                 return UNSAFE.getAndBitwiseOr$RawType$(
 393                         ba,
 394                         address(ba, index(ba, index)),
 395                         value);
 396             } else {
 397                 return getAndBitwiseOrConvEndianWithCAS(ba, index, value);
 398             }
 399         }
 400 
 401         @ForceInline
<a name="24" id="anc24"></a><span class="line-modified"> 402         static $type$ getAndBitwiseOrRelease(VarHandle ob, Object oba, int index, $type$ value) {</span>
<span class="line-added"> 403             ArrayHandle handle = (ArrayHandle)ob;</span>
 404             byte[] ba = (byte[]) oba;
 405             if (handle.be == BE) {
 406                 return UNSAFE.getAndBitwiseOr$RawType$Release(
 407                         ba,
 408                         address(ba, index(ba, index)),
 409                         value);
 410             } else {
 411                 return getAndBitwiseOrConvEndianWithCAS(ba, index, value);
 412             }
 413         }
 414 
 415         @ForceInline
<a name="25" id="anc25"></a><span class="line-modified"> 416         static $type$ getAndBitwiseOrAcquire(VarHandle ob, Object oba, int index, $type$ value) {</span>
<span class="line-added"> 417             ArrayHandle handle = (ArrayHandle)ob;</span>
 418             byte[] ba = (byte[]) oba;
 419             if (handle.be == BE) {
 420                 return UNSAFE.getAndBitwiseOr$RawType$Acquire(
 421                         ba,
 422                         address(ba, index(ba, index)),
 423                         value);
 424             } else {
 425                 return getAndBitwiseOrConvEndianWithCAS(ba, index, value);
 426             }
 427         }
 428 
 429         @ForceInline
 430         static $type$ getAndBitwiseOrConvEndianWithCAS(byte[] ba, int index, $type$ value) {
 431             $type$ nativeExpectedValue, expectedValue;
 432             long offset = address(ba, index(ba, index));
 433             do {
 434                 nativeExpectedValue = UNSAFE.get$RawType$Volatile(ba, offset);
 435                 expectedValue = $RawBoxType$.reverseBytes(nativeExpectedValue);
 436             } while (!UNSAFE.weakCompareAndSet$RawType$(ba, offset,
 437                     nativeExpectedValue, $RawBoxType$.reverseBytes(expectedValue | value)));
 438             return expectedValue;
 439         }
 440 
 441         @ForceInline
<a name="26" id="anc26"></a><span class="line-modified"> 442         static $type$ getAndBitwiseAnd(VarHandle ob, Object oba, int index, $type$ value) {</span>
<span class="line-added"> 443             ArrayHandle handle = (ArrayHandle)ob;</span>
 444             byte[] ba = (byte[]) oba;
 445             if (handle.be == BE) {
 446                 return UNSAFE.getAndBitwiseAnd$RawType$(
 447                         ba,
 448                         address(ba, index(ba, index)),
 449                         value);
 450             } else {
 451                 return getAndBitwiseAndConvEndianWithCAS(ba, index, value);
 452             }
 453         }
 454 
 455         @ForceInline
<a name="27" id="anc27"></a><span class="line-modified"> 456         static $type$ getAndBitwiseAndRelease(VarHandle ob, Object oba, int index, $type$ value) {</span>
<span class="line-added"> 457             ArrayHandle handle = (ArrayHandle)ob;</span>
 458             byte[] ba = (byte[]) oba;
 459             if (handle.be == BE) {
 460                 return UNSAFE.getAndBitwiseAnd$RawType$Release(
 461                         ba,
 462                         address(ba, index(ba, index)),
 463                         value);
 464             } else {
 465                 return getAndBitwiseAndConvEndianWithCAS(ba, index, value);
 466             }
 467         }
 468 
 469         @ForceInline
<a name="28" id="anc28"></a><span class="line-modified"> 470         static $type$ getAndBitwiseAndAcquire(VarHandle ob, Object oba, int index, $type$ value) {</span>
<span class="line-added"> 471             ArrayHandle handle = (ArrayHandle)ob;</span>
 472             byte[] ba = (byte[]) oba;
 473             if (handle.be == BE) {
 474                 return UNSAFE.getAndBitwiseAnd$RawType$Acquire(
 475                         ba,
 476                         address(ba, index(ba, index)),
 477                         value);
 478             } else {
 479                 return getAndBitwiseAndConvEndianWithCAS(ba, index, value);
 480             }
 481         }
 482 
 483         @ForceInline
 484         static $type$ getAndBitwiseAndConvEndianWithCAS(byte[] ba, int index, $type$ value) {
 485             $type$ nativeExpectedValue, expectedValue;
 486             long offset = address(ba, index(ba, index));
 487             do {
 488                 nativeExpectedValue = UNSAFE.get$RawType$Volatile(ba, offset);
 489                 expectedValue = $RawBoxType$.reverseBytes(nativeExpectedValue);
 490             } while (!UNSAFE.weakCompareAndSet$RawType$(ba, offset,
 491                     nativeExpectedValue, $RawBoxType$.reverseBytes(expectedValue &amp; value)));
 492             return expectedValue;
 493         }
 494 
 495         @ForceInline
<a name="29" id="anc29"></a><span class="line-modified"> 496         static $type$ getAndBitwiseXor(VarHandle ob, Object oba, int index, $type$ value) {</span>
<span class="line-added"> 497             ArrayHandle handle = (ArrayHandle)ob;</span>
 498             byte[] ba = (byte[]) oba;
 499             if (handle.be == BE) {
 500                 return UNSAFE.getAndBitwiseXor$RawType$(
 501                         ba,
 502                         address(ba, index(ba, index)),
 503                         value);
 504             } else {
 505                 return getAndBitwiseXorConvEndianWithCAS(ba, index, value);
 506             }
 507         }
 508 
 509         @ForceInline
<a name="30" id="anc30"></a><span class="line-modified"> 510         static $type$ getAndBitwiseXorRelease(VarHandle ob, Object oba, int index, $type$ value) {</span>
<span class="line-added"> 511             ArrayHandle handle = (ArrayHandle)ob;</span>
 512             byte[] ba = (byte[]) oba;
 513             if (handle.be == BE) {
 514                 return UNSAFE.getAndBitwiseXor$RawType$Release(
 515                         ba,
 516                         address(ba, index(ba, index)),
 517                         value);
 518             } else {
 519                 return getAndBitwiseXorConvEndianWithCAS(ba, index, value);
 520             }
 521         }
 522 
 523         @ForceInline
<a name="31" id="anc31"></a><span class="line-modified"> 524         static $type$ getAndBitwiseXorAcquire(VarHandle ob, Object oba, int index, $type$ value) {</span>
<span class="line-added"> 525             ArrayHandle handle = (ArrayHandle)ob;</span>
 526             byte[] ba = (byte[]) oba;
 527             if (handle.be == BE) {
 528                 return UNSAFE.getAndBitwiseXor$RawType$Acquire(
 529                         ba,
 530                         address(ba, index(ba, index)),
 531                         value);
 532             } else {
 533                 return getAndBitwiseXorConvEndianWithCAS(ba, index, value);
 534             }
 535         }
 536 
 537         @ForceInline
 538         static $type$ getAndBitwiseXorConvEndianWithCAS(byte[] ba, int index, $type$ value) {
 539             $type$ nativeExpectedValue, expectedValue;
 540             long offset = address(ba, index(ba, index));
 541             do {
 542                 nativeExpectedValue = UNSAFE.get$RawType$Volatile(ba, offset);
 543                 expectedValue = $RawBoxType$.reverseBytes(nativeExpectedValue);
 544             } while (!UNSAFE.weakCompareAndSet$RawType$(ba, offset,
 545                     nativeExpectedValue, $RawBoxType$.reverseBytes(expectedValue ^ value)));
 546             return expectedValue;
 547         }
 548 #end[Bitwise]
 549 
 550         static final VarForm FORM = new VarForm(ArrayHandle.class, byte[].class, $type$.class, int.class);
 551     }
 552 
 553 
 554     static final class ByteBufferHandle extends ByteArrayViewVarHandle {
 555 
 556         ByteBufferHandle(boolean be) {
 557             super(ByteBufferHandle.FORM, be);
 558         }
 559 
 560         @Override
 561         final MethodType accessModeTypeUncached(AccessMode accessMode) {
 562             return accessMode.at.accessModeType(ByteBuffer.class, $type$.class, int.class);
 563         }
 564 
 565         @ForceInline
 566         static int index(ByteBuffer bb, int index) {
 567             nioAccess.checkSegment(bb);
 568             return Preconditions.checkIndex(index, UNSAFE.getInt(bb, BUFFER_LIMIT) - ALIGN, null);
 569         }
 570 
 571         @ForceInline
 572         static int indexRO(ByteBuffer bb, int index) {
 573             if (UNSAFE.getBoolean(bb, BYTE_BUFFER_IS_READ_ONLY))
 574                 throw new ReadOnlyBufferException();
 575             return index(bb, index);
 576         }
 577 
 578         @ForceInline
 579         static long address(ByteBuffer bb, int index) {
 580             long address = ((long) index) + UNSAFE.getLong(bb, BUFFER_ADDRESS);
 581             if ((address &amp; ALIGN) != 0)
 582                 throw newIllegalStateExceptionForMisalignedAccess(index);
 583             return address;
 584         }
 585 
 586         @ForceInline
<a name="32" id="anc32"></a><span class="line-modified"> 587         static $type$ get(VarHandle ob, Object obb, int index) {</span>
<span class="line-added"> 588             ByteBufferHandle handle = (ByteBufferHandle)ob;</span>
 589             ByteBuffer bb = (ByteBuffer) Objects.requireNonNull(obb);
 590 #if[floatingPoint]
 591             $rawType$ rawValue = UNSAFE.get$RawType$Unaligned(
 592                     UNSAFE.getReference(bb, BYTE_BUFFER_HB),
 593                     ((long) index(bb, index)) + UNSAFE.getLong(bb, BUFFER_ADDRESS),
 594                     handle.be);
 595             return $Type$.$rawType$BitsTo$Type$(rawValue);
 596 #else[floatingPoint]
 597             return UNSAFE.get$Type$Unaligned(
 598                     UNSAFE.getReference(bb, BYTE_BUFFER_HB),
 599                     ((long) index(bb, index)) + UNSAFE.getLong(bb, BUFFER_ADDRESS),
 600                     handle.be);
 601 #end[floatingPoint]
 602         }
 603 
 604         @ForceInline
<a name="33" id="anc33"></a><span class="line-modified"> 605         static void set(VarHandle ob, Object obb, int index, $type$ value) {</span>
<span class="line-added"> 606             ByteBufferHandle handle = (ByteBufferHandle)ob;</span>
 607             ByteBuffer bb = (ByteBuffer) Objects.requireNonNull(obb);
 608 #if[floatingPoint]
 609             UNSAFE.put$RawType$Unaligned(
 610                     UNSAFE.getReference(bb, BYTE_BUFFER_HB),
 611                     ((long) indexRO(bb, index)) + UNSAFE.getLong(bb, BUFFER_ADDRESS),
 612                     $Type$.$type$ToRaw$RawType$Bits(value),
 613                     handle.be);
 614 #else[floatingPoint]
 615             UNSAFE.put$Type$Unaligned(
 616                     UNSAFE.getReference(bb, BYTE_BUFFER_HB),
 617                     ((long) indexRO(bb, index)) + UNSAFE.getLong(bb, BUFFER_ADDRESS),
 618                     value,
 619                     handle.be);
 620 #end[floatingPoint]
 621         }
 622 
 623         @ForceInline
<a name="34" id="anc34"></a><span class="line-modified"> 624         static $type$ getVolatile(VarHandle ob, Object obb, int index) {</span>
<span class="line-added"> 625             ByteBufferHandle handle = (ByteBufferHandle)ob;</span>
 626             ByteBuffer bb = (ByteBuffer) Objects.requireNonNull(obb);
 627             return convEndian(handle.be,
 628                               UNSAFE.get$RawType$Volatile(
 629                                       UNSAFE.getReference(bb, BYTE_BUFFER_HB),
 630                                       address(bb, index(bb, index))));
 631         }
 632 
 633         @ForceInline
<a name="35" id="anc35"></a><span class="line-modified"> 634         static void setVolatile(VarHandle ob, Object obb, int index, $type$ value) {</span>
<span class="line-added"> 635             ByteBufferHandle handle = (ByteBufferHandle)ob;</span>
 636             ByteBuffer bb = (ByteBuffer) Objects.requireNonNull(obb);
 637             UNSAFE.put$RawType$Volatile(
 638                     UNSAFE.getReference(bb, BYTE_BUFFER_HB),
 639                     address(bb, indexRO(bb, index)),
 640                     convEndian(handle.be, value));
 641         }
 642 
 643         @ForceInline
<a name="36" id="anc36"></a><span class="line-modified"> 644         static $type$ getAcquire(VarHandle ob, Object obb, int index) {</span>
<span class="line-added"> 645             ByteBufferHandle handle = (ByteBufferHandle)ob;</span>
 646             ByteBuffer bb = (ByteBuffer) Objects.requireNonNull(obb);
 647             return convEndian(handle.be,
 648                               UNSAFE.get$RawType$Acquire(
 649                                       UNSAFE.getReference(bb, BYTE_BUFFER_HB),
 650                                       address(bb, index(bb, index))));
 651         }
 652 
 653         @ForceInline
<a name="37" id="anc37"></a><span class="line-modified"> 654         static void setRelease(VarHandle ob, Object obb, int index, $type$ value) {</span>
<span class="line-added"> 655             ByteBufferHandle handle = (ByteBufferHandle)ob;</span>
 656             ByteBuffer bb = (ByteBuffer) Objects.requireNonNull(obb);
 657             UNSAFE.put$RawType$Release(
 658                     UNSAFE.getReference(bb, BYTE_BUFFER_HB),
 659                     address(bb, indexRO(bb, index)),
 660                     convEndian(handle.be, value));
 661         }
 662 
 663         @ForceInline
<a name="38" id="anc38"></a><span class="line-modified"> 664         static $type$ getOpaque(VarHandle ob, Object obb, int index) {</span>
<span class="line-added"> 665             ByteBufferHandle handle = (ByteBufferHandle)ob;</span>
 666             ByteBuffer bb = (ByteBuffer) Objects.requireNonNull(obb);
 667             return convEndian(handle.be,
 668                               UNSAFE.get$RawType$Opaque(
 669                                       UNSAFE.getReference(bb, BYTE_BUFFER_HB),
 670                                       address(bb, index(bb, index))));
 671         }
 672 
 673         @ForceInline
<a name="39" id="anc39"></a><span class="line-modified"> 674         static void setOpaque(VarHandle ob, Object obb, int index, $type$ value) {</span>
<span class="line-added"> 675             ByteBufferHandle handle = (ByteBufferHandle)ob;</span>
 676             ByteBuffer bb = (ByteBuffer) Objects.requireNonNull(obb);
 677             UNSAFE.put$RawType$Opaque(
 678                     UNSAFE.getReference(bb, BYTE_BUFFER_HB),
 679                     address(bb, indexRO(bb, index)),
 680                     convEndian(handle.be, value));
 681         }
 682 #if[CAS]
 683 
 684         @ForceInline
<a name="40" id="anc40"></a><span class="line-modified"> 685         static boolean compareAndSet(VarHandle ob, Object obb, int index, $type$ expected, $type$ value) {</span>
<span class="line-added"> 686             ByteBufferHandle handle = (ByteBufferHandle)ob;</span>
 687             ByteBuffer bb = (ByteBuffer) Objects.requireNonNull(obb);
 688 #if[Object]
 689             return UNSAFE.compareAndSetReference(
 690                     UNSAFE.getReference(bb, BYTE_BUFFER_HB),
 691                     address(bb, indexRO(bb, index)),
 692                     convEndian(handle.be, expected), convEndian(handle.be, value));
 693 #else[Object]
 694             return UNSAFE.compareAndSet$RawType$(
 695                     UNSAFE.getReference(bb, BYTE_BUFFER_HB),
 696                     address(bb, indexRO(bb, index)),
 697                     convEndian(handle.be, expected), convEndian(handle.be, value));
 698 #end[Object]
 699         }
 700 
 701         @ForceInline
<a name="41" id="anc41"></a><span class="line-modified"> 702         static $type$ compareAndExchange(VarHandle ob, Object obb, int index, $type$ expected, $type$ value) {</span>
<span class="line-added"> 703             ByteBufferHandle handle = (ByteBufferHandle)ob;</span>
 704             ByteBuffer bb = (ByteBuffer) Objects.requireNonNull(obb);
 705             return convEndian(handle.be,
 706                               UNSAFE.compareAndExchange$RawType$(
 707                                       UNSAFE.getReference(bb, BYTE_BUFFER_HB),
 708                                       address(bb, indexRO(bb, index)),
 709                                       convEndian(handle.be, expected), convEndian(handle.be, value)));
 710         }
 711 
 712         @ForceInline
<a name="42" id="anc42"></a><span class="line-modified"> 713         static $type$ compareAndExchangeAcquire(VarHandle ob, Object obb, int index, $type$ expected, $type$ value) {</span>
<span class="line-added"> 714             ByteBufferHandle handle = (ByteBufferHandle)ob;</span>
 715             ByteBuffer bb = (ByteBuffer) Objects.requireNonNull(obb);
 716             return convEndian(handle.be,
 717                               UNSAFE.compareAndExchange$RawType$Acquire(
 718                                       UNSAFE.getReference(bb, BYTE_BUFFER_HB),
 719                                       address(bb, indexRO(bb, index)),
 720                                       convEndian(handle.be, expected), convEndian(handle.be, value)));
 721         }
 722 
 723         @ForceInline
<a name="43" id="anc43"></a><span class="line-modified"> 724         static $type$ compareAndExchangeRelease(VarHandle ob, Object obb, int index, $type$ expected, $type$ value) {</span>
<span class="line-added"> 725             ByteBufferHandle handle = (ByteBufferHandle)ob;</span>
 726             ByteBuffer bb = (ByteBuffer) Objects.requireNonNull(obb);
 727             return convEndian(handle.be,
 728                               UNSAFE.compareAndExchange$RawType$Release(
 729                                       UNSAFE.getReference(bb, BYTE_BUFFER_HB),
 730                                       address(bb, indexRO(bb, index)),
 731                                       convEndian(handle.be, expected), convEndian(handle.be, value)));
 732         }
 733 
 734         @ForceInline
<a name="44" id="anc44"></a><span class="line-modified"> 735         static boolean weakCompareAndSetPlain(VarHandle ob, Object obb, int index, $type$ expected, $type$ value) {</span>
<span class="line-added"> 736             ByteBufferHandle handle = (ByteBufferHandle)ob;</span>
 737             ByteBuffer bb = (ByteBuffer) Objects.requireNonNull(obb);
 738             return UNSAFE.weakCompareAndSet$RawType$Plain(
 739                     UNSAFE.getReference(bb, BYTE_BUFFER_HB),
 740                     address(bb, indexRO(bb, index)),
 741                     convEndian(handle.be, expected), convEndian(handle.be, value));
 742         }
 743 
 744         @ForceInline
<a name="45" id="anc45"></a><span class="line-modified"> 745         static boolean weakCompareAndSet(VarHandle ob, Object obb, int index, $type$ expected, $type$ value) {</span>
<span class="line-added"> 746             ByteBufferHandle handle = (ByteBufferHandle)ob;</span>
 747             ByteBuffer bb = (ByteBuffer) Objects.requireNonNull(obb);
 748             return UNSAFE.weakCompareAndSet$RawType$(
 749                     UNSAFE.getReference(bb, BYTE_BUFFER_HB),
 750                     address(bb, indexRO(bb, index)),
 751                     convEndian(handle.be, expected), convEndian(handle.be, value));
 752         }
 753 
 754         @ForceInline
<a name="46" id="anc46"></a><span class="line-modified"> 755         static boolean weakCompareAndSetAcquire(VarHandle ob, Object obb, int index, $type$ expected, $type$ value) {</span>
<span class="line-added"> 756             ByteBufferHandle handle = (ByteBufferHandle)ob;</span>
 757             ByteBuffer bb = (ByteBuffer) Objects.requireNonNull(obb);
 758             return UNSAFE.weakCompareAndSet$RawType$Acquire(
 759                     UNSAFE.getReference(bb, BYTE_BUFFER_HB),
 760                     address(bb, indexRO(bb, index)),
 761                     convEndian(handle.be, expected), convEndian(handle.be, value));
 762         }
 763 
 764         @ForceInline
<a name="47" id="anc47"></a><span class="line-modified"> 765         static boolean weakCompareAndSetRelease(VarHandle ob, Object obb, int index, $type$ expected, $type$ value) {</span>
<span class="line-added"> 766             ByteBufferHandle handle = (ByteBufferHandle)ob;</span>
 767             ByteBuffer bb = (ByteBuffer) Objects.requireNonNull(obb);
 768             return UNSAFE.weakCompareAndSet$RawType$Release(
 769                     UNSAFE.getReference(bb, BYTE_BUFFER_HB),
 770                     address(bb, indexRO(bb, index)),
 771                     convEndian(handle.be, expected), convEndian(handle.be, value));
 772         }
 773 
 774         @ForceInline
<a name="48" id="anc48"></a><span class="line-modified"> 775         static $type$ getAndSet(VarHandle ob, Object obb, int index, $type$ value) {</span>
<span class="line-added"> 776             ByteBufferHandle handle = (ByteBufferHandle)ob;</span>
 777             ByteBuffer bb = (ByteBuffer) Objects.requireNonNull(obb);
 778 #if[Object]
 779             return convEndian(handle.be,
 780                               UNSAFE.getAndSetReference(
 781                                       UNSAFE.getReference(bb, BYTE_BUFFER_HB),
 782                                       address(bb, indexRO(bb, index)),
 783                                       convEndian(handle.be, value)));
 784 #else[Object]
 785             return convEndian(handle.be,
 786                               UNSAFE.getAndSet$RawType$(
 787                                       UNSAFE.getReference(bb, BYTE_BUFFER_HB),
 788                                       address(bb, indexRO(bb, index)),
 789                                       convEndian(handle.be, value)));
 790 #end[Object]
 791         }
 792 
 793         @ForceInline
<a name="49" id="anc49"></a><span class="line-modified"> 794         static $type$ getAndSetAcquire(VarHandle ob, Object obb, int index, $type$ value) {</span>
<span class="line-added"> 795             ByteBufferHandle handle = (ByteBufferHandle)ob;</span>
 796             ByteBuffer bb = (ByteBuffer) Objects.requireNonNull(obb);
 797             return convEndian(handle.be,
 798                               UNSAFE.getAndSet$RawType$Acquire(
 799                                       UNSAFE.getReference(bb, BYTE_BUFFER_HB),
 800                                       address(bb, indexRO(bb, index)),
 801                                       convEndian(handle.be, value)));
 802         }
 803 
 804         @ForceInline
<a name="50" id="anc50"></a><span class="line-modified"> 805         static $type$ getAndSetRelease(VarHandle ob, Object obb, int index, $type$ value) {</span>
<span class="line-added"> 806             ByteBufferHandle handle = (ByteBufferHandle)ob;</span>
 807             ByteBuffer bb = (ByteBuffer) Objects.requireNonNull(obb);
 808             return convEndian(handle.be,
 809                               UNSAFE.getAndSet$RawType$Release(
 810                                       UNSAFE.getReference(bb, BYTE_BUFFER_HB),
 811                                       address(bb, indexRO(bb, index)),
 812                                       convEndian(handle.be, value)));
 813         }
 814 #end[CAS]
 815 #if[AtomicAdd]
 816 
 817         @ForceInline
<a name="51" id="anc51"></a><span class="line-modified"> 818         static $type$ getAndAdd(VarHandle ob, Object obb, int index, $type$ delta) {</span>
<span class="line-added"> 819             ByteBufferHandle handle = (ByteBufferHandle)ob;</span>
 820             ByteBuffer bb = (ByteBuffer) Objects.requireNonNull(obb);
 821             if (handle.be == BE) {
 822                 return UNSAFE.getAndAdd$RawType$(
 823                         UNSAFE.getReference(bb, BYTE_BUFFER_HB),
 824                         address(bb, indexRO(bb, index)),
 825                         delta);
 826             } else {
 827                 return getAndAddConvEndianWithCAS(bb, index, delta);
 828             }
 829         }
 830 
 831         @ForceInline
<a name="52" id="anc52"></a><span class="line-modified"> 832         static $type$ getAndAddAcquire(VarHandle ob, Object obb, int index, $type$ delta) {</span>
<span class="line-added"> 833             ByteBufferHandle handle = (ByteBufferHandle)ob;</span>
 834             ByteBuffer bb = (ByteBuffer) Objects.requireNonNull(obb);
 835             if (handle.be == BE) {
 836                 return UNSAFE.getAndAdd$RawType$Acquire(
 837                         UNSAFE.getReference(bb, BYTE_BUFFER_HB),
 838                         address(bb, indexRO(bb, index)),
 839                         delta);
 840             } else {
 841                 return getAndAddConvEndianWithCAS(bb, index, delta);
 842             }
 843         }
 844 
 845         @ForceInline
<a name="53" id="anc53"></a><span class="line-modified"> 846         static $type$ getAndAddRelease(VarHandle ob, Object obb, int index, $type$ delta) {</span>
<span class="line-added"> 847             ByteBufferHandle handle = (ByteBufferHandle)ob;</span>
 848             ByteBuffer bb = (ByteBuffer) Objects.requireNonNull(obb);
 849             if (handle.be == BE) {
 850                 return UNSAFE.getAndAdd$RawType$Release(
 851                         UNSAFE.getReference(bb, BYTE_BUFFER_HB),
 852                         address(bb, indexRO(bb, index)),
 853                         delta);
 854             } else {
 855                 return getAndAddConvEndianWithCAS(bb, index, delta);
 856             }
 857         }
 858 
 859         @ForceInline
 860         static $type$ getAndAddConvEndianWithCAS(ByteBuffer bb, int index, $type$ delta) {
 861             $type$ nativeExpectedValue, expectedValue;
 862             Object base = UNSAFE.getReference(bb, BYTE_BUFFER_HB);
 863             long offset = address(bb, indexRO(bb, index));
 864             do {
 865                 nativeExpectedValue = UNSAFE.get$RawType$Volatile(base, offset);
 866                 expectedValue = $RawBoxType$.reverseBytes(nativeExpectedValue);
 867             } while (!UNSAFE.weakCompareAndSet$RawType$(base, offset,
 868                     nativeExpectedValue, $RawBoxType$.reverseBytes(expectedValue + delta)));
 869             return expectedValue;
 870         }
 871 #end[AtomicAdd]
 872 #if[Bitwise]
 873 
 874         @ForceInline
<a name="54" id="anc54"></a><span class="line-modified"> 875         static $type$ getAndBitwiseOr(VarHandle ob, Object obb, int index, $type$ value) {</span>
<span class="line-added"> 876             ByteBufferHandle handle = (ByteBufferHandle)ob;</span>
 877             ByteBuffer bb = (ByteBuffer) Objects.requireNonNull(obb);
 878             if (handle.be == BE) {
 879                 return UNSAFE.getAndBitwiseOr$RawType$(
 880                         UNSAFE.getReference(bb, BYTE_BUFFER_HB),
 881                         address(bb, indexRO(bb, index)),
 882                         value);
 883             } else {
 884                 return getAndBitwiseOrConvEndianWithCAS(bb, index, value);
 885             }
 886         }
 887 
 888         @ForceInline
<a name="55" id="anc55"></a><span class="line-modified"> 889         static $type$ getAndBitwiseOrRelease(VarHandle ob, Object obb, int index, $type$ value) {</span>
<span class="line-added"> 890             ByteBufferHandle handle = (ByteBufferHandle)ob;</span>
 891             ByteBuffer bb = (ByteBuffer) Objects.requireNonNull(obb);
 892             if (handle.be == BE) {
 893                 return UNSAFE.getAndBitwiseOr$RawType$Release(
 894                         UNSAFE.getReference(bb, BYTE_BUFFER_HB),
 895                         address(bb, indexRO(bb, index)),
 896                         value);
 897             } else {
 898                 return getAndBitwiseOrConvEndianWithCAS(bb, index, value);
 899             }
 900         }
 901 
 902         @ForceInline
<a name="56" id="anc56"></a><span class="line-modified"> 903         static $type$ getAndBitwiseOrAcquire(VarHandle ob, Object obb, int index, $type$ value) {</span>
<span class="line-added"> 904             ByteBufferHandle handle = (ByteBufferHandle)ob;</span>
 905             ByteBuffer bb = (ByteBuffer) Objects.requireNonNull(obb);
 906             if (handle.be == BE) {
 907                 return UNSAFE.getAndBitwiseOr$RawType$Acquire(
 908                         UNSAFE.getReference(bb, BYTE_BUFFER_HB),
 909                         address(bb, indexRO(bb, index)),
 910                         value);
 911             } else {
 912                 return getAndBitwiseOrConvEndianWithCAS(bb, index, value);
 913             }
 914         }
 915 
 916         @ForceInline
 917         static $type$ getAndBitwiseOrConvEndianWithCAS(ByteBuffer bb, int index, $type$ value) {
 918             $type$ nativeExpectedValue, expectedValue;
 919             Object base = UNSAFE.getReference(bb, BYTE_BUFFER_HB);
 920             long offset = address(bb, indexRO(bb, index));
 921             do {
 922                 nativeExpectedValue = UNSAFE.get$RawType$Volatile(base, offset);
 923                 expectedValue = $RawBoxType$.reverseBytes(nativeExpectedValue);
 924             } while (!UNSAFE.weakCompareAndSet$RawType$(base, offset,
 925                     nativeExpectedValue, $RawBoxType$.reverseBytes(expectedValue | value)));
 926             return expectedValue;
 927         }
 928 
 929         @ForceInline
<a name="57" id="anc57"></a><span class="line-modified"> 930         static $type$ getAndBitwiseAnd(VarHandle ob, Object obb, int index, $type$ value) {</span>
<span class="line-added"> 931             ByteBufferHandle handle = (ByteBufferHandle)ob;</span>
 932             ByteBuffer bb = (ByteBuffer) Objects.requireNonNull(obb);
 933             if (handle.be == BE) {
 934                 return UNSAFE.getAndBitwiseAnd$RawType$(
 935                         UNSAFE.getReference(bb, BYTE_BUFFER_HB),
 936                         address(bb, indexRO(bb, index)),
 937                         value);
 938             } else {
 939                 return getAndBitwiseAndConvEndianWithCAS(bb, index, value);
 940             }
 941         }
 942 
 943         @ForceInline
<a name="58" id="anc58"></a><span class="line-modified"> 944         static $type$ getAndBitwiseAndRelease(VarHandle ob, Object obb, int index, $type$ value) {</span>
<span class="line-added"> 945             ByteBufferHandle handle = (ByteBufferHandle)ob;</span>
 946             ByteBuffer bb = (ByteBuffer) Objects.requireNonNull(obb);
 947             if (handle.be == BE) {
 948                 return UNSAFE.getAndBitwiseAnd$RawType$Release(
 949                         UNSAFE.getReference(bb, BYTE_BUFFER_HB),
 950                         address(bb, indexRO(bb, index)),
 951                         value);
 952             } else {
 953                 return getAndBitwiseAndConvEndianWithCAS(bb, index, value);
 954             }
 955         }
 956 
 957         @ForceInline
<a name="59" id="anc59"></a><span class="line-modified"> 958         static $type$ getAndBitwiseAndAcquire(VarHandle ob, Object obb, int index, $type$ value) {</span>
<span class="line-added"> 959             ByteBufferHandle handle = (ByteBufferHandle)ob;</span>
 960             ByteBuffer bb = (ByteBuffer) Objects.requireNonNull(obb);
 961             if (handle.be == BE) {
 962                 return UNSAFE.getAndBitwiseAnd$RawType$Acquire(
 963                         UNSAFE.getReference(bb, BYTE_BUFFER_HB),
 964                         address(bb, indexRO(bb, index)),
 965                         value);
 966             } else {
 967                 return getAndBitwiseAndConvEndianWithCAS(bb, index, value);
 968             }
 969         }
 970 
 971         @ForceInline
 972         static $type$ getAndBitwiseAndConvEndianWithCAS(ByteBuffer bb, int index, $type$ value) {
 973             $type$ nativeExpectedValue, expectedValue;
 974             Object base = UNSAFE.getReference(bb, BYTE_BUFFER_HB);
 975             long offset = address(bb, indexRO(bb, index));
 976             do {
 977                 nativeExpectedValue = UNSAFE.get$RawType$Volatile(base, offset);
 978                 expectedValue = $RawBoxType$.reverseBytes(nativeExpectedValue);
 979             } while (!UNSAFE.weakCompareAndSet$RawType$(base, offset,
 980                     nativeExpectedValue, $RawBoxType$.reverseBytes(expectedValue &amp; value)));
 981             return expectedValue;
 982         }
 983 
 984 
 985         @ForceInline
<a name="60" id="anc60"></a><span class="line-modified"> 986         static $type$ getAndBitwiseXor(VarHandle ob, Object obb, int index, $type$ value) {</span>
<span class="line-added"> 987             ByteBufferHandle handle = (ByteBufferHandle)ob;</span>
 988             ByteBuffer bb = (ByteBuffer) Objects.requireNonNull(obb);
 989             if (handle.be == BE) {
 990                 return UNSAFE.getAndBitwiseXor$RawType$(
 991                         UNSAFE.getReference(bb, BYTE_BUFFER_HB),
 992                         address(bb, indexRO(bb, index)),
 993                         value);
 994             } else {
 995                 return getAndBitwiseXorConvEndianWithCAS(bb, index, value);
 996             }
 997         }
 998 
 999         @ForceInline
<a name="61" id="anc61"></a><span class="line-modified">1000         static $type$ getAndBitwiseXorRelease(VarHandle ob, Object obb, int index, $type$ value) {</span>
<span class="line-added">1001             ByteBufferHandle handle = (ByteBufferHandle)ob;</span>
1002             ByteBuffer bb = (ByteBuffer) Objects.requireNonNull(obb);
1003             if (handle.be == BE) {
1004                 return UNSAFE.getAndBitwiseXor$RawType$Release(
1005                         UNSAFE.getReference(bb, BYTE_BUFFER_HB),
1006                         address(bb, indexRO(bb, index)),
1007                         value);
1008             } else {
1009                 return getAndBitwiseXorConvEndianWithCAS(bb, index, value);
1010             }
1011         }
1012 
1013         @ForceInline
<a name="62" id="anc62"></a><span class="line-modified">1014         static $type$ getAndBitwiseXorAcquire(VarHandle ob, Object obb, int index, $type$ value) {</span>
<span class="line-added">1015             ByteBufferHandle handle = (ByteBufferHandle)ob;</span>
1016             ByteBuffer bb = (ByteBuffer) Objects.requireNonNull(obb);
1017             if (handle.be == BE) {
1018                 return UNSAFE.getAndBitwiseXor$RawType$Acquire(
1019                         UNSAFE.getReference(bb, BYTE_BUFFER_HB),
1020                         address(bb, indexRO(bb, index)),
1021                         value);
1022             } else {
1023                 return getAndBitwiseXorConvEndianWithCAS(bb, index, value);
1024             }
1025         }
1026 
1027         @ForceInline
1028         static $type$ getAndBitwiseXorConvEndianWithCAS(ByteBuffer bb, int index, $type$ value) {
1029             $type$ nativeExpectedValue, expectedValue;
1030             Object base = UNSAFE.getReference(bb, BYTE_BUFFER_HB);
1031             long offset = address(bb, indexRO(bb, index));
1032             do {
1033                 nativeExpectedValue = UNSAFE.get$RawType$Volatile(base, offset);
1034                 expectedValue = $RawBoxType$.reverseBytes(nativeExpectedValue);
1035             } while (!UNSAFE.weakCompareAndSet$RawType$(base, offset,
1036                     nativeExpectedValue, $RawBoxType$.reverseBytes(expectedValue ^ value)));
1037             return expectedValue;
1038         }
1039 #end[Bitwise]
1040 
1041         static final VarForm FORM = new VarForm(ByteBufferHandle.class, ByteBuffer.class, $type$.class, int.class);
1042     }
1043 }
<a name="63" id="anc63"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="63" type="hidden" />
</body>
</html>