<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff test/jdk/java/foreign/callarranger/TestSysVCallArranger.java</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="TestAarch64CallArranger.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="TestWindowsCallArranger.java.cdiff.html" target="_top">next &gt;</a></center>    <h2>test/jdk/java/foreign/callarranger/TestSysVCallArranger.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 45,10 ***</span>
<span class="line-new-header">--- 45,11 ---</span>
  
  import java.lang.invoke.MethodType;
  
  import static jdk.incubator.foreign.MemoryLayouts.SysV.*;
  import static jdk.incubator.foreign.MemoryLayouts.WinABI.C_POINTER;
<span class="line-added">+ import static jdk.internal.foreign.abi.Binding.*;</span>
  import static jdk.internal.foreign.abi.x64.X86_64Architecture.*;
  import static org.testng.Assert.assertEquals;
  import static org.testng.Assert.assertFalse;
  import static org.testng.Assert.assertTrue;
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 64,11 ***</span>
          CallingSequence callingSequence = bindings.callingSequence;
          assertEquals(callingSequence.methodType(), mt.appendParameterTypes(long.class));
          assertEquals(callingSequence.functionDesc(), descAddArgument(fd, C_LONG));
  
          checkArgumentBindings(callingSequence, new Binding[][]{
<span class="line-modified">!             { new Binding.Move(rax, long.class) }</span>
          });
  
          checkReturnBindings(callingSequence, new Binding[]{});
  
          assertEquals(bindings.nVectorArgs, 0);
<span class="line-new-header">--- 65,11 ---</span>
          CallingSequence callingSequence = bindings.callingSequence;
          assertEquals(callingSequence.methodType(), mt.appendParameterTypes(long.class));
          assertEquals(callingSequence.functionDesc(), descAddArgument(fd, C_LONG));
  
          checkArgumentBindings(callingSequence, new Binding[][]{
<span class="line-modified">!             { move(rax, long.class) }</span>
          });
  
          checkReturnBindings(callingSequence, new Binding[]{});
  
          assertEquals(bindings.nVectorArgs, 0);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 86,17 ***</span>
          CallingSequence callingSequence = bindings.callingSequence;
          assertEquals(callingSequence.methodType(), mt.appendParameterTypes(long.class));
          assertEquals(callingSequence.functionDesc(), descAddArgument(fd, C_LONG));
  
          checkArgumentBindings(callingSequence, new Binding[][]{
<span class="line-modified">!             { new Binding.Move(rdi, int.class) },</span>
<span class="line-modified">!             { new Binding.Move(rsi, int.class) },</span>
<span class="line-modified">!             { new Binding.Move(rdx, int.class) },</span>
<span class="line-modified">!             { new Binding.Move(rcx, int.class) },</span>
<span class="line-modified">!             { new Binding.Move(r8, int.class) },</span>
<span class="line-modified">!             { new Binding.Move(r9, int.class) },</span>
<span class="line-modified">!             { new Binding.Move(rax, long.class) },</span>
          });
  
          checkReturnBindings(callingSequence, new Binding[]{});
  
          assertEquals(bindings.nVectorArgs, 0);
<span class="line-new-header">--- 87,17 ---</span>
          CallingSequence callingSequence = bindings.callingSequence;
          assertEquals(callingSequence.methodType(), mt.appendParameterTypes(long.class));
          assertEquals(callingSequence.functionDesc(), descAddArgument(fd, C_LONG));
  
          checkArgumentBindings(callingSequence, new Binding[][]{
<span class="line-modified">!             { move(rdi, int.class) },</span>
<span class="line-modified">!             { move(rsi, int.class) },</span>
<span class="line-modified">!             { move(rdx, int.class) },</span>
<span class="line-modified">!             { move(rcx, int.class) },</span>
<span class="line-modified">!             { move(r8, int.class) },</span>
<span class="line-modified">!             { move(r9, int.class) },</span>
<span class="line-modified">!             { move(rax, long.class) },</span>
          });
  
          checkReturnBindings(callingSequence, new Binding[]{});
  
          assertEquals(bindings.nVectorArgs, 0);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 116,19 ***</span>
          CallingSequence callingSequence = bindings.callingSequence;
          assertEquals(callingSequence.methodType(), mt.appendParameterTypes(long.class));
          assertEquals(callingSequence.functionDesc(), descAddArgument(fd, C_LONG));
  
          checkArgumentBindings(callingSequence, new Binding[][]{
<span class="line-modified">!             { new Binding.Move(xmm0, double.class) },</span>
<span class="line-modified">!             { new Binding.Move(xmm1, double.class) },</span>
<span class="line-modified">!             { new Binding.Move(xmm2, double.class) },</span>
<span class="line-modified">!             { new Binding.Move(xmm3, double.class) },</span>
<span class="line-modified">!             { new Binding.Move(xmm4, double.class) },</span>
<span class="line-modified">!             { new Binding.Move(xmm5, double.class) },</span>
<span class="line-modified">!             { new Binding.Move(xmm6, double.class) },</span>
<span class="line-modified">!             { new Binding.Move(xmm7, double.class) },</span>
<span class="line-modified">!             { new Binding.Move(rax, long.class) },</span>
          });
  
          checkReturnBindings(callingSequence, new Binding[]{});
  
          assertEquals(bindings.nVectorArgs, 8);
<span class="line-new-header">--- 117,19 ---</span>
          CallingSequence callingSequence = bindings.callingSequence;
          assertEquals(callingSequence.methodType(), mt.appendParameterTypes(long.class));
          assertEquals(callingSequence.functionDesc(), descAddArgument(fd, C_LONG));
  
          checkArgumentBindings(callingSequence, new Binding[][]{
<span class="line-modified">!             { move(xmm0, double.class) },</span>
<span class="line-modified">!             { move(xmm1, double.class) },</span>
<span class="line-modified">!             { move(xmm2, double.class) },</span>
<span class="line-modified">!             { move(xmm3, double.class) },</span>
<span class="line-modified">!             { move(xmm4, double.class) },</span>
<span class="line-modified">!             { move(xmm5, double.class) },</span>
<span class="line-modified">!             { move(xmm6, double.class) },</span>
<span class="line-modified">!             { move(xmm7, double.class) },</span>
<span class="line-modified">!             { move(rax, long.class) },</span>
          });
  
          checkReturnBindings(callingSequence, new Binding[]{});
  
          assertEquals(bindings.nVectorArgs, 8);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 150,29 ***</span>
          CallingSequence callingSequence = bindings.callingSequence;
          assertEquals(callingSequence.methodType(), mt.appendParameterTypes(long.class));
          assertEquals(callingSequence.functionDesc(), descAddArgument(fd, C_LONG));
  
          checkArgumentBindings(callingSequence, new Binding[][]{
<span class="line-modified">!             { new Binding.Move(rdi, long.class) },</span>
<span class="line-modified">!             { new Binding.Move(rsi, long.class) },</span>
<span class="line-modified">!             { new Binding.Move(rdx, long.class) },</span>
<span class="line-modified">!             { new Binding.Move(rcx, long.class) },</span>
<span class="line-modified">!             { new Binding.Move(r8, long.class) },</span>
<span class="line-modified">!             { new Binding.Move(r9, long.class) },</span>
<span class="line-modified">!             { new Binding.Move(stackStorage(0), long.class) },</span>
<span class="line-modified">!             { new Binding.Move(stackStorage(1), long.class) },</span>
<span class="line-modified">!             { new Binding.Move(xmm0, float.class) },</span>
<span class="line-modified">!             { new Binding.Move(xmm1, float.class) },</span>
<span class="line-modified">!             { new Binding.Move(xmm2, float.class) },</span>
<span class="line-modified">!             { new Binding.Move(xmm3, float.class) },</span>
<span class="line-modified">!             { new Binding.Move(xmm4, float.class) },</span>
<span class="line-modified">!             { new Binding.Move(xmm5, float.class) },</span>
<span class="line-modified">!             { new Binding.Move(xmm6, float.class) },</span>
<span class="line-modified">!             { new Binding.Move(xmm7, float.class) },</span>
<span class="line-modified">!             { new Binding.Move(stackStorage(2), float.class) },</span>
<span class="line-modified">!             { new Binding.Move(stackStorage(3), float.class) },</span>
<span class="line-modified">!             { new Binding.Move(rax, long.class) },</span>
          });
  
          checkReturnBindings(callingSequence, new Binding[]{});
  
          assertEquals(bindings.nVectorArgs, 8);
<span class="line-new-header">--- 151,29 ---</span>
          CallingSequence callingSequence = bindings.callingSequence;
          assertEquals(callingSequence.methodType(), mt.appendParameterTypes(long.class));
          assertEquals(callingSequence.functionDesc(), descAddArgument(fd, C_LONG));
  
          checkArgumentBindings(callingSequence, new Binding[][]{
<span class="line-modified">!             { move(rdi, long.class) },</span>
<span class="line-modified">!             { move(rsi, long.class) },</span>
<span class="line-modified">!             { move(rdx, long.class) },</span>
<span class="line-modified">!             { move(rcx, long.class) },</span>
<span class="line-modified">!             { move(r8, long.class) },</span>
<span class="line-modified">!             { move(r9, long.class) },</span>
<span class="line-modified">!             { move(stackStorage(0), long.class) },</span>
<span class="line-modified">!             { move(stackStorage(1), long.class) },</span>
<span class="line-modified">!             { move(xmm0, float.class) },</span>
<span class="line-modified">!             { move(xmm1, float.class) },</span>
<span class="line-modified">!             { move(xmm2, float.class) },</span>
<span class="line-modified">!             { move(xmm3, float.class) },</span>
<span class="line-modified">!             { move(xmm4, float.class) },</span>
<span class="line-modified">!             { move(xmm5, float.class) },</span>
<span class="line-modified">!             { move(xmm6, float.class) },</span>
<span class="line-modified">!             { move(xmm7, float.class) },</span>
<span class="line-modified">!             { move(stackStorage(2), float.class) },</span>
<span class="line-modified">!             { move(stackStorage(3), float.class) },</span>
<span class="line-modified">!             { move(rax, long.class) },</span>
          });
  
          checkReturnBindings(callingSequence, new Binding[]{});
  
          assertEquals(bindings.nVectorArgs, 8);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 206,24 ***</span>
          CallingSequence callingSequence = bindings.callingSequence;
          assertEquals(callingSequence.methodType(), mt.appendParameterTypes(long.class));
          assertEquals(callingSequence.functionDesc(), descAddArgument(fd, C_LONG));
  
          checkArgumentBindings(callingSequence, new Binding[][]{
<span class="line-modified">!             { new Binding.Move(rdi, int.class) },</span>
<span class="line-modified">!             { new Binding.Move(rsi, int.class) },</span>
<span class="line-modified">!             { new Binding.Dup(),</span>
<span class="line-modified">!                 new Binding.Dereference(0, long.class), new Binding.Move(rdx, long.class),</span>
<span class="line-modified">!                 new Binding.Dereference(8, long.class), new Binding.Move(xmm0, long.class)</span>
              },
<span class="line-modified">!             { new Binding.Move(rcx, int.class) },</span>
<span class="line-modified">!             { new Binding.Move(r8, int.class) },</span>
<span class="line-modified">!             { new Binding.Move(xmm1, double.class) },</span>
<span class="line-modified">!             { new Binding.Move(xmm2, double.class) },</span>
<span class="line-modified">!             { new Binding.Move(r9, int.class) },</span>
<span class="line-modified">!             { new Binding.Move(stackStorage(0), int.class) },</span>
<span class="line-modified">!             { new Binding.Move(stackStorage(1), int.class) },</span>
<span class="line-modified">!             { new Binding.Move(rax, long.class) },</span>
          });
  
          checkReturnBindings(callingSequence, new Binding[]{});
  
          assertEquals(bindings.nVectorArgs, 3);
<span class="line-new-header">--- 207,25 ---</span>
          CallingSequence callingSequence = bindings.callingSequence;
          assertEquals(callingSequence.methodType(), mt.appendParameterTypes(long.class));
          assertEquals(callingSequence.functionDesc(), descAddArgument(fd, C_LONG));
  
          checkArgumentBindings(callingSequence, new Binding[][]{
<span class="line-modified">!             { move(rdi, int.class) },</span>
<span class="line-modified">!             { move(rsi, int.class) },</span>
<span class="line-modified">!             {</span>
<span class="line-modified">!                 dup(),</span>
<span class="line-modified">!                 dereference(0, long.class), move(rdx, long.class),</span>
<span class="line-added">+                 dereference(8, long.class), move(xmm0, long.class)</span>
              },
<span class="line-modified">!             { move(rcx, int.class) },</span>
<span class="line-modified">!             { move(r8, int.class) },</span>
<span class="line-modified">!             { move(xmm1, double.class) },</span>
<span class="line-modified">!             { move(xmm2, double.class) },</span>
<span class="line-modified">!             { move(r9, int.class) },</span>
<span class="line-modified">!             { move(stackStorage(0), int.class) },</span>
<span class="line-modified">!             { move(stackStorage(1), int.class) },</span>
<span class="line-modified">!             { move(rax, long.class) },</span>
          });
  
          checkReturnBindings(callingSequence, new Binding[]{});
  
          assertEquals(bindings.nVectorArgs, 3);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 247,12 ***</span>
          CallingSequence callingSequence = bindings.callingSequence;
          assertEquals(callingSequence.methodType(), mt.appendParameterTypes(long.class));
          assertEquals(callingSequence.functionDesc(), descAddArgument(fd, C_LONG));
  
          checkArgumentBindings(callingSequence, new Binding[][]{
<span class="line-modified">!             { new Binding.BoxAddress(), new Binding.Move(rdi, long.class) },</span>
<span class="line-modified">!             { new Binding.Move(rax, long.class) },</span>
          });
  
          checkReturnBindings(callingSequence, new Binding[]{});
  
          assertEquals(bindings.nVectorArgs, 0);
<span class="line-new-header">--- 249,12 ---</span>
          CallingSequence callingSequence = bindings.callingSequence;
          assertEquals(callingSequence.methodType(), mt.appendParameterTypes(long.class));
          assertEquals(callingSequence.functionDesc(), descAddArgument(fd, C_LONG));
  
          checkArgumentBindings(callingSequence, new Binding[][]{
<span class="line-modified">!             { convertAddress(), move(rdi, long.class) },</span>
<span class="line-modified">!             { move(rax, long.class) },</span>
          });
  
          checkReturnBindings(callingSequence, new Binding[]{});
  
          assertEquals(bindings.nVectorArgs, 0);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 269,11 ***</span>
          assertEquals(callingSequence.methodType(), mt.appendParameterTypes(long.class));
          assertEquals(callingSequence.functionDesc(), descAddArgument(fd, C_LONG));
  
          checkArgumentBindings(callingSequence, new Binding[][]{
              expectedBindings,
<span class="line-modified">!             { new Binding.Move(rax, long.class) },</span>
          });
  
          checkReturnBindings(callingSequence, new Binding[]{});
  
          assertEquals(bindings.nVectorArgs, 0);
<span class="line-new-header">--- 271,11 ---</span>
          assertEquals(callingSequence.methodType(), mt.appendParameterTypes(long.class));
          assertEquals(callingSequence.functionDesc(), descAddArgument(fd, C_LONG));
  
          checkArgumentBindings(callingSequence, new Binding[][]{
              expectedBindings,
<span class="line-modified">!             { move(rax, long.class) },</span>
          });
  
          checkReturnBindings(callingSequence, new Binding[]{});
  
          assertEquals(bindings.nVectorArgs, 0);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 282,35 ***</span>
  
      @DataProvider
      public static Object[][] structs() {
          return new Object[][]{
              { MemoryLayout.ofStruct(C_ULONG), new Binding[]{
<span class="line-modified">!                     new Binding.Dereference(0, long.class), new Binding.Move(rdi, long.class)</span>
                  }
              },
              { MemoryLayout.ofStruct(C_ULONG, C_ULONG), new Binding[]{
<span class="line-modified">!                     new Binding.Dup(),</span>
<span class="line-modified">!                     new Binding.Dereference(0, long.class), new Binding.Move(rdi, long.class),</span>
<span class="line-modified">!                     new Binding.Dereference(8, long.class), new Binding.Move(rsi, long.class)</span>
                  }
              },
              { MemoryLayout.ofStruct(C_ULONG, C_ULONG, C_ULONG), new Binding[]{
<span class="line-modified">!                     new Binding.Dup(),</span>
<span class="line-modified">!                     new Binding.Dereference(0, long.class), new Binding.Move(stackStorage(0), long.class),</span>
<span class="line-modified">!                     new Binding.Dup(),</span>
<span class="line-modified">!                     new Binding.Dereference(8, long.class), new Binding.Move(stackStorage(1), long.class),</span>
<span class="line-modified">!                     new Binding.Dereference(16, long.class), new Binding.Move(stackStorage(2), long.class)</span>
                  }
              },
              { MemoryLayout.ofStruct(C_ULONG, C_ULONG, C_ULONG, C_ULONG), new Binding[]{
<span class="line-modified">!                     new Binding.Dup(),</span>
<span class="line-modified">!                     new Binding.Dereference(0, long.class), new Binding.Move(stackStorage(0), long.class),</span>
<span class="line-modified">!                     new Binding.Dup(),</span>
<span class="line-modified">!                     new Binding.Dereference(8, long.class), new Binding.Move(stackStorage(1), long.class),</span>
<span class="line-modified">!                     new Binding.Dup(),</span>
<span class="line-modified">!                     new Binding.Dereference(16, long.class), new Binding.Move(stackStorage(2), long.class),</span>
<span class="line-modified">!                     new Binding.Dereference(24, long.class), new Binding.Move(stackStorage(3), long.class)</span>
                  }
              },
          };
      }
  
<span class="line-new-header">--- 284,35 ---</span>
  
      @DataProvider
      public static Object[][] structs() {
          return new Object[][]{
              { MemoryLayout.ofStruct(C_ULONG), new Binding[]{
<span class="line-modified">!                     dereference(0, long.class), move(rdi, long.class)</span>
                  }
              },
              { MemoryLayout.ofStruct(C_ULONG, C_ULONG), new Binding[]{
<span class="line-modified">!                     dup(),</span>
<span class="line-modified">!                     dereference(0, long.class), move(rdi, long.class),</span>
<span class="line-modified">!                     dereference(8, long.class), move(rsi, long.class)</span>
                  }
              },
              { MemoryLayout.ofStruct(C_ULONG, C_ULONG, C_ULONG), new Binding[]{
<span class="line-modified">!                     dup(),</span>
<span class="line-modified">!                     dereference(0, long.class), move(stackStorage(0), long.class),</span>
<span class="line-modified">!                     dup(),</span>
<span class="line-modified">!                     dereference(8, long.class), move(stackStorage(1), long.class),</span>
<span class="line-modified">!                     dereference(16, long.class), move(stackStorage(2), long.class)</span>
                  }
              },
              { MemoryLayout.ofStruct(C_ULONG, C_ULONG, C_ULONG, C_ULONG), new Binding[]{
<span class="line-modified">!                     dup(),</span>
<span class="line-modified">!                     dereference(0, long.class), move(stackStorage(0), long.class),</span>
<span class="line-modified">!                     dup(),</span>
<span class="line-modified">!                     dereference(8, long.class), move(stackStorage(1), long.class),</span>
<span class="line-modified">!                     dup(),</span>
<span class="line-modified">!                     dereference(16, long.class), move(stackStorage(2), long.class),</span>
<span class="line-modified">!                     dereference(24, long.class), move(stackStorage(3), long.class)</span>
                  }
              },
          };
      }
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 326,21 ***</span>
          CallingSequence callingSequence = bindings.callingSequence;
          assertEquals(callingSequence.methodType(), mt.appendParameterTypes(long.class));
          assertEquals(callingSequence.functionDesc(), descAddArgument(fd, C_LONG));
  
          checkArgumentBindings(callingSequence, new Binding[][]{
<span class="line-modified">!             { new Binding.Move(rax, long.class) }</span>
          });
  
          checkReturnBindings(callingSequence, new Binding[] {
<span class="line-modified">!             new Binding.AllocateBuffer(struct),</span>
<span class="line-modified">!             new Binding.Dup(),</span>
<span class="line-modified">!             new Binding.Move(rax, long.class),</span>
<span class="line-modified">!             new Binding.Dereference(0, long.class),</span>
<span class="line-modified">!             new Binding.Dup(),</span>
<span class="line-modified">!             new Binding.Move(rdx, long.class),</span>
<span class="line-modified">!             new Binding.Dereference(8, long.class)</span>
          });
  
          assertEquals(bindings.nVectorArgs, 0);
      }
  
<span class="line-new-header">--- 328,21 ---</span>
          CallingSequence callingSequence = bindings.callingSequence;
          assertEquals(callingSequence.methodType(), mt.appendParameterTypes(long.class));
          assertEquals(callingSequence.functionDesc(), descAddArgument(fd, C_LONG));
  
          checkArgumentBindings(callingSequence, new Binding[][]{
<span class="line-modified">!             { move(rax, long.class) }</span>
          });
  
          checkReturnBindings(callingSequence, new Binding[] {
<span class="line-modified">!             allocate(struct),</span>
<span class="line-modified">!             dup(),</span>
<span class="line-modified">!             move(rax, long.class),</span>
<span class="line-modified">!             dereference(0, long.class),</span>
<span class="line-modified">!             dup(),</span>
<span class="line-modified">!             move(rdx, long.class),</span>
<span class="line-modified">!             dereference(8, long.class)</span>
          });
  
          assertEquals(bindings.nVectorArgs, 0);
      }
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 356,12 ***</span>
          CallingSequence callingSequence = bindings.callingSequence;
          assertEquals(callingSequence.methodType(), MethodType.methodType(void.class, MemoryAddress.class, long.class));
          assertEquals(callingSequence.functionDesc(), FunctionDescriptor.ofVoid(false, C_POINTER, C_LONG));
  
          checkArgumentBindings(callingSequence, new Binding[][]{
<span class="line-modified">!             { new Binding.BoxAddress(), new Binding.Move(rdi, long.class) },</span>
<span class="line-modified">!             { new Binding.Move(rax, long.class) }</span>
          });
  
          checkReturnBindings(callingSequence, new Binding[] {});
  
          assertEquals(bindings.nVectorArgs, 0);
<span class="line-new-header">--- 358,12 ---</span>
          CallingSequence callingSequence = bindings.callingSequence;
          assertEquals(callingSequence.methodType(), MethodType.methodType(void.class, MemoryAddress.class, long.class));
          assertEquals(callingSequence.functionDesc(), FunctionDescriptor.ofVoid(false, C_POINTER, C_LONG));
  
          checkArgumentBindings(callingSequence, new Binding[][]{
<span class="line-modified">!             { convertAddress(), move(rdi, long.class) },</span>
<span class="line-modified">!             { move(rax, long.class) }</span>
          });
  
          checkReturnBindings(callingSequence, new Binding[] {});
  
          assertEquals(bindings.nVectorArgs, 0);
</pre>
<center><a href="TestAarch64CallArranger.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> <a href="TestWindowsCallArranger.java.cdiff.html" target="_top">next &gt;</a></center>  </body>
</html>