<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cdiff test/jdk/java/foreign/callarranger/TestWindowsCallArranger.java</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
<body>
<center><a href="TestSysVCallArranger.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> next &gt;</center>    <h2>test/jdk/java/foreign/callarranger/TestWindowsCallArranger.java</h2>
     <a class="print" href="javascript:print()">Print this page</a>
<hr />
<pre>
<span class="line-old-header">*** 44,10 ***</span>
<span class="line-new-header">--- 44,12 ---</span>
  
  import java.lang.invoke.MethodType;
  
  import static jdk.incubator.foreign.MemoryLayouts.WinABI.*;
  import static jdk.incubator.foreign.MemoryLayouts.WinABI.asVarArg;
<span class="line-added">+ import static jdk.internal.foreign.abi.Binding.*;</span>
<span class="line-added">+ import static jdk.internal.foreign.abi.Binding.copy;</span>
  import static jdk.internal.foreign.abi.x64.X86_64Architecture.*;
  import static org.testng.Assert.*;
  
  public class TestWindowsCallArranger extends CallArrangerTestBase {
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 76,14 ***</span>
          CallingSequence callingSequence = bindings.callingSequence;
          assertEquals(callingSequence.methodType(), mt);
          assertEquals(callingSequence.functionDesc(), fd);
  
          checkArgumentBindings(callingSequence, new Binding[][]{
<span class="line-modified">!             { new Binding.Move(rcx, int.class) },</span>
<span class="line-modified">!             { new Binding.Move(rdx, int.class) },</span>
<span class="line-modified">!             { new Binding.Move(r8, int.class) },</span>
<span class="line-modified">!             { new Binding.Move(r9, int.class) }</span>
          });
  
          checkReturnBindings(callingSequence, new Binding[]{});
      }
  
<span class="line-new-header">--- 78,14 ---</span>
          CallingSequence callingSequence = bindings.callingSequence;
          assertEquals(callingSequence.methodType(), mt);
          assertEquals(callingSequence.functionDesc(), fd);
  
          checkArgumentBindings(callingSequence, new Binding[][]{
<span class="line-modified">!             { move(rcx, int.class) },</span>
<span class="line-modified">!             { move(rdx, int.class) },</span>
<span class="line-modified">!             { move(r8, int.class) },</span>
<span class="line-modified">!             { move(r9, int.class) }</span>
          });
  
          checkReturnBindings(callingSequence, new Binding[]{});
      }
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 97,14 ***</span>
          CallingSequence callingSequence = bindings.callingSequence;
          assertEquals(callingSequence.methodType(), mt);
          assertEquals(callingSequence.functionDesc(), fd);
  
          checkArgumentBindings(callingSequence, new Binding[][]{
<span class="line-modified">!             { new Binding.Move(xmm0, double.class) },</span>
<span class="line-modified">!             { new Binding.Move(xmm1, double.class) },</span>
<span class="line-modified">!             { new Binding.Move(xmm2, double.class) },</span>
<span class="line-modified">!             { new Binding.Move(xmm3, double.class) }</span>
          });
  
          checkReturnBindings(callingSequence, new Binding[]{});
      }
  
<span class="line-new-header">--- 99,14 ---</span>
          CallingSequence callingSequence = bindings.callingSequence;
          assertEquals(callingSequence.methodType(), mt);
          assertEquals(callingSequence.functionDesc(), fd);
  
          checkArgumentBindings(callingSequence, new Binding[][]{
<span class="line-modified">!             { move(xmm0, double.class) },</span>
<span class="line-modified">!             { move(xmm1, double.class) },</span>
<span class="line-modified">!             { move(xmm2, double.class) },</span>
<span class="line-modified">!             { move(xmm3, double.class) }</span>
          });
  
          checkReturnBindings(callingSequence, new Binding[]{});
      }
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 120,18 ***</span>
          CallingSequence callingSequence = bindings.callingSequence;
          assertEquals(callingSequence.methodType(), mt);
          assertEquals(callingSequence.functionDesc(), fd);
  
          checkArgumentBindings(callingSequence, new Binding[][]{
<span class="line-modified">!             { new Binding.Move(rcx, long.class) },</span>
<span class="line-modified">!             { new Binding.Move(rdx, long.class) },</span>
<span class="line-modified">!             { new Binding.Move(xmm2, float.class) },</span>
<span class="line-modified">!             { new Binding.Move(xmm3, float.class) },</span>
<span class="line-modified">!             { new Binding.Move(stackStorage(0), long.class) },</span>
<span class="line-modified">!             { new Binding.Move(stackStorage(1), long.class) },</span>
<span class="line-modified">!             { new Binding.Move(stackStorage(2), float.class) },</span>
<span class="line-modified">!             { new Binding.Move(stackStorage(3), float.class) }</span>
          });
  
          checkReturnBindings(callingSequence, new Binding[]{});
      }
  
<span class="line-new-header">--- 122,18 ---</span>
          CallingSequence callingSequence = bindings.callingSequence;
          assertEquals(callingSequence.methodType(), mt);
          assertEquals(callingSequence.functionDesc(), fd);
  
          checkArgumentBindings(callingSequence, new Binding[][]{
<span class="line-modified">!             { move(rcx, long.class) },</span>
<span class="line-modified">!             { move(rdx, long.class) },</span>
<span class="line-modified">!             { move(xmm2, float.class) },</span>
<span class="line-modified">!             { move(xmm3, float.class) },</span>
<span class="line-modified">!             { move(stackStorage(0), long.class) },</span>
<span class="line-modified">!             { move(stackStorage(1), long.class) },</span>
<span class="line-modified">!             { move(stackStorage(2), float.class) },</span>
<span class="line-modified">!             { move(stackStorage(3), float.class) }</span>
          });
  
          checkReturnBindings(callingSequence, new Binding[]{});
      }
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 150,24 ***</span>
          CallingSequence callingSequence = bindings.callingSequence;
          assertEquals(callingSequence.methodType(), mt);
          assertEquals(callingSequence.functionDesc(), fd);
  
          checkArgumentBindings(callingSequence, new Binding[][]{
<span class="line-modified">!             { new Binding.Move(rcx, int.class) },</span>
<span class="line-modified">!             { new Binding.Move(rdx, int.class) },</span>
<span class="line-modified">!             { new Binding.Copy(structLayout.byteSize(), structLayout.byteAlignment()),</span>
<span class="line-modified">!                 new Binding.BaseAddress(),</span>
<span class="line-modified">!                 new Binding.BoxAddress(),</span>
<span class="line-modified">!                 new Binding.Move(r8, long.class) },</span>
<span class="line-modified">!             { new Binding.Move(r9, int.class) },</span>
<span class="line-modified">!             { new Binding.Move(stackStorage(0), int.class) },</span>
<span class="line-modified">!             { new Binding.Move(stackStorage(1), double.class) },</span>
<span class="line-modified">!             { new Binding.Move(stackStorage(2), double.class) },</span>
<span class="line-modified">!             { new Binding.Move(stackStorage(3), double.class) },</span>
<span class="line-modified">!             { new Binding.Move(stackStorage(4), int.class) },</span>
<span class="line-modified">!             { new Binding.Move(stackStorage(5), int.class) },</span>
<span class="line-modified">!             { new Binding.Move(stackStorage(6), int.class) }</span>
          });
  
          checkReturnBindings(callingSequence, new Binding[]{});
      }
  
<span class="line-new-header">--- 152,26 ---</span>
          CallingSequence callingSequence = bindings.callingSequence;
          assertEquals(callingSequence.methodType(), mt);
          assertEquals(callingSequence.functionDesc(), fd);
  
          checkArgumentBindings(callingSequence, new Binding[][]{
<span class="line-modified">!             { move(rcx, int.class) },</span>
<span class="line-modified">!             { move(rdx, int.class) },</span>
<span class="line-modified">!             {</span>
<span class="line-modified">!                 copy(structLayout),</span>
<span class="line-modified">!                 baseAddress(),</span>
<span class="line-modified">!                 convertAddress(),</span>
<span class="line-modified">!                 move(r8, long.class)</span>
<span class="line-modified">!             },</span>
<span class="line-modified">!             { move(r9, int.class) },</span>
<span class="line-modified">!             { move(stackStorage(0), int.class) },</span>
<span class="line-modified">!             { move(stackStorage(1), double.class) },</span>
<span class="line-modified">!             { move(stackStorage(2), double.class) },</span>
<span class="line-modified">!             { move(stackStorage(3), double.class) },</span>
<span class="line-modified">!             { move(stackStorage(4), int.class) },</span>
<span class="line-added">+             { move(stackStorage(5), int.class) },</span>
<span class="line-added">+             { move(stackStorage(6), int.class) }</span>
          });
  
          checkReturnBindings(callingSequence, new Binding[]{});
      }
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 183,15 ***</span>
          CallingSequence callingSequence = bindings.callingSequence;
          assertEquals(callingSequence.methodType(), mt);
          assertEquals(callingSequence.functionDesc(), fd);
  
          checkArgumentBindings(callingSequence, new Binding[][]{
<span class="line-modified">!             { new Binding.Move(rcx, int.class) },</span>
<span class="line-modified">!             { new Binding.Move(xmm1, double.class) },</span>
<span class="line-modified">!             { new Binding.Move(r8, int.class) },</span>
<span class="line-modified">!             { new Binding.Dup(), new Binding.Move(r9, double.class), new Binding.Move(xmm3, double.class) },</span>
<span class="line-modified">!             { new Binding.Move(stackStorage(0), double.class) },</span>
          });
  
          checkReturnBindings(callingSequence, new Binding[]{});
      }
  
<span class="line-new-header">--- 187,15 ---</span>
          CallingSequence callingSequence = bindings.callingSequence;
          assertEquals(callingSequence.methodType(), mt);
          assertEquals(callingSequence.functionDesc(), fd);
  
          checkArgumentBindings(callingSequence, new Binding[][]{
<span class="line-modified">!             { move(rcx, int.class) },</span>
<span class="line-modified">!             { move(xmm1, double.class) },</span>
<span class="line-modified">!             { move(r8, int.class) },</span>
<span class="line-modified">!             { dup(), move(r9, double.class), move(xmm3, double.class) },</span>
<span class="line-modified">!             { move(stackStorage(0), double.class) },</span>
          });
  
          checkReturnBindings(callingSequence, new Binding[]{});
      }
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 216,11 ***</span>
          CallingSequence callingSequence = bindings.callingSequence;
          assertEquals(callingSequence.methodType(), mt);
          assertEquals(callingSequence.functionDesc(), fd);
  
          checkArgumentBindings(callingSequence, new Binding[][]{
<span class="line-modified">!             { new Binding.Dereference(0, long.class), new Binding.Move(rcx, long.class) }</span>
          });
  
          checkReturnBindings(callingSequence, new Binding[]{});
      }
  
<span class="line-new-header">--- 220,11 ---</span>
          CallingSequence callingSequence = bindings.callingSequence;
          assertEquals(callingSequence.methodType(), mt);
          assertEquals(callingSequence.functionDesc(), fd);
  
          checkArgumentBindings(callingSequence, new Binding[][]{
<span class="line-modified">!             { dereference(0, long.class), move(rcx, long.class) }</span>
          });
  
          checkReturnBindings(callingSequence, new Binding[]{});
      }
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 245,14 ***</span>
          CallingSequence callingSequence = bindings.callingSequence;
          assertEquals(callingSequence.methodType(), mt);
          assertEquals(callingSequence.functionDesc(), fd);
  
          checkArgumentBindings(callingSequence, new Binding[][]{
<span class="line-modified">!             { new Binding.Copy(struct.byteSize(), struct.byteAlignment()),</span>
<span class="line-modified">!                     new Binding.BaseAddress(),</span>
<span class="line-modified">!                     new Binding.BoxAddress(),</span>
<span class="line-modified">!                     new Binding.Move(rcx, long.class) }</span>
          });
  
          checkReturnBindings(callingSequence, new Binding[]{});
      }
  
<span class="line-new-header">--- 249,16 ---</span>
          CallingSequence callingSequence = bindings.callingSequence;
          assertEquals(callingSequence.methodType(), mt);
          assertEquals(callingSequence.functionDesc(), fd);
  
          checkArgumentBindings(callingSequence, new Binding[][]{
<span class="line-modified">!             {</span>
<span class="line-modified">!                 copy(struct),</span>
<span class="line-modified">!                 baseAddress(),</span>
<span class="line-modified">!                 convertAddress(),</span>
<span class="line-added">+                 move(rcx, long.class)</span>
<span class="line-added">+             }</span>
          });
  
          checkReturnBindings(callingSequence, new Binding[]{});
      }
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 274,11 ***</span>
          CallingSequence callingSequence = bindings.callingSequence;
          assertEquals(callingSequence.methodType(), mt);
          assertEquals(callingSequence.functionDesc(), fd);
  
          checkArgumentBindings(callingSequence, new Binding[][]{
<span class="line-modified">!             { new Binding.BoxAddress(), new Binding.Move(rcx, long.class) }</span>
          });
  
          checkReturnBindings(callingSequence, new Binding[]{});
      }
  
<span class="line-new-header">--- 280,11 ---</span>
          CallingSequence callingSequence = bindings.callingSequence;
          assertEquals(callingSequence.methodType(), mt);
          assertEquals(callingSequence.functionDesc(), fd);
  
          checkArgumentBindings(callingSequence, new Binding[][]{
<span class="line-modified">!             { convertAddress(), move(rcx, long.class) }</span>
          });
  
          checkReturnBindings(callingSequence, new Binding[]{});
      }
  
</pre>
<hr />
<pre>
<span class="line-old-header">*** 296,14 ***</span>
          assertEquals(callingSequence.functionDesc(), fd);
  
          checkArgumentBindings(callingSequence, new Binding[][]{});
  
          checkReturnBindings(callingSequence,
<span class="line-modified">!             new Binding[]{ new Binding.AllocateBuffer(struct),</span>
<span class="line-modified">!                 new Binding.Dup(),</span>
<span class="line-modified">!                 new Binding.Move(rax, long.class),</span>
<span class="line-modified">!                 new Binding.Dereference(0, long.class) });</span>
      }
  
      @Test
      public void testIMR() {
          MemoryLayout struct = MemoryLayout.ofStruct(C_ULONGLONG, C_ULONGLONG);
<span class="line-new-header">--- 302,14 ---</span>
          assertEquals(callingSequence.functionDesc(), fd);
  
          checkArgumentBindings(callingSequence, new Binding[][]{});
  
          checkReturnBindings(callingSequence,
<span class="line-modified">!             new Binding[]{ allocate(struct),</span>
<span class="line-modified">!                 dup(),</span>
<span class="line-modified">!                 move(rax, long.class),</span>
<span class="line-modified">!                 dereference(0, long.class) });</span>
      }
  
      @Test
      public void testIMR() {
          MemoryLayout struct = MemoryLayout.ofStruct(C_ULONGLONG, C_ULONGLONG);
</pre>
<hr />
<pre>
<span class="line-old-header">*** 316,11 ***</span>
          CallingSequence callingSequence = bindings.callingSequence;
          assertEquals(callingSequence.methodType(), MethodType.methodType(void.class, MemoryAddress.class));
          assertEquals(callingSequence.functionDesc(), FunctionDescriptor.ofVoid(false, C_POINTER));
  
          checkArgumentBindings(callingSequence, new Binding[][]{
<span class="line-modified">!             { new Binding.BoxAddress(), new Binding.Move(rcx, long.class) }</span>
          });
  
          checkReturnBindings(callingSequence, new Binding[]{});
      }
  }
<span class="line-new-header">--- 322,11 ---</span>
          CallingSequence callingSequence = bindings.callingSequence;
          assertEquals(callingSequence.methodType(), MethodType.methodType(void.class, MemoryAddress.class));
          assertEquals(callingSequence.functionDesc(), FunctionDescriptor.ofVoid(false, C_POINTER));
  
          checkArgumentBindings(callingSequence, new Binding[][]{
<span class="line-modified">!             { convertAddress(), move(rcx, long.class) }</span>
          });
  
          checkReturnBindings(callingSequence, new Binding[]{});
      }
  }
</pre>
<center><a href="TestSysVCallArranger.java.cdiff.html" target="_top">&lt; prev</a> <a href="../../../../../index.html" target="_top">index</a> next &gt;</center>  </body>
</html>