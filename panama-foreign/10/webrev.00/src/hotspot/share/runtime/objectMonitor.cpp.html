<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New src/hotspot/share/runtime/objectMonitor.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
  <body>
    <pre>
   1 /*
   2  * Copyright (c) 1998, 2020, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
  23  */
  24 
  25 #include &quot;precompiled.hpp&quot;
  26 #include &quot;classfile/vmSymbols.hpp&quot;
  27 #include &quot;jfr/jfrEvents.hpp&quot;
  28 #include &quot;jfr/support/jfrThreadId.hpp&quot;
  29 #include &quot;logging/log.hpp&quot;
  30 #include &quot;logging/logStream.hpp&quot;
  31 #include &quot;memory/allocation.inline.hpp&quot;
  32 #include &quot;memory/resourceArea.hpp&quot;
  33 #include &quot;oops/markWord.hpp&quot;
  34 #include &quot;oops/oop.inline.hpp&quot;
  35 #include &quot;runtime/atomic.hpp&quot;
  36 #include &quot;runtime/handles.inline.hpp&quot;
  37 #include &quot;runtime/interfaceSupport.inline.hpp&quot;
  38 #include &quot;runtime/mutexLocker.hpp&quot;
  39 #include &quot;runtime/objectMonitor.hpp&quot;
  40 #include &quot;runtime/objectMonitor.inline.hpp&quot;
  41 #include &quot;runtime/orderAccess.hpp&quot;
  42 #include &quot;runtime/osThread.hpp&quot;
  43 #include &quot;runtime/safepointMechanism.inline.hpp&quot;
  44 #include &quot;runtime/sharedRuntime.hpp&quot;
  45 #include &quot;runtime/stubRoutines.hpp&quot;
  46 #include &quot;runtime/thread.inline.hpp&quot;
  47 #include &quot;services/threadService.hpp&quot;
  48 #include &quot;utilities/dtrace.hpp&quot;
  49 #include &quot;utilities/macros.hpp&quot;
  50 #include &quot;utilities/preserveException.hpp&quot;
  51 #if INCLUDE_JFR
  52 #include &quot;jfr/support/jfrFlush.hpp&quot;
  53 #endif
  54 
  55 #ifdef DTRACE_ENABLED
  56 
  57 // Only bother with this argument setup if dtrace is available
  58 // TODO-FIXME: probes should not fire when caller is _blocked.  assert() accordingly.
  59 
  60 
  61 #define DTRACE_MONITOR_PROBE_COMMON(obj, thread)                           \
  62   char* bytes = NULL;                                                      \
  63   int len = 0;                                                             \
  64   jlong jtid = SharedRuntime::get_java_tid(thread);                        \
  65   Symbol* klassname = ((oop)obj)-&gt;klass()-&gt;name();                         \
  66   if (klassname != NULL) {                                                 \
  67     bytes = (char*)klassname-&gt;bytes();                                     \
  68     len = klassname-&gt;utf8_length();                                        \
  69   }
  70 
  71 #define DTRACE_MONITOR_WAIT_PROBE(monitor, obj, thread, millis)            \
  72   {                                                                        \
  73     if (DTraceMonitorProbes) {                                             \
  74       DTRACE_MONITOR_PROBE_COMMON(obj, thread);                            \
  75       HOTSPOT_MONITOR_WAIT(jtid,                                           \
  76                            (monitor), bytes, len, (millis));               \
  77     }                                                                      \
  78   }
  79 
  80 #define HOTSPOT_MONITOR_contended__enter HOTSPOT_MONITOR_CONTENDED_ENTER
  81 #define HOTSPOT_MONITOR_contended__entered HOTSPOT_MONITOR_CONTENDED_ENTERED
  82 #define HOTSPOT_MONITOR_contended__exit HOTSPOT_MONITOR_CONTENDED_EXIT
  83 #define HOTSPOT_MONITOR_notify HOTSPOT_MONITOR_NOTIFY
  84 #define HOTSPOT_MONITOR_notifyAll HOTSPOT_MONITOR_NOTIFYALL
  85 
  86 #define DTRACE_MONITOR_PROBE(probe, monitor, obj, thread)                  \
  87   {                                                                        \
  88     if (DTraceMonitorProbes) {                                             \
  89       DTRACE_MONITOR_PROBE_COMMON(obj, thread);                            \
  90       HOTSPOT_MONITOR_##probe(jtid,                                        \
  91                               (uintptr_t)(monitor), bytes, len);           \
  92     }                                                                      \
  93   }
  94 
  95 #else //  ndef DTRACE_ENABLED
  96 
  97 #define DTRACE_MONITOR_WAIT_PROBE(obj, thread, millis, mon)    {;}
  98 #define DTRACE_MONITOR_PROBE(probe, obj, thread, mon)          {;}
  99 
 100 #endif // ndef DTRACE_ENABLED
 101 
 102 // Tunables ...
 103 // The knob* variables are effectively final.  Once set they should
 104 // never be modified hence.  Consider using __read_mostly with GCC.
 105 
 106 int ObjectMonitor::Knob_SpinLimit    = 5000;    // derived by an external tool -
 107 
 108 static int Knob_Bonus               = 100;     // spin success bonus
 109 static int Knob_BonusB              = 100;     // spin success bonus
 110 static int Knob_Penalty             = 200;     // spin failure penalty
 111 static int Knob_Poverty             = 1000;
 112 static int Knob_FixedSpin           = 0;
 113 static int Knob_PreSpin             = 10;      // 20-100 likely better
 114 
 115 DEBUG_ONLY(static volatile bool InitDone = false;)
 116 
 117 // -----------------------------------------------------------------------------
 118 // Theory of operations -- Monitors lists, thread residency, etc:
 119 //
 120 // * A thread acquires ownership of a monitor by successfully
 121 //   CAS()ing the _owner field from null to non-null.
 122 //
 123 // * Invariant: A thread appears on at most one monitor list --
 124 //   cxq, EntryList or WaitSet -- at any one time.
 125 //
 126 // * Contending threads &quot;push&quot; themselves onto the cxq with CAS
 127 //   and then spin/park.
 128 //
 129 // * After a contending thread eventually acquires the lock it must
 130 //   dequeue itself from either the EntryList or the cxq.
 131 //
 132 // * The exiting thread identifies and unparks an &quot;heir presumptive&quot;
 133 //   tentative successor thread on the EntryList.  Critically, the
 134 //   exiting thread doesn&#39;t unlink the successor thread from the EntryList.
 135 //   After having been unparked, the wakee will recontend for ownership of
 136 //   the monitor.   The successor (wakee) will either acquire the lock or
 137 //   re-park itself.
 138 //
 139 //   Succession is provided for by a policy of competitive handoff.
 140 //   The exiting thread does _not_ grant or pass ownership to the
 141 //   successor thread.  (This is also referred to as &quot;handoff&quot; succession&quot;).
 142 //   Instead the exiting thread releases ownership and possibly wakes
 143 //   a successor, so the successor can (re)compete for ownership of the lock.
 144 //   If the EntryList is empty but the cxq is populated the exiting
 145 //   thread will drain the cxq into the EntryList.  It does so by
 146 //   by detaching the cxq (installing null with CAS) and folding
 147 //   the threads from the cxq into the EntryList.  The EntryList is
 148 //   doubly linked, while the cxq is singly linked because of the
 149 //   CAS-based &quot;push&quot; used to enqueue recently arrived threads (RATs).
 150 //
 151 // * Concurrency invariants:
 152 //
 153 //   -- only the monitor owner may access or mutate the EntryList.
 154 //      The mutex property of the monitor itself protects the EntryList
 155 //      from concurrent interference.
 156 //   -- Only the monitor owner may detach the cxq.
 157 //
 158 // * The monitor entry list operations avoid locks, but strictly speaking
 159 //   they&#39;re not lock-free.  Enter is lock-free, exit is not.
 160 //   For a description of &#39;Methods and apparatus providing non-blocking access
 161 //   to a resource,&#39; see U.S. Pat. No. 7844973.
 162 //
 163 // * The cxq can have multiple concurrent &quot;pushers&quot; but only one concurrent
 164 //   detaching thread.  This mechanism is immune from the ABA corruption.
 165 //   More precisely, the CAS-based &quot;push&quot; onto cxq is ABA-oblivious.
 166 //
 167 // * Taken together, the cxq and the EntryList constitute or form a
 168 //   single logical queue of threads stalled trying to acquire the lock.
 169 //   We use two distinct lists to improve the odds of a constant-time
 170 //   dequeue operation after acquisition (in the ::enter() epilogue) and
 171 //   to reduce heat on the list ends.  (c.f. Michael Scott&#39;s &quot;2Q&quot; algorithm).
 172 //   A key desideratum is to minimize queue &amp; monitor metadata manipulation
 173 //   that occurs while holding the monitor lock -- that is, we want to
 174 //   minimize monitor lock holds times.  Note that even a small amount of
 175 //   fixed spinning will greatly reduce the # of enqueue-dequeue operations
 176 //   on EntryList|cxq.  That is, spinning relieves contention on the &quot;inner&quot;
 177 //   locks and monitor metadata.
 178 //
 179 //   Cxq points to the set of Recently Arrived Threads attempting entry.
 180 //   Because we push threads onto _cxq with CAS, the RATs must take the form of
 181 //   a singly-linked LIFO.  We drain _cxq into EntryList  at unlock-time when
 182 //   the unlocking thread notices that EntryList is null but _cxq is != null.
 183 //
 184 //   The EntryList is ordered by the prevailing queue discipline and
 185 //   can be organized in any convenient fashion, such as a doubly-linked list or
 186 //   a circular doubly-linked list.  Critically, we want insert and delete operations
 187 //   to operate in constant-time.  If we need a priority queue then something akin
 188 //   to Solaris&#39; sleepq would work nicely.  Viz.,
 189 //   http://agg.eng/ws/on10_nightly/source/usr/src/uts/common/os/sleepq.c.
 190 //   Queue discipline is enforced at ::exit() time, when the unlocking thread
 191 //   drains the cxq into the EntryList, and orders or reorders the threads on the
 192 //   EntryList accordingly.
 193 //
 194 //   Barring &quot;lock barging&quot;, this mechanism provides fair cyclic ordering,
 195 //   somewhat similar to an elevator-scan.
 196 //
 197 // * The monitor synchronization subsystem avoids the use of native
 198 //   synchronization primitives except for the narrow platform-specific
 199 //   park-unpark abstraction.  See the comments in os_solaris.cpp regarding
 200 //   the semantics of park-unpark.  Put another way, this monitor implementation
 201 //   depends only on atomic operations and park-unpark.  The monitor subsystem
 202 //   manages all RUNNING-&gt;BLOCKED and BLOCKED-&gt;READY transitions while the
 203 //   underlying OS manages the READY&lt;-&gt;RUN transitions.
 204 //
 205 // * Waiting threads reside on the WaitSet list -- wait() puts
 206 //   the caller onto the WaitSet.
 207 //
 208 // * notify() or notifyAll() simply transfers threads from the WaitSet to
 209 //   either the EntryList or cxq.  Subsequent exit() operations will
 210 //   unpark the notifyee.  Unparking a notifee in notify() is inefficient -
 211 //   it&#39;s likely the notifyee would simply impale itself on the lock held
 212 //   by the notifier.
 213 //
 214 // * An interesting alternative is to encode cxq as (List,LockByte) where
 215 //   the LockByte is 0 iff the monitor is owned.  _owner is simply an auxiliary
 216 //   variable, like _recursions, in the scheme.  The threads or Events that form
 217 //   the list would have to be aligned in 256-byte addresses.  A thread would
 218 //   try to acquire the lock or enqueue itself with CAS, but exiting threads
 219 //   could use a 1-0 protocol and simply STB to set the LockByte to 0.
 220 //   Note that is is *not* word-tearing, but it does presume that full-word
 221 //   CAS operations are coherent with intermix with STB operations.  That&#39;s true
 222 //   on most common processors.
 223 //
 224 // * See also http://blogs.sun.com/dave
 225 
 226 
 227 void* ObjectMonitor::operator new (size_t size) throw() {
 228   return AllocateHeap(size, mtInternal);
 229 }
 230 void* ObjectMonitor::operator new[] (size_t size) throw() {
 231   return operator new (size);
 232 }
 233 void ObjectMonitor::operator delete(void* p) {
 234   FreeHeap(p);
 235 }
 236 void ObjectMonitor::operator delete[] (void *p) {
 237   operator delete(p);
 238 }
 239 
 240 // -----------------------------------------------------------------------------
 241 // Enter support
 242 
 243 void ObjectMonitor::enter(TRAPS) {
 244   // The following code is ordered to check the most common cases first
 245   // and to reduce RTS-&gt;RTO cache line upgrades on SPARC and IA32 processors.
 246   Thread * const Self = THREAD;
 247 
 248   void* cur = try_set_owner_from(NULL, Self);
 249   if (cur == NULL) {
 250     assert(_recursions == 0, &quot;invariant&quot;);
 251     return;
 252   }
 253 
 254   if (cur == Self) {
 255     // TODO-FIXME: check for integer overflow!  BUGID 6557169.
 256     _recursions++;
 257     return;
 258   }
 259 
 260   if (Self-&gt;is_lock_owned((address)cur)) {
 261     assert(_recursions == 0, &quot;internal state error&quot;);
 262     _recursions = 1;
 263     set_owner_from_BasicLock(cur, Self);  // Convert from BasicLock* to Thread*.
 264     return;
 265   }
 266 
 267   // We&#39;ve encountered genuine contention.
 268   assert(Self-&gt;_Stalled == 0, &quot;invariant&quot;);
 269   Self-&gt;_Stalled = intptr_t(this);
 270 
 271   // Try one round of spinning *before* enqueueing Self
 272   // and before going through the awkward and expensive state
 273   // transitions.  The following spin is strictly optional ...
 274   // Note that if we acquire the monitor from an initial spin
 275   // we forgo posting JVMTI events and firing DTRACE probes.
 276   if (TrySpin(Self) &gt; 0) {
 277     assert(_owner == Self, &quot;must be Self: owner=&quot; INTPTR_FORMAT, p2i(_owner));
 278     assert(_recursions == 0, &quot;must be 0: recursions=&quot; INTX_FORMAT, _recursions);
 279     assert(((oop)object())-&gt;mark() == markWord::encode(this),
 280            &quot;object mark must match encoded this: mark=&quot; INTPTR_FORMAT
 281            &quot;, encoded this=&quot; INTPTR_FORMAT, ((oop)object())-&gt;mark().value(),
 282            markWord::encode(this).value());
 283     Self-&gt;_Stalled = 0;
 284     return;
 285   }
 286 
 287   assert(_owner != Self, &quot;invariant&quot;);
 288   assert(_succ != Self, &quot;invariant&quot;);
 289   assert(Self-&gt;is_Java_thread(), &quot;invariant&quot;);
 290   JavaThread * jt = (JavaThread *) Self;
 291   assert(!SafepointSynchronize::is_at_safepoint(), &quot;invariant&quot;);
 292   assert(jt-&gt;thread_state() != _thread_blocked, &quot;invariant&quot;);
 293   assert(this-&gt;object() != NULL, &quot;invariant&quot;);
 294   assert(_contentions &gt;= 0, &quot;invariant&quot;);
 295 
 296   // Prevent deflation at STW-time.  See deflate_idle_monitors() and is_busy().
 297   // Ensure the object-monitor relationship remains stable while there&#39;s contention.
 298   Atomic::inc(&amp;_contentions);
 299 
 300   JFR_ONLY(JfrConditionalFlushWithStacktrace&lt;EventJavaMonitorEnter&gt; flush(jt);)
 301   EventJavaMonitorEnter event;
 302   if (event.should_commit()) {
 303     event.set_monitorClass(((oop)this-&gt;object())-&gt;klass());
 304     event.set_address((uintptr_t)(this-&gt;object_addr()));
 305   }
 306 
 307   { // Change java thread status to indicate blocked on monitor enter.
 308     JavaThreadBlockedOnMonitorEnterState jtbmes(jt, this);
 309 
 310     Self-&gt;set_current_pending_monitor(this);
 311 
 312     DTRACE_MONITOR_PROBE(contended__enter, this, object(), jt);
 313     if (JvmtiExport::should_post_monitor_contended_enter()) {
 314       JvmtiExport::post_monitor_contended_enter(jt, this);
 315 
 316       // The current thread does not yet own the monitor and does not
 317       // yet appear on any queues that would get it made the successor.
 318       // This means that the JVMTI_EVENT_MONITOR_CONTENDED_ENTER event
 319       // handler cannot accidentally consume an unpark() meant for the
 320       // ParkEvent associated with this ObjectMonitor.
 321     }
 322 
 323     OSThreadContendState osts(Self-&gt;osthread());
 324     ThreadBlockInVM tbivm(jt);
 325 
 326     // TODO-FIXME: change the following for(;;) loop to straight-line code.
 327     for (;;) {
 328       jt-&gt;set_suspend_equivalent();
 329       // cleared by handle_special_suspend_equivalent_condition()
 330       // or java_suspend_self()
 331 
 332       EnterI(THREAD);
 333 
 334       if (!ExitSuspendEquivalent(jt)) break;
 335 
 336       // We have acquired the contended monitor, but while we were
 337       // waiting another thread suspended us. We don&#39;t want to enter
 338       // the monitor while suspended because that would surprise the
 339       // thread that suspended us.
 340       //
 341       _recursions = 0;
 342       _succ = NULL;
 343       exit(false, Self);
 344 
 345       jt-&gt;java_suspend_self();
 346     }
 347     Self-&gt;set_current_pending_monitor(NULL);
 348 
 349     // We cleared the pending monitor info since we&#39;ve just gotten past
 350     // the enter-check-for-suspend dance and we now own the monitor free
 351     // and clear, i.e., it is no longer pending. The ThreadBlockInVM
 352     // destructor can go to a safepoint at the end of this block. If we
 353     // do a thread dump during that safepoint, then this thread will show
 354     // as having &quot;-locked&quot; the monitor, but the OS and java.lang.Thread
 355     // states will still report that the thread is blocked trying to
 356     // acquire it.
 357   }
 358 
 359   Atomic::dec(&amp;_contentions);
 360   assert(_contentions &gt;= 0, &quot;invariant&quot;);
 361   Self-&gt;_Stalled = 0;
 362 
 363   // Must either set _recursions = 0 or ASSERT _recursions == 0.
 364   assert(_recursions == 0, &quot;invariant&quot;);
 365   assert(_owner == Self, &quot;invariant&quot;);
 366   assert(_succ != Self, &quot;invariant&quot;);
 367   assert(((oop)(object()))-&gt;mark() == markWord::encode(this), &quot;invariant&quot;);
 368 
 369   // The thread -- now the owner -- is back in vm mode.
 370   // Report the glorious news via TI,DTrace and jvmstat.
 371   // The probe effect is non-trivial.  All the reportage occurs
 372   // while we hold the monitor, increasing the length of the critical
 373   // section.  Amdahl&#39;s parallel speedup law comes vividly into play.
 374   //
 375   // Another option might be to aggregate the events (thread local or
 376   // per-monitor aggregation) and defer reporting until a more opportune
 377   // time -- such as next time some thread encounters contention but has
 378   // yet to acquire the lock.  While spinning that thread could
 379   // spinning we could increment JVMStat counters, etc.
 380 
 381   DTRACE_MONITOR_PROBE(contended__entered, this, object(), jt);
 382   if (JvmtiExport::should_post_monitor_contended_entered()) {
 383     JvmtiExport::post_monitor_contended_entered(jt, this);
 384 
 385     // The current thread already owns the monitor and is not going to
 386     // call park() for the remainder of the monitor enter protocol. So
 387     // it doesn&#39;t matter if the JVMTI_EVENT_MONITOR_CONTENDED_ENTERED
 388     // event handler consumed an unpark() issued by the thread that
 389     // just exited the monitor.
 390   }
 391   if (event.should_commit()) {
 392     event.set_previousOwner((uintptr_t)_previous_owner_tid);
 393     event.commit();
 394   }
 395   OM_PERFDATA_OP(ContendedLockAttempts, inc());
 396 }
 397 
 398 // Caveat: TryLock() is not necessarily serializing if it returns failure.
 399 // Callers must compensate as needed.
 400 
 401 int ObjectMonitor::TryLock(Thread * Self) {
 402   void * own = _owner;
 403   if (own != NULL) return 0;
 404   if (try_set_owner_from(NULL, Self) == NULL) {
 405     assert(_recursions == 0, &quot;invariant&quot;);
 406     return 1;
 407   }
 408   // The lock had been free momentarily, but we lost the race to the lock.
 409   // Interference -- the CAS failed.
 410   // We can either return -1 or retry.
 411   // Retry doesn&#39;t make as much sense because the lock was just acquired.
 412   return -1;
 413 }
 414 
 415 // Convert the fields used by is_busy() to a string that can be
 416 // used for diagnostic output.
 417 const char* ObjectMonitor::is_busy_to_string(stringStream* ss) {
 418   ss-&gt;print(&quot;is_busy: contentions=%d, waiters=%d, owner=&quot; INTPTR_FORMAT
 419             &quot;, cxq=&quot; INTPTR_FORMAT &quot;, EntryList=&quot; INTPTR_FORMAT, _contentions,
 420             _waiters, p2i(_owner), p2i(_cxq), p2i(_EntryList));
 421   return ss-&gt;base();
 422 }
 423 
 424 #define MAX_RECHECK_INTERVAL 1000
 425 
 426 void ObjectMonitor::EnterI(TRAPS) {
 427   Thread * const Self = THREAD;
 428   assert(Self-&gt;is_Java_thread(), &quot;invariant&quot;);
 429   assert(((JavaThread *) Self)-&gt;thread_state() == _thread_blocked, &quot;invariant&quot;);
 430 
 431   // Try the lock - TATAS
 432   if (TryLock (Self) &gt; 0) {
 433     assert(_succ != Self, &quot;invariant&quot;);
 434     assert(_owner == Self, &quot;invariant&quot;);
 435     assert(_Responsible != Self, &quot;invariant&quot;);
 436     return;
 437   }
 438 
 439   assert(InitDone, &quot;Unexpectedly not initialized&quot;);
 440 
 441   // We try one round of spinning *before* enqueueing Self.
 442   //
 443   // If the _owner is ready but OFFPROC we could use a YieldTo()
 444   // operation to donate the remainder of this thread&#39;s quantum
 445   // to the owner.  This has subtle but beneficial affinity
 446   // effects.
 447 
 448   if (TrySpin(Self) &gt; 0) {
 449     assert(_owner == Self, &quot;invariant&quot;);
 450     assert(_succ != Self, &quot;invariant&quot;);
 451     assert(_Responsible != Self, &quot;invariant&quot;);
 452     return;
 453   }
 454 
 455   // The Spin failed -- Enqueue and park the thread ...
 456   assert(_succ != Self, &quot;invariant&quot;);
 457   assert(_owner != Self, &quot;invariant&quot;);
 458   assert(_Responsible != Self, &quot;invariant&quot;);
 459 
 460   // Enqueue &quot;Self&quot; on ObjectMonitor&#39;s _cxq.
 461   //
 462   // Node acts as a proxy for Self.
 463   // As an aside, if were to ever rewrite the synchronization code mostly
 464   // in Java, WaitNodes, ObjectMonitors, and Events would become 1st-class
 465   // Java objects.  This would avoid awkward lifecycle and liveness issues,
 466   // as well as eliminate a subset of ABA issues.
 467   // TODO: eliminate ObjectWaiter and enqueue either Threads or Events.
 468 
 469   ObjectWaiter node(Self);
 470   Self-&gt;_ParkEvent-&gt;reset();
 471   node._prev   = (ObjectWaiter *) 0xBAD;
 472   node.TState  = ObjectWaiter::TS_CXQ;
 473 
 474   // Push &quot;Self&quot; onto the front of the _cxq.
 475   // Once on cxq/EntryList, Self stays on-queue until it acquires the lock.
 476   // Note that spinning tends to reduce the rate at which threads
 477   // enqueue and dequeue on EntryList|cxq.
 478   ObjectWaiter * nxt;
 479   for (;;) {
 480     node._next = nxt = _cxq;
 481     if (Atomic::cmpxchg(&amp;_cxq, nxt, &amp;node) == nxt) break;
 482 
 483     // Interference - the CAS failed because _cxq changed.  Just retry.
 484     // As an optional optimization we retry the lock.
 485     if (TryLock (Self) &gt; 0) {
 486       assert(_succ != Self, &quot;invariant&quot;);
 487       assert(_owner == Self, &quot;invariant&quot;);
 488       assert(_Responsible != Self, &quot;invariant&quot;);
 489       return;
 490     }
 491   }
 492 
 493   // Check for cxq|EntryList edge transition to non-null.  This indicates
 494   // the onset of contention.  While contention persists exiting threads
 495   // will use a ST:MEMBAR:LD 1-1 exit protocol.  When contention abates exit
 496   // operations revert to the faster 1-0 mode.  This enter operation may interleave
 497   // (race) a concurrent 1-0 exit operation, resulting in stranding, so we
 498   // arrange for one of the contending thread to use a timed park() operations
 499   // to detect and recover from the race.  (Stranding is form of progress failure
 500   // where the monitor is unlocked but all the contending threads remain parked).
 501   // That is, at least one of the contended threads will periodically poll _owner.
 502   // One of the contending threads will become the designated &quot;Responsible&quot; thread.
 503   // The Responsible thread uses a timed park instead of a normal indefinite park
 504   // operation -- it periodically wakes and checks for and recovers from potential
 505   // strandings admitted by 1-0 exit operations.   We need at most one Responsible
 506   // thread per-monitor at any given moment.  Only threads on cxq|EntryList may
 507   // be responsible for a monitor.
 508   //
 509   // Currently, one of the contended threads takes on the added role of &quot;Responsible&quot;.
 510   // A viable alternative would be to use a dedicated &quot;stranding checker&quot; thread
 511   // that periodically iterated over all the threads (or active monitors) and unparked
 512   // successors where there was risk of stranding.  This would help eliminate the
 513   // timer scalability issues we see on some platforms as we&#39;d only have one thread
 514   // -- the checker -- parked on a timer.
 515 
 516   if (nxt == NULL &amp;&amp; _EntryList == NULL) {
 517     // Try to assume the role of responsible thread for the monitor.
 518     // CONSIDER:  ST vs CAS vs { if (Responsible==null) Responsible=Self }
 519     Atomic::replace_if_null(&amp;_Responsible, Self);
 520   }
 521 
 522   // The lock might have been released while this thread was occupied queueing
 523   // itself onto _cxq.  To close the race and avoid &quot;stranding&quot; and
 524   // progress-liveness failure we must resample-retry _owner before parking.
 525   // Note the Dekker/Lamport duality: ST cxq; MEMBAR; LD Owner.
 526   // In this case the ST-MEMBAR is accomplished with CAS().
 527   //
 528   // TODO: Defer all thread state transitions until park-time.
 529   // Since state transitions are heavy and inefficient we&#39;d like
 530   // to defer the state transitions until absolutely necessary,
 531   // and in doing so avoid some transitions ...
 532 
 533   int nWakeups = 0;
 534   int recheckInterval = 1;
 535 
 536   for (;;) {
 537 
 538     if (TryLock(Self) &gt; 0) break;
 539     assert(_owner != Self, &quot;invariant&quot;);
 540 
 541     // park self
 542     if (_Responsible == Self) {
 543       Self-&gt;_ParkEvent-&gt;park((jlong) recheckInterval);
 544       // Increase the recheckInterval, but clamp the value.
 545       recheckInterval *= 8;
 546       if (recheckInterval &gt; MAX_RECHECK_INTERVAL) {
 547         recheckInterval = MAX_RECHECK_INTERVAL;
 548       }
 549     } else {
 550       Self-&gt;_ParkEvent-&gt;park();
 551     }
 552 
 553     if (TryLock(Self) &gt; 0) break;
 554 
 555     // The lock is still contested.
 556     // Keep a tally of the # of futile wakeups.
 557     // Note that the counter is not protected by a lock or updated by atomics.
 558     // That is by design - we trade &quot;lossy&quot; counters which are exposed to
 559     // races during updates for a lower probe effect.
 560 
 561     // This PerfData object can be used in parallel with a safepoint.
 562     // See the work around in PerfDataManager::destroy().
 563     OM_PERFDATA_OP(FutileWakeups, inc());
 564     ++nWakeups;
 565 
 566     // Assuming this is not a spurious wakeup we&#39;ll normally find _succ == Self.
 567     // We can defer clearing _succ until after the spin completes
 568     // TrySpin() must tolerate being called with _succ == Self.
 569     // Try yet another round of adaptive spinning.
 570     if (TrySpin(Self) &gt; 0) break;
 571 
 572     // We can find that we were unpark()ed and redesignated _succ while
 573     // we were spinning.  That&#39;s harmless.  If we iterate and call park(),
 574     // park() will consume the event and return immediately and we&#39;ll
 575     // just spin again.  This pattern can repeat, leaving _succ to simply
 576     // spin on a CPU.
 577 
 578     if (_succ == Self) _succ = NULL;
 579 
 580     // Invariant: after clearing _succ a thread *must* retry _owner before parking.
 581     OrderAccess::fence();
 582   }
 583 
 584   // Egress :
 585   // Self has acquired the lock -- Unlink Self from the cxq or EntryList.
 586   // Normally we&#39;ll find Self on the EntryList .
 587   // From the perspective of the lock owner (this thread), the
 588   // EntryList is stable and cxq is prepend-only.
 589   // The head of cxq is volatile but the interior is stable.
 590   // In addition, Self.TState is stable.
 591 
 592   assert(_owner == Self, &quot;invariant&quot;);
 593   assert(object() != NULL, &quot;invariant&quot;);
 594   // I&#39;d like to write:
 595   //   guarantee (((oop)(object()))-&gt;mark() == markWord::encode(this), &quot;invariant&quot;) ;
 596   // but as we&#39;re at a safepoint that&#39;s not safe.
 597 
 598   UnlinkAfterAcquire(Self, &amp;node);
 599   if (_succ == Self) _succ = NULL;
 600 
 601   assert(_succ != Self, &quot;invariant&quot;);
 602   if (_Responsible == Self) {
 603     _Responsible = NULL;
 604     OrderAccess::fence(); // Dekker pivot-point
 605 
 606     // We may leave threads on cxq|EntryList without a designated
 607     // &quot;Responsible&quot; thread.  This is benign.  When this thread subsequently
 608     // exits the monitor it can &quot;see&quot; such preexisting &quot;old&quot; threads --
 609     // threads that arrived on the cxq|EntryList before the fence, above --
 610     // by LDing cxq|EntryList.  Newly arrived threads -- that is, threads
 611     // that arrive on cxq after the ST:MEMBAR, above -- will set Responsible
 612     // non-null and elect a new &quot;Responsible&quot; timer thread.
 613     //
 614     // This thread executes:
 615     //    ST Responsible=null; MEMBAR    (in enter epilogue - here)
 616     //    LD cxq|EntryList               (in subsequent exit)
 617     //
 618     // Entering threads in the slow/contended path execute:
 619     //    ST cxq=nonnull; MEMBAR; LD Responsible (in enter prolog)
 620     //    The (ST cxq; MEMBAR) is accomplished with CAS().
 621     //
 622     // The MEMBAR, above, prevents the LD of cxq|EntryList in the subsequent
 623     // exit operation from floating above the ST Responsible=null.
 624   }
 625 
 626   // We&#39;ve acquired ownership with CAS().
 627   // CAS is serializing -- it has MEMBAR/FENCE-equivalent semantics.
 628   // But since the CAS() this thread may have also stored into _succ,
 629   // EntryList, cxq or Responsible.  These meta-data updates must be
 630   // visible __before this thread subsequently drops the lock.
 631   // Consider what could occur if we didn&#39;t enforce this constraint --
 632   // STs to monitor meta-data and user-data could reorder with (become
 633   // visible after) the ST in exit that drops ownership of the lock.
 634   // Some other thread could then acquire the lock, but observe inconsistent
 635   // or old monitor meta-data and heap data.  That violates the JMM.
 636   // To that end, the 1-0 exit() operation must have at least STST|LDST
 637   // &quot;release&quot; barrier semantics.  Specifically, there must be at least a
 638   // STST|LDST barrier in exit() before the ST of null into _owner that drops
 639   // the lock.   The barrier ensures that changes to monitor meta-data and data
 640   // protected by the lock will be visible before we release the lock, and
 641   // therefore before some other thread (CPU) has a chance to acquire the lock.
 642   // See also: http://gee.cs.oswego.edu/dl/jmm/cookbook.html.
 643   //
 644   // Critically, any prior STs to _succ or EntryList must be visible before
 645   // the ST of null into _owner in the *subsequent* (following) corresponding
 646   // monitorexit.  Recall too, that in 1-0 mode monitorexit does not necessarily
 647   // execute a serializing instruction.
 648 
 649   return;
 650 }
 651 
 652 // ReenterI() is a specialized inline form of the latter half of the
 653 // contended slow-path from EnterI().  We use ReenterI() only for
 654 // monitor reentry in wait().
 655 //
 656 // In the future we should reconcile EnterI() and ReenterI().
 657 
 658 void ObjectMonitor::ReenterI(Thread * Self, ObjectWaiter * SelfNode) {
 659   assert(Self != NULL, &quot;invariant&quot;);
 660   assert(SelfNode != NULL, &quot;invariant&quot;);
 661   assert(SelfNode-&gt;_thread == Self, &quot;invariant&quot;);
 662   assert(_waiters &gt; 0, &quot;invariant&quot;);
 663   assert(((oop)(object()))-&gt;mark() == markWord::encode(this), &quot;invariant&quot;);
 664   assert(((JavaThread *)Self)-&gt;thread_state() != _thread_blocked, &quot;invariant&quot;);
 665   JavaThread * jt = (JavaThread *) Self;
 666 
 667   int nWakeups = 0;
 668   for (;;) {
 669     ObjectWaiter::TStates v = SelfNode-&gt;TState;
 670     guarantee(v == ObjectWaiter::TS_ENTER || v == ObjectWaiter::TS_CXQ, &quot;invariant&quot;);
 671     assert(_owner != Self, &quot;invariant&quot;);
 672 
 673     if (TryLock(Self) &gt; 0) break;
 674     if (TrySpin(Self) &gt; 0) break;
 675 
 676     // State transition wrappers around park() ...
 677     // ReenterI() wisely defers state transitions until
 678     // it&#39;s clear we must park the thread.
 679     {
 680       OSThreadContendState osts(Self-&gt;osthread());
 681       ThreadBlockInVM tbivm(jt);
 682 
 683       // cleared by handle_special_suspend_equivalent_condition()
 684       // or java_suspend_self()
 685       jt-&gt;set_suspend_equivalent();
 686       Self-&gt;_ParkEvent-&gt;park();
 687 
 688       // were we externally suspended while we were waiting?
 689       for (;;) {
 690         if (!ExitSuspendEquivalent(jt)) break;
 691         if (_succ == Self) { _succ = NULL; OrderAccess::fence(); }
 692         jt-&gt;java_suspend_self();
 693         jt-&gt;set_suspend_equivalent();
 694       }
 695     }
 696 
 697     // Try again, but just so we distinguish between futile wakeups and
 698     // successful wakeups.  The following test isn&#39;t algorithmically
 699     // necessary, but it helps us maintain sensible statistics.
 700     if (TryLock(Self) &gt; 0) break;
 701 
 702     // The lock is still contested.
 703     // Keep a tally of the # of futile wakeups.
 704     // Note that the counter is not protected by a lock or updated by atomics.
 705     // That is by design - we trade &quot;lossy&quot; counters which are exposed to
 706     // races during updates for a lower probe effect.
 707     ++nWakeups;
 708 
 709     // Assuming this is not a spurious wakeup we&#39;ll normally
 710     // find that _succ == Self.
 711     if (_succ == Self) _succ = NULL;
 712 
 713     // Invariant: after clearing _succ a contending thread
 714     // *must* retry  _owner before parking.
 715     OrderAccess::fence();
 716 
 717     // This PerfData object can be used in parallel with a safepoint.
 718     // See the work around in PerfDataManager::destroy().
 719     OM_PERFDATA_OP(FutileWakeups, inc());
 720   }
 721 
 722   // Self has acquired the lock -- Unlink Self from the cxq or EntryList .
 723   // Normally we&#39;ll find Self on the EntryList.
 724   // Unlinking from the EntryList is constant-time and atomic-free.
 725   // From the perspective of the lock owner (this thread), the
 726   // EntryList is stable and cxq is prepend-only.
 727   // The head of cxq is volatile but the interior is stable.
 728   // In addition, Self.TState is stable.
 729 
 730   assert(_owner == Self, &quot;invariant&quot;);
 731   assert(((oop)(object()))-&gt;mark() == markWord::encode(this), &quot;invariant&quot;);
 732   UnlinkAfterAcquire(Self, SelfNode);
 733   if (_succ == Self) _succ = NULL;
 734   assert(_succ != Self, &quot;invariant&quot;);
 735   SelfNode-&gt;TState = ObjectWaiter::TS_RUN;
 736   OrderAccess::fence();      // see comments at the end of EnterI()
 737 }
 738 
 739 // By convention we unlink a contending thread from EntryList|cxq immediately
 740 // after the thread acquires the lock in ::enter().  Equally, we could defer
 741 // unlinking the thread until ::exit()-time.
 742 
 743 void ObjectMonitor::UnlinkAfterAcquire(Thread *Self, ObjectWaiter *SelfNode) {
 744   assert(_owner == Self, &quot;invariant&quot;);
 745   assert(SelfNode-&gt;_thread == Self, &quot;invariant&quot;);
 746 
 747   if (SelfNode-&gt;TState == ObjectWaiter::TS_ENTER) {
 748     // Normal case: remove Self from the DLL EntryList .
 749     // This is a constant-time operation.
 750     ObjectWaiter * nxt = SelfNode-&gt;_next;
 751     ObjectWaiter * prv = SelfNode-&gt;_prev;
 752     if (nxt != NULL) nxt-&gt;_prev = prv;
 753     if (prv != NULL) prv-&gt;_next = nxt;
 754     if (SelfNode == _EntryList) _EntryList = nxt;
 755     assert(nxt == NULL || nxt-&gt;TState == ObjectWaiter::TS_ENTER, &quot;invariant&quot;);
 756     assert(prv == NULL || prv-&gt;TState == ObjectWaiter::TS_ENTER, &quot;invariant&quot;);
 757   } else {
 758     assert(SelfNode-&gt;TState == ObjectWaiter::TS_CXQ, &quot;invariant&quot;);
 759     // Inopportune interleaving -- Self is still on the cxq.
 760     // This usually means the enqueue of self raced an exiting thread.
 761     // Normally we&#39;ll find Self near the front of the cxq, so
 762     // dequeueing is typically fast.  If needbe we can accelerate
 763     // this with some MCS/CHL-like bidirectional list hints and advisory
 764     // back-links so dequeueing from the interior will normally operate
 765     // in constant-time.
 766     // Dequeue Self from either the head (with CAS) or from the interior
 767     // with a linear-time scan and normal non-atomic memory operations.
 768     // CONSIDER: if Self is on the cxq then simply drain cxq into EntryList
 769     // and then unlink Self from EntryList.  We have to drain eventually,
 770     // so it might as well be now.
 771 
 772     ObjectWaiter * v = _cxq;
 773     assert(v != NULL, &quot;invariant&quot;);
 774     if (v != SelfNode || Atomic::cmpxchg(&amp;_cxq, v, SelfNode-&gt;_next) != v) {
 775       // The CAS above can fail from interference IFF a &quot;RAT&quot; arrived.
 776       // In that case Self must be in the interior and can no longer be
 777       // at the head of cxq.
 778       if (v == SelfNode) {
 779         assert(_cxq != v, &quot;invariant&quot;);
 780         v = _cxq;          // CAS above failed - start scan at head of list
 781       }
 782       ObjectWaiter * p;
 783       ObjectWaiter * q = NULL;
 784       for (p = v; p != NULL &amp;&amp; p != SelfNode; p = p-&gt;_next) {
 785         q = p;
 786         assert(p-&gt;TState == ObjectWaiter::TS_CXQ, &quot;invariant&quot;);
 787       }
 788       assert(v != SelfNode, &quot;invariant&quot;);
 789       assert(p == SelfNode, &quot;Node not found on cxq&quot;);
 790       assert(p != _cxq, &quot;invariant&quot;);
 791       assert(q != NULL, &quot;invariant&quot;);
 792       assert(q-&gt;_next == p, &quot;invariant&quot;);
 793       q-&gt;_next = p-&gt;_next;
 794     }
 795   }
 796 
 797 #ifdef ASSERT
 798   // Diagnostic hygiene ...
 799   SelfNode-&gt;_prev  = (ObjectWaiter *) 0xBAD;
 800   SelfNode-&gt;_next  = (ObjectWaiter *) 0xBAD;
 801   SelfNode-&gt;TState = ObjectWaiter::TS_RUN;
 802 #endif
 803 }
 804 
 805 // -----------------------------------------------------------------------------
 806 // Exit support
 807 //
 808 // exit()
 809 // ~~~~~~
 810 // Note that the collector can&#39;t reclaim the objectMonitor or deflate
 811 // the object out from underneath the thread calling ::exit() as the
 812 // thread calling ::exit() never transitions to a stable state.
 813 // This inhibits GC, which in turn inhibits asynchronous (and
 814 // inopportune) reclamation of &quot;this&quot;.
 815 //
 816 // We&#39;d like to assert that: (THREAD-&gt;thread_state() != _thread_blocked) ;
 817 // There&#39;s one exception to the claim above, however.  EnterI() can call
 818 // exit() to drop a lock if the acquirer has been externally suspended.
 819 // In that case exit() is called with _thread_state as _thread_blocked,
 820 // but the monitor&#39;s _contentions field is &gt; 0, which inhibits reclamation.
 821 //
 822 // 1-0 exit
 823 // ~~~~~~~~
 824 // ::exit() uses a canonical 1-1 idiom with a MEMBAR although some of
 825 // the fast-path operators have been optimized so the common ::exit()
 826 // operation is 1-0, e.g., see macroAssembler_x86.cpp: fast_unlock().
 827 // The code emitted by fast_unlock() elides the usual MEMBAR.  This
 828 // greatly improves latency -- MEMBAR and CAS having considerable local
 829 // latency on modern processors -- but at the cost of &quot;stranding&quot;.  Absent the
 830 // MEMBAR, a thread in fast_unlock() can race a thread in the slow
 831 // ::enter() path, resulting in the entering thread being stranding
 832 // and a progress-liveness failure.   Stranding is extremely rare.
 833 // We use timers (timed park operations) &amp; periodic polling to detect
 834 // and recover from stranding.  Potentially stranded threads periodically
 835 // wake up and poll the lock.  See the usage of the _Responsible variable.
 836 //
 837 // The CAS() in enter provides for safety and exclusion, while the CAS or
 838 // MEMBAR in exit provides for progress and avoids stranding.  1-0 locking
 839 // eliminates the CAS/MEMBAR from the exit path, but it admits stranding.
 840 // We detect and recover from stranding with timers.
 841 //
 842 // If a thread transiently strands it&#39;ll park until (a) another
 843 // thread acquires the lock and then drops the lock, at which time the
 844 // exiting thread will notice and unpark the stranded thread, or, (b)
 845 // the timer expires.  If the lock is high traffic then the stranding latency
 846 // will be low due to (a).  If the lock is low traffic then the odds of
 847 // stranding are lower, although the worst-case stranding latency
 848 // is longer.  Critically, we don&#39;t want to put excessive load in the
 849 // platform&#39;s timer subsystem.  We want to minimize both the timer injection
 850 // rate (timers created/sec) as well as the number of timers active at
 851 // any one time.  (more precisely, we want to minimize timer-seconds, which is
 852 // the integral of the # of active timers at any instant over time).
 853 // Both impinge on OS scalability.  Given that, at most one thread parked on
 854 // a monitor will use a timer.
 855 //
 856 // There is also the risk of a futile wake-up. If we drop the lock
 857 // another thread can reacquire the lock immediately, and we can
 858 // then wake a thread unnecessarily. This is benign, and we&#39;ve
 859 // structured the code so the windows are short and the frequency
 860 // of such futile wakups is low.
 861 
 862 void ObjectMonitor::exit(bool not_suspended, TRAPS) {
 863   Thread* const Self = THREAD;
 864   void* cur = Atomic::load(&amp;_owner);
 865   if (THREAD != cur) {
 866     if (THREAD-&gt;is_lock_owned((address)cur)) {
 867       assert(_recursions == 0, &quot;invariant&quot;);
 868       set_owner_from_BasicLock(cur, Self);  // Convert from BasicLock* to Thread*.
 869       _recursions = 0;
 870     } else {
 871       // Apparent unbalanced locking ...
 872       // Naively we&#39;d like to throw IllegalMonitorStateException.
 873       // As a practical matter we can neither allocate nor throw an
 874       // exception as ::exit() can be called from leaf routines.
 875       // see x86_32.ad Fast_Unlock() and the I1 and I2 properties.
 876       // Upon deeper reflection, however, in a properly run JVM the only
 877       // way we should encounter this situation is in the presence of
 878       // unbalanced JNI locking. TODO: CheckJNICalls.
 879       // See also: CR4414101
 880 #ifdef ASSERT
 881       LogStreamHandle(Error, monitorinflation) lsh;
 882       lsh.print_cr(&quot;ERROR: ObjectMonitor::exit(): thread=&quot; INTPTR_FORMAT
 883                     &quot; is exiting an ObjectMonitor it does not own.&quot;, p2i(THREAD));
 884       lsh.print_cr(&quot;The imbalance is possibly caused by JNI locking.&quot;);
 885       print_debug_style_on(&amp;lsh);
 886 #endif
 887       assert(false, &quot;Non-balanced monitor enter/exit!&quot;);
 888       return;
 889     }
 890   }
 891 
 892   if (_recursions != 0) {
 893     _recursions--;        // this is simple recursive enter
 894     return;
 895   }
 896 
 897   // Invariant: after setting Responsible=null an thread must execute
 898   // a MEMBAR or other serializing instruction before fetching EntryList|cxq.
 899   _Responsible = NULL;
 900 
 901 #if INCLUDE_JFR
 902   // get the owner&#39;s thread id for the MonitorEnter event
 903   // if it is enabled and the thread isn&#39;t suspended
 904   if (not_suspended &amp;&amp; EventJavaMonitorEnter::is_enabled()) {
 905     _previous_owner_tid = JFR_THREAD_ID(Self);
 906   }
 907 #endif
 908 
 909   for (;;) {
 910     assert(THREAD == _owner, &quot;invariant&quot;);
 911 
 912     // Drop the lock.
 913     // release semantics: prior loads and stores from within the critical section
 914     // must not float (reorder) past the following store that drops the lock.
 915     // Uses a storeload to separate release_store(owner) from the
 916     // successor check. The try_set_owner() below uses cmpxchg() so
 917     // we get the fence down there.
 918     release_clear_owner(Self);
 919     OrderAccess::storeload();
 920 
 921     if ((intptr_t(_EntryList)|intptr_t(_cxq)) == 0 || _succ != NULL) {
 922       return;
 923     }
 924     // Other threads are blocked trying to acquire the lock.
 925 
 926     // Normally the exiting thread is responsible for ensuring succession,
 927     // but if other successors are ready or other entering threads are spinning
 928     // then this thread can simply store NULL into _owner and exit without
 929     // waking a successor.  The existence of spinners or ready successors
 930     // guarantees proper succession (liveness).  Responsibility passes to the
 931     // ready or running successors.  The exiting thread delegates the duty.
 932     // More precisely, if a successor already exists this thread is absolved
 933     // of the responsibility of waking (unparking) one.
 934     //
 935     // The _succ variable is critical to reducing futile wakeup frequency.
 936     // _succ identifies the &quot;heir presumptive&quot; thread that has been made
 937     // ready (unparked) but that has not yet run.  We need only one such
 938     // successor thread to guarantee progress.
 939     // See http://www.usenix.org/events/jvm01/full_papers/dice/dice.pdf
 940     // section 3.3 &quot;Futile Wakeup Throttling&quot; for details.
 941     //
 942     // Note that spinners in Enter() also set _succ non-null.
 943     // In the current implementation spinners opportunistically set
 944     // _succ so that exiting threads might avoid waking a successor.
 945     // Another less appealing alternative would be for the exiting thread
 946     // to drop the lock and then spin briefly to see if a spinner managed
 947     // to acquire the lock.  If so, the exiting thread could exit
 948     // immediately without waking a successor, otherwise the exiting
 949     // thread would need to dequeue and wake a successor.
 950     // (Note that we&#39;d need to make the post-drop spin short, but no
 951     // shorter than the worst-case round-trip cache-line migration time.
 952     // The dropped lock needs to become visible to the spinner, and then
 953     // the acquisition of the lock by the spinner must become visible to
 954     // the exiting thread).
 955 
 956     // It appears that an heir-presumptive (successor) must be made ready.
 957     // Only the current lock owner can manipulate the EntryList or
 958     // drain _cxq, so we need to reacquire the lock.  If we fail
 959     // to reacquire the lock the responsibility for ensuring succession
 960     // falls to the new owner.
 961     //
 962     if (try_set_owner_from(NULL, Self) != NULL) {
 963       return;
 964     }
 965 
 966     guarantee(_owner == THREAD, &quot;invariant&quot;);
 967 
 968     ObjectWaiter * w = NULL;
 969 
 970     w = _EntryList;
 971     if (w != NULL) {
 972       // I&#39;d like to write: guarantee (w-&gt;_thread != Self).
 973       // But in practice an exiting thread may find itself on the EntryList.
 974       // Let&#39;s say thread T1 calls O.wait().  Wait() enqueues T1 on O&#39;s waitset and
 975       // then calls exit().  Exit release the lock by setting O._owner to NULL.
 976       // Let&#39;s say T1 then stalls.  T2 acquires O and calls O.notify().  The
 977       // notify() operation moves T1 from O&#39;s waitset to O&#39;s EntryList. T2 then
 978       // release the lock &quot;O&quot;.  T2 resumes immediately after the ST of null into
 979       // _owner, above.  T2 notices that the EntryList is populated, so it
 980       // reacquires the lock and then finds itself on the EntryList.
 981       // Given all that, we have to tolerate the circumstance where &quot;w&quot; is
 982       // associated with Self.
 983       assert(w-&gt;TState == ObjectWaiter::TS_ENTER, &quot;invariant&quot;);
 984       ExitEpilog(Self, w);
 985       return;
 986     }
 987 
 988     // If we find that both _cxq and EntryList are null then just
 989     // re-run the exit protocol from the top.
 990     w = _cxq;
 991     if (w == NULL) continue;
 992 
 993     // Drain _cxq into EntryList - bulk transfer.
 994     // First, detach _cxq.
 995     // The following loop is tantamount to: w = swap(&amp;cxq, NULL)
 996     for (;;) {
 997       assert(w != NULL, &quot;Invariant&quot;);
 998       ObjectWaiter * u = Atomic::cmpxchg(&amp;_cxq, w, (ObjectWaiter*)NULL);
 999       if (u == w) break;
1000       w = u;
1001     }
1002 
1003     assert(w != NULL, &quot;invariant&quot;);
1004     assert(_EntryList == NULL, &quot;invariant&quot;);
1005 
1006     // Convert the LIFO SLL anchored by _cxq into a DLL.
1007     // The list reorganization step operates in O(LENGTH(w)) time.
1008     // It&#39;s critical that this step operate quickly as
1009     // &quot;Self&quot; still holds the outer-lock, restricting parallelism
1010     // and effectively lengthening the critical section.
1011     // Invariant: s chases t chases u.
1012     // TODO-FIXME: consider changing EntryList from a DLL to a CDLL so
1013     // we have faster access to the tail.
1014 
1015     _EntryList = w;
1016     ObjectWaiter * q = NULL;
1017     ObjectWaiter * p;
1018     for (p = w; p != NULL; p = p-&gt;_next) {
1019       guarantee(p-&gt;TState == ObjectWaiter::TS_CXQ, &quot;Invariant&quot;);
1020       p-&gt;TState = ObjectWaiter::TS_ENTER;
1021       p-&gt;_prev = q;
1022       q = p;
1023     }
1024 
1025     // In 1-0 mode we need: ST EntryList; MEMBAR #storestore; ST _owner = NULL
1026     // The MEMBAR is satisfied by the release_store() operation in ExitEpilog().
1027 
1028     // See if we can abdicate to a spinner instead of waking a thread.
1029     // A primary goal of the implementation is to reduce the
1030     // context-switch rate.
1031     if (_succ != NULL) continue;
1032 
1033     w = _EntryList;
1034     if (w != NULL) {
1035       guarantee(w-&gt;TState == ObjectWaiter::TS_ENTER, &quot;invariant&quot;);
1036       ExitEpilog(Self, w);
1037       return;
1038     }
1039   }
1040 }
1041 
1042 // ExitSuspendEquivalent:
1043 // A faster alternate to handle_special_suspend_equivalent_condition()
1044 //
1045 // handle_special_suspend_equivalent_condition() unconditionally
1046 // acquires the SR_lock.  On some platforms uncontended MutexLocker()
1047 // operations have high latency.  Note that in ::enter() we call HSSEC
1048 // while holding the monitor, so we effectively lengthen the critical sections.
1049 //
1050 // There are a number of possible solutions:
1051 //
1052 // A.  To ameliorate the problem we might also defer state transitions
1053 //     to as late as possible -- just prior to parking.
1054 //     Given that, we&#39;d call HSSEC after having returned from park(),
1055 //     but before attempting to acquire the monitor.  This is only a
1056 //     partial solution.  It avoids calling HSSEC while holding the
1057 //     monitor (good), but it still increases successor reacquisition latency --
1058 //     the interval between unparking a successor and the time the successor
1059 //     resumes and retries the lock.  See ReenterI(), which defers state transitions.
1060 //     If we use this technique we can also avoid EnterI()-exit() loop
1061 //     in ::enter() where we iteratively drop the lock and then attempt
1062 //     to reacquire it after suspending.
1063 //
1064 // B.  In the future we might fold all the suspend bits into a
1065 //     composite per-thread suspend flag and then update it with CAS().
1066 //     Alternately, a Dekker-like mechanism with multiple variables
1067 //     would suffice:
1068 //       ST Self-&gt;_suspend_equivalent = false
1069 //       MEMBAR
1070 //       LD Self_&gt;_suspend_flags
1071 
1072 bool ObjectMonitor::ExitSuspendEquivalent(JavaThread * jSelf) {
1073   return jSelf-&gt;handle_special_suspend_equivalent_condition();
1074 }
1075 
1076 
1077 void ObjectMonitor::ExitEpilog(Thread * Self, ObjectWaiter * Wakee) {
1078   assert(_owner == Self, &quot;invariant&quot;);
1079 
1080   // Exit protocol:
1081   // 1. ST _succ = wakee
1082   // 2. membar #loadstore|#storestore;
1083   // 2. ST _owner = NULL
1084   // 3. unpark(wakee)
1085 
1086   _succ = Wakee-&gt;_thread;
1087   ParkEvent * Trigger = Wakee-&gt;_event;
1088 
1089   // Hygiene -- once we&#39;ve set _owner = NULL we can&#39;t safely dereference Wakee again.
1090   // The thread associated with Wakee may have grabbed the lock and &quot;Wakee&quot; may be
1091   // out-of-scope (non-extant).
1092   Wakee  = NULL;
1093 
1094   // Drop the lock
1095   // Uses a fence to separate release_store(owner) from the LD in unpark().
1096   release_clear_owner(Self);
1097   OrderAccess::fence();
1098 
1099   DTRACE_MONITOR_PROBE(contended__exit, this, object(), Self);
1100   Trigger-&gt;unpark();
1101 
1102   // Maintain stats and report events to JVMTI
1103   OM_PERFDATA_OP(Parks, inc());
1104 }
1105 
1106 
1107 // -----------------------------------------------------------------------------
1108 // Class Loader deadlock handling.
1109 //
1110 // complete_exit exits a lock returning recursion count
1111 // complete_exit/reenter operate as a wait without waiting
1112 // complete_exit requires an inflated monitor
1113 // The _owner field is not always the Thread addr even with an
1114 // inflated monitor, e.g. the monitor can be inflated by a non-owning
1115 // thread due to contention.
1116 intx ObjectMonitor::complete_exit(TRAPS) {
1117   Thread * const Self = THREAD;
1118   assert(Self-&gt;is_Java_thread(), &quot;Must be Java thread!&quot;);
1119   JavaThread *jt = (JavaThread *)THREAD;
1120 
1121   assert(InitDone, &quot;Unexpectedly not initialized&quot;);
1122 
1123   void* cur = Atomic::load(&amp;_owner);
1124   if (THREAD != cur) {
1125     if (THREAD-&gt;is_lock_owned((address)cur)) {
1126       assert(_recursions == 0, &quot;internal state error&quot;);
1127       set_owner_from_BasicLock(cur, Self);  // Convert from BasicLock* to Thread*.
1128       _recursions = 0;
1129     }
1130   }
1131 
1132   guarantee(Self == _owner, &quot;complete_exit not owner&quot;);
1133   intx save = _recursions; // record the old recursion count
1134   _recursions = 0;        // set the recursion level to be 0
1135   exit(true, Self);           // exit the monitor
1136   guarantee(_owner != Self, &quot;invariant&quot;);
1137   return save;
1138 }
1139 
1140 // reenter() enters a lock and sets recursion count
1141 // complete_exit/reenter operate as a wait without waiting
1142 void ObjectMonitor::reenter(intx recursions, TRAPS) {
1143   Thread * const Self = THREAD;
1144   assert(Self-&gt;is_Java_thread(), &quot;Must be Java thread!&quot;);
1145   JavaThread *jt = (JavaThread *)THREAD;
1146 
1147   guarantee(_owner != Self, &quot;reenter already owner&quot;);
1148   enter(THREAD);       // enter the monitor
1149   guarantee(_recursions == 0, &quot;reenter recursion&quot;);
1150   _recursions = recursions;
1151   return;
1152 }
1153 
1154 // Checks that the current THREAD owns this monitor and causes an
1155 // immediate return if it doesn&#39;t. We don&#39;t use the CHECK macro
1156 // because we want the IMSE to be the only exception that is thrown
1157 // from the call site when false is returned. Any other pending
1158 // exception is ignored.
1159 #define CHECK_OWNER()                                                  \
1160   do {                                                                 \
1161     if (!check_owner(THREAD)) {                                        \
1162        assert(HAS_PENDING_EXCEPTION, &quot;expected a pending IMSE here.&quot;); \
1163        return;                                                         \
1164      }                                                                 \
1165   } while (false)
1166 
1167 // Returns true if the specified thread owns the ObjectMonitor.
1168 // Otherwise returns false and throws IllegalMonitorStateException
1169 // (IMSE). If there is a pending exception and the specified thread
1170 // is not the owner, that exception will be replaced by the IMSE.
1171 bool ObjectMonitor::check_owner(Thread* THREAD) {
1172   void* cur = Atomic::load(&amp;_owner);
1173   if (cur == THREAD) {
1174     return true;
1175   }
1176   if (THREAD-&gt;is_lock_owned((address)cur)) {
1177     set_owner_from_BasicLock(cur, THREAD);  // Convert from BasicLock* to Thread*.
1178     _recursions = 0;
1179     return true;
1180   }
1181   THROW_MSG_(vmSymbols::java_lang_IllegalMonitorStateException(),
1182              &quot;current thread is not owner&quot;, false);
1183 }
1184 
1185 static void post_monitor_wait_event(EventJavaMonitorWait* event,
1186                                     ObjectMonitor* monitor,
1187                                     jlong notifier_tid,
1188                                     jlong timeout,
1189                                     bool timedout) {
1190   assert(event != NULL, &quot;invariant&quot;);
1191   assert(monitor != NULL, &quot;invariant&quot;);
1192   event-&gt;set_monitorClass(((oop)monitor-&gt;object())-&gt;klass());
1193   event-&gt;set_timeout(timeout);
1194   event-&gt;set_address((uintptr_t)monitor-&gt;object_addr());
1195   event-&gt;set_notifier(notifier_tid);
1196   event-&gt;set_timedOut(timedout);
1197   event-&gt;commit();
1198 }
1199 
1200 // -----------------------------------------------------------------------------
1201 // Wait/Notify/NotifyAll
1202 //
1203 // Note: a subset of changes to ObjectMonitor::wait()
1204 // will need to be replicated in complete_exit
1205 void ObjectMonitor::wait(jlong millis, bool interruptible, TRAPS) {
1206   Thread * const Self = THREAD;
1207   assert(Self-&gt;is_Java_thread(), &quot;Must be Java thread!&quot;);
1208   JavaThread *jt = (JavaThread *)THREAD;
1209 
1210   assert(InitDone, &quot;Unexpectedly not initialized&quot;);
1211 
1212   CHECK_OWNER();  // Throws IMSE if not owner.
1213 
1214   EventJavaMonitorWait event;
1215 
1216   // check for a pending interrupt
1217   if (interruptible &amp;&amp; jt-&gt;is_interrupted(true) &amp;&amp; !HAS_PENDING_EXCEPTION) {
1218     // post monitor waited event.  Note that this is past-tense, we are done waiting.
1219     if (JvmtiExport::should_post_monitor_waited()) {
1220       // Note: &#39;false&#39; parameter is passed here because the
1221       // wait was not timed out due to thread interrupt.
1222       JvmtiExport::post_monitor_waited(jt, this, false);
1223 
1224       // In this short circuit of the monitor wait protocol, the
1225       // current thread never drops ownership of the monitor and
1226       // never gets added to the wait queue so the current thread
1227       // cannot be made the successor. This means that the
1228       // JVMTI_EVENT_MONITOR_WAITED event handler cannot accidentally
1229       // consume an unpark() meant for the ParkEvent associated with
1230       // this ObjectMonitor.
1231     }
1232     if (event.should_commit()) {
1233       post_monitor_wait_event(&amp;event, this, 0, millis, false);
1234     }
1235     THROW(vmSymbols::java_lang_InterruptedException());
1236     return;
1237   }
1238 
1239   assert(Self-&gt;_Stalled == 0, &quot;invariant&quot;);
1240   Self-&gt;_Stalled = intptr_t(this);
1241   jt-&gt;set_current_waiting_monitor(this);
1242 
1243   // create a node to be put into the queue
1244   // Critically, after we reset() the event but prior to park(), we must check
1245   // for a pending interrupt.
1246   ObjectWaiter node(Self);
1247   node.TState = ObjectWaiter::TS_WAIT;
1248   Self-&gt;_ParkEvent-&gt;reset();
1249   OrderAccess::fence();          // ST into Event; membar ; LD interrupted-flag
1250 
1251   // Enter the waiting queue, which is a circular doubly linked list in this case
1252   // but it could be a priority queue or any data structure.
1253   // _WaitSetLock protects the wait queue.  Normally the wait queue is accessed only
1254   // by the the owner of the monitor *except* in the case where park()
1255   // returns because of a timeout of interrupt.  Contention is exceptionally rare
1256   // so we use a simple spin-lock instead of a heavier-weight blocking lock.
1257 
1258   Thread::SpinAcquire(&amp;_WaitSetLock, &quot;WaitSet - add&quot;);
1259   AddWaiter(&amp;node);
1260   Thread::SpinRelease(&amp;_WaitSetLock);
1261 
1262   _Responsible = NULL;
1263 
1264   intx save = _recursions;     // record the old recursion count
1265   _waiters++;                  // increment the number of waiters
1266   _recursions = 0;             // set the recursion level to be 1
1267   exit(true, Self);                    // exit the monitor
1268   guarantee(_owner != Self, &quot;invariant&quot;);
1269 
1270   // The thread is on the WaitSet list - now park() it.
1271   // On MP systems it&#39;s conceivable that a brief spin before we park
1272   // could be profitable.
1273   //
1274   // TODO-FIXME: change the following logic to a loop of the form
1275   //   while (!timeout &amp;&amp; !interrupted &amp;&amp; _notified == 0) park()
1276 
1277   int ret = OS_OK;
1278   int WasNotified = 0;
1279 
1280   // Need to check interrupt state whilst still _thread_in_vm
1281   bool interrupted = interruptible &amp;&amp; jt-&gt;is_interrupted(false);
1282 
1283   { // State transition wrappers
1284     OSThread* osthread = Self-&gt;osthread();
1285     OSThreadWaitState osts(osthread, true);
1286     {
1287       ThreadBlockInVM tbivm(jt);
1288       // Thread is in thread_blocked state and oop access is unsafe.
1289       jt-&gt;set_suspend_equivalent();
1290 
1291       if (interrupted || HAS_PENDING_EXCEPTION) {
1292         // Intentionally empty
1293       } else if (node._notified == 0) {
1294         if (millis &lt;= 0) {
1295           Self-&gt;_ParkEvent-&gt;park();
1296         } else {
1297           ret = Self-&gt;_ParkEvent-&gt;park(millis);
1298         }
1299       }
1300 
1301       // were we externally suspended while we were waiting?
1302       if (ExitSuspendEquivalent (jt)) {
1303         // TODO-FIXME: add -- if succ == Self then succ = null.
1304         jt-&gt;java_suspend_self();
1305       }
1306 
1307     } // Exit thread safepoint: transition _thread_blocked -&gt; _thread_in_vm
1308 
1309     // Node may be on the WaitSet, the EntryList (or cxq), or in transition
1310     // from the WaitSet to the EntryList.
1311     // See if we need to remove Node from the WaitSet.
1312     // We use double-checked locking to avoid grabbing _WaitSetLock
1313     // if the thread is not on the wait queue.
1314     //
1315     // Note that we don&#39;t need a fence before the fetch of TState.
1316     // In the worst case we&#39;ll fetch a old-stale value of TS_WAIT previously
1317     // written by the is thread. (perhaps the fetch might even be satisfied
1318     // by a look-aside into the processor&#39;s own store buffer, although given
1319     // the length of the code path between the prior ST and this load that&#39;s
1320     // highly unlikely).  If the following LD fetches a stale TS_WAIT value
1321     // then we&#39;ll acquire the lock and then re-fetch a fresh TState value.
1322     // That is, we fail toward safety.
1323 
1324     if (node.TState == ObjectWaiter::TS_WAIT) {
1325       Thread::SpinAcquire(&amp;_WaitSetLock, &quot;WaitSet - unlink&quot;);
1326       if (node.TState == ObjectWaiter::TS_WAIT) {
1327         DequeueSpecificWaiter(&amp;node);       // unlink from WaitSet
1328         assert(node._notified == 0, &quot;invariant&quot;);
1329         node.TState = ObjectWaiter::TS_RUN;
1330       }
1331       Thread::SpinRelease(&amp;_WaitSetLock);
1332     }
1333 
1334     // The thread is now either on off-list (TS_RUN),
1335     // on the EntryList (TS_ENTER), or on the cxq (TS_CXQ).
1336     // The Node&#39;s TState variable is stable from the perspective of this thread.
1337     // No other threads will asynchronously modify TState.
1338     guarantee(node.TState != ObjectWaiter::TS_WAIT, &quot;invariant&quot;);
1339     OrderAccess::loadload();
1340     if (_succ == Self) _succ = NULL;
1341     WasNotified = node._notified;
1342 
1343     // Reentry phase -- reacquire the monitor.
1344     // re-enter contended monitor after object.wait().
1345     // retain OBJECT_WAIT state until re-enter successfully completes
1346     // Thread state is thread_in_vm and oop access is again safe,
1347     // although the raw address of the object may have changed.
1348     // (Don&#39;t cache naked oops over safepoints, of course).
1349 
1350     // post monitor waited event. Note that this is past-tense, we are done waiting.
1351     if (JvmtiExport::should_post_monitor_waited()) {
1352       JvmtiExport::post_monitor_waited(jt, this, ret == OS_TIMEOUT);
1353 
1354       if (node._notified != 0 &amp;&amp; _succ == Self) {
1355         // In this part of the monitor wait-notify-reenter protocol it
1356         // is possible (and normal) for another thread to do a fastpath
1357         // monitor enter-exit while this thread is still trying to get
1358         // to the reenter portion of the protocol.
1359         //
1360         // The ObjectMonitor was notified and the current thread is
1361         // the successor which also means that an unpark() has already
1362         // been done. The JVMTI_EVENT_MONITOR_WAITED event handler can
1363         // consume the unpark() that was done when the successor was
1364         // set because the same ParkEvent is shared between Java
1365         // monitors and JVM/TI RawMonitors (for now).
1366         //
1367         // We redo the unpark() to ensure forward progress, i.e., we
1368         // don&#39;t want all pending threads hanging (parked) with none
1369         // entering the unlocked monitor.
1370         node._event-&gt;unpark();
1371       }
1372     }
1373 
1374     if (event.should_commit()) {
1375       post_monitor_wait_event(&amp;event, this, node._notifier_tid, millis, ret == OS_TIMEOUT);
1376     }
1377 
1378     OrderAccess::fence();
1379 
1380     assert(Self-&gt;_Stalled != 0, &quot;invariant&quot;);
1381     Self-&gt;_Stalled = 0;
1382 
1383     assert(_owner != Self, &quot;invariant&quot;);
1384     ObjectWaiter::TStates v = node.TState;
1385     if (v == ObjectWaiter::TS_RUN) {
1386       enter(Self);
1387     } else {
1388       guarantee(v == ObjectWaiter::TS_ENTER || v == ObjectWaiter::TS_CXQ, &quot;invariant&quot;);
1389       ReenterI(Self, &amp;node);
1390       node.wait_reenter_end(this);
1391     }
1392 
1393     // Self has reacquired the lock.
1394     // Lifecycle - the node representing Self must not appear on any queues.
1395     // Node is about to go out-of-scope, but even if it were immortal we wouldn&#39;t
1396     // want residual elements associated with this thread left on any lists.
1397     guarantee(node.TState == ObjectWaiter::TS_RUN, &quot;invariant&quot;);
1398     assert(_owner == Self, &quot;invariant&quot;);
1399     assert(_succ != Self, &quot;invariant&quot;);
1400   } // OSThreadWaitState()
1401 
1402   jt-&gt;set_current_waiting_monitor(NULL);
1403 
1404   guarantee(_recursions == 0, &quot;invariant&quot;);
1405   _recursions = save;     // restore the old recursion count
1406   _waiters--;             // decrement the number of waiters
1407 
1408   // Verify a few postconditions
1409   assert(_owner == Self, &quot;invariant&quot;);
1410   assert(_succ != Self, &quot;invariant&quot;);
1411   assert(((oop)(object()))-&gt;mark() == markWord::encode(this), &quot;invariant&quot;);
1412 
1413   // check if the notification happened
1414   if (!WasNotified) {
1415     // no, it could be timeout or Thread.interrupt() or both
1416     // check for interrupt event, otherwise it is timeout
1417     if (interruptible &amp;&amp; jt-&gt;is_interrupted(true) &amp;&amp; !HAS_PENDING_EXCEPTION) {
1418       THROW(vmSymbols::java_lang_InterruptedException());
1419     }
1420   }
1421 
1422   // NOTE: Spurious wake up will be consider as timeout.
1423   // Monitor notify has precedence over thread interrupt.
1424 }
1425 
1426 
1427 // Consider:
1428 // If the lock is cool (cxq == null &amp;&amp; succ == null) and we&#39;re on an MP system
1429 // then instead of transferring a thread from the WaitSet to the EntryList
1430 // we might just dequeue a thread from the WaitSet and directly unpark() it.
1431 
1432 void ObjectMonitor::INotify(Thread * Self) {
1433   Thread::SpinAcquire(&amp;_WaitSetLock, &quot;WaitSet - notify&quot;);
1434   ObjectWaiter * iterator = DequeueWaiter();
1435   if (iterator != NULL) {
1436     guarantee(iterator-&gt;TState == ObjectWaiter::TS_WAIT, &quot;invariant&quot;);
1437     guarantee(iterator-&gt;_notified == 0, &quot;invariant&quot;);
1438     // Disposition - what might we do with iterator ?
1439     // a.  add it directly to the EntryList - either tail (policy == 1)
1440     //     or head (policy == 0).
1441     // b.  push it onto the front of the _cxq (policy == 2).
1442     // For now we use (b).
1443 
1444     iterator-&gt;TState = ObjectWaiter::TS_ENTER;
1445 
1446     iterator-&gt;_notified = 1;
1447     iterator-&gt;_notifier_tid = JFR_THREAD_ID(Self);
1448 
1449     ObjectWaiter * list = _EntryList;
1450     if (list != NULL) {
1451       assert(list-&gt;_prev == NULL, &quot;invariant&quot;);
1452       assert(list-&gt;TState == ObjectWaiter::TS_ENTER, &quot;invariant&quot;);
1453       assert(list != iterator, &quot;invariant&quot;);
1454     }
1455 
1456     // prepend to cxq
1457     if (list == NULL) {
1458       iterator-&gt;_next = iterator-&gt;_prev = NULL;
1459       _EntryList = iterator;
1460     } else {
1461       iterator-&gt;TState = ObjectWaiter::TS_CXQ;
1462       for (;;) {
1463         ObjectWaiter * front = _cxq;
1464         iterator-&gt;_next = front;
1465         if (Atomic::cmpxchg(&amp;_cxq, front, iterator) == front) {
1466           break;
1467         }
1468       }
1469     }
1470 
1471     // _WaitSetLock protects the wait queue, not the EntryList.  We could
1472     // move the add-to-EntryList operation, above, outside the critical section
1473     // protected by _WaitSetLock.  In practice that&#39;s not useful.  With the
1474     // exception of  wait() timeouts and interrupts the monitor owner
1475     // is the only thread that grabs _WaitSetLock.  There&#39;s almost no contention
1476     // on _WaitSetLock so it&#39;s not profitable to reduce the length of the
1477     // critical section.
1478 
1479     iterator-&gt;wait_reenter_begin(this);
1480   }
1481   Thread::SpinRelease(&amp;_WaitSetLock);
1482 }
1483 
1484 // Consider: a not-uncommon synchronization bug is to use notify() when
1485 // notifyAll() is more appropriate, potentially resulting in stranded
1486 // threads; this is one example of a lost wakeup. A useful diagnostic
1487 // option is to force all notify() operations to behave as notifyAll().
1488 //
1489 // Note: We can also detect many such problems with a &quot;minimum wait&quot;.
1490 // When the &quot;minimum wait&quot; is set to a small non-zero timeout value
1491 // and the program does not hang whereas it did absent &quot;minimum wait&quot;,
1492 // that suggests a lost wakeup bug.
1493 
1494 void ObjectMonitor::notify(TRAPS) {
1495   CHECK_OWNER();  // Throws IMSE if not owner.
1496   if (_WaitSet == NULL) {
1497     return;
1498   }
1499   DTRACE_MONITOR_PROBE(notify, this, object(), THREAD);
1500   INotify(THREAD);
1501   OM_PERFDATA_OP(Notifications, inc(1));
1502 }
1503 
1504 
1505 // The current implementation of notifyAll() transfers the waiters one-at-a-time
1506 // from the waitset to the EntryList. This could be done more efficiently with a
1507 // single bulk transfer but in practice it&#39;s not time-critical. Beware too,
1508 // that in prepend-mode we invert the order of the waiters. Let&#39;s say that the
1509 // waitset is &quot;ABCD&quot; and the EntryList is &quot;XYZ&quot;. After a notifyAll() in prepend
1510 // mode the waitset will be empty and the EntryList will be &quot;DCBAXYZ&quot;.
1511 
1512 void ObjectMonitor::notifyAll(TRAPS) {
1513   CHECK_OWNER();  // Throws IMSE if not owner.
1514   if (_WaitSet == NULL) {
1515     return;
1516   }
1517 
1518   DTRACE_MONITOR_PROBE(notifyAll, this, object(), THREAD);
1519   int tally = 0;
1520   while (_WaitSet != NULL) {
1521     tally++;
1522     INotify(THREAD);
1523   }
1524 
1525   OM_PERFDATA_OP(Notifications, inc(tally));
1526 }
1527 
1528 // -----------------------------------------------------------------------------
1529 // Adaptive Spinning Support
1530 //
1531 // Adaptive spin-then-block - rational spinning
1532 //
1533 // Note that we spin &quot;globally&quot; on _owner with a classic SMP-polite TATAS
1534 // algorithm.  On high order SMP systems it would be better to start with
1535 // a brief global spin and then revert to spinning locally.  In the spirit of MCS/CLH,
1536 // a contending thread could enqueue itself on the cxq and then spin locally
1537 // on a thread-specific variable such as its ParkEvent._Event flag.
1538 // That&#39;s left as an exercise for the reader.  Note that global spinning is
1539 // not problematic on Niagara, as the L2 cache serves the interconnect and
1540 // has both low latency and massive bandwidth.
1541 //
1542 // Broadly, we can fix the spin frequency -- that is, the % of contended lock
1543 // acquisition attempts where we opt to spin --  at 100% and vary the spin count
1544 // (duration) or we can fix the count at approximately the duration of
1545 // a context switch and vary the frequency.   Of course we could also
1546 // vary both satisfying K == Frequency * Duration, where K is adaptive by monitor.
1547 // For a description of &#39;Adaptive spin-then-block mutual exclusion in
1548 // multi-threaded processing,&#39; see U.S. Pat. No. 8046758.
1549 //
1550 // This implementation varies the duration &quot;D&quot;, where D varies with
1551 // the success rate of recent spin attempts. (D is capped at approximately
1552 // length of a round-trip context switch).  The success rate for recent
1553 // spin attempts is a good predictor of the success rate of future spin
1554 // attempts.  The mechanism adapts automatically to varying critical
1555 // section length (lock modality), system load and degree of parallelism.
1556 // D is maintained per-monitor in _SpinDuration and is initialized
1557 // optimistically.  Spin frequency is fixed at 100%.
1558 //
1559 // Note that _SpinDuration is volatile, but we update it without locks
1560 // or atomics.  The code is designed so that _SpinDuration stays within
1561 // a reasonable range even in the presence of races.  The arithmetic
1562 // operations on _SpinDuration are closed over the domain of legal values,
1563 // so at worst a race will install and older but still legal value.
1564 // At the very worst this introduces some apparent non-determinism.
1565 // We might spin when we shouldn&#39;t or vice-versa, but since the spin
1566 // count are relatively short, even in the worst case, the effect is harmless.
1567 //
1568 // Care must be taken that a low &quot;D&quot; value does not become an
1569 // an absorbing state.  Transient spinning failures -- when spinning
1570 // is overall profitable -- should not cause the system to converge
1571 // on low &quot;D&quot; values.  We want spinning to be stable and predictable
1572 // and fairly responsive to change and at the same time we don&#39;t want
1573 // it to oscillate, become metastable, be &quot;too&quot; non-deterministic,
1574 // or converge on or enter undesirable stable absorbing states.
1575 //
1576 // We implement a feedback-based control system -- using past behavior
1577 // to predict future behavior.  We face two issues: (a) if the
1578 // input signal is random then the spin predictor won&#39;t provide optimal
1579 // results, and (b) if the signal frequency is too high then the control
1580 // system, which has some natural response lag, will &quot;chase&quot; the signal.
1581 // (b) can arise from multimodal lock hold times.  Transient preemption
1582 // can also result in apparent bimodal lock hold times.
1583 // Although sub-optimal, neither condition is particularly harmful, as
1584 // in the worst-case we&#39;ll spin when we shouldn&#39;t or vice-versa.
1585 // The maximum spin duration is rather short so the failure modes aren&#39;t bad.
1586 // To be conservative, I&#39;ve tuned the gain in system to bias toward
1587 // _not spinning.  Relatedly, the system can sometimes enter a mode where it
1588 // &quot;rings&quot; or oscillates between spinning and not spinning.  This happens
1589 // when spinning is just on the cusp of profitability, however, so the
1590 // situation is not dire.  The state is benign -- there&#39;s no need to add
1591 // hysteresis control to damp the transition rate between spinning and
1592 // not spinning.
1593 
1594 // Spinning: Fixed frequency (100%), vary duration
1595 int ObjectMonitor::TrySpin(Thread * Self) {
1596   // Dumb, brutal spin.  Good for comparative measurements against adaptive spinning.
1597   int ctr = Knob_FixedSpin;
1598   if (ctr != 0) {
1599     while (--ctr &gt;= 0) {
1600       if (TryLock(Self) &gt; 0) return 1;
1601       SpinPause();
1602     }
1603     return 0;
1604   }
1605 
1606   for (ctr = Knob_PreSpin + 1; --ctr &gt;= 0;) {
1607     if (TryLock(Self) &gt; 0) {
1608       // Increase _SpinDuration ...
1609       // Note that we don&#39;t clamp SpinDuration precisely at SpinLimit.
1610       // Raising _SpurDuration to the poverty line is key.
1611       int x = _SpinDuration;
1612       if (x &lt; Knob_SpinLimit) {
1613         if (x &lt; Knob_Poverty) x = Knob_Poverty;
1614         _SpinDuration = x + Knob_BonusB;
1615       }
1616       return 1;
1617     }
1618     SpinPause();
1619   }
1620 
1621   // Admission control - verify preconditions for spinning
1622   //
1623   // We always spin a little bit, just to prevent _SpinDuration == 0 from
1624   // becoming an absorbing state.  Put another way, we spin briefly to
1625   // sample, just in case the system load, parallelism, contention, or lock
1626   // modality changed.
1627   //
1628   // Consider the following alternative:
1629   // Periodically set _SpinDuration = _SpinLimit and try a long/full
1630   // spin attempt.  &quot;Periodically&quot; might mean after a tally of
1631   // the # of failed spin attempts (or iterations) reaches some threshold.
1632   // This takes us into the realm of 1-out-of-N spinning, where we
1633   // hold the duration constant but vary the frequency.
1634 
1635   ctr = _SpinDuration;
1636   if (ctr &lt;= 0) return 0;
1637 
1638   if (NotRunnable(Self, (Thread *) _owner)) {
1639     return 0;
1640   }
1641 
1642   // We&#39;re good to spin ... spin ingress.
1643   // CONSIDER: use Prefetch::write() to avoid RTS-&gt;RTO upgrades
1644   // when preparing to LD...CAS _owner, etc and the CAS is likely
1645   // to succeed.
1646   if (_succ == NULL) {
1647     _succ = Self;
1648   }
1649   Thread * prv = NULL;
1650 
1651   // There are three ways to exit the following loop:
1652   // 1.  A successful spin where this thread has acquired the lock.
1653   // 2.  Spin failure with prejudice
1654   // 3.  Spin failure without prejudice
1655 
1656   while (--ctr &gt;= 0) {
1657 
1658     // Periodic polling -- Check for pending GC
1659     // Threads may spin while they&#39;re unsafe.
1660     // We don&#39;t want spinning threads to delay the JVM from reaching
1661     // a stop-the-world safepoint or to steal cycles from GC.
1662     // If we detect a pending safepoint we abort in order that
1663     // (a) this thread, if unsafe, doesn&#39;t delay the safepoint, and (b)
1664     // this thread, if safe, doesn&#39;t steal cycles from GC.
1665     // This is in keeping with the &quot;no loitering in runtime&quot; rule.
1666     // We periodically check to see if there&#39;s a safepoint pending.
1667     if ((ctr &amp; 0xFF) == 0) {
1668       if (SafepointMechanism::should_block(Self)) {
1669         goto Abort;           // abrupt spin egress
1670       }
1671       SpinPause();
1672     }
1673 
1674     // Probe _owner with TATAS
1675     // If this thread observes the monitor transition or flicker
1676     // from locked to unlocked to locked, then the odds that this
1677     // thread will acquire the lock in this spin attempt go down
1678     // considerably.  The same argument applies if the CAS fails
1679     // or if we observe _owner change from one non-null value to
1680     // another non-null value.   In such cases we might abort
1681     // the spin without prejudice or apply a &quot;penalty&quot; to the
1682     // spin count-down variable &quot;ctr&quot;, reducing it by 100, say.
1683 
1684     Thread * ox = (Thread *) _owner;
1685     if (ox == NULL) {
1686       ox = (Thread*)try_set_owner_from(NULL, Self);
1687       if (ox == NULL) {
1688         // The CAS succeeded -- this thread acquired ownership
1689         // Take care of some bookkeeping to exit spin state.
1690         if (_succ == Self) {
1691           _succ = NULL;
1692         }
1693 
1694         // Increase _SpinDuration :
1695         // The spin was successful (profitable) so we tend toward
1696         // longer spin attempts in the future.
1697         // CONSIDER: factor &quot;ctr&quot; into the _SpinDuration adjustment.
1698         // If we acquired the lock early in the spin cycle it
1699         // makes sense to increase _SpinDuration proportionally.
1700         // Note that we don&#39;t clamp SpinDuration precisely at SpinLimit.
1701         int x = _SpinDuration;
1702         if (x &lt; Knob_SpinLimit) {
1703           if (x &lt; Knob_Poverty) x = Knob_Poverty;
1704           _SpinDuration = x + Knob_Bonus;
1705         }
1706         return 1;
1707       }
1708 
1709       // The CAS failed ... we can take any of the following actions:
1710       // * penalize: ctr -= CASPenalty
1711       // * exit spin with prejudice -- goto Abort;
1712       // * exit spin without prejudice.
1713       // * Since CAS is high-latency, retry again immediately.
1714       prv = ox;
1715       goto Abort;
1716     }
1717 
1718     // Did lock ownership change hands ?
1719     if (ox != prv &amp;&amp; prv != NULL) {
1720       goto Abort;
1721     }
1722     prv = ox;
1723 
1724     // Abort the spin if the owner is not executing.
1725     // The owner must be executing in order to drop the lock.
1726     // Spinning while the owner is OFFPROC is idiocy.
1727     // Consider: ctr -= RunnablePenalty ;
1728     if (NotRunnable(Self, ox)) {
1729       goto Abort;
1730     }
1731     if (_succ == NULL) {
1732       _succ = Self;
1733     }
1734   }
1735 
1736   // Spin failed with prejudice -- reduce _SpinDuration.
1737   // TODO: Use an AIMD-like policy to adjust _SpinDuration.
1738   // AIMD is globally stable.
1739   {
1740     int x = _SpinDuration;
1741     if (x &gt; 0) {
1742       // Consider an AIMD scheme like: x -= (x &gt;&gt; 3) + 100
1743       // This is globally sample and tends to damp the response.
1744       x -= Knob_Penalty;
1745       if (x &lt; 0) x = 0;
1746       _SpinDuration = x;
1747     }
1748   }
1749 
1750  Abort:
1751   if (_succ == Self) {
1752     _succ = NULL;
1753     // Invariant: after setting succ=null a contending thread
1754     // must recheck-retry _owner before parking.  This usually happens
1755     // in the normal usage of TrySpin(), but it&#39;s safest
1756     // to make TrySpin() as foolproof as possible.
1757     OrderAccess::fence();
1758     if (TryLock(Self) &gt; 0) return 1;
1759   }
1760   return 0;
1761 }
1762 
1763 // NotRunnable() -- informed spinning
1764 //
1765 // Don&#39;t bother spinning if the owner is not eligible to drop the lock.
1766 // Spin only if the owner thread is _thread_in_Java or _thread_in_vm.
1767 // The thread must be runnable in order to drop the lock in timely fashion.
1768 // If the _owner is not runnable then spinning will not likely be
1769 // successful (profitable).
1770 //
1771 // Beware -- the thread referenced by _owner could have died
1772 // so a simply fetch from _owner-&gt;_thread_state might trap.
1773 // Instead, we use SafeFetchXX() to safely LD _owner-&gt;_thread_state.
1774 // Because of the lifecycle issues, the _thread_state values
1775 // observed by NotRunnable() might be garbage.  NotRunnable must
1776 // tolerate this and consider the observed _thread_state value
1777 // as advisory.
1778 //
1779 // Beware too, that _owner is sometimes a BasicLock address and sometimes
1780 // a thread pointer.
1781 // Alternately, we might tag the type (thread pointer vs basiclock pointer)
1782 // with the LSB of _owner.  Another option would be to probabilistically probe
1783 // the putative _owner-&gt;TypeTag value.
1784 //
1785 // Checking _thread_state isn&#39;t perfect.  Even if the thread is
1786 // in_java it might be blocked on a page-fault or have been preempted
1787 // and sitting on a ready/dispatch queue.
1788 //
1789 // The return value from NotRunnable() is *advisory* -- the
1790 // result is based on sampling and is not necessarily coherent.
1791 // The caller must tolerate false-negative and false-positive errors.
1792 // Spinning, in general, is probabilistic anyway.
1793 
1794 
1795 int ObjectMonitor::NotRunnable(Thread * Self, Thread * ox) {
1796   // Check ox-&gt;TypeTag == 2BAD.
1797   if (ox == NULL) return 0;
1798 
1799   // Avoid transitive spinning ...
1800   // Say T1 spins or blocks trying to acquire L.  T1._Stalled is set to L.
1801   // Immediately after T1 acquires L it&#39;s possible that T2, also
1802   // spinning on L, will see L.Owner=T1 and T1._Stalled=L.
1803   // This occurs transiently after T1 acquired L but before
1804   // T1 managed to clear T1.Stalled.  T2 does not need to abort
1805   // its spin in this circumstance.
1806   intptr_t BlockedOn = SafeFetchN((intptr_t *) &amp;ox-&gt;_Stalled, intptr_t(1));
1807 
1808   if (BlockedOn == 1) return 1;
1809   if (BlockedOn != 0) {
1810     return BlockedOn != intptr_t(this) &amp;&amp; _owner == ox;
1811   }
1812 
1813   assert(sizeof(((JavaThread *)ox)-&gt;_thread_state == sizeof(int)), &quot;invariant&quot;);
1814   int jst = SafeFetch32((int *) &amp;((JavaThread *) ox)-&gt;_thread_state, -1);;
1815   // consider also: jst != _thread_in_Java -- but that&#39;s overspecific.
1816   return jst == _thread_blocked || jst == _thread_in_native;
1817 }
1818 
1819 
1820 // -----------------------------------------------------------------------------
1821 // WaitSet management ...
1822 
1823 ObjectWaiter::ObjectWaiter(Thread* thread) {
1824   _next     = NULL;
1825   _prev     = NULL;
1826   _notified = 0;
1827   _notifier_tid = 0;
1828   TState    = TS_RUN;
1829   _thread   = thread;
1830   _event    = thread-&gt;_ParkEvent;
1831   _active   = false;
1832   assert(_event != NULL, &quot;invariant&quot;);
1833 }
1834 
1835 void ObjectWaiter::wait_reenter_begin(ObjectMonitor * const mon) {
1836   JavaThread *jt = (JavaThread *)this-&gt;_thread;
1837   _active = JavaThreadBlockedOnMonitorEnterState::wait_reenter_begin(jt, mon);
1838 }
1839 
1840 void ObjectWaiter::wait_reenter_end(ObjectMonitor * const mon) {
1841   JavaThread *jt = (JavaThread *)this-&gt;_thread;
1842   JavaThreadBlockedOnMonitorEnterState::wait_reenter_end(jt, _active);
1843 }
1844 
1845 inline void ObjectMonitor::AddWaiter(ObjectWaiter* node) {
1846   assert(node != NULL, &quot;should not add NULL node&quot;);
1847   assert(node-&gt;_prev == NULL, &quot;node already in list&quot;);
1848   assert(node-&gt;_next == NULL, &quot;node already in list&quot;);
1849   // put node at end of queue (circular doubly linked list)
1850   if (_WaitSet == NULL) {
1851     _WaitSet = node;
1852     node-&gt;_prev = node;
1853     node-&gt;_next = node;
1854   } else {
1855     ObjectWaiter* head = _WaitSet;
1856     ObjectWaiter* tail = head-&gt;_prev;
1857     assert(tail-&gt;_next == head, &quot;invariant check&quot;);
1858     tail-&gt;_next = node;
1859     head-&gt;_prev = node;
1860     node-&gt;_next = head;
1861     node-&gt;_prev = tail;
1862   }
1863 }
1864 
1865 inline ObjectWaiter* ObjectMonitor::DequeueWaiter() {
1866   // dequeue the very first waiter
1867   ObjectWaiter* waiter = _WaitSet;
1868   if (waiter) {
1869     DequeueSpecificWaiter(waiter);
1870   }
1871   return waiter;
1872 }
1873 
1874 inline void ObjectMonitor::DequeueSpecificWaiter(ObjectWaiter* node) {
1875   assert(node != NULL, &quot;should not dequeue NULL node&quot;);
1876   assert(node-&gt;_prev != NULL, &quot;node already removed from list&quot;);
1877   assert(node-&gt;_next != NULL, &quot;node already removed from list&quot;);
1878   // when the waiter has woken up because of interrupt,
1879   // timeout or other spurious wake-up, dequeue the
1880   // waiter from waiting list
1881   ObjectWaiter* next = node-&gt;_next;
1882   if (next == node) {
1883     assert(node-&gt;_prev == node, &quot;invariant check&quot;);
1884     _WaitSet = NULL;
1885   } else {
1886     ObjectWaiter* prev = node-&gt;_prev;
1887     assert(prev-&gt;_next == node, &quot;invariant check&quot;);
1888     assert(next-&gt;_prev == node, &quot;invariant check&quot;);
1889     next-&gt;_prev = prev;
1890     prev-&gt;_next = next;
1891     if (_WaitSet == node) {
1892       _WaitSet = next;
1893     }
1894   }
1895   node-&gt;_next = NULL;
1896   node-&gt;_prev = NULL;
1897 }
1898 
1899 // -----------------------------------------------------------------------------
1900 // PerfData support
1901 PerfCounter * ObjectMonitor::_sync_ContendedLockAttempts       = NULL;
1902 PerfCounter * ObjectMonitor::_sync_FutileWakeups               = NULL;
1903 PerfCounter * ObjectMonitor::_sync_Parks                       = NULL;
1904 PerfCounter * ObjectMonitor::_sync_Notifications               = NULL;
1905 PerfCounter * ObjectMonitor::_sync_Inflations                  = NULL;
1906 PerfCounter * ObjectMonitor::_sync_Deflations                  = NULL;
1907 PerfLongVariable * ObjectMonitor::_sync_MonExtant              = NULL;
1908 
1909 // One-shot global initialization for the sync subsystem.
1910 // We could also defer initialization and initialize on-demand
1911 // the first time we call ObjectSynchronizer::inflate().
1912 // Initialization would be protected - like so many things - by
1913 // the MonitorCache_lock.
1914 
1915 void ObjectMonitor::Initialize() {
1916   assert(!InitDone, &quot;invariant&quot;);
1917 
1918   if (!os::is_MP()) {
1919     Knob_SpinLimit = 0;
1920     Knob_PreSpin   = 0;
1921     Knob_FixedSpin = -1;
1922   }
1923 
1924   if (UsePerfData) {
1925     EXCEPTION_MARK;
1926 #define NEWPERFCOUNTER(n)                                                \
1927   {                                                                      \
1928     n = PerfDataManager::create_counter(SUN_RT, #n, PerfData::U_Events,  \
1929                                         CHECK);                          \
1930   }
1931 #define NEWPERFVARIABLE(n)                                                \
1932   {                                                                       \
1933     n = PerfDataManager::create_variable(SUN_RT, #n, PerfData::U_Events,  \
1934                                          CHECK);                          \
1935   }
1936     NEWPERFCOUNTER(_sync_Inflations);
1937     NEWPERFCOUNTER(_sync_Deflations);
1938     NEWPERFCOUNTER(_sync_ContendedLockAttempts);
1939     NEWPERFCOUNTER(_sync_FutileWakeups);
1940     NEWPERFCOUNTER(_sync_Parks);
1941     NEWPERFCOUNTER(_sync_Notifications);
1942     NEWPERFVARIABLE(_sync_MonExtant);
1943 #undef NEWPERFCOUNTER
1944 #undef NEWPERFVARIABLE
1945   }
1946 
1947   DEBUG_ONLY(InitDone = true;)
1948 }
1949 
1950 void ObjectMonitor::print_on(outputStream* st) const {
1951   // The minimal things to print for markWord printing, more can be added for debugging and logging.
1952   st-&gt;print(&quot;{contentions=0x%08x,waiters=0x%08x&quot;
1953             &quot;,recursions=&quot; INTX_FORMAT &quot;,owner=&quot; INTPTR_FORMAT &quot;}&quot;,
1954             contentions(), waiters(), recursions(),
1955             p2i(owner()));
1956 }
1957 void ObjectMonitor::print() const { print_on(tty); }
1958 
1959 #ifdef ASSERT
1960 // Print the ObjectMonitor like a debugger would:
1961 //
1962 // (ObjectMonitor) 0x00007fdfb6012e40 = {
1963 //   _header = 0x0000000000000001
1964 //   _object = 0x000000070ff45fd0
1965 //   _next_om = 0x0000000000000000
1966 //   _pad_buf0 = {
1967 //     [0] = &#39;\0&#39;
1968 //     ...
1969 //     [103] = &#39;\0&#39;
1970 //   }
1971 //   _owner = 0x0000000000000000
1972 //   _previous_owner_tid = 0
1973 //   _recursions = 0
1974 //   _EntryList = 0x0000000000000000
1975 //   _cxq = 0x0000000000000000
1976 //   _succ = 0x0000000000000000
1977 //   _Responsible = 0x0000000000000000
1978 //   _Spinner = 0
1979 //   _SpinDuration = 5000
1980 //   _contentions = 0
1981 //   _WaitSet = 0x0000700009756248
1982 //   _waiters = 1
1983 //   _WaitSetLock = 0
1984 // }
1985 //
1986 void ObjectMonitor::print_debug_style_on(outputStream* st) const {
1987   st-&gt;print_cr(&quot;(ObjectMonitor*) &quot; INTPTR_FORMAT &quot; = {&quot;, p2i(this));
1988   st-&gt;print_cr(&quot;  _header = &quot; INTPTR_FORMAT, header().value());
1989   st-&gt;print_cr(&quot;  _object = &quot; INTPTR_FORMAT, p2i(_object));
1990   st-&gt;print_cr(&quot;  _next_om = &quot; INTPTR_FORMAT, p2i(next_om()));
1991   st-&gt;print_cr(&quot;  _pad_buf0 = {&quot;);
1992   st-&gt;print_cr(&quot;    [0] = &#39;\\0&#39;&quot;);
1993   st-&gt;print_cr(&quot;    ...&quot;);
1994   st-&gt;print_cr(&quot;    [%d] = &#39;\\0&#39;&quot;, (int)sizeof(_pad_buf0) - 1);
1995   st-&gt;print_cr(&quot;  }&quot;);
1996   st-&gt;print_cr(&quot;  _owner = &quot; INTPTR_FORMAT, p2i(_owner));
1997   st-&gt;print_cr(&quot;  _previous_owner_tid = &quot; JLONG_FORMAT, _previous_owner_tid);
1998   st-&gt;print_cr(&quot;  _recursions = &quot; INTX_FORMAT, _recursions);
1999   st-&gt;print_cr(&quot;  _EntryList = &quot; INTPTR_FORMAT, p2i(_EntryList));
2000   st-&gt;print_cr(&quot;  _cxq = &quot; INTPTR_FORMAT, p2i(_cxq));
2001   st-&gt;print_cr(&quot;  _succ = &quot; INTPTR_FORMAT, p2i(_succ));
2002   st-&gt;print_cr(&quot;  _Responsible = &quot; INTPTR_FORMAT, p2i(_Responsible));
2003   st-&gt;print_cr(&quot;  _Spinner = %d&quot;, _Spinner);
2004   st-&gt;print_cr(&quot;  _SpinDuration = %d&quot;, _SpinDuration);
2005   st-&gt;print_cr(&quot;  _contentions = %d&quot;, _contentions);
2006   st-&gt;print_cr(&quot;  _WaitSet = &quot; INTPTR_FORMAT, p2i(_WaitSet));
2007   st-&gt;print_cr(&quot;  _waiters = %d&quot;, _waiters);
2008   st-&gt;print_cr(&quot;  _WaitSetLock = %d&quot;, _WaitSetLock);
2009   st-&gt;print_cr(&quot;}&quot;);
2010 }
2011 #endif
    </pre>
  </body>
</html>