<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Old src/hotspot/share/runtime/objectMonitor.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
  <body>
    <pre>
   1 /*
   2  * Copyright (c) 1998, 2019, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
  23  */
  24 
  25 #include &quot;precompiled.hpp&quot;
  26 #include &quot;classfile/vmSymbols.hpp&quot;
  27 #include &quot;jfr/jfrEvents.hpp&quot;
  28 #include &quot;jfr/support/jfrThreadId.hpp&quot;
  29 #include &quot;logging/log.hpp&quot;
  30 #include &quot;logging/logStream.hpp&quot;
  31 #include &quot;memory/allocation.inline.hpp&quot;
  32 #include &quot;memory/resourceArea.hpp&quot;
  33 #include &quot;oops/markWord.hpp&quot;
  34 #include &quot;oops/oop.inline.hpp&quot;
  35 #include &quot;runtime/atomic.hpp&quot;
  36 #include &quot;runtime/handles.inline.hpp&quot;
  37 #include &quot;runtime/interfaceSupport.inline.hpp&quot;
  38 #include &quot;runtime/mutexLocker.hpp&quot;
  39 #include &quot;runtime/objectMonitor.hpp&quot;
  40 #include &quot;runtime/objectMonitor.inline.hpp&quot;
  41 #include &quot;runtime/orderAccess.hpp&quot;
  42 #include &quot;runtime/osThread.hpp&quot;
  43 #include &quot;runtime/safepointMechanism.inline.hpp&quot;
  44 #include &quot;runtime/sharedRuntime.hpp&quot;
  45 #include &quot;runtime/stubRoutines.hpp&quot;
  46 #include &quot;runtime/thread.inline.hpp&quot;
  47 #include &quot;services/threadService.hpp&quot;
  48 #include &quot;utilities/dtrace.hpp&quot;
  49 #include &quot;utilities/macros.hpp&quot;
  50 #include &quot;utilities/preserveException.hpp&quot;
  51 #if INCLUDE_JFR
  52 #include &quot;jfr/support/jfrFlush.hpp&quot;
  53 #endif
  54 
  55 #ifdef DTRACE_ENABLED
  56 
  57 // Only bother with this argument setup if dtrace is available
  58 // TODO-FIXME: probes should not fire when caller is _blocked.  assert() accordingly.
  59 
  60 
  61 #define DTRACE_MONITOR_PROBE_COMMON(obj, thread)                           \
  62   char* bytes = NULL;                                                      \
  63   int len = 0;                                                             \
  64   jlong jtid = SharedRuntime::get_java_tid(thread);                        \
  65   Symbol* klassname = ((oop)obj)-&gt;klass()-&gt;name();                         \
  66   if (klassname != NULL) {                                                 \
  67     bytes = (char*)klassname-&gt;bytes();                                     \
  68     len = klassname-&gt;utf8_length();                                        \
  69   }
  70 
  71 #define DTRACE_MONITOR_WAIT_PROBE(monitor, obj, thread, millis)            \
  72   {                                                                        \
  73     if (DTraceMonitorProbes) {                                             \
  74       DTRACE_MONITOR_PROBE_COMMON(obj, thread);                            \
  75       HOTSPOT_MONITOR_WAIT(jtid,                                           \
  76                            (monitor), bytes, len, (millis));               \
  77     }                                                                      \
  78   }
  79 
  80 #define HOTSPOT_MONITOR_contended__enter HOTSPOT_MONITOR_CONTENDED_ENTER
  81 #define HOTSPOT_MONITOR_contended__entered HOTSPOT_MONITOR_CONTENDED_ENTERED
  82 #define HOTSPOT_MONITOR_contended__exit HOTSPOT_MONITOR_CONTENDED_EXIT
  83 #define HOTSPOT_MONITOR_notify HOTSPOT_MONITOR_NOTIFY
  84 #define HOTSPOT_MONITOR_notifyAll HOTSPOT_MONITOR_NOTIFYALL
  85 
  86 #define DTRACE_MONITOR_PROBE(probe, monitor, obj, thread)                  \
  87   {                                                                        \
  88     if (DTraceMonitorProbes) {                                             \
  89       DTRACE_MONITOR_PROBE_COMMON(obj, thread);                            \
  90       HOTSPOT_MONITOR_##probe(jtid,                                        \
  91                               (uintptr_t)(monitor), bytes, len);           \
  92     }                                                                      \
  93   }
  94 
  95 #else //  ndef DTRACE_ENABLED
  96 
  97 #define DTRACE_MONITOR_WAIT_PROBE(obj, thread, millis, mon)    {;}
  98 #define DTRACE_MONITOR_PROBE(probe, obj, thread, mon)          {;}
  99 
 100 #endif // ndef DTRACE_ENABLED
 101 
 102 // Tunables ...
 103 // The knob* variables are effectively final.  Once set they should
 104 // never be modified hence.  Consider using __read_mostly with GCC.
 105 
 106 int ObjectMonitor::Knob_SpinLimit    = 5000;    // derived by an external tool -
 107 
 108 static int Knob_Bonus               = 100;     // spin success bonus
 109 static int Knob_BonusB              = 100;     // spin success bonus
 110 static int Knob_Penalty             = 200;     // spin failure penalty
 111 static int Knob_Poverty             = 1000;
 112 static int Knob_FixedSpin           = 0;
 113 static int Knob_PreSpin             = 10;      // 20-100 likely better
 114 
 115 DEBUG_ONLY(static volatile bool InitDone = false;)
 116 
 117 // -----------------------------------------------------------------------------
 118 // Theory of operations -- Monitors lists, thread residency, etc:
 119 //
 120 // * A thread acquires ownership of a monitor by successfully
 121 //   CAS()ing the _owner field from null to non-null.
 122 //
 123 // * Invariant: A thread appears on at most one monitor list --
 124 //   cxq, EntryList or WaitSet -- at any one time.
 125 //
 126 // * Contending threads &quot;push&quot; themselves onto the cxq with CAS
 127 //   and then spin/park.
 128 //
 129 // * After a contending thread eventually acquires the lock it must
 130 //   dequeue itself from either the EntryList or the cxq.
 131 //
 132 // * The exiting thread identifies and unparks an &quot;heir presumptive&quot;
 133 //   tentative successor thread on the EntryList.  Critically, the
 134 //   exiting thread doesn&#39;t unlink the successor thread from the EntryList.
 135 //   After having been unparked, the wakee will recontend for ownership of
 136 //   the monitor.   The successor (wakee) will either acquire the lock or
 137 //   re-park itself.
 138 //
 139 //   Succession is provided for by a policy of competitive handoff.
 140 //   The exiting thread does _not_ grant or pass ownership to the
 141 //   successor thread.  (This is also referred to as &quot;handoff&quot; succession&quot;).
 142 //   Instead the exiting thread releases ownership and possibly wakes
 143 //   a successor, so the successor can (re)compete for ownership of the lock.
 144 //   If the EntryList is empty but the cxq is populated the exiting
 145 //   thread will drain the cxq into the EntryList.  It does so by
 146 //   by detaching the cxq (installing null with CAS) and folding
 147 //   the threads from the cxq into the EntryList.  The EntryList is
 148 //   doubly linked, while the cxq is singly linked because of the
 149 //   CAS-based &quot;push&quot; used to enqueue recently arrived threads (RATs).
 150 //
 151 // * Concurrency invariants:
 152 //
 153 //   -- only the monitor owner may access or mutate the EntryList.
 154 //      The mutex property of the monitor itself protects the EntryList
 155 //      from concurrent interference.
 156 //   -- Only the monitor owner may detach the cxq.
 157 //
 158 // * The monitor entry list operations avoid locks, but strictly speaking
 159 //   they&#39;re not lock-free.  Enter is lock-free, exit is not.
 160 //   For a description of &#39;Methods and apparatus providing non-blocking access
 161 //   to a resource,&#39; see U.S. Pat. No. 7844973.
 162 //
 163 // * The cxq can have multiple concurrent &quot;pushers&quot; but only one concurrent
 164 //   detaching thread.  This mechanism is immune from the ABA corruption.
 165 //   More precisely, the CAS-based &quot;push&quot; onto cxq is ABA-oblivious.
 166 //
 167 // * Taken together, the cxq and the EntryList constitute or form a
 168 //   single logical queue of threads stalled trying to acquire the lock.
 169 //   We use two distinct lists to improve the odds of a constant-time
 170 //   dequeue operation after acquisition (in the ::enter() epilogue) and
 171 //   to reduce heat on the list ends.  (c.f. Michael Scott&#39;s &quot;2Q&quot; algorithm).
 172 //   A key desideratum is to minimize queue &amp; monitor metadata manipulation
 173 //   that occurs while holding the monitor lock -- that is, we want to
 174 //   minimize monitor lock holds times.  Note that even a small amount of
 175 //   fixed spinning will greatly reduce the # of enqueue-dequeue operations
 176 //   on EntryList|cxq.  That is, spinning relieves contention on the &quot;inner&quot;
 177 //   locks and monitor metadata.
 178 //
 179 //   Cxq points to the set of Recently Arrived Threads attempting entry.
 180 //   Because we push threads onto _cxq with CAS, the RATs must take the form of
 181 //   a singly-linked LIFO.  We drain _cxq into EntryList  at unlock-time when
 182 //   the unlocking thread notices that EntryList is null but _cxq is != null.
 183 //
 184 //   The EntryList is ordered by the prevailing queue discipline and
 185 //   can be organized in any convenient fashion, such as a doubly-linked list or
 186 //   a circular doubly-linked list.  Critically, we want insert and delete operations
 187 //   to operate in constant-time.  If we need a priority queue then something akin
 188 //   to Solaris&#39; sleepq would work nicely.  Viz.,
 189 //   http://agg.eng/ws/on10_nightly/source/usr/src/uts/common/os/sleepq.c.
 190 //   Queue discipline is enforced at ::exit() time, when the unlocking thread
 191 //   drains the cxq into the EntryList, and orders or reorders the threads on the
 192 //   EntryList accordingly.
 193 //
 194 //   Barring &quot;lock barging&quot;, this mechanism provides fair cyclic ordering,
 195 //   somewhat similar to an elevator-scan.
 196 //
 197 // * The monitor synchronization subsystem avoids the use of native
 198 //   synchronization primitives except for the narrow platform-specific
 199 //   park-unpark abstraction.  See the comments in os_solaris.cpp regarding
 200 //   the semantics of park-unpark.  Put another way, this monitor implementation
 201 //   depends only on atomic operations and park-unpark.  The monitor subsystem
 202 //   manages all RUNNING-&gt;BLOCKED and BLOCKED-&gt;READY transitions while the
 203 //   underlying OS manages the READY&lt;-&gt;RUN transitions.
 204 //
 205 // * Waiting threads reside on the WaitSet list -- wait() puts
 206 //   the caller onto the WaitSet.
 207 //
 208 // * notify() or notifyAll() simply transfers threads from the WaitSet to
 209 //   either the EntryList or cxq.  Subsequent exit() operations will
 210 //   unpark the notifyee.  Unparking a notifee in notify() is inefficient -
 211 //   it&#39;s likely the notifyee would simply impale itself on the lock held
 212 //   by the notifier.
 213 //
 214 // * An interesting alternative is to encode cxq as (List,LockByte) where
 215 //   the LockByte is 0 iff the monitor is owned.  _owner is simply an auxiliary
 216 //   variable, like _recursions, in the scheme.  The threads or Events that form
 217 //   the list would have to be aligned in 256-byte addresses.  A thread would
 218 //   try to acquire the lock or enqueue itself with CAS, but exiting threads
 219 //   could use a 1-0 protocol and simply STB to set the LockByte to 0.
 220 //   Note that is is *not* word-tearing, but it does presume that full-word
 221 //   CAS operations are coherent with intermix with STB operations.  That&#39;s true
 222 //   on most common processors.
 223 //
 224 // * See also http://blogs.sun.com/dave
 225 
 226 
 227 void* ObjectMonitor::operator new (size_t size) throw() {
 228   return AllocateHeap(size, mtInternal);
 229 }
 230 void* ObjectMonitor::operator new[] (size_t size) throw() {
 231   return operator new (size);
 232 }
 233 void ObjectMonitor::operator delete(void* p) {
 234   FreeHeap(p);
 235 }
 236 void ObjectMonitor::operator delete[] (void *p) {
 237   operator delete(p);
 238 }
 239 
 240 // -----------------------------------------------------------------------------
 241 // Enter support
 242 
 243 void ObjectMonitor::enter(TRAPS) {
 244   // The following code is ordered to check the most common cases first
 245   // and to reduce RTS-&gt;RTO cache line upgrades on SPARC and IA32 processors.
 246   Thread * const Self = THREAD;
 247 
 248   void * cur = Atomic::cmpxchg(&amp;_owner, (void*)NULL, Self);
 249   if (cur == NULL) {
 250     assert(_recursions == 0, &quot;invariant&quot;);
 251     return;
 252   }
 253 
 254   if (cur == Self) {
 255     // TODO-FIXME: check for integer overflow!  BUGID 6557169.
 256     _recursions++;
 257     return;
 258   }
 259 
 260   if (Self-&gt;is_lock_owned((address)cur)) {
 261     assert(_recursions == 0, &quot;internal state error&quot;);
 262     _recursions = 1;
 263     // Commute owner from a thread-specific on-stack BasicLockObject address to
 264     // a full-fledged &quot;Thread *&quot;.
 265     _owner = Self;
 266     return;
 267   }
 268 
 269   // We&#39;ve encountered genuine contention.
 270   assert(Self-&gt;_Stalled == 0, &quot;invariant&quot;);
 271   Self-&gt;_Stalled = intptr_t(this);
 272 
 273   // Try one round of spinning *before* enqueueing Self
 274   // and before going through the awkward and expensive state
 275   // transitions.  The following spin is strictly optional ...
 276   // Note that if we acquire the monitor from an initial spin
 277   // we forgo posting JVMTI events and firing DTRACE probes.
 278   if (TrySpin(Self) &gt; 0) {
 279     assert(_owner == Self, &quot;must be Self: owner=&quot; INTPTR_FORMAT, p2i(_owner));
 280     assert(_recursions == 0, &quot;must be 0: recursions=&quot; INTX_FORMAT, _recursions);
 281     assert(((oop)object())-&gt;mark() == markWord::encode(this),
 282            &quot;object mark must match encoded this: mark=&quot; INTPTR_FORMAT
 283            &quot;, encoded this=&quot; INTPTR_FORMAT, ((oop)object())-&gt;mark().value(),
 284            markWord::encode(this).value());
 285     Self-&gt;_Stalled = 0;
 286     return;
 287   }
 288 
 289   assert(_owner != Self, &quot;invariant&quot;);
 290   assert(_succ != Self, &quot;invariant&quot;);
 291   assert(Self-&gt;is_Java_thread(), &quot;invariant&quot;);
 292   JavaThread * jt = (JavaThread *) Self;
 293   assert(!SafepointSynchronize::is_at_safepoint(), &quot;invariant&quot;);
 294   assert(jt-&gt;thread_state() != _thread_blocked, &quot;invariant&quot;);
 295   assert(this-&gt;object() != NULL, &quot;invariant&quot;);
 296   assert(_contentions &gt;= 0, &quot;invariant&quot;);
 297 
 298   // Prevent deflation at STW-time.  See deflate_idle_monitors() and is_busy().
 299   // Ensure the object-monitor relationship remains stable while there&#39;s contention.
 300   Atomic::inc(&amp;_contentions);
 301 
 302   JFR_ONLY(JfrConditionalFlushWithStacktrace&lt;EventJavaMonitorEnter&gt; flush(jt);)
 303   EventJavaMonitorEnter event;
 304   if (event.should_commit()) {
 305     event.set_monitorClass(((oop)this-&gt;object())-&gt;klass());
 306     event.set_address((uintptr_t)(this-&gt;object_addr()));
 307   }
 308 
 309   { // Change java thread status to indicate blocked on monitor enter.
 310     JavaThreadBlockedOnMonitorEnterState jtbmes(jt, this);
 311 
 312     Self-&gt;set_current_pending_monitor(this);
 313 
 314     DTRACE_MONITOR_PROBE(contended__enter, this, object(), jt);
 315     if (JvmtiExport::should_post_monitor_contended_enter()) {
 316       JvmtiExport::post_monitor_contended_enter(jt, this);
 317 
 318       // The current thread does not yet own the monitor and does not
 319       // yet appear on any queues that would get it made the successor.
 320       // This means that the JVMTI_EVENT_MONITOR_CONTENDED_ENTER event
 321       // handler cannot accidentally consume an unpark() meant for the
 322       // ParkEvent associated with this ObjectMonitor.
 323     }
 324 
 325     OSThreadContendState osts(Self-&gt;osthread());
 326     ThreadBlockInVM tbivm(jt);
 327 
 328     // TODO-FIXME: change the following for(;;) loop to straight-line code.
 329     for (;;) {
 330       jt-&gt;set_suspend_equivalent();
 331       // cleared by handle_special_suspend_equivalent_condition()
 332       // or java_suspend_self()
 333 
 334       EnterI(THREAD);
 335 
 336       if (!ExitSuspendEquivalent(jt)) break;
 337 
 338       // We have acquired the contended monitor, but while we were
 339       // waiting another thread suspended us. We don&#39;t want to enter
 340       // the monitor while suspended because that would surprise the
 341       // thread that suspended us.
 342       //
 343       _recursions = 0;
 344       _succ = NULL;
 345       exit(false, Self);
 346 
 347       jt-&gt;java_suspend_self();
 348     }
 349     Self-&gt;set_current_pending_monitor(NULL);
 350 
 351     // We cleared the pending monitor info since we&#39;ve just gotten past
 352     // the enter-check-for-suspend dance and we now own the monitor free
 353     // and clear, i.e., it is no longer pending. The ThreadBlockInVM
 354     // destructor can go to a safepoint at the end of this block. If we
 355     // do a thread dump during that safepoint, then this thread will show
 356     // as having &quot;-locked&quot; the monitor, but the OS and java.lang.Thread
 357     // states will still report that the thread is blocked trying to
 358     // acquire it.
 359   }
 360 
 361   Atomic::dec(&amp;_contentions);
 362   assert(_contentions &gt;= 0, &quot;invariant&quot;);
 363   Self-&gt;_Stalled = 0;
 364 
 365   // Must either set _recursions = 0 or ASSERT _recursions == 0.
 366   assert(_recursions == 0, &quot;invariant&quot;);
 367   assert(_owner == Self, &quot;invariant&quot;);
 368   assert(_succ != Self, &quot;invariant&quot;);
 369   assert(((oop)(object()))-&gt;mark() == markWord::encode(this), &quot;invariant&quot;);
 370 
 371   // The thread -- now the owner -- is back in vm mode.
 372   // Report the glorious news via TI,DTrace and jvmstat.
 373   // The probe effect is non-trivial.  All the reportage occurs
 374   // while we hold the monitor, increasing the length of the critical
 375   // section.  Amdahl&#39;s parallel speedup law comes vividly into play.
 376   //
 377   // Another option might be to aggregate the events (thread local or
 378   // per-monitor aggregation) and defer reporting until a more opportune
 379   // time -- such as next time some thread encounters contention but has
 380   // yet to acquire the lock.  While spinning that thread could
 381   // spinning we could increment JVMStat counters, etc.
 382 
 383   DTRACE_MONITOR_PROBE(contended__entered, this, object(), jt);
 384   if (JvmtiExport::should_post_monitor_contended_entered()) {
 385     JvmtiExport::post_monitor_contended_entered(jt, this);
 386 
 387     // The current thread already owns the monitor and is not going to
 388     // call park() for the remainder of the monitor enter protocol. So
 389     // it doesn&#39;t matter if the JVMTI_EVENT_MONITOR_CONTENDED_ENTERED
 390     // event handler consumed an unpark() issued by the thread that
 391     // just exited the monitor.
 392   }
 393   if (event.should_commit()) {
 394     event.set_previousOwner((uintptr_t)_previous_owner_tid);
 395     event.commit();
 396   }
 397   OM_PERFDATA_OP(ContendedLockAttempts, inc());
 398 }
 399 
 400 // Caveat: TryLock() is not necessarily serializing if it returns failure.
 401 // Callers must compensate as needed.
 402 
 403 int ObjectMonitor::TryLock(Thread * Self) {
 404   void * own = _owner;
 405   if (own != NULL) return 0;
 406   if (Atomic::replace_if_null(&amp;_owner, Self)) {
 407     assert(_recursions == 0, &quot;invariant&quot;);
 408     return 1;
 409   }
 410   // The lock had been free momentarily, but we lost the race to the lock.
 411   // Interference -- the CAS failed.
 412   // We can either return -1 or retry.
 413   // Retry doesn&#39;t make as much sense because the lock was just acquired.
 414   return -1;
 415 }
 416 
 417 // Convert the fields used by is_busy() to a string that can be
 418 // used for diagnostic output.
 419 const char* ObjectMonitor::is_busy_to_string(stringStream* ss) {
 420   ss-&gt;print(&quot;is_busy: contentions=%d, waiters=%d, owner=&quot; INTPTR_FORMAT
 421             &quot;, cxq=&quot; INTPTR_FORMAT &quot;, EntryList=&quot; INTPTR_FORMAT, _contentions,
 422             _waiters, p2i(_owner), p2i(_cxq), p2i(_EntryList));
 423   return ss-&gt;base();
 424 }
 425 
 426 #define MAX_RECHECK_INTERVAL 1000
 427 
 428 void ObjectMonitor::EnterI(TRAPS) {
 429   Thread * const Self = THREAD;
 430   assert(Self-&gt;is_Java_thread(), &quot;invariant&quot;);
 431   assert(((JavaThread *) Self)-&gt;thread_state() == _thread_blocked, &quot;invariant&quot;);
 432 
 433   // Try the lock - TATAS
 434   if (TryLock (Self) &gt; 0) {
 435     assert(_succ != Self, &quot;invariant&quot;);
 436     assert(_owner == Self, &quot;invariant&quot;);
 437     assert(_Responsible != Self, &quot;invariant&quot;);
 438     return;
 439   }
 440 
 441   assert(InitDone, &quot;Unexpectedly not initialized&quot;);
 442 
 443   // We try one round of spinning *before* enqueueing Self.
 444   //
 445   // If the _owner is ready but OFFPROC we could use a YieldTo()
 446   // operation to donate the remainder of this thread&#39;s quantum
 447   // to the owner.  This has subtle but beneficial affinity
 448   // effects.
 449 
 450   if (TrySpin(Self) &gt; 0) {
 451     assert(_owner == Self, &quot;invariant&quot;);
 452     assert(_succ != Self, &quot;invariant&quot;);
 453     assert(_Responsible != Self, &quot;invariant&quot;);
 454     return;
 455   }
 456 
 457   // The Spin failed -- Enqueue and park the thread ...
 458   assert(_succ != Self, &quot;invariant&quot;);
 459   assert(_owner != Self, &quot;invariant&quot;);
 460   assert(_Responsible != Self, &quot;invariant&quot;);
 461 
 462   // Enqueue &quot;Self&quot; on ObjectMonitor&#39;s _cxq.
 463   //
 464   // Node acts as a proxy for Self.
 465   // As an aside, if were to ever rewrite the synchronization code mostly
 466   // in Java, WaitNodes, ObjectMonitors, and Events would become 1st-class
 467   // Java objects.  This would avoid awkward lifecycle and liveness issues,
 468   // as well as eliminate a subset of ABA issues.
 469   // TODO: eliminate ObjectWaiter and enqueue either Threads or Events.
 470 
 471   ObjectWaiter node(Self);
 472   Self-&gt;_ParkEvent-&gt;reset();
 473   node._prev   = (ObjectWaiter *) 0xBAD;
 474   node.TState  = ObjectWaiter::TS_CXQ;
 475 
 476   // Push &quot;Self&quot; onto the front of the _cxq.
 477   // Once on cxq/EntryList, Self stays on-queue until it acquires the lock.
 478   // Note that spinning tends to reduce the rate at which threads
 479   // enqueue and dequeue on EntryList|cxq.
 480   ObjectWaiter * nxt;
 481   for (;;) {
 482     node._next = nxt = _cxq;
 483     if (Atomic::cmpxchg(&amp;_cxq, nxt, &amp;node) == nxt) break;
 484 
 485     // Interference - the CAS failed because _cxq changed.  Just retry.
 486     // As an optional optimization we retry the lock.
 487     if (TryLock (Self) &gt; 0) {
 488       assert(_succ != Self, &quot;invariant&quot;);
 489       assert(_owner == Self, &quot;invariant&quot;);
 490       assert(_Responsible != Self, &quot;invariant&quot;);
 491       return;
 492     }
 493   }
 494 
 495   // Check for cxq|EntryList edge transition to non-null.  This indicates
 496   // the onset of contention.  While contention persists exiting threads
 497   // will use a ST:MEMBAR:LD 1-1 exit protocol.  When contention abates exit
 498   // operations revert to the faster 1-0 mode.  This enter operation may interleave
 499   // (race) a concurrent 1-0 exit operation, resulting in stranding, so we
 500   // arrange for one of the contending thread to use a timed park() operations
 501   // to detect and recover from the race.  (Stranding is form of progress failure
 502   // where the monitor is unlocked but all the contending threads remain parked).
 503   // That is, at least one of the contended threads will periodically poll _owner.
 504   // One of the contending threads will become the designated &quot;Responsible&quot; thread.
 505   // The Responsible thread uses a timed park instead of a normal indefinite park
 506   // operation -- it periodically wakes and checks for and recovers from potential
 507   // strandings admitted by 1-0 exit operations.   We need at most one Responsible
 508   // thread per-monitor at any given moment.  Only threads on cxq|EntryList may
 509   // be responsible for a monitor.
 510   //
 511   // Currently, one of the contended threads takes on the added role of &quot;Responsible&quot;.
 512   // A viable alternative would be to use a dedicated &quot;stranding checker&quot; thread
 513   // that periodically iterated over all the threads (or active monitors) and unparked
 514   // successors where there was risk of stranding.  This would help eliminate the
 515   // timer scalability issues we see on some platforms as we&#39;d only have one thread
 516   // -- the checker -- parked on a timer.
 517 
 518   if (nxt == NULL &amp;&amp; _EntryList == NULL) {
 519     // Try to assume the role of responsible thread for the monitor.
 520     // CONSIDER:  ST vs CAS vs { if (Responsible==null) Responsible=Self }
 521     Atomic::replace_if_null(&amp;_Responsible, Self);
 522   }
 523 
 524   // The lock might have been released while this thread was occupied queueing
 525   // itself onto _cxq.  To close the race and avoid &quot;stranding&quot; and
 526   // progress-liveness failure we must resample-retry _owner before parking.
 527   // Note the Dekker/Lamport duality: ST cxq; MEMBAR; LD Owner.
 528   // In this case the ST-MEMBAR is accomplished with CAS().
 529   //
 530   // TODO: Defer all thread state transitions until park-time.
 531   // Since state transitions are heavy and inefficient we&#39;d like
 532   // to defer the state transitions until absolutely necessary,
 533   // and in doing so avoid some transitions ...
 534 
 535   int nWakeups = 0;
 536   int recheckInterval = 1;
 537 
 538   for (;;) {
 539 
 540     if (TryLock(Self) &gt; 0) break;
 541     assert(_owner != Self, &quot;invariant&quot;);
 542 
 543     // park self
 544     if (_Responsible == Self) {
 545       Self-&gt;_ParkEvent-&gt;park((jlong) recheckInterval);
 546       // Increase the recheckInterval, but clamp the value.
 547       recheckInterval *= 8;
 548       if (recheckInterval &gt; MAX_RECHECK_INTERVAL) {
 549         recheckInterval = MAX_RECHECK_INTERVAL;
 550       }
 551     } else {
 552       Self-&gt;_ParkEvent-&gt;park();
 553     }
 554 
 555     if (TryLock(Self) &gt; 0) break;
 556 
 557     // The lock is still contested.
 558     // Keep a tally of the # of futile wakeups.
 559     // Note that the counter is not protected by a lock or updated by atomics.
 560     // That is by design - we trade &quot;lossy&quot; counters which are exposed to
 561     // races during updates for a lower probe effect.
 562 
 563     // This PerfData object can be used in parallel with a safepoint.
 564     // See the work around in PerfDataManager::destroy().
 565     OM_PERFDATA_OP(FutileWakeups, inc());
 566     ++nWakeups;
 567 
 568     // Assuming this is not a spurious wakeup we&#39;ll normally find _succ == Self.
 569     // We can defer clearing _succ until after the spin completes
 570     // TrySpin() must tolerate being called with _succ == Self.
 571     // Try yet another round of adaptive spinning.
 572     if (TrySpin(Self) &gt; 0) break;
 573 
 574     // We can find that we were unpark()ed and redesignated _succ while
 575     // we were spinning.  That&#39;s harmless.  If we iterate and call park(),
 576     // park() will consume the event and return immediately and we&#39;ll
 577     // just spin again.  This pattern can repeat, leaving _succ to simply
 578     // spin on a CPU.
 579 
 580     if (_succ == Self) _succ = NULL;
 581 
 582     // Invariant: after clearing _succ a thread *must* retry _owner before parking.
 583     OrderAccess::fence();
 584   }
 585 
 586   // Egress :
 587   // Self has acquired the lock -- Unlink Self from the cxq or EntryList.
 588   // Normally we&#39;ll find Self on the EntryList .
 589   // From the perspective of the lock owner (this thread), the
 590   // EntryList is stable and cxq is prepend-only.
 591   // The head of cxq is volatile but the interior is stable.
 592   // In addition, Self.TState is stable.
 593 
 594   assert(_owner == Self, &quot;invariant&quot;);
 595   assert(object() != NULL, &quot;invariant&quot;);
 596   // I&#39;d like to write:
 597   //   guarantee (((oop)(object()))-&gt;mark() == markWord::encode(this), &quot;invariant&quot;) ;
 598   // but as we&#39;re at a safepoint that&#39;s not safe.
 599 
 600   UnlinkAfterAcquire(Self, &amp;node);
 601   if (_succ == Self) _succ = NULL;
 602 
 603   assert(_succ != Self, &quot;invariant&quot;);
 604   if (_Responsible == Self) {
 605     _Responsible = NULL;
 606     OrderAccess::fence(); // Dekker pivot-point
 607 
 608     // We may leave threads on cxq|EntryList without a designated
 609     // &quot;Responsible&quot; thread.  This is benign.  When this thread subsequently
 610     // exits the monitor it can &quot;see&quot; such preexisting &quot;old&quot; threads --
 611     // threads that arrived on the cxq|EntryList before the fence, above --
 612     // by LDing cxq|EntryList.  Newly arrived threads -- that is, threads
 613     // that arrive on cxq after the ST:MEMBAR, above -- will set Responsible
 614     // non-null and elect a new &quot;Responsible&quot; timer thread.
 615     //
 616     // This thread executes:
 617     //    ST Responsible=null; MEMBAR    (in enter epilogue - here)
 618     //    LD cxq|EntryList               (in subsequent exit)
 619     //
 620     // Entering threads in the slow/contended path execute:
 621     //    ST cxq=nonnull; MEMBAR; LD Responsible (in enter prolog)
 622     //    The (ST cxq; MEMBAR) is accomplished with CAS().
 623     //
 624     // The MEMBAR, above, prevents the LD of cxq|EntryList in the subsequent
 625     // exit operation from floating above the ST Responsible=null.
 626   }
 627 
 628   // We&#39;ve acquired ownership with CAS().
 629   // CAS is serializing -- it has MEMBAR/FENCE-equivalent semantics.
 630   // But since the CAS() this thread may have also stored into _succ,
 631   // EntryList, cxq or Responsible.  These meta-data updates must be
 632   // visible __before this thread subsequently drops the lock.
 633   // Consider what could occur if we didn&#39;t enforce this constraint --
 634   // STs to monitor meta-data and user-data could reorder with (become
 635   // visible after) the ST in exit that drops ownership of the lock.
 636   // Some other thread could then acquire the lock, but observe inconsistent
 637   // or old monitor meta-data and heap data.  That violates the JMM.
 638   // To that end, the 1-0 exit() operation must have at least STST|LDST
 639   // &quot;release&quot; barrier semantics.  Specifically, there must be at least a
 640   // STST|LDST barrier in exit() before the ST of null into _owner that drops
 641   // the lock.   The barrier ensures that changes to monitor meta-data and data
 642   // protected by the lock will be visible before we release the lock, and
 643   // therefore before some other thread (CPU) has a chance to acquire the lock.
 644   // See also: http://gee.cs.oswego.edu/dl/jmm/cookbook.html.
 645   //
 646   // Critically, any prior STs to _succ or EntryList must be visible before
 647   // the ST of null into _owner in the *subsequent* (following) corresponding
 648   // monitorexit.  Recall too, that in 1-0 mode monitorexit does not necessarily
 649   // execute a serializing instruction.
 650 
 651   return;
 652 }
 653 
 654 // ReenterI() is a specialized inline form of the latter half of the
 655 // contended slow-path from EnterI().  We use ReenterI() only for
 656 // monitor reentry in wait().
 657 //
 658 // In the future we should reconcile EnterI() and ReenterI().
 659 
 660 void ObjectMonitor::ReenterI(Thread * Self, ObjectWaiter * SelfNode) {
 661   assert(Self != NULL, &quot;invariant&quot;);
 662   assert(SelfNode != NULL, &quot;invariant&quot;);
 663   assert(SelfNode-&gt;_thread == Self, &quot;invariant&quot;);
 664   assert(_waiters &gt; 0, &quot;invariant&quot;);
 665   assert(((oop)(object()))-&gt;mark() == markWord::encode(this), &quot;invariant&quot;);
 666   assert(((JavaThread *)Self)-&gt;thread_state() != _thread_blocked, &quot;invariant&quot;);
 667   JavaThread * jt = (JavaThread *) Self;
 668 
 669   int nWakeups = 0;
 670   for (;;) {
 671     ObjectWaiter::TStates v = SelfNode-&gt;TState;
 672     guarantee(v == ObjectWaiter::TS_ENTER || v == ObjectWaiter::TS_CXQ, &quot;invariant&quot;);
 673     assert(_owner != Self, &quot;invariant&quot;);
 674 
 675     if (TryLock(Self) &gt; 0) break;
 676     if (TrySpin(Self) &gt; 0) break;
 677 
 678     // State transition wrappers around park() ...
 679     // ReenterI() wisely defers state transitions until
 680     // it&#39;s clear we must park the thread.
 681     {
 682       OSThreadContendState osts(Self-&gt;osthread());
 683       ThreadBlockInVM tbivm(jt);
 684 
 685       // cleared by handle_special_suspend_equivalent_condition()
 686       // or java_suspend_self()
 687       jt-&gt;set_suspend_equivalent();
 688       Self-&gt;_ParkEvent-&gt;park();
 689 
 690       // were we externally suspended while we were waiting?
 691       for (;;) {
 692         if (!ExitSuspendEquivalent(jt)) break;
 693         if (_succ == Self) { _succ = NULL; OrderAccess::fence(); }
 694         jt-&gt;java_suspend_self();
 695         jt-&gt;set_suspend_equivalent();
 696       }
 697     }
 698 
 699     // Try again, but just so we distinguish between futile wakeups and
 700     // successful wakeups.  The following test isn&#39;t algorithmically
 701     // necessary, but it helps us maintain sensible statistics.
 702     if (TryLock(Self) &gt; 0) break;
 703 
 704     // The lock is still contested.
 705     // Keep a tally of the # of futile wakeups.
 706     // Note that the counter is not protected by a lock or updated by atomics.
 707     // That is by design - we trade &quot;lossy&quot; counters which are exposed to
 708     // races during updates for a lower probe effect.
 709     ++nWakeups;
 710 
 711     // Assuming this is not a spurious wakeup we&#39;ll normally
 712     // find that _succ == Self.
 713     if (_succ == Self) _succ = NULL;
 714 
 715     // Invariant: after clearing _succ a contending thread
 716     // *must* retry  _owner before parking.
 717     OrderAccess::fence();
 718 
 719     // This PerfData object can be used in parallel with a safepoint.
 720     // See the work around in PerfDataManager::destroy().
 721     OM_PERFDATA_OP(FutileWakeups, inc());
 722   }
 723 
 724   // Self has acquired the lock -- Unlink Self from the cxq or EntryList .
 725   // Normally we&#39;ll find Self on the EntryList.
 726   // Unlinking from the EntryList is constant-time and atomic-free.
 727   // From the perspective of the lock owner (this thread), the
 728   // EntryList is stable and cxq is prepend-only.
 729   // The head of cxq is volatile but the interior is stable.
 730   // In addition, Self.TState is stable.
 731 
 732   assert(_owner == Self, &quot;invariant&quot;);
 733   assert(((oop)(object()))-&gt;mark() == markWord::encode(this), &quot;invariant&quot;);
 734   UnlinkAfterAcquire(Self, SelfNode);
 735   if (_succ == Self) _succ = NULL;
 736   assert(_succ != Self, &quot;invariant&quot;);
 737   SelfNode-&gt;TState = ObjectWaiter::TS_RUN;
 738   OrderAccess::fence();      // see comments at the end of EnterI()
 739 }
 740 
 741 // By convention we unlink a contending thread from EntryList|cxq immediately
 742 // after the thread acquires the lock in ::enter().  Equally, we could defer
 743 // unlinking the thread until ::exit()-time.
 744 
 745 void ObjectMonitor::UnlinkAfterAcquire(Thread *Self, ObjectWaiter *SelfNode) {
 746   assert(_owner == Self, &quot;invariant&quot;);
 747   assert(SelfNode-&gt;_thread == Self, &quot;invariant&quot;);
 748 
 749   if (SelfNode-&gt;TState == ObjectWaiter::TS_ENTER) {
 750     // Normal case: remove Self from the DLL EntryList .
 751     // This is a constant-time operation.
 752     ObjectWaiter * nxt = SelfNode-&gt;_next;
 753     ObjectWaiter * prv = SelfNode-&gt;_prev;
 754     if (nxt != NULL) nxt-&gt;_prev = prv;
 755     if (prv != NULL) prv-&gt;_next = nxt;
 756     if (SelfNode == _EntryList) _EntryList = nxt;
 757     assert(nxt == NULL || nxt-&gt;TState == ObjectWaiter::TS_ENTER, &quot;invariant&quot;);
 758     assert(prv == NULL || prv-&gt;TState == ObjectWaiter::TS_ENTER, &quot;invariant&quot;);
 759   } else {
 760     assert(SelfNode-&gt;TState == ObjectWaiter::TS_CXQ, &quot;invariant&quot;);
 761     // Inopportune interleaving -- Self is still on the cxq.
 762     // This usually means the enqueue of self raced an exiting thread.
 763     // Normally we&#39;ll find Self near the front of the cxq, so
 764     // dequeueing is typically fast.  If needbe we can accelerate
 765     // this with some MCS/CHL-like bidirectional list hints and advisory
 766     // back-links so dequeueing from the interior will normally operate
 767     // in constant-time.
 768     // Dequeue Self from either the head (with CAS) or from the interior
 769     // with a linear-time scan and normal non-atomic memory operations.
 770     // CONSIDER: if Self is on the cxq then simply drain cxq into EntryList
 771     // and then unlink Self from EntryList.  We have to drain eventually,
 772     // so it might as well be now.
 773 
 774     ObjectWaiter * v = _cxq;
 775     assert(v != NULL, &quot;invariant&quot;);
 776     if (v != SelfNode || Atomic::cmpxchg(&amp;_cxq, v, SelfNode-&gt;_next) != v) {
 777       // The CAS above can fail from interference IFF a &quot;RAT&quot; arrived.
 778       // In that case Self must be in the interior and can no longer be
 779       // at the head of cxq.
 780       if (v == SelfNode) {
 781         assert(_cxq != v, &quot;invariant&quot;);
 782         v = _cxq;          // CAS above failed - start scan at head of list
 783       }
 784       ObjectWaiter * p;
 785       ObjectWaiter * q = NULL;
 786       for (p = v; p != NULL &amp;&amp; p != SelfNode; p = p-&gt;_next) {
 787         q = p;
 788         assert(p-&gt;TState == ObjectWaiter::TS_CXQ, &quot;invariant&quot;);
 789       }
 790       assert(v != SelfNode, &quot;invariant&quot;);
 791       assert(p == SelfNode, &quot;Node not found on cxq&quot;);
 792       assert(p != _cxq, &quot;invariant&quot;);
 793       assert(q != NULL, &quot;invariant&quot;);
 794       assert(q-&gt;_next == p, &quot;invariant&quot;);
 795       q-&gt;_next = p-&gt;_next;
 796     }
 797   }
 798 
 799 #ifdef ASSERT
 800   // Diagnostic hygiene ...
 801   SelfNode-&gt;_prev  = (ObjectWaiter *) 0xBAD;
 802   SelfNode-&gt;_next  = (ObjectWaiter *) 0xBAD;
 803   SelfNode-&gt;TState = ObjectWaiter::TS_RUN;
 804 #endif
 805 }
 806 
 807 // -----------------------------------------------------------------------------
 808 // Exit support
 809 //
 810 // exit()
 811 // ~~~~~~
 812 // Note that the collector can&#39;t reclaim the objectMonitor or deflate
 813 // the object out from underneath the thread calling ::exit() as the
 814 // thread calling ::exit() never transitions to a stable state.
 815 // This inhibits GC, which in turn inhibits asynchronous (and
 816 // inopportune) reclamation of &quot;this&quot;.
 817 //
 818 // We&#39;d like to assert that: (THREAD-&gt;thread_state() != _thread_blocked) ;
 819 // There&#39;s one exception to the claim above, however.  EnterI() can call
 820 // exit() to drop a lock if the acquirer has been externally suspended.
 821 // In that case exit() is called with _thread_state as _thread_blocked,
 822 // but the monitor&#39;s _contentions field is &gt; 0, which inhibits reclamation.
 823 //
 824 // 1-0 exit
 825 // ~~~~~~~~
 826 // ::exit() uses a canonical 1-1 idiom with a MEMBAR although some of
 827 // the fast-path operators have been optimized so the common ::exit()
 828 // operation is 1-0, e.g., see macroAssembler_x86.cpp: fast_unlock().
 829 // The code emitted by fast_unlock() elides the usual MEMBAR.  This
 830 // greatly improves latency -- MEMBAR and CAS having considerable local
 831 // latency on modern processors -- but at the cost of &quot;stranding&quot;.  Absent the
 832 // MEMBAR, a thread in fast_unlock() can race a thread in the slow
 833 // ::enter() path, resulting in the entering thread being stranding
 834 // and a progress-liveness failure.   Stranding is extremely rare.
 835 // We use timers (timed park operations) &amp; periodic polling to detect
 836 // and recover from stranding.  Potentially stranded threads periodically
 837 // wake up and poll the lock.  See the usage of the _Responsible variable.
 838 //
 839 // The CAS() in enter provides for safety and exclusion, while the CAS or
 840 // MEMBAR in exit provides for progress and avoids stranding.  1-0 locking
 841 // eliminates the CAS/MEMBAR from the exit path, but it admits stranding.
 842 // We detect and recover from stranding with timers.
 843 //
 844 // If a thread transiently strands it&#39;ll park until (a) another
 845 // thread acquires the lock and then drops the lock, at which time the
 846 // exiting thread will notice and unpark the stranded thread, or, (b)
 847 // the timer expires.  If the lock is high traffic then the stranding latency
 848 // will be low due to (a).  If the lock is low traffic then the odds of
 849 // stranding are lower, although the worst-case stranding latency
 850 // is longer.  Critically, we don&#39;t want to put excessive load in the
 851 // platform&#39;s timer subsystem.  We want to minimize both the timer injection
 852 // rate (timers created/sec) as well as the number of timers active at
 853 // any one time.  (more precisely, we want to minimize timer-seconds, which is
 854 // the integral of the # of active timers at any instant over time).
 855 // Both impinge on OS scalability.  Given that, at most one thread parked on
 856 // a monitor will use a timer.
 857 //
 858 // There is also the risk of a futile wake-up. If we drop the lock
 859 // another thread can reacquire the lock immediately, and we can
 860 // then wake a thread unnecessarily. This is benign, and we&#39;ve
 861 // structured the code so the windows are short and the frequency
 862 // of such futile wakups is low.
 863 
 864 void ObjectMonitor::exit(bool not_suspended, TRAPS) {
 865   Thread * const Self = THREAD;
 866   if (THREAD != _owner) {
 867     if (THREAD-&gt;is_lock_owned((address) _owner)) {
 868       // Transmute _owner from a BasicLock pointer to a Thread address.
 869       // We don&#39;t need to hold _mutex for this transition.
 870       // Non-null to Non-null is safe as long as all readers can
 871       // tolerate either flavor.
 872       assert(_recursions == 0, &quot;invariant&quot;);
 873       _owner = THREAD;
 874       _recursions = 0;
 875     } else {
 876       // Apparent unbalanced locking ...
 877       // Naively we&#39;d like to throw IllegalMonitorStateException.
 878       // As a practical matter we can neither allocate nor throw an
 879       // exception as ::exit() can be called from leaf routines.
 880       // see x86_32.ad Fast_Unlock() and the I1 and I2 properties.
 881       // Upon deeper reflection, however, in a properly run JVM the only
 882       // way we should encounter this situation is in the presence of
 883       // unbalanced JNI locking. TODO: CheckJNICalls.
 884       // See also: CR4414101
 885 #ifdef ASSERT
 886       LogStreamHandle(Error, monitorinflation) lsh;
 887       lsh.print_cr(&quot;ERROR: ObjectMonitor::exit(): thread=&quot; INTPTR_FORMAT
 888                     &quot; is exiting an ObjectMonitor it does not own.&quot;, p2i(THREAD));
 889       lsh.print_cr(&quot;The imbalance is possibly caused by JNI locking.&quot;);
 890       print_debug_style_on(&amp;lsh);
 891 #endif
 892       assert(false, &quot;Non-balanced monitor enter/exit!&quot;);
 893       return;
 894     }
 895   }
 896 
 897   if (_recursions != 0) {
 898     _recursions--;        // this is simple recursive enter
 899     return;
 900   }
 901 
 902   // Invariant: after setting Responsible=null an thread must execute
 903   // a MEMBAR or other serializing instruction before fetching EntryList|cxq.
 904   _Responsible = NULL;
 905 
 906 #if INCLUDE_JFR
 907   // get the owner&#39;s thread id for the MonitorEnter event
 908   // if it is enabled and the thread isn&#39;t suspended
 909   if (not_suspended &amp;&amp; EventJavaMonitorEnter::is_enabled()) {
 910     _previous_owner_tid = JFR_THREAD_ID(Self);
 911   }
 912 #endif
 913 
 914   for (;;) {
 915     assert(THREAD == _owner, &quot;invariant&quot;);
 916 
 917     // release semantics: prior loads and stores from within the critical section
 918     // must not float (reorder) past the following store that drops the lock.
 919     Atomic::release_store(&amp;_owner, (void*)NULL);   // drop the lock
 920     OrderAccess::storeload();                      // See if we need to wake a successor
 921     if ((intptr_t(_EntryList)|intptr_t(_cxq)) == 0 || _succ != NULL) {
 922       return;
 923     }
 924     // Other threads are blocked trying to acquire the lock.
 925 
 926     // Normally the exiting thread is responsible for ensuring succession,
 927     // but if other successors are ready or other entering threads are spinning
 928     // then this thread can simply store NULL into _owner and exit without
 929     // waking a successor.  The existence of spinners or ready successors
 930     // guarantees proper succession (liveness).  Responsibility passes to the
 931     // ready or running successors.  The exiting thread delegates the duty.
 932     // More precisely, if a successor already exists this thread is absolved
 933     // of the responsibility of waking (unparking) one.
 934     //
 935     // The _succ variable is critical to reducing futile wakeup frequency.
 936     // _succ identifies the &quot;heir presumptive&quot; thread that has been made
 937     // ready (unparked) but that has not yet run.  We need only one such
 938     // successor thread to guarantee progress.
 939     // See http://www.usenix.org/events/jvm01/full_papers/dice/dice.pdf
 940     // section 3.3 &quot;Futile Wakeup Throttling&quot; for details.
 941     //
 942     // Note that spinners in Enter() also set _succ non-null.
 943     // In the current implementation spinners opportunistically set
 944     // _succ so that exiting threads might avoid waking a successor.
 945     // Another less appealing alternative would be for the exiting thread
 946     // to drop the lock and then spin briefly to see if a spinner managed
 947     // to acquire the lock.  If so, the exiting thread could exit
 948     // immediately without waking a successor, otherwise the exiting
 949     // thread would need to dequeue and wake a successor.
 950     // (Note that we&#39;d need to make the post-drop spin short, but no
 951     // shorter than the worst-case round-trip cache-line migration time.
 952     // The dropped lock needs to become visible to the spinner, and then
 953     // the acquisition of the lock by the spinner must become visible to
 954     // the exiting thread).
 955 
 956     // It appears that an heir-presumptive (successor) must be made ready.
 957     // Only the current lock owner can manipulate the EntryList or
 958     // drain _cxq, so we need to reacquire the lock.  If we fail
 959     // to reacquire the lock the responsibility for ensuring succession
 960     // falls to the new owner.
 961     //
 962     if (!Atomic::replace_if_null(&amp;_owner, THREAD)) {
 963       return;
 964     }
 965 
 966     guarantee(_owner == THREAD, &quot;invariant&quot;);
 967 
 968     ObjectWaiter * w = NULL;
 969 
 970     w = _EntryList;
 971     if (w != NULL) {
 972       // I&#39;d like to write: guarantee (w-&gt;_thread != Self).
 973       // But in practice an exiting thread may find itself on the EntryList.
 974       // Let&#39;s say thread T1 calls O.wait().  Wait() enqueues T1 on O&#39;s waitset and
 975       // then calls exit().  Exit release the lock by setting O._owner to NULL.
 976       // Let&#39;s say T1 then stalls.  T2 acquires O and calls O.notify().  The
 977       // notify() operation moves T1 from O&#39;s waitset to O&#39;s EntryList. T2 then
 978       // release the lock &quot;O&quot;.  T2 resumes immediately after the ST of null into
 979       // _owner, above.  T2 notices that the EntryList is populated, so it
 980       // reacquires the lock and then finds itself on the EntryList.
 981       // Given all that, we have to tolerate the circumstance where &quot;w&quot; is
 982       // associated with Self.
 983       assert(w-&gt;TState == ObjectWaiter::TS_ENTER, &quot;invariant&quot;);
 984       ExitEpilog(Self, w);
 985       return;
 986     }
 987 
 988     // If we find that both _cxq and EntryList are null then just
 989     // re-run the exit protocol from the top.
 990     w = _cxq;
 991     if (w == NULL) continue;
 992 
 993     // Drain _cxq into EntryList - bulk transfer.
 994     // First, detach _cxq.
 995     // The following loop is tantamount to: w = swap(&amp;cxq, NULL)
 996     for (;;) {
 997       assert(w != NULL, &quot;Invariant&quot;);
 998       ObjectWaiter * u = Atomic::cmpxchg(&amp;_cxq, w, (ObjectWaiter*)NULL);
 999       if (u == w) break;
1000       w = u;
1001     }
1002 
1003     assert(w != NULL, &quot;invariant&quot;);
1004     assert(_EntryList == NULL, &quot;invariant&quot;);
1005 
1006     // Convert the LIFO SLL anchored by _cxq into a DLL.
1007     // The list reorganization step operates in O(LENGTH(w)) time.
1008     // It&#39;s critical that this step operate quickly as
1009     // &quot;Self&quot; still holds the outer-lock, restricting parallelism
1010     // and effectively lengthening the critical section.
1011     // Invariant: s chases t chases u.
1012     // TODO-FIXME: consider changing EntryList from a DLL to a CDLL so
1013     // we have faster access to the tail.
1014 
1015     _EntryList = w;
1016     ObjectWaiter * q = NULL;
1017     ObjectWaiter * p;
1018     for (p = w; p != NULL; p = p-&gt;_next) {
1019       guarantee(p-&gt;TState == ObjectWaiter::TS_CXQ, &quot;Invariant&quot;);
1020       p-&gt;TState = ObjectWaiter::TS_ENTER;
1021       p-&gt;_prev = q;
1022       q = p;
1023     }
1024 
1025     // In 1-0 mode we need: ST EntryList; MEMBAR #storestore; ST _owner = NULL
1026     // The MEMBAR is satisfied by the release_store() operation in ExitEpilog().
1027 
1028     // See if we can abdicate to a spinner instead of waking a thread.
1029     // A primary goal of the implementation is to reduce the
1030     // context-switch rate.
1031     if (_succ != NULL) continue;
1032 
1033     w = _EntryList;
1034     if (w != NULL) {
1035       guarantee(w-&gt;TState == ObjectWaiter::TS_ENTER, &quot;invariant&quot;);
1036       ExitEpilog(Self, w);
1037       return;
1038     }
1039   }
1040 }
1041 
1042 // ExitSuspendEquivalent:
1043 // A faster alternate to handle_special_suspend_equivalent_condition()
1044 //
1045 // handle_special_suspend_equivalent_condition() unconditionally
1046 // acquires the SR_lock.  On some platforms uncontended MutexLocker()
1047 // operations have high latency.  Note that in ::enter() we call HSSEC
1048 // while holding the monitor, so we effectively lengthen the critical sections.
1049 //
1050 // There are a number of possible solutions:
1051 //
1052 // A.  To ameliorate the problem we might also defer state transitions
1053 //     to as late as possible -- just prior to parking.
1054 //     Given that, we&#39;d call HSSEC after having returned from park(),
1055 //     but before attempting to acquire the monitor.  This is only a
1056 //     partial solution.  It avoids calling HSSEC while holding the
1057 //     monitor (good), but it still increases successor reacquisition latency --
1058 //     the interval between unparking a successor and the time the successor
1059 //     resumes and retries the lock.  See ReenterI(), which defers state transitions.
1060 //     If we use this technique we can also avoid EnterI()-exit() loop
1061 //     in ::enter() where we iteratively drop the lock and then attempt
1062 //     to reacquire it after suspending.
1063 //
1064 // B.  In the future we might fold all the suspend bits into a
1065 //     composite per-thread suspend flag and then update it with CAS().
1066 //     Alternately, a Dekker-like mechanism with multiple variables
1067 //     would suffice:
1068 //       ST Self-&gt;_suspend_equivalent = false
1069 //       MEMBAR
1070 //       LD Self_&gt;_suspend_flags
1071 
1072 bool ObjectMonitor::ExitSuspendEquivalent(JavaThread * jSelf) {
1073   return jSelf-&gt;handle_special_suspend_equivalent_condition();
1074 }
1075 
1076 
1077 void ObjectMonitor::ExitEpilog(Thread * Self, ObjectWaiter * Wakee) {
1078   assert(_owner == Self, &quot;invariant&quot;);
1079 
1080   // Exit protocol:
1081   // 1. ST _succ = wakee
1082   // 2. membar #loadstore|#storestore;
1083   // 2. ST _owner = NULL
1084   // 3. unpark(wakee)
1085 
1086   _succ = Wakee-&gt;_thread;
1087   ParkEvent * Trigger = Wakee-&gt;_event;
1088 
1089   // Hygiene -- once we&#39;ve set _owner = NULL we can&#39;t safely dereference Wakee again.
1090   // The thread associated with Wakee may have grabbed the lock and &quot;Wakee&quot; may be
1091   // out-of-scope (non-extant).
1092   Wakee  = NULL;
1093 
1094   // Drop the lock
1095   Atomic::release_store(&amp;_owner, (void*)NULL);
1096   OrderAccess::fence();                               // ST _owner vs LD in unpark()
1097 
1098   DTRACE_MONITOR_PROBE(contended__exit, this, object(), Self);
1099   Trigger-&gt;unpark();
1100 
1101   // Maintain stats and report events to JVMTI
1102   OM_PERFDATA_OP(Parks, inc());
1103 }
1104 
1105 
1106 // -----------------------------------------------------------------------------
1107 // Class Loader deadlock handling.
1108 //
1109 // complete_exit exits a lock returning recursion count
1110 // complete_exit/reenter operate as a wait without waiting
1111 // complete_exit requires an inflated monitor
1112 // The _owner field is not always the Thread addr even with an
1113 // inflated monitor, e.g. the monitor can be inflated by a non-owning
1114 // thread due to contention.
1115 intx ObjectMonitor::complete_exit(TRAPS) {
1116   Thread * const Self = THREAD;
1117   assert(Self-&gt;is_Java_thread(), &quot;Must be Java thread!&quot;);
1118   JavaThread *jt = (JavaThread *)THREAD;
1119 
1120   assert(InitDone, &quot;Unexpectedly not initialized&quot;);
1121 
1122   if (THREAD != _owner) {
1123     if (THREAD-&gt;is_lock_owned ((address)_owner)) {
1124       assert(_recursions == 0, &quot;internal state error&quot;);
1125       _owner = THREAD;   // Convert from basiclock addr to Thread addr
1126       _recursions = 0;
1127     }
1128   }
1129 
1130   guarantee(Self == _owner, &quot;complete_exit not owner&quot;);
1131   intx save = _recursions; // record the old recursion count
1132   _recursions = 0;        // set the recursion level to be 0
1133   exit(true, Self);           // exit the monitor
1134   guarantee(_owner != Self, &quot;invariant&quot;);
1135   return save;
1136 }
1137 
1138 // reenter() enters a lock and sets recursion count
1139 // complete_exit/reenter operate as a wait without waiting
1140 void ObjectMonitor::reenter(intx recursions, TRAPS) {
1141   Thread * const Self = THREAD;
1142   assert(Self-&gt;is_Java_thread(), &quot;Must be Java thread!&quot;);
1143   JavaThread *jt = (JavaThread *)THREAD;
1144 
1145   guarantee(_owner != Self, &quot;reenter already owner&quot;);
1146   enter(THREAD);       // enter the monitor
1147   guarantee(_recursions == 0, &quot;reenter recursion&quot;);
1148   _recursions = recursions;
1149   return;
1150 }
1151 
1152 // Checks that the current THREAD owns this monitor and causes an
1153 // immediate return if it doesn&#39;t. We don&#39;t use the CHECK macro
1154 // because we want the IMSE to be the only exception that is thrown
1155 // from the call site when false is returned. Any other pending
1156 // exception is ignored.
1157 #define CHECK_OWNER()                                                  \
1158   do {                                                                 \
1159     if (!check_owner(THREAD)) {                                        \
1160        assert(HAS_PENDING_EXCEPTION, &quot;expected a pending IMSE here.&quot;); \
1161        return;                                                         \
1162      }                                                                 \
1163   } while (false)
1164 
1165 // Returns true if the specified thread owns the ObjectMonitor.
1166 // Otherwise returns false and throws IllegalMonitorStateException
1167 // (IMSE). If there is a pending exception and the specified thread
1168 // is not the owner, that exception will be replaced by the IMSE.
1169 bool ObjectMonitor::check_owner(Thread* THREAD) {
1170   if (_owner == THREAD) {
1171     return true;
1172   }
1173   if (THREAD-&gt;is_lock_owned((address)_owner)) {
1174     _owner = THREAD;  // convert from BasicLock addr to Thread addr
1175     _recursions = 0;
1176     return true;
1177   }
1178   THROW_MSG_(vmSymbols::java_lang_IllegalMonitorStateException(),
1179              &quot;current thread is not owner&quot;, false);
1180 }
1181 
1182 static void post_monitor_wait_event(EventJavaMonitorWait* event,
1183                                     ObjectMonitor* monitor,
1184                                     jlong notifier_tid,
1185                                     jlong timeout,
1186                                     bool timedout) {
1187   assert(event != NULL, &quot;invariant&quot;);
1188   assert(monitor != NULL, &quot;invariant&quot;);
1189   event-&gt;set_monitorClass(((oop)monitor-&gt;object())-&gt;klass());
1190   event-&gt;set_timeout(timeout);
1191   event-&gt;set_address((uintptr_t)monitor-&gt;object_addr());
1192   event-&gt;set_notifier(notifier_tid);
1193   event-&gt;set_timedOut(timedout);
1194   event-&gt;commit();
1195 }
1196 
1197 // -----------------------------------------------------------------------------
1198 // Wait/Notify/NotifyAll
1199 //
1200 // Note: a subset of changes to ObjectMonitor::wait()
1201 // will need to be replicated in complete_exit
1202 void ObjectMonitor::wait(jlong millis, bool interruptible, TRAPS) {
1203   Thread * const Self = THREAD;
1204   assert(Self-&gt;is_Java_thread(), &quot;Must be Java thread!&quot;);
1205   JavaThread *jt = (JavaThread *)THREAD;
1206 
1207   assert(InitDone, &quot;Unexpectedly not initialized&quot;);
1208 
1209   CHECK_OWNER();  // Throws IMSE if not owner.
1210 
1211   EventJavaMonitorWait event;
1212 
1213   // check for a pending interrupt
1214   if (interruptible &amp;&amp; jt-&gt;is_interrupted(true) &amp;&amp; !HAS_PENDING_EXCEPTION) {
1215     // post monitor waited event.  Note that this is past-tense, we are done waiting.
1216     if (JvmtiExport::should_post_monitor_waited()) {
1217       // Note: &#39;false&#39; parameter is passed here because the
1218       // wait was not timed out due to thread interrupt.
1219       JvmtiExport::post_monitor_waited(jt, this, false);
1220 
1221       // In this short circuit of the monitor wait protocol, the
1222       // current thread never drops ownership of the monitor and
1223       // never gets added to the wait queue so the current thread
1224       // cannot be made the successor. This means that the
1225       // JVMTI_EVENT_MONITOR_WAITED event handler cannot accidentally
1226       // consume an unpark() meant for the ParkEvent associated with
1227       // this ObjectMonitor.
1228     }
1229     if (event.should_commit()) {
1230       post_monitor_wait_event(&amp;event, this, 0, millis, false);
1231     }
1232     THROW(vmSymbols::java_lang_InterruptedException());
1233     return;
1234   }
1235 
1236   assert(Self-&gt;_Stalled == 0, &quot;invariant&quot;);
1237   Self-&gt;_Stalled = intptr_t(this);
1238   jt-&gt;set_current_waiting_monitor(this);
1239 
1240   // create a node to be put into the queue
1241   // Critically, after we reset() the event but prior to park(), we must check
1242   // for a pending interrupt.
1243   ObjectWaiter node(Self);
1244   node.TState = ObjectWaiter::TS_WAIT;
1245   Self-&gt;_ParkEvent-&gt;reset();
1246   OrderAccess::fence();          // ST into Event; membar ; LD interrupted-flag
1247 
1248   // Enter the waiting queue, which is a circular doubly linked list in this case
1249   // but it could be a priority queue or any data structure.
1250   // _WaitSetLock protects the wait queue.  Normally the wait queue is accessed only
1251   // by the the owner of the monitor *except* in the case where park()
1252   // returns because of a timeout of interrupt.  Contention is exceptionally rare
1253   // so we use a simple spin-lock instead of a heavier-weight blocking lock.
1254 
1255   Thread::SpinAcquire(&amp;_WaitSetLock, &quot;WaitSet - add&quot;);
1256   AddWaiter(&amp;node);
1257   Thread::SpinRelease(&amp;_WaitSetLock);
1258 
1259   _Responsible = NULL;
1260 
1261   intx save = _recursions;     // record the old recursion count
1262   _waiters++;                  // increment the number of waiters
1263   _recursions = 0;             // set the recursion level to be 1
1264   exit(true, Self);                    // exit the monitor
1265   guarantee(_owner != Self, &quot;invariant&quot;);
1266 
1267   // The thread is on the WaitSet list - now park() it.
1268   // On MP systems it&#39;s conceivable that a brief spin before we park
1269   // could be profitable.
1270   //
1271   // TODO-FIXME: change the following logic to a loop of the form
1272   //   while (!timeout &amp;&amp; !interrupted &amp;&amp; _notified == 0) park()
1273 
1274   int ret = OS_OK;
1275   int WasNotified = 0;
1276 
1277   // Need to check interrupt state whilst still _thread_in_vm
1278   bool interrupted = interruptible &amp;&amp; jt-&gt;is_interrupted(false);
1279 
1280   { // State transition wrappers
1281     OSThread* osthread = Self-&gt;osthread();
1282     OSThreadWaitState osts(osthread, true);
1283     {
1284       ThreadBlockInVM tbivm(jt);
1285       // Thread is in thread_blocked state and oop access is unsafe.
1286       jt-&gt;set_suspend_equivalent();
1287 
1288       if (interrupted || HAS_PENDING_EXCEPTION) {
1289         // Intentionally empty
1290       } else if (node._notified == 0) {
1291         if (millis &lt;= 0) {
1292           Self-&gt;_ParkEvent-&gt;park();
1293         } else {
1294           ret = Self-&gt;_ParkEvent-&gt;park(millis);
1295         }
1296       }
1297 
1298       // were we externally suspended while we were waiting?
1299       if (ExitSuspendEquivalent (jt)) {
1300         // TODO-FIXME: add -- if succ == Self then succ = null.
1301         jt-&gt;java_suspend_self();
1302       }
1303 
1304     } // Exit thread safepoint: transition _thread_blocked -&gt; _thread_in_vm
1305 
1306     // Node may be on the WaitSet, the EntryList (or cxq), or in transition
1307     // from the WaitSet to the EntryList.
1308     // See if we need to remove Node from the WaitSet.
1309     // We use double-checked locking to avoid grabbing _WaitSetLock
1310     // if the thread is not on the wait queue.
1311     //
1312     // Note that we don&#39;t need a fence before the fetch of TState.
1313     // In the worst case we&#39;ll fetch a old-stale value of TS_WAIT previously
1314     // written by the is thread. (perhaps the fetch might even be satisfied
1315     // by a look-aside into the processor&#39;s own store buffer, although given
1316     // the length of the code path between the prior ST and this load that&#39;s
1317     // highly unlikely).  If the following LD fetches a stale TS_WAIT value
1318     // then we&#39;ll acquire the lock and then re-fetch a fresh TState value.
1319     // That is, we fail toward safety.
1320 
1321     if (node.TState == ObjectWaiter::TS_WAIT) {
1322       Thread::SpinAcquire(&amp;_WaitSetLock, &quot;WaitSet - unlink&quot;);
1323       if (node.TState == ObjectWaiter::TS_WAIT) {
1324         DequeueSpecificWaiter(&amp;node);       // unlink from WaitSet
1325         assert(node._notified == 0, &quot;invariant&quot;);
1326         node.TState = ObjectWaiter::TS_RUN;
1327       }
1328       Thread::SpinRelease(&amp;_WaitSetLock);
1329     }
1330 
1331     // The thread is now either on off-list (TS_RUN),
1332     // on the EntryList (TS_ENTER), or on the cxq (TS_CXQ).
1333     // The Node&#39;s TState variable is stable from the perspective of this thread.
1334     // No other threads will asynchronously modify TState.
1335     guarantee(node.TState != ObjectWaiter::TS_WAIT, &quot;invariant&quot;);
1336     OrderAccess::loadload();
1337     if (_succ == Self) _succ = NULL;
1338     WasNotified = node._notified;
1339 
1340     // Reentry phase -- reacquire the monitor.
1341     // re-enter contended monitor after object.wait().
1342     // retain OBJECT_WAIT state until re-enter successfully completes
1343     // Thread state is thread_in_vm and oop access is again safe,
1344     // although the raw address of the object may have changed.
1345     // (Don&#39;t cache naked oops over safepoints, of course).
1346 
1347     // post monitor waited event. Note that this is past-tense, we are done waiting.
1348     if (JvmtiExport::should_post_monitor_waited()) {
1349       JvmtiExport::post_monitor_waited(jt, this, ret == OS_TIMEOUT);
1350 
1351       if (node._notified != 0 &amp;&amp; _succ == Self) {
1352         // In this part of the monitor wait-notify-reenter protocol it
1353         // is possible (and normal) for another thread to do a fastpath
1354         // monitor enter-exit while this thread is still trying to get
1355         // to the reenter portion of the protocol.
1356         //
1357         // The ObjectMonitor was notified and the current thread is
1358         // the successor which also means that an unpark() has already
1359         // been done. The JVMTI_EVENT_MONITOR_WAITED event handler can
1360         // consume the unpark() that was done when the successor was
1361         // set because the same ParkEvent is shared between Java
1362         // monitors and JVM/TI RawMonitors (for now).
1363         //
1364         // We redo the unpark() to ensure forward progress, i.e., we
1365         // don&#39;t want all pending threads hanging (parked) with none
1366         // entering the unlocked monitor.
1367         node._event-&gt;unpark();
1368       }
1369     }
1370 
1371     if (event.should_commit()) {
1372       post_monitor_wait_event(&amp;event, this, node._notifier_tid, millis, ret == OS_TIMEOUT);
1373     }
1374 
1375     OrderAccess::fence();
1376 
1377     assert(Self-&gt;_Stalled != 0, &quot;invariant&quot;);
1378     Self-&gt;_Stalled = 0;
1379 
1380     assert(_owner != Self, &quot;invariant&quot;);
1381     ObjectWaiter::TStates v = node.TState;
1382     if (v == ObjectWaiter::TS_RUN) {
1383       enter(Self);
1384     } else {
1385       guarantee(v == ObjectWaiter::TS_ENTER || v == ObjectWaiter::TS_CXQ, &quot;invariant&quot;);
1386       ReenterI(Self, &amp;node);
1387       node.wait_reenter_end(this);
1388     }
1389 
1390     // Self has reacquired the lock.
1391     // Lifecycle - the node representing Self must not appear on any queues.
1392     // Node is about to go out-of-scope, but even if it were immortal we wouldn&#39;t
1393     // want residual elements associated with this thread left on any lists.
1394     guarantee(node.TState == ObjectWaiter::TS_RUN, &quot;invariant&quot;);
1395     assert(_owner == Self, &quot;invariant&quot;);
1396     assert(_succ != Self, &quot;invariant&quot;);
1397   } // OSThreadWaitState()
1398 
1399   jt-&gt;set_current_waiting_monitor(NULL);
1400 
1401   guarantee(_recursions == 0, &quot;invariant&quot;);
1402   _recursions = save;     // restore the old recursion count
1403   _waiters--;             // decrement the number of waiters
1404 
1405   // Verify a few postconditions
1406   assert(_owner == Self, &quot;invariant&quot;);
1407   assert(_succ != Self, &quot;invariant&quot;);
1408   assert(((oop)(object()))-&gt;mark() == markWord::encode(this), &quot;invariant&quot;);
1409 
1410   // check if the notification happened
1411   if (!WasNotified) {
1412     // no, it could be timeout or Thread.interrupt() or both
1413     // check for interrupt event, otherwise it is timeout
1414     if (interruptible &amp;&amp; jt-&gt;is_interrupted(true) &amp;&amp; !HAS_PENDING_EXCEPTION) {
1415       THROW(vmSymbols::java_lang_InterruptedException());
1416     }
1417   }
1418 
1419   // NOTE: Spurious wake up will be consider as timeout.
1420   // Monitor notify has precedence over thread interrupt.
1421 }
1422 
1423 
1424 // Consider:
1425 // If the lock is cool (cxq == null &amp;&amp; succ == null) and we&#39;re on an MP system
1426 // then instead of transferring a thread from the WaitSet to the EntryList
1427 // we might just dequeue a thread from the WaitSet and directly unpark() it.
1428 
1429 void ObjectMonitor::INotify(Thread * Self) {
1430   Thread::SpinAcquire(&amp;_WaitSetLock, &quot;WaitSet - notify&quot;);
1431   ObjectWaiter * iterator = DequeueWaiter();
1432   if (iterator != NULL) {
1433     guarantee(iterator-&gt;TState == ObjectWaiter::TS_WAIT, &quot;invariant&quot;);
1434     guarantee(iterator-&gt;_notified == 0, &quot;invariant&quot;);
1435     // Disposition - what might we do with iterator ?
1436     // a.  add it directly to the EntryList - either tail (policy == 1)
1437     //     or head (policy == 0).
1438     // b.  push it onto the front of the _cxq (policy == 2).
1439     // For now we use (b).
1440 
1441     iterator-&gt;TState = ObjectWaiter::TS_ENTER;
1442 
1443     iterator-&gt;_notified = 1;
1444     iterator-&gt;_notifier_tid = JFR_THREAD_ID(Self);
1445 
1446     ObjectWaiter * list = _EntryList;
1447     if (list != NULL) {
1448       assert(list-&gt;_prev == NULL, &quot;invariant&quot;);
1449       assert(list-&gt;TState == ObjectWaiter::TS_ENTER, &quot;invariant&quot;);
1450       assert(list != iterator, &quot;invariant&quot;);
1451     }
1452 
1453     // prepend to cxq
1454     if (list == NULL) {
1455       iterator-&gt;_next = iterator-&gt;_prev = NULL;
1456       _EntryList = iterator;
1457     } else {
1458       iterator-&gt;TState = ObjectWaiter::TS_CXQ;
1459       for (;;) {
1460         ObjectWaiter * front = _cxq;
1461         iterator-&gt;_next = front;
1462         if (Atomic::cmpxchg(&amp;_cxq, front, iterator) == front) {
1463           break;
1464         }
1465       }
1466     }
1467 
1468     // _WaitSetLock protects the wait queue, not the EntryList.  We could
1469     // move the add-to-EntryList operation, above, outside the critical section
1470     // protected by _WaitSetLock.  In practice that&#39;s not useful.  With the
1471     // exception of  wait() timeouts and interrupts the monitor owner
1472     // is the only thread that grabs _WaitSetLock.  There&#39;s almost no contention
1473     // on _WaitSetLock so it&#39;s not profitable to reduce the length of the
1474     // critical section.
1475 
1476     iterator-&gt;wait_reenter_begin(this);
1477   }
1478   Thread::SpinRelease(&amp;_WaitSetLock);
1479 }
1480 
1481 // Consider: a not-uncommon synchronization bug is to use notify() when
1482 // notifyAll() is more appropriate, potentially resulting in stranded
1483 // threads; this is one example of a lost wakeup. A useful diagnostic
1484 // option is to force all notify() operations to behave as notifyAll().
1485 //
1486 // Note: We can also detect many such problems with a &quot;minimum wait&quot;.
1487 // When the &quot;minimum wait&quot; is set to a small non-zero timeout value
1488 // and the program does not hang whereas it did absent &quot;minimum wait&quot;,
1489 // that suggests a lost wakeup bug.
1490 
1491 void ObjectMonitor::notify(TRAPS) {
1492   CHECK_OWNER();  // Throws IMSE if not owner.
1493   if (_WaitSet == NULL) {
1494     return;
1495   }
1496   DTRACE_MONITOR_PROBE(notify, this, object(), THREAD);
1497   INotify(THREAD);
1498   OM_PERFDATA_OP(Notifications, inc(1));
1499 }
1500 
1501 
1502 // The current implementation of notifyAll() transfers the waiters one-at-a-time
1503 // from the waitset to the EntryList. This could be done more efficiently with a
1504 // single bulk transfer but in practice it&#39;s not time-critical. Beware too,
1505 // that in prepend-mode we invert the order of the waiters. Let&#39;s say that the
1506 // waitset is &quot;ABCD&quot; and the EntryList is &quot;XYZ&quot;. After a notifyAll() in prepend
1507 // mode the waitset will be empty and the EntryList will be &quot;DCBAXYZ&quot;.
1508 
1509 void ObjectMonitor::notifyAll(TRAPS) {
1510   CHECK_OWNER();  // Throws IMSE if not owner.
1511   if (_WaitSet == NULL) {
1512     return;
1513   }
1514 
1515   DTRACE_MONITOR_PROBE(notifyAll, this, object(), THREAD);
1516   int tally = 0;
1517   while (_WaitSet != NULL) {
1518     tally++;
1519     INotify(THREAD);
1520   }
1521 
1522   OM_PERFDATA_OP(Notifications, inc(tally));
1523 }
1524 
1525 // -----------------------------------------------------------------------------
1526 // Adaptive Spinning Support
1527 //
1528 // Adaptive spin-then-block - rational spinning
1529 //
1530 // Note that we spin &quot;globally&quot; on _owner with a classic SMP-polite TATAS
1531 // algorithm.  On high order SMP systems it would be better to start with
1532 // a brief global spin and then revert to spinning locally.  In the spirit of MCS/CLH,
1533 // a contending thread could enqueue itself on the cxq and then spin locally
1534 // on a thread-specific variable such as its ParkEvent._Event flag.
1535 // That&#39;s left as an exercise for the reader.  Note that global spinning is
1536 // not problematic on Niagara, as the L2 cache serves the interconnect and
1537 // has both low latency and massive bandwidth.
1538 //
1539 // Broadly, we can fix the spin frequency -- that is, the % of contended lock
1540 // acquisition attempts where we opt to spin --  at 100% and vary the spin count
1541 // (duration) or we can fix the count at approximately the duration of
1542 // a context switch and vary the frequency.   Of course we could also
1543 // vary both satisfying K == Frequency * Duration, where K is adaptive by monitor.
1544 // For a description of &#39;Adaptive spin-then-block mutual exclusion in
1545 // multi-threaded processing,&#39; see U.S. Pat. No. 8046758.
1546 //
1547 // This implementation varies the duration &quot;D&quot;, where D varies with
1548 // the success rate of recent spin attempts. (D is capped at approximately
1549 // length of a round-trip context switch).  The success rate for recent
1550 // spin attempts is a good predictor of the success rate of future spin
1551 // attempts.  The mechanism adapts automatically to varying critical
1552 // section length (lock modality), system load and degree of parallelism.
1553 // D is maintained per-monitor in _SpinDuration and is initialized
1554 // optimistically.  Spin frequency is fixed at 100%.
1555 //
1556 // Note that _SpinDuration is volatile, but we update it without locks
1557 // or atomics.  The code is designed so that _SpinDuration stays within
1558 // a reasonable range even in the presence of races.  The arithmetic
1559 // operations on _SpinDuration are closed over the domain of legal values,
1560 // so at worst a race will install and older but still legal value.
1561 // At the very worst this introduces some apparent non-determinism.
1562 // We might spin when we shouldn&#39;t or vice-versa, but since the spin
1563 // count are relatively short, even in the worst case, the effect is harmless.
1564 //
1565 // Care must be taken that a low &quot;D&quot; value does not become an
1566 // an absorbing state.  Transient spinning failures -- when spinning
1567 // is overall profitable -- should not cause the system to converge
1568 // on low &quot;D&quot; values.  We want spinning to be stable and predictable
1569 // and fairly responsive to change and at the same time we don&#39;t want
1570 // it to oscillate, become metastable, be &quot;too&quot; non-deterministic,
1571 // or converge on or enter undesirable stable absorbing states.
1572 //
1573 // We implement a feedback-based control system -- using past behavior
1574 // to predict future behavior.  We face two issues: (a) if the
1575 // input signal is random then the spin predictor won&#39;t provide optimal
1576 // results, and (b) if the signal frequency is too high then the control
1577 // system, which has some natural response lag, will &quot;chase&quot; the signal.
1578 // (b) can arise from multimodal lock hold times.  Transient preemption
1579 // can also result in apparent bimodal lock hold times.
1580 // Although sub-optimal, neither condition is particularly harmful, as
1581 // in the worst-case we&#39;ll spin when we shouldn&#39;t or vice-versa.
1582 // The maximum spin duration is rather short so the failure modes aren&#39;t bad.
1583 // To be conservative, I&#39;ve tuned the gain in system to bias toward
1584 // _not spinning.  Relatedly, the system can sometimes enter a mode where it
1585 // &quot;rings&quot; or oscillates between spinning and not spinning.  This happens
1586 // when spinning is just on the cusp of profitability, however, so the
1587 // situation is not dire.  The state is benign -- there&#39;s no need to add
1588 // hysteresis control to damp the transition rate between spinning and
1589 // not spinning.
1590 
1591 // Spinning: Fixed frequency (100%), vary duration
1592 int ObjectMonitor::TrySpin(Thread * Self) {
1593   // Dumb, brutal spin.  Good for comparative measurements against adaptive spinning.
1594   int ctr = Knob_FixedSpin;
1595   if (ctr != 0) {
1596     while (--ctr &gt;= 0) {
1597       if (TryLock(Self) &gt; 0) return 1;
1598       SpinPause();
1599     }
1600     return 0;
1601   }
1602 
1603   for (ctr = Knob_PreSpin + 1; --ctr &gt;= 0;) {
1604     if (TryLock(Self) &gt; 0) {
1605       // Increase _SpinDuration ...
1606       // Note that we don&#39;t clamp SpinDuration precisely at SpinLimit.
1607       // Raising _SpurDuration to the poverty line is key.
1608       int x = _SpinDuration;
1609       if (x &lt; Knob_SpinLimit) {
1610         if (x &lt; Knob_Poverty) x = Knob_Poverty;
1611         _SpinDuration = x + Knob_BonusB;
1612       }
1613       return 1;
1614     }
1615     SpinPause();
1616   }
1617 
1618   // Admission control - verify preconditions for spinning
1619   //
1620   // We always spin a little bit, just to prevent _SpinDuration == 0 from
1621   // becoming an absorbing state.  Put another way, we spin briefly to
1622   // sample, just in case the system load, parallelism, contention, or lock
1623   // modality changed.
1624   //
1625   // Consider the following alternative:
1626   // Periodically set _SpinDuration = _SpinLimit and try a long/full
1627   // spin attempt.  &quot;Periodically&quot; might mean after a tally of
1628   // the # of failed spin attempts (or iterations) reaches some threshold.
1629   // This takes us into the realm of 1-out-of-N spinning, where we
1630   // hold the duration constant but vary the frequency.
1631 
1632   ctr = _SpinDuration;
1633   if (ctr &lt;= 0) return 0;
1634 
1635   if (NotRunnable(Self, (Thread *) _owner)) {
1636     return 0;
1637   }
1638 
1639   // We&#39;re good to spin ... spin ingress.
1640   // CONSIDER: use Prefetch::write() to avoid RTS-&gt;RTO upgrades
1641   // when preparing to LD...CAS _owner, etc and the CAS is likely
1642   // to succeed.
1643   if (_succ == NULL) {
1644     _succ = Self;
1645   }
1646   Thread * prv = NULL;
1647 
1648   // There are three ways to exit the following loop:
1649   // 1.  A successful spin where this thread has acquired the lock.
1650   // 2.  Spin failure with prejudice
1651   // 3.  Spin failure without prejudice
1652 
1653   while (--ctr &gt;= 0) {
1654 
1655     // Periodic polling -- Check for pending GC
1656     // Threads may spin while they&#39;re unsafe.
1657     // We don&#39;t want spinning threads to delay the JVM from reaching
1658     // a stop-the-world safepoint or to steal cycles from GC.
1659     // If we detect a pending safepoint we abort in order that
1660     // (a) this thread, if unsafe, doesn&#39;t delay the safepoint, and (b)
1661     // this thread, if safe, doesn&#39;t steal cycles from GC.
1662     // This is in keeping with the &quot;no loitering in runtime&quot; rule.
1663     // We periodically check to see if there&#39;s a safepoint pending.
1664     if ((ctr &amp; 0xFF) == 0) {
1665       if (SafepointMechanism::should_block(Self)) {
1666         goto Abort;           // abrupt spin egress
1667       }
1668       SpinPause();
1669     }
1670 
1671     // Probe _owner with TATAS
1672     // If this thread observes the monitor transition or flicker
1673     // from locked to unlocked to locked, then the odds that this
1674     // thread will acquire the lock in this spin attempt go down
1675     // considerably.  The same argument applies if the CAS fails
1676     // or if we observe _owner change from one non-null value to
1677     // another non-null value.   In such cases we might abort
1678     // the spin without prejudice or apply a &quot;penalty&quot; to the
1679     // spin count-down variable &quot;ctr&quot;, reducing it by 100, say.
1680 
1681     Thread * ox = (Thread *) _owner;
1682     if (ox == NULL) {
1683       ox = (Thread*)Atomic::cmpxchg(&amp;_owner, (void*)NULL, Self);
1684       if (ox == NULL) {
1685         // The CAS succeeded -- this thread acquired ownership
1686         // Take care of some bookkeeping to exit spin state.
1687         if (_succ == Self) {
1688           _succ = NULL;
1689         }
1690 
1691         // Increase _SpinDuration :
1692         // The spin was successful (profitable) so we tend toward
1693         // longer spin attempts in the future.
1694         // CONSIDER: factor &quot;ctr&quot; into the _SpinDuration adjustment.
1695         // If we acquired the lock early in the spin cycle it
1696         // makes sense to increase _SpinDuration proportionally.
1697         // Note that we don&#39;t clamp SpinDuration precisely at SpinLimit.
1698         int x = _SpinDuration;
1699         if (x &lt; Knob_SpinLimit) {
1700           if (x &lt; Knob_Poverty) x = Knob_Poverty;
1701           _SpinDuration = x + Knob_Bonus;
1702         }
1703         return 1;
1704       }
1705 
1706       // The CAS failed ... we can take any of the following actions:
1707       // * penalize: ctr -= CASPenalty
1708       // * exit spin with prejudice -- goto Abort;
1709       // * exit spin without prejudice.
1710       // * Since CAS is high-latency, retry again immediately.
1711       prv = ox;
1712       goto Abort;
1713     }
1714 
1715     // Did lock ownership change hands ?
1716     if (ox != prv &amp;&amp; prv != NULL) {
1717       goto Abort;
1718     }
1719     prv = ox;
1720 
1721     // Abort the spin if the owner is not executing.
1722     // The owner must be executing in order to drop the lock.
1723     // Spinning while the owner is OFFPROC is idiocy.
1724     // Consider: ctr -= RunnablePenalty ;
1725     if (NotRunnable(Self, ox)) {
1726       goto Abort;
1727     }
1728     if (_succ == NULL) {
1729       _succ = Self;
1730     }
1731   }
1732 
1733   // Spin failed with prejudice -- reduce _SpinDuration.
1734   // TODO: Use an AIMD-like policy to adjust _SpinDuration.
1735   // AIMD is globally stable.
1736   {
1737     int x = _SpinDuration;
1738     if (x &gt; 0) {
1739       // Consider an AIMD scheme like: x -= (x &gt;&gt; 3) + 100
1740       // This is globally sample and tends to damp the response.
1741       x -= Knob_Penalty;
1742       if (x &lt; 0) x = 0;
1743       _SpinDuration = x;
1744     }
1745   }
1746 
1747  Abort:
1748   if (_succ == Self) {
1749     _succ = NULL;
1750     // Invariant: after setting succ=null a contending thread
1751     // must recheck-retry _owner before parking.  This usually happens
1752     // in the normal usage of TrySpin(), but it&#39;s safest
1753     // to make TrySpin() as foolproof as possible.
1754     OrderAccess::fence();
1755     if (TryLock(Self) &gt; 0) return 1;
1756   }
1757   return 0;
1758 }
1759 
1760 // NotRunnable() -- informed spinning
1761 //
1762 // Don&#39;t bother spinning if the owner is not eligible to drop the lock.
1763 // Spin only if the owner thread is _thread_in_Java or _thread_in_vm.
1764 // The thread must be runnable in order to drop the lock in timely fashion.
1765 // If the _owner is not runnable then spinning will not likely be
1766 // successful (profitable).
1767 //
1768 // Beware -- the thread referenced by _owner could have died
1769 // so a simply fetch from _owner-&gt;_thread_state might trap.
1770 // Instead, we use SafeFetchXX() to safely LD _owner-&gt;_thread_state.
1771 // Because of the lifecycle issues, the _thread_state values
1772 // observed by NotRunnable() might be garbage.  NotRunnable must
1773 // tolerate this and consider the observed _thread_state value
1774 // as advisory.
1775 //
1776 // Beware too, that _owner is sometimes a BasicLock address and sometimes
1777 // a thread pointer.
1778 // Alternately, we might tag the type (thread pointer vs basiclock pointer)
1779 // with the LSB of _owner.  Another option would be to probabilistically probe
1780 // the putative _owner-&gt;TypeTag value.
1781 //
1782 // Checking _thread_state isn&#39;t perfect.  Even if the thread is
1783 // in_java it might be blocked on a page-fault or have been preempted
1784 // and sitting on a ready/dispatch queue.
1785 //
1786 // The return value from NotRunnable() is *advisory* -- the
1787 // result is based on sampling and is not necessarily coherent.
1788 // The caller must tolerate false-negative and false-positive errors.
1789 // Spinning, in general, is probabilistic anyway.
1790 
1791 
1792 int ObjectMonitor::NotRunnable(Thread * Self, Thread * ox) {
1793   // Check ox-&gt;TypeTag == 2BAD.
1794   if (ox == NULL) return 0;
1795 
1796   // Avoid transitive spinning ...
1797   // Say T1 spins or blocks trying to acquire L.  T1._Stalled is set to L.
1798   // Immediately after T1 acquires L it&#39;s possible that T2, also
1799   // spinning on L, will see L.Owner=T1 and T1._Stalled=L.
1800   // This occurs transiently after T1 acquired L but before
1801   // T1 managed to clear T1.Stalled.  T2 does not need to abort
1802   // its spin in this circumstance.
1803   intptr_t BlockedOn = SafeFetchN((intptr_t *) &amp;ox-&gt;_Stalled, intptr_t(1));
1804 
1805   if (BlockedOn == 1) return 1;
1806   if (BlockedOn != 0) {
1807     return BlockedOn != intptr_t(this) &amp;&amp; _owner == ox;
1808   }
1809 
1810   assert(sizeof(((JavaThread *)ox)-&gt;_thread_state == sizeof(int)), &quot;invariant&quot;);
1811   int jst = SafeFetch32((int *) &amp;((JavaThread *) ox)-&gt;_thread_state, -1);;
1812   // consider also: jst != _thread_in_Java -- but that&#39;s overspecific.
1813   return jst == _thread_blocked || jst == _thread_in_native;
1814 }
1815 
1816 
1817 // -----------------------------------------------------------------------------
1818 // WaitSet management ...
1819 
1820 ObjectWaiter::ObjectWaiter(Thread* thread) {
1821   _next     = NULL;
1822   _prev     = NULL;
1823   _notified = 0;
1824   _notifier_tid = 0;
1825   TState    = TS_RUN;
1826   _thread   = thread;
1827   _event    = thread-&gt;_ParkEvent;
1828   _active   = false;
1829   assert(_event != NULL, &quot;invariant&quot;);
1830 }
1831 
1832 void ObjectWaiter::wait_reenter_begin(ObjectMonitor * const mon) {
1833   JavaThread *jt = (JavaThread *)this-&gt;_thread;
1834   _active = JavaThreadBlockedOnMonitorEnterState::wait_reenter_begin(jt, mon);
1835 }
1836 
1837 void ObjectWaiter::wait_reenter_end(ObjectMonitor * const mon) {
1838   JavaThread *jt = (JavaThread *)this-&gt;_thread;
1839   JavaThreadBlockedOnMonitorEnterState::wait_reenter_end(jt, _active);
1840 }
1841 
1842 inline void ObjectMonitor::AddWaiter(ObjectWaiter* node) {
1843   assert(node != NULL, &quot;should not add NULL node&quot;);
1844   assert(node-&gt;_prev == NULL, &quot;node already in list&quot;);
1845   assert(node-&gt;_next == NULL, &quot;node already in list&quot;);
1846   // put node at end of queue (circular doubly linked list)
1847   if (_WaitSet == NULL) {
1848     _WaitSet = node;
1849     node-&gt;_prev = node;
1850     node-&gt;_next = node;
1851   } else {
1852     ObjectWaiter* head = _WaitSet;
1853     ObjectWaiter* tail = head-&gt;_prev;
1854     assert(tail-&gt;_next == head, &quot;invariant check&quot;);
1855     tail-&gt;_next = node;
1856     head-&gt;_prev = node;
1857     node-&gt;_next = head;
1858     node-&gt;_prev = tail;
1859   }
1860 }
1861 
1862 inline ObjectWaiter* ObjectMonitor::DequeueWaiter() {
1863   // dequeue the very first waiter
1864   ObjectWaiter* waiter = _WaitSet;
1865   if (waiter) {
1866     DequeueSpecificWaiter(waiter);
1867   }
1868   return waiter;
1869 }
1870 
1871 inline void ObjectMonitor::DequeueSpecificWaiter(ObjectWaiter* node) {
1872   assert(node != NULL, &quot;should not dequeue NULL node&quot;);
1873   assert(node-&gt;_prev != NULL, &quot;node already removed from list&quot;);
1874   assert(node-&gt;_next != NULL, &quot;node already removed from list&quot;);
1875   // when the waiter has woken up because of interrupt,
1876   // timeout or other spurious wake-up, dequeue the
1877   // waiter from waiting list
1878   ObjectWaiter* next = node-&gt;_next;
1879   if (next == node) {
1880     assert(node-&gt;_prev == node, &quot;invariant check&quot;);
1881     _WaitSet = NULL;
1882   } else {
1883     ObjectWaiter* prev = node-&gt;_prev;
1884     assert(prev-&gt;_next == node, &quot;invariant check&quot;);
1885     assert(next-&gt;_prev == node, &quot;invariant check&quot;);
1886     next-&gt;_prev = prev;
1887     prev-&gt;_next = next;
1888     if (_WaitSet == node) {
1889       _WaitSet = next;
1890     }
1891   }
1892   node-&gt;_next = NULL;
1893   node-&gt;_prev = NULL;
1894 }
1895 
1896 // -----------------------------------------------------------------------------
1897 // PerfData support
1898 PerfCounter * ObjectMonitor::_sync_ContendedLockAttempts       = NULL;
1899 PerfCounter * ObjectMonitor::_sync_FutileWakeups               = NULL;
1900 PerfCounter * ObjectMonitor::_sync_Parks                       = NULL;
1901 PerfCounter * ObjectMonitor::_sync_Notifications               = NULL;
1902 PerfCounter * ObjectMonitor::_sync_Inflations                  = NULL;
1903 PerfCounter * ObjectMonitor::_sync_Deflations                  = NULL;
1904 PerfLongVariable * ObjectMonitor::_sync_MonExtant              = NULL;
1905 
1906 // One-shot global initialization for the sync subsystem.
1907 // We could also defer initialization and initialize on-demand
1908 // the first time we call ObjectSynchronizer::inflate().
1909 // Initialization would be protected - like so many things - by
1910 // the MonitorCache_lock.
1911 
1912 void ObjectMonitor::Initialize() {
1913   assert(!InitDone, &quot;invariant&quot;);
1914 
1915   if (!os::is_MP()) {
1916     Knob_SpinLimit = 0;
1917     Knob_PreSpin   = 0;
1918     Knob_FixedSpin = -1;
1919   }
1920 
1921   if (UsePerfData) {
1922     EXCEPTION_MARK;
1923 #define NEWPERFCOUNTER(n)                                                \
1924   {                                                                      \
1925     n = PerfDataManager::create_counter(SUN_RT, #n, PerfData::U_Events,  \
1926                                         CHECK);                          \
1927   }
1928 #define NEWPERFVARIABLE(n)                                                \
1929   {                                                                       \
1930     n = PerfDataManager::create_variable(SUN_RT, #n, PerfData::U_Events,  \
1931                                          CHECK);                          \
1932   }
1933     NEWPERFCOUNTER(_sync_Inflations);
1934     NEWPERFCOUNTER(_sync_Deflations);
1935     NEWPERFCOUNTER(_sync_ContendedLockAttempts);
1936     NEWPERFCOUNTER(_sync_FutileWakeups);
1937     NEWPERFCOUNTER(_sync_Parks);
1938     NEWPERFCOUNTER(_sync_Notifications);
1939     NEWPERFVARIABLE(_sync_MonExtant);
1940 #undef NEWPERFCOUNTER
1941 #undef NEWPERFVARIABLE
1942   }
1943 
1944   DEBUG_ONLY(InitDone = true;)
1945 }
1946 
1947 void ObjectMonitor::print_on(outputStream* st) const {
1948   // The minimal things to print for markWord printing, more can be added for debugging and logging.
1949   st-&gt;print(&quot;{contentions=0x%08x,waiters=0x%08x&quot;
1950             &quot;,recursions=&quot; INTX_FORMAT &quot;,owner=&quot; INTPTR_FORMAT &quot;}&quot;,
1951             contentions(), waiters(), recursions(),
1952             p2i(owner()));
1953 }
1954 void ObjectMonitor::print() const { print_on(tty); }
1955 
1956 #ifdef ASSERT
1957 // Print the ObjectMonitor like a debugger would:
1958 //
1959 // (ObjectMonitor) 0x00007fdfb6012e40 = {
1960 //   _header = 0x0000000000000001
1961 //   _object = 0x000000070ff45fd0
1962 //   _next_om = 0x0000000000000000
1963 //   _pad_buf0 = {
1964 //     [0] = &#39;\0&#39;
1965 //     ...
1966 //     [103] = &#39;\0&#39;
1967 //   }
1968 //   _owner = 0x0000000000000000
1969 //   _previous_owner_tid = 0
1970 //   _recursions = 0
1971 //   _EntryList = 0x0000000000000000
1972 //   _cxq = 0x0000000000000000
1973 //   _succ = 0x0000000000000000
1974 //   _Responsible = 0x0000000000000000
1975 //   _Spinner = 0
1976 //   _SpinDuration = 5000
1977 //   _contentions = 0
1978 //   _WaitSet = 0x0000700009756248
1979 //   _waiters = 1
1980 //   _WaitSetLock = 0
1981 // }
1982 //
1983 void ObjectMonitor::print_debug_style_on(outputStream* st) const {
1984   st-&gt;print_cr(&quot;(ObjectMonitor*) &quot; INTPTR_FORMAT &quot; = {&quot;, p2i(this));
1985   st-&gt;print_cr(&quot;  _header = &quot; INTPTR_FORMAT, header().value());
1986   st-&gt;print_cr(&quot;  _object = &quot; INTPTR_FORMAT, p2i(_object));
1987   st-&gt;print_cr(&quot;  _next_om = &quot; INTPTR_FORMAT, p2i(_next_om));
1988   st-&gt;print_cr(&quot;  _pad_buf0 = {&quot;);
1989   st-&gt;print_cr(&quot;    [0] = &#39;\\0&#39;&quot;);
1990   st-&gt;print_cr(&quot;    ...&quot;);
1991   st-&gt;print_cr(&quot;    [%d] = &#39;\\0&#39;&quot;, (int)sizeof(_pad_buf0) - 1);
1992   st-&gt;print_cr(&quot;  }&quot;);
1993   st-&gt;print_cr(&quot;  _owner = &quot; INTPTR_FORMAT, p2i(_owner));
1994   st-&gt;print_cr(&quot;  _previous_owner_tid = &quot; JLONG_FORMAT, _previous_owner_tid);
1995   st-&gt;print_cr(&quot;  _recursions = &quot; INTX_FORMAT, _recursions);
1996   st-&gt;print_cr(&quot;  _EntryList = &quot; INTPTR_FORMAT, p2i(_EntryList));
1997   st-&gt;print_cr(&quot;  _cxq = &quot; INTPTR_FORMAT, p2i(_cxq));
1998   st-&gt;print_cr(&quot;  _succ = &quot; INTPTR_FORMAT, p2i(_succ));
1999   st-&gt;print_cr(&quot;  _Responsible = &quot; INTPTR_FORMAT, p2i(_Responsible));
2000   st-&gt;print_cr(&quot;  _Spinner = %d&quot;, _Spinner);
2001   st-&gt;print_cr(&quot;  _SpinDuration = %d&quot;, _SpinDuration);
2002   st-&gt;print_cr(&quot;  _contentions = %d&quot;, _contentions);
2003   st-&gt;print_cr(&quot;  _WaitSet = &quot; INTPTR_FORMAT, p2i(_WaitSet));
2004   st-&gt;print_cr(&quot;  _waiters = %d&quot;, _waiters);
2005   st-&gt;print_cr(&quot;  _WaitSetLock = %d&quot;, _WaitSetLock);
2006   st-&gt;print_cr(&quot;}&quot;);
2007 }
2008 #endif
    </pre>
  </body>
</html>