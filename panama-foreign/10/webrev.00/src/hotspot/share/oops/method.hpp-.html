<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Old src/hotspot/share/oops/method.hpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
  </head>
  <body>
    <pre>
   1 /*
   2  * Copyright (c) 1997, 2020, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
  23  */
  24 
  25 #ifndef SHARE_OOPS_METHOD_HPP
  26 #define SHARE_OOPS_METHOD_HPP
  27 
  28 #include &quot;classfile/vmSymbols.hpp&quot;
  29 #include &quot;code/compressedStream.hpp&quot;
  30 #include &quot;compiler/compilerDefinitions.hpp&quot;
  31 #include &quot;compiler/oopMap.hpp&quot;
  32 #include &quot;interpreter/invocationCounter.hpp&quot;
  33 #include &quot;oops/annotations.hpp&quot;
  34 #include &quot;oops/constantPool.hpp&quot;
  35 #include &quot;oops/methodCounters.hpp&quot;
  36 #include &quot;oops/instanceKlass.hpp&quot;
  37 #include &quot;oops/oop.hpp&quot;
  38 #include &quot;oops/typeArrayOop.hpp&quot;
  39 #include &quot;utilities/accessFlags.hpp&quot;
  40 #include &quot;utilities/align.hpp&quot;
  41 #include &quot;utilities/growableArray.hpp&quot;
  42 #include &quot;utilities/macros.hpp&quot;
  43 #if INCLUDE_JFR
  44 #include &quot;jfr/support/jfrTraceIdExtension.hpp&quot;
  45 #endif
  46 
  47 
  48 // A Method represents a Java method.
  49 //
  50 // Note that most applications load thousands of methods, so keeping the size of this
  51 // class small has a big impact on footprint.
  52 //
  53 // Note that native_function and signature_handler have to be at fixed offsets
  54 // (required by the interpreter)
  55 //
  56 //  Method embedded field layout (after declared fields):
  57 //   [EMBEDDED native_function       (present only if native) ]
  58 //   [EMBEDDED signature_handler     (present only if native) ]
  59 
  60 class CheckedExceptionElement;
  61 class LocalVariableTableElement;
  62 class AdapterHandlerEntry;
  63 class MethodData;
  64 class MethodCounters;
  65 class ConstMethod;
  66 class InlineTableSizes;
  67 class CompiledMethod;
  68 class InterpreterOopMap;
  69 
  70 class Method : public Metadata {
  71  friend class VMStructs;
  72  friend class JVMCIVMStructs;
  73  private:
  74   // If you add a new field that points to any metaspace object, you
  75   // must add this field to Method::metaspace_pointers_do().
  76   ConstMethod*      _constMethod;                // Method read-only data.
  77   MethodData*       _method_data;
  78   MethodCounters*   _method_counters;
  79   AccessFlags       _access_flags;               // Access flags
  80   int               _vtable_index;               // vtable index of this method (see VtableIndexFlag)
  81                                                  // note: can have vtables with &gt;2**16 elements (because of inheritance)
  82   u2                _intrinsic_id;               // vmSymbols::intrinsic_id (0 == _none)
  83 
  84   // Flags
  85   enum Flags {
  86     _caller_sensitive      = 1 &lt;&lt; 0,
  87     _force_inline          = 1 &lt;&lt; 1,
  88     _dont_inline           = 1 &lt;&lt; 2,
  89     _hidden                = 1 &lt;&lt; 3,
  90     _has_injected_profile  = 1 &lt;&lt; 4,
  91     _running_emcp          = 1 &lt;&lt; 5,
  92     _intrinsic_candidate   = 1 &lt;&lt; 6,
  93     _reserved_stack_access = 1 &lt;&lt; 7
  94   };
  95   mutable u2 _flags;
  96 
  97   JFR_ONLY(DEFINE_TRACE_FLAG;)
  98 
  99 #ifndef PRODUCT
 100   int               _compiled_invocation_count;  // Number of nmethod invocations so far (for perf. debugging)
 101 #endif
 102   // Entry point for calling both from and to the interpreter.
 103   address _i2i_entry;           // All-args-on-stack calling convention
 104   // Entry point for calling from compiled code, to compiled code if it exists
 105   // or else the interpreter.
 106   volatile address _from_compiled_entry;        // Cache of: _code ? _code-&gt;entry_point() : _adapter-&gt;c2i_entry()
 107   // The entry point for calling both from and to compiled code is
 108   // &quot;_code-&gt;entry_point()&quot;.  Because of tiered compilation and de-opt, this
 109   // field can come and go.  It can transition from NULL to not-null at any
 110   // time (whenever a compile completes).  It can transition from not-null to
 111   // NULL only at safepoints (because of a de-opt).
 112   CompiledMethod* volatile _code;                       // Points to the corresponding piece of native code
 113   volatile address           _from_interpreted_entry; // Cache of _code ? _adapter-&gt;i2c_entry() : _i2i_entry
 114 
 115 #if INCLUDE_AOT &amp;&amp; defined(TIERED)
 116   CompiledMethod* _aot_code;
 117 #endif
 118 
 119   // Constructor
 120   Method(ConstMethod* xconst, AccessFlags access_flags);
 121  public:
 122 
 123   static Method* allocate(ClassLoaderData* loader_data,
 124                           int byte_code_size,
 125                           AccessFlags access_flags,
 126                           InlineTableSizes* sizes,
 127                           ConstMethod::MethodType method_type,
 128                           TRAPS);
 129 
 130   // CDS and vtbl checking can create an empty Method to get vtbl pointer.
 131   Method(){}
 132 
 133   bool is_method() const volatile { return true; }
 134 
 135   void restore_unshareable_info(TRAPS);
 136 
 137   // accessors for instance variables
 138 
 139   ConstMethod* constMethod() const             { return _constMethod; }
 140   void set_constMethod(ConstMethod* xconst)    { _constMethod = xconst; }
 141 
 142 
 143   static address make_adapters(const methodHandle&amp; mh, TRAPS);
 144   address from_compiled_entry() const;
 145   address from_compiled_entry_no_trampoline() const;
 146   address from_interpreted_entry() const;
 147 
 148   // access flag
 149   AccessFlags access_flags() const               { return _access_flags;  }
 150   void set_access_flags(AccessFlags flags)       { _access_flags = flags; }
 151 
 152   // name
 153   Symbol* name() const                           { return constants()-&gt;symbol_at(name_index()); }
 154   int name_index() const                         { return constMethod()-&gt;name_index();         }
 155   void set_name_index(int index)                 { constMethod()-&gt;set_name_index(index);       }
 156 
 157   // signature
 158   Symbol* signature() const                      { return constants()-&gt;symbol_at(signature_index()); }
 159   int signature_index() const                    { return constMethod()-&gt;signature_index();         }
 160   void set_signature_index(int index)            { constMethod()-&gt;set_signature_index(index);       }
 161 
 162   // generics support
 163   Symbol* generic_signature() const              { int idx = generic_signature_index(); return ((idx != 0) ? constants()-&gt;symbol_at(idx) : (Symbol*)NULL); }
 164   int generic_signature_index() const            { return constMethod()-&gt;generic_signature_index(); }
 165   void set_generic_signature_index(int index)    { constMethod()-&gt;set_generic_signature_index(index); }
 166 
 167   // annotations support
 168   AnnotationArray* annotations() const           {
 169     return constMethod()-&gt;method_annotations();
 170   }
 171   AnnotationArray* parameter_annotations() const {
 172     return constMethod()-&gt;parameter_annotations();
 173   }
 174   AnnotationArray* annotation_default() const    {
 175     return constMethod()-&gt;default_annotations();
 176   }
 177   AnnotationArray* type_annotations() const      {
 178     return constMethod()-&gt;type_annotations();
 179   }
 180 
 181   // Helper routine: get klass name + &quot;.&quot; + method name + signature as
 182   // C string, for the purpose of providing more useful
 183   // fatal error handling. The string is allocated in resource
 184   // area if a buffer is not provided by the caller.
 185   char* name_and_sig_as_C_string() const;
 186   char* name_and_sig_as_C_string(char* buf, int size) const;
 187 
 188   // Static routine in the situations we don&#39;t have a Method*
 189   static char* name_and_sig_as_C_string(Klass* klass, Symbol* method_name, Symbol* signature);
 190   static char* name_and_sig_as_C_string(Klass* klass, Symbol* method_name, Symbol* signature, char* buf, int size);
 191 
 192   // Get return type + klass name + &quot;.&quot; + method name + ( parameters types )
 193   // as a C string or print it to an outputStream.
 194   // This is to be used to assemble strings passed to Java, so that
 195   // the text more resembles Java code. Used in exception messages.
 196   // Memory is allocated in the resource area; the caller needs
 197   // a ResourceMark.
 198   const char* external_name() const;
 199   void  print_external_name(outputStream *os) const;
 200 
 201   static const char* external_name(                  Klass* klass, Symbol* method_name, Symbol* signature);
 202   static void  print_external_name(outputStream *os, Klass* klass, Symbol* method_name, Symbol* signature);
 203 
 204   Bytecodes::Code java_code_at(int bci) const {
 205     return Bytecodes::java_code_at(this, bcp_from(bci));
 206   }
 207   Bytecodes::Code code_at(int bci) const {
 208     return Bytecodes::code_at(this, bcp_from(bci));
 209   }
 210 
 211   // JVMTI breakpoints
 212 #if !INCLUDE_JVMTI
 213   Bytecodes::Code orig_bytecode_at(int bci) const {
 214     ShouldNotReachHere();
 215     return Bytecodes::_shouldnotreachhere;
 216   }
 217   void set_orig_bytecode_at(int bci, Bytecodes::Code code) {
 218     ShouldNotReachHere();
 219   };
 220   u2   number_of_breakpoints() const {return 0;}
 221 #else // !INCLUDE_JVMTI
 222   Bytecodes::Code orig_bytecode_at(int bci) const;
 223   void set_orig_bytecode_at(int bci, Bytecodes::Code code);
 224   void set_breakpoint(int bci);
 225   void clear_breakpoint(int bci);
 226   void clear_all_breakpoints();
 227   // Tracking number of breakpoints, for fullspeed debugging.
 228   // Only mutated by VM thread.
 229   u2   number_of_breakpoints()             const {
 230     MethodCounters* mcs = method_counters();
 231     if (mcs == NULL) {
 232       return 0;
 233     } else {
 234       return mcs-&gt;number_of_breakpoints();
 235     }
 236   }
 237   void incr_number_of_breakpoints(TRAPS)         {
 238     MethodCounters* mcs = get_method_counters(CHECK);
 239     if (mcs != NULL) {
 240       mcs-&gt;incr_number_of_breakpoints();
 241     }
 242   }
 243   void decr_number_of_breakpoints(TRAPS)         {
 244     MethodCounters* mcs = get_method_counters(CHECK);
 245     if (mcs != NULL) {
 246       mcs-&gt;decr_number_of_breakpoints();
 247     }
 248   }
 249   // Initialization only
 250   void clear_number_of_breakpoints()             {
 251     MethodCounters* mcs = method_counters();
 252     if (mcs != NULL) {
 253       mcs-&gt;clear_number_of_breakpoints();
 254     }
 255   }
 256 #endif // !INCLUDE_JVMTI
 257 
 258   // index into InstanceKlass methods() array
 259   // note: also used by jfr
 260   u2 method_idnum() const           { return constMethod()-&gt;method_idnum(); }
 261   void set_method_idnum(u2 idnum)   { constMethod()-&gt;set_method_idnum(idnum); }
 262 
 263   u2 orig_method_idnum() const           { return constMethod()-&gt;orig_method_idnum(); }
 264   void set_orig_method_idnum(u2 idnum)   { constMethod()-&gt;set_orig_method_idnum(idnum); }
 265 
 266   // code size
 267   int code_size() const                  { return constMethod()-&gt;code_size(); }
 268 
 269   // method size in words
 270   int method_size() const                { return sizeof(Method)/wordSize + ( is_native() ? 2 : 0 ); }
 271 
 272   // constant pool for Klass* holding this method
 273   ConstantPool* constants() const              { return constMethod()-&gt;constants(); }
 274   void set_constants(ConstantPool* c)          { constMethod()-&gt;set_constants(c); }
 275 
 276   // max stack
 277   // return original max stack size for method verification
 278   int  verifier_max_stack() const                { return constMethod()-&gt;max_stack(); }
 279   int           max_stack() const                { return constMethod()-&gt;max_stack() + extra_stack_entries(); }
 280   void      set_max_stack(int size)              {        constMethod()-&gt;set_max_stack(size); }
 281 
 282   // max locals
 283   int  max_locals() const                        { return constMethod()-&gt;max_locals(); }
 284   void set_max_locals(int size)                  { constMethod()-&gt;set_max_locals(size); }
 285 
 286   int highest_comp_level() const;
 287   void set_highest_comp_level(int level);
 288   int highest_osr_comp_level() const;
 289   void set_highest_osr_comp_level(int level);
 290 
 291 #if COMPILER2_OR_JVMCI
 292   // Count of times method was exited via exception while interpreting
 293   void interpreter_throwout_increment(TRAPS) {
 294     MethodCounters* mcs = get_method_counters(CHECK);
 295     if (mcs != NULL) {
 296       mcs-&gt;interpreter_throwout_increment();
 297     }
 298   }
 299 #endif
 300 
 301   int  interpreter_throwout_count() const        {
 302     MethodCounters* mcs = method_counters();
 303     if (mcs == NULL) {
 304       return 0;
 305     } else {
 306       return mcs-&gt;interpreter_throwout_count();
 307     }
 308   }
 309 
 310   // size of parameters
 311   int  size_of_parameters() const                { return constMethod()-&gt;size_of_parameters(); }
 312   void set_size_of_parameters(int size)          { constMethod()-&gt;set_size_of_parameters(size); }
 313 
 314   bool has_stackmap_table() const {
 315     return constMethod()-&gt;has_stackmap_table();
 316   }
 317 
 318   Array&lt;u1&gt;* stackmap_data() const {
 319     return constMethod()-&gt;stackmap_data();
 320   }
 321 
 322   void set_stackmap_data(Array&lt;u1&gt;* sd) {
 323     constMethod()-&gt;set_stackmap_data(sd);
 324   }
 325 
 326   // exception handler table
 327   bool has_exception_handler() const
 328                              { return constMethod()-&gt;has_exception_handler(); }
 329   int exception_table_length() const
 330                              { return constMethod()-&gt;exception_table_length(); }
 331   ExceptionTableElement* exception_table_start() const
 332                              { return constMethod()-&gt;exception_table_start(); }
 333 
 334   // Finds the first entry point bci of an exception handler for an
 335   // exception of klass ex_klass thrown at throw_bci. A value of NULL
 336   // for ex_klass indicates that the exception klass is not known; in
 337   // this case it matches any constraint class. Returns -1 if the
 338   // exception cannot be handled in this method. The handler
 339   // constraint classes are loaded if necessary. Note that this may
 340   // throw an exception if loading of the constraint classes causes
 341   // an IllegalAccessError (bugid 4307310) or an OutOfMemoryError.
 342   // If an exception is thrown, returns the bci of the
 343   // exception handler which caused the exception to be thrown, which
 344   // is needed for proper retries. See, for example,
 345   // InterpreterRuntime::exception_handler_for_exception.
 346   static int fast_exception_handler_bci_for(const methodHandle&amp; mh, Klass* ex_klass, int throw_bci, TRAPS);
 347 
 348   static bool register_native(Klass* k,
 349                               Symbol* name,
 350                               Symbol* signature,
 351                               address entry,
 352                               TRAPS);
 353 
 354   // method data access
 355   MethodData* method_data() const              {
 356     return _method_data;
 357   }
 358 
 359   void set_method_data(MethodData* data);
 360 
 361   MethodCounters* method_counters() const {
 362     return _method_counters;
 363   }
 364 
 365   void clear_method_counters() {
 366     _method_counters = NULL;
 367   }
 368 
 369   bool init_method_counters(MethodCounters* counters);
 370 
 371 #ifdef TIERED
 372   // We are reusing interpreter_invocation_count as a holder for the previous event count!
 373   // We can do that since interpreter_invocation_count is not used in tiered.
 374   int prev_event_count() const                   {
 375     if (method_counters() == NULL) {
 376       return 0;
 377     } else {
 378       return method_counters()-&gt;interpreter_invocation_count();
 379     }
 380   }
 381   void set_prev_event_count(int count) {
 382     MethodCounters* mcs = method_counters();
 383     if (mcs != NULL) {
 384       mcs-&gt;set_interpreter_invocation_count(count);
 385     }
 386   }
 387   jlong prev_time() const                        {
 388     MethodCounters* mcs = method_counters();
 389     return mcs == NULL ? 0 : mcs-&gt;prev_time();
 390   }
 391   void set_prev_time(jlong time) {
 392     MethodCounters* mcs = method_counters();
 393     if (mcs != NULL) {
 394       mcs-&gt;set_prev_time(time);
 395     }
 396   }
 397   float rate() const                             {
 398     MethodCounters* mcs = method_counters();
 399     return mcs == NULL ? 0 : mcs-&gt;rate();
 400   }
 401   void set_rate(float rate) {
 402     MethodCounters* mcs = method_counters();
 403     if (mcs != NULL) {
 404       mcs-&gt;set_rate(rate);
 405     }
 406   }
 407 
 408 #if INCLUDE_AOT
 409   void set_aot_code(CompiledMethod* aot_code) {
 410     _aot_code = aot_code;
 411   }
 412 
 413   CompiledMethod* aot_code() const {
 414     return _aot_code;
 415   }
 416 #else
 417   CompiledMethod* aot_code() const { return NULL; }
 418 #endif // INCLUDE_AOT
 419 #endif // TIERED
 420 
 421   int nmethod_age() const {
 422     if (method_counters() == NULL) {
 423       return INT_MAX;
 424     } else {
 425       return method_counters()-&gt;nmethod_age();
 426     }
 427   }
 428 
 429   int invocation_count();
 430   int backedge_count();
 431 
 432   bool was_executed_more_than(int n);
 433   bool was_never_executed()                      { return !was_executed_more_than(0); }
 434 
 435   static void build_interpreter_method_data(const methodHandle&amp; method, TRAPS);
 436 
 437   static MethodCounters* build_method_counters(Method* m, TRAPS);
 438 
 439   int interpreter_invocation_count() {
 440     if (TieredCompilation) {
 441       return invocation_count();
 442     } else {
 443       MethodCounters* mcs = method_counters();
 444       return (mcs == NULL) ? 0 : mcs-&gt;interpreter_invocation_count();
 445     }
 446   }
 447 #if COMPILER2_OR_JVMCI
 448   int increment_interpreter_invocation_count(TRAPS) {
 449     if (TieredCompilation) ShouldNotReachHere();
 450     MethodCounters* mcs = get_method_counters(CHECK_0);
 451     return (mcs == NULL) ? 0 : mcs-&gt;increment_interpreter_invocation_count();
 452   }
 453 #endif
 454 
 455 #ifndef PRODUCT
 456   int  compiled_invocation_count() const         { return _compiled_invocation_count;  }
 457   void set_compiled_invocation_count(int count)  { _compiled_invocation_count = count; }
 458 #else
 459   // for PrintMethodData in a product build
 460   int  compiled_invocation_count() const         { return 0;  }
 461 #endif // not PRODUCT
 462 
 463   // Clear (non-shared space) pointers which could not be relevant
 464   // if this (shared) method were mapped into another JVM.
 465   void remove_unshareable_info();
 466 
 467   // nmethod/verified compiler entry
 468   address verified_code_entry();
 469   bool check_code() const;      // Not inline to avoid circular ref
 470   CompiledMethod* volatile code() const;
 471 
 472   // Locks CompiledMethod_lock if not held.
 473   void unlink_code(CompiledMethod *compare);
 474   // Locks CompiledMethod_lock if not held.
 475   void unlink_code();
 476 
 477 private:
 478   // Either called with CompiledMethod_lock held or from constructor.
 479   void clear_code();
 480 
 481 public:
 482   static void set_code(const methodHandle&amp; mh, CompiledMethod* code);
 483   void set_adapter_entry(AdapterHandlerEntry* adapter) {
 484     constMethod()-&gt;set_adapter_entry(adapter);
 485   }
 486   void set_adapter_trampoline(AdapterHandlerEntry** trampoline) {
 487     constMethod()-&gt;set_adapter_trampoline(trampoline);
 488   }
 489   void update_adapter_trampoline(AdapterHandlerEntry* adapter) {
 490     constMethod()-&gt;update_adapter_trampoline(adapter);
 491   }
 492   void set_from_compiled_entry(address entry) {
 493     _from_compiled_entry =  entry;
 494   }
 495 
 496   address get_i2c_entry();
 497   address get_c2i_entry();
 498   address get_c2i_unverified_entry();
 499   address get_c2i_no_clinit_check_entry();
 500   AdapterHandlerEntry* adapter() const {
 501     return constMethod()-&gt;adapter();
 502   }
 503   // setup entry points
 504   void link_method(const methodHandle&amp; method, TRAPS);
 505   // clear entry points. Used by sharing code during dump time
 506   void unlink_method() NOT_CDS_RETURN;
 507 
 508   virtual void metaspace_pointers_do(MetaspaceClosure* iter);
 509   virtual MetaspaceObj::Type type() const { return MethodType; }
 510 
 511   // vtable index
 512   enum VtableIndexFlag {
 513     // Valid vtable indexes are non-negative (&gt;= 0).
 514     // These few negative values are used as sentinels.
 515     itable_index_max        = -10, // first itable index, growing downward
 516     pending_itable_index    = -9,  // itable index will be assigned
 517     invalid_vtable_index    = -4,  // distinct from any valid vtable index
 518     garbage_vtable_index    = -3,  // not yet linked; no vtable layout yet
 519     nonvirtual_vtable_index = -2   // there is no need for vtable dispatch
 520     // 6330203 Note:  Do not use -1, which was overloaded with many meanings.
 521   };
 522   DEBUG_ONLY(bool valid_vtable_index() const     { return _vtable_index &gt;= nonvirtual_vtable_index; })
 523   bool has_vtable_index() const                  { return _vtable_index &gt;= 0; }
 524   int  vtable_index() const                      { return _vtable_index; }
 525   void set_vtable_index(int index);
 526   DEBUG_ONLY(bool valid_itable_index() const     { return _vtable_index &lt;= pending_itable_index; })
 527   bool has_itable_index() const                  { return _vtable_index &lt;= itable_index_max; }
 528   int  itable_index() const                      { assert(valid_itable_index(), &quot;&quot;);
 529                                                    return itable_index_max - _vtable_index; }
 530   void set_itable_index(int index);
 531 
 532   // interpreter entry
 533   address interpreter_entry() const              { return _i2i_entry; }
 534   // Only used when first initialize so we can set _i2i_entry and _from_interpreted_entry
 535   void set_interpreter_entry(address entry) {
 536     assert(!is_shared(),
 537            &quot;shared method&#39;s interpreter entry should not be changed at run time&quot;);
 538     if (_i2i_entry != entry) {
 539       _i2i_entry = entry;
 540     }
 541     if (_from_interpreted_entry != entry) {
 542       _from_interpreted_entry = entry;
 543     }
 544   }
 545 
 546   // native function (used for native methods only)
 547   enum {
 548     native_bind_event_is_interesting = true
 549   };
 550   address native_function() const                { return *(native_function_addr()); }
 551 
 552   // Must specify a real function (not NULL).
 553   // Use clear_native_function() to unregister.
 554   void set_native_function(address function, bool post_event_flag);
 555   bool has_native_function() const;
 556   void clear_native_function();
 557 
 558   // signature handler (used for native methods only)
 559   address signature_handler() const              { return *(signature_handler_addr()); }
 560   void set_signature_handler(address handler);
 561 
 562   // Interpreter oopmap support
 563   void mask_for(int bci, InterpreterOopMap* mask);
 564 
 565   // operations on invocation counter
 566   void print_invocation_count();
 567 
 568   // byte codes
 569   void    set_code(address code)      { return constMethod()-&gt;set_code(code); }
 570   address code_base() const           { return constMethod()-&gt;code_base(); }
 571   bool    contains(address bcp) const { return constMethod()-&gt;contains(bcp); }
 572 
 573   // prints byte codes
 574   void print_codes() const            { print_codes_on(tty); }
 575   void print_codes_on(outputStream* st) const;
 576   void print_codes_on(int from, int to, outputStream* st) const;
 577 
 578   // method parameters
 579   bool has_method_parameters() const
 580                          { return constMethod()-&gt;has_method_parameters(); }
 581   int method_parameters_length() const
 582                          { return constMethod()-&gt;method_parameters_length(); }
 583   MethodParametersElement* method_parameters_start() const
 584                           { return constMethod()-&gt;method_parameters_start(); }
 585 
 586   // checked exceptions
 587   int checked_exceptions_length() const
 588                          { return constMethod()-&gt;checked_exceptions_length(); }
 589   CheckedExceptionElement* checked_exceptions_start() const
 590                           { return constMethod()-&gt;checked_exceptions_start(); }
 591 
 592   // localvariable table
 593   bool has_localvariable_table() const
 594                           { return constMethod()-&gt;has_localvariable_table(); }
 595   int localvariable_table_length() const
 596                         { return constMethod()-&gt;localvariable_table_length(); }
 597   LocalVariableTableElement* localvariable_table_start() const
 598                          { return constMethod()-&gt;localvariable_table_start(); }
 599 
 600   bool has_linenumber_table() const
 601                               { return constMethod()-&gt;has_linenumber_table(); }
 602   u_char* compressed_linenumber_table() const
 603                        { return constMethod()-&gt;compressed_linenumber_table(); }
 604 
 605   // method holder (the Klass* holding this method)
 606   InstanceKlass* method_holder() const         { return constants()-&gt;pool_holder(); }
 607 
 608   void compute_size_of_parameters(Thread *thread); // word size of parameters (receiver if any + arguments)
 609   Symbol* klass_name() const;                    // returns the name of the method holder
 610   BasicType result_type() const                  { return constMethod()-&gt;result_type(); }
 611   bool is_returning_oop() const                  { BasicType r = result_type(); return is_reference_type(r); }
 612   bool is_returning_fp() const                   { BasicType r = result_type(); return (r == T_FLOAT || r == T_DOUBLE); }
 613 
 614   // Checked exceptions thrown by this method (resolved to mirrors)
 615   objArrayHandle resolved_checked_exceptions(TRAPS) { return resolved_checked_exceptions_impl(this, THREAD); }
 616 
 617   // Access flags
 618   bool is_public() const                         { return access_flags().is_public();      }
 619   bool is_private() const                        { return access_flags().is_private();     }
 620   bool is_protected() const                      { return access_flags().is_protected();   }
 621   bool is_package_private() const                { return !is_public() &amp;&amp; !is_private() &amp;&amp; !is_protected(); }
 622   bool is_static() const                         { return access_flags().is_static();      }
 623   bool is_final() const                          { return access_flags().is_final();       }
 624   bool is_synchronized() const                   { return access_flags().is_synchronized();}
 625   bool is_native() const                         { return access_flags().is_native();      }
 626   bool is_abstract() const                       { return access_flags().is_abstract();    }
 627   bool is_strict() const                         { return access_flags().is_strict();      }
 628   bool is_synthetic() const                      { return access_flags().is_synthetic();   }
 629 
 630   // returns true if contains only return operation
 631   bool is_empty_method() const;
 632 
 633   // returns true if this is a vanilla constructor
 634   bool is_vanilla_constructor() const;
 635 
 636   // checks method and its method holder
 637   bool is_final_method() const;
 638   bool is_final_method(AccessFlags class_access_flags) const;
 639   // interface method declared with &#39;default&#39; - excludes private interface methods
 640   bool is_default_method() const;
 641 
 642   // true if method needs no dynamic dispatch (final and/or no vtable entry)
 643   bool can_be_statically_bound() const;
 644   bool can_be_statically_bound(InstanceKlass* context) const;
 645   bool can_be_statically_bound(AccessFlags class_access_flags) const;
 646 
 647   // returns true if the method has any backward branches.
 648   bool has_loops() {
 649     return access_flags().loops_flag_init() ? access_flags().has_loops() : compute_has_loops_flag();
 650   };
 651 
 652   bool compute_has_loops_flag();
 653 
 654   bool has_jsrs() {
 655     return access_flags().has_jsrs();
 656   };
 657   void set_has_jsrs() {
 658     _access_flags.set_has_jsrs();
 659   }
 660 
 661   // returns true if the method has any monitors.
 662   bool has_monitors() const                      { return is_synchronized() || access_flags().has_monitor_bytecodes(); }
 663   bool has_monitor_bytecodes() const             { return access_flags().has_monitor_bytecodes(); }
 664 
 665   void set_has_monitor_bytecodes()               { _access_flags.set_has_monitor_bytecodes(); }
 666 
 667   // monitor matching. This returns a conservative estimate of whether the monitorenter/monitorexit bytecodes
 668   // propererly nest in the method. It might return false, even though they actually nest properly, since the info.
 669   // has not been computed yet.
 670   bool guaranteed_monitor_matching() const       { return access_flags().is_monitor_matching(); }
 671   void set_guaranteed_monitor_matching()         { _access_flags.set_monitor_matching(); }
 672 
 673   // returns true if the method is an accessor function (setter/getter).
 674   bool is_accessor() const;
 675 
 676   // returns true if the method is a getter
 677   bool is_getter() const;
 678 
 679   // returns true if the method is a setter
 680   bool is_setter() const;
 681 
 682   // returns true if the method does nothing but return a constant of primitive type
 683   bool is_constant_getter() const;
 684 
 685   // returns true if the method is an initializer (&lt;init&gt; or &lt;clinit&gt;).
 686   bool is_initializer() const;
 687 
 688   // returns true if the method is static OR if the classfile version &lt; 51
 689   bool has_valid_initializer_flags() const;
 690 
 691   // returns true if the method name is &lt;clinit&gt; and the method has
 692   // valid static initializer flags.
 693   bool is_static_initializer() const;
 694 
 695   // returns true if the method name is &lt;init&gt;
 696   bool is_object_initializer() const;
 697 
 698   // compiled code support
 699   // NOTE: code() is inherently racy as deopt can be clearing code
 700   // simultaneously. Use with caution.
 701   bool has_compiled_code() const;
 702 
 703 #ifdef TIERED
 704   bool has_aot_code() const                      { return aot_code() != NULL; }
 705 #endif
 706 
 707   bool needs_clinit_barrier() const;
 708 
 709   // sizing
 710   static int header_size()                       {
 711     return align_up((int)sizeof(Method), wordSize) / wordSize;
 712   }
 713   static int size(bool is_native);
 714   int size() const                               { return method_size(); }
 715   void log_touched(TRAPS);
 716   static void print_touched_methods(outputStream* out);
 717 
 718   // interpreter support
 719   static ByteSize const_offset()                 { return byte_offset_of(Method, _constMethod       ); }
 720   static ByteSize access_flags_offset()          { return byte_offset_of(Method, _access_flags      ); }
 721   static ByteSize from_compiled_offset()         { return byte_offset_of(Method, _from_compiled_entry); }
 722   static ByteSize code_offset()                  { return byte_offset_of(Method, _code); }
 723   static ByteSize method_data_offset()           {
 724     return byte_offset_of(Method, _method_data);
 725   }
 726   static ByteSize method_counters_offset()       {
 727     return byte_offset_of(Method, _method_counters);
 728   }
 729 #ifndef PRODUCT
 730   static ByteSize compiled_invocation_counter_offset() { return byte_offset_of(Method, _compiled_invocation_count); }
 731 #endif // not PRODUCT
 732   static ByteSize native_function_offset()       { return in_ByteSize(sizeof(Method));                 }
 733   static ByteSize from_interpreted_offset()      { return byte_offset_of(Method, _from_interpreted_entry ); }
 734   static ByteSize interpreter_entry_offset()     { return byte_offset_of(Method, _i2i_entry ); }
 735   static ByteSize signature_handler_offset()     { return in_ByteSize(sizeof(Method) + wordSize);      }
 736   static ByteSize itable_index_offset()          { return byte_offset_of(Method, _vtable_index ); }
 737 
 738   // for code generation
 739   static int method_data_offset_in_bytes()       { return offset_of(Method, _method_data); }
 740   static int intrinsic_id_offset_in_bytes()      { return offset_of(Method, _intrinsic_id); }
 741   static int intrinsic_id_size_in_bytes()        { return sizeof(u2); }
 742 
 743   // Static methods that are used to implement member methods where an exposed this pointer
 744   // is needed due to possible GCs
 745   static objArrayHandle resolved_checked_exceptions_impl(Method* method, TRAPS);
 746 
 747   // Returns the byte code index from the byte code pointer
 748   int     bci_from(address bcp) const;
 749   address bcp_from(int bci) const;
 750   address bcp_from(address bcp) const;
 751   int validate_bci_from_bcp(address bcp) const;
 752   int validate_bci(int bci) const;
 753 
 754   // Returns the line number for a bci if debugging information for the method is prowided,
 755   // -1 is returned otherwise.
 756   int line_number_from_bci(int bci) const;
 757 
 758   // Reflection support
 759   bool is_overridden_in(Klass* k) const;
 760 
 761   // Stack walking support
 762   bool is_ignored_by_security_stack_walk() const;
 763 
 764   // JSR 292 support
 765   bool is_method_handle_intrinsic() const;          // MethodHandles::is_signature_polymorphic_intrinsic(intrinsic_id)
 766   bool is_compiled_lambda_form() const;             // intrinsic_id() == vmIntrinsics::_compiledLambdaForm
 767   bool has_member_arg() const;                      // intrinsic_id() == vmIntrinsics::_linkToSpecial, etc.
 768   static methodHandle make_method_handle_intrinsic(vmIntrinsics::ID iid, // _invokeBasic, _linkToVirtual
 769                                                    Symbol* signature, //anything at all
 770                                                    TRAPS);
 771   static Klass* check_non_bcp_klass(Klass* klass);
 772 
 773   enum {
 774     // How many extra stack entries for invokedynamic
 775     extra_stack_entries_for_jsr292 = 1
 776   };
 777 
 778   // this operates only on invoke methods:
 779   // presize interpreter frames for extra interpreter stack entries, if needed
 780   // Account for the extra appendix argument for invokehandle/invokedynamic
 781   static int extra_stack_entries() { return extra_stack_entries_for_jsr292; }
 782   static int extra_stack_words();  // = extra_stack_entries() * Interpreter::stackElementSize
 783 
 784   // RedefineClasses() support:
 785   bool is_old() const                               { return access_flags().is_old(); }
 786   void set_is_old()                                 { _access_flags.set_is_old(); }
 787   bool is_obsolete() const                          { return access_flags().is_obsolete(); }
 788   void set_is_obsolete()                            { _access_flags.set_is_obsolete(); }
 789   bool is_deleted() const                           { return access_flags().is_deleted(); }
 790   void set_is_deleted()                             { _access_flags.set_is_deleted(); }
 791 
 792   bool is_running_emcp() const {
 793     // EMCP methods are old but not obsolete or deleted. Equivalent
 794     // Modulo Constant Pool means the method is equivalent except
 795     // the constant pool and instructions that access the constant
 796     // pool might be different.
 797     // If a breakpoint is set in a redefined method, its EMCP methods that are
 798     // still running must have a breakpoint also.
 799     return (_flags &amp; _running_emcp) != 0;
 800   }
 801 
 802   void set_running_emcp(bool x) {
 803     _flags = x ? (_flags | _running_emcp) : (_flags &amp; ~_running_emcp);
 804   }
 805 
 806   bool on_stack() const                             { return access_flags().on_stack(); }
 807   void set_on_stack(const bool value);
 808 
 809   // see the definition in Method*.cpp for the gory details
 810   bool should_not_be_cached() const;
 811 
 812   // JVMTI Native method prefixing support:
 813   bool is_prefixed_native() const                   { return access_flags().is_prefixed_native(); }
 814   void set_is_prefixed_native()                     { _access_flags.set_is_prefixed_native(); }
 815 
 816   // Rewriting support
 817   static methodHandle clone_with_new_data(const methodHandle&amp; m, u_char* new_code, int new_code_length,
 818                                           u_char* new_compressed_linenumber_table, int new_compressed_linenumber_size, TRAPS);
 819 
 820   // jmethodID handling
 821   // Because the useful life-span of a jmethodID cannot be determined,
 822   // once created they are never reclaimed.  The methods to which they refer,
 823   // however, can be GC&#39;ed away if the class is unloaded or if the method is
 824   // made obsolete or deleted -- in these cases, the jmethodID
 825   // refers to NULL (as is the case for any weak reference).
 826   static jmethodID make_jmethod_id(ClassLoaderData* loader_data, Method* mh);
 827   static void destroy_jmethod_id(ClassLoaderData* loader_data, jmethodID mid);
 828 
 829   // Ensure there is enough capacity in the internal tracking data
 830   // structures to hold the number of jmethodIDs you plan to generate.
 831   // This saves substantial time doing allocations.
 832   static void ensure_jmethod_ids(ClassLoaderData* loader_data, int capacity);
 833 
 834   // Use resolve_jmethod_id() in situations where the caller is expected
 835   // to provide a valid jmethodID; the only sanity checks are in asserts;
 836   // result guaranteed not to be NULL.
 837   inline static Method* resolve_jmethod_id(jmethodID mid) {
 838     assert(mid != NULL, &quot;JNI method id should not be null&quot;);
 839     return *((Method**)mid);
 840   }
 841 
 842   // Use checked_resolve_jmethod_id() in situations where the caller
 843   // should provide a valid jmethodID, but might not. NULL is returned
 844   // when the jmethodID does not refer to a valid method.
 845   static Method* checked_resolve_jmethod_id(jmethodID mid);
 846 
 847   static void change_method_associated_with_jmethod_id(jmethodID old_jmid_ptr, Method* new_method);
 848   static bool is_method_id(jmethodID mid);
 849 
 850   // Clear methods
 851   static void clear_jmethod_ids(ClassLoaderData* loader_data);
 852   static void print_jmethod_ids(const ClassLoaderData* loader_data, outputStream* out) PRODUCT_RETURN;
 853 
 854   // Get this method&#39;s jmethodID -- allocate if it doesn&#39;t exist
 855   jmethodID jmethod_id();
 856 
 857   // Lookup the jmethodID for this method.  Return NULL if not found.
 858   // NOTE that this function can be called from a signal handler
 859   // (see AsyncGetCallTrace support for Forte Analyzer) and this
 860   // needs to be async-safe. No allocation should be done and
 861   // so handles are not used to avoid deadlock.
 862   jmethodID find_jmethod_id_or_null()               { return method_holder()-&gt;jmethod_id_or_null(this); }
 863 
 864   // Support for inlining of intrinsic methods
 865   vmIntrinsics::ID intrinsic_id() const          { return (vmIntrinsics::ID) _intrinsic_id;           }
 866   void     set_intrinsic_id(vmIntrinsics::ID id) {                           _intrinsic_id = (u2) id; }
 867 
 868   // Helper routines for intrinsic_id() and vmIntrinsics::method().
 869   void init_intrinsic_id();     // updates from _none if a match
 870   static vmSymbols::SID klass_id_for_intrinsics(const Klass* holder);
 871 
 872   bool caller_sensitive() {
 873     return (_flags &amp; _caller_sensitive) != 0;
 874   }
 875   void set_caller_sensitive(bool x) {
 876     _flags = x ? (_flags | _caller_sensitive) : (_flags &amp; ~_caller_sensitive);
 877   }
 878 
 879   bool force_inline() {
 880     return (_flags &amp; _force_inline) != 0;
 881   }
 882   void set_force_inline(bool x) {
 883     _flags = x ? (_flags | _force_inline) : (_flags &amp; ~_force_inline);
 884   }
 885 
 886   bool dont_inline() {
 887     return (_flags &amp; _dont_inline) != 0;
 888   }
 889   void set_dont_inline(bool x) {
 890     _flags = x ? (_flags | _dont_inline) : (_flags &amp; ~_dont_inline);
 891   }
 892 
 893   bool is_hidden() {
 894     return (_flags &amp; _hidden) != 0;
 895   }
 896   void set_hidden(bool x) {
 897     _flags = x ? (_flags | _hidden) : (_flags &amp; ~_hidden);
 898   }
 899 
 900   bool intrinsic_candidate() {
 901     return (_flags &amp; _intrinsic_candidate) != 0;
 902   }
 903   void set_intrinsic_candidate(bool x) {
 904     _flags = x ? (_flags | _intrinsic_candidate) : (_flags &amp; ~_intrinsic_candidate);
 905   }
 906 
 907   bool has_injected_profile() {
 908     return (_flags &amp; _has_injected_profile) != 0;
 909   }
 910   void set_has_injected_profile(bool x) {
 911     _flags = x ? (_flags | _has_injected_profile) : (_flags &amp; ~_has_injected_profile);
 912   }
 913 
 914   bool has_reserved_stack_access() {
 915     return (_flags &amp; _reserved_stack_access) != 0;
 916   }
 917 
 918   void set_has_reserved_stack_access(bool x) {
 919     _flags = x ? (_flags | _reserved_stack_access) : (_flags &amp; ~_reserved_stack_access);
 920   }
 921 
 922   JFR_ONLY(DEFINE_TRACE_FLAG_ACCESSOR;)
 923 
 924   ConstMethod::MethodType method_type() const {
 925       return _constMethod-&gt;method_type();
 926   }
 927   bool is_overpass() const { return method_type() == ConstMethod::OVERPASS; }
 928 
 929   // On-stack replacement support
 930   bool has_osr_nmethod(int level, bool match_level) {
 931    return method_holder()-&gt;lookup_osr_nmethod(this, InvocationEntryBci, level, match_level) != NULL;
 932   }
 933 
 934   int mark_osr_nmethods() {
 935     return method_holder()-&gt;mark_osr_nmethods(this);
 936   }
 937 
 938   nmethod* lookup_osr_nmethod_for(int bci, int level, bool match_level) {
 939     return method_holder()-&gt;lookup_osr_nmethod(this, bci, level, match_level);
 940   }
 941 
 942   // Find if klass for method is loaded
 943   bool is_klass_loaded_by_klass_index(int klass_index) const;
 944   bool is_klass_loaded(int refinfo_index, bool must_be_resolved = false) const;
 945 
 946   // Indicates whether compilation failed earlier for this method, or
 947   // whether it is not compilable for another reason like having a
 948   // breakpoint set in it.
 949   bool  is_not_compilable(int comp_level = CompLevel_any) const;
 950   void set_not_compilable(const char* reason, int comp_level = CompLevel_all, bool report = true);
 951   void set_not_compilable_quietly(const char* reason, int comp_level = CompLevel_all) {
 952     set_not_compilable(reason, comp_level, false);
 953   }
 954   bool  is_not_osr_compilable(int comp_level = CompLevel_any) const;
 955   void set_not_osr_compilable(const char* reason, int comp_level = CompLevel_all, bool report = true);
 956   void set_not_osr_compilable_quietly(const char* reason, int comp_level = CompLevel_all) {
 957     set_not_osr_compilable(reason, comp_level, false);
 958   }
 959   bool is_always_compilable() const;
 960 
 961  private:
 962   void print_made_not_compilable(int comp_level, bool is_osr, bool report, const char* reason);
 963 
 964  public:
 965   MethodCounters* get_method_counters(TRAPS) {
 966     if (_method_counters == NULL) {
 967       build_method_counters(this, CHECK_AND_CLEAR_NULL);
 968     }
 969     return _method_counters;
 970   }
 971 
 972   bool   is_not_c1_compilable() const         { return access_flags().is_not_c1_compilable();  }
 973   void  set_not_c1_compilable()               {       _access_flags.set_not_c1_compilable();   }
 974   void clear_not_c1_compilable()              {       _access_flags.clear_not_c1_compilable(); }
 975   bool   is_not_c2_compilable() const         { return access_flags().is_not_c2_compilable();  }
 976   void  set_not_c2_compilable()               {       _access_flags.set_not_c2_compilable();   }
 977   void clear_not_c2_compilable()              {       _access_flags.clear_not_c2_compilable(); }
 978 
 979   bool    is_not_c1_osr_compilable() const    { return is_not_c1_compilable(); }  // don&#39;t waste an accessFlags bit
 980   void   set_not_c1_osr_compilable()          {       set_not_c1_compilable(); }  // don&#39;t waste an accessFlags bit
 981   void clear_not_c1_osr_compilable()          {     clear_not_c1_compilable(); }  // don&#39;t waste an accessFlags bit
 982   bool   is_not_c2_osr_compilable() const     { return access_flags().is_not_c2_osr_compilable();  }
 983   void  set_not_c2_osr_compilable()           {       _access_flags.set_not_c2_osr_compilable();   }
 984   void clear_not_c2_osr_compilable()          {       _access_flags.clear_not_c2_osr_compilable(); }
 985 
 986   // Background compilation support
 987   bool queued_for_compilation() const  { return access_flags().queued_for_compilation(); }
 988   void set_queued_for_compilation()    { _access_flags.set_queued_for_compilation();     }
 989   void clear_queued_for_compilation()  { _access_flags.clear_queued_for_compilation();   }
 990 
 991   // Resolve all classes in signature, return &#39;true&#39; if successful
 992   static bool load_signature_classes(const methodHandle&amp; m, TRAPS);
 993 
 994   // Return if true if not all classes references in signature, including return type, has been loaded
 995   static bool has_unloaded_classes_in_signature(const methodHandle&amp; m, TRAPS);
 996 
 997   // Printing
 998   void print_short_name(outputStream* st = tty); // prints as klassname::methodname; Exposed so field engineers can debug VM
 999 #if INCLUDE_JVMTI
1000   void print_name(outputStream* st = tty); // prints as &quot;virtual void foo(int)&quot;; exposed for TraceRedefineClasses
1001 #else
1002   void print_name(outputStream* st = tty)        PRODUCT_RETURN; // prints as &quot;virtual void foo(int)&quot;
1003 #endif
1004 
1005   typedef int (*method_comparator_func)(Method* a, Method* b);
1006 
1007   // Helper routine used for method sorting
1008   static void sort_methods(Array&lt;Method*&gt;* methods, bool set_idnums = true, method_comparator_func func = NULL);
1009 
1010   // Deallocation function for redefine classes or if an error occurs
1011   void deallocate_contents(ClassLoaderData* loader_data);
1012 
1013   void release_C_heap_structures();
1014 
1015   Method* get_new_method() const {
1016     InstanceKlass* holder = method_holder();
1017     Method* new_method = holder-&gt;method_with_idnum(orig_method_idnum());
1018 
1019     assert(new_method != NULL, &quot;method_with_idnum() should not be NULL&quot;);
1020     assert(this != new_method, &quot;sanity check&quot;);
1021     return new_method;
1022   }
1023 
1024   // Printing
1025 #ifndef PRODUCT
1026   void print_on(outputStream* st) const;
1027 #endif
1028   void print_value_on(outputStream* st) const;
1029   void print_linkage_flags(outputStream* st) PRODUCT_RETURN;
1030 
1031   const char* internal_name() const { return &quot;{method}&quot;; }
1032 
1033   // Check for valid method pointer
1034   static bool has_method_vptr(const void* ptr);
1035   static bool is_valid_method(const Method* m);
1036 
1037   // Verify
1038   void verify() { verify_on(tty); }
1039   void verify_on(outputStream* st);
1040 
1041  private:
1042 
1043   // Inlined elements
1044   address* native_function_addr() const          { assert(is_native(), &quot;must be native&quot;); return (address*) (this+1); }
1045   address* signature_handler_addr() const        { return native_function_addr() + 1; }
1046 };
1047 
1048 
1049 // Utility class for compressing line number tables
1050 
1051 class CompressedLineNumberWriteStream: public CompressedWriteStream {
1052  private:
1053   int _bci;
1054   int _line;
1055  public:
1056   // Constructor
1057   CompressedLineNumberWriteStream(int initial_size) : CompressedWriteStream(initial_size), _bci(0), _line(0) {}
1058   CompressedLineNumberWriteStream(u_char* buffer, int initial_size) : CompressedWriteStream(buffer, initial_size), _bci(0), _line(0) {}
1059 
1060   // Write (bci, line number) pair to stream
1061   void write_pair_regular(int bci_delta, int line_delta);
1062 
1063   // If (bci delta, line delta) fits in (5-bit unsigned, 3-bit unsigned)
1064   // we save it as one byte, otherwise we write a 0xFF escape character
1065   // and use regular compression. 0x0 is used as end-of-stream terminator.
1066   void write_pair_inline(int bci, int line);
1067 
1068   void write_pair(int bci, int line);
1069 
1070   // Write end-of-stream marker
1071   void write_terminator()                        { write_byte(0); }
1072 };
1073 
1074 
1075 // Utility class for decompressing line number tables
1076 
1077 class CompressedLineNumberReadStream: public CompressedReadStream {
1078  private:
1079   int _bci;
1080   int _line;
1081  public:
1082   // Constructor
1083   CompressedLineNumberReadStream(u_char* buffer);
1084   // Read (bci, line number) pair from stream. Returns false at end-of-stream.
1085   bool read_pair();
1086   // Accessing bci and line number (after calling read_pair)
1087   int bci() const                               { return _bci; }
1088   int line() const                              { return _line; }
1089 };
1090 
1091 
1092 #if INCLUDE_JVMTI
1093 
1094 /// Fast Breakpoints.
1095 
1096 // If this structure gets more complicated (because bpts get numerous),
1097 // move it into its own header.
1098 
1099 // There is presently no provision for concurrent access
1100 // to breakpoint lists, which is only OK for JVMTI because
1101 // breakpoints are written only at safepoints, and are read
1102 // concurrently only outside of safepoints.
1103 
1104 class BreakpointInfo : public CHeapObj&lt;mtClass&gt; {
1105   friend class VMStructs;
1106  private:
1107   Bytecodes::Code  _orig_bytecode;
1108   int              _bci;
1109   u2               _name_index;       // of method
1110   u2               _signature_index;  // of method
1111   BreakpointInfo*  _next;             // simple storage allocation
1112 
1113  public:
1114   BreakpointInfo(Method* m, int bci);
1115 
1116   // accessors
1117   Bytecodes::Code orig_bytecode()                     { return _orig_bytecode; }
1118   void        set_orig_bytecode(Bytecodes::Code code) { _orig_bytecode = code; }
1119   int         bci()                                   { return _bci; }
1120 
1121   BreakpointInfo*          next() const               { return _next; }
1122   void                 set_next(BreakpointInfo* n)    { _next = n; }
1123 
1124   // helps for searchers
1125   bool match(const Method* m, int bci) {
1126     return bci == _bci &amp;&amp; match(m);
1127   }
1128 
1129   bool match(const Method* m) {
1130     return _name_index == m-&gt;name_index() &amp;&amp;
1131       _signature_index == m-&gt;signature_index();
1132   }
1133 
1134   void set(Method* method);
1135   void clear(Method* method);
1136 };
1137 
1138 #endif // INCLUDE_JVMTI
1139 
1140 // Utility class for access exception handlers
1141 class ExceptionTable : public StackObj {
1142  private:
1143   ExceptionTableElement* _table;
1144   u2  _length;
1145 
1146  public:
1147   ExceptionTable(const Method* m) {
1148     if (m-&gt;has_exception_handler()) {
1149       _table = m-&gt;exception_table_start();
1150       _length = m-&gt;exception_table_length();
1151     } else {
1152       _table = NULL;
1153       _length = 0;
1154     }
1155   }
1156 
1157   int length() const {
1158     return _length;
1159   }
1160 
1161   u2 start_pc(int idx) const {
1162     assert(idx &lt; _length, &quot;out of bounds&quot;);
1163     return _table[idx].start_pc;
1164   }
1165 
1166   void set_start_pc(int idx, u2 value) {
1167     assert(idx &lt; _length, &quot;out of bounds&quot;);
1168     _table[idx].start_pc = value;
1169   }
1170 
1171   u2 end_pc(int idx) const {
1172     assert(idx &lt; _length, &quot;out of bounds&quot;);
1173     return _table[idx].end_pc;
1174   }
1175 
1176   void set_end_pc(int idx, u2 value) {
1177     assert(idx &lt; _length, &quot;out of bounds&quot;);
1178     _table[idx].end_pc = value;
1179   }
1180 
1181   u2 handler_pc(int idx) const {
1182     assert(idx &lt; _length, &quot;out of bounds&quot;);
1183     return _table[idx].handler_pc;
1184   }
1185 
1186   void set_handler_pc(int idx, u2 value) {
1187     assert(idx &lt; _length, &quot;out of bounds&quot;);
1188     _table[idx].handler_pc = value;
1189   }
1190 
1191   u2 catch_type_index(int idx) const {
1192     assert(idx &lt; _length, &quot;out of bounds&quot;);
1193     return _table[idx].catch_type_index;
1194   }
1195 
1196   void set_catch_type_index(int idx, u2 value) {
1197     assert(idx &lt; _length, &quot;out of bounds&quot;);
1198     _table[idx].catch_type_index = value;
1199   }
1200 };
1201 
1202 #endif // SHARE_OOPS_METHOD_HPP
    </pre>
  </body>
</html>