<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames src/hotspot/share/oops/instanceKlass.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
    <script type="text/javascript" src="../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>   1 /*
   2  * Copyright (c) 1997, 2020, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
  23  */
  24 
  25 #include &quot;precompiled.hpp&quot;
  26 #include &quot;jvm.h&quot;
  27 #include &quot;aot/aotLoader.hpp&quot;
  28 #include &quot;classfile/classFileParser.hpp&quot;
  29 #include &quot;classfile/classFileStream.hpp&quot;
  30 #include &quot;classfile/classLoader.hpp&quot;
  31 #include &quot;classfile/classLoaderData.inline.hpp&quot;
  32 #include &quot;classfile/javaClasses.hpp&quot;
  33 #include &quot;classfile/moduleEntry.hpp&quot;
  34 #include &quot;classfile/symbolTable.hpp&quot;
  35 #include &quot;classfile/systemDictionary.hpp&quot;
  36 #include &quot;classfile/systemDictionaryShared.hpp&quot;
  37 #include &quot;classfile/verifier.hpp&quot;
  38 #include &quot;classfile/vmSymbols.hpp&quot;
  39 #include &quot;code/dependencyContext.hpp&quot;
  40 #include &quot;compiler/compileBroker.hpp&quot;
  41 #include &quot;gc/shared/collectedHeap.inline.hpp&quot;
  42 #include &quot;interpreter/oopMapCache.hpp&quot;
  43 #include &quot;interpreter/rewriter.hpp&quot;
  44 #include &quot;jvmtifiles/jvmti.h&quot;
  45 #include &quot;logging/log.hpp&quot;
  46 #include &quot;logging/logMessage.hpp&quot;
  47 #include &quot;logging/logStream.hpp&quot;
  48 #include &quot;memory/allocation.inline.hpp&quot;
  49 #include &quot;memory/iterator.inline.hpp&quot;
  50 #include &quot;memory/metadataFactory.hpp&quot;
  51 #include &quot;memory/metaspaceClosure.hpp&quot;
  52 #include &quot;memory/metaspaceShared.hpp&quot;
  53 #include &quot;memory/oopFactory.hpp&quot;
  54 #include &quot;memory/resourceArea.hpp&quot;
  55 #include &quot;memory/universe.hpp&quot;
  56 #include &quot;oops/fieldStreams.inline.hpp&quot;
  57 #include &quot;oops/constantPool.hpp&quot;
  58 #include &quot;oops/instanceClassLoaderKlass.hpp&quot;
  59 #include &quot;oops/instanceKlass.inline.hpp&quot;
  60 #include &quot;oops/instanceMirrorKlass.hpp&quot;
  61 #include &quot;oops/instanceOop.hpp&quot;
  62 #include &quot;oops/klass.inline.hpp&quot;
  63 #include &quot;oops/method.hpp&quot;
  64 #include &quot;oops/oop.inline.hpp&quot;
  65 #include &quot;oops/recordComponent.hpp&quot;
  66 #include &quot;oops/symbol.hpp&quot;
  67 #include &quot;prims/jvmtiExport.hpp&quot;
  68 #include &quot;prims/jvmtiRedefineClasses.hpp&quot;
  69 #include &quot;prims/jvmtiThreadState.hpp&quot;
  70 #include &quot;prims/methodComparator.hpp&quot;
  71 #include &quot;runtime/atomic.hpp&quot;
  72 #include &quot;runtime/biasedLocking.hpp&quot;
  73 #include &quot;runtime/fieldDescriptor.inline.hpp&quot;
  74 #include &quot;runtime/handles.inline.hpp&quot;
  75 #include &quot;runtime/javaCalls.hpp&quot;
  76 #include &quot;runtime/mutexLocker.hpp&quot;
  77 #include &quot;runtime/orderAccess.hpp&quot;
  78 #include &quot;runtime/thread.inline.hpp&quot;
  79 #include &quot;services/classLoadingService.hpp&quot;
  80 #include &quot;services/threadService.hpp&quot;
  81 #include &quot;utilities/dtrace.hpp&quot;
  82 #include &quot;utilities/events.hpp&quot;
  83 #include &quot;utilities/macros.hpp&quot;
  84 #include &quot;utilities/stringUtils.hpp&quot;
  85 #ifdef COMPILER1
  86 #include &quot;c1/c1_Compiler.hpp&quot;
  87 #endif
  88 #if INCLUDE_JFR
  89 #include &quot;jfr/jfrEvents.hpp&quot;
  90 #endif
  91 
  92 
  93 #ifdef DTRACE_ENABLED
  94 
  95 
  96 #define HOTSPOT_CLASS_INITIALIZATION_required HOTSPOT_CLASS_INITIALIZATION_REQUIRED
  97 #define HOTSPOT_CLASS_INITIALIZATION_recursive HOTSPOT_CLASS_INITIALIZATION_RECURSIVE
  98 #define HOTSPOT_CLASS_INITIALIZATION_concurrent HOTSPOT_CLASS_INITIALIZATION_CONCURRENT
  99 #define HOTSPOT_CLASS_INITIALIZATION_erroneous HOTSPOT_CLASS_INITIALIZATION_ERRONEOUS
 100 #define HOTSPOT_CLASS_INITIALIZATION_super__failed HOTSPOT_CLASS_INITIALIZATION_SUPER_FAILED
 101 #define HOTSPOT_CLASS_INITIALIZATION_clinit HOTSPOT_CLASS_INITIALIZATION_CLINIT
 102 #define HOTSPOT_CLASS_INITIALIZATION_error HOTSPOT_CLASS_INITIALIZATION_ERROR
 103 #define HOTSPOT_CLASS_INITIALIZATION_end HOTSPOT_CLASS_INITIALIZATION_END
 104 #define DTRACE_CLASSINIT_PROBE(type, thread_type)                \
 105   {                                                              \
 106     char* data = NULL;                                           \
 107     int len = 0;                                                 \
 108     Symbol* clss_name = name();                                  \
 109     if (clss_name != NULL) {                                     \
 110       data = (char*)clss_name-&gt;bytes();                          \
 111       len = clss_name-&gt;utf8_length();                            \
 112     }                                                            \
 113     HOTSPOT_CLASS_INITIALIZATION_##type(                         \
 114       data, len, (void*)class_loader(), thread_type);            \
 115   }
 116 
 117 #define DTRACE_CLASSINIT_PROBE_WAIT(type, thread_type, wait)     \
 118   {                                                              \
 119     char* data = NULL;                                           \
 120     int len = 0;                                                 \
 121     Symbol* clss_name = name();                                  \
 122     if (clss_name != NULL) {                                     \
 123       data = (char*)clss_name-&gt;bytes();                          \
 124       len = clss_name-&gt;utf8_length();                            \
 125     }                                                            \
 126     HOTSPOT_CLASS_INITIALIZATION_##type(                         \
 127       data, len, (void*)class_loader(), thread_type, wait);      \
 128   }
 129 
 130 #else //  ndef DTRACE_ENABLED
 131 
 132 #define DTRACE_CLASSINIT_PROBE(type, thread_type)
 133 #define DTRACE_CLASSINIT_PROBE_WAIT(type, thread_type, wait)
 134 
 135 #endif //  ndef DTRACE_ENABLED
 136 
 137 static inline bool is_class_loader(const Symbol* class_name,
 138                                    const ClassFileParser&amp; parser) {
 139   assert(class_name != NULL, &quot;invariant&quot;);
 140 
 141   if (class_name == vmSymbols::java_lang_ClassLoader()) {
 142     return true;
 143   }
 144 
 145   if (SystemDictionary::ClassLoader_klass_loaded()) {
 146     const Klass* const super_klass = parser.super_klass();
 147     if (super_klass != NULL) {
 148       if (super_klass-&gt;is_subtype_of(SystemDictionary::ClassLoader_klass())) {
 149         return true;
 150       }
 151     }
 152   }
 153   return false;
 154 }
 155 
 156 // called to verify that k is a member of this nest
 157 bool InstanceKlass::has_nest_member(InstanceKlass* k, TRAPS) const {
 158   if (_nest_members == NULL || _nest_members == Universe::the_empty_short_array()) {
 159     if (log_is_enabled(Trace, class, nestmates)) {
 160       ResourceMark rm(THREAD);
 161       log_trace(class, nestmates)(&quot;Checked nest membership of %s in non-nest-host class %s&quot;,
 162                                   k-&gt;external_name(), this-&gt;external_name());
 163     }
 164     return false;
 165   }
 166 
 167   if (log_is_enabled(Trace, class, nestmates)) {
 168     ResourceMark rm(THREAD);
 169     log_trace(class, nestmates)(&quot;Checking nest membership of %s in %s&quot;,
 170                                 k-&gt;external_name(), this-&gt;external_name());
 171   }
 172 
 173   // Check for a resolved cp entry , else fall back to a name check.
 174   // We don&#39;t want to resolve any class other than the one being checked.
 175   for (int i = 0; i &lt; _nest_members-&gt;length(); i++) {
 176     int cp_index = _nest_members-&gt;at(i);
 177     if (_constants-&gt;tag_at(cp_index).is_klass()) {
 178       Klass* k2 = _constants-&gt;klass_at(cp_index, CHECK_false);
 179       if (k2 == k) {
 180         log_trace(class, nestmates)(&quot;- class is listed at nest_members[%d] =&gt; cp[%d]&quot;, i, cp_index);
 181         return true;
 182       }
 183     }
 184     else {
 185       Symbol* name = _constants-&gt;klass_name_at(cp_index);
 186       if (name == k-&gt;name()) {
 187         log_trace(class, nestmates)(&quot;- Found it at nest_members[%d] =&gt; cp[%d]&quot;, i, cp_index);
 188 
 189         // Names match so check actual klass - this may trigger class loading if
 190         // it doesn&#39;t match (though that should be impossible). But to be safe we
 191         // have to check for a compiler thread executing here.
 192         if (!THREAD-&gt;can_call_java() &amp;&amp; !_constants-&gt;tag_at(cp_index).is_klass()) {
 193           log_trace(class, nestmates)(&quot;- validation required resolution in an unsuitable thread&quot;);
 194           return false;
 195         }
 196 
 197         Klass* k2 = _constants-&gt;klass_at(cp_index, CHECK_false);
 198         if (k2 == k) {
 199           log_trace(class, nestmates)(&quot;- class is listed as a nest member&quot;);
 200           return true;
 201         }
 202         else {
 203           // same name but different klass!
 204           log_trace(class, nestmates)(&quot; - klass comparison failed!&quot;);
 205           // can&#39;t have two names the same, so we&#39;re done
 206           return false;
 207         }
 208       }
 209     }
 210   }
 211   log_trace(class, nestmates)(&quot;- class is NOT a nest member!&quot;);
 212   return false;
 213 }
 214 
 215 // Return nest-host class, resolving, validating and saving it if needed.
 216 // In cases where this is called from a thread that can not do classloading
 217 // (such as a native JIT thread) then we simply return NULL, which in turn
 218 // causes the access check to return false. Such code will retry the access
 219 // from a more suitable environment later.
 220 InstanceKlass* InstanceKlass::nest_host(Symbol* validationException, TRAPS) {
 221   InstanceKlass* nest_host_k = _nest_host;
 222   if (nest_host_k == NULL) {
 223     // need to resolve and save our nest-host class. This could be attempted
 224     // concurrently but as the result is idempotent and we don&#39;t use the class
 225     // then we do not need any synchronization beyond what is implicitly used
 226     // during class loading.
 227     if (_nest_host_index != 0) { // we have a real nest_host
 228       // Before trying to resolve check if we&#39;re in a suitable context
 229       if (!THREAD-&gt;can_call_java() &amp;&amp; !_constants-&gt;tag_at(_nest_host_index).is_klass()) {
 230         if (log_is_enabled(Trace, class, nestmates)) {
 231           ResourceMark rm(THREAD);
 232           log_trace(class, nestmates)(&quot;Rejected resolution of nest-host of %s in unsuitable thread&quot;,
 233                                       this-&gt;external_name());
 234         }
 235         return NULL;
 236       }
 237 
 238       if (log_is_enabled(Trace, class, nestmates)) {
 239         ResourceMark rm(THREAD);
 240         log_trace(class, nestmates)(&quot;Resolving nest-host of %s using cp entry for %s&quot;,
 241                                     this-&gt;external_name(),
 242                                     _constants-&gt;klass_name_at(_nest_host_index)-&gt;as_C_string());
 243       }
 244 
 245       Klass* k = _constants-&gt;klass_at(_nest_host_index, THREAD);
 246       if (HAS_PENDING_EXCEPTION) {
 247         Handle exc_h = Handle(THREAD, PENDING_EXCEPTION);
 248         if (exc_h-&gt;is_a(SystemDictionary::NoClassDefFoundError_klass())) {
 249           // throw a new CDNFE with the original as its cause, and a clear msg
 250           ResourceMark rm(THREAD);
 251           char buf[200];
 252           CLEAR_PENDING_EXCEPTION;
 253           jio_snprintf(buf, sizeof(buf),
 254                        &quot;Unable to load nest-host class (%s) of %s&quot;,
 255                        _constants-&gt;klass_name_at(_nest_host_index)-&gt;as_C_string(),
 256                        this-&gt;external_name());
 257           log_trace(class, nestmates)(&quot;%s - NoClassDefFoundError&quot;, buf);
 258           THROW_MSG_CAUSE_NULL(vmSymbols::java_lang_NoClassDefFoundError(), buf, exc_h);
 259         }
 260         // All other exceptions pass through (OOME, StackOverflowError, LinkageErrors etc).
 261         return NULL;
 262       }
 263 
 264       // A valid nest-host is an instance class in the current package that lists this
 265       // class as a nest member. If any of these conditions are not met we post the
 266       // requested exception type (if any) and return NULL
 267 
 268       const char* error = NULL;
 269 
 270       // JVMS 5.4.4 indicates package check comes first
 271       if (is_same_class_package(k)) {
 272 
 273         // Now check actual membership. We can&#39;t be a member if our &quot;host&quot; is
 274         // not an instance class.
 275         if (k-&gt;is_instance_klass()) {
 276           nest_host_k = InstanceKlass::cast(k);
 277 
 278           bool is_member = nest_host_k-&gt;has_nest_member(this, CHECK_NULL);
 279           if (is_member) {
 280             // save resolved nest-host value
 281             _nest_host = nest_host_k;
 282 
 283             if (log_is_enabled(Trace, class, nestmates)) {
 284               ResourceMark rm(THREAD);
 285               log_trace(class, nestmates)(&quot;Resolved nest-host of %s to %s&quot;,
 286                                           this-&gt;external_name(), k-&gt;external_name());
 287             }
 288             return nest_host_k;
 289           }
 290         }
 291         error = &quot;current type is not listed as a nest member&quot;;
 292       } else {
 293         error = &quot;types are in different packages&quot;;
 294       }
 295 
 296       if (log_is_enabled(Trace, class, nestmates)) {
 297         ResourceMark rm(THREAD);
 298         log_trace(class, nestmates)
 299           (&quot;Type %s (loader: %s) is not a nest member of &quot;
 300            &quot;resolved type %s (loader: %s): %s&quot;,
 301            this-&gt;external_name(),
 302            this-&gt;class_loader_data()-&gt;loader_name_and_id(),
 303            k-&gt;external_name(),
 304            k-&gt;class_loader_data()-&gt;loader_name_and_id(),
 305            error);
 306       }
 307 
 308       if (validationException != NULL &amp;&amp; THREAD-&gt;can_call_java()) {
 309         ResourceMark rm(THREAD);
 310         Exceptions::fthrow(THREAD_AND_LOCATION,
 311                            validationException,
 312                            &quot;Type %s (loader: %s) is not a nest member of %s (loader: %s): %s&quot;,
 313                            this-&gt;external_name(),
 314                            this-&gt;class_loader_data()-&gt;loader_name_and_id(),
 315                            k-&gt;external_name(),
 316                            k-&gt;class_loader_data()-&gt;loader_name_and_id(),
 317                            error
 318                            );
 319       }
 320       return NULL;
 321     } else {
 322       if (log_is_enabled(Trace, class, nestmates)) {
 323         ResourceMark rm(THREAD);
 324         log_trace(class, nestmates)(&quot;Type %s is not part of a nest: setting nest-host to self&quot;,
 325                                     this-&gt;external_name());
 326       }
 327       // save resolved nest-host value
 328       return (_nest_host = this);
 329     }
 330   }
 331   return nest_host_k;
 332 }
 333 
 334 // check if &#39;this&#39; and k are nestmates (same nest_host), or k is our nest_host,
 335 // or we are k&#39;s nest_host - all of which is covered by comparing the two
 336 // resolved_nest_hosts
 337 bool InstanceKlass::has_nestmate_access_to(InstanceKlass* k, TRAPS) {
 338 
 339   assert(this != k, &quot;this should be handled by higher-level code&quot;);
 340 
 341   // Per JVMS 5.4.4 we first resolve and validate the current class, then
 342   // the target class k. Resolution exceptions will be passed on by upper
 343   // layers. IncompatibleClassChangeErrors from membership validation failures
 344   // will also be passed through.
 345 
 346   Symbol* icce = vmSymbols::java_lang_IncompatibleClassChangeError();
 347   InstanceKlass* cur_host = nest_host(icce, CHECK_false);
 348   if (cur_host == NULL) {
 349     return false;
 350   }
 351 
 352   Klass* k_nest_host = k-&gt;nest_host(icce, CHECK_false);
 353   if (k_nest_host == NULL) {
 354     return false;
 355   }
 356 
 357   bool access = (cur_host == k_nest_host);
 358 
 359   if (log_is_enabled(Trace, class, nestmates)) {
 360     ResourceMark rm(THREAD);
 361     log_trace(class, nestmates)(&quot;Class %s does %shave nestmate access to %s&quot;,
 362                                 this-&gt;external_name(),
 363                                 access ? &quot;&quot; : &quot;NOT &quot;,
 364                                 k-&gt;external_name());
 365   }
 366 
 367   return access;
 368 }
 369 
 370 InstanceKlass* InstanceKlass::allocate_instance_klass(const ClassFileParser&amp; parser, TRAPS) {
 371   const int size = InstanceKlass::size(parser.vtable_size(),
 372                                        parser.itable_size(),
 373                                        nonstatic_oop_map_size(parser.total_oop_map_count()),
 374                                        parser.is_interface(),
 375                                        parser.is_unsafe_anonymous(),
 376                                        should_store_fingerprint(parser.is_unsafe_anonymous()));
 377 
 378   const Symbol* const class_name = parser.class_name();
 379   assert(class_name != NULL, &quot;invariant&quot;);
 380   ClassLoaderData* loader_data = parser.loader_data();
 381   assert(loader_data != NULL, &quot;invariant&quot;);
 382 
 383   InstanceKlass* ik;
 384 
 385   // Allocation
 386   if (REF_NONE == parser.reference_type()) {
 387     if (class_name == vmSymbols::java_lang_Class()) {
 388       // mirror
 389       ik = new (loader_data, size, THREAD) InstanceMirrorKlass(parser);
 390     }
 391     else if (is_class_loader(class_name, parser)) {
 392       // class loader
 393       ik = new (loader_data, size, THREAD) InstanceClassLoaderKlass(parser);
 394     } else {
 395       // normal
 396       ik = new (loader_data, size, THREAD) InstanceKlass(parser, InstanceKlass::_misc_kind_other);
 397     }
 398   } else {
 399     // reference
 400     ik = new (loader_data, size, THREAD) InstanceRefKlass(parser);
 401   }
 402 
 403   // Check for pending exception before adding to the loader data and incrementing
 404   // class count.  Can get OOM here.
 405   if (HAS_PENDING_EXCEPTION) {
 406     return NULL;
 407   }
 408 
 409   return ik;
 410 }
 411 
 412 
 413 // copy method ordering from resource area to Metaspace
 414 void InstanceKlass::copy_method_ordering(const intArray* m, TRAPS) {
 415   if (m != NULL) {
 416     // allocate a new array and copy contents (memcpy?)
 417     _method_ordering = MetadataFactory::new_array&lt;int&gt;(class_loader_data(), m-&gt;length(), CHECK);
 418     for (int i = 0; i &lt; m-&gt;length(); i++) {
 419       _method_ordering-&gt;at_put(i, m-&gt;at(i));
 420     }
 421   } else {
 422     _method_ordering = Universe::the_empty_int_array();
 423   }
 424 }
 425 
 426 // create a new array of vtable_indices for default methods
 427 Array&lt;int&gt;* InstanceKlass::create_new_default_vtable_indices(int len, TRAPS) {
 428   Array&lt;int&gt;* vtable_indices = MetadataFactory::new_array&lt;int&gt;(class_loader_data(), len, CHECK_NULL);
 429   assert(default_vtable_indices() == NULL, &quot;only create once&quot;);
 430   set_default_vtable_indices(vtable_indices);
 431   return vtable_indices;
 432 }
 433 
 434 InstanceKlass::InstanceKlass(const ClassFileParser&amp; parser, unsigned kind, KlassID id) :
 435   Klass(id),
 436   _nest_members(NULL),
 437   _nest_host_index(0),
 438   _nest_host(NULL),
 439   _record_components(NULL),
 440   _static_field_size(parser.static_field_size()),
 441   _nonstatic_oop_map_size(nonstatic_oop_map_size(parser.total_oop_map_count())),
 442   _itable_len(parser.itable_size()),
 443   _init_thread(NULL),
 444   _init_state(allocated),
 445   _reference_type(parser.reference_type())
 446 {
 447   set_vtable_length(parser.vtable_size());
 448   set_kind(kind);
 449   set_access_flags(parser.access_flags());
 450   set_is_unsafe_anonymous(parser.is_unsafe_anonymous());
 451   set_layout_helper(Klass::instance_layout_helper(parser.layout_size(),
 452                                                     false));
 453 
 454   assert(NULL == _methods, &quot;underlying memory not zeroed?&quot;);
 455   assert(is_instance_klass(), &quot;is layout incorrect?&quot;);
 456   assert(size_helper() == parser.layout_size(), &quot;incorrect size_helper?&quot;);
 457 
 458   if (Arguments::is_dumping_archive()) {
 459     SystemDictionaryShared::init_dumptime_info(this);
 460   }
 461 
 462   // Set biased locking bit for all instances of this class; it will be
 463   // cleared if revocation occurs too often for this type
 464   if (UseBiasedLocking &amp;&amp; BiasedLocking::enabled()) {
 465     set_prototype_header(markWord::biased_locking_prototype());
 466   }
 467 }
 468 
 469 void InstanceKlass::deallocate_methods(ClassLoaderData* loader_data,
 470                                        Array&lt;Method*&gt;* methods) {
 471   if (methods != NULL &amp;&amp; methods != Universe::the_empty_method_array() &amp;&amp;
 472       !methods-&gt;is_shared()) {
 473     for (int i = 0; i &lt; methods-&gt;length(); i++) {
 474       Method* method = methods-&gt;at(i);
 475       if (method == NULL) continue;  // maybe null if error processing
 476       // Only want to delete methods that are not executing for RedefineClasses.
 477       // The previous version will point to them so they&#39;re not totally dangling
 478       assert (!method-&gt;on_stack(), &quot;shouldn&#39;t be called with methods on stack&quot;);
 479       MetadataFactory::free_metadata(loader_data, method);
 480     }
 481     MetadataFactory::free_array&lt;Method*&gt;(loader_data, methods);
 482   }
 483 }
 484 
 485 void InstanceKlass::deallocate_interfaces(ClassLoaderData* loader_data,
 486                                           const Klass* super_klass,
 487                                           Array&lt;InstanceKlass*&gt;* local_interfaces,
 488                                           Array&lt;InstanceKlass*&gt;* transitive_interfaces) {
 489   // Only deallocate transitive interfaces if not empty, same as super class
 490   // or same as local interfaces.  See code in parseClassFile.
 491   Array&lt;InstanceKlass*&gt;* ti = transitive_interfaces;
 492   if (ti != Universe::the_empty_instance_klass_array() &amp;&amp; ti != local_interfaces) {
 493     // check that the interfaces don&#39;t come from super class
 494     Array&lt;InstanceKlass*&gt;* sti = (super_klass == NULL) ? NULL :
 495                     InstanceKlass::cast(super_klass)-&gt;transitive_interfaces();
 496     if (ti != sti &amp;&amp; ti != NULL &amp;&amp; !ti-&gt;is_shared()) {
 497       MetadataFactory::free_array&lt;InstanceKlass*&gt;(loader_data, ti);
 498     }
 499   }
 500 
 501   // local interfaces can be empty
 502   if (local_interfaces != Universe::the_empty_instance_klass_array() &amp;&amp;
 503       local_interfaces != NULL &amp;&amp; !local_interfaces-&gt;is_shared()) {
 504     MetadataFactory::free_array&lt;InstanceKlass*&gt;(loader_data, local_interfaces);
 505   }
 506 }
 507 
 508 void InstanceKlass::deallocate_record_components(ClassLoaderData* loader_data,
 509                                                  Array&lt;RecordComponent*&gt;* record_components) {
 510   if (record_components != NULL &amp;&amp; !record_components-&gt;is_shared()) {
 511     for (int i = 0; i &lt; record_components-&gt;length(); i++) {
 512       RecordComponent* record_component = record_components-&gt;at(i);
 513       MetadataFactory::free_metadata(loader_data, record_component);
 514     }
 515     MetadataFactory::free_array&lt;RecordComponent*&gt;(loader_data, record_components);
 516   }
 517 }
 518 
 519 // This function deallocates the metadata and C heap pointers that the
 520 // InstanceKlass points to.
 521 void InstanceKlass::deallocate_contents(ClassLoaderData* loader_data) {
 522 
 523   // Orphan the mirror first, CMS thinks it&#39;s still live.
 524   if (java_mirror() != NULL) {
 525     java_lang_Class::set_klass(java_mirror(), NULL);
 526   }
 527 
 528   // Also remove mirror from handles
 529   loader_data-&gt;remove_handle(_java_mirror);
 530 
 531   // Need to take this class off the class loader data list.
 532   loader_data-&gt;remove_class(this);
 533 
 534   // The array_klass for this class is created later, after error handling.
 535   // For class redefinition, we keep the original class so this scratch class
 536   // doesn&#39;t have an array class.  Either way, assert that there is nothing
 537   // to deallocate.
 538   assert(array_klasses() == NULL, &quot;array classes shouldn&#39;t be created for this class yet&quot;);
 539 
 540   // Release C heap allocated data that this might point to, which includes
 541   // reference counting symbol names.
 542   release_C_heap_structures();
 543 
 544   deallocate_methods(loader_data, methods());
 545   set_methods(NULL);
 546 
 547   deallocate_record_components(loader_data, record_components());
 548   set_record_components(NULL);
 549 
 550   if (method_ordering() != NULL &amp;&amp;
 551       method_ordering() != Universe::the_empty_int_array() &amp;&amp;
 552       !method_ordering()-&gt;is_shared()) {
 553     MetadataFactory::free_array&lt;int&gt;(loader_data, method_ordering());
 554   }
 555   set_method_ordering(NULL);
 556 
 557   // default methods can be empty
 558   if (default_methods() != NULL &amp;&amp;
 559       default_methods() != Universe::the_empty_method_array() &amp;&amp;
 560       !default_methods()-&gt;is_shared()) {
 561     MetadataFactory::free_array&lt;Method*&gt;(loader_data, default_methods());
 562   }
 563   // Do NOT deallocate the default methods, they are owned by superinterfaces.
 564   set_default_methods(NULL);
 565 
 566   // default methods vtable indices can be empty
 567   if (default_vtable_indices() != NULL &amp;&amp;
 568       !default_vtable_indices()-&gt;is_shared()) {
 569     MetadataFactory::free_array&lt;int&gt;(loader_data, default_vtable_indices());
 570   }
 571   set_default_vtable_indices(NULL);
 572 
 573 
 574   // This array is in Klass, but remove it with the InstanceKlass since
 575   // this place would be the only caller and it can share memory with transitive
 576   // interfaces.
 577   if (secondary_supers() != NULL &amp;&amp;
 578       secondary_supers() != Universe::the_empty_klass_array() &amp;&amp;
 579       // see comments in compute_secondary_supers about the following cast
 580       (address)(secondary_supers()) != (address)(transitive_interfaces()) &amp;&amp;
 581       !secondary_supers()-&gt;is_shared()) {
 582     MetadataFactory::free_array&lt;Klass*&gt;(loader_data, secondary_supers());
 583   }
 584   set_secondary_supers(NULL);
 585 
 586   deallocate_interfaces(loader_data, super(), local_interfaces(), transitive_interfaces());
 587   set_transitive_interfaces(NULL);
 588   set_local_interfaces(NULL);
 589 
 590   if (fields() != NULL &amp;&amp; !fields()-&gt;is_shared()) {
 591     MetadataFactory::free_array&lt;jushort&gt;(loader_data, fields());
 592   }
 593   set_fields(NULL, 0);
 594 
 595   // If a method from a redefined class is using this constant pool, don&#39;t
 596   // delete it, yet.  The new class&#39;s previous version will point to this.
 597   if (constants() != NULL) {
 598     assert (!constants()-&gt;on_stack(), &quot;shouldn&#39;t be called if anything is onstack&quot;);
 599     if (!constants()-&gt;is_shared()) {
 600       MetadataFactory::free_metadata(loader_data, constants());
 601     }
 602     // Delete any cached resolution errors for the constant pool
 603     SystemDictionary::delete_resolution_error(constants());
 604 
 605     set_constants(NULL);
 606   }
 607 
 608   if (inner_classes() != NULL &amp;&amp;
 609       inner_classes() != Universe::the_empty_short_array() &amp;&amp;
 610       !inner_classes()-&gt;is_shared()) {
 611     MetadataFactory::free_array&lt;jushort&gt;(loader_data, inner_classes());
 612   }
 613   set_inner_classes(NULL);
 614 
 615   if (nest_members() != NULL &amp;&amp;
 616       nest_members() != Universe::the_empty_short_array() &amp;&amp;
 617       !nest_members()-&gt;is_shared()) {
 618     MetadataFactory::free_array&lt;jushort&gt;(loader_data, nest_members());
 619   }
 620   set_nest_members(NULL);
 621 
 622   // We should deallocate the Annotations instance if it&#39;s not in shared spaces.
 623   if (annotations() != NULL &amp;&amp; !annotations()-&gt;is_shared()) {
 624     MetadataFactory::free_metadata(loader_data, annotations());
 625   }
 626   set_annotations(NULL);
 627 
 628   if (Arguments::is_dumping_archive()) {
 629     SystemDictionaryShared::remove_dumptime_info(this);
 630   }
 631 }
 632 
 633 bool InstanceKlass::should_be_initialized() const {
 634   return !is_initialized();
 635 }
 636 
 637 klassItable InstanceKlass::itable() const {
 638   return klassItable(const_cast&lt;InstanceKlass*&gt;(this));
 639 }
 640 
 641 void InstanceKlass::eager_initialize(Thread *thread) {
 642   if (!EagerInitialization) return;
 643 
 644   if (this-&gt;is_not_initialized()) {
 645     // abort if the the class has a class initializer
 646     if (this-&gt;class_initializer() != NULL) return;
 647 
 648     // abort if it is java.lang.Object (initialization is handled in genesis)
 649     Klass* super_klass = super();
 650     if (super_klass == NULL) return;
 651 
 652     // abort if the super class should be initialized
 653     if (!InstanceKlass::cast(super_klass)-&gt;is_initialized()) return;
 654 
 655     // call body to expose the this pointer
 656     eager_initialize_impl();
 657   }
 658 }
 659 
 660 // JVMTI spec thinks there are signers and protection domain in the
 661 // instanceKlass.  These accessors pretend these fields are there.
 662 // The hprof specification also thinks these fields are in InstanceKlass.
 663 oop InstanceKlass::protection_domain() const {
 664   // return the protection_domain from the mirror
 665   return java_lang_Class::protection_domain(java_mirror());
 666 }
 667 
 668 // To remove these from requires an incompatible change and CCC request.
 669 objArrayOop InstanceKlass::signers() const {
 670   // return the signers from the mirror
 671   return java_lang_Class::signers(java_mirror());
 672 }
 673 
 674 oop InstanceKlass::init_lock() const {
 675   // return the init lock from the mirror
 676   oop lock = java_lang_Class::init_lock(java_mirror());
 677   // Prevent reordering with any access of initialization state
 678   OrderAccess::loadload();
 679   assert((oop)lock != NULL || !is_not_initialized(), // initialized or in_error state
 680          &quot;only fully initialized state can have a null lock&quot;);
 681   return lock;
 682 }
 683 
 684 // Set the initialization lock to null so the object can be GC&#39;ed.  Any racing
 685 // threads to get this lock will see a null lock and will not lock.
 686 // That&#39;s okay because they all check for initialized state after getting
 687 // the lock and return.
 688 void InstanceKlass::fence_and_clear_init_lock() {
 689   // make sure previous stores are all done, notably the init_state.
 690   OrderAccess::storestore();
 691   java_lang_Class::set_init_lock(java_mirror(), NULL);
 692   assert(!is_not_initialized(), &quot;class must be initialized now&quot;);
 693 }
 694 
 695 void InstanceKlass::eager_initialize_impl() {
 696   EXCEPTION_MARK;
 697   HandleMark hm(THREAD);
 698   Handle h_init_lock(THREAD, init_lock());
 699   ObjectLocker ol(h_init_lock, THREAD, h_init_lock() != NULL);
 700 
 701   // abort if someone beat us to the initialization
 702   if (!is_not_initialized()) return;  // note: not equivalent to is_initialized()
 703 
 704   ClassState old_state = init_state();
 705   link_class_impl(THREAD);
 706   if (HAS_PENDING_EXCEPTION) {
 707     CLEAR_PENDING_EXCEPTION;
 708     // Abort if linking the class throws an exception.
 709 
 710     // Use a test to avoid redundantly resetting the state if there&#39;s
 711     // no change.  Set_init_state() asserts that state changes make
 712     // progress, whereas here we might just be spinning in place.
 713     if (old_state != _init_state)
 714       set_init_state(old_state);
 715   } else {
 716     // linking successfull, mark class as initialized
 717     set_init_state(fully_initialized);
 718     fence_and_clear_init_lock();
 719     // trace
 720     if (log_is_enabled(Info, class, init)) {
 721       ResourceMark rm(THREAD);
 722       log_info(class, init)(&quot;[Initialized %s without side effects]&quot;, external_name());
 723     }
 724   }
 725 }
 726 
 727 
 728 // See &quot;The Virtual Machine Specification&quot; section 2.16.5 for a detailed explanation of the class initialization
 729 // process. The step comments refers to the procedure described in that section.
 730 // Note: implementation moved to static method to expose the this pointer.
 731 void InstanceKlass::initialize(TRAPS) {
 732   if (this-&gt;should_be_initialized()) {
 733     initialize_impl(CHECK);
 734     // Note: at this point the class may be initialized
 735     //       OR it may be in the state of being initialized
 736     //       in case of recursive initialization!
 737   } else {
 738     assert(is_initialized(), &quot;sanity check&quot;);
 739   }
 740 }
 741 
 742 
 743 bool InstanceKlass::verify_code(TRAPS) {
 744   // 1) Verify the bytecodes
 745   return Verifier::verify(this, should_verify_class(), THREAD);
 746 }
 747 
 748 void InstanceKlass::link_class(TRAPS) {
 749   assert(is_loaded(), &quot;must be loaded&quot;);
 750   if (!is_linked()) {
 751     link_class_impl(CHECK);
 752   }
 753 }
 754 
 755 // Called to verify that a class can link during initialization, without
 756 // throwing a VerifyError.
 757 bool InstanceKlass::link_class_or_fail(TRAPS) {
 758   assert(is_loaded(), &quot;must be loaded&quot;);
 759   if (!is_linked()) {
 760     link_class_impl(CHECK_false);
 761   }
 762   return is_linked();
 763 }
 764 
 765 bool InstanceKlass::link_class_impl(TRAPS) {
 766   if (DumpSharedSpaces &amp;&amp; is_in_error_state()) {
 767     // This is for CDS dumping phase only -- we use the in_error_state to indicate that
 768     // the class has failed verification. Throwing the NoClassDefFoundError here is just
 769     // a convenient way to stop repeat attempts to verify the same (bad) class.
 770     //
 771     // Note that the NoClassDefFoundError is not part of the JLS, and should not be thrown
 772     // if we are executing Java code. This is not a problem for CDS dumping phase since
 773     // it doesn&#39;t execute any Java code.
 774     ResourceMark rm(THREAD);
 775     Exceptions::fthrow(THREAD_AND_LOCATION,
 776                        vmSymbols::java_lang_NoClassDefFoundError(),
 777                        &quot;Class %s, or one of its supertypes, failed class initialization&quot;,
 778                        external_name());
 779     return false;
 780   }
 781   // return if already verified
 782   if (is_linked()) {
 783     return true;
 784   }
 785 
 786   // Timing
 787   // timer handles recursion
 788   assert(THREAD-&gt;is_Java_thread(), &quot;non-JavaThread in link_class_impl&quot;);
 789   JavaThread* jt = (JavaThread*)THREAD;
 790 
 791   // link super class before linking this class
 792   Klass* super_klass = super();
 793   if (super_klass != NULL) {
 794     if (super_klass-&gt;is_interface()) {  // check if super class is an interface
 795       ResourceMark rm(THREAD);
 796       Exceptions::fthrow(
 797         THREAD_AND_LOCATION,
 798         vmSymbols::java_lang_IncompatibleClassChangeError(),
 799         &quot;class %s has interface %s as super class&quot;,
 800         external_name(),
 801         super_klass-&gt;external_name()
 802       );
 803       return false;
 804     }
 805 
 806     InstanceKlass* ik_super = InstanceKlass::cast(super_klass);
 807     ik_super-&gt;link_class_impl(CHECK_false);
 808   }
 809 
 810   // link all interfaces implemented by this class before linking this class
 811   Array&lt;InstanceKlass*&gt;* interfaces = local_interfaces();
 812   int num_interfaces = interfaces-&gt;length();
 813   for (int index = 0; index &lt; num_interfaces; index++) {
 814     InstanceKlass* interk = interfaces-&gt;at(index);
 815     interk-&gt;link_class_impl(CHECK_false);
 816   }
 817 
 818   // in case the class is linked in the process of linking its superclasses
 819   if (is_linked()) {
 820     return true;
 821   }
 822 
 823   // trace only the link time for this klass that includes
 824   // the verification time
 825   PerfClassTraceTime vmtimer(ClassLoader::perf_class_link_time(),
 826                              ClassLoader::perf_class_link_selftime(),
 827                              ClassLoader::perf_classes_linked(),
 828                              jt-&gt;get_thread_stat()-&gt;perf_recursion_counts_addr(),
 829                              jt-&gt;get_thread_stat()-&gt;perf_timers_addr(),
 830                              PerfClassTraceTime::CLASS_LINK);
 831 
 832   // verification &amp; rewriting
 833   {
 834     HandleMark hm(THREAD);
 835     Handle h_init_lock(THREAD, init_lock());
 836     ObjectLocker ol(h_init_lock, THREAD, h_init_lock() != NULL);
 837     // rewritten will have been set if loader constraint error found
 838     // on an earlier link attempt
 839     // don&#39;t verify or rewrite if already rewritten
 840     //
 841 
 842     if (!is_linked()) {
 843       if (!is_rewritten()) {
 844         {
 845           bool verify_ok = verify_code(THREAD);
 846           if (!verify_ok) {
 847             return false;
 848           }
 849         }
 850 
 851         // Just in case a side-effect of verify linked this class already
 852         // (which can sometimes happen since the verifier loads classes
 853         // using custom class loaders, which are free to initialize things)
 854         if (is_linked()) {
 855           return true;
 856         }
 857 
 858         // also sets rewritten
 859         rewrite_class(CHECK_false);
 860       } else if (is_shared()) {
 861         SystemDictionaryShared::check_verification_constraints(this, CHECK_false);
 862       }
 863 
 864       // relocate jsrs and link methods after they are all rewritten
 865       link_methods(CHECK_false);
 866 
 867       // Initialize the vtable and interface table after
 868       // methods have been rewritten since rewrite may
 869       // fabricate new Method*s.
 870       // also does loader constraint checking
 871       //
 872       // initialize_vtable and initialize_itable need to be rerun for
 873       // a shared class if the class is not loaded by the NULL classloader.
 874       ClassLoaderData * loader_data = class_loader_data();
 875       if (!(is_shared() &amp;&amp;
 876             loader_data-&gt;is_the_null_class_loader_data())) {
 877         vtable().initialize_vtable(true, CHECK_false);
 878         itable().initialize_itable(true, CHECK_false);
 879       }
 880 #ifdef ASSERT
 881       else {
 882         vtable().verify(tty, true);
 883         // In case itable verification is ever added.
 884         // itable().verify(tty, true);
 885       }
 886 #endif
 887       set_init_state(linked);
 888       if (JvmtiExport::should_post_class_prepare()) {
 889         Thread *thread = THREAD;
 890         assert(thread-&gt;is_Java_thread(), &quot;thread-&gt;is_Java_thread()&quot;);
 891         JvmtiExport::post_class_prepare((JavaThread *) thread, this);
 892       }
 893     }
 894   }
 895   return true;
 896 }
 897 
 898 // Rewrite the byte codes of all of the methods of a class.
 899 // The rewriter must be called exactly once. Rewriting must happen after
 900 // verification but before the first method of the class is executed.
 901 void InstanceKlass::rewrite_class(TRAPS) {
 902   assert(is_loaded(), &quot;must be loaded&quot;);
 903   if (is_rewritten()) {
 904     assert(is_shared(), &quot;rewriting an unshared class?&quot;);
 905     return;
 906   }
 907   Rewriter::rewrite(this, CHECK);
 908   set_rewritten();
 909 }
 910 
 911 // Now relocate and link method entry points after class is rewritten.
 912 // This is outside is_rewritten flag. In case of an exception, it can be
 913 // executed more than once.
 914 void InstanceKlass::link_methods(TRAPS) {
 915   int len = methods()-&gt;length();
 916   for (int i = len-1; i &gt;= 0; i--) {
 917     methodHandle m(THREAD, methods()-&gt;at(i));
 918 
 919     // Set up method entry points for compiler and interpreter    .
 920     m-&gt;link_method(m, CHECK);
 921   }
 922 }
 923 
 924 // Eagerly initialize superinterfaces that declare default methods (concrete instance: any access)
 925 void InstanceKlass::initialize_super_interfaces(TRAPS) {
 926   assert (has_nonstatic_concrete_methods(), &quot;caller should have checked this&quot;);
 927   for (int i = 0; i &lt; local_interfaces()-&gt;length(); ++i) {
 928     InstanceKlass* ik = local_interfaces()-&gt;at(i);
 929 
 930     // Initialization is depth first search ie. we start with top of the inheritance tree
 931     // has_nonstatic_concrete_methods drives searching superinterfaces since it
 932     // means has_nonstatic_concrete_methods in its superinterface hierarchy
 933     if (ik-&gt;has_nonstatic_concrete_methods()) {
 934       ik-&gt;initialize_super_interfaces(CHECK);
 935     }
 936 
 937     // Only initialize() interfaces that &quot;declare&quot; concrete methods.
 938     if (ik-&gt;should_be_initialized() &amp;&amp; ik-&gt;declares_nonstatic_concrete_methods()) {
 939       ik-&gt;initialize(CHECK);
 940     }
 941   }
 942 }
 943 
 944 void InstanceKlass::initialize_impl(TRAPS) {
 945   HandleMark hm(THREAD);
 946 
 947   // Make sure klass is linked (verified) before initialization
 948   // A class could already be verified, since it has been reflected upon.
 949   link_class(CHECK);
 950 
 951   DTRACE_CLASSINIT_PROBE(required, -1);
 952 
 953   bool wait = false;
 954 
 955   assert(THREAD-&gt;is_Java_thread(), &quot;non-JavaThread in initialize_impl&quot;);
 956   JavaThread* jt = (JavaThread*)THREAD;
 957 
 958   // refer to the JVM book page 47 for description of steps
 959   // Step 1
 960   {
 961     Handle h_init_lock(THREAD, init_lock());
 962     ObjectLocker ol(h_init_lock, THREAD, h_init_lock() != NULL);
 963 
 964     // Step 2
 965     // If we were to use wait() instead of waitInterruptibly() then
 966     // we might end up throwing IE from link/symbol resolution sites
 967     // that aren&#39;t expected to throw.  This would wreak havoc.  See 6320309.
 968     while (is_being_initialized() &amp;&amp; !is_reentrant_initialization(jt)) {
 969       wait = true;
 970       jt-&gt;set_class_to_be_initialized(this);
 971       ol.wait_uninterruptibly(jt);
 972       jt-&gt;set_class_to_be_initialized(NULL);
 973     }
 974 
 975     // Step 3
 976     if (is_being_initialized() &amp;&amp; is_reentrant_initialization(jt)) {
 977       DTRACE_CLASSINIT_PROBE_WAIT(recursive, -1, wait);
 978       return;
 979     }
 980 
 981     // Step 4
 982     if (is_initialized()) {
 983       DTRACE_CLASSINIT_PROBE_WAIT(concurrent, -1, wait);
 984       return;
 985     }
 986 
 987     // Step 5
 988     if (is_in_error_state()) {
 989       DTRACE_CLASSINIT_PROBE_WAIT(erroneous, -1, wait);
 990       ResourceMark rm(THREAD);
 991       const char* desc = &quot;Could not initialize class &quot;;
 992       const char* className = external_name();
 993       size_t msglen = strlen(desc) + strlen(className) + 1;
 994       char* message = NEW_RESOURCE_ARRAY(char, msglen);
 995       if (NULL == message) {
 996         // Out of memory: can&#39;t create detailed error message
 997           THROW_MSG(vmSymbols::java_lang_NoClassDefFoundError(), className);
 998       } else {
 999         jio_snprintf(message, msglen, &quot;%s%s&quot;, desc, className);
1000           THROW_MSG(vmSymbols::java_lang_NoClassDefFoundError(), message);
1001       }
1002     }
1003 
1004     // Step 6
1005     set_init_state(being_initialized);
1006     set_init_thread(jt);
1007   }
1008 
1009   // Step 7
1010   // Next, if C is a class rather than an interface, initialize it&#39;s super class and super
1011   // interfaces.
1012   if (!is_interface()) {
1013     Klass* super_klass = super();
1014     if (super_klass != NULL &amp;&amp; super_klass-&gt;should_be_initialized()) {
1015       super_klass-&gt;initialize(THREAD);
1016     }
1017     // If C implements any interface that declares a non-static, concrete method,
1018     // the initialization of C triggers initialization of its super interfaces.
1019     // Only need to recurse if has_nonstatic_concrete_methods which includes declaring and
1020     // having a superinterface that declares, non-static, concrete methods
1021     if (!HAS_PENDING_EXCEPTION &amp;&amp; has_nonstatic_concrete_methods()) {
1022       initialize_super_interfaces(THREAD);
1023     }
1024 
1025     // If any exceptions, complete abruptly, throwing the same exception as above.
1026     if (HAS_PENDING_EXCEPTION) {
1027       Handle e(THREAD, PENDING_EXCEPTION);
1028       CLEAR_PENDING_EXCEPTION;
1029       {
1030         EXCEPTION_MARK;
1031         // Locks object, set state, and notify all waiting threads
1032         set_initialization_state_and_notify(initialization_error, THREAD);
1033         CLEAR_PENDING_EXCEPTION;
1034       }
1035       DTRACE_CLASSINIT_PROBE_WAIT(super__failed, -1, wait);
1036       THROW_OOP(e());
1037     }
1038   }
1039 
1040 
1041   // Look for aot compiled methods for this klass, including class initializer.
1042   AOTLoader::load_for_klass(this, THREAD);
1043 
1044   // Step 8
1045   {
1046     DTRACE_CLASSINIT_PROBE_WAIT(clinit, -1, wait);
1047     // Timer includes any side effects of class initialization (resolution,
1048     // etc), but not recursive entry into call_class_initializer().
1049     PerfClassTraceTime timer(ClassLoader::perf_class_init_time(),
1050                              ClassLoader::perf_class_init_selftime(),
1051                              ClassLoader::perf_classes_inited(),
1052                              jt-&gt;get_thread_stat()-&gt;perf_recursion_counts_addr(),
1053                              jt-&gt;get_thread_stat()-&gt;perf_timers_addr(),
1054                              PerfClassTraceTime::CLASS_CLINIT);
1055     call_class_initializer(THREAD);
1056   }
1057 
1058   // Step 9
1059   if (!HAS_PENDING_EXCEPTION) {
1060     set_initialization_state_and_notify(fully_initialized, CHECK);
1061     {
1062       debug_only(vtable().verify(tty, true);)
1063     }
1064   }
1065   else {
1066     // Step 10 and 11
1067     Handle e(THREAD, PENDING_EXCEPTION);
1068     CLEAR_PENDING_EXCEPTION;
1069     // JVMTI has already reported the pending exception
1070     // JVMTI internal flag reset is needed in order to report ExceptionInInitializerError
1071     JvmtiExport::clear_detected_exception(jt);
1072     {
1073       EXCEPTION_MARK;
1074       set_initialization_state_and_notify(initialization_error, THREAD);
1075       CLEAR_PENDING_EXCEPTION;   // ignore any exception thrown, class initialization error is thrown below
1076       // JVMTI has already reported the pending exception
1077       // JVMTI internal flag reset is needed in order to report ExceptionInInitializerError
1078       JvmtiExport::clear_detected_exception(jt);
1079     }
1080     DTRACE_CLASSINIT_PROBE_WAIT(error, -1, wait);
1081     if (e-&gt;is_a(SystemDictionary::Error_klass())) {
1082       THROW_OOP(e());
1083     } else {
1084       JavaCallArguments args(e);
1085       THROW_ARG(vmSymbols::java_lang_ExceptionInInitializerError(),
1086                 vmSymbols::throwable_void_signature(),
1087                 &amp;args);
1088     }
1089   }
1090   DTRACE_CLASSINIT_PROBE_WAIT(end, -1, wait);
1091 }
1092 
1093 
1094 void InstanceKlass::set_initialization_state_and_notify(ClassState state, TRAPS) {
1095   Handle h_init_lock(THREAD, init_lock());
1096   if (h_init_lock() != NULL) {
1097     ObjectLocker ol(h_init_lock, THREAD);
1098     set_init_thread(NULL); // reset _init_thread before changing _init_state
1099     set_init_state(state);
1100     fence_and_clear_init_lock();
1101     ol.notify_all(CHECK);
1102   } else {
1103     assert(h_init_lock() != NULL, &quot;The initialization state should never be set twice&quot;);
1104     set_init_thread(NULL); // reset _init_thread before changing _init_state
1105     set_init_state(state);
1106   }
1107 }
1108 
1109 Klass* InstanceKlass::implementor() const {
1110   Klass* volatile* k = adr_implementor();
1111   if (k == NULL) {
1112     return NULL;
1113   } else {
1114     // This load races with inserts, and therefore needs acquire.
1115     Klass* kls = Atomic::load_acquire(k);
1116     if (kls != NULL &amp;&amp; !kls-&gt;is_loader_alive()) {
1117       return NULL;  // don&#39;t return unloaded class
1118     } else {
1119       return kls;
1120     }
1121   }
1122 }
1123 
1124 
1125 void InstanceKlass::set_implementor(Klass* k) {
1126   assert_locked_or_safepoint(Compile_lock);
1127   assert(is_interface(), &quot;not interface&quot;);
1128   Klass* volatile* addr = adr_implementor();
1129   assert(addr != NULL, &quot;null addr&quot;);
1130   if (addr != NULL) {
1131     Atomic::release_store(addr, k);
1132   }
1133 }
1134 
1135 int  InstanceKlass::nof_implementors() const {
1136   Klass* k = implementor();
1137   if (k == NULL) {
1138     return 0;
1139   } else if (k != this) {
1140     return 1;
1141   } else {
1142     return 2;
1143   }
1144 }
1145 
1146 // The embedded _implementor field can only record one implementor.
1147 // When there are more than one implementors, the _implementor field
1148 // is set to the interface Klass* itself. Following are the possible
1149 // values for the _implementor field:
1150 //   NULL                  - no implementor
1151 //   implementor Klass*    - one implementor
1152 //   self                  - more than one implementor
1153 //
1154 // The _implementor field only exists for interfaces.
1155 void InstanceKlass::add_implementor(Klass* k) {
1156   assert_lock_strong(Compile_lock);
1157   assert(is_interface(), &quot;not interface&quot;);
1158   // Filter out my subinterfaces.
1159   // (Note: Interfaces are never on the subklass list.)
1160   if (InstanceKlass::cast(k)-&gt;is_interface()) return;
1161 
1162   // Filter out subclasses whose supers already implement me.
1163   // (Note: CHA must walk subclasses of direct implementors
1164   // in order to locate indirect implementors.)
1165   Klass* sk = k-&gt;super();
1166   if (sk != NULL &amp;&amp; InstanceKlass::cast(sk)-&gt;implements_interface(this))
1167     // We only need to check one immediate superclass, since the
1168     // implements_interface query looks at transitive_interfaces.
1169     // Any supers of the super have the same (or fewer) transitive_interfaces.
1170     return;
1171 
1172   Klass* ik = implementor();
1173   if (ik == NULL) {
1174     set_implementor(k);
<a name="1" id="anc1"></a><span class="line-modified">1175   } else if (ik != this &amp;&amp; ik != k) {</span>
1176     // There is already an implementor. Use itself as an indicator of
1177     // more than one implementors.
1178     set_implementor(this);
1179   }
1180 
1181   // The implementor also implements the transitive_interfaces
1182   for (int index = 0; index &lt; local_interfaces()-&gt;length(); index++) {
1183     InstanceKlass::cast(local_interfaces()-&gt;at(index))-&gt;add_implementor(k);
1184   }
1185 }
1186 
1187 void InstanceKlass::init_implementor() {
1188   if (is_interface()) {
1189     set_implementor(NULL);
1190   }
1191 }
1192 
1193 
1194 void InstanceKlass::process_interfaces(Thread *thread) {
1195   // link this class into the implementors list of every interface it implements
1196   for (int i = local_interfaces()-&gt;length() - 1; i &gt;= 0; i--) {
1197     assert(local_interfaces()-&gt;at(i)-&gt;is_klass(), &quot;must be a klass&quot;);
1198     InstanceKlass* interf = InstanceKlass::cast(local_interfaces()-&gt;at(i));
1199     assert(interf-&gt;is_interface(), &quot;expected interface&quot;);
1200     interf-&gt;add_implementor(this);
1201   }
1202 }
1203 
1204 bool InstanceKlass::can_be_primary_super_slow() const {
1205   if (is_interface())
1206     return false;
1207   else
1208     return Klass::can_be_primary_super_slow();
1209 }
1210 
1211 GrowableArray&lt;Klass*&gt;* InstanceKlass::compute_secondary_supers(int num_extra_slots,
1212                                                                Array&lt;InstanceKlass*&gt;* transitive_interfaces) {
1213   // The secondaries are the implemented interfaces.
1214   Array&lt;InstanceKlass*&gt;* interfaces = transitive_interfaces;
1215   int num_secondaries = num_extra_slots + interfaces-&gt;length();
1216   if (num_secondaries == 0) {
1217     // Must share this for correct bootstrapping!
1218     set_secondary_supers(Universe::the_empty_klass_array());
1219     return NULL;
1220   } else if (num_extra_slots == 0) {
1221     // The secondary super list is exactly the same as the transitive interfaces, so
1222     // let&#39;s use it instead of making a copy.
1223     // Redefine classes has to be careful not to delete this!
1224     // We need the cast because Array&lt;Klass*&gt; is NOT a supertype of Array&lt;InstanceKlass*&gt;,
1225     // (but it&#39;s safe to do here because we won&#39;t write into _secondary_supers from this point on).
1226     set_secondary_supers((Array&lt;Klass*&gt;*)(address)interfaces);
1227     return NULL;
1228   } else {
1229     // Copy transitive interfaces to a temporary growable array to be constructed
1230     // into the secondary super list with extra slots.
1231     GrowableArray&lt;Klass*&gt;* secondaries = new GrowableArray&lt;Klass*&gt;(interfaces-&gt;length());
1232     for (int i = 0; i &lt; interfaces-&gt;length(); i++) {
1233       secondaries-&gt;push(interfaces-&gt;at(i));
1234     }
1235     return secondaries;
1236   }
1237 }
1238 
1239 bool InstanceKlass::implements_interface(Klass* k) const {
1240   if (this == k) return true;
1241   assert(k-&gt;is_interface(), &quot;should be an interface class&quot;);
1242   for (int i = 0; i &lt; transitive_interfaces()-&gt;length(); i++) {
1243     if (transitive_interfaces()-&gt;at(i) == k) {
1244       return true;
1245     }
1246   }
1247   return false;
1248 }
1249 
1250 bool InstanceKlass::is_same_or_direct_interface(Klass *k) const {
1251   // Verify direct super interface
1252   if (this == k) return true;
1253   assert(k-&gt;is_interface(), &quot;should be an interface class&quot;);
1254   for (int i = 0; i &lt; local_interfaces()-&gt;length(); i++) {
1255     if (local_interfaces()-&gt;at(i) == k) {
1256       return true;
1257     }
1258   }
1259   return false;
1260 }
1261 
1262 objArrayOop InstanceKlass::allocate_objArray(int n, int length, TRAPS) {
1263   check_array_allocation_length(length, arrayOopDesc::max_array_length(T_OBJECT), CHECK_NULL);
1264   int size = objArrayOopDesc::object_size(length);
1265   Klass* ak = array_klass(n, CHECK_NULL);
1266   objArrayOop o = (objArrayOop)Universe::heap()-&gt;array_allocate(ak, size, length,
1267                                                                 /* do_zero */ true, CHECK_NULL);
1268   return o;
1269 }
1270 
1271 instanceOop InstanceKlass::register_finalizer(instanceOop i, TRAPS) {
1272   if (TraceFinalizerRegistration) {
1273     tty-&gt;print(&quot;Registered &quot;);
1274     i-&gt;print_value_on(tty);
1275     tty-&gt;print_cr(&quot; (&quot; INTPTR_FORMAT &quot;) as finalizable&quot;, p2i(i));
1276   }
1277   instanceHandle h_i(THREAD, i);
1278   // Pass the handle as argument, JavaCalls::call expects oop as jobjects
1279   JavaValue result(T_VOID);
1280   JavaCallArguments args(h_i);
1281   methodHandle mh (THREAD, Universe::finalizer_register_method());
1282   JavaCalls::call(&amp;result, mh, &amp;args, CHECK_NULL);
1283   return h_i();
1284 }
1285 
1286 instanceOop InstanceKlass::allocate_instance(TRAPS) {
1287   bool has_finalizer_flag = has_finalizer(); // Query before possible GC
1288   int size = size_helper();  // Query before forming handle.
1289 
1290   instanceOop i;
1291 
1292   i = (instanceOop)Universe::heap()-&gt;obj_allocate(this, size, CHECK_NULL);
1293   if (has_finalizer_flag &amp;&amp; !RegisterFinalizersAtInit) {
1294     i = register_finalizer(i, CHECK_NULL);
1295   }
1296   return i;
1297 }
1298 
1299 instanceHandle InstanceKlass::allocate_instance_handle(TRAPS) {
1300   return instanceHandle(THREAD, allocate_instance(THREAD));
1301 }
1302 
1303 void InstanceKlass::check_valid_for_instantiation(bool throwError, TRAPS) {
1304   if (is_interface() || is_abstract()) {
1305     ResourceMark rm(THREAD);
1306     THROW_MSG(throwError ? vmSymbols::java_lang_InstantiationError()
1307               : vmSymbols::java_lang_InstantiationException(), external_name());
1308   }
1309   if (this == SystemDictionary::Class_klass()) {
1310     ResourceMark rm(THREAD);
1311     THROW_MSG(throwError ? vmSymbols::java_lang_IllegalAccessError()
1312               : vmSymbols::java_lang_IllegalAccessException(), external_name());
1313   }
1314 }
1315 
1316 Klass* InstanceKlass::array_klass_impl(bool or_null, int n, TRAPS) {
1317   // Need load-acquire for lock-free read
1318   if (array_klasses_acquire() == NULL) {
1319     if (or_null) return NULL;
1320 
1321     ResourceMark rm(THREAD);
1322     JavaThread *jt = (JavaThread *)THREAD;
1323     {
1324       // Atomic creation of array_klasses
1325       MutexLocker ma(THREAD, MultiArray_lock);
1326 
1327       // Check if update has already taken place
1328       if (array_klasses() == NULL) {
1329         Klass*    k = ObjArrayKlass::allocate_objArray_klass(class_loader_data(), 1, this, CHECK_NULL);
1330         // use &#39;release&#39; to pair with lock-free load
1331         release_set_array_klasses(k);
1332       }
1333     }
1334   }
1335   // _this will always be set at this point
1336   ObjArrayKlass* oak = (ObjArrayKlass*)array_klasses();
1337   if (or_null) {
1338     return oak-&gt;array_klass_or_null(n);
1339   }
1340   return oak-&gt;array_klass(n, THREAD);
1341 }
1342 
1343 Klass* InstanceKlass::array_klass_impl(bool or_null, TRAPS) {
1344   return array_klass_impl(or_null, 1, THREAD);
1345 }
1346 
1347 static int call_class_initializer_counter = 0;   // for debugging
1348 
1349 Method* InstanceKlass::class_initializer() const {
1350   Method* clinit = find_method(
1351       vmSymbols::class_initializer_name(), vmSymbols::void_method_signature());
1352   if (clinit != NULL &amp;&amp; clinit-&gt;has_valid_initializer_flags()) {
1353     return clinit;
1354   }
1355   return NULL;
1356 }
1357 
1358 void InstanceKlass::call_class_initializer(TRAPS) {
1359   if (ReplayCompiles &amp;&amp;
1360       (ReplaySuppressInitializers == 1 ||
1361        (ReplaySuppressInitializers &gt;= 2 &amp;&amp; class_loader() != NULL))) {
1362     // Hide the existence of the initializer for the purpose of replaying the compile
1363     return;
1364   }
1365 
1366   methodHandle h_method(THREAD, class_initializer());
1367   assert(!is_initialized(), &quot;we cannot initialize twice&quot;);
1368   LogTarget(Info, class, init) lt;
1369   if (lt.is_enabled()) {
1370     ResourceMark rm(THREAD);
1371     LogStream ls(lt);
1372     ls.print(&quot;%d Initializing &quot;, call_class_initializer_counter++);
1373     name()-&gt;print_value_on(&amp;ls);
1374     ls.print_cr(&quot;%s (&quot; INTPTR_FORMAT &quot;)&quot;, h_method() == NULL ? &quot;(no method)&quot; : &quot;&quot;, p2i(this));
1375   }
1376   if (h_method() != NULL) {
1377     JavaCallArguments args; // No arguments
1378     JavaValue result(T_VOID);
1379     JavaCalls::call(&amp;result, h_method, &amp;args, CHECK); // Static call (no args)
1380   }
1381 }
1382 
1383 
1384 void InstanceKlass::mask_for(const methodHandle&amp; method, int bci,
1385   InterpreterOopMap* entry_for) {
1386   // Lazily create the _oop_map_cache at first request
1387   // Lock-free access requires load_acquire.
1388   OopMapCache* oop_map_cache = Atomic::load_acquire(&amp;_oop_map_cache);
1389   if (oop_map_cache == NULL) {
1390     MutexLocker x(OopMapCacheAlloc_lock);
1391     // Check if _oop_map_cache was allocated while we were waiting for this lock
1392     if ((oop_map_cache = _oop_map_cache) == NULL) {
1393       oop_map_cache = new OopMapCache();
1394       // Ensure _oop_map_cache is stable, since it is examined without a lock
1395       Atomic::release_store(&amp;_oop_map_cache, oop_map_cache);
1396     }
1397   }
1398   // _oop_map_cache is constant after init; lookup below does its own locking.
1399   oop_map_cache-&gt;lookup(method, bci, entry_for);
1400 }
1401 
1402 
1403 bool InstanceKlass::find_local_field(Symbol* name, Symbol* sig, fieldDescriptor* fd) const {
1404   for (JavaFieldStream fs(this); !fs.done(); fs.next()) {
1405     Symbol* f_name = fs.name();
1406     Symbol* f_sig  = fs.signature();
1407     if (f_name == name &amp;&amp; f_sig == sig) {
1408       fd-&gt;reinitialize(const_cast&lt;InstanceKlass*&gt;(this), fs.index());
1409       return true;
1410     }
1411   }
1412   return false;
1413 }
1414 
1415 
1416 Klass* InstanceKlass::find_interface_field(Symbol* name, Symbol* sig, fieldDescriptor* fd) const {
1417   const int n = local_interfaces()-&gt;length();
1418   for (int i = 0; i &lt; n; i++) {
1419     Klass* intf1 = local_interfaces()-&gt;at(i);
1420     assert(intf1-&gt;is_interface(), &quot;just checking type&quot;);
1421     // search for field in current interface
1422     if (InstanceKlass::cast(intf1)-&gt;find_local_field(name, sig, fd)) {
1423       assert(fd-&gt;is_static(), &quot;interface field must be static&quot;);
1424       return intf1;
1425     }
1426     // search for field in direct superinterfaces
1427     Klass* intf2 = InstanceKlass::cast(intf1)-&gt;find_interface_field(name, sig, fd);
1428     if (intf2 != NULL) return intf2;
1429   }
1430   // otherwise field lookup fails
1431   return NULL;
1432 }
1433 
1434 
1435 Klass* InstanceKlass::find_field(Symbol* name, Symbol* sig, fieldDescriptor* fd) const {
1436   // search order according to newest JVM spec (5.4.3.2, p.167).
1437   // 1) search for field in current klass
1438   if (find_local_field(name, sig, fd)) {
1439     return const_cast&lt;InstanceKlass*&gt;(this);
1440   }
1441   // 2) search for field recursively in direct superinterfaces
1442   { Klass* intf = find_interface_field(name, sig, fd);
1443     if (intf != NULL) return intf;
1444   }
1445   // 3) apply field lookup recursively if superclass exists
1446   { Klass* supr = super();
1447     if (supr != NULL) return InstanceKlass::cast(supr)-&gt;find_field(name, sig, fd);
1448   }
1449   // 4) otherwise field lookup fails
1450   return NULL;
1451 }
1452 
1453 
1454 Klass* InstanceKlass::find_field(Symbol* name, Symbol* sig, bool is_static, fieldDescriptor* fd) const {
1455   // search order according to newest JVM spec (5.4.3.2, p.167).
1456   // 1) search for field in current klass
1457   if (find_local_field(name, sig, fd)) {
1458     if (fd-&gt;is_static() == is_static) return const_cast&lt;InstanceKlass*&gt;(this);
1459   }
1460   // 2) search for field recursively in direct superinterfaces
1461   if (is_static) {
1462     Klass* intf = find_interface_field(name, sig, fd);
1463     if (intf != NULL) return intf;
1464   }
1465   // 3) apply field lookup recursively if superclass exists
1466   { Klass* supr = super();
1467     if (supr != NULL) return InstanceKlass::cast(supr)-&gt;find_field(name, sig, is_static, fd);
1468   }
1469   // 4) otherwise field lookup fails
1470   return NULL;
1471 }
1472 
1473 
1474 bool InstanceKlass::find_local_field_from_offset(int offset, bool is_static, fieldDescriptor* fd) const {
1475   for (JavaFieldStream fs(this); !fs.done(); fs.next()) {
1476     if (fs.offset() == offset) {
1477       fd-&gt;reinitialize(const_cast&lt;InstanceKlass*&gt;(this), fs.index());
1478       if (fd-&gt;is_static() == is_static) return true;
1479     }
1480   }
1481   return false;
1482 }
1483 
1484 
1485 bool InstanceKlass::find_field_from_offset(int offset, bool is_static, fieldDescriptor* fd) const {
1486   Klass* klass = const_cast&lt;InstanceKlass*&gt;(this);
1487   while (klass != NULL) {
1488     if (InstanceKlass::cast(klass)-&gt;find_local_field_from_offset(offset, is_static, fd)) {
1489       return true;
1490     }
1491     klass = klass-&gt;super();
1492   }
1493   return false;
1494 }
1495 
1496 
1497 void InstanceKlass::methods_do(void f(Method* method)) {
1498   // Methods aren&#39;t stable until they are loaded.  This can be read outside
1499   // a lock through the ClassLoaderData for profiling
1500   if (!is_loaded()) {
1501     return;
1502   }
1503 
1504   int len = methods()-&gt;length();
1505   for (int index = 0; index &lt; len; index++) {
1506     Method* m = methods()-&gt;at(index);
1507     assert(m-&gt;is_method(), &quot;must be method&quot;);
1508     f(m);
1509   }
1510 }
1511 
1512 
1513 void InstanceKlass::do_local_static_fields(FieldClosure* cl) {
1514   for (JavaFieldStream fs(this); !fs.done(); fs.next()) {
1515     if (fs.access_flags().is_static()) {
1516       fieldDescriptor&amp; fd = fs.field_descriptor();
1517       cl-&gt;do_field(&amp;fd);
1518     }
1519   }
1520 }
1521 
1522 
1523 void InstanceKlass::do_local_static_fields(void f(fieldDescriptor*, Handle, TRAPS), Handle mirror, TRAPS) {
1524   for (JavaFieldStream fs(this); !fs.done(); fs.next()) {
1525     if (fs.access_flags().is_static()) {
1526       fieldDescriptor&amp; fd = fs.field_descriptor();
1527       f(&amp;fd, mirror, CHECK);
1528     }
1529   }
1530 }
1531 
1532 
1533 static int compare_fields_by_offset(int* a, int* b) {
1534   return a[0] - b[0];
1535 }
1536 
1537 void InstanceKlass::do_nonstatic_fields(FieldClosure* cl) {
1538   InstanceKlass* super = superklass();
1539   if (super != NULL) {
1540     super-&gt;do_nonstatic_fields(cl);
1541   }
1542   fieldDescriptor fd;
1543   int length = java_fields_count();
1544   // In DebugInfo nonstatic fields are sorted by offset.
1545   int* fields_sorted = NEW_C_HEAP_ARRAY(int, 2*(length+1), mtClass);
1546   int j = 0;
1547   for (int i = 0; i &lt; length; i += 1) {
1548     fd.reinitialize(this, i);
1549     if (!fd.is_static()) {
1550       fields_sorted[j + 0] = fd.offset();
1551       fields_sorted[j + 1] = i;
1552       j += 2;
1553     }
1554   }
1555   if (j &gt; 0) {
1556     length = j;
1557     // _sort_Fn is defined in growableArray.hpp.
1558     qsort(fields_sorted, length/2, 2*sizeof(int), (_sort_Fn)compare_fields_by_offset);
1559     for (int i = 0; i &lt; length; i += 2) {
1560       fd.reinitialize(this, fields_sorted[i + 1]);
1561       assert(!fd.is_static() &amp;&amp; fd.offset() == fields_sorted[i], &quot;only nonstatic fields&quot;);
1562       cl-&gt;do_field(&amp;fd);
1563     }
1564   }
1565   FREE_C_HEAP_ARRAY(int, fields_sorted);
1566 }
1567 
1568 
1569 void InstanceKlass::array_klasses_do(void f(Klass* k, TRAPS), TRAPS) {
1570   if (array_klasses() != NULL)
1571     ArrayKlass::cast(array_klasses())-&gt;array_klasses_do(f, THREAD);
1572 }
1573 
1574 void InstanceKlass::array_klasses_do(void f(Klass* k)) {
1575   if (array_klasses() != NULL)
1576     ArrayKlass::cast(array_klasses())-&gt;array_klasses_do(f);
1577 }
1578 
1579 #ifdef ASSERT
1580 static int linear_search(const Array&lt;Method*&gt;* methods,
1581                          const Symbol* name,
1582                          const Symbol* signature) {
1583   const int len = methods-&gt;length();
1584   for (int index = 0; index &lt; len; index++) {
1585     const Method* const m = methods-&gt;at(index);
1586     assert(m-&gt;is_method(), &quot;must be method&quot;);
1587     if (m-&gt;signature() == signature &amp;&amp; m-&gt;name() == name) {
1588        return index;
1589     }
1590   }
1591   return -1;
1592 }
1593 #endif
1594 
1595 bool InstanceKlass::_disable_method_binary_search = false;
1596 
1597 NOINLINE int linear_search(const Array&lt;Method*&gt;* methods, const Symbol* name) {
1598   int len = methods-&gt;length();
1599   int l = 0;
1600   int h = len - 1;
1601   while (l &lt;= h) {
1602     Method* m = methods-&gt;at(l);
1603     if (m-&gt;name() == name) {
1604       return l;
1605     }
1606     l++;
1607   }
1608   return -1;
1609 }
1610 
1611 inline int InstanceKlass::quick_search(const Array&lt;Method*&gt;* methods, const Symbol* name) {
1612   if (_disable_method_binary_search) {
1613     assert(DynamicDumpSharedSpaces, &quot;must be&quot;);
1614     // At the final stage of dynamic dumping, the methods array may not be sorted
1615     // by ascending addresses of their names, so we can&#39;t use binary search anymore.
1616     // However, methods with the same name are still laid out consecutively inside the
1617     // methods array, so let&#39;s look for the first one that matches.
1618     return linear_search(methods, name);
1619   }
1620 
1621   int len = methods-&gt;length();
1622   int l = 0;
1623   int h = len - 1;
1624 
1625   // methods are sorted by ascending addresses of their names, so do binary search
1626   while (l &lt;= h) {
1627     int mid = (l + h) &gt;&gt; 1;
1628     Method* m = methods-&gt;at(mid);
1629     assert(m-&gt;is_method(), &quot;must be method&quot;);
1630     int res = m-&gt;name()-&gt;fast_compare(name);
1631     if (res == 0) {
1632       return mid;
1633     } else if (res &lt; 0) {
1634       l = mid + 1;
1635     } else {
1636       h = mid - 1;
1637     }
1638   }
1639   return -1;
1640 }
1641 
1642 // find_method looks up the name/signature in the local methods array
1643 Method* InstanceKlass::find_method(const Symbol* name,
1644                                    const Symbol* signature) const {
1645   return find_method_impl(name, signature, find_overpass, find_static, find_private);
1646 }
1647 
1648 Method* InstanceKlass::find_method_impl(const Symbol* name,
1649                                         const Symbol* signature,
1650                                         OverpassLookupMode overpass_mode,
1651                                         StaticLookupMode static_mode,
1652                                         PrivateLookupMode private_mode) const {
1653   return InstanceKlass::find_method_impl(methods(),
1654                                          name,
1655                                          signature,
1656                                          overpass_mode,
1657                                          static_mode,
1658                                          private_mode);
1659 }
1660 
1661 // find_instance_method looks up the name/signature in the local methods array
1662 // and skips over static methods
1663 Method* InstanceKlass::find_instance_method(const Array&lt;Method*&gt;* methods,
1664                                             const Symbol* name,
1665                                             const Symbol* signature,
1666                                             PrivateLookupMode private_mode) {
1667   Method* const meth = InstanceKlass::find_method_impl(methods,
1668                                                  name,
1669                                                  signature,
1670                                                  find_overpass,
1671                                                  skip_static,
1672                                                  private_mode);
1673   assert(((meth == NULL) || !meth-&gt;is_static()),
1674     &quot;find_instance_method should have skipped statics&quot;);
1675   return meth;
1676 }
1677 
1678 // find_instance_method looks up the name/signature in the local methods array
1679 // and skips over static methods
1680 Method* InstanceKlass::find_instance_method(const Symbol* name,
1681                                             const Symbol* signature,
1682                                             PrivateLookupMode private_mode) const {
1683   return InstanceKlass::find_instance_method(methods(), name, signature, private_mode);
1684 }
1685 
1686 // Find looks up the name/signature in the local methods array
1687 // and filters on the overpass, static and private flags
1688 // This returns the first one found
1689 // note that the local methods array can have up to one overpass, one static
1690 // and one instance (private or not) with the same name/signature
1691 Method* InstanceKlass::find_local_method(const Symbol* name,
1692                                          const Symbol* signature,
1693                                          OverpassLookupMode overpass_mode,
1694                                          StaticLookupMode static_mode,
1695                                          PrivateLookupMode private_mode) const {
1696   return InstanceKlass::find_method_impl(methods(),
1697                                          name,
1698                                          signature,
1699                                          overpass_mode,
1700                                          static_mode,
1701                                          private_mode);
1702 }
1703 
1704 // Find looks up the name/signature in the local methods array
1705 // and filters on the overpass, static and private flags
1706 // This returns the first one found
1707 // note that the local methods array can have up to one overpass, one static
1708 // and one instance (private or not) with the same name/signature
1709 Method* InstanceKlass::find_local_method(const Array&lt;Method*&gt;* methods,
1710                                          const Symbol* name,
1711                                          const Symbol* signature,
1712                                          OverpassLookupMode overpass_mode,
1713                                          StaticLookupMode static_mode,
1714                                          PrivateLookupMode private_mode) {
1715   return InstanceKlass::find_method_impl(methods,
1716                                          name,
1717                                          signature,
1718                                          overpass_mode,
1719                                          static_mode,
1720                                          private_mode);
1721 }
1722 
1723 Method* InstanceKlass::find_method(const Array&lt;Method*&gt;* methods,
1724                                    const Symbol* name,
1725                                    const Symbol* signature) {
1726   return InstanceKlass::find_method_impl(methods,
1727                                          name,
1728                                          signature,
1729                                          find_overpass,
1730                                          find_static,
1731                                          find_private);
1732 }
1733 
1734 Method* InstanceKlass::find_method_impl(const Array&lt;Method*&gt;* methods,
1735                                         const Symbol* name,
1736                                         const Symbol* signature,
1737                                         OverpassLookupMode overpass_mode,
1738                                         StaticLookupMode static_mode,
1739                                         PrivateLookupMode private_mode) {
1740   int hit = find_method_index(methods, name, signature, overpass_mode, static_mode, private_mode);
1741   return hit &gt;= 0 ? methods-&gt;at(hit): NULL;
1742 }
1743 
1744 // true if method matches signature and conforms to skipping_X conditions.
1745 static bool method_matches(const Method* m,
1746                            const Symbol* signature,
1747                            bool skipping_overpass,
1748                            bool skipping_static,
1749                            bool skipping_private) {
1750   return ((m-&gt;signature() == signature) &amp;&amp;
1751     (!skipping_overpass || !m-&gt;is_overpass()) &amp;&amp;
1752     (!skipping_static || !m-&gt;is_static()) &amp;&amp;
1753     (!skipping_private || !m-&gt;is_private()));
1754 }
1755 
1756 // Used directly for default_methods to find the index into the
1757 // default_vtable_indices, and indirectly by find_method
1758 // find_method_index looks in the local methods array to return the index
1759 // of the matching name/signature. If, overpass methods are being ignored,
1760 // the search continues to find a potential non-overpass match.  This capability
1761 // is important during method resolution to prefer a static method, for example,
1762 // over an overpass method.
1763 // There is the possibility in any _method&#39;s array to have the same name/signature
1764 // for a static method, an overpass method and a local instance method
1765 // To correctly catch a given method, the search criteria may need
1766 // to explicitly skip the other two. For local instance methods, it
1767 // is often necessary to skip private methods
1768 int InstanceKlass::find_method_index(const Array&lt;Method*&gt;* methods,
1769                                      const Symbol* name,
1770                                      const Symbol* signature,
1771                                      OverpassLookupMode overpass_mode,
1772                                      StaticLookupMode static_mode,
1773                                      PrivateLookupMode private_mode) {
1774   const bool skipping_overpass = (overpass_mode == skip_overpass);
1775   const bool skipping_static = (static_mode == skip_static);
1776   const bool skipping_private = (private_mode == skip_private);
1777   const int hit = quick_search(methods, name);
1778   if (hit != -1) {
1779     const Method* const m = methods-&gt;at(hit);
1780 
1781     // Do linear search to find matching signature.  First, quick check
1782     // for common case, ignoring overpasses if requested.
1783     if (method_matches(m, signature, skipping_overpass, skipping_static, skipping_private)) {
1784       return hit;
1785     }
1786 
1787     // search downwards through overloaded methods
1788     int i;
1789     for (i = hit - 1; i &gt;= 0; --i) {
1790         const Method* const m = methods-&gt;at(i);
1791         assert(m-&gt;is_method(), &quot;must be method&quot;);
1792         if (m-&gt;name() != name) {
1793           break;
1794         }
1795         if (method_matches(m, signature, skipping_overpass, skipping_static, skipping_private)) {
1796           return i;
1797         }
1798     }
1799     // search upwards
1800     for (i = hit + 1; i &lt; methods-&gt;length(); ++i) {
1801         const Method* const m = methods-&gt;at(i);
1802         assert(m-&gt;is_method(), &quot;must be method&quot;);
1803         if (m-&gt;name() != name) {
1804           break;
1805         }
1806         if (method_matches(m, signature, skipping_overpass, skipping_static, skipping_private)) {
1807           return i;
1808         }
1809     }
1810     // not found
1811 #ifdef ASSERT
1812     const int index = (skipping_overpass || skipping_static || skipping_private) ? -1 :
1813       linear_search(methods, name, signature);
1814     assert(-1 == index, &quot;binary search should have found entry %d&quot;, index);
1815 #endif
1816   }
1817   return -1;
1818 }
1819 
1820 int InstanceKlass::find_method_by_name(const Symbol* name, int* end) const {
1821   return find_method_by_name(methods(), name, end);
1822 }
1823 
1824 int InstanceKlass::find_method_by_name(const Array&lt;Method*&gt;* methods,
1825                                        const Symbol* name,
1826                                        int* end_ptr) {
1827   assert(end_ptr != NULL, &quot;just checking&quot;);
1828   int start = quick_search(methods, name);
1829   int end = start + 1;
1830   if (start != -1) {
1831     while (start - 1 &gt;= 0 &amp;&amp; (methods-&gt;at(start - 1))-&gt;name() == name) --start;
1832     while (end &lt; methods-&gt;length() &amp;&amp; (methods-&gt;at(end))-&gt;name() == name) ++end;
1833     *end_ptr = end;
1834     return start;
1835   }
1836   return -1;
1837 }
1838 
1839 // uncached_lookup_method searches both the local class methods array and all
1840 // superclasses methods arrays, skipping any overpass methods in superclasses,
1841 // and possibly skipping private methods.
1842 Method* InstanceKlass::uncached_lookup_method(const Symbol* name,
1843                                               const Symbol* signature,
1844                                               OverpassLookupMode overpass_mode,
1845                                               PrivateLookupMode private_mode) const {
1846   OverpassLookupMode overpass_local_mode = overpass_mode;
1847   const Klass* klass = this;
1848   while (klass != NULL) {
1849     Method* const method = InstanceKlass::cast(klass)-&gt;find_method_impl(name,
1850                                                                         signature,
1851                                                                         overpass_local_mode,
1852                                                                         find_static,
1853                                                                         private_mode);
1854     if (method != NULL) {
1855       return method;
1856     }
1857     klass = klass-&gt;super();
1858     overpass_local_mode = skip_overpass;   // Always ignore overpass methods in superclasses
1859   }
1860   return NULL;
1861 }
1862 
1863 #ifdef ASSERT
1864 // search through class hierarchy and return true if this class or
1865 // one of the superclasses was redefined
1866 bool InstanceKlass::has_redefined_this_or_super() const {
1867   const Klass* klass = this;
1868   while (klass != NULL) {
1869     if (InstanceKlass::cast(klass)-&gt;has_been_redefined()) {
1870       return true;
1871     }
1872     klass = klass-&gt;super();
1873   }
1874   return false;
1875 }
1876 #endif
1877 
1878 // lookup a method in the default methods list then in all transitive interfaces
1879 // Do NOT return private or static methods
1880 Method* InstanceKlass::lookup_method_in_ordered_interfaces(Symbol* name,
1881                                                          Symbol* signature) const {
1882   Method* m = NULL;
1883   if (default_methods() != NULL) {
1884     m = find_method(default_methods(), name, signature);
1885   }
1886   // Look up interfaces
1887   if (m == NULL) {
1888     m = lookup_method_in_all_interfaces(name, signature, find_defaults);
1889   }
1890   return m;
1891 }
1892 
1893 // lookup a method in all the interfaces that this class implements
1894 // Do NOT return private or static methods, new in JDK8 which are not externally visible
1895 // They should only be found in the initial InterfaceMethodRef
1896 Method* InstanceKlass::lookup_method_in_all_interfaces(Symbol* name,
1897                                                        Symbol* signature,
1898                                                        DefaultsLookupMode defaults_mode) const {
1899   Array&lt;InstanceKlass*&gt;* all_ifs = transitive_interfaces();
1900   int num_ifs = all_ifs-&gt;length();
1901   InstanceKlass *ik = NULL;
1902   for (int i = 0; i &lt; num_ifs; i++) {
1903     ik = all_ifs-&gt;at(i);
1904     Method* m = ik-&gt;lookup_method(name, signature);
1905     if (m != NULL &amp;&amp; m-&gt;is_public() &amp;&amp; !m-&gt;is_static() &amp;&amp;
1906         ((defaults_mode != skip_defaults) || !m-&gt;is_default_method())) {
1907       return m;
1908     }
1909   }
1910   return NULL;
1911 }
1912 
1913 /* jni_id_for_impl for jfieldIds only */
1914 JNIid* InstanceKlass::jni_id_for_impl(int offset) {
1915   MutexLocker ml(JfieldIdCreation_lock);
1916   // Retry lookup after we got the lock
1917   JNIid* probe = jni_ids() == NULL ? NULL : jni_ids()-&gt;find(offset);
1918   if (probe == NULL) {
1919     // Slow case, allocate new static field identifier
1920     probe = new JNIid(this, offset, jni_ids());
1921     set_jni_ids(probe);
1922   }
1923   return probe;
1924 }
1925 
1926 
1927 /* jni_id_for for jfieldIds only */
1928 JNIid* InstanceKlass::jni_id_for(int offset) {
1929   JNIid* probe = jni_ids() == NULL ? NULL : jni_ids()-&gt;find(offset);
1930   if (probe == NULL) {
1931     probe = jni_id_for_impl(offset);
1932   }
1933   return probe;
1934 }
1935 
1936 u2 InstanceKlass::enclosing_method_data(int offset) const {
1937   const Array&lt;jushort&gt;* const inner_class_list = inner_classes();
1938   if (inner_class_list == NULL) {
1939     return 0;
1940   }
1941   const int length = inner_class_list-&gt;length();
1942   if (length % inner_class_next_offset == 0) {
1943     return 0;
1944   }
1945   const int index = length - enclosing_method_attribute_size;
1946   assert(offset &lt; enclosing_method_attribute_size, &quot;invalid offset&quot;);
1947   return inner_class_list-&gt;at(index + offset);
1948 }
1949 
1950 void InstanceKlass::set_enclosing_method_indices(u2 class_index,
1951                                                  u2 method_index) {
1952   Array&lt;jushort&gt;* inner_class_list = inner_classes();
1953   assert (inner_class_list != NULL, &quot;_inner_classes list is not set up&quot;);
1954   int length = inner_class_list-&gt;length();
1955   if (length % inner_class_next_offset == enclosing_method_attribute_size) {
1956     int index = length - enclosing_method_attribute_size;
1957     inner_class_list-&gt;at_put(
1958       index + enclosing_method_class_index_offset, class_index);
1959     inner_class_list-&gt;at_put(
1960       index + enclosing_method_method_index_offset, method_index);
1961   }
1962 }
1963 
1964 // Lookup or create a jmethodID.
1965 // This code is called by the VMThread and JavaThreads so the
1966 // locking has to be done very carefully to avoid deadlocks
1967 // and/or other cache consistency problems.
1968 //
1969 jmethodID InstanceKlass::get_jmethod_id(const methodHandle&amp; method_h) {
1970   size_t idnum = (size_t)method_h-&gt;method_idnum();
1971   jmethodID* jmeths = methods_jmethod_ids_acquire();
1972   size_t length = 0;
1973   jmethodID id = NULL;
1974 
1975   // We use a double-check locking idiom here because this cache is
1976   // performance sensitive. In the normal system, this cache only
1977   // transitions from NULL to non-NULL which is safe because we use
1978   // release_set_methods_jmethod_ids() to advertise the new cache.
1979   // A partially constructed cache should never be seen by a racing
1980   // thread. We also use release_store() to save a new jmethodID
1981   // in the cache so a partially constructed jmethodID should never be
1982   // seen either. Cache reads of existing jmethodIDs proceed without a
1983   // lock, but cache writes of a new jmethodID requires uniqueness and
1984   // creation of the cache itself requires no leaks so a lock is
1985   // generally acquired in those two cases.
1986   //
1987   // If the RedefineClasses() API has been used, then this cache can
1988   // grow and we&#39;ll have transitions from non-NULL to bigger non-NULL.
1989   // Cache creation requires no leaks and we require safety between all
1990   // cache accesses and freeing of the old cache so a lock is generally
1991   // acquired when the RedefineClasses() API has been used.
1992 
1993   if (jmeths != NULL) {
1994     // the cache already exists
1995     if (!idnum_can_increment()) {
1996       // the cache can&#39;t grow so we can just get the current values
1997       get_jmethod_id_length_value(jmeths, idnum, &amp;length, &amp;id);
1998     } else {
1999       // cache can grow so we have to be more careful
2000       if (Threads::number_of_threads() == 0 ||
2001           SafepointSynchronize::is_at_safepoint()) {
2002         // we&#39;re single threaded or at a safepoint - no locking needed
2003         get_jmethod_id_length_value(jmeths, idnum, &amp;length, &amp;id);
2004       } else {
2005         MutexLocker ml(JmethodIdCreation_lock, Mutex::_no_safepoint_check_flag);
2006         get_jmethod_id_length_value(jmeths, idnum, &amp;length, &amp;id);
2007       }
2008     }
2009   }
2010   // implied else:
2011   // we need to allocate a cache so default length and id values are good
2012 
2013   if (jmeths == NULL ||   // no cache yet
2014       length &lt;= idnum ||  // cache is too short
2015       id == NULL) {       // cache doesn&#39;t contain entry
2016 
2017     // This function can be called by the VMThread so we have to do all
2018     // things that might block on a safepoint before grabbing the lock.
2019     // Otherwise, we can deadlock with the VMThread or have a cache
2020     // consistency issue. These vars keep track of what we might have
2021     // to free after the lock is dropped.
2022     jmethodID  to_dealloc_id     = NULL;
2023     jmethodID* to_dealloc_jmeths = NULL;
2024 
2025     // may not allocate new_jmeths or use it if we allocate it
2026     jmethodID* new_jmeths = NULL;
2027     if (length &lt;= idnum) {
2028       // allocate a new cache that might be used
2029       size_t size = MAX2(idnum+1, (size_t)idnum_allocated_count());
2030       new_jmeths = NEW_C_HEAP_ARRAY(jmethodID, size+1, mtClass);
2031       memset(new_jmeths, 0, (size+1)*sizeof(jmethodID));
2032       // cache size is stored in element[0], other elements offset by one
2033       new_jmeths[0] = (jmethodID)size;
2034     }
2035 
2036     // allocate a new jmethodID that might be used
2037     jmethodID new_id = NULL;
2038     if (method_h-&gt;is_old() &amp;&amp; !method_h-&gt;is_obsolete()) {
2039       // The method passed in is old (but not obsolete), we need to use the current version
2040       Method* current_method = method_with_idnum((int)idnum);
2041       assert(current_method != NULL, &quot;old and but not obsolete, so should exist&quot;);
2042       new_id = Method::make_jmethod_id(class_loader_data(), current_method);
2043     } else {
2044       // It is the current version of the method or an obsolete method,
2045       // use the version passed in
2046       new_id = Method::make_jmethod_id(class_loader_data(), method_h());
2047     }
2048 
2049     if (Threads::number_of_threads() == 0 ||
2050         SafepointSynchronize::is_at_safepoint()) {
2051       // we&#39;re single threaded or at a safepoint - no locking needed
2052       id = get_jmethod_id_fetch_or_update(idnum, new_id, new_jmeths,
2053                                           &amp;to_dealloc_id, &amp;to_dealloc_jmeths);
2054     } else {
2055       MutexLocker ml(JmethodIdCreation_lock, Mutex::_no_safepoint_check_flag);
2056       id = get_jmethod_id_fetch_or_update(idnum, new_id, new_jmeths,
2057                                           &amp;to_dealloc_id, &amp;to_dealloc_jmeths);
2058     }
2059 
2060     // The lock has been dropped so we can free resources.
2061     // Free up either the old cache or the new cache if we allocated one.
2062     if (to_dealloc_jmeths != NULL) {
2063       FreeHeap(to_dealloc_jmeths);
2064     }
2065     // free up the new ID since it wasn&#39;t needed
2066     if (to_dealloc_id != NULL) {
2067       Method::destroy_jmethod_id(class_loader_data(), to_dealloc_id);
2068     }
2069   }
2070   return id;
2071 }
2072 
2073 // Figure out how many jmethodIDs haven&#39;t been allocated, and make
2074 // sure space for them is pre-allocated.  This makes getting all
2075 // method ids much, much faster with classes with more than 8
2076 // methods, and has a *substantial* effect on performance with jvmti
2077 // code that loads all jmethodIDs for all classes.
2078 void InstanceKlass::ensure_space_for_methodids(int start_offset) {
2079   int new_jmeths = 0;
2080   int length = methods()-&gt;length();
2081   for (int index = start_offset; index &lt; length; index++) {
2082     Method* m = methods()-&gt;at(index);
2083     jmethodID id = m-&gt;find_jmethod_id_or_null();
2084     if (id == NULL) {
2085       new_jmeths++;
2086     }
2087   }
2088   if (new_jmeths != 0) {
2089     Method::ensure_jmethod_ids(class_loader_data(), new_jmeths);
2090   }
2091 }
2092 
2093 // Common code to fetch the jmethodID from the cache or update the
2094 // cache with the new jmethodID. This function should never do anything
2095 // that causes the caller to go to a safepoint or we can deadlock with
2096 // the VMThread or have cache consistency issues.
2097 //
2098 jmethodID InstanceKlass::get_jmethod_id_fetch_or_update(
2099             size_t idnum, jmethodID new_id,
2100             jmethodID* new_jmeths, jmethodID* to_dealloc_id_p,
2101             jmethodID** to_dealloc_jmeths_p) {
2102   assert(new_id != NULL, &quot;sanity check&quot;);
2103   assert(to_dealloc_id_p != NULL, &quot;sanity check&quot;);
2104   assert(to_dealloc_jmeths_p != NULL, &quot;sanity check&quot;);
2105   assert(Threads::number_of_threads() == 0 ||
2106          SafepointSynchronize::is_at_safepoint() ||
2107          JmethodIdCreation_lock-&gt;owned_by_self(), &quot;sanity check&quot;);
2108 
2109   // reacquire the cache - we are locked, single threaded or at a safepoint
2110   jmethodID* jmeths = methods_jmethod_ids_acquire();
2111   jmethodID  id     = NULL;
2112   size_t     length = 0;
2113 
2114   if (jmeths == NULL ||                         // no cache yet
2115       (length = (size_t)jmeths[0]) &lt;= idnum) {  // cache is too short
2116     if (jmeths != NULL) {
2117       // copy any existing entries from the old cache
2118       for (size_t index = 0; index &lt; length; index++) {
2119         new_jmeths[index+1] = jmeths[index+1];
2120       }
2121       *to_dealloc_jmeths_p = jmeths;  // save old cache for later delete
2122     }
2123     release_set_methods_jmethod_ids(jmeths = new_jmeths);
2124   } else {
2125     // fetch jmethodID (if any) from the existing cache
2126     id = jmeths[idnum+1];
2127     *to_dealloc_jmeths_p = new_jmeths;  // save new cache for later delete
2128   }
2129   if (id == NULL) {
2130     // No matching jmethodID in the existing cache or we have a new
2131     // cache or we just grew the cache. This cache write is done here
2132     // by the first thread to win the foot race because a jmethodID
2133     // needs to be unique once it is generally available.
2134     id = new_id;
2135 
2136     // The jmethodID cache can be read while unlocked so we have to
2137     // make sure the new jmethodID is complete before installing it
2138     // in the cache.
2139     Atomic::release_store(&amp;jmeths[idnum+1], id);
2140   } else {
2141     *to_dealloc_id_p = new_id; // save new id for later delete
2142   }
2143   return id;
2144 }
2145 
2146 
2147 // Common code to get the jmethodID cache length and the jmethodID
2148 // value at index idnum if there is one.
2149 //
2150 void InstanceKlass::get_jmethod_id_length_value(jmethodID* cache,
2151        size_t idnum, size_t *length_p, jmethodID* id_p) {
2152   assert(cache != NULL, &quot;sanity check&quot;);
2153   assert(length_p != NULL, &quot;sanity check&quot;);
2154   assert(id_p != NULL, &quot;sanity check&quot;);
2155 
2156   // cache size is stored in element[0], other elements offset by one
2157   *length_p = (size_t)cache[0];
2158   if (*length_p &lt;= idnum) {  // cache is too short
2159     *id_p = NULL;
2160   } else {
2161     *id_p = cache[idnum+1];  // fetch jmethodID (if any)
2162   }
2163 }
2164 
2165 
2166 // Lookup a jmethodID, NULL if not found.  Do no blocking, no allocations, no handles
2167 jmethodID InstanceKlass::jmethod_id_or_null(Method* method) {
2168   size_t idnum = (size_t)method-&gt;method_idnum();
2169   jmethodID* jmeths = methods_jmethod_ids_acquire();
2170   size_t length;                                // length assigned as debugging crumb
2171   jmethodID id = NULL;
2172   if (jmeths != NULL &amp;&amp;                         // If there is a cache
2173       (length = (size_t)jmeths[0]) &gt; idnum) {   // and if it is long enough,
2174     id = jmeths[idnum+1];                       // Look up the id (may be NULL)
2175   }
2176   return id;
2177 }
2178 
2179 inline DependencyContext InstanceKlass::dependencies() {
2180   DependencyContext dep_context(&amp;_dep_context, &amp;_dep_context_last_cleaned);
2181   return dep_context;
2182 }
2183 
2184 int InstanceKlass::mark_dependent_nmethods(KlassDepChange&amp; changes) {
2185   return dependencies().mark_dependent_nmethods(changes);
2186 }
2187 
2188 void InstanceKlass::add_dependent_nmethod(nmethod* nm) {
2189   dependencies().add_dependent_nmethod(nm);
2190 }
2191 
2192 void InstanceKlass::remove_dependent_nmethod(nmethod* nm) {
2193   dependencies().remove_dependent_nmethod(nm);
2194 }
2195 
2196 void InstanceKlass::clean_dependency_context() {
2197   dependencies().clean_unloading_dependents();
2198 }
2199 
2200 #ifndef PRODUCT
2201 void InstanceKlass::print_dependent_nmethods(bool verbose) {
2202   dependencies().print_dependent_nmethods(verbose);
2203 }
2204 
2205 bool InstanceKlass::is_dependent_nmethod(nmethod* nm) {
2206   return dependencies().is_dependent_nmethod(nm);
2207 }
2208 #endif //PRODUCT
2209 
2210 void InstanceKlass::clean_weak_instanceklass_links() {
2211   clean_implementors_list();
2212   clean_method_data();
2213 }
2214 
2215 void InstanceKlass::clean_implementors_list() {
2216   assert(is_loader_alive(), &quot;this klass should be live&quot;);
2217   if (is_interface()) {
2218     assert (ClassUnloading, &quot;only called for ClassUnloading&quot;);
2219     for (;;) {
2220       // Use load_acquire due to competing with inserts
2221       Klass* impl = Atomic::load_acquire(adr_implementor());
2222       if (impl != NULL &amp;&amp; !impl-&gt;is_loader_alive()) {
2223         // NULL this field, might be an unloaded klass or NULL
2224         Klass* volatile* klass = adr_implementor();
2225         if (Atomic::cmpxchg(klass, impl, (Klass*)NULL) == impl) {
2226           // Successfully unlinking implementor.
2227           if (log_is_enabled(Trace, class, unload)) {
2228             ResourceMark rm;
2229             log_trace(class, unload)(&quot;unlinking class (implementor): %s&quot;, impl-&gt;external_name());
2230           }
2231           return;
2232         }
2233       } else {
2234         return;
2235       }
2236     }
2237   }
2238 }
2239 
2240 void InstanceKlass::clean_method_data() {
2241   for (int m = 0; m &lt; methods()-&gt;length(); m++) {
2242     MethodData* mdo = methods()-&gt;at(m)-&gt;method_data();
2243     if (mdo != NULL) {
2244       MutexLocker ml(SafepointSynchronize::is_at_safepoint() ? NULL : mdo-&gt;extra_data_lock());
2245       mdo-&gt;clean_method_data(/*always_clean*/false);
2246     }
2247   }
2248 }
2249 
2250 bool InstanceKlass::supers_have_passed_fingerprint_checks() {
2251   if (java_super() != NULL &amp;&amp; !java_super()-&gt;has_passed_fingerprint_check()) {
2252     ResourceMark rm;
2253     log_trace(class, fingerprint)(&quot;%s : super %s not fingerprinted&quot;, external_name(), java_super()-&gt;external_name());
2254     return false;
2255   }
2256 
2257   Array&lt;InstanceKlass*&gt;* local_interfaces = this-&gt;local_interfaces();
2258   if (local_interfaces != NULL) {
2259     int length = local_interfaces-&gt;length();
2260     for (int i = 0; i &lt; length; i++) {
2261       InstanceKlass* intf = local_interfaces-&gt;at(i);
2262       if (!intf-&gt;has_passed_fingerprint_check()) {
2263         ResourceMark rm;
2264         log_trace(class, fingerprint)(&quot;%s : interface %s not fingerprinted&quot;, external_name(), intf-&gt;external_name());
2265         return false;
2266       }
2267     }
2268   }
2269 
2270   return true;
2271 }
2272 
2273 bool InstanceKlass::should_store_fingerprint(bool is_unsafe_anonymous) {
2274 #if INCLUDE_AOT
2275   // We store the fingerprint into the InstanceKlass only in the following 2 cases:
2276   if (CalculateClassFingerprint) {
2277     // (1) We are running AOT to generate a shared library.
2278     return true;
2279   }
2280   if (Arguments::is_dumping_archive()) {
2281     // (2) We are running -Xshare:dump or -XX:ArchiveClassesAtExit to create a shared archive
2282     return true;
2283   }
2284   if (UseAOT &amp;&amp; is_unsafe_anonymous) {
2285     // (3) We are using AOT code from a shared library and see an unsafe anonymous class
2286     return true;
2287   }
2288 #endif
2289 
2290   // In all other cases we might set the _misc_has_passed_fingerprint_check bit,
2291   // but do not store the 64-bit fingerprint to save space.
2292   return false;
2293 }
2294 
2295 bool InstanceKlass::has_stored_fingerprint() const {
2296 #if INCLUDE_AOT
2297   return should_store_fingerprint() || is_shared();
2298 #else
2299   return false;
2300 #endif
2301 }
2302 
2303 uint64_t InstanceKlass::get_stored_fingerprint() const {
2304   address adr = adr_fingerprint();
2305   if (adr != NULL) {
2306     return (uint64_t)Bytes::get_native_u8(adr); // adr may not be 64-bit aligned
2307   }
2308   return 0;
2309 }
2310 
2311 void InstanceKlass::store_fingerprint(uint64_t fingerprint) {
2312   address adr = adr_fingerprint();
2313   if (adr != NULL) {
2314     Bytes::put_native_u8(adr, (u8)fingerprint); // adr may not be 64-bit aligned
2315 
2316     ResourceMark rm;
2317     log_trace(class, fingerprint)(&quot;stored as &quot; PTR64_FORMAT &quot; for class %s&quot;, fingerprint, external_name());
2318   }
2319 }
2320 
2321 void InstanceKlass::metaspace_pointers_do(MetaspaceClosure* it) {
2322   Klass::metaspace_pointers_do(it);
2323 
2324   if (log_is_enabled(Trace, cds)) {
2325     ResourceMark rm;
2326     log_trace(cds)(&quot;Iter(InstanceKlass): %p (%s)&quot;, this, external_name());
2327   }
2328 
2329   it-&gt;push(&amp;_annotations);
2330   it-&gt;push((Klass**)&amp;_array_klasses);
2331   it-&gt;push(&amp;_constants);
2332   it-&gt;push(&amp;_inner_classes);
2333   it-&gt;push(&amp;_array_name);
2334 #if INCLUDE_JVMTI
2335   it-&gt;push(&amp;_previous_versions);
2336 #endif
2337   it-&gt;push(&amp;_methods);
2338   it-&gt;push(&amp;_default_methods);
2339   it-&gt;push(&amp;_local_interfaces);
2340   it-&gt;push(&amp;_transitive_interfaces);
2341   it-&gt;push(&amp;_method_ordering);
2342   it-&gt;push(&amp;_default_vtable_indices);
2343   it-&gt;push(&amp;_fields);
2344 
2345   if (itable_length() &gt; 0) {
2346     itableOffsetEntry* ioe = (itableOffsetEntry*)start_of_itable();
2347     int method_table_offset_in_words = ioe-&gt;offset()/wordSize;
2348     int nof_interfaces = (method_table_offset_in_words - itable_offset_in_words())
2349                          / itableOffsetEntry::size();
2350 
2351     for (int i = 0; i &lt; nof_interfaces; i ++, ioe ++) {
2352       if (ioe-&gt;interface_klass() != NULL) {
2353         it-&gt;push(ioe-&gt;interface_klass_addr());
2354         itableMethodEntry* ime = ioe-&gt;first_method_entry(this);
2355         int n = klassItable::method_count_for_interface(ioe-&gt;interface_klass());
2356         for (int index = 0; index &lt; n; index ++) {
2357           it-&gt;push(ime[index].method_addr());
2358         }
2359       }
2360     }
2361   }
2362 
2363   it-&gt;push(&amp;_nest_members);
2364   it-&gt;push(&amp;_record_components);
2365 }
2366 
2367 void InstanceKlass::remove_unshareable_info() {
2368   Klass::remove_unshareable_info();
2369 
2370   if (is_in_error_state()) {
2371     // Classes are attempted to link during dumping and may fail,
2372     // but these classes are still in the dictionary and class list in CLD.
2373     // Check in_error state first because in_error is &gt; linked state, so
2374     // is_linked() is true.
2375     // If there&#39;s a linking error, there is nothing else to remove.
2376     return;
2377   }
2378 
2379   // Reset to the &#39;allocated&#39; state to prevent any premature accessing to
2380   // a shared class at runtime while the class is still being loaded and
2381   // restored. A class&#39; init_state is set to &#39;loaded&#39; at runtime when it&#39;s
2382   // being added to class hierarchy (see SystemDictionary:::add_to_hierarchy()).
2383   _init_state = allocated;
2384 
2385   { // Otherwise this needs to take out the Compile_lock.
2386     assert(SafepointSynchronize::is_at_safepoint(), &quot;only called at safepoint&quot;);
2387     init_implementor();
2388   }
2389 
2390   constants()-&gt;remove_unshareable_info();
2391 
2392   for (int i = 0; i &lt; methods()-&gt;length(); i++) {
2393     Method* m = methods()-&gt;at(i);
2394     m-&gt;remove_unshareable_info();
2395   }
2396 
2397   // do array classes also.
2398   if (array_klasses() != NULL) {
2399     array_klasses()-&gt;remove_unshareable_info();
2400   }
2401 
2402   // These are not allocated from metaspace. They are safe to set to NULL.
2403   _source_debug_extension = NULL;
2404   _dep_context = NULL;
2405   _osr_nmethods_head = NULL;
2406 #if INCLUDE_JVMTI
2407   _breakpoints = NULL;
2408   _previous_versions = NULL;
2409   _cached_class_file = NULL;
2410   _jvmti_cached_class_field_map = NULL;
2411 #endif
2412 
2413   _init_thread = NULL;
2414   _methods_jmethod_ids = NULL;
2415   _jni_ids = NULL;
2416   _oop_map_cache = NULL;
2417   // clear _nest_host to ensure re-load at runtime
2418   _nest_host = NULL;
2419   _package_entry = NULL;
2420   _dep_context_last_cleaned = 0;
2421 }
2422 
2423 void InstanceKlass::remove_java_mirror() {
2424   Klass::remove_java_mirror();
2425 
2426   // do array classes also.
2427   if (array_klasses() != NULL) {
2428     array_klasses()-&gt;remove_java_mirror();
2429   }
2430 }
2431 
2432 void InstanceKlass::restore_unshareable_info(ClassLoaderData* loader_data, Handle protection_domain, TRAPS) {
2433   // SystemDictionary::add_to_hierarchy() sets the init_state to loaded
2434   // before the InstanceKlass is added to the SystemDictionary. Make
2435   // sure the current state is &lt;loaded.
2436   assert(!is_loaded(), &quot;invalid init state&quot;);
2437   set_package(loader_data, CHECK);
2438   Klass::restore_unshareable_info(loader_data, protection_domain, CHECK);
2439 
2440   Array&lt;Method*&gt;* methods = this-&gt;methods();
2441   int num_methods = methods-&gt;length();
2442   for (int index = 0; index &lt; num_methods; ++index) {
2443     methods-&gt;at(index)-&gt;restore_unshareable_info(CHECK);
2444   }
2445   if (JvmtiExport::has_redefined_a_class()) {
2446     // Reinitialize vtable because RedefineClasses may have changed some
2447     // entries in this vtable for super classes so the CDS vtable might
2448     // point to old or obsolete entries.  RedefineClasses doesn&#39;t fix up
2449     // vtables in the shared system dictionary, only the main one.
2450     // It also redefines the itable too so fix that too.
2451     vtable().initialize_vtable(false, CHECK);
2452     itable().initialize_itable(false, CHECK);
2453   }
2454 
2455   // restore constant pool resolved references
2456   constants()-&gt;restore_unshareable_info(CHECK);
2457 
2458   if (array_klasses() != NULL) {
2459     // Array classes have null protection domain.
2460     // --&gt; see ArrayKlass::complete_create_array_klass()
2461     array_klasses()-&gt;restore_unshareable_info(ClassLoaderData::the_null_class_loader_data(), Handle(), CHECK);
2462   }
2463 
2464   // Initialize current biased locking state.
2465   if (UseBiasedLocking &amp;&amp; BiasedLocking::enabled()) {
2466     set_prototype_header(markWord::biased_locking_prototype());
2467   }
2468 }
2469 
2470 // returns true IFF is_in_error_state() has been changed as a result of this call.
2471 bool InstanceKlass::check_sharing_error_state() {
2472   assert(DumpSharedSpaces, &quot;should only be called during dumping&quot;);
2473   bool old_state = is_in_error_state();
2474 
2475   if (!is_in_error_state()) {
2476     bool bad = false;
2477     for (InstanceKlass* sup = java_super(); sup; sup = sup-&gt;java_super()) {
2478       if (sup-&gt;is_in_error_state()) {
2479         bad = true;
2480         break;
2481       }
2482     }
2483     if (!bad) {
2484       Array&lt;InstanceKlass*&gt;* interfaces = transitive_interfaces();
2485       for (int i = 0; i &lt; interfaces-&gt;length(); i++) {
2486         InstanceKlass* iface = interfaces-&gt;at(i);
2487         if (iface-&gt;is_in_error_state()) {
2488           bad = true;
2489           break;
2490         }
2491       }
2492     }
2493 
2494     if (bad) {
2495       set_in_error_state();
2496     }
2497   }
2498 
2499   return (old_state != is_in_error_state());
2500 }
2501 
2502 void InstanceKlass::set_class_loader_type(s2 loader_type) {
2503   switch (loader_type) {
2504   case ClassLoader::BOOT_LOADER:
2505     _misc_flags |= _misc_is_shared_boot_class;
2506     break;
2507   case ClassLoader::PLATFORM_LOADER:
2508     _misc_flags |= _misc_is_shared_platform_class;
2509     break;
2510   case ClassLoader::APP_LOADER:
2511     _misc_flags |= _misc_is_shared_app_class;
2512     break;
2513   default:
2514     ShouldNotReachHere();
2515     break;
2516   }
2517 }
2518 
2519 #if INCLUDE_JVMTI
2520 static void clear_all_breakpoints(Method* m) {
2521   m-&gt;clear_all_breakpoints();
2522 }
2523 #endif
2524 
2525 void InstanceKlass::unload_class(InstanceKlass* ik) {
2526   // Release dependencies.
2527   ik-&gt;dependencies().remove_all_dependents();
2528 
2529   // notify the debugger
2530   if (JvmtiExport::should_post_class_unload()) {
2531     JvmtiExport::post_class_unload(ik);
2532   }
2533 
2534   // notify ClassLoadingService of class unload
2535   ClassLoadingService::notify_class_unloaded(ik);
2536 
2537   if (Arguments::is_dumping_archive()) {
2538     SystemDictionaryShared::remove_dumptime_info(ik);
2539   }
2540 
2541   if (log_is_enabled(Info, class, unload)) {
2542     ResourceMark rm;
2543     log_info(class, unload)(&quot;unloading class %s &quot; INTPTR_FORMAT, ik-&gt;external_name(), p2i(ik));
2544   }
2545 
2546   Events::log_class_unloading(Thread::current(), ik);
2547 
2548 #if INCLUDE_JFR
2549   assert(ik != NULL, &quot;invariant&quot;);
2550   EventClassUnload event;
2551   event.set_unloadedClass(ik);
2552   event.set_definingClassLoader(ik-&gt;class_loader_data());
2553   event.commit();
2554 #endif
2555 }
2556 
2557 static void method_release_C_heap_structures(Method* m) {
2558   m-&gt;release_C_heap_structures();
2559 }
2560 
2561 void InstanceKlass::release_C_heap_structures(InstanceKlass* ik) {
2562   // Clean up C heap
2563   ik-&gt;release_C_heap_structures();
2564   ik-&gt;constants()-&gt;release_C_heap_structures();
2565 
2566   // Deallocate and call destructors for MDO mutexes
2567   ik-&gt;methods_do(method_release_C_heap_structures);
2568 
2569 }
2570 
2571 void InstanceKlass::release_C_heap_structures() {
2572   // Can&#39;t release the constant pool here because the constant pool can be
2573   // deallocated separately from the InstanceKlass for default methods and
2574   // redefine classes.
2575 
2576   // Deallocate oop map cache
2577   if (_oop_map_cache != NULL) {
2578     delete _oop_map_cache;
2579     _oop_map_cache = NULL;
2580   }
2581 
2582   // Deallocate JNI identifiers for jfieldIDs
2583   JNIid::deallocate(jni_ids());
2584   set_jni_ids(NULL);
2585 
2586   jmethodID* jmeths = methods_jmethod_ids_acquire();
2587   if (jmeths != (jmethodID*)NULL) {
2588     release_set_methods_jmethod_ids(NULL);
2589     FreeHeap(jmeths);
2590   }
2591 
2592   assert(_dep_context == NULL,
2593          &quot;dependencies should already be cleaned&quot;);
2594 
2595 #if INCLUDE_JVMTI
2596   // Deallocate breakpoint records
2597   if (breakpoints() != 0x0) {
2598     methods_do(clear_all_breakpoints);
2599     assert(breakpoints() == 0x0, &quot;should have cleared breakpoints&quot;);
2600   }
2601 
2602   // deallocate the cached class file
2603   if (_cached_class_file != NULL) {
2604     os::free(_cached_class_file);
2605     _cached_class_file = NULL;
2606   }
2607 #endif
2608 
2609   // Decrement symbol reference counts associated with the unloaded class.
2610   if (_name != NULL) _name-&gt;decrement_refcount();
2611   // unreference array name derived from this class name (arrays of an unloaded
2612   // class can&#39;t be referenced anymore).
2613   if (_array_name != NULL)  _array_name-&gt;decrement_refcount();
2614   FREE_C_HEAP_ARRAY(char, _source_debug_extension);
2615 }
2616 
2617 void InstanceKlass::set_source_debug_extension(const char* array, int length) {
2618   if (array == NULL) {
2619     _source_debug_extension = NULL;
2620   } else {
2621     // Adding one to the attribute length in order to store a null terminator
2622     // character could cause an overflow because the attribute length is
2623     // already coded with an u4 in the classfile, but in practice, it&#39;s
2624     // unlikely to happen.
2625     assert((length+1) &gt; length, &quot;Overflow checking&quot;);
2626     char* sde = NEW_C_HEAP_ARRAY(char, (length + 1), mtClass);
2627     for (int i = 0; i &lt; length; i++) {
2628       sde[i] = array[i];
2629     }
2630     sde[length] = &#39;\0&#39;;
2631     _source_debug_extension = sde;
2632   }
2633 }
2634 
2635 const char* InstanceKlass::signature_name() const {
2636   int hash_len = 0;
2637   char hash_buf[40];
2638 
2639   // If this is an unsafe anonymous class, append a hash to make the name unique
2640   if (is_unsafe_anonymous()) {
2641     intptr_t hash = (java_mirror() != NULL) ? java_mirror()-&gt;identity_hash() : 0;
2642     jio_snprintf(hash_buf, sizeof(hash_buf), &quot;/&quot; UINTX_FORMAT, (uintx)hash);
2643     hash_len = (int)strlen(hash_buf);
2644   }
2645 
2646   // Get the internal name as a c string
2647   const char* src = (const char*) (name()-&gt;as_C_string());
2648   const int src_length = (int)strlen(src);
2649 
2650   char* dest = NEW_RESOURCE_ARRAY(char, src_length + hash_len + 3);
2651 
2652   // Add L as type indicator
2653   int dest_index = 0;
2654   dest[dest_index++] = JVM_SIGNATURE_CLASS;
2655 
2656   // Add the actual class name
2657   for (int src_index = 0; src_index &lt; src_length; ) {
2658     dest[dest_index++] = src[src_index++];
2659   }
2660 
2661   // If we have a hash, append it
2662   for (int hash_index = 0; hash_index &lt; hash_len; ) {
2663     dest[dest_index++] = hash_buf[hash_index++];
2664   }
2665 
2666   // Add the semicolon and the NULL
2667   dest[dest_index++] = JVM_SIGNATURE_ENDCLASS;
2668   dest[dest_index] = &#39;\0&#39;;
2669   return dest;
2670 }
2671 
2672 // Used to obtain the package name from a fully qualified class name.
2673 Symbol* InstanceKlass::package_from_name(const Symbol* name, TRAPS) {
2674   if (name == NULL) {
2675     return NULL;
2676   } else {
2677     if (name-&gt;utf8_length() &lt;= 0) {
2678       return NULL;
2679     }
2680     ResourceMark rm(THREAD);
2681     const char* package_name = ClassLoader::package_from_name((const char*) name-&gt;as_C_string());
2682     if (package_name == NULL) {
2683       return NULL;
2684     }
2685     Symbol* pkg_name = SymbolTable::new_symbol(package_name);
2686     return pkg_name;
2687   }
2688 }
2689 
2690 ModuleEntry* InstanceKlass::module() const {
2691   // For an unsafe anonymous class return the host class&#39; module
2692   if (is_unsafe_anonymous()) {
2693     assert(unsafe_anonymous_host() != NULL, &quot;unsafe anonymous class must have a host class&quot;);
2694     return unsafe_anonymous_host()-&gt;module();
2695   }
2696 
2697   // Class is in a named package
2698   if (!in_unnamed_package()) {
2699     return _package_entry-&gt;module();
2700   }
2701 
2702   // Class is in an unnamed package, return its loader&#39;s unnamed module
2703   return class_loader_data()-&gt;unnamed_module();
2704 }
2705 
2706 void InstanceKlass::set_package(ClassLoaderData* loader_data, TRAPS) {
2707 
2708   // ensure java/ packages only loaded by boot or platform builtin loaders
2709   check_prohibited_package(name(), loader_data, CHECK);
2710 
2711   TempNewSymbol pkg_name = package_from_name(name(), CHECK);
2712 
2713   if (pkg_name != NULL &amp;&amp; loader_data != NULL) {
2714 
2715     // Find in class loader&#39;s package entry table.
2716     _package_entry = loader_data-&gt;packages()-&gt;lookup_only(pkg_name);
2717 
2718     // If the package name is not found in the loader&#39;s package
2719     // entry table, it is an indication that the package has not
2720     // been defined. Consider it defined within the unnamed module.
2721     if (_package_entry == NULL) {
2722       ResourceMark rm(THREAD);
2723 
2724       if (!ModuleEntryTable::javabase_defined()) {
2725         // Before java.base is defined during bootstrapping, define all packages in
2726         // the java.base module.  If a non-java.base package is erroneously placed
2727         // in the java.base module it will be caught later when java.base
2728         // is defined by ModuleEntryTable::verify_javabase_packages check.
2729         assert(ModuleEntryTable::javabase_moduleEntry() != NULL, JAVA_BASE_NAME &quot; module is NULL&quot;);
2730         _package_entry = loader_data-&gt;packages()-&gt;lookup(pkg_name, ModuleEntryTable::javabase_moduleEntry());
2731       } else {
2732         assert(loader_data-&gt;unnamed_module() != NULL, &quot;unnamed module is NULL&quot;);
2733         _package_entry = loader_data-&gt;packages()-&gt;lookup(pkg_name,
2734                                                          loader_data-&gt;unnamed_module());
2735       }
2736 
2737       // A package should have been successfully created
2738       assert(_package_entry != NULL, &quot;Package entry for class %s not found, loader %s&quot;,
2739              name()-&gt;as_C_string(), loader_data-&gt;loader_name_and_id());
2740     }
2741 
2742     if (log_is_enabled(Debug, module)) {
2743       ResourceMark rm(THREAD);
2744       ModuleEntry* m = _package_entry-&gt;module();
2745       log_trace(module)(&quot;Setting package: class: %s, package: %s, loader: %s, module: %s&quot;,
2746                         external_name(),
2747                         pkg_name-&gt;as_C_string(),
2748                         loader_data-&gt;loader_name_and_id(),
2749                         (m-&gt;is_named() ? m-&gt;name()-&gt;as_C_string() : UNNAMED_MODULE));
2750     }
2751   } else {
2752     ResourceMark rm(THREAD);
2753     log_trace(module)(&quot;Setting package: class: %s, package: unnamed, loader: %s, module: %s&quot;,
2754                       external_name(),
2755                       (loader_data != NULL) ? loader_data-&gt;loader_name_and_id() : &quot;NULL&quot;,
2756                       UNNAMED_MODULE);
2757   }
2758 }
2759 
2760 
2761 // different versions of is_same_class_package
2762 
2763 bool InstanceKlass::is_same_class_package(const Klass* class2) const {
2764   oop classloader1 = this-&gt;class_loader();
2765   PackageEntry* classpkg1 = this-&gt;package();
2766   if (class2-&gt;is_objArray_klass()) {
2767     class2 = ObjArrayKlass::cast(class2)-&gt;bottom_klass();
2768   }
2769 
2770   oop classloader2;
2771   PackageEntry* classpkg2;
2772   if (class2-&gt;is_instance_klass()) {
2773     classloader2 = class2-&gt;class_loader();
2774     classpkg2 = class2-&gt;package();
2775   } else {
2776     assert(class2-&gt;is_typeArray_klass(), &quot;should be type array&quot;);
2777     classloader2 = NULL;
2778     classpkg2 = NULL;
2779   }
2780 
2781   // Same package is determined by comparing class loader
2782   // and package entries. Both must be the same. This rule
2783   // applies even to classes that are defined in the unnamed
2784   // package, they still must have the same class loader.
2785   if ((classloader1 == classloader2) &amp;&amp; (classpkg1 == classpkg2)) {
2786     return true;
2787   }
2788 
2789   return false;
2790 }
2791 
2792 // return true if this class and other_class are in the same package. Classloader
2793 // and classname information is enough to determine a class&#39;s package
2794 bool InstanceKlass::is_same_class_package(oop other_class_loader,
2795                                           const Symbol* other_class_name) const {
2796   if (class_loader() != other_class_loader) {
2797     return false;
2798   }
2799   if (name()-&gt;fast_compare(other_class_name) == 0) {
2800      return true;
2801   }
2802 
2803   {
2804     ResourceMark rm;
2805 
2806     bool bad_class_name = false;
2807     const char* other_pkg =
2808       ClassLoader::package_from_name((const char*) other_class_name-&gt;as_C_string(), &amp;bad_class_name);
2809     if (bad_class_name) {
2810       return false;
2811     }
2812     // Check that package_from_name() returns NULL, not &quot;&quot;, if there is no package.
2813     assert(other_pkg == NULL || strlen(other_pkg) &gt; 0, &quot;package name is empty string&quot;);
2814 
2815     const Symbol* const this_package_name =
2816       this-&gt;package() != NULL ? this-&gt;package()-&gt;name() : NULL;
2817 
2818     if (this_package_name == NULL || other_pkg == NULL) {
2819       // One of the two doesn&#39;t have a package.  Only return true if the other
2820       // one also doesn&#39;t have a package.
2821       return (const char*)this_package_name == other_pkg;
2822     }
2823 
2824     // Check if package is identical
2825     return this_package_name-&gt;equals(other_pkg);
2826   }
2827 }
2828 
2829 // Returns true iff super_method can be overridden by a method in targetclassname
2830 // See JLS 3rd edition 8.4.6.1
2831 // Assumes name-signature match
2832 // &quot;this&quot; is InstanceKlass of super_method which must exist
2833 // note that the InstanceKlass of the method in the targetclassname has not always been created yet
2834 bool InstanceKlass::is_override(const methodHandle&amp; super_method, Handle targetclassloader, Symbol* targetclassname, TRAPS) {
2835    // Private methods can not be overridden
2836    if (super_method-&gt;is_private()) {
2837      return false;
2838    }
2839    // If super method is accessible, then override
2840    if ((super_method-&gt;is_protected()) ||
2841        (super_method-&gt;is_public())) {
2842      return true;
2843    }
2844    // Package-private methods are not inherited outside of package
2845    assert(super_method-&gt;is_package_private(), &quot;must be package private&quot;);
2846    return(is_same_class_package(targetclassloader(), targetclassname));
2847 }
2848 
2849 // Only boot and platform class loaders can define classes in &quot;java/&quot; packages.
2850 void InstanceKlass::check_prohibited_package(Symbol* class_name,
2851                                              ClassLoaderData* loader_data,
2852                                              TRAPS) {
2853   if (!loader_data-&gt;is_boot_class_loader_data() &amp;&amp;
2854       !loader_data-&gt;is_platform_class_loader_data() &amp;&amp;
2855       class_name != NULL) {
2856     ResourceMark rm(THREAD);
2857     char* name = class_name-&gt;as_C_string();
2858     if (strncmp(name, JAVAPKG, JAVAPKG_LEN) == 0 &amp;&amp; name[JAVAPKG_LEN] == &#39;/&#39;) {
2859       TempNewSymbol pkg_name = InstanceKlass::package_from_name(class_name, CHECK);
2860       assert(pkg_name != NULL, &quot;Error in parsing package name starting with &#39;java/&#39;&quot;);
2861       name = pkg_name-&gt;as_C_string();
2862       const char* class_loader_name = loader_data-&gt;loader_name_and_id();
2863       StringUtils::replace_no_expand(name, &quot;/&quot;, &quot;.&quot;);
2864       const char* msg_text1 = &quot;Class loader (instance of): &quot;;
2865       const char* msg_text2 = &quot; tried to load prohibited package name: &quot;;
2866       size_t len = strlen(msg_text1) + strlen(class_loader_name) + strlen(msg_text2) + strlen(name) + 1;
2867       char* message = NEW_RESOURCE_ARRAY_IN_THREAD(THREAD, char, len);
2868       jio_snprintf(message, len, &quot;%s%s%s%s&quot;, msg_text1, class_loader_name, msg_text2, name);
2869       THROW_MSG(vmSymbols::java_lang_SecurityException(), message);
2870     }
2871   }
2872   return;
2873 }
2874 
2875 bool InstanceKlass::find_inner_classes_attr(int* ooff, int* noff, TRAPS) const {
2876   constantPoolHandle i_cp(THREAD, constants());
2877   for (InnerClassesIterator iter(this); !iter.done(); iter.next()) {
2878     int ioff = iter.inner_class_info_index();
2879     if (ioff != 0) {
2880       // Check to see if the name matches the class we&#39;re looking for
2881       // before attempting to find the class.
2882       if (i_cp-&gt;klass_name_at_matches(this, ioff)) {
2883         Klass* inner_klass = i_cp-&gt;klass_at(ioff, CHECK_false);
2884         if (this == inner_klass) {
2885           *ooff = iter.outer_class_info_index();
2886           *noff = iter.inner_name_index();
2887           return true;
2888         }
2889       }
2890     }
2891   }
2892   return false;
2893 }
2894 
2895 InstanceKlass* InstanceKlass::compute_enclosing_class(bool* inner_is_member, TRAPS) const {
2896   InstanceKlass* outer_klass = NULL;
2897   *inner_is_member = false;
2898   int ooff = 0, noff = 0;
2899   bool has_inner_classes_attr = find_inner_classes_attr(&amp;ooff, &amp;noff, THREAD);
2900   if (has_inner_classes_attr) {
2901     constantPoolHandle i_cp(THREAD, constants());
2902     if (ooff != 0) {
2903       Klass* ok = i_cp-&gt;klass_at(ooff, CHECK_NULL);
2904       outer_klass = InstanceKlass::cast(ok);
2905       *inner_is_member = true;
2906     }
2907     if (NULL == outer_klass) {
2908       // It may be unsafe anonymous; try for that.
2909       int encl_method_class_idx = enclosing_method_class_index();
2910       if (encl_method_class_idx != 0) {
2911         Klass* ok = i_cp-&gt;klass_at(encl_method_class_idx, CHECK_NULL);
2912         outer_klass = InstanceKlass::cast(ok);
2913         *inner_is_member = false;
2914       }
2915     }
2916   }
2917 
2918   // If no inner class attribute found for this class.
2919   if (NULL == outer_klass) return NULL;
2920 
2921   // Throws an exception if outer klass has not declared k as an inner klass
2922   // We need evidence that each klass knows about the other, or else
2923   // the system could allow a spoof of an inner class to gain access rights.
2924   Reflection::check_for_inner_class(outer_klass, this, *inner_is_member, CHECK_NULL);
2925   return outer_klass;
2926 }
2927 
2928 jint InstanceKlass::compute_modifier_flags(TRAPS) const {
2929   jint access = access_flags().as_int();
2930 
2931   // But check if it happens to be member class.
2932   InnerClassesIterator iter(this);
2933   for (; !iter.done(); iter.next()) {
2934     int ioff = iter.inner_class_info_index();
2935     // Inner class attribute can be zero, skip it.
2936     // Strange but true:  JVM spec. allows null inner class refs.
2937     if (ioff == 0) continue;
2938 
2939     // only look at classes that are already loaded
2940     // since we are looking for the flags for our self.
2941     Symbol* inner_name = constants()-&gt;klass_name_at(ioff);
2942     if (name() == inner_name) {
2943       // This is really a member class.
2944       access = iter.inner_access_flags();
2945       break;
2946     }
2947   }
2948   // Remember to strip ACC_SUPER bit
2949   return (access &amp; (~JVM_ACC_SUPER)) &amp; JVM_ACC_WRITTEN_FLAGS;
2950 }
2951 
2952 jint InstanceKlass::jvmti_class_status() const {
2953   jint result = 0;
2954 
2955   if (is_linked()) {
2956     result |= JVMTI_CLASS_STATUS_VERIFIED | JVMTI_CLASS_STATUS_PREPARED;
2957   }
2958 
2959   if (is_initialized()) {
2960     assert(is_linked(), &quot;Class status is not consistent&quot;);
2961     result |= JVMTI_CLASS_STATUS_INITIALIZED;
2962   }
2963   if (is_in_error_state()) {
2964     result |= JVMTI_CLASS_STATUS_ERROR;
2965   }
2966   return result;
2967 }
2968 
2969 Method* InstanceKlass::method_at_itable(Klass* holder, int index, TRAPS) {
2970   itableOffsetEntry* ioe = (itableOffsetEntry*)start_of_itable();
2971   int method_table_offset_in_words = ioe-&gt;offset()/wordSize;
2972   int nof_interfaces = (method_table_offset_in_words - itable_offset_in_words())
2973                        / itableOffsetEntry::size();
2974 
2975   for (int cnt = 0 ; ; cnt ++, ioe ++) {
2976     // If the interface isn&#39;t implemented by the receiver class,
2977     // the VM should throw IncompatibleClassChangeError.
2978     if (cnt &gt;= nof_interfaces) {
2979       ResourceMark rm(THREAD);
2980       stringStream ss;
2981       bool same_module = (module() == holder-&gt;module());
2982       ss.print(&quot;Receiver class %s does not implement &quot;
2983                &quot;the interface %s defining the method to be called &quot;
2984                &quot;(%s%s%s)&quot;,
2985                external_name(), holder-&gt;external_name(),
2986                (same_module) ? joint_in_module_of_loader(holder) : class_in_module_of_loader(),
2987                (same_module) ? &quot;&quot; : &quot;; &quot;,
2988                (same_module) ? &quot;&quot; : holder-&gt;class_in_module_of_loader());
2989       THROW_MSG_NULL(vmSymbols::java_lang_IncompatibleClassChangeError(), ss.as_string());
2990     }
2991 
2992     Klass* ik = ioe-&gt;interface_klass();
2993     if (ik == holder) break;
2994   }
2995 
2996   itableMethodEntry* ime = ioe-&gt;first_method_entry(this);
2997   Method* m = ime[index].method();
2998   if (m == NULL) {
2999     THROW_NULL(vmSymbols::java_lang_AbstractMethodError());
3000   }
3001   return m;
3002 }
3003 
3004 
3005 #if INCLUDE_JVMTI
3006 // update default_methods for redefineclasses for methods that are
3007 // not yet in the vtable due to concurrent subclass define and superinterface
3008 // redefinition
3009 // Note: those in the vtable, should have been updated via adjust_method_entries
3010 void InstanceKlass::adjust_default_methods(bool* trace_name_printed) {
3011   // search the default_methods for uses of either obsolete or EMCP methods
3012   if (default_methods() != NULL) {
3013     for (int index = 0; index &lt; default_methods()-&gt;length(); index ++) {
3014       Method* old_method = default_methods()-&gt;at(index);
3015       if (old_method == NULL || !old_method-&gt;is_old()) {
3016         continue; // skip uninteresting entries
3017       }
3018       assert(!old_method-&gt;is_deleted(), &quot;default methods may not be deleted&quot;);
3019       Method* new_method = old_method-&gt;get_new_method();
3020       default_methods()-&gt;at_put(index, new_method);
3021 
3022       if (log_is_enabled(Info, redefine, class, update)) {
3023         ResourceMark rm;
3024         if (!(*trace_name_printed)) {
3025           log_info(redefine, class, update)
3026             (&quot;adjust: klassname=%s default methods from name=%s&quot;,
3027              external_name(), old_method-&gt;method_holder()-&gt;external_name());
3028           *trace_name_printed = true;
3029         }
3030         log_debug(redefine, class, update, vtables)
3031           (&quot;default method update: %s(%s) &quot;,
3032            new_method-&gt;name()-&gt;as_C_string(), new_method-&gt;signature()-&gt;as_C_string());
3033       }
3034     }
3035   }
3036 }
3037 #endif // INCLUDE_JVMTI
3038 
3039 // On-stack replacement stuff
3040 void InstanceKlass::add_osr_nmethod(nmethod* n) {
3041   assert_lock_strong(CompiledMethod_lock);
3042 #ifndef PRODUCT
3043   if (TieredCompilation) {
3044       nmethod * prev = lookup_osr_nmethod(n-&gt;method(), n-&gt;osr_entry_bci(), n-&gt;comp_level(), true);
3045       assert(prev == NULL || !prev-&gt;is_in_use(),
3046       &quot;redundunt OSR recompilation detected. memory leak in CodeCache!&quot;);
3047   }
3048 #endif
3049   // only one compilation can be active
3050   {
3051     assert(n-&gt;is_osr_method(), &quot;wrong kind of nmethod&quot;);
3052     n-&gt;set_osr_link(osr_nmethods_head());
3053     set_osr_nmethods_head(n);
3054     // Raise the highest osr level if necessary
3055     if (TieredCompilation) {
3056       Method* m = n-&gt;method();
3057       m-&gt;set_highest_osr_comp_level(MAX2(m-&gt;highest_osr_comp_level(), n-&gt;comp_level()));
3058     }
3059   }
3060 
3061   // Get rid of the osr methods for the same bci that have lower levels.
3062   if (TieredCompilation) {
3063     for (int l = CompLevel_limited_profile; l &lt; n-&gt;comp_level(); l++) {
3064       nmethod *inv = lookup_osr_nmethod(n-&gt;method(), n-&gt;osr_entry_bci(), l, true);
3065       if (inv != NULL &amp;&amp; inv-&gt;is_in_use()) {
3066         inv-&gt;make_not_entrant();
3067       }
3068     }
3069   }
3070 }
3071 
3072 // Remove osr nmethod from the list. Return true if found and removed.
3073 bool InstanceKlass::remove_osr_nmethod(nmethod* n) {
3074   // This is a short non-blocking critical region, so the no safepoint check is ok.
3075   MutexLocker ml(CompiledMethod_lock-&gt;owned_by_self() ? NULL : CompiledMethod_lock
3076                  , Mutex::_no_safepoint_check_flag);
3077   assert(n-&gt;is_osr_method(), &quot;wrong kind of nmethod&quot;);
3078   nmethod* last = NULL;
3079   nmethod* cur  = osr_nmethods_head();
3080   int max_level = CompLevel_none;  // Find the max comp level excluding n
3081   Method* m = n-&gt;method();
3082   // Search for match
3083   bool found = false;
3084   while(cur != NULL &amp;&amp; cur != n) {
3085     if (TieredCompilation &amp;&amp; m == cur-&gt;method()) {
3086       // Find max level before n
3087       max_level = MAX2(max_level, cur-&gt;comp_level());
3088     }
3089     last = cur;
3090     cur = cur-&gt;osr_link();
3091   }
3092   nmethod* next = NULL;
3093   if (cur == n) {
3094     found = true;
3095     next = cur-&gt;osr_link();
3096     if (last == NULL) {
3097       // Remove first element
3098       set_osr_nmethods_head(next);
3099     } else {
3100       last-&gt;set_osr_link(next);
3101     }
3102   }
3103   n-&gt;set_osr_link(NULL);
3104   if (TieredCompilation) {
3105     cur = next;
3106     while (cur != NULL) {
3107       // Find max level after n
3108       if (m == cur-&gt;method()) {
3109         max_level = MAX2(max_level, cur-&gt;comp_level());
3110       }
3111       cur = cur-&gt;osr_link();
3112     }
3113     m-&gt;set_highest_osr_comp_level(max_level);
3114   }
3115   return found;
3116 }
3117 
3118 int InstanceKlass::mark_osr_nmethods(const Method* m) {
3119   MutexLocker ml(CompiledMethod_lock-&gt;owned_by_self() ? NULL : CompiledMethod_lock,
3120                  Mutex::_no_safepoint_check_flag);
3121   nmethod* osr = osr_nmethods_head();
3122   int found = 0;
3123   while (osr != NULL) {
3124     assert(osr-&gt;is_osr_method(), &quot;wrong kind of nmethod found in chain&quot;);
3125     if (osr-&gt;method() == m) {
3126       osr-&gt;mark_for_deoptimization();
3127       found++;
3128     }
3129     osr = osr-&gt;osr_link();
3130   }
3131   return found;
3132 }
3133 
3134 nmethod* InstanceKlass::lookup_osr_nmethod(const Method* m, int bci, int comp_level, bool match_level) const {
3135   MutexLocker ml(CompiledMethod_lock-&gt;owned_by_self() ? NULL : CompiledMethod_lock,
3136                  Mutex::_no_safepoint_check_flag);
3137   nmethod* osr = osr_nmethods_head();
3138   nmethod* best = NULL;
3139   while (osr != NULL) {
3140     assert(osr-&gt;is_osr_method(), &quot;wrong kind of nmethod found in chain&quot;);
3141     // There can be a time when a c1 osr method exists but we are waiting
3142     // for a c2 version. When c2 completes its osr nmethod we will trash
3143     // the c1 version and only be able to find the c2 version. However
3144     // while we overflow in the c1 code at back branches we don&#39;t want to
3145     // try and switch to the same code as we are already running
3146 
3147     if (osr-&gt;method() == m &amp;&amp;
3148         (bci == InvocationEntryBci || osr-&gt;osr_entry_bci() == bci)) {
3149       if (match_level) {
3150         if (osr-&gt;comp_level() == comp_level) {
3151           // Found a match - return it.
3152           return osr;
3153         }
3154       } else {
3155         if (best == NULL || (osr-&gt;comp_level() &gt; best-&gt;comp_level())) {
3156           if (osr-&gt;comp_level() == CompLevel_highest_tier) {
3157             // Found the best possible - return it.
3158             return osr;
3159           }
3160           best = osr;
3161         }
3162       }
3163     }
3164     osr = osr-&gt;osr_link();
3165   }
3166 
3167   assert(match_level == false || best == NULL, &quot;shouldn&#39;t pick up anything if match_level is set&quot;);
3168   if (best != NULL &amp;&amp; best-&gt;comp_level() &gt;= comp_level) {
3169     return best;
3170   }
3171   return NULL;
3172 }
3173 
3174 // -----------------------------------------------------------------------------------------------------
3175 // Printing
3176 
3177 #ifndef PRODUCT
3178 
3179 #define BULLET  &quot; - &quot;
3180 
3181 static const char* state_names[] = {
3182   &quot;allocated&quot;, &quot;loaded&quot;, &quot;linked&quot;, &quot;being_initialized&quot;, &quot;fully_initialized&quot;, &quot;initialization_error&quot;
3183 };
3184 
3185 static void print_vtable(intptr_t* start, int len, outputStream* st) {
3186   for (int i = 0; i &lt; len; i++) {
3187     intptr_t e = start[i];
3188     st-&gt;print(&quot;%d : &quot; INTPTR_FORMAT, i, e);
3189     if (MetaspaceObj::is_valid((Metadata*)e)) {
3190       st-&gt;print(&quot; &quot;);
3191       ((Metadata*)e)-&gt;print_value_on(st);
3192     }
3193     st-&gt;cr();
3194   }
3195 }
3196 
3197 static void print_vtable(vtableEntry* start, int len, outputStream* st) {
3198   return print_vtable(reinterpret_cast&lt;intptr_t*&gt;(start), len, st);
3199 }
3200 
3201 void InstanceKlass::print_on(outputStream* st) const {
3202   assert(is_klass(), &quot;must be klass&quot;);
3203   Klass::print_on(st);
3204 
3205   st-&gt;print(BULLET&quot;instance size:     %d&quot;, size_helper());                        st-&gt;cr();
3206   st-&gt;print(BULLET&quot;klass size:        %d&quot;, size());                               st-&gt;cr();
3207   st-&gt;print(BULLET&quot;access:            &quot;); access_flags().print_on(st);            st-&gt;cr();
3208   st-&gt;print(BULLET&quot;state:             &quot;); st-&gt;print_cr(&quot;%s&quot;, state_names[_init_state]);
3209   st-&gt;print(BULLET&quot;name:              &quot;); name()-&gt;print_value_on(st);             st-&gt;cr();
3210   st-&gt;print(BULLET&quot;super:             &quot;); Metadata::print_value_on_maybe_null(st, super()); st-&gt;cr();
3211   st-&gt;print(BULLET&quot;sub:               &quot;);
3212   Klass* sub = subklass();
3213   int n;
3214   for (n = 0; sub != NULL; n++, sub = sub-&gt;next_sibling()) {
3215     if (n &lt; MaxSubklassPrintSize) {
3216       sub-&gt;print_value_on(st);
3217       st-&gt;print(&quot;   &quot;);
3218     }
3219   }
3220   if (n &gt;= MaxSubklassPrintSize) st-&gt;print(&quot;(&quot; INTX_FORMAT &quot; more klasses...)&quot;, n - MaxSubklassPrintSize);
3221   st-&gt;cr();
3222 
3223   if (is_interface()) {
3224     st-&gt;print_cr(BULLET&quot;nof implementors:  %d&quot;, nof_implementors());
3225     if (nof_implementors() == 1) {
3226       st-&gt;print_cr(BULLET&quot;implementor:    &quot;);
3227       st-&gt;print(&quot;   &quot;);
3228       implementor()-&gt;print_value_on(st);
3229       st-&gt;cr();
3230     }
3231   }
3232 
3233   st-&gt;print(BULLET&quot;arrays:            &quot;); Metadata::print_value_on_maybe_null(st, array_klasses()); st-&gt;cr();
3234   st-&gt;print(BULLET&quot;methods:           &quot;); methods()-&gt;print_value_on(st);                  st-&gt;cr();
3235   if (Verbose || WizardMode) {
3236     Array&lt;Method*&gt;* method_array = methods();
3237     for (int i = 0; i &lt; method_array-&gt;length(); i++) {
3238       st-&gt;print(&quot;%d : &quot;, i); method_array-&gt;at(i)-&gt;print_value(); st-&gt;cr();
3239     }
3240   }
3241   st-&gt;print(BULLET&quot;method ordering:   &quot;); method_ordering()-&gt;print_value_on(st);      st-&gt;cr();
3242   st-&gt;print(BULLET&quot;default_methods:   &quot;); default_methods()-&gt;print_value_on(st);      st-&gt;cr();
3243   if (Verbose &amp;&amp; default_methods() != NULL) {
3244     Array&lt;Method*&gt;* method_array = default_methods();
3245     for (int i = 0; i &lt; method_array-&gt;length(); i++) {
3246       st-&gt;print(&quot;%d : &quot;, i); method_array-&gt;at(i)-&gt;print_value(); st-&gt;cr();
3247     }
3248   }
3249   if (default_vtable_indices() != NULL) {
3250     st-&gt;print(BULLET&quot;default vtable indices:   &quot;); default_vtable_indices()-&gt;print_value_on(st);       st-&gt;cr();
3251   }
3252   st-&gt;print(BULLET&quot;local interfaces:  &quot;); local_interfaces()-&gt;print_value_on(st);      st-&gt;cr();
3253   st-&gt;print(BULLET&quot;trans. interfaces: &quot;); transitive_interfaces()-&gt;print_value_on(st); st-&gt;cr();
3254   st-&gt;print(BULLET&quot;constants:         &quot;); constants()-&gt;print_value_on(st);         st-&gt;cr();
3255   if (class_loader_data() != NULL) {
3256     st-&gt;print(BULLET&quot;class loader data:  &quot;);
3257     class_loader_data()-&gt;print_value_on(st);
3258     st-&gt;cr();
3259   }
3260   st-&gt;print(BULLET&quot;unsafe anonymous host class:        &quot;); Metadata::print_value_on_maybe_null(st, unsafe_anonymous_host()); st-&gt;cr();
3261   if (source_file_name() != NULL) {
3262     st-&gt;print(BULLET&quot;source file:       &quot;);
3263     source_file_name()-&gt;print_value_on(st);
3264     st-&gt;cr();
3265   }
3266   if (source_debug_extension() != NULL) {
3267     st-&gt;print(BULLET&quot;source debug extension:       &quot;);
3268     st-&gt;print(&quot;%s&quot;, source_debug_extension());
3269     st-&gt;cr();
3270   }
3271   st-&gt;print(BULLET&quot;class annotations:       &quot;); class_annotations()-&gt;print_value_on(st); st-&gt;cr();
3272   st-&gt;print(BULLET&quot;class type annotations:  &quot;); class_type_annotations()-&gt;print_value_on(st); st-&gt;cr();
3273   st-&gt;print(BULLET&quot;field annotations:       &quot;); fields_annotations()-&gt;print_value_on(st); st-&gt;cr();
3274   st-&gt;print(BULLET&quot;field type annotations:  &quot;); fields_type_annotations()-&gt;print_value_on(st); st-&gt;cr();
3275   {
3276     bool have_pv = false;
3277     // previous versions are linked together through the InstanceKlass
3278     for (InstanceKlass* pv_node = previous_versions();
3279          pv_node != NULL;
3280          pv_node = pv_node-&gt;previous_versions()) {
3281       if (!have_pv)
3282         st-&gt;print(BULLET&quot;previous version:  &quot;);
3283       have_pv = true;
3284       pv_node-&gt;constants()-&gt;print_value_on(st);
3285     }
3286     if (have_pv) st-&gt;cr();
3287   }
3288 
3289   if (generic_signature() != NULL) {
3290     st-&gt;print(BULLET&quot;generic signature: &quot;);
3291     generic_signature()-&gt;print_value_on(st);
3292     st-&gt;cr();
3293   }
3294   st-&gt;print(BULLET&quot;inner classes:     &quot;); inner_classes()-&gt;print_value_on(st);     st-&gt;cr();
3295   st-&gt;print(BULLET&quot;nest members:     &quot;); nest_members()-&gt;print_value_on(st);     st-&gt;cr();
3296   if (record_components() != NULL) {
3297     st-&gt;print(BULLET&quot;record components:     &quot;); record_components()-&gt;print_value_on(st);     st-&gt;cr();
3298   }
3299   if (java_mirror() != NULL) {
3300     st-&gt;print(BULLET&quot;java mirror:       &quot;);
3301     java_mirror()-&gt;print_value_on(st);
3302     st-&gt;cr();
3303   } else {
3304     st-&gt;print_cr(BULLET&quot;java mirror:       NULL&quot;);
3305   }
3306   st-&gt;print(BULLET&quot;vtable length      %d  (start addr: &quot; INTPTR_FORMAT &quot;)&quot;, vtable_length(), p2i(start_of_vtable())); st-&gt;cr();
3307   if (vtable_length() &gt; 0 &amp;&amp; (Verbose || WizardMode))  print_vtable(start_of_vtable(), vtable_length(), st);
3308   st-&gt;print(BULLET&quot;itable length      %d (start addr: &quot; INTPTR_FORMAT &quot;)&quot;, itable_length(), p2i(start_of_itable())); st-&gt;cr();
3309   if (itable_length() &gt; 0 &amp;&amp; (Verbose || WizardMode))  print_vtable(start_of_itable(), itable_length(), st);
3310   st-&gt;print_cr(BULLET&quot;---- static fields (%d words):&quot;, static_field_size());
3311   FieldPrinter print_static_field(st);
3312   ((InstanceKlass*)this)-&gt;do_local_static_fields(&amp;print_static_field);
3313   st-&gt;print_cr(BULLET&quot;---- non-static fields (%d words):&quot;, nonstatic_field_size());
3314   FieldPrinter print_nonstatic_field(st);
3315   InstanceKlass* ik = const_cast&lt;InstanceKlass*&gt;(this);
3316   ik-&gt;do_nonstatic_fields(&amp;print_nonstatic_field);
3317 
3318   st-&gt;print(BULLET&quot;non-static oop maps: &quot;);
3319   OopMapBlock* map     = start_of_nonstatic_oop_maps();
3320   OopMapBlock* end_map = map + nonstatic_oop_map_count();
3321   while (map &lt; end_map) {
3322     st-&gt;print(&quot;%d-%d &quot;, map-&gt;offset(), map-&gt;offset() + heapOopSize*(map-&gt;count() - 1));
3323     map++;
3324   }
3325   st-&gt;cr();
3326 }
3327 
3328 #endif //PRODUCT
3329 
3330 void InstanceKlass::print_value_on(outputStream* st) const {
3331   assert(is_klass(), &quot;must be klass&quot;);
3332   if (Verbose || WizardMode)  access_flags().print_on(st);
3333   name()-&gt;print_value_on(st);
3334 }
3335 
3336 #ifndef PRODUCT
3337 
3338 void FieldPrinter::do_field(fieldDescriptor* fd) {
3339   _st-&gt;print(BULLET);
3340    if (_obj == NULL) {
3341      fd-&gt;print_on(_st);
3342      _st-&gt;cr();
3343    } else {
3344      fd-&gt;print_on_for(_st, _obj);
3345      _st-&gt;cr();
3346    }
3347 }
3348 
3349 
3350 void InstanceKlass::oop_print_on(oop obj, outputStream* st) {
3351   Klass::oop_print_on(obj, st);
3352 
3353   if (this == SystemDictionary::String_klass()) {
3354     typeArrayOop value  = java_lang_String::value(obj);
3355     juint        length = java_lang_String::length(obj);
3356     if (value != NULL &amp;&amp;
3357         value-&gt;is_typeArray() &amp;&amp;
3358         length &lt;= (juint) value-&gt;length()) {
3359       st-&gt;print(BULLET&quot;string: &quot;);
3360       java_lang_String::print(obj, st);
3361       st-&gt;cr();
3362       if (!WizardMode)  return;  // that is enough
3363     }
3364   }
3365 
3366   st-&gt;print_cr(BULLET&quot;---- fields (total size %d words):&quot;, oop_size(obj));
3367   FieldPrinter print_field(st, obj);
3368   do_nonstatic_fields(&amp;print_field);
3369 
3370   if (this == SystemDictionary::Class_klass()) {
3371     st-&gt;print(BULLET&quot;signature: &quot;);
3372     java_lang_Class::print_signature(obj, st);
3373     st-&gt;cr();
3374     Klass* mirrored_klass = java_lang_Class::as_Klass(obj);
3375     st-&gt;print(BULLET&quot;fake entry for mirror: &quot;);
3376     Metadata::print_value_on_maybe_null(st, mirrored_klass);
3377     st-&gt;cr();
3378     Klass* array_klass = java_lang_Class::array_klass_acquire(obj);
3379     st-&gt;print(BULLET&quot;fake entry for array: &quot;);
3380     Metadata::print_value_on_maybe_null(st, array_klass);
3381     st-&gt;cr();
3382     st-&gt;print_cr(BULLET&quot;fake entry for oop_size: %d&quot;, java_lang_Class::oop_size(obj));
3383     st-&gt;print_cr(BULLET&quot;fake entry for static_oop_field_count: %d&quot;, java_lang_Class::static_oop_field_count(obj));
3384     Klass* real_klass = java_lang_Class::as_Klass(obj);
3385     if (real_klass != NULL &amp;&amp; real_klass-&gt;is_instance_klass()) {
3386       InstanceKlass::cast(real_klass)-&gt;do_local_static_fields(&amp;print_field);
3387     }
3388   } else if (this == SystemDictionary::MethodType_klass()) {
3389     st-&gt;print(BULLET&quot;signature: &quot;);
3390     java_lang_invoke_MethodType::print_signature(obj, st);
3391     st-&gt;cr();
3392   }
3393 }
3394 
3395 bool InstanceKlass::verify_itable_index(int i) {
3396   int method_count = klassItable::method_count_for_interface(this);
3397   assert(i &gt;= 0 &amp;&amp; i &lt; method_count, &quot;index out of bounds&quot;);
3398   return true;
3399 }
3400 
3401 #endif //PRODUCT
3402 
3403 void InstanceKlass::oop_print_value_on(oop obj, outputStream* st) {
3404   st-&gt;print(&quot;a &quot;);
3405   name()-&gt;print_value_on(st);
3406   obj-&gt;print_address_on(st);
3407   if (this == SystemDictionary::String_klass()
3408       &amp;&amp; java_lang_String::value(obj) != NULL) {
3409     ResourceMark rm;
3410     int len = java_lang_String::length(obj);
3411     int plen = (len &lt; 24 ? len : 12);
3412     char* str = java_lang_String::as_utf8_string(obj, 0, plen);
3413     st-&gt;print(&quot; = \&quot;%s\&quot;&quot;, str);
3414     if (len &gt; plen)
3415       st-&gt;print(&quot;...[%d]&quot;, len);
3416   } else if (this == SystemDictionary::Class_klass()) {
3417     Klass* k = java_lang_Class::as_Klass(obj);
3418     st-&gt;print(&quot; = &quot;);
3419     if (k != NULL) {
3420       k-&gt;print_value_on(st);
3421     } else {
3422       const char* tname = type2name(java_lang_Class::primitive_type(obj));
3423       st-&gt;print(&quot;%s&quot;, tname ? tname : &quot;type?&quot;);
3424     }
3425   } else if (this == SystemDictionary::MethodType_klass()) {
3426     st-&gt;print(&quot; = &quot;);
3427     java_lang_invoke_MethodType::print_signature(obj, st);
3428   } else if (java_lang_boxing_object::is_instance(obj)) {
3429     st-&gt;print(&quot; = &quot;);
3430     java_lang_boxing_object::print(obj, st);
3431   } else if (this == SystemDictionary::LambdaForm_klass()) {
3432     oop vmentry = java_lang_invoke_LambdaForm::vmentry(obj);
3433     if (vmentry != NULL) {
3434       st-&gt;print(&quot; =&gt; &quot;);
3435       vmentry-&gt;print_value_on(st);
3436     }
3437   } else if (this == SystemDictionary::MemberName_klass()) {
3438     Metadata* vmtarget = java_lang_invoke_MemberName::vmtarget(obj);
3439     if (vmtarget != NULL) {
3440       st-&gt;print(&quot; = &quot;);
3441       vmtarget-&gt;print_value_on(st);
3442     } else {
3443       java_lang_invoke_MemberName::clazz(obj)-&gt;print_value_on(st);
3444       st-&gt;print(&quot;.&quot;);
3445       java_lang_invoke_MemberName::name(obj)-&gt;print_value_on(st);
3446     }
3447   }
3448 }
3449 
3450 const char* InstanceKlass::internal_name() const {
3451   return external_name();
3452 }
3453 
3454 void InstanceKlass::print_class_load_logging(ClassLoaderData* loader_data,
3455                                              const char* module_name,
3456                                              const ClassFileStream* cfs) const {
3457   if (!log_is_enabled(Info, class, load)) {
3458     return;
3459   }
3460 
3461   ResourceMark rm;
3462   LogMessage(class, load) msg;
3463   stringStream info_stream;
3464 
3465   // Name and class hierarchy info
3466   info_stream.print(&quot;%s&quot;, external_name());
3467 
3468   // Source
3469   if (cfs != NULL) {
3470     if (cfs-&gt;source() != NULL) {
3471       if (module_name != NULL) {
3472         // When the boot loader created the stream, it didn&#39;t know the module name
3473         // yet. Let&#39;s format it now.
3474         if (cfs-&gt;from_boot_loader_modules_image()) {
3475           info_stream.print(&quot; source: jrt:/%s&quot;, module_name);
3476         } else {
3477           info_stream.print(&quot; source: %s&quot;, cfs-&gt;source());
3478         }
3479       } else {
3480         info_stream.print(&quot; source: %s&quot;, cfs-&gt;source());
3481       }
3482     } else if (loader_data == ClassLoaderData::the_null_class_loader_data()) {
3483       Thread* THREAD = Thread::current();
3484       Klass* caller =
3485             THREAD-&gt;is_Java_thread()
3486                 ? ((JavaThread*)THREAD)-&gt;security_get_caller_class(1)
3487                 : NULL;
3488       // caller can be NULL, for example, during a JVMTI VM_Init hook
3489       if (caller != NULL) {
3490         info_stream.print(&quot; source: instance of %s&quot;, caller-&gt;external_name());
3491       } else {
3492         // source is unknown
3493       }
3494     } else {
3495       oop class_loader = loader_data-&gt;class_loader();
3496       info_stream.print(&quot; source: %s&quot;, class_loader-&gt;klass()-&gt;external_name());
3497     }
3498   } else {
3499     assert(this-&gt;is_shared(), &quot;must be&quot;);
3500     if (MetaspaceShared::is_shared_dynamic((void*)this)) {
3501       info_stream.print(&quot; source: shared objects file (top)&quot;);
3502     } else {
3503       info_stream.print(&quot; source: shared objects file&quot;);
3504     }
3505   }
3506 
3507   msg.info(&quot;%s&quot;, info_stream.as_string());
3508 
3509   if (log_is_enabled(Debug, class, load)) {
3510     stringStream debug_stream;
3511 
3512     // Class hierarchy info
3513     debug_stream.print(&quot; klass: &quot; INTPTR_FORMAT &quot; super: &quot; INTPTR_FORMAT,
3514                        p2i(this),  p2i(superklass()));
3515 
3516     // Interfaces
3517     if (local_interfaces() != NULL &amp;&amp; local_interfaces()-&gt;length() &gt; 0) {
3518       debug_stream.print(&quot; interfaces:&quot;);
3519       int length = local_interfaces()-&gt;length();
3520       for (int i = 0; i &lt; length; i++) {
3521         debug_stream.print(&quot; &quot; INTPTR_FORMAT,
3522                            p2i(InstanceKlass::cast(local_interfaces()-&gt;at(i))));
3523       }
3524     }
3525 
3526     // Class loader
3527     debug_stream.print(&quot; loader: [&quot;);
3528     loader_data-&gt;print_value_on(&amp;debug_stream);
3529     debug_stream.print(&quot;]&quot;);
3530 
3531     // Classfile checksum
3532     if (cfs) {
3533       debug_stream.print(&quot; bytes: %d checksum: %08x&quot;,
3534                          cfs-&gt;length(),
3535                          ClassLoader::crc32(0, (const char*)cfs-&gt;buffer(),
3536                          cfs-&gt;length()));
3537     }
3538 
3539     msg.debug(&quot;%s&quot;, debug_stream.as_string());
3540   }
3541 }
3542 
3543 // Verification
3544 
3545 class VerifyFieldClosure: public BasicOopIterateClosure {
3546  protected:
3547   template &lt;class T&gt; void do_oop_work(T* p) {
3548     oop obj = RawAccess&lt;&gt;::oop_load(p);
3549     if (!oopDesc::is_oop_or_null(obj)) {
3550       tty-&gt;print_cr(&quot;Failed: &quot; PTR_FORMAT &quot; -&gt; &quot; PTR_FORMAT, p2i(p), p2i(obj));
3551       Universe::print_on(tty);
3552       guarantee(false, &quot;boom&quot;);
3553     }
3554   }
3555  public:
3556   virtual void do_oop(oop* p)       { VerifyFieldClosure::do_oop_work(p); }
3557   virtual void do_oop(narrowOop* p) { VerifyFieldClosure::do_oop_work(p); }
3558 };
3559 
3560 void InstanceKlass::verify_on(outputStream* st) {
3561 #ifndef PRODUCT
3562   // Avoid redundant verifies, this really should be in product.
3563   if (_verify_count == Universe::verify_count()) return;
3564   _verify_count = Universe::verify_count();
3565 #endif
3566 
3567   // Verify Klass
3568   Klass::verify_on(st);
3569 
3570   // Verify that klass is present in ClassLoaderData
3571   guarantee(class_loader_data()-&gt;contains_klass(this),
3572             &quot;this class isn&#39;t found in class loader data&quot;);
3573 
3574   // Verify vtables
3575   if (is_linked()) {
3576     // $$$ This used to be done only for m/s collections.  Doing it
3577     // always seemed a valid generalization.  (DLD -- 6/00)
3578     vtable().verify(st);
3579   }
3580 
3581   // Verify first subklass
3582   if (subklass() != NULL) {
3583     guarantee(subklass()-&gt;is_klass(), &quot;should be klass&quot;);
3584   }
3585 
3586   // Verify siblings
3587   Klass* super = this-&gt;super();
3588   Klass* sib = next_sibling();
3589   if (sib != NULL) {
3590     if (sib == this) {
3591       fatal(&quot;subclass points to itself &quot; PTR_FORMAT, p2i(sib));
3592     }
3593 
3594     guarantee(sib-&gt;is_klass(), &quot;should be klass&quot;);
3595     guarantee(sib-&gt;super() == super, &quot;siblings should have same superklass&quot;);
3596   }
3597 
3598   // Verify local interfaces
3599   if (local_interfaces()) {
3600     Array&lt;InstanceKlass*&gt;* local_interfaces = this-&gt;local_interfaces();
3601     for (int j = 0; j &lt; local_interfaces-&gt;length(); j++) {
3602       InstanceKlass* e = local_interfaces-&gt;at(j);
3603       guarantee(e-&gt;is_klass() &amp;&amp; e-&gt;is_interface(), &quot;invalid local interface&quot;);
3604     }
3605   }
3606 
3607   // Verify transitive interfaces
3608   if (transitive_interfaces() != NULL) {
3609     Array&lt;InstanceKlass*&gt;* transitive_interfaces = this-&gt;transitive_interfaces();
3610     for (int j = 0; j &lt; transitive_interfaces-&gt;length(); j++) {
3611       InstanceKlass* e = transitive_interfaces-&gt;at(j);
3612       guarantee(e-&gt;is_klass() &amp;&amp; e-&gt;is_interface(), &quot;invalid transitive interface&quot;);
3613     }
3614   }
3615 
3616   // Verify methods
3617   if (methods() != NULL) {
3618     Array&lt;Method*&gt;* methods = this-&gt;methods();
3619     for (int j = 0; j &lt; methods-&gt;length(); j++) {
3620       guarantee(methods-&gt;at(j)-&gt;is_method(), &quot;non-method in methods array&quot;);
3621     }
3622     for (int j = 0; j &lt; methods-&gt;length() - 1; j++) {
3623       Method* m1 = methods-&gt;at(j);
3624       Method* m2 = methods-&gt;at(j + 1);
3625       guarantee(m1-&gt;name()-&gt;fast_compare(m2-&gt;name()) &lt;= 0, &quot;methods not sorted correctly&quot;);
3626     }
3627   }
3628 
3629   // Verify method ordering
3630   if (method_ordering() != NULL) {
3631     Array&lt;int&gt;* method_ordering = this-&gt;method_ordering();
3632     int length = method_ordering-&gt;length();
3633     if (JvmtiExport::can_maintain_original_method_order() ||
3634         ((UseSharedSpaces || Arguments::is_dumping_archive()) &amp;&amp; length != 0)) {
3635       guarantee(length == methods()-&gt;length(), &quot;invalid method ordering length&quot;);
3636       jlong sum = 0;
3637       for (int j = 0; j &lt; length; j++) {
3638         int original_index = method_ordering-&gt;at(j);
3639         guarantee(original_index &gt;= 0, &quot;invalid method ordering index&quot;);
3640         guarantee(original_index &lt; length, &quot;invalid method ordering index&quot;);
3641         sum += original_index;
3642       }
3643       // Verify sum of indices 0,1,...,length-1
3644       guarantee(sum == ((jlong)length*(length-1))/2, &quot;invalid method ordering sum&quot;);
3645     } else {
3646       guarantee(length == 0, &quot;invalid method ordering length&quot;);
3647     }
3648   }
3649 
3650   // Verify default methods
3651   if (default_methods() != NULL) {
3652     Array&lt;Method*&gt;* methods = this-&gt;default_methods();
3653     for (int j = 0; j &lt; methods-&gt;length(); j++) {
3654       guarantee(methods-&gt;at(j)-&gt;is_method(), &quot;non-method in methods array&quot;);
3655     }
3656     for (int j = 0; j &lt; methods-&gt;length() - 1; j++) {
3657       Method* m1 = methods-&gt;at(j);
3658       Method* m2 = methods-&gt;at(j + 1);
3659       guarantee(m1-&gt;name()-&gt;fast_compare(m2-&gt;name()) &lt;= 0, &quot;methods not sorted correctly&quot;);
3660     }
3661   }
3662 
3663   // Verify JNI static field identifiers
3664   if (jni_ids() != NULL) {
3665     jni_ids()-&gt;verify(this);
3666   }
3667 
3668   // Verify other fields
3669   if (array_klasses() != NULL) {
3670     guarantee(array_klasses()-&gt;is_klass(), &quot;should be klass&quot;);
3671   }
3672   if (constants() != NULL) {
3673     guarantee(constants()-&gt;is_constantPool(), &quot;should be constant pool&quot;);
3674   }
3675   const Klass* anonymous_host = unsafe_anonymous_host();
3676   if (anonymous_host != NULL) {
3677     guarantee(anonymous_host-&gt;is_klass(), &quot;should be klass&quot;);
3678   }
3679 }
3680 
3681 void InstanceKlass::oop_verify_on(oop obj, outputStream* st) {
3682   Klass::oop_verify_on(obj, st);
3683   VerifyFieldClosure blk;
3684   obj-&gt;oop_iterate(&amp;blk);
3685 }
3686 
3687 
3688 // JNIid class for jfieldIDs only
3689 // Note to reviewers:
3690 // These JNI functions are just moved over to column 1 and not changed
3691 // in the compressed oops workspace.
3692 JNIid::JNIid(Klass* holder, int offset, JNIid* next) {
3693   _holder = holder;
3694   _offset = offset;
3695   _next = next;
3696   debug_only(_is_static_field_id = false;)
3697 }
3698 
3699 
3700 JNIid* JNIid::find(int offset) {
3701   JNIid* current = this;
3702   while (current != NULL) {
3703     if (current-&gt;offset() == offset) return current;
3704     current = current-&gt;next();
3705   }
3706   return NULL;
3707 }
3708 
3709 void JNIid::deallocate(JNIid* current) {
3710   while (current != NULL) {
3711     JNIid* next = current-&gt;next();
3712     delete current;
3713     current = next;
3714   }
3715 }
3716 
3717 
3718 void JNIid::verify(Klass* holder) {
3719   int first_field_offset  = InstanceMirrorKlass::offset_of_static_fields();
3720   int end_field_offset;
3721   end_field_offset = first_field_offset + (InstanceKlass::cast(holder)-&gt;static_field_size() * wordSize);
3722 
3723   JNIid* current = this;
3724   while (current != NULL) {
3725     guarantee(current-&gt;holder() == holder, &quot;Invalid klass in JNIid&quot;);
3726 #ifdef ASSERT
3727     int o = current-&gt;offset();
3728     if (current-&gt;is_static_field_id()) {
3729       guarantee(o &gt;= first_field_offset  &amp;&amp; o &lt; end_field_offset,  &quot;Invalid static field offset in JNIid&quot;);
3730     }
3731 #endif
3732     current = current-&gt;next();
3733   }
3734 }
3735 
3736 void InstanceKlass::set_init_state(ClassState state) {
3737 #ifdef ASSERT
3738   bool good_state = is_shared() ? (_init_state &lt;= state)
3739                                                : (_init_state &lt; state);
3740   assert(good_state || state == allocated, &quot;illegal state transition&quot;);
3741 #endif
3742   assert(_init_thread == NULL, &quot;should be cleared before state change&quot;);
3743   _init_state = (u1)state;
3744 }
3745 
3746 #if INCLUDE_JVMTI
3747 
3748 // RedefineClasses() support for previous versions
3749 
3750 // Globally, there is at least one previous version of a class to walk
3751 // during class unloading, which is saved because old methods in the class
3752 // are still running.   Otherwise the previous version list is cleaned up.
3753 bool InstanceKlass::_has_previous_versions = false;
3754 
3755 // Returns true if there are previous versions of a class for class
3756 // unloading only. Also resets the flag to false. purge_previous_version
3757 // will set the flag to true if there are any left, i.e., if there&#39;s any
3758 // work to do for next time. This is to avoid the expensive code cache
3759 // walk in CLDG::clean_deallocate_lists().
3760 bool InstanceKlass::has_previous_versions_and_reset() {
3761   bool ret = _has_previous_versions;
3762   log_trace(redefine, class, iklass, purge)(&quot;Class unloading: has_previous_versions = %s&quot;,
3763      ret ? &quot;true&quot; : &quot;false&quot;);
3764   _has_previous_versions = false;
3765   return ret;
3766 }
3767 
3768 // Purge previous versions before adding new previous versions of the class and
3769 // during class unloading.
3770 void InstanceKlass::purge_previous_version_list() {
3771   assert(SafepointSynchronize::is_at_safepoint(), &quot;only called at safepoint&quot;);
3772   assert(has_been_redefined(), &quot;Should only be called for main class&quot;);
3773 
3774   // Quick exit.
3775   if (previous_versions() == NULL) {
3776     return;
3777   }
3778 
3779   // This klass has previous versions so see what we can cleanup
3780   // while it is safe to do so.
3781 
3782   int deleted_count = 0;    // leave debugging breadcrumbs
3783   int live_count = 0;
3784   ClassLoaderData* loader_data = class_loader_data();
3785   assert(loader_data != NULL, &quot;should never be null&quot;);
3786 
3787   ResourceMark rm;
3788   log_trace(redefine, class, iklass, purge)(&quot;%s: previous versions&quot;, external_name());
3789 
3790   // previous versions are linked together through the InstanceKlass
3791   InstanceKlass* pv_node = previous_versions();
3792   InstanceKlass* last = this;
3793   int version = 0;
3794 
3795   // check the previous versions list
3796   for (; pv_node != NULL; ) {
3797 
3798     ConstantPool* pvcp = pv_node-&gt;constants();
3799     assert(pvcp != NULL, &quot;cp ref was unexpectedly cleared&quot;);
3800 
3801     if (!pvcp-&gt;on_stack()) {
3802       // If the constant pool isn&#39;t on stack, none of the methods
3803       // are executing.  Unlink this previous_version.
3804       // The previous version InstanceKlass is on the ClassLoaderData deallocate list
3805       // so will be deallocated during the next phase of class unloading.
3806       log_trace(redefine, class, iklass, purge)
3807         (&quot;previous version &quot; INTPTR_FORMAT &quot; is dead.&quot;, p2i(pv_node));
3808       // For debugging purposes.
3809       pv_node-&gt;set_is_scratch_class();
3810       // Unlink from previous version list.
3811       assert(pv_node-&gt;class_loader_data() == loader_data, &quot;wrong loader_data&quot;);
3812       InstanceKlass* next = pv_node-&gt;previous_versions();
3813       pv_node-&gt;link_previous_versions(NULL);   // point next to NULL
3814       last-&gt;link_previous_versions(next);
3815       // Add to the deallocate list after unlinking
3816       loader_data-&gt;add_to_deallocate_list(pv_node);
3817       pv_node = next;
3818       deleted_count++;
3819       version++;
3820       continue;
3821     } else {
3822       log_trace(redefine, class, iklass, purge)(&quot;previous version &quot; INTPTR_FORMAT &quot; is alive&quot;, p2i(pv_node));
3823       assert(pvcp-&gt;pool_holder() != NULL, &quot;Constant pool with no holder&quot;);
3824       guarantee (!loader_data-&gt;is_unloading(), &quot;unloaded classes can&#39;t be on the stack&quot;);
3825       live_count++;
3826       // found a previous version for next time we do class unloading
3827       _has_previous_versions = true;
3828     }
3829 
3830     // At least one method is live in this previous version.
3831     // Reset dead EMCP methods not to get breakpoints.
3832     // All methods are deallocated when all of the methods for this class are no
3833     // longer running.
3834     Array&lt;Method*&gt;* method_refs = pv_node-&gt;methods();
3835     if (method_refs != NULL) {
3836       log_trace(redefine, class, iklass, purge)(&quot;previous methods length=%d&quot;, method_refs-&gt;length());
3837       for (int j = 0; j &lt; method_refs-&gt;length(); j++) {
3838         Method* method = method_refs-&gt;at(j);
3839 
3840         if (!method-&gt;on_stack()) {
3841           // no breakpoints for non-running methods
3842           if (method-&gt;is_running_emcp()) {
3843             method-&gt;set_running_emcp(false);
3844           }
3845         } else {
3846           assert (method-&gt;is_obsolete() || method-&gt;is_running_emcp(),
3847                   &quot;emcp method cannot run after emcp bit is cleared&quot;);
3848           log_trace(redefine, class, iklass, purge)
3849             (&quot;purge: %s(%s): prev method @%d in version @%d is alive&quot;,
3850              method-&gt;name()-&gt;as_C_string(), method-&gt;signature()-&gt;as_C_string(), j, version);
3851         }
3852       }
3853     }
3854     // next previous version
3855     last = pv_node;
3856     pv_node = pv_node-&gt;previous_versions();
3857     version++;
3858   }
3859   log_trace(redefine, class, iklass, purge)
3860     (&quot;previous version stats: live=%d, deleted=%d&quot;, live_count, deleted_count);
3861 }
3862 
3863 void InstanceKlass::mark_newly_obsolete_methods(Array&lt;Method*&gt;* old_methods,
3864                                                 int emcp_method_count) {
3865   int obsolete_method_count = old_methods-&gt;length() - emcp_method_count;
3866 
3867   if (emcp_method_count != 0 &amp;&amp; obsolete_method_count != 0 &amp;&amp;
3868       _previous_versions != NULL) {
3869     // We have a mix of obsolete and EMCP methods so we have to
3870     // clear out any matching EMCP method entries the hard way.
3871     int local_count = 0;
3872     for (int i = 0; i &lt; old_methods-&gt;length(); i++) {
3873       Method* old_method = old_methods-&gt;at(i);
3874       if (old_method-&gt;is_obsolete()) {
3875         // only obsolete methods are interesting
3876         Symbol* m_name = old_method-&gt;name();
3877         Symbol* m_signature = old_method-&gt;signature();
3878 
3879         // previous versions are linked together through the InstanceKlass
3880         int j = 0;
3881         for (InstanceKlass* prev_version = _previous_versions;
3882              prev_version != NULL;
3883              prev_version = prev_version-&gt;previous_versions(), j++) {
3884 
3885           Array&lt;Method*&gt;* method_refs = prev_version-&gt;methods();
3886           for (int k = 0; k &lt; method_refs-&gt;length(); k++) {
3887             Method* method = method_refs-&gt;at(k);
3888 
3889             if (!method-&gt;is_obsolete() &amp;&amp;
3890                 method-&gt;name() == m_name &amp;&amp;
3891                 method-&gt;signature() == m_signature) {
3892               // The current RedefineClasses() call has made all EMCP
3893               // versions of this method obsolete so mark it as obsolete
3894               log_trace(redefine, class, iklass, add)
3895                 (&quot;%s(%s): flush obsolete method @%d in version @%d&quot;,
3896                  m_name-&gt;as_C_string(), m_signature-&gt;as_C_string(), k, j);
3897 
3898               method-&gt;set_is_obsolete();
3899               break;
3900             }
3901           }
3902 
3903           // The previous loop may not find a matching EMCP method, but
3904           // that doesn&#39;t mean that we can optimize and not go any
3905           // further back in the PreviousVersion generations. The EMCP
3906           // method for this generation could have already been made obsolete,
3907           // but there still may be an older EMCP method that has not
3908           // been made obsolete.
3909         }
3910 
3911         if (++local_count &gt;= obsolete_method_count) {
3912           // no more obsolete methods so bail out now
3913           break;
3914         }
3915       }
3916     }
3917   }
3918 }
3919 
3920 // Save the scratch_class as the previous version if any of the methods are running.
3921 // The previous_versions are used to set breakpoints in EMCP methods and they are
3922 // also used to clean MethodData links to redefined methods that are no longer running.
3923 void InstanceKlass::add_previous_version(InstanceKlass* scratch_class,
3924                                          int emcp_method_count) {
3925   assert(Thread::current()-&gt;is_VM_thread(),
3926          &quot;only VMThread can add previous versions&quot;);
3927 
3928   ResourceMark rm;
3929   log_trace(redefine, class, iklass, add)
3930     (&quot;adding previous version ref for %s, EMCP_cnt=%d&quot;, scratch_class-&gt;external_name(), emcp_method_count);
3931 
3932   // Clean out old previous versions for this class
3933   purge_previous_version_list();
3934 
3935   // Mark newly obsolete methods in remaining previous versions.  An EMCP method from
3936   // a previous redefinition may be made obsolete by this redefinition.
3937   Array&lt;Method*&gt;* old_methods = scratch_class-&gt;methods();
3938   mark_newly_obsolete_methods(old_methods, emcp_method_count);
3939 
3940   // If the constant pool for this previous version of the class
3941   // is not marked as being on the stack, then none of the methods
3942   // in this previous version of the class are on the stack so
3943   // we don&#39;t need to add this as a previous version.
3944   ConstantPool* cp_ref = scratch_class-&gt;constants();
3945   if (!cp_ref-&gt;on_stack()) {
3946     log_trace(redefine, class, iklass, add)(&quot;scratch class not added; no methods are running&quot;);
3947     // For debugging purposes.
3948     scratch_class-&gt;set_is_scratch_class();
3949     scratch_class-&gt;class_loader_data()-&gt;add_to_deallocate_list(scratch_class);
3950     return;
3951   }
3952 
3953   if (emcp_method_count != 0) {
3954     // At least one method is still running, check for EMCP methods
3955     for (int i = 0; i &lt; old_methods-&gt;length(); i++) {
3956       Method* old_method = old_methods-&gt;at(i);
3957       if (!old_method-&gt;is_obsolete() &amp;&amp; old_method-&gt;on_stack()) {
3958         // if EMCP method (not obsolete) is on the stack, mark as EMCP so that
3959         // we can add breakpoints for it.
3960 
3961         // We set the method-&gt;on_stack bit during safepoints for class redefinition
3962         // and use this bit to set the is_running_emcp bit.
3963         // After the safepoint, the on_stack bit is cleared and the running emcp
3964         // method may exit.   If so, we would set a breakpoint in a method that
3965         // is never reached, but this won&#39;t be noticeable to the programmer.
3966         old_method-&gt;set_running_emcp(true);
3967         log_trace(redefine, class, iklass, add)
3968           (&quot;EMCP method %s is on_stack &quot; INTPTR_FORMAT, old_method-&gt;name_and_sig_as_C_string(), p2i(old_method));
3969       } else if (!old_method-&gt;is_obsolete()) {
3970         log_trace(redefine, class, iklass, add)
3971           (&quot;EMCP method %s is NOT on_stack &quot; INTPTR_FORMAT, old_method-&gt;name_and_sig_as_C_string(), p2i(old_method));
3972       }
3973     }
3974   }
3975 
3976   // Add previous version if any methods are still running.
3977   // Set has_previous_version flag for processing during class unloading.
3978   _has_previous_versions = true;
3979   log_trace(redefine, class, iklass, add) (&quot;scratch class added; one of its methods is on_stack.&quot;);
3980   assert(scratch_class-&gt;previous_versions() == NULL, &quot;shouldn&#39;t have a previous version&quot;);
3981   scratch_class-&gt;link_previous_versions(previous_versions());
3982   link_previous_versions(scratch_class);
3983 } // end add_previous_version()
3984 
3985 #endif // INCLUDE_JVMTI
3986 
3987 Method* InstanceKlass::method_with_idnum(int idnum) {
3988   Method* m = NULL;
3989   if (idnum &lt; methods()-&gt;length()) {
3990     m = methods()-&gt;at(idnum);
3991   }
3992   if (m == NULL || m-&gt;method_idnum() != idnum) {
3993     for (int index = 0; index &lt; methods()-&gt;length(); ++index) {
3994       m = methods()-&gt;at(index);
3995       if (m-&gt;method_idnum() == idnum) {
3996         return m;
3997       }
3998     }
3999     // None found, return null for the caller to handle.
4000     return NULL;
4001   }
4002   return m;
4003 }
4004 
4005 
4006 Method* InstanceKlass::method_with_orig_idnum(int idnum) {
4007   if (idnum &gt;= methods()-&gt;length()) {
4008     return NULL;
4009   }
4010   Method* m = methods()-&gt;at(idnum);
4011   if (m != NULL &amp;&amp; m-&gt;orig_method_idnum() == idnum) {
4012     return m;
4013   }
4014   // Obsolete method idnum does not match the original idnum
4015   for (int index = 0; index &lt; methods()-&gt;length(); ++index) {
4016     m = methods()-&gt;at(index);
4017     if (m-&gt;orig_method_idnum() == idnum) {
4018       return m;
4019     }
4020   }
4021   // None found, return null for the caller to handle.
4022   return NULL;
4023 }
4024 
4025 
4026 Method* InstanceKlass::method_with_orig_idnum(int idnum, int version) {
4027   InstanceKlass* holder = get_klass_version(version);
4028   if (holder == NULL) {
4029     return NULL; // The version of klass is gone, no method is found
4030   }
4031   Method* method = holder-&gt;method_with_orig_idnum(idnum);
4032   return method;
4033 }
4034 
4035 #if INCLUDE_JVMTI
4036 JvmtiCachedClassFileData* InstanceKlass::get_cached_class_file() {
4037   return _cached_class_file;
4038 }
4039 
4040 jint InstanceKlass::get_cached_class_file_len() {
4041   return VM_RedefineClasses::get_cached_class_file_len(_cached_class_file);
4042 }
4043 
4044 unsigned char * InstanceKlass::get_cached_class_file_bytes() {
4045   return VM_RedefineClasses::get_cached_class_file_bytes(_cached_class_file);
4046 }
4047 #endif
<a name="2" id="anc2"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="2" type="hidden" />
</body>
</html>