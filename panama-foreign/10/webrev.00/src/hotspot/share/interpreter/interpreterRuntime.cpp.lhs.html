<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames src/hotspot/share/interpreter/interpreterRuntime.cpp</title>
    <link rel="stylesheet" href="../../../../style.css" />
    <script type="text/javascript" src="../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>   1 /*
<a name="1" id="anc1"></a><span class="line-modified">   2  * Copyright (c) 1997, 2019, Oracle and/or its affiliates. All rights reserved.</span>
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
  23  */
  24 
  25 #include &quot;precompiled.hpp&quot;
  26 #include &quot;classfile/javaClasses.inline.hpp&quot;
  27 #include &quot;classfile/symbolTable.hpp&quot;
  28 #include &quot;classfile/systemDictionary.hpp&quot;
  29 #include &quot;classfile/vmSymbols.hpp&quot;
  30 #include &quot;code/codeCache.hpp&quot;
  31 #include &quot;compiler/compilationPolicy.hpp&quot;
  32 #include &quot;compiler/compileBroker.hpp&quot;
  33 #include &quot;compiler/disassembler.hpp&quot;
  34 #include &quot;gc/shared/barrierSetNMethod.hpp&quot;
  35 #include &quot;gc/shared/collectedHeap.hpp&quot;
  36 #include &quot;interpreter/interpreter.hpp&quot;
  37 #include &quot;interpreter/interpreterRuntime.hpp&quot;
  38 #include &quot;interpreter/linkResolver.hpp&quot;
  39 #include &quot;interpreter/templateTable.hpp&quot;
  40 #include &quot;logging/log.hpp&quot;
  41 #include &quot;memory/oopFactory.hpp&quot;
  42 #include &quot;memory/resourceArea.hpp&quot;
  43 #include &quot;memory/universe.hpp&quot;
  44 #include &quot;oops/constantPool.hpp&quot;
  45 #include &quot;oops/cpCache.inline.hpp&quot;
  46 #include &quot;oops/instanceKlass.hpp&quot;
  47 #include &quot;oops/methodData.hpp&quot;
  48 #include &quot;oops/objArrayKlass.hpp&quot;
  49 #include &quot;oops/objArrayOop.inline.hpp&quot;
  50 #include &quot;oops/oop.inline.hpp&quot;
  51 #include &quot;oops/symbol.hpp&quot;
  52 #include &quot;prims/jvmtiExport.hpp&quot;
  53 #include &quot;prims/nativeLookup.hpp&quot;
  54 #include &quot;runtime/atomic.hpp&quot;
  55 #include &quot;runtime/biasedLocking.hpp&quot;
  56 #include &quot;runtime/deoptimization.hpp&quot;
  57 #include &quot;runtime/fieldDescriptor.inline.hpp&quot;
  58 #include &quot;runtime/frame.inline.hpp&quot;
  59 #include &quot;runtime/handles.inline.hpp&quot;
  60 #include &quot;runtime/icache.hpp&quot;
  61 #include &quot;runtime/interfaceSupport.inline.hpp&quot;
  62 #include &quot;runtime/java.hpp&quot;
  63 #include &quot;runtime/javaCalls.hpp&quot;
  64 #include &quot;runtime/jfieldIDWorkaround.hpp&quot;
  65 #include &quot;runtime/osThread.hpp&quot;
  66 #include &quot;runtime/sharedRuntime.hpp&quot;
  67 #include &quot;runtime/stubRoutines.hpp&quot;
  68 #include &quot;runtime/synchronizer.hpp&quot;
  69 #include &quot;runtime/threadCritical.hpp&quot;
  70 #include &quot;utilities/align.hpp&quot;
  71 #include &quot;utilities/copy.hpp&quot;
  72 #include &quot;utilities/events.hpp&quot;
  73 #ifdef COMPILER2
  74 #include &quot;opto/runtime.hpp&quot;
  75 #endif
  76 
  77 class UnlockFlagSaver {
  78   private:
  79     JavaThread* _thread;
  80     bool _do_not_unlock;
  81   public:
  82     UnlockFlagSaver(JavaThread* t) {
  83       _thread = t;
  84       _do_not_unlock = t-&gt;do_not_unlock_if_synchronized();
  85       t-&gt;set_do_not_unlock_if_synchronized(false);
  86     }
  87     ~UnlockFlagSaver() {
  88       _thread-&gt;set_do_not_unlock_if_synchronized(_do_not_unlock);
  89     }
  90 };
  91 
  92 // Helper class to access current interpreter state
  93 class LastFrameAccessor : public StackObj {
  94   frame _last_frame;
  95 public:
  96   LastFrameAccessor(JavaThread* thread) {
  97     assert(thread == Thread::current(), &quot;sanity&quot;);
  98     _last_frame = thread-&gt;last_frame();
  99   }
 100   bool is_interpreted_frame() const              { return _last_frame.is_interpreted_frame(); }
 101   Method*   method() const                       { return _last_frame.interpreter_frame_method(); }
 102   address   bcp() const                          { return _last_frame.interpreter_frame_bcp(); }
 103   int       bci() const                          { return _last_frame.interpreter_frame_bci(); }
 104   address   mdp() const                          { return _last_frame.interpreter_frame_mdp(); }
 105 
 106   void      set_bcp(address bcp)                 { _last_frame.interpreter_frame_set_bcp(bcp); }
 107   void      set_mdp(address dp)                  { _last_frame.interpreter_frame_set_mdp(dp); }
 108 
 109   // pass method to avoid calling unsafe bcp_to_method (partial fix 4926272)
 110   Bytecodes::Code code() const                   { return Bytecodes::code_at(method(), bcp()); }
 111 
 112   Bytecode  bytecode() const                     { return Bytecode(method(), bcp()); }
 113   int get_index_u1(Bytecodes::Code bc) const     { return bytecode().get_index_u1(bc); }
 114   int get_index_u2(Bytecodes::Code bc) const     { return bytecode().get_index_u2(bc); }
 115   int get_index_u2_cpcache(Bytecodes::Code bc) const
 116                                                  { return bytecode().get_index_u2_cpcache(bc); }
 117   int get_index_u4(Bytecodes::Code bc) const     { return bytecode().get_index_u4(bc); }
 118   int number_of_dimensions() const               { return bcp()[3]; }
 119   ConstantPoolCacheEntry* cache_entry_at(int i) const
 120                                                  { return method()-&gt;constants()-&gt;cache()-&gt;entry_at(i); }
 121   ConstantPoolCacheEntry* cache_entry() const    { return cache_entry_at(Bytes::get_native_u2(bcp() + 1)); }
 122 
 123   oop callee_receiver(Symbol* signature) {
 124     return _last_frame.interpreter_callee_receiver(signature);
 125   }
 126   BasicObjectLock* monitor_begin() const {
 127     return _last_frame.interpreter_frame_monitor_begin();
 128   }
 129   BasicObjectLock* monitor_end() const {
 130     return _last_frame.interpreter_frame_monitor_end();
 131   }
 132   BasicObjectLock* next_monitor(BasicObjectLock* current) const {
 133     return _last_frame.next_monitor_in_interpreter_frame(current);
 134   }
 135 
 136   frame&amp; get_frame()                             { return _last_frame; }
 137 };
 138 
 139 //------------------------------------------------------------------------------------------------------------------------
 140 // State accessors
 141 
 142 void InterpreterRuntime::set_bcp_and_mdp(address bcp, JavaThread *thread) {
 143   LastFrameAccessor last_frame(thread);
 144   last_frame.set_bcp(bcp);
 145   if (ProfileInterpreter) {
 146     // ProfileTraps uses MDOs independently of ProfileInterpreter.
 147     // That is why we must check both ProfileInterpreter and mdo != NULL.
 148     MethodData* mdo = last_frame.method()-&gt;method_data();
 149     if (mdo != NULL) {
 150       NEEDS_CLEANUP;
 151       last_frame.set_mdp(mdo-&gt;bci_to_dp(last_frame.bci()));
 152     }
 153   }
 154 }
 155 
 156 //------------------------------------------------------------------------------------------------------------------------
 157 // Constants
 158 
 159 
 160 JRT_ENTRY(void, InterpreterRuntime::ldc(JavaThread* thread, bool wide))
 161   // access constant pool
 162   LastFrameAccessor last_frame(thread);
 163   ConstantPool* pool = last_frame.method()-&gt;constants();
 164   int index = wide ? last_frame.get_index_u2(Bytecodes::_ldc_w) : last_frame.get_index_u1(Bytecodes::_ldc);
 165   constantTag tag = pool-&gt;tag_at(index);
 166 
 167   assert (tag.is_unresolved_klass() || tag.is_klass(), &quot;wrong ldc call&quot;);
 168   Klass* klass = pool-&gt;klass_at(index, CHECK);
 169     oop java_class = klass-&gt;java_mirror();
 170     thread-&gt;set_vm_result(java_class);
 171 JRT_END
 172 
 173 JRT_ENTRY(void, InterpreterRuntime::resolve_ldc(JavaThread* thread, Bytecodes::Code bytecode)) {
 174   assert(bytecode == Bytecodes::_ldc ||
 175          bytecode == Bytecodes::_ldc_w ||
 176          bytecode == Bytecodes::_ldc2_w ||
 177          bytecode == Bytecodes::_fast_aldc ||
 178          bytecode == Bytecodes::_fast_aldc_w, &quot;wrong bc&quot;);
 179   ResourceMark rm(thread);
 180   const bool is_fast_aldc = (bytecode == Bytecodes::_fast_aldc ||
 181                              bytecode == Bytecodes::_fast_aldc_w);
 182   LastFrameAccessor last_frame(thread);
 183   methodHandle m (thread, last_frame.method());
 184   Bytecode_loadconstant ldc(m, last_frame.bci());
 185 
 186   // Double-check the size.  (Condy can have any type.)
 187   BasicType type = ldc.result_type();
 188   switch (type2size[type]) {
 189   case 2: guarantee(bytecode == Bytecodes::_ldc2_w, &quot;&quot;); break;
 190   case 1: guarantee(bytecode != Bytecodes::_ldc2_w, &quot;&quot;); break;
 191   default: ShouldNotReachHere();
 192   }
 193 
 194   // Resolve the constant.  This does not do unboxing.
 195   // But it does replace Universe::the_null_sentinel by null.
 196   oop result = ldc.resolve_constant(CHECK);
 197   assert(result != NULL || is_fast_aldc, &quot;null result only valid for fast_aldc&quot;);
 198 
 199 #ifdef ASSERT
 200   {
 201     // The bytecode wrappers aren&#39;t GC-safe so construct a new one
 202     Bytecode_loadconstant ldc2(m, last_frame.bci());
 203     int rindex = ldc2.cache_index();
 204     if (rindex &lt; 0)
 205       rindex = m-&gt;constants()-&gt;cp_to_object_index(ldc2.pool_index());
 206     if (rindex &gt;= 0) {
 207       oop coop = m-&gt;constants()-&gt;resolved_references()-&gt;obj_at(rindex);
 208       oop roop = (result == NULL ? Universe::the_null_sentinel() : result);
 209       assert(roop == coop, &quot;expected result for assembly code&quot;);
 210     }
 211   }
 212 #endif
 213   thread-&gt;set_vm_result(result);
 214   if (!is_fast_aldc) {
 215     // Tell the interpreter how to unbox the primitive.
 216     guarantee(java_lang_boxing_object::is_instance(result, type), &quot;&quot;);
 217     int offset = java_lang_boxing_object::value_offset_in_bytes(type);
 218     intptr_t flags = ((as_TosState(type) &lt;&lt; ConstantPoolCacheEntry::tos_state_shift)
 219                       | (offset &amp; ConstantPoolCacheEntry::field_index_mask));
 220     thread-&gt;set_vm_result_2((Metadata*)flags);
 221   }
 222 }
 223 JRT_END
 224 
 225 
 226 //------------------------------------------------------------------------------------------------------------------------
 227 // Allocation
 228 
 229 JRT_ENTRY(void, InterpreterRuntime::_new(JavaThread* thread, ConstantPool* pool, int index))
 230   Klass* k = pool-&gt;klass_at(index, CHECK);
 231   InstanceKlass* klass = InstanceKlass::cast(k);
 232 
 233   // Make sure we are not instantiating an abstract klass
 234   klass-&gt;check_valid_for_instantiation(true, CHECK);
 235 
 236   // Make sure klass is initialized
 237   klass-&gt;initialize(CHECK);
 238 
 239   // At this point the class may not be fully initialized
 240   // because of recursive initialization. If it is fully
 241   // initialized &amp; has_finalized is not set, we rewrite
 242   // it into its fast version (Note: no locking is needed
 243   // here since this is an atomic byte write and can be
 244   // done more than once).
 245   //
 246   // Note: In case of classes with has_finalized we don&#39;t
 247   //       rewrite since that saves us an extra check in
 248   //       the fast version which then would call the
 249   //       slow version anyway (and do a call back into
 250   //       Java).
 251   //       If we have a breakpoint, then we don&#39;t rewrite
 252   //       because the _breakpoint bytecode would be lost.
 253   oop obj = klass-&gt;allocate_instance(CHECK);
 254   thread-&gt;set_vm_result(obj);
 255 JRT_END
 256 
 257 
 258 JRT_ENTRY(void, InterpreterRuntime::newarray(JavaThread* thread, BasicType type, jint size))
 259   oop obj = oopFactory::new_typeArray(type, size, CHECK);
 260   thread-&gt;set_vm_result(obj);
 261 JRT_END
 262 
 263 
 264 JRT_ENTRY(void, InterpreterRuntime::anewarray(JavaThread* thread, ConstantPool* pool, int index, jint size))
 265   Klass*    klass = pool-&gt;klass_at(index, CHECK);
 266   objArrayOop obj = oopFactory::new_objArray(klass, size, CHECK);
 267   thread-&gt;set_vm_result(obj);
 268 JRT_END
 269 
 270 
 271 JRT_ENTRY(void, InterpreterRuntime::multianewarray(JavaThread* thread, jint* first_size_address))
 272   // We may want to pass in more arguments - could make this slightly faster
 273   LastFrameAccessor last_frame(thread);
 274   ConstantPool* constants = last_frame.method()-&gt;constants();
 275   int          i = last_frame.get_index_u2(Bytecodes::_multianewarray);
 276   Klass* klass   = constants-&gt;klass_at(i, CHECK);
 277   int   nof_dims = last_frame.number_of_dimensions();
 278   assert(klass-&gt;is_klass(), &quot;not a class&quot;);
 279   assert(nof_dims &gt;= 1, &quot;multianewarray rank must be nonzero&quot;);
 280 
 281   // We must create an array of jints to pass to multi_allocate.
 282   ResourceMark rm(thread);
 283   const int small_dims = 10;
 284   jint dim_array[small_dims];
 285   jint *dims = &amp;dim_array[0];
 286   if (nof_dims &gt; small_dims) {
 287     dims = (jint*) NEW_RESOURCE_ARRAY(jint, nof_dims);
 288   }
 289   for (int index = 0; index &lt; nof_dims; index++) {
 290     // offset from first_size_address is addressed as local[index]
 291     int n = Interpreter::local_offset_in_bytes(index)/jintSize;
 292     dims[index] = first_size_address[n];
 293   }
 294   oop obj = ArrayKlass::cast(klass)-&gt;multi_allocate(nof_dims, dims, CHECK);
 295   thread-&gt;set_vm_result(obj);
 296 JRT_END
 297 
 298 
 299 JRT_ENTRY(void, InterpreterRuntime::register_finalizer(JavaThread* thread, oopDesc* obj))
 300   assert(oopDesc::is_oop(obj), &quot;must be a valid oop&quot;);
 301   assert(obj-&gt;klass()-&gt;has_finalizer(), &quot;shouldn&#39;t be here otherwise&quot;);
 302   InstanceKlass::register_finalizer(instanceOop(obj), CHECK);
 303 JRT_END
 304 
 305 
 306 // Quicken instance-of and check-cast bytecodes
 307 JRT_ENTRY(void, InterpreterRuntime::quicken_io_cc(JavaThread* thread))
 308   // Force resolving; quicken the bytecode
 309   LastFrameAccessor last_frame(thread);
 310   int which = last_frame.get_index_u2(Bytecodes::_checkcast);
 311   ConstantPool* cpool = last_frame.method()-&gt;constants();
 312   // We&#39;d expect to assert that we&#39;re only here to quicken bytecodes, but in a multithreaded
 313   // program we might have seen an unquick&#39;d bytecode in the interpreter but have another
 314   // thread quicken the bytecode before we get here.
 315   // assert( cpool-&gt;tag_at(which).is_unresolved_klass(), &quot;should only come here to quicken bytecodes&quot; );
 316   Klass* klass = cpool-&gt;klass_at(which, CHECK);
 317   thread-&gt;set_vm_result_2(klass);
 318 JRT_END
 319 
 320 
 321 //------------------------------------------------------------------------------------------------------------------------
 322 // Exceptions
 323 
 324 void InterpreterRuntime::note_trap_inner(JavaThread* thread, int reason,
 325                                          const methodHandle&amp; trap_method, int trap_bci, TRAPS) {
 326   if (trap_method.not_null()) {
 327     MethodData* trap_mdo = trap_method-&gt;method_data();
 328     if (trap_mdo == NULL) {
 329       Method::build_interpreter_method_data(trap_method, THREAD);
 330       if (HAS_PENDING_EXCEPTION) {
 331         assert((PENDING_EXCEPTION-&gt;is_a(SystemDictionary::OutOfMemoryError_klass())),
 332                &quot;we expect only an OOM error here&quot;);
 333         CLEAR_PENDING_EXCEPTION;
 334       }
 335       trap_mdo = trap_method-&gt;method_data();
 336       // and fall through...
 337     }
 338     if (trap_mdo != NULL) {
 339       // Update per-method count of trap events.  The interpreter
 340       // is updating the MDO to simulate the effect of compiler traps.
 341       Deoptimization::update_method_data_from_interpreter(trap_mdo, trap_bci, reason);
 342     }
 343   }
 344 }
 345 
 346 // Assume the compiler is (or will be) interested in this event.
 347 // If necessary, create an MDO to hold the information, and record it.
 348 void InterpreterRuntime::note_trap(JavaThread* thread, int reason, TRAPS) {
 349   assert(ProfileTraps, &quot;call me only if profiling&quot;);
 350   LastFrameAccessor last_frame(thread);
 351   methodHandle trap_method(thread, last_frame.method());
 352   int trap_bci = trap_method-&gt;bci_from(last_frame.bcp());
 353   note_trap_inner(thread, reason, trap_method, trap_bci, THREAD);
 354 }
 355 
 356 #ifdef CC_INTERP
 357 // As legacy note_trap, but we have more arguments.
 358 JRT_ENTRY(void, InterpreterRuntime::note_trap(JavaThread* thread, int reason, Method *method, int trap_bci))
 359   methodHandle trap_method(thread, method);
 360   note_trap_inner(thread, reason, trap_method, trap_bci, THREAD);
 361 JRT_END
 362 
 363 // Class Deoptimization is not visible in BytecodeInterpreter, so we need a wrapper
 364 // for each exception.
 365 void InterpreterRuntime::note_nullCheck_trap(JavaThread* thread, Method *method, int trap_bci)
 366   { if (ProfileTraps) note_trap(thread, Deoptimization::Reason_null_check, method, trap_bci); }
 367 void InterpreterRuntime::note_div0Check_trap(JavaThread* thread, Method *method, int trap_bci)
 368   { if (ProfileTraps) note_trap(thread, Deoptimization::Reason_div0_check, method, trap_bci); }
 369 void InterpreterRuntime::note_rangeCheck_trap(JavaThread* thread, Method *method, int trap_bci)
 370   { if (ProfileTraps) note_trap(thread, Deoptimization::Reason_range_check, method, trap_bci); }
 371 void InterpreterRuntime::note_classCheck_trap(JavaThread* thread, Method *method, int trap_bci)
 372   { if (ProfileTraps) note_trap(thread, Deoptimization::Reason_class_check, method, trap_bci); }
 373 void InterpreterRuntime::note_arrayCheck_trap(JavaThread* thread, Method *method, int trap_bci)
 374   { if (ProfileTraps) note_trap(thread, Deoptimization::Reason_array_check, method, trap_bci); }
 375 #endif // CC_INTERP
 376 
 377 
 378 static Handle get_preinitialized_exception(Klass* k, TRAPS) {
 379   // get klass
 380   InstanceKlass* klass = InstanceKlass::cast(k);
 381   assert(klass-&gt;is_initialized(),
 382          &quot;this klass should have been initialized during VM initialization&quot;);
 383   // create instance - do not call constructor since we may have no
 384   // (java) stack space left (should assert constructor is empty)
 385   Handle exception;
 386   oop exception_oop = klass-&gt;allocate_instance(CHECK_(exception));
 387   exception = Handle(THREAD, exception_oop);
 388   if (StackTraceInThrowable) {
 389     java_lang_Throwable::fill_in_stack_trace(exception);
 390   }
 391   return exception;
 392 }
 393 
 394 // Special handling for stack overflow: since we don&#39;t have any (java) stack
 395 // space left we use the pre-allocated &amp; pre-initialized StackOverflowError
 396 // klass to create an stack overflow error instance.  We do not call its
 397 // constructor for the same reason (it is empty, anyway).
 398 JRT_ENTRY(void, InterpreterRuntime::throw_StackOverflowError(JavaThread* thread))
 399   Handle exception = get_preinitialized_exception(
 400                                  SystemDictionary::StackOverflowError_klass(),
 401                                  CHECK);
 402   // Increment counter for hs_err file reporting
 403   Atomic::inc(&amp;Exceptions::_stack_overflow_errors);
 404   THROW_HANDLE(exception);
 405 JRT_END
 406 
 407 JRT_ENTRY(void, InterpreterRuntime::throw_delayed_StackOverflowError(JavaThread* thread))
 408   Handle exception = get_preinitialized_exception(
 409                                  SystemDictionary::StackOverflowError_klass(),
 410                                  CHECK);
 411   java_lang_Throwable::set_message(exception(),
 412           Universe::delayed_stack_overflow_error_message());
 413   // Increment counter for hs_err file reporting
 414   Atomic::inc(&amp;Exceptions::_stack_overflow_errors);
 415   THROW_HANDLE(exception);
 416 JRT_END
 417 
 418 JRT_ENTRY(void, InterpreterRuntime::create_exception(JavaThread* thread, char* name, char* message))
 419   // lookup exception klass
 420   TempNewSymbol s = SymbolTable::new_symbol(name);
 421   if (ProfileTraps) {
 422     if (s == vmSymbols::java_lang_ArithmeticException()) {
 423       note_trap(thread, Deoptimization::Reason_div0_check, CHECK);
 424     } else if (s == vmSymbols::java_lang_NullPointerException()) {
 425       note_trap(thread, Deoptimization::Reason_null_check, CHECK);
 426     }
 427   }
 428   // create exception
 429   Handle exception = Exceptions::new_exception(thread, s, message);
 430   thread-&gt;set_vm_result(exception());
 431 JRT_END
 432 
 433 
 434 JRT_ENTRY(void, InterpreterRuntime::create_klass_exception(JavaThread* thread, char* name, oopDesc* obj))
 435   // Produce the error message first because note_trap can safepoint
 436   ResourceMark rm(thread);
 437   const char* klass_name = obj-&gt;klass()-&gt;external_name();
 438   // lookup exception klass
 439   TempNewSymbol s = SymbolTable::new_symbol(name);
 440   if (ProfileTraps) {
 441     note_trap(thread, Deoptimization::Reason_class_check, CHECK);
 442   }
 443   // create exception, with klass name as detail message
 444   Handle exception = Exceptions::new_exception(thread, s, klass_name);
 445   thread-&gt;set_vm_result(exception());
 446 JRT_END
 447 
 448 JRT_ENTRY(void, InterpreterRuntime::throw_ArrayIndexOutOfBoundsException(JavaThread* thread, arrayOopDesc* a, jint index))
 449   // Produce the error message first because note_trap can safepoint
 450   ResourceMark rm(thread);
 451   stringStream ss;
 452   ss.print(&quot;Index %d out of bounds for length %d&quot;, index, a-&gt;length());
 453 
 454   if (ProfileTraps) {
 455     note_trap(thread, Deoptimization::Reason_range_check, CHECK);
 456   }
 457 
 458   THROW_MSG(vmSymbols::java_lang_ArrayIndexOutOfBoundsException(), ss.as_string());
 459 JRT_END
 460 
 461 JRT_ENTRY(void, InterpreterRuntime::throw_ClassCastException(
 462   JavaThread* thread, oopDesc* obj))
 463 
 464   // Produce the error message first because note_trap can safepoint
 465   ResourceMark rm(thread);
 466   char* message = SharedRuntime::generate_class_cast_message(
 467     thread, obj-&gt;klass());
 468 
 469   if (ProfileTraps) {
 470     note_trap(thread, Deoptimization::Reason_class_check, CHECK);
 471   }
 472 
 473   // create exception
 474   THROW_MSG(vmSymbols::java_lang_ClassCastException(), message);
 475 JRT_END
 476 
 477 // exception_handler_for_exception(...) returns the continuation address,
 478 // the exception oop (via TLS) and sets the bci/bcp for the continuation.
 479 // The exception oop is returned to make sure it is preserved over GC (it
 480 // is only on the stack if the exception was thrown explicitly via athrow).
 481 // During this operation, the expression stack contains the values for the
 482 // bci where the exception happened. If the exception was propagated back
 483 // from a call, the expression stack contains the values for the bci at the
 484 // invoke w/o arguments (i.e., as if one were inside the call).
 485 JRT_ENTRY(address, InterpreterRuntime::exception_handler_for_exception(JavaThread* thread, oopDesc* exception))
 486 
 487   LastFrameAccessor last_frame(thread);
 488   Handle             h_exception(thread, exception);
 489   methodHandle       h_method   (thread, last_frame.method());
 490   constantPoolHandle h_constants(thread, h_method-&gt;constants());
 491   bool               should_repeat;
 492   int                handler_bci;
 493   int                current_bci = last_frame.bci();
 494 
 495   if (thread-&gt;frames_to_pop_failed_realloc() &gt; 0) {
 496     // Allocation of scalar replaced object used in this frame
 497     // failed. Unconditionally pop the frame.
 498     thread-&gt;dec_frames_to_pop_failed_realloc();
 499     thread-&gt;set_vm_result(h_exception());
 500     // If the method is synchronized we already unlocked the monitor
 501     // during deoptimization so the interpreter needs to skip it when
 502     // the frame is popped.
 503     thread-&gt;set_do_not_unlock_if_synchronized(true);
 504 #ifdef CC_INTERP
 505     return (address) -1;
 506 #else
 507     return Interpreter::remove_activation_entry();
 508 #endif
 509   }
 510 
 511   // Need to do this check first since when _do_not_unlock_if_synchronized
 512   // is set, we don&#39;t want to trigger any classloading which may make calls
 513   // into java, or surprisingly find a matching exception handler for bci 0
 514   // since at this moment the method hasn&#39;t been &quot;officially&quot; entered yet.
 515   if (thread-&gt;do_not_unlock_if_synchronized()) {
 516     ResourceMark rm;
 517     assert(current_bci == 0,  &quot;bci isn&#39;t zero for do_not_unlock_if_synchronized&quot;);
 518     thread-&gt;set_vm_result(exception);
 519 #ifdef CC_INTERP
 520     return (address) -1;
 521 #else
 522     return Interpreter::remove_activation_entry();
 523 #endif
 524   }
 525 
 526   do {
 527     should_repeat = false;
 528 
 529     // assertions
 530 #ifdef ASSERT
 531     assert(h_exception.not_null(), &quot;NULL exceptions should be handled by athrow&quot;);
 532     // Check that exception is a subclass of Throwable, otherwise we have a VerifyError
 533     if (!(h_exception-&gt;is_a(SystemDictionary::Throwable_klass()))) {
 534       if (ExitVMOnVerifyError) vm_exit(-1);
 535       ShouldNotReachHere();
 536     }
 537 #endif
 538 
 539     // tracing
 540     if (log_is_enabled(Info, exceptions)) {
 541       ResourceMark rm(thread);
 542       stringStream tempst;
 543       tempst.print(&quot;interpreter method &lt;%s&gt;\n&quot;
 544                    &quot; at bci %d for thread &quot; INTPTR_FORMAT &quot; (%s)&quot;,
 545                    h_method-&gt;print_value_string(), current_bci, p2i(thread), thread-&gt;name());
 546       Exceptions::log_exception(h_exception, tempst.as_string());
 547     }
 548 // Don&#39;t go paging in something which won&#39;t be used.
 549 //     else if (extable-&gt;length() == 0) {
 550 //       // disabled for now - interpreter is not using shortcut yet
 551 //       // (shortcut is not to call runtime if we have no exception handlers)
 552 //       // warning(&quot;performance bug: should not call runtime if method has no exception handlers&quot;);
 553 //     }
 554     // for AbortVMOnException flag
 555     Exceptions::debug_check_abort(h_exception);
 556 
 557     // exception handler lookup
 558     Klass* klass = h_exception-&gt;klass();
 559     handler_bci = Method::fast_exception_handler_bci_for(h_method, klass, current_bci, THREAD);
 560     if (HAS_PENDING_EXCEPTION) {
 561       // We threw an exception while trying to find the exception handler.
 562       // Transfer the new exception to the exception handle which will
 563       // be set into thread local storage, and do another lookup for an
 564       // exception handler for this exception, this time starting at the
 565       // BCI of the exception handler which caused the exception to be
 566       // thrown (bug 4307310).
 567       h_exception = Handle(THREAD, PENDING_EXCEPTION);
 568       CLEAR_PENDING_EXCEPTION;
 569       if (handler_bci &gt;= 0) {
 570         current_bci = handler_bci;
 571         should_repeat = true;
 572       }
 573     }
 574   } while (should_repeat == true);
 575 
 576 #if INCLUDE_JVMCI
 577   if (EnableJVMCI &amp;&amp; h_method-&gt;method_data() != NULL) {
 578     ResourceMark rm(thread);
 579     ProfileData* pdata = h_method-&gt;method_data()-&gt;allocate_bci_to_data(current_bci, NULL);
 580     if (pdata != NULL &amp;&amp; pdata-&gt;is_BitData()) {
 581       BitData* bit_data = (BitData*) pdata;
 582       bit_data-&gt;set_exception_seen();
 583     }
 584   }
 585 #endif
 586 
 587   // notify JVMTI of an exception throw; JVMTI will detect if this is a first
 588   // time throw or a stack unwinding throw and accordingly notify the debugger
 589   if (JvmtiExport::can_post_on_exceptions()) {
 590     JvmtiExport::post_exception_throw(thread, h_method(), last_frame.bcp(), h_exception());
 591   }
 592 
 593 #ifdef CC_INTERP
 594   address continuation = (address)(intptr_t) handler_bci;
 595 #else
 596   address continuation = NULL;
 597 #endif
 598   address handler_pc = NULL;
 599   if (handler_bci &lt; 0 || !thread-&gt;reguard_stack((address) &amp;continuation)) {
 600     // Forward exception to callee (leaving bci/bcp untouched) because (a) no
 601     // handler in this method, or (b) after a stack overflow there is not yet
 602     // enough stack space available to reprotect the stack.
 603 #ifndef CC_INTERP
 604     continuation = Interpreter::remove_activation_entry();
 605 #endif
 606 #if COMPILER2_OR_JVMCI
 607     // Count this for compilation purposes
 608     h_method-&gt;interpreter_throwout_increment(THREAD);
 609 #endif
 610   } else {
 611     // handler in this method =&gt; change bci/bcp to handler bci/bcp and continue there
 612     handler_pc = h_method-&gt;code_base() + handler_bci;
 613 #ifndef CC_INTERP
 614     set_bcp_and_mdp(handler_pc, thread);
 615     continuation = Interpreter::dispatch_table(vtos)[*handler_pc];
 616 #endif
 617   }
 618   // notify debugger of an exception catch
 619   // (this is good for exceptions caught in native methods as well)
 620   if (JvmtiExport::can_post_on_exceptions()) {
 621     JvmtiExport::notice_unwind_due_to_exception(thread, h_method(), handler_pc, h_exception(), (handler_pc != NULL));
 622   }
 623 
 624   thread-&gt;set_vm_result(h_exception());
 625   return continuation;
 626 JRT_END
 627 
 628 
 629 JRT_ENTRY(void, InterpreterRuntime::throw_pending_exception(JavaThread* thread))
 630   assert(thread-&gt;has_pending_exception(), &quot;must only ne called if there&#39;s an exception pending&quot;);
 631   // nothing to do - eventually we should remove this code entirely (see comments @ call sites)
 632 JRT_END
 633 
 634 
 635 JRT_ENTRY(void, InterpreterRuntime::throw_AbstractMethodError(JavaThread* thread))
 636   THROW(vmSymbols::java_lang_AbstractMethodError());
 637 JRT_END
 638 
 639 // This method is called from the &quot;abstract_entry&quot; of the interpreter.
 640 // At that point, the arguments have already been removed from the stack
 641 // and therefore we don&#39;t have the receiver object at our fingertips. (Though,
 642 // on some platforms the receiver still resides in a register...). Thus,
 643 // we have no choice but print an error message not containing the receiver
 644 // type.
 645 JRT_ENTRY(void, InterpreterRuntime::throw_AbstractMethodErrorWithMethod(JavaThread* thread,
 646                                                                         Method* missingMethod))
 647   ResourceMark rm(thread);
 648   assert(missingMethod != NULL, &quot;sanity&quot;);
 649   methodHandle m(thread, missingMethod);
 650   LinkResolver::throw_abstract_method_error(m, THREAD);
 651 JRT_END
 652 
 653 JRT_ENTRY(void, InterpreterRuntime::throw_AbstractMethodErrorVerbose(JavaThread* thread,
 654                                                                      Klass* recvKlass,
 655                                                                      Method* missingMethod))
 656   ResourceMark rm(thread);
 657   methodHandle mh = methodHandle(thread, missingMethod);
 658   LinkResolver::throw_abstract_method_error(mh, recvKlass, THREAD);
 659 JRT_END
 660 
 661 
 662 JRT_ENTRY(void, InterpreterRuntime::throw_IncompatibleClassChangeError(JavaThread* thread))
 663   THROW(vmSymbols::java_lang_IncompatibleClassChangeError());
 664 JRT_END
 665 
 666 JRT_ENTRY(void, InterpreterRuntime::throw_IncompatibleClassChangeErrorVerbose(JavaThread* thread,
 667                                                                               Klass* recvKlass,
 668                                                                               Klass* interfaceKlass))
 669   ResourceMark rm(thread);
 670   char buf[1000];
 671   buf[0] = &#39;\0&#39;;
 672   jio_snprintf(buf, sizeof(buf),
 673                &quot;Class %s does not implement the requested interface %s&quot;,
 674                recvKlass ? recvKlass-&gt;external_name() : &quot;NULL&quot;,
 675                interfaceKlass ? interfaceKlass-&gt;external_name() : &quot;NULL&quot;);
 676   THROW_MSG(vmSymbols::java_lang_IncompatibleClassChangeError(), buf);
 677 JRT_END
 678 
 679 //------------------------------------------------------------------------------------------------------------------------
 680 // Fields
 681 //
 682 
 683 void InterpreterRuntime::resolve_get_put(JavaThread* thread, Bytecodes::Code bytecode) {
 684   Thread* THREAD = thread;
 685   // resolve field
 686   fieldDescriptor info;
 687   LastFrameAccessor last_frame(thread);
 688   constantPoolHandle pool(thread, last_frame.method()-&gt;constants());
 689   methodHandle m(thread, last_frame.method());
 690   bool is_put    = (bytecode == Bytecodes::_putfield  || bytecode == Bytecodes::_nofast_putfield ||
 691                     bytecode == Bytecodes::_putstatic);
 692   bool is_static = (bytecode == Bytecodes::_getstatic || bytecode == Bytecodes::_putstatic);
 693 
 694   {
 695     JvmtiHideSingleStepping jhss(thread);
 696     LinkResolver::resolve_field_access(info, pool, last_frame.get_index_u2_cpcache(bytecode),
 697                                        m, bytecode, CHECK);
 698   } // end JvmtiHideSingleStepping
 699 
 700   // check if link resolution caused cpCache to be updated
 701   ConstantPoolCacheEntry* cp_cache_entry = last_frame.cache_entry();
 702   if (cp_cache_entry-&gt;is_resolved(bytecode)) return;
 703 
 704   // compute auxiliary field attributes
 705   TosState state  = as_TosState(info.field_type());
 706 
 707   // Resolution of put instructions on final fields is delayed. That is required so that
 708   // exceptions are thrown at the correct place (when the instruction is actually invoked).
 709   // If we do not resolve an instruction in the current pass, leaving the put_code
 710   // set to zero will cause the next put instruction to the same field to reresolve.
 711 
 712   // Resolution of put instructions to final instance fields with invalid updates (i.e.,
 713   // to final instance fields with updates originating from a method different than &lt;init&gt;)
 714   // is inhibited. A putfield instruction targeting an instance final field must throw
 715   // an IllegalAccessError if the instruction is not in an instance
 716   // initializer method &lt;init&gt;. If resolution were not inhibited, a putfield
 717   // in an initializer method could be resolved in the initializer. Subsequent
 718   // putfield instructions to the same field would then use cached information.
 719   // As a result, those instructions would not pass through the VM. That is,
 720   // checks in resolve_field_access() would not be executed for those instructions
 721   // and the required IllegalAccessError would not be thrown.
 722   //
 723   // Also, we need to delay resolving getstatic and putstatic instructions until the
 724   // class is initialized.  This is required so that access to the static
 725   // field will call the initialization function every time until the class
 726   // is completely initialized ala. in 2.17.5 in JVM Specification.
 727   InstanceKlass* klass = info.field_holder();
 728   bool uninitialized_static = is_static &amp;&amp; !klass-&gt;is_initialized();
 729   bool has_initialized_final_update = info.field_holder()-&gt;major_version() &gt;= 53 &amp;&amp;
 730                                       info.has_initialized_final_update();
 731   assert(!(has_initialized_final_update &amp;&amp; !info.access_flags().is_final()), &quot;Fields with initialized final updates must be final&quot;);
 732 
 733   Bytecodes::Code get_code = (Bytecodes::Code)0;
 734   Bytecodes::Code put_code = (Bytecodes::Code)0;
 735   if (!uninitialized_static) {
 736     get_code = ((is_static) ? Bytecodes::_getstatic : Bytecodes::_getfield);
 737     if ((is_put &amp;&amp; !has_initialized_final_update) || !info.access_flags().is_final()) {
 738       put_code = ((is_static) ? Bytecodes::_putstatic : Bytecodes::_putfield);
 739     }
 740   }
 741 
 742   cp_cache_entry-&gt;set_field(
 743     get_code,
 744     put_code,
 745     info.field_holder(),
 746     info.index(),
 747     info.offset(),
 748     state,
 749     info.access_flags().is_final(),
 750     info.access_flags().is_volatile(),
 751     pool-&gt;pool_holder()
 752   );
 753 }
 754 
 755 
 756 //------------------------------------------------------------------------------------------------------------------------
 757 // Synchronization
 758 //
 759 // The interpreter&#39;s synchronization code is factored out so that it can
 760 // be shared by method invocation and synchronized blocks.
 761 //%note synchronization_3
 762 
 763 //%note monitor_1
 764 JRT_ENTRY_NO_ASYNC(void, InterpreterRuntime::monitorenter(JavaThread* thread, BasicObjectLock* elem))
 765 #ifdef ASSERT
 766   thread-&gt;last_frame().interpreter_frame_verify_monitor(elem);
 767 #endif
 768   if (PrintBiasedLockingStatistics) {
 769     Atomic::inc(BiasedLocking::slow_path_entry_count_addr());
 770   }
 771   Handle h_obj(thread, elem-&gt;obj());
 772   assert(Universe::heap()-&gt;is_in_or_null(h_obj()),
 773          &quot;must be NULL or an object&quot;);
 774   ObjectSynchronizer::enter(h_obj, elem-&gt;lock(), CHECK);
 775   assert(Universe::heap()-&gt;is_in_or_null(elem-&gt;obj()),
 776          &quot;must be NULL or an object&quot;);
 777 #ifdef ASSERT
 778   thread-&gt;last_frame().interpreter_frame_verify_monitor(elem);
 779 #endif
 780 JRT_END
 781 
 782 
 783 //%note monitor_1
 784 JRT_ENTRY_NO_ASYNC(void, InterpreterRuntime::monitorexit(JavaThread* thread, BasicObjectLock* elem))
 785 #ifdef ASSERT
 786   thread-&gt;last_frame().interpreter_frame_verify_monitor(elem);
 787 #endif
 788   Handle h_obj(thread, elem-&gt;obj());
 789   assert(Universe::heap()-&gt;is_in_or_null(h_obj()),
 790          &quot;must be NULL or an object&quot;);
 791   if (elem == NULL || h_obj()-&gt;is_unlocked()) {
 792     THROW(vmSymbols::java_lang_IllegalMonitorStateException());
 793   }
 794   ObjectSynchronizer::exit(h_obj(), elem-&gt;lock(), thread);
 795   // Free entry. This must be done here, since a pending exception might be installed on
 796   // exit. If it is not cleared, the exception handling code will try to unlock the monitor again.
 797   elem-&gt;set_obj(NULL);
 798 #ifdef ASSERT
 799   thread-&gt;last_frame().interpreter_frame_verify_monitor(elem);
 800 #endif
 801 JRT_END
 802 
 803 
 804 JRT_ENTRY(void, InterpreterRuntime::throw_illegal_monitor_state_exception(JavaThread* thread))
 805   THROW(vmSymbols::java_lang_IllegalMonitorStateException());
 806 JRT_END
 807 
 808 
 809 JRT_ENTRY(void, InterpreterRuntime::new_illegal_monitor_state_exception(JavaThread* thread))
 810   // Returns an illegal exception to install into the current thread. The
 811   // pending_exception flag is cleared so normal exception handling does not
 812   // trigger. Any current installed exception will be overwritten. This
 813   // method will be called during an exception unwind.
 814 
 815   assert(!HAS_PENDING_EXCEPTION, &quot;no pending exception&quot;);
 816   Handle exception(thread, thread-&gt;vm_result());
 817   assert(exception() != NULL, &quot;vm result should be set&quot;);
 818   thread-&gt;set_vm_result(NULL); // clear vm result before continuing (may cause memory leaks and assert failures)
 819   if (!exception-&gt;is_a(SystemDictionary::ThreadDeath_klass())) {
 820     exception = get_preinitialized_exception(
 821                        SystemDictionary::IllegalMonitorStateException_klass(),
 822                        CATCH);
 823   }
 824   thread-&gt;set_vm_result(exception());
 825 JRT_END
 826 
 827 
 828 //------------------------------------------------------------------------------------------------------------------------
 829 // Invokes
 830 
 831 JRT_ENTRY(Bytecodes::Code, InterpreterRuntime::get_original_bytecode_at(JavaThread* thread, Method* method, address bcp))
 832   return method-&gt;orig_bytecode_at(method-&gt;bci_from(bcp));
 833 JRT_END
 834 
 835 JRT_ENTRY(void, InterpreterRuntime::set_original_bytecode_at(JavaThread* thread, Method* method, address bcp, Bytecodes::Code new_code))
 836   method-&gt;set_orig_bytecode_at(method-&gt;bci_from(bcp), new_code);
 837 JRT_END
 838 
 839 JRT_ENTRY(void, InterpreterRuntime::_breakpoint(JavaThread* thread, Method* method, address bcp))
 840   JvmtiExport::post_raw_breakpoint(thread, method, bcp);
 841 JRT_END
 842 
 843 void InterpreterRuntime::resolve_invoke(JavaThread* thread, Bytecodes::Code bytecode) {
 844   Thread* THREAD = thread;
 845   LastFrameAccessor last_frame(thread);
 846   // extract receiver from the outgoing argument list if necessary
 847   Handle receiver(thread, NULL);
 848   if (bytecode == Bytecodes::_invokevirtual || bytecode == Bytecodes::_invokeinterface ||
 849       bytecode == Bytecodes::_invokespecial) {
 850     ResourceMark rm(thread);
 851     methodHandle m (thread, last_frame.method());
 852     Bytecode_invoke call(m, last_frame.bci());
 853     Symbol* signature = call.signature();
 854     receiver = Handle(thread, last_frame.callee_receiver(signature));
 855 
 856     assert(Universe::heap()-&gt;is_in_or_null(receiver()),
 857            &quot;sanity check&quot;);
 858     assert(receiver.is_null() ||
 859            !Universe::heap()-&gt;is_in(receiver-&gt;klass()),
 860            &quot;sanity check&quot;);
 861   }
 862 
 863   // resolve method
 864   CallInfo info;
 865   constantPoolHandle pool(thread, last_frame.method()-&gt;constants());
 866 
 867   {
 868     JvmtiHideSingleStepping jhss(thread);
 869     LinkResolver::resolve_invoke(info, receiver, pool,
 870                                  last_frame.get_index_u2_cpcache(bytecode), bytecode,
 871                                  CHECK);
 872     if (JvmtiExport::can_hotswap_or_post_breakpoint()) {
 873       int retry_count = 0;
 874       while (info.resolved_method()-&gt;is_old()) {
 875         // It is very unlikely that method is redefined more than 100 times
 876         // in the middle of resolve. If it is looping here more than 100 times
 877         // means then there could be a bug here.
 878         guarantee((retry_count++ &lt; 100),
 879                   &quot;Could not resolve to latest version of redefined method&quot;);
 880         // method is redefined in the middle of resolve so re-try.
 881         LinkResolver::resolve_invoke(info, receiver, pool,
 882                                      last_frame.get_index_u2_cpcache(bytecode), bytecode,
 883                                      CHECK);
 884       }
 885     }
 886   } // end JvmtiHideSingleStepping
 887 
 888   // check if link resolution caused cpCache to be updated
 889   ConstantPoolCacheEntry* cp_cache_entry = last_frame.cache_entry();
 890   if (cp_cache_entry-&gt;is_resolved(bytecode)) return;
 891 
 892 #ifdef ASSERT
 893   if (bytecode == Bytecodes::_invokeinterface) {
 894     if (info.resolved_method()-&gt;method_holder() ==
 895                                             SystemDictionary::Object_klass()) {
 896       // NOTE: THIS IS A FIX FOR A CORNER CASE in the JVM spec
 897       // (see also CallInfo::set_interface for details)
 898       assert(info.call_kind() == CallInfo::vtable_call ||
 899              info.call_kind() == CallInfo::direct_call, &quot;&quot;);
 900       Method* rm = info.resolved_method();
 901       assert(rm-&gt;is_final() || info.has_vtable_index(),
 902              &quot;should have been set already&quot;);
 903     } else if (!info.resolved_method()-&gt;has_itable_index()) {
 904       // Resolved something like CharSequence.toString.  Use vtable not itable.
 905       assert(info.call_kind() != CallInfo::itable_call, &quot;&quot;);
 906     } else {
 907       // Setup itable entry
 908       assert(info.call_kind() == CallInfo::itable_call, &quot;&quot;);
 909       int index = info.resolved_method()-&gt;itable_index();
 910       assert(info.itable_index() == index, &quot;&quot;);
 911     }
 912   } else if (bytecode == Bytecodes::_invokespecial) {
 913     assert(info.call_kind() == CallInfo::direct_call, &quot;must be direct call&quot;);
 914   } else {
 915     assert(info.call_kind() == CallInfo::direct_call ||
 916            info.call_kind() == CallInfo::vtable_call, &quot;&quot;);
 917   }
 918 #endif
 919   // Get sender or sender&#39;s unsafe_anonymous_host, and only set cpCache entry to resolved if
 920   // it is not an interface.  The receiver for invokespecial calls within interface
 921   // methods must be checked for every call.
 922   InstanceKlass* sender = pool-&gt;pool_holder();
 923   sender = sender-&gt;is_unsafe_anonymous() ? sender-&gt;unsafe_anonymous_host() : sender;
 924   methodHandle resolved_method(THREAD, info.resolved_method());
 925 
 926   switch (info.call_kind()) {
 927   case CallInfo::direct_call:
 928     cp_cache_entry-&gt;set_direct_call(
 929       bytecode,
 930       resolved_method,
 931       sender-&gt;is_interface());
 932     break;
 933   case CallInfo::vtable_call:
 934     cp_cache_entry-&gt;set_vtable_call(
 935       bytecode,
 936       resolved_method,
 937       info.vtable_index());
 938     break;
 939   case CallInfo::itable_call:
 940     cp_cache_entry-&gt;set_itable_call(
 941       bytecode,
 942       info.resolved_klass(),
 943       resolved_method,
 944       info.itable_index());
 945     break;
 946   default:  ShouldNotReachHere();
 947   }
 948 }
 949 
 950 
 951 // First time execution:  Resolve symbols, create a permanent MethodType object.
 952 void InterpreterRuntime::resolve_invokehandle(JavaThread* thread) {
 953   Thread* THREAD = thread;
 954   const Bytecodes::Code bytecode = Bytecodes::_invokehandle;
 955   LastFrameAccessor last_frame(thread);
 956 
 957   // resolve method
 958   CallInfo info;
 959   constantPoolHandle pool(thread, last_frame.method()-&gt;constants());
 960   {
 961     JvmtiHideSingleStepping jhss(thread);
 962     LinkResolver::resolve_invoke(info, Handle(), pool,
 963                                  last_frame.get_index_u2_cpcache(bytecode), bytecode,
 964                                  CHECK);
 965   } // end JvmtiHideSingleStepping
 966 
 967   ConstantPoolCacheEntry* cp_cache_entry = last_frame.cache_entry();
 968   cp_cache_entry-&gt;set_method_handle(pool, info);
 969 }
 970 
 971 // First time execution:  Resolve symbols, create a permanent CallSite object.
 972 void InterpreterRuntime::resolve_invokedynamic(JavaThread* thread) {
 973   Thread* THREAD = thread;
 974   LastFrameAccessor last_frame(thread);
 975   const Bytecodes::Code bytecode = Bytecodes::_invokedynamic;
 976 
 977   // resolve method
 978   CallInfo info;
 979   constantPoolHandle pool(thread, last_frame.method()-&gt;constants());
 980   int index = last_frame.get_index_u4(bytecode);
 981   {
 982     JvmtiHideSingleStepping jhss(thread);
 983     LinkResolver::resolve_invoke(info, Handle(), pool,
 984                                  index, bytecode, CHECK);
 985   } // end JvmtiHideSingleStepping
 986 
 987   ConstantPoolCacheEntry* cp_cache_entry = pool-&gt;invokedynamic_cp_cache_entry_at(index);
 988   cp_cache_entry-&gt;set_dynamic_call(pool, info);
 989 }
 990 
 991 // This function is the interface to the assembly code. It returns the resolved
 992 // cpCache entry.  This doesn&#39;t safepoint, but the helper routines safepoint.
 993 // This function will check for redefinition!
 994 JRT_ENTRY(void, InterpreterRuntime::resolve_from_cache(JavaThread* thread, Bytecodes::Code bytecode)) {
 995   switch (bytecode) {
 996   case Bytecodes::_getstatic:
 997   case Bytecodes::_putstatic:
 998   case Bytecodes::_getfield:
 999   case Bytecodes::_putfield:
1000     resolve_get_put(thread, bytecode);
1001     break;
1002   case Bytecodes::_invokevirtual:
1003   case Bytecodes::_invokespecial:
1004   case Bytecodes::_invokestatic:
1005   case Bytecodes::_invokeinterface:
1006     resolve_invoke(thread, bytecode);
1007     break;
1008   case Bytecodes::_invokehandle:
1009     resolve_invokehandle(thread);
1010     break;
1011   case Bytecodes::_invokedynamic:
1012     resolve_invokedynamic(thread);
1013     break;
1014   default:
1015     fatal(&quot;unexpected bytecode: %s&quot;, Bytecodes::name(bytecode));
1016     break;
1017   }
1018 }
1019 JRT_END
1020 
1021 //------------------------------------------------------------------------------------------------------------------------
1022 // Miscellaneous
1023 
1024 
1025 nmethod* InterpreterRuntime::frequency_counter_overflow(JavaThread* thread, address branch_bcp) {
1026   nmethod* nm = frequency_counter_overflow_inner(thread, branch_bcp);
1027   assert(branch_bcp != NULL || nm == NULL, &quot;always returns null for non OSR requests&quot;);
1028   if (branch_bcp != NULL &amp;&amp; nm != NULL) {
1029     // This was a successful request for an OSR nmethod.  Because
1030     // frequency_counter_overflow_inner ends with a safepoint check,
1031     // nm could have been unloaded so look it up again.  It&#39;s unsafe
1032     // to examine nm directly since it might have been freed and used
1033     // for something else.
1034     LastFrameAccessor last_frame(thread);
1035     Method* method =  last_frame.method();
1036     int bci = method-&gt;bci_from(last_frame.bcp());
1037     nm = method-&gt;lookup_osr_nmethod_for(bci, CompLevel_none, false);
1038     BarrierSetNMethod* bs_nm = BarrierSet::barrier_set()-&gt;barrier_set_nmethod();
1039     if (nm != NULL &amp;&amp; bs_nm != NULL) {
1040       // in case the transition passed a safepoint we need to barrier this again
1041       if (!bs_nm-&gt;nmethod_osr_entry_barrier(nm)) {
1042         nm = NULL;
1043       }
1044     }
1045   }
1046   if (nm != NULL &amp;&amp; thread-&gt;is_interp_only_mode()) {
1047     // Normally we never get an nm if is_interp_only_mode() is true, because
1048     // policy()-&gt;event has a check for this and won&#39;t compile the method when
1049     // true. However, it&#39;s possible for is_interp_only_mode() to become true
1050     // during the compilation. We don&#39;t want to return the nm in that case
1051     // because we want to continue to execute interpreted.
1052     nm = NULL;
1053   }
1054 #ifndef PRODUCT
1055   if (TraceOnStackReplacement) {
1056     if (nm != NULL) {
1057       tty-&gt;print(&quot;OSR entry @ pc: &quot; INTPTR_FORMAT &quot;: &quot;, p2i(nm-&gt;osr_entry()));
1058       nm-&gt;print();
1059     }
1060   }
1061 #endif
1062   return nm;
1063 }
1064 
1065 JRT_ENTRY(nmethod*,
1066           InterpreterRuntime::frequency_counter_overflow_inner(JavaThread* thread, address branch_bcp))
1067   // use UnlockFlagSaver to clear and restore the _do_not_unlock_if_synchronized
1068   // flag, in case this method triggers classloading which will call into Java.
1069   UnlockFlagSaver fs(thread);
1070 
1071   LastFrameAccessor last_frame(thread);
1072   assert(last_frame.is_interpreted_frame(), &quot;must come from interpreter&quot;);
1073   methodHandle method(thread, last_frame.method());
1074   const int branch_bci = branch_bcp != NULL ? method-&gt;bci_from(branch_bcp) : InvocationEntryBci;
1075   const int bci = branch_bcp != NULL ? method-&gt;bci_from(last_frame.bcp()) : InvocationEntryBci;
1076 
1077   assert(!HAS_PENDING_EXCEPTION, &quot;Should not have any exceptions pending&quot;);
1078   nmethod* osr_nm = CompilationPolicy::policy()-&gt;event(method, method, branch_bci, bci, CompLevel_none, NULL, thread);
1079   assert(!HAS_PENDING_EXCEPTION, &quot;Event handler should not throw any exceptions&quot;);
1080 
1081   BarrierSetNMethod* bs_nm = BarrierSet::barrier_set()-&gt;barrier_set_nmethod();
1082   if (osr_nm != NULL &amp;&amp; bs_nm != NULL) {
1083     if (!bs_nm-&gt;nmethod_osr_entry_barrier(osr_nm)) {
1084       osr_nm = NULL;
1085     }
1086   }
1087 
1088   if (osr_nm != NULL) {
1089     // We may need to do on-stack replacement which requires that no
1090     // monitors in the activation are biased because their
1091     // BasicObjectLocks will need to migrate during OSR. Force
1092     // unbiasing of all monitors in the activation now (even though
1093     // the OSR nmethod might be invalidated) because we don&#39;t have a
1094     // safepoint opportunity later once the migration begins.
1095     if (UseBiasedLocking) {
1096       ResourceMark rm;
1097       GrowableArray&lt;Handle&gt;* objects_to_revoke = new GrowableArray&lt;Handle&gt;();
1098       for( BasicObjectLock *kptr = last_frame.monitor_end();
1099            kptr &lt; last_frame.monitor_begin();
1100            kptr = last_frame.next_monitor(kptr) ) {
1101         if( kptr-&gt;obj() != NULL ) {
1102           objects_to_revoke-&gt;append(Handle(THREAD, kptr-&gt;obj()));
1103         }
1104       }
1105       BiasedLocking::revoke(objects_to_revoke, thread);
1106     }
1107   }
1108   return osr_nm;
1109 JRT_END
1110 
1111 JRT_LEAF(jint, InterpreterRuntime::bcp_to_di(Method* method, address cur_bcp))
1112   assert(ProfileInterpreter, &quot;must be profiling interpreter&quot;);
1113   int bci = method-&gt;bci_from(cur_bcp);
1114   MethodData* mdo = method-&gt;method_data();
1115   if (mdo == NULL)  return 0;
1116   return mdo-&gt;bci_to_di(bci);
1117 JRT_END
1118 
1119 JRT_ENTRY(void, InterpreterRuntime::profile_method(JavaThread* thread))
1120   // use UnlockFlagSaver to clear and restore the _do_not_unlock_if_synchronized
1121   // flag, in case this method triggers classloading which will call into Java.
1122   UnlockFlagSaver fs(thread);
1123 
1124   assert(ProfileInterpreter, &quot;must be profiling interpreter&quot;);
1125   LastFrameAccessor last_frame(thread);
1126   assert(last_frame.is_interpreted_frame(), &quot;must come from interpreter&quot;);
1127   methodHandle method(thread, last_frame.method());
1128   Method::build_interpreter_method_data(method, THREAD);
1129   if (HAS_PENDING_EXCEPTION) {
1130     assert((PENDING_EXCEPTION-&gt;is_a(SystemDictionary::OutOfMemoryError_klass())), &quot;we expect only an OOM error here&quot;);
1131     CLEAR_PENDING_EXCEPTION;
1132     // and fall through...
1133   }
1134 JRT_END
1135 
1136 
1137 #ifdef ASSERT
1138 JRT_LEAF(void, InterpreterRuntime::verify_mdp(Method* method, address bcp, address mdp))
1139   assert(ProfileInterpreter, &quot;must be profiling interpreter&quot;);
1140 
1141   MethodData* mdo = method-&gt;method_data();
1142   assert(mdo != NULL, &quot;must not be null&quot;);
1143 
1144   int bci = method-&gt;bci_from(bcp);
1145 
1146   address mdp2 = mdo-&gt;bci_to_dp(bci);
1147   if (mdp != mdp2) {
1148     ResourceMark rm;
1149     ResetNoHandleMark rnm; // In a LEAF entry.
1150     HandleMark hm;
1151     tty-&gt;print_cr(&quot;FAILED verify : actual mdp %p   expected mdp %p @ bci %d&quot;, mdp, mdp2, bci);
1152     int current_di = mdo-&gt;dp_to_di(mdp);
1153     int expected_di  = mdo-&gt;dp_to_di(mdp2);
1154     tty-&gt;print_cr(&quot;  actual di %d   expected di %d&quot;, current_di, expected_di);
1155     int expected_approx_bci = mdo-&gt;data_at(expected_di)-&gt;bci();
1156     int approx_bci = -1;
1157     if (current_di &gt;= 0) {
1158       approx_bci = mdo-&gt;data_at(current_di)-&gt;bci();
1159     }
1160     tty-&gt;print_cr(&quot;  actual bci is %d  expected bci %d&quot;, approx_bci, expected_approx_bci);
1161     mdo-&gt;print_on(tty);
1162     method-&gt;print_codes();
1163   }
1164   assert(mdp == mdp2, &quot;wrong mdp&quot;);
1165 JRT_END
1166 #endif // ASSERT
1167 
1168 JRT_ENTRY(void, InterpreterRuntime::update_mdp_for_ret(JavaThread* thread, int return_bci))
1169   assert(ProfileInterpreter, &quot;must be profiling interpreter&quot;);
1170   ResourceMark rm(thread);
1171   HandleMark hm(thread);
1172   LastFrameAccessor last_frame(thread);
1173   assert(last_frame.is_interpreted_frame(), &quot;must come from interpreter&quot;);
1174   MethodData* h_mdo = last_frame.method()-&gt;method_data();
1175 
1176   // Grab a lock to ensure atomic access to setting the return bci and
1177   // the displacement.  This can block and GC, invalidating all naked oops.
1178   MutexLocker ml(RetData_lock);
1179 
1180   // ProfileData is essentially a wrapper around a derived oop, so we
1181   // need to take the lock before making any ProfileData structures.
1182   ProfileData* data = h_mdo-&gt;data_at(h_mdo-&gt;dp_to_di(last_frame.mdp()));
1183   guarantee(data != NULL, &quot;profile data must be valid&quot;);
1184   RetData* rdata = data-&gt;as_RetData();
1185   address new_mdp = rdata-&gt;fixup_ret(return_bci, h_mdo);
1186   last_frame.set_mdp(new_mdp);
1187 JRT_END
1188 
1189 JRT_ENTRY(MethodCounters*, InterpreterRuntime::build_method_counters(JavaThread* thread, Method* m))
1190   MethodCounters* mcs = Method::build_method_counters(m, thread);
1191   if (HAS_PENDING_EXCEPTION) {
1192     assert((PENDING_EXCEPTION-&gt;is_a(SystemDictionary::OutOfMemoryError_klass())), &quot;we expect only an OOM error here&quot;);
1193     CLEAR_PENDING_EXCEPTION;
1194   }
1195   return mcs;
1196 JRT_END
1197 
1198 
1199 JRT_ENTRY(void, InterpreterRuntime::at_safepoint(JavaThread* thread))
1200   // We used to need an explict preserve_arguments here for invoke bytecodes. However,
1201   // stack traversal automatically takes care of preserving arguments for invoke, so
1202   // this is no longer needed.
1203 
1204   // JRT_END does an implicit safepoint check, hence we are guaranteed to block
1205   // if this is called during a safepoint
1206 
1207   if (JvmtiExport::should_post_single_step()) {
1208     // We are called during regular safepoints and when the VM is
1209     // single stepping. If any thread is marked for single stepping,
1210     // then we may have JVMTI work to do.
1211     LastFrameAccessor last_frame(thread);
1212     JvmtiExport::at_single_stepping_point(thread, last_frame.method(), last_frame.bcp());
1213   }
1214 JRT_END
1215 
1216 JRT_ENTRY(void, InterpreterRuntime::post_field_access(JavaThread *thread, oopDesc* obj,
1217 ConstantPoolCacheEntry *cp_entry))
1218 
1219   // check the access_flags for the field in the klass
1220 
1221   InstanceKlass* ik = InstanceKlass::cast(cp_entry-&gt;f1_as_klass());
1222   int index = cp_entry-&gt;field_index();
1223   if ((ik-&gt;field_access_flags(index) &amp; JVM_ACC_FIELD_ACCESS_WATCHED) == 0) return;
1224 
1225   bool is_static = (obj == NULL);
1226   HandleMark hm(thread);
1227 
1228   Handle h_obj;
1229   if (!is_static) {
1230     // non-static field accessors have an object, but we need a handle
1231     h_obj = Handle(thread, obj);
1232   }
1233   InstanceKlass* cp_entry_f1 = InstanceKlass::cast(cp_entry-&gt;f1_as_klass());
1234   jfieldID fid = jfieldIDWorkaround::to_jfieldID(cp_entry_f1, cp_entry-&gt;f2_as_index(), is_static);
1235   LastFrameAccessor last_frame(thread);
1236   JvmtiExport::post_field_access(thread, last_frame.method(), last_frame.bcp(), cp_entry_f1, h_obj, fid);
1237 JRT_END
1238 
1239 JRT_ENTRY(void, InterpreterRuntime::post_field_modification(JavaThread *thread,
1240   oopDesc* obj, ConstantPoolCacheEntry *cp_entry, jvalue *value))
1241 
1242   Klass* k = cp_entry-&gt;f1_as_klass();
1243 
1244   // check the access_flags for the field in the klass
1245   InstanceKlass* ik = InstanceKlass::cast(k);
1246   int index = cp_entry-&gt;field_index();
1247   // bail out if field modifications are not watched
1248   if ((ik-&gt;field_access_flags(index) &amp; JVM_ACC_FIELD_MODIFICATION_WATCHED) == 0) return;
1249 
1250   char sig_type = &#39;\0&#39;;
1251 
1252   switch(cp_entry-&gt;flag_state()) {
1253     case btos: sig_type = JVM_SIGNATURE_BYTE;    break;
1254     case ztos: sig_type = JVM_SIGNATURE_BOOLEAN; break;
1255     case ctos: sig_type = JVM_SIGNATURE_CHAR;    break;
1256     case stos: sig_type = JVM_SIGNATURE_SHORT;   break;
1257     case itos: sig_type = JVM_SIGNATURE_INT;     break;
1258     case ftos: sig_type = JVM_SIGNATURE_FLOAT;   break;
1259     case atos: sig_type = JVM_SIGNATURE_CLASS;   break;
1260     case ltos: sig_type = JVM_SIGNATURE_LONG;    break;
1261     case dtos: sig_type = JVM_SIGNATURE_DOUBLE;  break;
1262     default:  ShouldNotReachHere(); return;
1263   }
1264   bool is_static = (obj == NULL);
1265 
1266   HandleMark hm(thread);
1267   jfieldID fid = jfieldIDWorkaround::to_jfieldID(ik, cp_entry-&gt;f2_as_index(), is_static);
1268   jvalue fvalue;
1269 #ifdef _LP64
1270   fvalue = *value;
1271 #else
1272   // Long/double values are stored unaligned and also noncontiguously with
1273   // tagged stacks.  We can&#39;t just do a simple assignment even in the non-
1274   // J/D cases because a C++ compiler is allowed to assume that a jvalue is
1275   // 8-byte aligned, and interpreter stack slots are only 4-byte aligned.
1276   // We assume that the two halves of longs/doubles are stored in interpreter
1277   // stack slots in platform-endian order.
1278   jlong_accessor u;
1279   jint* newval = (jint*)value;
1280   u.words[0] = newval[0];
1281   u.words[1] = newval[Interpreter::stackElementWords]; // skip if tag
1282   fvalue.j = u.long_value;
1283 #endif // _LP64
1284 
1285   Handle h_obj;
1286   if (!is_static) {
1287     // non-static field accessors have an object, but we need a handle
1288     h_obj = Handle(thread, obj);
1289   }
1290 
1291   LastFrameAccessor last_frame(thread);
1292   JvmtiExport::post_raw_field_modification(thread, last_frame.method(), last_frame.bcp(), ik, h_obj,
1293                                            fid, sig_type, &amp;fvalue);
1294 JRT_END
1295 
1296 JRT_ENTRY(void, InterpreterRuntime::post_method_entry(JavaThread *thread))
1297   LastFrameAccessor last_frame(thread);
1298   JvmtiExport::post_method_entry(thread, last_frame.method(), last_frame.get_frame());
1299 JRT_END
1300 
1301 
1302 JRT_ENTRY(void, InterpreterRuntime::post_method_exit(JavaThread *thread))
1303   LastFrameAccessor last_frame(thread);
1304   JvmtiExport::post_method_exit(thread, last_frame.method(), last_frame.get_frame());
1305 JRT_END
1306 
1307 JRT_LEAF(int, InterpreterRuntime::interpreter_contains(address pc))
1308 {
1309   return (Interpreter::contains(pc) ? 1 : 0);
1310 }
1311 JRT_END
1312 
1313 
1314 // Implementation of SignatureHandlerLibrary
1315 
1316 #ifndef SHARING_FAST_NATIVE_FINGERPRINTS
1317 // Dummy definition (else normalization method is defined in CPU
1318 // dependant code)
1319 uint64_t InterpreterRuntime::normalize_fast_native_fingerprint(uint64_t fingerprint) {
1320   return fingerprint;
1321 }
1322 #endif
1323 
1324 address SignatureHandlerLibrary::set_handler_blob() {
1325   BufferBlob* handler_blob = BufferBlob::create(&quot;native signature handlers&quot;, blob_size);
1326   if (handler_blob == NULL) {
1327     return NULL;
1328   }
1329   address handler = handler_blob-&gt;code_begin();
1330   _handler_blob = handler_blob;
1331   _handler = handler;
1332   return handler;
1333 }
1334 
1335 void SignatureHandlerLibrary::initialize() {
1336   if (_fingerprints != NULL) {
1337     return;
1338   }
1339   if (set_handler_blob() == NULL) {
1340     vm_exit_out_of_memory(blob_size, OOM_MALLOC_ERROR, &quot;native signature handlers&quot;);
1341   }
1342 
1343   BufferBlob* bb = BufferBlob::create(&quot;Signature Handler Temp Buffer&quot;,
1344                                       SignatureHandlerLibrary::buffer_size);
1345   _buffer = bb-&gt;code_begin();
1346 
1347   _fingerprints = new(ResourceObj::C_HEAP, mtCode)GrowableArray&lt;uint64_t&gt;(32, true);
1348   _handlers     = new(ResourceObj::C_HEAP, mtCode)GrowableArray&lt;address&gt;(32, true);
1349 }
1350 
1351 address SignatureHandlerLibrary::set_handler(CodeBuffer* buffer) {
1352   address handler   = _handler;
1353   int     insts_size = buffer-&gt;pure_insts_size();
1354   if (handler + insts_size &gt; _handler_blob-&gt;code_end()) {
1355     // get a new handler blob
1356     handler = set_handler_blob();
1357   }
1358   if (handler != NULL) {
1359     memcpy(handler, buffer-&gt;insts_begin(), insts_size);
1360     pd_set_handler(handler);
1361     ICache::invalidate_range(handler, insts_size);
1362     _handler = handler + insts_size;
1363   }
1364   return handler;
1365 }
1366 
1367 void SignatureHandlerLibrary::add(const methodHandle&amp; method) {
1368   if (method-&gt;signature_handler() == NULL) {
1369     // use slow signature handler if we can&#39;t do better
1370     int handler_index = -1;
1371     // check if we can use customized (fast) signature handler
<a name="2" id="anc2"></a><span class="line-modified">1372     if (UseFastSignatureHandlers &amp;&amp; method-&gt;size_of_parameters() &lt;= Fingerprinter::max_size_of_parameters) {</span>
1373       // use customized signature handler
1374       MutexLocker mu(SignatureHandlerLibrary_lock);
1375       // make sure data structure is initialized
1376       initialize();
1377       // lookup method signature&#39;s fingerprint
1378       uint64_t fingerprint = Fingerprinter(method).fingerprint();
1379       // allow CPU dependant code to optimize the fingerprints for the fast handler
1380       fingerprint = InterpreterRuntime::normalize_fast_native_fingerprint(fingerprint);
1381       handler_index = _fingerprints-&gt;find(fingerprint);
1382       // create handler if necessary
1383       if (handler_index &lt; 0) {
1384         ResourceMark rm;
1385         ptrdiff_t align_offset = align_up(_buffer, CodeEntryAlignment) - (address)_buffer;
1386         CodeBuffer buffer((address)(_buffer + align_offset),
1387                           SignatureHandlerLibrary::buffer_size - align_offset);
1388         InterpreterRuntime::SignatureHandlerGenerator(method, &amp;buffer).generate(fingerprint);
1389         // copy into code heap
1390         address handler = set_handler(&amp;buffer);
1391         if (handler == NULL) {
1392           // use slow signature handler (without memorizing it in the fingerprints)
1393         } else {
1394           // debugging suppport
1395           if (PrintSignatureHandlers &amp;&amp; (handler != Interpreter::slow_signature_handler())) {
1396             ttyLocker ttyl;
1397             tty-&gt;cr();
1398             tty-&gt;print_cr(&quot;argument handler #%d for: %s %s (fingerprint = &quot; UINT64_FORMAT &quot;, %d bytes generated)&quot;,
1399                           _handlers-&gt;length(),
1400                           (method-&gt;is_static() ? &quot;static&quot; : &quot;receiver&quot;),
1401                           method-&gt;name_and_sig_as_C_string(),
1402                           fingerprint,
1403                           buffer.insts_size());
1404             if (buffer.insts_size() &gt; 0) {
1405               Disassembler::decode(handler, handler + buffer.insts_size());
1406             }
1407 #ifndef PRODUCT
1408             address rh_begin = Interpreter::result_handler(method()-&gt;result_type());
1409             if (CodeCache::contains(rh_begin)) {
1410               // else it might be special platform dependent values
1411               tty-&gt;print_cr(&quot; --- associated result handler ---&quot;);
1412               address rh_end = rh_begin;
1413               while (*(int*)rh_end != 0) {
1414                 rh_end += sizeof(int);
1415               }
1416               Disassembler::decode(rh_begin, rh_end);
1417             } else {
1418               tty-&gt;print_cr(&quot; associated result handler: &quot; PTR_FORMAT, p2i(rh_begin));
1419             }
1420 #endif
1421           }
1422           // add handler to library
1423           _fingerprints-&gt;append(fingerprint);
1424           _handlers-&gt;append(handler);
1425           // set handler index
1426           assert(_fingerprints-&gt;length() == _handlers-&gt;length(), &quot;sanity check&quot;);
1427           handler_index = _fingerprints-&gt;length() - 1;
1428         }
1429       }
1430       // Set handler under SignatureHandlerLibrary_lock
1431       if (handler_index &lt; 0) {
1432         // use generic signature handler
1433         method-&gt;set_signature_handler(Interpreter::slow_signature_handler());
1434       } else {
1435         // set handler
1436         method-&gt;set_signature_handler(_handlers-&gt;at(handler_index));
1437       }
1438     } else {
1439       DEBUG_ONLY(Thread::current()-&gt;check_possible_safepoint());
1440       // use generic signature handler
1441       method-&gt;set_signature_handler(Interpreter::slow_signature_handler());
1442     }
1443   }
1444 #ifdef ASSERT
1445   int handler_index = -1;
1446   int fingerprint_index = -2;
1447   {
1448     // &#39;_handlers&#39; and &#39;_fingerprints&#39; are &#39;GrowableArray&#39;s and are NOT synchronized
1449     // in any way if accessed from multiple threads. To avoid races with another
1450     // thread which may change the arrays in the above, mutex protected block, we
1451     // have to protect this read access here with the same mutex as well!
1452     MutexLocker mu(SignatureHandlerLibrary_lock);
1453     if (_handlers != NULL) {
1454       handler_index = _handlers-&gt;find(method-&gt;signature_handler());
1455       uint64_t fingerprint = Fingerprinter(method).fingerprint();
1456       fingerprint = InterpreterRuntime::normalize_fast_native_fingerprint(fingerprint);
1457       fingerprint_index = _fingerprints-&gt;find(fingerprint);
1458     }
1459   }
1460   assert(method-&gt;signature_handler() == Interpreter::slow_signature_handler() ||
1461          handler_index == fingerprint_index, &quot;sanity check&quot;);
1462 #endif // ASSERT
1463 }
1464 
1465 void SignatureHandlerLibrary::add(uint64_t fingerprint, address handler) {
1466   int handler_index = -1;
1467   // use customized signature handler
1468   MutexLocker mu(SignatureHandlerLibrary_lock);
1469   // make sure data structure is initialized
1470   initialize();
1471   fingerprint = InterpreterRuntime::normalize_fast_native_fingerprint(fingerprint);
1472   handler_index = _fingerprints-&gt;find(fingerprint);
1473   // create handler if necessary
1474   if (handler_index &lt; 0) {
1475     if (PrintSignatureHandlers &amp;&amp; (handler != Interpreter::slow_signature_handler())) {
1476       tty-&gt;cr();
1477       tty-&gt;print_cr(&quot;argument handler #%d at &quot; PTR_FORMAT &quot; for fingerprint &quot; UINT64_FORMAT,
1478                     _handlers-&gt;length(),
1479                     p2i(handler),
1480                     fingerprint);
1481     }
1482     _fingerprints-&gt;append(fingerprint);
1483     _handlers-&gt;append(handler);
1484   } else {
1485     if (PrintSignatureHandlers) {
1486       tty-&gt;cr();
1487       tty-&gt;print_cr(&quot;duplicate argument handler #%d for fingerprint &quot; UINT64_FORMAT &quot;(old: &quot; PTR_FORMAT &quot;, new : &quot; PTR_FORMAT &quot;)&quot;,
1488                     _handlers-&gt;length(),
1489                     fingerprint,
1490                     p2i(_handlers-&gt;at(handler_index)),
1491                     p2i(handler));
1492     }
1493   }
1494 }
1495 
1496 
1497 BufferBlob*              SignatureHandlerLibrary::_handler_blob = NULL;
1498 address                  SignatureHandlerLibrary::_handler      = NULL;
1499 GrowableArray&lt;uint64_t&gt;* SignatureHandlerLibrary::_fingerprints = NULL;
1500 GrowableArray&lt;address&gt;*  SignatureHandlerLibrary::_handlers     = NULL;
1501 address                  SignatureHandlerLibrary::_buffer       = NULL;
1502 
1503 
1504 JRT_ENTRY(void, InterpreterRuntime::prepare_native_call(JavaThread* thread, Method* method))
1505   methodHandle m(thread, method);
1506   assert(m-&gt;is_native(), &quot;sanity check&quot;);
1507   // lookup native function entry point if it doesn&#39;t exist
1508   bool in_base_library;
1509   if (!m-&gt;has_native_function()) {
1510     NativeLookup::lookup(m, in_base_library, CHECK);
1511   }
1512   // make sure signature handler is installed
1513   SignatureHandlerLibrary::add(m);
1514   // The interpreter entry point checks the signature handler first,
1515   // before trying to fetch the native entry point and klass mirror.
1516   // We must set the signature handler last, so that multiple processors
1517   // preparing the same method will be sure to see non-null entry &amp; mirror.
1518 JRT_END
1519 
1520 #if defined(IA32) || defined(AMD64) || defined(ARM)
1521 JRT_LEAF(void, InterpreterRuntime::popframe_move_outgoing_args(JavaThread* thread, void* src_address, void* dest_address))
1522   if (src_address == dest_address) {
1523     return;
1524   }
1525   ResetNoHandleMark rnm; // In a LEAF entry.
1526   HandleMark hm;
1527   ResourceMark rm;
1528   LastFrameAccessor last_frame(thread);
1529   assert(last_frame.is_interpreted_frame(), &quot;&quot;);
1530   jint bci = last_frame.bci();
1531   methodHandle mh(thread, last_frame.method());
1532   Bytecode_invoke invoke(mh, bci);
1533   ArgumentSizeComputer asc(invoke.signature());
1534   int size_of_arguments = (asc.size() + (invoke.has_receiver() ? 1 : 0)); // receiver
1535   Copy::conjoint_jbytes(src_address, dest_address,
1536                        size_of_arguments * Interpreter::stackElementSize);
1537 JRT_END
1538 #endif
1539 
1540 #if INCLUDE_JVMTI
1541 // This is a support of the JVMTI PopFrame interface.
1542 // Make sure it is an invokestatic of a polymorphic intrinsic that has a member_name argument
1543 // and return it as a vm_result so that it can be reloaded in the list of invokestatic parameters.
1544 // The member_name argument is a saved reference (in local#0) to the member_name.
1545 // For backward compatibility with some JDK versions (7, 8) it can also be a direct method handle.
1546 // FIXME: remove DMH case after j.l.i.InvokerBytecodeGenerator code shape is updated.
1547 JRT_ENTRY(void, InterpreterRuntime::member_name_arg_or_null(JavaThread* thread, address member_name,
1548                                                             Method* method, address bcp))
1549   Bytecodes::Code code = Bytecodes::code_at(method, bcp);
1550   if (code != Bytecodes::_invokestatic) {
1551     return;
1552   }
1553   ConstantPool* cpool = method-&gt;constants();
1554   int cp_index = Bytes::get_native_u2(bcp + 1) + ConstantPool::CPCACHE_INDEX_TAG;
1555   Symbol* cname = cpool-&gt;klass_name_at(cpool-&gt;klass_ref_index_at(cp_index));
1556   Symbol* mname = cpool-&gt;name_ref_at(cp_index);
1557 
1558   if (MethodHandles::has_member_arg(cname, mname)) {
1559     oop member_name_oop = (oop) member_name;
1560     if (java_lang_invoke_DirectMethodHandle::is_instance(member_name_oop)) {
1561       // FIXME: remove after j.l.i.InvokerBytecodeGenerator code shape is updated.
1562       member_name_oop = java_lang_invoke_DirectMethodHandle::member(member_name_oop);
1563     }
1564     thread-&gt;set_vm_result(member_name_oop);
1565   } else {
1566     thread-&gt;set_vm_result(NULL);
1567   }
1568 JRT_END
1569 #endif // INCLUDE_JVMTI
1570 
1571 #ifndef PRODUCT
1572 // This must be a JRT_LEAF function because the interpreter must save registers on x86 to
1573 // call this, which changes rsp and makes the interpreter&#39;s expression stack not walkable.
1574 // The generated code still uses call_VM because that will set up the frame pointer for
1575 // bcp and method.
1576 JRT_LEAF(intptr_t, InterpreterRuntime::trace_bytecode(JavaThread* thread, intptr_t preserve_this_value, intptr_t tos, intptr_t tos2))
1577   LastFrameAccessor last_frame(thread);
1578   assert(last_frame.is_interpreted_frame(), &quot;must be an interpreted frame&quot;);
1579   methodHandle mh(thread, last_frame.method());
1580   BytecodeTracer::trace(mh, last_frame.bcp(), tos, tos2);
1581   return preserve_this_value;
1582 JRT_END
1583 #endif // !PRODUCT
<a name="3" id="anc3"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="3" type="hidden" />
</body>
</html>