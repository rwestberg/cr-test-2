<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>New src/hotspot/share/gc/g1/g1CollectedHeap.hpp</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
  <body>
    <pre>
   1 /*
   2  * Copyright (c) 2001, 2020, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
  23  */
  24 
  25 #ifndef SHARE_GC_G1_G1COLLECTEDHEAP_HPP
  26 #define SHARE_GC_G1_G1COLLECTEDHEAP_HPP
  27 
  28 #include &quot;gc/g1/g1BarrierSet.hpp&quot;
  29 #include &quot;gc/g1/g1BiasedArray.hpp&quot;
  30 #include &quot;gc/g1/g1CardTable.hpp&quot;
  31 #include &quot;gc/g1/g1CollectionSet.hpp&quot;
  32 #include &quot;gc/g1/g1CollectorState.hpp&quot;
  33 #include &quot;gc/g1/g1ConcurrentMark.hpp&quot;
  34 #include &quot;gc/g1/g1EdenRegions.hpp&quot;
  35 #include &quot;gc/g1/g1EvacFailure.hpp&quot;
  36 #include &quot;gc/g1/g1EvacStats.hpp&quot;
  37 #include &quot;gc/g1/g1EvacuationInfo.hpp&quot;
  38 #include &quot;gc/g1/g1GCPhaseTimes.hpp&quot;
  39 #include &quot;gc/g1/g1HeapTransition.hpp&quot;
  40 #include &quot;gc/g1/g1HeapVerifier.hpp&quot;
  41 #include &quot;gc/g1/g1HRPrinter.hpp&quot;
  42 #include &quot;gc/g1/g1HeapRegionAttr.hpp&quot;
  43 #include &quot;gc/g1/g1MonitoringSupport.hpp&quot;
  44 #include &quot;gc/g1/g1NUMA.hpp&quot;
  45 #include &quot;gc/g1/g1RedirtyCardsQueue.hpp&quot;
  46 #include &quot;gc/g1/g1SurvivorRegions.hpp&quot;
  47 #include &quot;gc/g1/g1YCTypes.hpp&quot;
  48 #include &quot;gc/g1/heapRegionManager.hpp&quot;
  49 #include &quot;gc/g1/heapRegionSet.hpp&quot;
  50 #include &quot;gc/g1/heterogeneousHeapRegionManager.hpp&quot;
  51 #include &quot;gc/shared/barrierSet.hpp&quot;
  52 #include &quot;gc/shared/collectedHeap.hpp&quot;
  53 #include &quot;gc/shared/gcHeapSummary.hpp&quot;
  54 #include &quot;gc/shared/plab.hpp&quot;
  55 #include &quot;gc/shared/preservedMarks.hpp&quot;
  56 #include &quot;gc/shared/softRefPolicy.hpp&quot;
  57 #include &quot;memory/memRegion.hpp&quot;
  58 #include &quot;utilities/stack.hpp&quot;
  59 
  60 // A &quot;G1CollectedHeap&quot; is an implementation of a java heap for HotSpot.
  61 // It uses the &quot;Garbage First&quot; heap organization and algorithm, which
  62 // may combine concurrent marking with parallel, incremental compaction of
  63 // heap subsets that will yield large amounts of garbage.
  64 
  65 // Forward declarations
  66 class HeapRegion;
  67 class GenerationSpec;
  68 class G1ParScanThreadState;
  69 class G1ParScanThreadStateSet;
  70 class G1ParScanThreadState;
  71 class MemoryPool;
  72 class MemoryManager;
  73 class ObjectClosure;
  74 class SpaceClosure;
  75 class CompactibleSpaceClosure;
  76 class Space;
  77 class G1CardTableEntryClosure;
  78 class G1CollectionSet;
  79 class G1Policy;
  80 class G1HotCardCache;
  81 class G1RemSet;
  82 class G1YoungRemSetSamplingThread;
  83 class G1ConcurrentMark;
  84 class G1ConcurrentMarkThread;
  85 class G1ConcurrentRefine;
  86 class GenerationCounters;
  87 class STWGCTimer;
  88 class G1NewTracer;
  89 class EvacuationFailedInfo;
  90 class nmethod;
  91 class WorkGang;
  92 class G1Allocator;
  93 class G1ArchiveAllocator;
  94 class G1FullGCScope;
  95 class G1HeapVerifier;
  96 class G1HeapSizingPolicy;
  97 class G1HeapSummary;
  98 class G1EvacSummary;
  99 
 100 typedef OverflowTaskQueue&lt;StarTask, mtGC&gt;         RefToScanQueue;
 101 typedef GenericTaskQueueSet&lt;RefToScanQueue, mtGC&gt; RefToScanQueueSet;
 102 
 103 typedef int RegionIdx_t;   // needs to hold [ 0..max_regions() )
 104 typedef int CardIdx_t;     // needs to hold [ 0..CardsPerRegion )
 105 
 106 // The G1 STW is alive closure.
 107 // An instance is embedded into the G1CH and used as the
 108 // (optional) _is_alive_non_header closure in the STW
 109 // reference processor. It is also extensively used during
 110 // reference processing during STW evacuation pauses.
 111 class G1STWIsAliveClosure : public BoolObjectClosure {
 112   G1CollectedHeap* _g1h;
 113 public:
 114   G1STWIsAliveClosure(G1CollectedHeap* g1h) : _g1h(g1h) {}
 115   bool do_object_b(oop p);
 116 };
 117 
 118 class G1STWSubjectToDiscoveryClosure : public BoolObjectClosure {
 119   G1CollectedHeap* _g1h;
 120 public:
 121   G1STWSubjectToDiscoveryClosure(G1CollectedHeap* g1h) : _g1h(g1h) {}
 122   bool do_object_b(oop p);
 123 };
 124 
 125 class G1RegionMappingChangedListener : public G1MappingChangedListener {
 126  private:
 127   void reset_from_card_cache(uint start_idx, size_t num_regions);
 128  public:
 129   virtual void on_commit(uint start_idx, size_t num_regions, bool zero_filled);
 130 };
 131 
 132 class G1CollectedHeap : public CollectedHeap {
 133   friend class VM_CollectForMetadataAllocation;
 134   friend class VM_G1CollectForAllocation;
 135   friend class VM_G1CollectFull;
 136   friend class VM_G1TryInitiateConcMark;
 137   friend class VMStructs;
 138   friend class MutatorAllocRegion;
 139   friend class G1FullCollector;
 140   friend class G1GCAllocRegion;
 141   friend class G1HeapVerifier;
 142 
 143   // Closures used in implementation.
 144   friend class G1ParScanThreadState;
 145   friend class G1ParScanThreadStateSet;
 146   friend class G1EvacuateRegionsTask;
 147   friend class G1PLABAllocator;
 148 
 149   // Other related classes.
 150   friend class HeapRegionClaimer;
 151 
 152   // Testing classes.
 153   friend class G1CheckRegionAttrTableClosure;
 154 
 155 private:
 156   G1YoungRemSetSamplingThread* _young_gen_sampling_thread;
 157 
 158   WorkGang* _workers;
 159   G1CardTable* _card_table;
 160 
 161   SoftRefPolicy      _soft_ref_policy;
 162 
 163   static size_t _humongous_object_threshold_in_words;
 164 
 165   // These sets keep track of old, archive and humongous regions respectively.
 166   HeapRegionSet _old_set;
 167   HeapRegionSet _archive_set;
 168   HeapRegionSet _humongous_set;
 169 
 170   void eagerly_reclaim_humongous_regions();
 171   // Start a new incremental collection set for the next pause.
 172   void start_new_collection_set();
 173 
 174   // The block offset table for the G1 heap.
 175   G1BlockOffsetTable* _bot;
 176 
 177   // Tears down the region sets / lists so that they are empty and the
 178   // regions on the heap do not belong to a region set / list. The
 179   // only exception is the humongous set which we leave unaltered. If
 180   // free_list_only is true, it will only tear down the master free
 181   // list. It is called before a Full GC (free_list_only == false) or
 182   // before heap shrinking (free_list_only == true).
 183   void tear_down_region_sets(bool free_list_only);
 184 
 185   // Rebuilds the region sets / lists so that they are repopulated to
 186   // reflect the contents of the heap. The only exception is the
 187   // humongous set which was not torn down in the first place. If
 188   // free_list_only is true, it will only rebuild the master free
 189   // list. It is called after a Full GC (free_list_only == false) or
 190   // after heap shrinking (free_list_only == true).
 191   void rebuild_region_sets(bool free_list_only);
 192 
 193   // Callback for region mapping changed events.
 194   G1RegionMappingChangedListener _listener;
 195 
 196   // Handle G1 NUMA support.
 197   G1NUMA* _numa;
 198 
 199   // The sequence of all heap regions in the heap.
 200   HeapRegionManager* _hrm;
 201 
 202   // Manages all allocations with regions except humongous object allocations.
 203   G1Allocator* _allocator;
 204 
 205   // Manages all heap verification.
 206   G1HeapVerifier* _verifier;
 207 
 208   // Outside of GC pauses, the number of bytes used in all regions other
 209   // than the current allocation region(s).
 210   volatile size_t _summary_bytes_used;
 211 
 212   void increase_used(size_t bytes);
 213   void decrease_used(size_t bytes);
 214 
 215   void set_used(size_t bytes);
 216 
 217   // Number of bytes used in all regions during GC. Typically changed when
 218   // retiring a GC alloc region.
 219   size_t _bytes_used_during_gc;
 220 
 221   // Class that handles archive allocation ranges.
 222   G1ArchiveAllocator* _archive_allocator;
 223 
 224   // GC allocation statistics policy for survivors.
 225   G1EvacStats _survivor_evac_stats;
 226 
 227   // GC allocation statistics policy for tenured objects.
 228   G1EvacStats _old_evac_stats;
 229 
 230   // It specifies whether we should attempt to expand the heap after a
 231   // region allocation failure. If heap expansion fails we set this to
 232   // false so that we don&#39;t re-attempt the heap expansion (it&#39;s likely
 233   // that subsequent expansion attempts will also fail if one fails).
 234   // Currently, it is only consulted during GC and it&#39;s reset at the
 235   // start of each GC.
 236   bool _expand_heap_after_alloc_failure;
 237 
 238   // Helper for monitoring and management support.
 239   G1MonitoringSupport* _g1mm;
 240 
 241   // Records whether the region at the given index is (still) a
 242   // candidate for eager reclaim.  Only valid for humongous start
 243   // regions; other regions have unspecified values.  Humongous start
 244   // regions are initialized at start of collection pause, with
 245   // candidates removed from the set as they are found reachable from
 246   // roots or the young generation.
 247   class HumongousReclaimCandidates : public G1BiasedMappedArray&lt;bool&gt; {
 248    protected:
 249     bool default_value() const { return false; }
 250    public:
 251     void clear() { G1BiasedMappedArray&lt;bool&gt;::clear(); }
 252     void set_candidate(uint region, bool value) {
 253       set_by_index(region, value);
 254     }
 255     bool is_candidate(uint region) {
 256       return get_by_index(region);
 257     }
 258   };
 259 
 260   HumongousReclaimCandidates _humongous_reclaim_candidates;
 261   // Stores whether during humongous object registration we found candidate regions.
 262   // If not, we can skip a few steps.
 263   bool _has_humongous_reclaim_candidates;
 264 
 265   G1HRPrinter _hr_printer;
 266 
 267   // Return true if an explicit GC should start a concurrent cycle instead
 268   // of doing a STW full GC. A concurrent cycle should be started if:
 269   // (a) cause == _g1_humongous_allocation,
 270   // (b) cause == _java_lang_system_gc and +ExplicitGCInvokesConcurrent,
 271   // (c) cause == _dcmd_gc_run and +ExplicitGCInvokesConcurrent,
 272   // (d) cause == _wb_conc_mark,
 273   // (e) cause == _g1_periodic_collection and +G1PeriodicGCInvokesConcurrent.
 274   bool should_do_concurrent_full_gc(GCCause::Cause cause);
 275 
 276   // Attempt to start a concurrent cycle with the indicated cause.
 277   // precondition: should_do_concurrent_full_gc(cause)
 278   bool try_collect_concurrently(GCCause::Cause cause,
 279                                 uint gc_counter,
 280                                 uint old_marking_started_before);
 281 
 282   // Return true if should upgrade to full gc after an incremental one.
 283   bool should_upgrade_to_full_gc(GCCause::Cause cause);
 284 
 285   // indicates whether we are in young or mixed GC mode
 286   G1CollectorState _collector_state;
 287 
 288   // Keeps track of how many &quot;old marking cycles&quot; (i.e., Full GCs or
 289   // concurrent cycles) we have started.
 290   volatile uint _old_marking_cycles_started;
 291 
 292   // Keeps track of how many &quot;old marking cycles&quot; (i.e., Full GCs or
 293   // concurrent cycles) we have completed.
 294   volatile uint _old_marking_cycles_completed;
 295 
 296   // This is a non-product method that is helpful for testing. It is
 297   // called at the end of a GC and artificially expands the heap by
 298   // allocating a number of dead regions. This way we can induce very
 299   // frequent marking cycles and stress the cleanup / concurrent
 300   // cleanup code more (as all the regions that will be allocated by
 301   // this method will be found dead by the marking cycle).
 302   void allocate_dummy_regions() PRODUCT_RETURN;
 303 
 304   // If the HR printer is active, dump the state of the regions in the
 305   // heap after a compaction.
 306   void print_hrm_post_compaction();
 307 
 308   // Create a memory mapper for auxiliary data structures of the given size and
 309   // translation factor.
 310   static G1RegionToSpaceMapper* create_aux_memory_mapper(const char* description,
 311                                                          size_t size,
 312                                                          size_t translation_factor);
 313 
 314   void trace_heap(GCWhen::Type when, const GCTracer* tracer);
 315 
 316   // These are macros so that, if the assert fires, we get the correct
 317   // line number, file, etc.
 318 
 319 #define heap_locking_asserts_params(_extra_message_)                          \
 320   &quot;%s : Heap_lock locked: %s, at safepoint: %s, is VM thread: %s&quot;,            \
 321   (_extra_message_),                                                          \
 322   BOOL_TO_STR(Heap_lock-&gt;owned_by_self()),                                    \
 323   BOOL_TO_STR(SafepointSynchronize::is_at_safepoint()),                       \
 324   BOOL_TO_STR(Thread::current()-&gt;is_VM_thread())
 325 
 326 #define assert_heap_locked()                                                  \
 327   do {                                                                        \
 328     assert(Heap_lock-&gt;owned_by_self(),                                        \
 329            heap_locking_asserts_params(&quot;should be holding the Heap_lock&quot;));   \
 330   } while (0)
 331 
 332 #define assert_heap_locked_or_at_safepoint(_should_be_vm_thread_)             \
 333   do {                                                                        \
 334     assert(Heap_lock-&gt;owned_by_self() ||                                      \
 335            (SafepointSynchronize::is_at_safepoint() &amp;&amp;                        \
 336              ((_should_be_vm_thread_) == Thread::current()-&gt;is_VM_thread())), \
 337            heap_locking_asserts_params(&quot;should be holding the Heap_lock or &quot;  \
 338                                         &quot;should be at a safepoint&quot;));         \
 339   } while (0)
 340 
 341 #define assert_heap_locked_and_not_at_safepoint()                             \
 342   do {                                                                        \
 343     assert(Heap_lock-&gt;owned_by_self() &amp;&amp;                                      \
 344                                     !SafepointSynchronize::is_at_safepoint(), \
 345           heap_locking_asserts_params(&quot;should be holding the Heap_lock and &quot;  \
 346                                        &quot;should not be at a safepoint&quot;));      \
 347   } while (0)
 348 
 349 #define assert_heap_not_locked()                                              \
 350   do {                                                                        \
 351     assert(!Heap_lock-&gt;owned_by_self(),                                       \
 352         heap_locking_asserts_params(&quot;should not be holding the Heap_lock&quot;));  \
 353   } while (0)
 354 
 355 #define assert_heap_not_locked_and_not_at_safepoint()                         \
 356   do {                                                                        \
 357     assert(!Heap_lock-&gt;owned_by_self() &amp;&amp;                                     \
 358                                     !SafepointSynchronize::is_at_safepoint(), \
 359       heap_locking_asserts_params(&quot;should not be holding the Heap_lock and &quot;  \
 360                                    &quot;should not be at a safepoint&quot;));          \
 361   } while (0)
 362 
 363 #define assert_at_safepoint_on_vm_thread()                                    \
 364   do {                                                                        \
 365     assert_at_safepoint();                                                    \
 366     assert(Thread::current_or_null() != NULL, &quot;no current thread&quot;);           \
 367     assert(Thread::current()-&gt;is_VM_thread(), &quot;current thread is not VM thread&quot;); \
 368   } while (0)
 369 
 370 #ifdef ASSERT
 371 #define assert_used_and_recalculate_used_equal(g1h)                           \
 372   do {                                                                        \
 373     size_t cur_used_bytes = g1h-&gt;used();                                      \
 374     size_t recal_used_bytes = g1h-&gt;recalculate_used();                        \
 375     assert(cur_used_bytes == recal_used_bytes, &quot;Used(&quot; SIZE_FORMAT &quot;) is not&quot; \
 376            &quot; same as recalculated used(&quot; SIZE_FORMAT &quot;).&quot;,                    \
 377            cur_used_bytes, recal_used_bytes);                                 \
 378   } while (0)
 379 #else
 380 #define assert_used_and_recalculate_used_equal(g1h) do {} while(0)
 381 #endif
 382 
 383   const char* young_gc_name() const;
 384 
 385   // The young region list.
 386   G1EdenRegions _eden;
 387   G1SurvivorRegions _survivor;
 388 
 389   STWGCTimer* _gc_timer_stw;
 390 
 391   G1NewTracer* _gc_tracer_stw;
 392 
 393   // The current policy object for the collector.
 394   G1Policy* _policy;
 395   G1HeapSizingPolicy* _heap_sizing_policy;
 396 
 397   G1CollectionSet _collection_set;
 398 
 399   // Try to allocate a single non-humongous HeapRegion sufficient for
 400   // an allocation of the given word_size. If do_expand is true,
 401   // attempt to expand the heap if necessary to satisfy the allocation
 402   // request. &#39;type&#39; takes the type of region to be allocated. (Use constants
 403   // Old, Eden, Humongous, Survivor defined in HeapRegionType.)
 404   HeapRegion* new_region(size_t word_size,
 405                          HeapRegionType type,
 406                          bool do_expand,
 407                          uint node_index = G1NUMA::AnyNodeIndex);
 408 
 409   // Initialize a contiguous set of free regions of length num_regions
 410   // and starting at index first so that they appear as a single
 411   // humongous region.
 412   HeapWord* humongous_obj_allocate_initialize_regions(uint first,
 413                                                       uint num_regions,
 414                                                       size_t word_size);
 415 
 416   // Attempt to allocate a humongous object of the given size. Return
 417   // NULL if unsuccessful.
 418   HeapWord* humongous_obj_allocate(size_t word_size);
 419 
 420   // The following two methods, allocate_new_tlab() and
 421   // mem_allocate(), are the two main entry points from the runtime
 422   // into the G1&#39;s allocation routines. They have the following
 423   // assumptions:
 424   //
 425   // * They should both be called outside safepoints.
 426   //
 427   // * They should both be called without holding the Heap_lock.
 428   //
 429   // * All allocation requests for new TLABs should go to
 430   //   allocate_new_tlab().
 431   //
 432   // * All non-TLAB allocation requests should go to mem_allocate().
 433   //
 434   // * If either call cannot satisfy the allocation request using the
 435   //   current allocating region, they will try to get a new one. If
 436   //   this fails, they will attempt to do an evacuation pause and
 437   //   retry the allocation.
 438   //
 439   // * If all allocation attempts fail, even after trying to schedule
 440   //   an evacuation pause, allocate_new_tlab() will return NULL,
 441   //   whereas mem_allocate() will attempt a heap expansion and/or
 442   //   schedule a Full GC.
 443   //
 444   // * We do not allow humongous-sized TLABs. So, allocate_new_tlab
 445   //   should never be called with word_size being humongous. All
 446   //   humongous allocation requests should go to mem_allocate() which
 447   //   will satisfy them with a special path.
 448 
 449   virtual HeapWord* allocate_new_tlab(size_t min_size,
 450                                       size_t requested_size,
 451                                       size_t* actual_size);
 452 
 453   virtual HeapWord* mem_allocate(size_t word_size,
 454                                  bool*  gc_overhead_limit_was_exceeded);
 455 
 456   // First-level mutator allocation attempt: try to allocate out of
 457   // the mutator alloc region without taking the Heap_lock. This
 458   // should only be used for non-humongous allocations.
 459   inline HeapWord* attempt_allocation(size_t min_word_size,
 460                                       size_t desired_word_size,
 461                                       size_t* actual_word_size);
 462 
 463   // Second-level mutator allocation attempt: take the Heap_lock and
 464   // retry the allocation attempt, potentially scheduling a GC
 465   // pause. This should only be used for non-humongous allocations.
 466   HeapWord* attempt_allocation_slow(size_t word_size);
 467 
 468   // Takes the Heap_lock and attempts a humongous allocation. It can
 469   // potentially schedule a GC pause.
 470   HeapWord* attempt_allocation_humongous(size_t word_size);
 471 
 472   // Allocation attempt that should be called during safepoints (e.g.,
 473   // at the end of a successful GC). expect_null_mutator_alloc_region
 474   // specifies whether the mutator alloc region is expected to be NULL
 475   // or not.
 476   HeapWord* attempt_allocation_at_safepoint(size_t word_size,
 477                                             bool expect_null_mutator_alloc_region);
 478 
 479   // These methods are the &quot;callbacks&quot; from the G1AllocRegion class.
 480 
 481   // For mutator alloc regions.
 482   HeapRegion* new_mutator_alloc_region(size_t word_size, bool force, uint node_index);
 483   void retire_mutator_alloc_region(HeapRegion* alloc_region,
 484                                    size_t allocated_bytes);
 485 
 486   // For GC alloc regions.
 487   bool has_more_regions(G1HeapRegionAttr dest);
 488   HeapRegion* new_gc_alloc_region(size_t word_size, G1HeapRegionAttr dest, uint node_index);
 489   void retire_gc_alloc_region(HeapRegion* alloc_region,
 490                               size_t allocated_bytes, G1HeapRegionAttr dest);
 491 
 492   // - if explicit_gc is true, the GC is for a System.gc() etc,
 493   //   otherwise it&#39;s for a failed allocation.
 494   // - if clear_all_soft_refs is true, all soft references should be
 495   //   cleared during the GC.
 496   // - it returns false if it is unable to do the collection due to the
 497   //   GC locker being active, true otherwise.
 498   bool do_full_collection(bool explicit_gc,
 499                           bool clear_all_soft_refs);
 500 
 501   // Callback from VM_G1CollectFull operation, or collect_as_vm_thread.
 502   virtual void do_full_collection(bool clear_all_soft_refs);
 503 
 504   // Callback from VM_G1CollectForAllocation operation.
 505   // This function does everything necessary/possible to satisfy a
 506   // failed allocation request (including collection, expansion, etc.)
 507   HeapWord* satisfy_failed_allocation(size_t word_size,
 508                                       bool* succeeded);
 509   // Internal helpers used during full GC to split it up to
 510   // increase readability.
 511   void abort_concurrent_cycle();
 512   void verify_before_full_collection(bool explicit_gc);
 513   void prepare_heap_for_full_collection();
 514   void prepare_heap_for_mutators();
 515   void abort_refinement();
 516   void verify_after_full_collection();
 517   void print_heap_after_full_collection(G1HeapTransition* heap_transition);
 518 
 519   // Helper method for satisfy_failed_allocation()
 520   HeapWord* satisfy_failed_allocation_helper(size_t word_size,
 521                                              bool do_gc,
 522                                              bool clear_all_soft_refs,
 523                                              bool expect_null_mutator_alloc_region,
 524                                              bool* gc_succeeded);
 525 
 526   // Attempting to expand the heap sufficiently
 527   // to support an allocation of the given &quot;word_size&quot;.  If
 528   // successful, perform the allocation and return the address of the
 529   // allocated block, or else &quot;NULL&quot;.
 530   HeapWord* expand_and_allocate(size_t word_size);
 531 
 532   // Process any reference objects discovered.
 533   void process_discovered_references(G1ParScanThreadStateSet* per_thread_states);
 534 
 535   // If during an initial mark pause we may install a pending list head which is not
 536   // otherwise reachable ensure that it is marked in the bitmap for concurrent marking
 537   // to discover.
 538   void make_pending_list_reachable();
 539 
 540   // Merges the information gathered on a per-thread basis for all worker threads
 541   // during GC into global variables.
 542   void merge_per_thread_state_info(G1ParScanThreadStateSet* per_thread_states);
 543 
 544   void verify_numa_regions(const char* desc);
 545 
 546 public:
 547   G1YoungRemSetSamplingThread* sampling_thread() const { return _young_gen_sampling_thread; }
 548 
 549   WorkGang* workers() const { return _workers; }
 550 
 551   // Runs the given AbstractGangTask with the current active workers, returning the
 552   // total time taken.
 553   Tickspan run_task(AbstractGangTask* task);
 554 
 555   G1Allocator* allocator() {
 556     return _allocator;
 557   }
 558 
 559   G1HeapVerifier* verifier() {
 560     return _verifier;
 561   }
 562 
 563   G1MonitoringSupport* g1mm() {
 564     assert(_g1mm != NULL, &quot;should have been initialized&quot;);
 565     return _g1mm;
 566   }
 567 
 568   void resize_heap_if_necessary();
 569 
 570   G1NUMA* numa() const { return _numa; }
 571 
 572   // Expand the garbage-first heap by at least the given size (in bytes!).
 573   // Returns true if the heap was expanded by the requested amount;
 574   // false otherwise.
 575   // (Rounds up to a HeapRegion boundary.)
 576   bool expand(size_t expand_bytes, WorkGang* pretouch_workers = NULL, double* expand_time_ms = NULL);
 577   bool expand_single_region(uint node_index);
 578 
 579   // Returns the PLAB statistics for a given destination.
 580   inline G1EvacStats* alloc_buffer_stats(G1HeapRegionAttr dest);
 581 
 582   // Determines PLAB size for a given destination.
 583   inline size_t desired_plab_sz(G1HeapRegionAttr dest);
 584 
 585   // Do anything common to GC&#39;s.
 586   void gc_prologue(bool full);
 587   void gc_epilogue(bool full);
 588 
 589   // Does the given region fulfill remembered set based eager reclaim candidate requirements?
 590   bool is_potential_eager_reclaim_candidate(HeapRegion* r) const;
 591 
 592   // Modify the reclaim candidate set and test for presence.
 593   // These are only valid for starts_humongous regions.
 594   inline void set_humongous_reclaim_candidate(uint region, bool value);
 595   inline bool is_humongous_reclaim_candidate(uint region);
 596   inline void set_has_humongous_reclaim_candidate(bool value);
 597 
 598   // Remove from the reclaim candidate set.  Also remove from the
 599   // collection set so that later encounters avoid the slow path.
 600   inline void set_humongous_is_live(oop obj);
 601 
 602   // Register the given region to be part of the collection set.
 603   inline void register_humongous_region_with_region_attr(uint index);
 604 
 605   // We register a region with the fast &quot;in collection set&quot; test. We
 606   // simply set to true the array slot corresponding to this region.
 607   void register_young_region_with_region_attr(HeapRegion* r) {
 608     _region_attr.set_in_young(r-&gt;hrm_index());
 609   }
 610   inline void register_region_with_region_attr(HeapRegion* r);
 611   inline void register_old_region_with_region_attr(HeapRegion* r);
 612   inline void register_optional_region_with_region_attr(HeapRegion* r);
 613 
 614   void clear_region_attr(const HeapRegion* hr) {
 615     _region_attr.clear(hr);
 616   }
 617 
 618   void clear_region_attr() {
 619     _region_attr.clear();
 620   }
 621 
 622   // Verify that the G1RegionAttr remset tracking corresponds to actual remset tracking
 623   // for all regions.
 624   void verify_region_attr_remset_update() PRODUCT_RETURN;
 625 
 626   bool is_user_requested_concurrent_full_gc(GCCause::Cause cause);
 627 
 628   // This is called at the start of either a concurrent cycle or a Full
 629   // GC to update the number of old marking cycles started.
 630   void increment_old_marking_cycles_started();
 631 
 632   // This is called at the end of either a concurrent cycle or a Full
 633   // GC to update the number of old marking cycles completed. Those two
 634   // can happen in a nested fashion, i.e., we start a concurrent
 635   // cycle, a Full GC happens half-way through it which ends first,
 636   // and then the cycle notices that a Full GC happened and ends
 637   // too. The concurrent parameter is a boolean to help us do a bit
 638   // tighter consistency checking in the method. If concurrent is
 639   // false, the caller is the inner caller in the nesting (i.e., the
 640   // Full GC). If concurrent is true, the caller is the outer caller
 641   // in this nesting (i.e., the concurrent cycle). Further nesting is
 642   // not currently supported. The end of this call also notifies
 643   // the G1OldGCCount_lock in case a Java thread is waiting for a full
 644   // GC to happen (e.g., it called System.gc() with
 645   // +ExplicitGCInvokesConcurrent).
 646   void increment_old_marking_cycles_completed(bool concurrent);
 647 
 648   uint old_marking_cycles_completed() {
 649     return _old_marking_cycles_completed;
 650   }
 651 
 652   G1HRPrinter* hr_printer() { return &amp;_hr_printer; }
 653 
 654   // Allocates a new heap region instance.
 655   HeapRegion* new_heap_region(uint hrs_index, MemRegion mr);
 656 
 657   // Allocate the highest free region in the reserved heap. This will commit
 658   // regions as necessary.
 659   HeapRegion* alloc_highest_free_region();
 660 
 661   // Frees a region by resetting its metadata and adding it to the free list
 662   // passed as a parameter (this is usually a local list which will be appended
 663   // to the master free list later or NULL if free list management is handled
 664   // in another way).
 665   // Callers must ensure they are the only one calling free on the given region
 666   // at the same time.
 667   void free_region(HeapRegion* hr, FreeRegionList* free_list);
 668 
 669   // It dirties the cards that cover the block so that the post
 670   // write barrier never queues anything when updating objects on this
 671   // block. It is assumed (and in fact we assert) that the block
 672   // belongs to a young region.
 673   inline void dirty_young_block(HeapWord* start, size_t word_size);
 674 
 675   // Frees a humongous region by collapsing it into individual regions
 676   // and calling free_region() for each of them. The freed regions
 677   // will be added to the free list that&#39;s passed as a parameter (this
 678   // is usually a local list which will be appended to the master free
 679   // list later).
 680   // The method assumes that only a single thread is ever calling
 681   // this for a particular region at once.
 682   void free_humongous_region(HeapRegion* hr,
 683                              FreeRegionList* free_list);
 684 
 685   // Facility for allocating in &#39;archive&#39; regions in high heap memory and
 686   // recording the allocated ranges. These should all be called from the
 687   // VM thread at safepoints, without the heap lock held. They can be used
 688   // to create and archive a set of heap regions which can be mapped at the
 689   // same fixed addresses in a subsequent JVM invocation.
 690   void begin_archive_alloc_range(bool open = false);
 691 
 692   // Check if the requested size would be too large for an archive allocation.
 693   bool is_archive_alloc_too_large(size_t word_size);
 694 
 695   // Allocate memory of the requested size from the archive region. This will
 696   // return NULL if the size is too large or if no memory is available. It
 697   // does not trigger a garbage collection.
 698   HeapWord* archive_mem_allocate(size_t word_size);
 699 
 700   // Optionally aligns the end address and returns the allocated ranges in
 701   // an array of MemRegions in order of ascending addresses.
 702   void end_archive_alloc_range(GrowableArray&lt;MemRegion&gt;* ranges,
 703                                size_t end_alignment_in_bytes = 0);
 704 
 705   // Facility for allocating a fixed range within the heap and marking
 706   // the containing regions as &#39;archive&#39;. For use at JVM init time, when the
 707   // caller may mmap archived heap data at the specified range(s).
 708   // Verify that the MemRegions specified in the argument array are within the
 709   // reserved heap.
 710   bool check_archive_addresses(MemRegion* range, size_t count);
 711 
 712   // Commit the appropriate G1 regions containing the specified MemRegions
 713   // and mark them as &#39;archive&#39; regions. The regions in the array must be
 714   // non-overlapping and in order of ascending address.
 715   bool alloc_archive_regions(MemRegion* range, size_t count, bool open);
 716 
 717   // Insert any required filler objects in the G1 regions around the specified
 718   // ranges to make the regions parseable. This must be called after
 719   // alloc_archive_regions, and after class loading has occurred.
 720   void fill_archive_regions(MemRegion* range, size_t count);
 721 
 722   // For each of the specified MemRegions, uncommit the containing G1 regions
 723   // which had been allocated by alloc_archive_regions. This should be called
 724   // rather than fill_archive_regions at JVM init time if the archive file
 725   // mapping failed, with the same non-overlapping and sorted MemRegion array.
 726   void dealloc_archive_regions(MemRegion* range, size_t count);
 727 
 728   oop materialize_archived_object(oop obj);
 729 
 730 private:
 731 
 732   // Shrink the garbage-first heap by at most the given size (in bytes!).
 733   // (Rounds down to a HeapRegion boundary.)
 734   void shrink(size_t expand_bytes);
 735   void shrink_helper(size_t expand_bytes);
 736 
 737   #if TASKQUEUE_STATS
 738   static void print_taskqueue_stats_hdr(outputStream* const st);
 739   void print_taskqueue_stats() const;
 740   void reset_taskqueue_stats();
 741   #endif // TASKQUEUE_STATS
 742 
 743   // Schedule the VM operation that will do an evacuation pause to
 744   // satisfy an allocation request of word_size. *succeeded will
 745   // return whether the VM operation was successful (it did do an
 746   // evacuation pause) or not (another thread beat us to it or the GC
 747   // locker was active). Given that we should not be holding the
 748   // Heap_lock when we enter this method, we will pass the
 749   // gc_count_before (i.e., total_collections()) as a parameter since
 750   // it has to be read while holding the Heap_lock. Currently, both
 751   // methods that call do_collection_pause() release the Heap_lock
 752   // before the call, so it&#39;s easy to read gc_count_before just before.
 753   HeapWord* do_collection_pause(size_t         word_size,
 754                                 uint           gc_count_before,
 755                                 bool*          succeeded,
 756                                 GCCause::Cause gc_cause);
 757 
 758   void wait_for_root_region_scanning();
 759 
 760   // Perform an incremental collection at a safepoint, possibly
 761   // followed by a by-policy upgrade to a full collection.  Returns
 762   // false if unable to do the collection due to the GC locker being
 763   // active, true otherwise.
 764   // precondition: at safepoint on VM thread
 765   // precondition: !is_gc_active()
 766   bool do_collection_pause_at_safepoint(double target_pause_time_ms);
 767 
 768   // Helper for do_collection_pause_at_safepoint, containing the guts
 769   // of the incremental collection pause, executed by the vm thread.
 770   void do_collection_pause_at_safepoint_helper(double target_pause_time_ms);
 771 
 772   G1HeapVerifier::G1VerifyType young_collection_verify_type() const;
 773   void verify_before_young_collection(G1HeapVerifier::G1VerifyType type);
 774   void verify_after_young_collection(G1HeapVerifier::G1VerifyType type);
 775 
 776   void calculate_collection_set(G1EvacuationInfo&amp; evacuation_info, double target_pause_time_ms);
 777 
 778   // Actually do the work of evacuating the parts of the collection set.
 779   void evacuate_initial_collection_set(G1ParScanThreadStateSet* per_thread_states);
 780   void evacuate_optional_collection_set(G1ParScanThreadStateSet* per_thread_states);
 781 private:
 782   // Evacuate the next set of optional regions.
 783   void evacuate_next_optional_regions(G1ParScanThreadStateSet* per_thread_states);
 784 
 785 public:
 786   void pre_evacuate_collection_set(G1EvacuationInfo&amp; evacuation_info, G1ParScanThreadStateSet* pss);
 787   void post_evacuate_collection_set(G1EvacuationInfo&amp; evacuation_info,
 788                                     G1RedirtyCardsQueueSet* rdcqs,
 789                                     G1ParScanThreadStateSet* pss);
 790 
 791   void expand_heap_after_young_collection();
 792   // Update object copying statistics.
 793   void record_obj_copy_mem_stats();
 794 
 795   // The hot card cache for remembered set insertion optimization.
 796   G1HotCardCache* _hot_card_cache;
 797 
 798   // The g1 remembered set of the heap.
 799   G1RemSet* _rem_set;
 800 
 801   // After a collection pause, convert the regions in the collection set into free
 802   // regions.
 803   void free_collection_set(G1CollectionSet* collection_set, G1EvacuationInfo&amp; evacuation_info, const size_t* surviving_young_words);
 804 
 805   // Abandon the current collection set without recording policy
 806   // statistics or updating free lists.
 807   void abandon_collection_set(G1CollectionSet* collection_set);
 808 
 809   // The concurrent marker (and the thread it runs in.)
 810   G1ConcurrentMark* _cm;
 811   G1ConcurrentMarkThread* _cm_thread;
 812 
 813   // The concurrent refiner.
 814   G1ConcurrentRefine* _cr;
 815 
 816   // The parallel task queues
 817   RefToScanQueueSet *_task_queues;
 818 
 819   // True iff a evacuation has failed in the current collection.
 820   bool _evacuation_failed;
 821 
 822   EvacuationFailedInfo* _evacuation_failed_info_array;
 823 
 824   // Failed evacuations cause some logical from-space objects to have
 825   // forwarding pointers to themselves.  Reset them.
 826   void remove_self_forwarding_pointers(G1RedirtyCardsQueueSet* rdcqs);
 827 
 828   // Restore the objects in the regions in the collection set after an
 829   // evacuation failure.
 830   void restore_after_evac_failure(G1RedirtyCardsQueueSet* rdcqs);
 831 
 832   PreservedMarksSet _preserved_marks_set;
 833 
 834   // Preserve the mark of &quot;obj&quot;, if necessary, in preparation for its mark
 835   // word being overwritten with a self-forwarding-pointer.
 836   void preserve_mark_during_evac_failure(uint worker_id, oop obj, markWord m);
 837 
 838 #ifndef PRODUCT
 839   // Support for forcing evacuation failures. Analogous to
 840   // PromotionFailureALot for the other collectors.
 841 
 842   // Records whether G1EvacuationFailureALot should be in effect
 843   // for the current GC
 844   bool _evacuation_failure_alot_for_current_gc;
 845 
 846   // Used to record the GC number for interval checking when
 847   // determining whether G1EvaucationFailureALot is in effect
 848   // for the current GC.
 849   size_t _evacuation_failure_alot_gc_number;
 850 
 851   // Count of the number of evacuations between failures.
 852   volatile size_t _evacuation_failure_alot_count;
 853 
 854   // Set whether G1EvacuationFailureALot should be in effect
 855   // for the current GC (based upon the type of GC and which
 856   // command line flags are set);
 857   inline bool evacuation_failure_alot_for_gc_type(bool for_young_gc,
 858                                                   bool during_initial_mark,
 859                                                   bool mark_or_rebuild_in_progress);
 860 
 861   inline void set_evacuation_failure_alot_for_current_gc();
 862 
 863   // Return true if it&#39;s time to cause an evacuation failure.
 864   inline bool evacuation_should_fail();
 865 
 866   // Reset the G1EvacuationFailureALot counters.  Should be called at
 867   // the end of an evacuation pause in which an evacuation failure occurred.
 868   inline void reset_evacuation_should_fail();
 869 #endif // !PRODUCT
 870 
 871   // (&quot;Weak&quot;) Reference processing support.
 872   //
 873   // G1 has 2 instances of the reference processor class. One
 874   // (_ref_processor_cm) handles reference object discovery
 875   // and subsequent processing during concurrent marking cycles.
 876   //
 877   // The other (_ref_processor_stw) handles reference object
 878   // discovery and processing during full GCs and incremental
 879   // evacuation pauses.
 880   //
 881   // During an incremental pause, reference discovery will be
 882   // temporarily disabled for _ref_processor_cm and will be
 883   // enabled for _ref_processor_stw. At the end of the evacuation
 884   // pause references discovered by _ref_processor_stw will be
 885   // processed and discovery will be disabled. The previous
 886   // setting for reference object discovery for _ref_processor_cm
 887   // will be re-instated.
 888   //
 889   // At the start of marking:
 890   //  * Discovery by the CM ref processor is verified to be inactive
 891   //    and it&#39;s discovered lists are empty.
 892   //  * Discovery by the CM ref processor is then enabled.
 893   //
 894   // At the end of marking:
 895   //  * Any references on the CM ref processor&#39;s discovered
 896   //    lists are processed (possibly MT).
 897   //
 898   // At the start of full GC we:
 899   //  * Disable discovery by the CM ref processor and
 900   //    empty CM ref processor&#39;s discovered lists
 901   //    (without processing any entries).
 902   //  * Verify that the STW ref processor is inactive and it&#39;s
 903   //    discovered lists are empty.
 904   //  * Temporarily set STW ref processor discovery as single threaded.
 905   //  * Temporarily clear the STW ref processor&#39;s _is_alive_non_header
 906   //    field.
 907   //  * Finally enable discovery by the STW ref processor.
 908   //
 909   // The STW ref processor is used to record any discovered
 910   // references during the full GC.
 911   //
 912   // At the end of a full GC we:
 913   //  * Enqueue any reference objects discovered by the STW ref processor
 914   //    that have non-live referents. This has the side-effect of
 915   //    making the STW ref processor inactive by disabling discovery.
 916   //  * Verify that the CM ref processor is still inactive
 917   //    and no references have been placed on it&#39;s discovered
 918   //    lists (also checked as a precondition during initial marking).
 919 
 920   // The (stw) reference processor...
 921   ReferenceProcessor* _ref_processor_stw;
 922 
 923   // During reference object discovery, the _is_alive_non_header
 924   // closure (if non-null) is applied to the referent object to
 925   // determine whether the referent is live. If so then the
 926   // reference object does not need to be &#39;discovered&#39; and can
 927   // be treated as a regular oop. This has the benefit of reducing
 928   // the number of &#39;discovered&#39; reference objects that need to
 929   // be processed.
 930   //
 931   // Instance of the is_alive closure for embedding into the
 932   // STW reference processor as the _is_alive_non_header field.
 933   // Supplying a value for the _is_alive_non_header field is
 934   // optional but doing so prevents unnecessary additions to
 935   // the discovered lists during reference discovery.
 936   G1STWIsAliveClosure _is_alive_closure_stw;
 937 
 938   G1STWSubjectToDiscoveryClosure _is_subject_to_discovery_stw;
 939 
 940   // The (concurrent marking) reference processor...
 941   ReferenceProcessor* _ref_processor_cm;
 942 
 943   // Instance of the concurrent mark is_alive closure for embedding
 944   // into the Concurrent Marking reference processor as the
 945   // _is_alive_non_header field. Supplying a value for the
 946   // _is_alive_non_header field is optional but doing so prevents
 947   // unnecessary additions to the discovered lists during reference
 948   // discovery.
 949   G1CMIsAliveClosure _is_alive_closure_cm;
 950 
 951   G1CMSubjectToDiscoveryClosure _is_subject_to_discovery_cm;
 952 public:
 953 
 954   RefToScanQueue *task_queue(uint i) const;
 955 
 956   uint num_task_queues() const;
 957 
 958   // Create a G1CollectedHeap.
 959   // Must call the initialize method afterwards.
 960   // May not return if something goes wrong.
 961   G1CollectedHeap();
 962 
 963 private:
 964   jint initialize_concurrent_refinement();
 965   jint initialize_young_gen_sampling_thread();
 966 public:
 967   // Initialize the G1CollectedHeap to have the initial and
 968   // maximum sizes and remembered and barrier sets
 969   // specified by the policy object.
 970   jint initialize();
 971 
 972   virtual void stop();
 973   virtual void safepoint_synchronize_begin();
 974   virtual void safepoint_synchronize_end();
 975 
 976   // Does operations required after initialization has been done.
 977   void post_initialize();
 978 
 979   // Initialize weak reference processing.
 980   void ref_processing_init();
 981 
 982   virtual Name kind() const {
 983     return CollectedHeap::G1;
 984   }
 985 
 986   virtual const char* name() const {
 987     return &quot;G1&quot;;
 988   }
 989 
 990   const G1CollectorState* collector_state() const { return &amp;_collector_state; }
 991   G1CollectorState* collector_state() { return &amp;_collector_state; }
 992 
 993   // The current policy object for the collector.
 994   G1Policy* policy() const { return _policy; }
 995   // The remembered set.
 996   G1RemSet* rem_set() const { return _rem_set; }
 997 
 998   inline G1GCPhaseTimes* phase_times() const;
 999 
1000   HeapRegionManager* hrm() const { return _hrm; }
1001 
1002   const G1CollectionSet* collection_set() const { return &amp;_collection_set; }
1003   G1CollectionSet* collection_set() { return &amp;_collection_set; }
1004 
1005   virtual SoftRefPolicy* soft_ref_policy();
1006 
1007   virtual void initialize_serviceability();
1008   virtual MemoryUsage memory_usage();
1009   virtual GrowableArray&lt;GCMemoryManager*&gt; memory_managers();
1010   virtual GrowableArray&lt;MemoryPool*&gt; memory_pools();
1011 
1012   // Try to minimize the remembered set.
1013   void scrub_rem_set();
1014 
1015   // Apply the given closure on all cards in the Hot Card Cache, emptying it.
1016   void iterate_hcc_closure(G1CardTableEntryClosure* cl, uint worker_id);
1017 
1018   // The shared block offset table array.
1019   G1BlockOffsetTable* bot() const { return _bot; }
1020 
1021   // Reference Processing accessors
1022 
1023   // The STW reference processor....
1024   ReferenceProcessor* ref_processor_stw() const { return _ref_processor_stw; }
1025 
1026   G1NewTracer* gc_tracer_stw() const { return _gc_tracer_stw; }
1027 
1028   // The Concurrent Marking reference processor...
1029   ReferenceProcessor* ref_processor_cm() const { return _ref_processor_cm; }
1030 
1031   size_t unused_committed_regions_in_bytes() const;
1032 
1033   virtual size_t capacity() const;
1034   virtual size_t used() const;
1035   // This should be called when we&#39;re not holding the heap lock. The
1036   // result might be a bit inaccurate.
1037   size_t used_unlocked() const;
1038   size_t recalculate_used() const;
1039 
1040   // These virtual functions do the actual allocation.
1041   // Some heaps may offer a contiguous region for shared non-blocking
1042   // allocation, via inlined code (by exporting the address of the top and
1043   // end fields defining the extent of the contiguous allocation region.)
1044   // But G1CollectedHeap doesn&#39;t yet support this.
1045 
1046   virtual bool is_maximal_no_gc() const {
1047     return _hrm-&gt;available() == 0;
1048   }
1049 
1050   // Returns whether there are any regions left in the heap for allocation.
1051   bool has_regions_left_for_allocation() const {
1052     return !is_maximal_no_gc() || num_free_regions() != 0;
1053   }
1054 
1055   // The current number of regions in the heap.
1056   uint num_regions() const { return _hrm-&gt;length(); }
1057 
1058   // The max number of regions in the heap.
1059   uint max_regions() const { return _hrm-&gt;max_length(); }
1060 
1061   // Max number of regions that can be comitted.
1062   uint max_expandable_regions() const { return _hrm-&gt;max_expandable_length(); }
1063 
1064   // The number of regions that are completely free.
1065   uint num_free_regions() const { return _hrm-&gt;num_free_regions(); }
1066 
1067   // The number of regions that can be allocated into.
1068   uint num_free_or_available_regions() const { return num_free_regions() + _hrm-&gt;available(); }
1069 
1070   MemoryUsage get_auxiliary_data_memory_usage() const {
1071     return _hrm-&gt;get_auxiliary_data_memory_usage();
1072   }
1073 
1074   // The number of regions that are not completely free.
1075   uint num_used_regions() const { return num_regions() - num_free_regions(); }
1076 
1077 #ifdef ASSERT
1078   bool is_on_master_free_list(HeapRegion* hr) {
1079     return _hrm-&gt;is_free(hr);
1080   }
1081 #endif // ASSERT
1082 
1083   inline void old_set_add(HeapRegion* hr);
1084   inline void old_set_remove(HeapRegion* hr);
1085 
1086   inline void archive_set_add(HeapRegion* hr);
1087 
1088   size_t non_young_capacity_bytes() {
1089     return (old_regions_count() + _archive_set.length() + humongous_regions_count()) * HeapRegion::GrainBytes;
1090   }
1091 
1092   // Determine whether the given region is one that we are using as an
1093   // old GC alloc region.
1094   bool is_old_gc_alloc_region(HeapRegion* hr);
1095 
1096   // Perform a collection of the heap; intended for use in implementing
1097   // &quot;System.gc&quot;.  This probably implies as full a collection as the
1098   // &quot;CollectedHeap&quot; supports.
1099   virtual void collect(GCCause::Cause cause);
1100 
1101   // Perform a collection of the heap with the given cause.
1102   // Returns whether this collection actually executed.
1103   bool try_collect(GCCause::Cause cause);
1104 
1105   // True iff an evacuation has failed in the most-recent collection.
1106   bool evacuation_failed() { return _evacuation_failed; }
1107 
1108   void remove_from_old_sets(const uint old_regions_removed, const uint humongous_regions_removed);
1109   void prepend_to_freelist(FreeRegionList* list);
1110   void decrement_summary_bytes(size_t bytes);
1111 
1112   virtual bool is_in(const void* p) const;
1113 #ifdef ASSERT
1114   // Returns whether p is in one of the available areas of the heap. Slow but
1115   // extensive version.
1116   bool is_in_exact(const void* p) const;
1117 #endif
1118 
1119   // Return &quot;TRUE&quot; iff the given object address is within the collection
1120   // set. Assumes that the reference points into the heap.
1121   inline bool is_in_cset(const HeapRegion *hr);
1122   inline bool is_in_cset(oop obj);
1123   inline bool is_in_cset(HeapWord* addr);
1124 
1125   inline bool is_in_cset_or_humongous(const oop obj);
1126 
1127  private:
1128   // This array is used for a quick test on whether a reference points into
1129   // the collection set or not. Each of the array&#39;s elements denotes whether the
1130   // corresponding region is in the collection set or not.
1131   G1HeapRegionAttrBiasedMappedArray _region_attr;
1132 
1133  public:
1134 
1135   inline G1HeapRegionAttr region_attr(const void* obj) const;
1136   inline G1HeapRegionAttr region_attr(uint idx) const;
1137 
1138   // Return &quot;TRUE&quot; iff the given object address is in the reserved
1139   // region of g1.
1140   bool is_in_g1_reserved(const void* p) const {
1141     return _hrm-&gt;reserved().contains(p);
1142   }
1143 
1144   // Returns a MemRegion that corresponds to the space that has been
1145   // reserved for the heap
1146   MemRegion g1_reserved() const {
1147     return _hrm-&gt;reserved();
1148   }
1149 
1150   MemRegion reserved_region() const {
1151     return _reserved;
1152   }
1153 
1154   HeapWord* base() const {
1155     return _reserved.start();
1156   }
1157 
1158   bool is_in_reserved(const void* addr) const {
1159     return _reserved.contains(addr);
1160   }
1161 
1162   G1HotCardCache* hot_card_cache() const { return _hot_card_cache; }
1163 
1164   G1CardTable* card_table() const {
1165     return _card_table;
1166   }
1167 
1168   // Iteration functions.
1169 
1170   // Iterate over all objects, calling &quot;cl.do_object&quot; on each.
1171   virtual void object_iterate(ObjectClosure* cl);
1172 
1173   // Keep alive an object that was loaded with AS_NO_KEEPALIVE.
1174   virtual void keep_alive(oop obj);
1175 
1176   // Iterate over heap regions, in address order, terminating the
1177   // iteration early if the &quot;do_heap_region&quot; method returns &quot;true&quot;.
1178   void heap_region_iterate(HeapRegionClosure* blk) const;
1179 
1180   // Return the region with the given index. It assumes the index is valid.
1181   inline HeapRegion* region_at(uint index) const;
1182   inline HeapRegion* region_at_or_null(uint index) const;
1183 
1184   // Return the next region (by index) that is part of the same
1185   // humongous object that hr is part of.
1186   inline HeapRegion* next_region_in_humongous(HeapRegion* hr) const;
1187 
1188   // Calculate the region index of the given address. Given address must be
1189   // within the heap.
1190   inline uint addr_to_region(HeapWord* addr) const;
1191 
1192   inline HeapWord* bottom_addr_for_region(uint index) const;
1193 
1194   // Two functions to iterate over the heap regions in parallel. Threads
1195   // compete using the HeapRegionClaimer to claim the regions before
1196   // applying the closure on them.
1197   // The _from_worker_offset version uses the HeapRegionClaimer and
1198   // the worker id to calculate a start offset to prevent all workers to
1199   // start from the point.
1200   void heap_region_par_iterate_from_worker_offset(HeapRegionClosure* cl,
1201                                                   HeapRegionClaimer* hrclaimer,
1202                                                   uint worker_id) const;
1203 
1204   void heap_region_par_iterate_from_start(HeapRegionClosure* cl,
1205                                           HeapRegionClaimer* hrclaimer) const;
1206 
1207   // Iterate over all regions in the collection set in parallel.
1208   void collection_set_par_iterate_all(HeapRegionClosure* cl,
1209                                       HeapRegionClaimer* hr_claimer,
1210                                       uint worker_id);
1211 
1212   // Iterate over all regions currently in the current collection set.
1213   void collection_set_iterate_all(HeapRegionClosure* blk);
1214 
1215   // Iterate over the regions in the current increment of the collection set.
1216   // Starts the iteration so that the start regions of a given worker id over the
1217   // set active_workers are evenly spread across the set of collection set regions
1218   // to be iterated.
1219   // The variant with the HeapRegionClaimer guarantees that the closure will be
1220   // applied to a particular region exactly once.
1221   void collection_set_iterate_increment_from(HeapRegionClosure *blk, uint worker_id) {
1222     collection_set_iterate_increment_from(blk, NULL, worker_id);
1223   }
1224   void collection_set_iterate_increment_from(HeapRegionClosure *blk, HeapRegionClaimer* hr_claimer, uint worker_id);
1225 
1226   // Returns the HeapRegion that contains addr. addr must not be NULL.
1227   template &lt;class T&gt;
1228   inline HeapRegion* heap_region_containing(const T addr) const;
1229 
1230   // Returns the HeapRegion that contains addr, or NULL if that is an uncommitted
1231   // region. addr must not be NULL.
1232   template &lt;class T&gt;
1233   inline HeapRegion* heap_region_containing_or_null(const T addr) const;
1234 
1235   // A CollectedHeap is divided into a dense sequence of &quot;blocks&quot;; that is,
1236   // each address in the (reserved) heap is a member of exactly
1237   // one block.  The defining characteristic of a block is that it is
1238   // possible to find its size, and thus to progress forward to the next
1239   // block.  (Blocks may be of different sizes.)  Thus, blocks may
1240   // represent Java objects, or they might be free blocks in a
1241   // free-list-based heap (or subheap), as long as the two kinds are
1242   // distinguishable and the size of each is determinable.
1243 
1244   // Returns the address of the start of the &quot;block&quot; that contains the
1245   // address &quot;addr&quot;.  We say &quot;blocks&quot; instead of &quot;object&quot; since some heaps
1246   // may not pack objects densely; a chunk may either be an object or a
1247   // non-object.
1248   HeapWord* block_start(const void* addr) const;
1249 
1250   // Requires &quot;addr&quot; to be the start of a block, and returns &quot;TRUE&quot; iff
1251   // the block is an object.
1252   bool block_is_obj(const HeapWord* addr) const;
1253 
1254   // Section on thread-local allocation buffers (TLABs)
1255   // See CollectedHeap for semantics.
1256 
1257   bool supports_tlab_allocation() const;
1258   size_t tlab_capacity(Thread* ignored) const;
1259   size_t tlab_used(Thread* ignored) const;
1260   size_t max_tlab_size() const;
1261   size_t unsafe_max_tlab_alloc(Thread* ignored) const;
1262 
1263   inline bool is_in_young(const oop obj);
1264 
1265   // Returns &quot;true&quot; iff the given word_size is &quot;very large&quot;.
1266   static bool is_humongous(size_t word_size) {
1267     // Note this has to be strictly greater-than as the TLABs
1268     // are capped at the humongous threshold and we want to
1269     // ensure that we don&#39;t try to allocate a TLAB as
1270     // humongous and that we don&#39;t allocate a humongous
1271     // object in a TLAB.
1272     return word_size &gt; _humongous_object_threshold_in_words;
1273   }
1274 
1275   // Returns the humongous threshold for a specific region size
1276   static size_t humongous_threshold_for(size_t region_size) {
1277     return (region_size / 2);
1278   }
1279 
1280   // Returns the number of regions the humongous object of the given word size
1281   // requires.
1282   static size_t humongous_obj_size_in_regions(size_t word_size);
1283 
1284   // Print the maximum heap capacity.
1285   virtual size_t max_capacity() const;
1286 
1287   // Return the size of reserved memory. Returns different value than max_capacity() when AllocateOldGenAt is used.
1288   virtual size_t max_reserved_capacity() const;
1289 
1290   virtual jlong millis_since_last_gc();
1291 
1292 
1293   // Convenience function to be used in situations where the heap type can be
1294   // asserted to be this type.
1295   static G1CollectedHeap* heap();
1296 
1297   void set_region_short_lived_locked(HeapRegion* hr);
1298   // add appropriate methods for any other surv rate groups
1299 
1300   const G1SurvivorRegions* survivor() const { return &amp;_survivor; }
1301 
1302   uint eden_regions_count() const { return _eden.length(); }
1303   uint eden_regions_count(uint node_index) const { return _eden.regions_on_node(node_index); }
1304   uint survivor_regions_count() const { return _survivor.length(); }
1305   uint survivor_regions_count(uint node_index) const { return _survivor.regions_on_node(node_index); }
1306   size_t eden_regions_used_bytes() const { return _eden.used_bytes(); }
1307   size_t survivor_regions_used_bytes() const { return _survivor.used_bytes(); }
1308   uint young_regions_count() const { return _eden.length() + _survivor.length(); }
1309   uint old_regions_count() const { return _old_set.length(); }
1310   uint archive_regions_count() const { return _archive_set.length(); }
1311   uint humongous_regions_count() const { return _humongous_set.length(); }
1312 
1313 #ifdef ASSERT
1314   bool check_young_list_empty();
1315 #endif
1316 
1317   // *** Stuff related to concurrent marking.  It&#39;s not clear to me that so
1318   // many of these need to be public.
1319 
1320   // The functions below are helper functions that a subclass of
1321   // &quot;CollectedHeap&quot; can use in the implementation of its virtual
1322   // functions.
1323   // This performs a concurrent marking of the live objects in a
1324   // bitmap off to the side.
1325   void do_concurrent_mark();
1326 
1327   bool is_marked_next(oop obj) const;
1328 
1329   // Determine if an object is dead, given the object and also
1330   // the region to which the object belongs. An object is dead
1331   // iff a) it was not allocated since the last mark, b) it
1332   // is not marked, and c) it is not in an archive region.
1333   bool is_obj_dead(const oop obj, const HeapRegion* hr) const {
1334     return
1335       hr-&gt;is_obj_dead(obj, _cm-&gt;prev_mark_bitmap()) &amp;&amp;
1336       !hr-&gt;is_archive();
1337   }
1338 
1339   // This function returns true when an object has been
1340   // around since the previous marking and hasn&#39;t yet
1341   // been marked during this marking, and is not in an archive region.
1342   bool is_obj_ill(const oop obj, const HeapRegion* hr) const {
1343     return
1344       !hr-&gt;obj_allocated_since_next_marking(obj) &amp;&amp;
1345       !is_marked_next(obj) &amp;&amp;
1346       !hr-&gt;is_archive();
1347   }
1348 
1349   // Determine if an object is dead, given only the object itself.
1350   // This will find the region to which the object belongs and
1351   // then call the region version of the same function.
1352 
1353   // Added if it is NULL it isn&#39;t dead.
1354 
1355   inline bool is_obj_dead(const oop obj) const;
1356 
1357   inline bool is_obj_ill(const oop obj) const;
1358 
1359   inline bool is_obj_dead_full(const oop obj, const HeapRegion* hr) const;
1360   inline bool is_obj_dead_full(const oop obj) const;
1361 
1362   G1ConcurrentMark* concurrent_mark() const { return _cm; }
1363 
1364   // Refinement
1365 
1366   G1ConcurrentRefine* concurrent_refine() const { return _cr; }
1367 
1368   // Optimized nmethod scanning support routines
1369 
1370   // Register the given nmethod with the G1 heap.
1371   virtual void register_nmethod(nmethod* nm);
1372 
1373   // Unregister the given nmethod from the G1 heap.
1374   virtual void unregister_nmethod(nmethod* nm);
1375 
1376   // No nmethod flushing needed.
1377   virtual void flush_nmethod(nmethod* nm) {}
1378 
1379   // No nmethod verification implemented.
1380   virtual void verify_nmethod(nmethod* nm) {}
1381 
1382   // Free up superfluous code root memory.
1383   void purge_code_root_memory();
1384 
1385   // Rebuild the strong code root lists for each region
1386   // after a full GC.
1387   void rebuild_strong_code_roots();
1388 
1389   // Partial cleaning of VM internal data structures.
1390   void string_dedup_cleaning(BoolObjectClosure* is_alive,
1391                              OopClosure* keep_alive,
1392                              G1GCPhaseTimes* phase_times = NULL);
1393 
1394   // Performs cleaning of data structures after class unloading.
1395   void complete_cleaning(BoolObjectClosure* is_alive, bool class_unloading_occurred);
1396 
1397   // Redirty logged cards in the refinement queue.
1398   void redirty_logged_cards(G1RedirtyCardsQueueSet* rdcqs);
1399 
1400   // Verification
1401 
1402   // Deduplicate the string
1403   virtual void deduplicate_string(oop str);
1404 
1405   // Perform any cleanup actions necessary before allowing a verification.
1406   virtual void prepare_for_verify();
1407 
1408   // Perform verification.
1409 
1410   // vo == UsePrevMarking -&gt; use &quot;prev&quot; marking information,
1411   // vo == UseNextMarking -&gt; use &quot;next&quot; marking information
1412   // vo == UseFullMarking -&gt; use &quot;next&quot; marking bitmap but no TAMS
1413   //
1414   // NOTE: Only the &quot;prev&quot; marking information is guaranteed to be
1415   // consistent most of the time, so most calls to this should use
1416   // vo == UsePrevMarking.
1417   // Currently, there is only one case where this is called with
1418   // vo == UseNextMarking, which is to verify the &quot;next&quot; marking
1419   // information at the end of remark.
1420   // Currently there is only one place where this is called with
1421   // vo == UseFullMarking, which is to verify the marking during a
1422   // full GC.
1423   void verify(VerifyOption vo);
1424 
1425   // WhiteBox testing support.
1426   virtual bool supports_concurrent_phase_control() const;
1427   virtual bool request_concurrent_phase(const char* phase);
1428   bool is_heterogeneous_heap() const;
1429 
1430   virtual WorkGang* get_safepoint_workers() { return _workers; }
1431 
1432   // The methods below are here for convenience and dispatch the
1433   // appropriate method depending on value of the given VerifyOption
1434   // parameter. The values for that parameter, and their meanings,
1435   // are the same as those above.
1436 
1437   bool is_obj_dead_cond(const oop obj,
1438                         const HeapRegion* hr,
1439                         const VerifyOption vo) const;
1440 
1441   bool is_obj_dead_cond(const oop obj,
1442                         const VerifyOption vo) const;
1443 
1444   G1HeapSummary create_g1_heap_summary();
1445   G1EvacSummary create_g1_evac_summary(G1EvacStats* stats);
1446 
1447   // Printing
1448 private:
1449   void print_heap_regions() const;
1450   void print_regions_on(outputStream* st) const;
1451 
1452 public:
1453   virtual void print_on(outputStream* st) const;
1454   virtual void print_extended_on(outputStream* st) const;
1455   virtual void print_on_error(outputStream* st) const;
1456 
1457   virtual void print_gc_threads_on(outputStream* st) const;
1458   virtual void gc_threads_do(ThreadClosure* tc) const;
1459 
1460   // Override
1461   void print_tracing_info() const;
1462 
1463   // The following two methods are helpful for debugging RSet issues.
1464   void print_cset_rsets() PRODUCT_RETURN;
1465   void print_all_rsets() PRODUCT_RETURN;
1466 
1467   // Used to print information about locations in the hs_err file.
1468   virtual bool print_location(outputStream* st, void* addr) const;
1469 
1470   size_t pending_card_num();
1471 };
1472 
1473 class G1ParEvacuateFollowersClosure : public VoidClosure {
1474 private:
1475   double _start_term;
1476   double _term_time;
1477   size_t _term_attempts;
1478 
1479   void start_term_time() { _term_attempts++; _start_term = os::elapsedTime(); }
1480   void end_term_time() { _term_time += (os::elapsedTime() - _start_term); }
1481 protected:
1482   G1CollectedHeap*              _g1h;
1483   G1ParScanThreadState*         _par_scan_state;
1484   RefToScanQueueSet*            _queues;
1485   TaskTerminator*               _terminator;
1486   G1GCPhaseTimes::GCParPhases   _phase;
1487 
1488   G1ParScanThreadState*   par_scan_state() { return _par_scan_state; }
1489   RefToScanQueueSet*      queues()         { return _queues; }
1490   TaskTerminator*         terminator()     { return _terminator; }
1491 
1492 public:
1493   G1ParEvacuateFollowersClosure(G1CollectedHeap* g1h,
1494                                 G1ParScanThreadState* par_scan_state,
1495                                 RefToScanQueueSet* queues,
1496                                 TaskTerminator* terminator,
1497                                 G1GCPhaseTimes::GCParPhases phase)
1498     : _start_term(0.0), _term_time(0.0), _term_attempts(0),
1499       _g1h(g1h), _par_scan_state(par_scan_state),
1500       _queues(queues), _terminator(terminator), _phase(phase) {}
1501 
1502   void do_void();
1503 
1504   double term_time() const { return _term_time; }
1505   size_t term_attempts() const { return _term_attempts; }
1506 
1507 private:
1508   inline bool offer_termination();
1509 };
1510 
1511 #endif // SHARE_GC_G1_G1COLLECTEDHEAP_HPP
    </pre>
  </body>
</html>