<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Frames src/hotspot/share/gc/g1/g1CollectedHeap.cpp</title>
    <link rel="stylesheet" href="../../../../../style.css" />
    <script type="text/javascript" src="../../../../../navigation.js"></script>
  </head>
<body onkeypress="keypress(event);">
<a name="0"></a>
<hr />
<pre>   1 /*
   2  * Copyright (c) 2001, 2020, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
  23  */
  24 
  25 #include &quot;precompiled.hpp&quot;
  26 #include &quot;classfile/classLoaderDataGraph.hpp&quot;
  27 #include &quot;classfile/metadataOnStackMark.hpp&quot;
  28 #include &quot;classfile/stringTable.hpp&quot;
  29 #include &quot;code/codeCache.hpp&quot;
  30 #include &quot;code/icBuffer.hpp&quot;
  31 #include &quot;gc/g1/g1Allocator.inline.hpp&quot;
  32 #include &quot;gc/g1/g1Arguments.hpp&quot;
  33 #include &quot;gc/g1/g1BarrierSet.hpp&quot;
  34 #include &quot;gc/g1/g1CardTableEntryClosure.hpp&quot;
  35 #include &quot;gc/g1/g1CollectedHeap.inline.hpp&quot;
  36 #include &quot;gc/g1/g1CollectionSet.hpp&quot;
  37 #include &quot;gc/g1/g1CollectorState.hpp&quot;
  38 #include &quot;gc/g1/g1ConcurrentRefine.hpp&quot;
  39 #include &quot;gc/g1/g1ConcurrentRefineThread.hpp&quot;
  40 #include &quot;gc/g1/g1ConcurrentMarkThread.inline.hpp&quot;
  41 #include &quot;gc/g1/g1DirtyCardQueue.hpp&quot;
  42 #include &quot;gc/g1/g1EvacStats.inline.hpp&quot;
  43 #include &quot;gc/g1/g1FullCollector.hpp&quot;
  44 #include &quot;gc/g1/g1GCPhaseTimes.hpp&quot;
  45 #include &quot;gc/g1/g1HeapSizingPolicy.hpp&quot;
  46 #include &quot;gc/g1/g1HeapTransition.hpp&quot;
  47 #include &quot;gc/g1/g1HeapVerifier.hpp&quot;
  48 #include &quot;gc/g1/g1HotCardCache.hpp&quot;
  49 #include &quot;gc/g1/g1MemoryPool.hpp&quot;
  50 #include &quot;gc/g1/g1OopClosures.inline.hpp&quot;
  51 #include &quot;gc/g1/g1ParallelCleaning.hpp&quot;
  52 #include &quot;gc/g1/g1ParScanThreadState.inline.hpp&quot;
  53 #include &quot;gc/g1/g1Policy.hpp&quot;
  54 #include &quot;gc/g1/g1RedirtyCardsQueue.hpp&quot;
  55 #include &quot;gc/g1/g1RegionToSpaceMapper.hpp&quot;
  56 #include &quot;gc/g1/g1RemSet.hpp&quot;
  57 #include &quot;gc/g1/g1RootClosures.hpp&quot;
  58 #include &quot;gc/g1/g1RootProcessor.hpp&quot;
  59 #include &quot;gc/g1/g1SATBMarkQueueSet.hpp&quot;
  60 #include &quot;gc/g1/g1StringDedup.hpp&quot;
  61 #include &quot;gc/g1/g1ThreadLocalData.hpp&quot;
  62 #include &quot;gc/g1/g1Trace.hpp&quot;
  63 #include &quot;gc/g1/g1YCTypes.hpp&quot;
  64 #include &quot;gc/g1/g1YoungRemSetSamplingThread.hpp&quot;
  65 #include &quot;gc/g1/g1VMOperations.hpp&quot;
  66 #include &quot;gc/g1/heapRegion.inline.hpp&quot;
  67 #include &quot;gc/g1/heapRegionRemSet.hpp&quot;
  68 #include &quot;gc/g1/heapRegionSet.inline.hpp&quot;
  69 #include &quot;gc/shared/gcBehaviours.hpp&quot;
  70 #include &quot;gc/shared/gcHeapSummary.hpp&quot;
  71 #include &quot;gc/shared/gcId.hpp&quot;
  72 #include &quot;gc/shared/gcLocker.hpp&quot;
  73 #include &quot;gc/shared/gcTimer.hpp&quot;
  74 #include &quot;gc/shared/gcTraceTime.inline.hpp&quot;
  75 #include &quot;gc/shared/generationSpec.hpp&quot;
  76 #include &quot;gc/shared/isGCActiveMark.hpp&quot;
  77 #include &quot;gc/shared/locationPrinter.inline.hpp&quot;
  78 #include &quot;gc/shared/oopStorageParState.hpp&quot;
  79 #include &quot;gc/shared/preservedMarks.inline.hpp&quot;
  80 #include &quot;gc/shared/suspendibleThreadSet.hpp&quot;
  81 #include &quot;gc/shared/referenceProcessor.inline.hpp&quot;
<a name="1" id="anc1"></a>
  82 #include &quot;gc/shared/taskqueue.inline.hpp&quot;
  83 #include &quot;gc/shared/weakProcessor.inline.hpp&quot;
  84 #include &quot;gc/shared/workerPolicy.hpp&quot;
  85 #include &quot;logging/log.hpp&quot;
  86 #include &quot;memory/allocation.hpp&quot;
  87 #include &quot;memory/iterator.hpp&quot;
  88 #include &quot;memory/resourceArea.hpp&quot;
  89 #include &quot;memory/universe.hpp&quot;
  90 #include &quot;oops/access.inline.hpp&quot;
  91 #include &quot;oops/compressedOops.inline.hpp&quot;
  92 #include &quot;oops/oop.inline.hpp&quot;
  93 #include &quot;runtime/atomic.hpp&quot;
  94 #include &quot;runtime/flags/flagSetting.hpp&quot;
  95 #include &quot;runtime/handles.inline.hpp&quot;
  96 #include &quot;runtime/init.hpp&quot;
  97 #include &quot;runtime/orderAccess.hpp&quot;
  98 #include &quot;runtime/threadSMR.hpp&quot;
  99 #include &quot;runtime/vmThread.hpp&quot;
 100 #include &quot;utilities/align.hpp&quot;
 101 #include &quot;utilities/bitMap.inline.hpp&quot;
 102 #include &quot;utilities/globalDefinitions.hpp&quot;
 103 #include &quot;utilities/stack.inline.hpp&quot;
 104 
 105 size_t G1CollectedHeap::_humongous_object_threshold_in_words = 0;
 106 
 107 // INVARIANTS/NOTES
 108 //
 109 // All allocation activity covered by the G1CollectedHeap interface is
 110 // serialized by acquiring the HeapLock.  This happens in mem_allocate
 111 // and allocate_new_tlab, which are the &quot;entry&quot; points to the
 112 // allocation code from the rest of the JVM.  (Note that this does not
 113 // apply to TLAB allocation, which is not part of this interface: it
 114 // is done by clients of this interface.)
 115 
 116 class RedirtyLoggedCardTableEntryClosure : public G1CardTableEntryClosure {
 117  private:
 118   size_t _num_dirtied;
 119   G1CollectedHeap* _g1h;
 120   G1CardTable* _g1_ct;
 121 
 122   HeapRegion* region_for_card(CardValue* card_ptr) const {
 123     return _g1h-&gt;heap_region_containing(_g1_ct-&gt;addr_for(card_ptr));
 124   }
 125 
 126   bool will_become_free(HeapRegion* hr) const {
 127     // A region will be freed by free_collection_set if the region is in the
 128     // collection set and has not had an evacuation failure.
 129     return _g1h-&gt;is_in_cset(hr) &amp;&amp; !hr-&gt;evacuation_failed();
 130   }
 131 
 132  public:
 133   RedirtyLoggedCardTableEntryClosure(G1CollectedHeap* g1h) : G1CardTableEntryClosure(),
 134     _num_dirtied(0), _g1h(g1h), _g1_ct(g1h-&gt;card_table()) { }
 135 
 136   void do_card_ptr(CardValue* card_ptr, uint worker_id) {
 137     HeapRegion* hr = region_for_card(card_ptr);
 138 
 139     // Should only dirty cards in regions that won&#39;t be freed.
 140     if (!will_become_free(hr)) {
 141       *card_ptr = G1CardTable::dirty_card_val();
 142       _num_dirtied++;
 143     }
 144   }
 145 
 146   size_t num_dirtied()   const { return _num_dirtied; }
 147 };
 148 
 149 
 150 void G1RegionMappingChangedListener::reset_from_card_cache(uint start_idx, size_t num_regions) {
 151   HeapRegionRemSet::invalidate_from_card_cache(start_idx, num_regions);
 152 }
 153 
 154 void G1RegionMappingChangedListener::on_commit(uint start_idx, size_t num_regions, bool zero_filled) {
 155   // The from card cache is not the memory that is actually committed. So we cannot
 156   // take advantage of the zero_filled parameter.
 157   reset_from_card_cache(start_idx, num_regions);
 158 }
 159 
 160 Tickspan G1CollectedHeap::run_task(AbstractGangTask* task) {
 161   Ticks start = Ticks::now();
 162   workers()-&gt;run_task(task, workers()-&gt;active_workers());
 163   return Ticks::now() - start;
 164 }
 165 
 166 HeapRegion* G1CollectedHeap::new_heap_region(uint hrs_index,
 167                                              MemRegion mr) {
 168   return new HeapRegion(hrs_index, bot(), mr);
 169 }
 170 
 171 // Private methods.
 172 
 173 HeapRegion* G1CollectedHeap::new_region(size_t word_size,
 174                                         HeapRegionType type,
 175                                         bool do_expand,
 176                                         uint node_index) {
 177   assert(!is_humongous(word_size) || word_size &lt;= HeapRegion::GrainWords,
 178          &quot;the only time we use this to allocate a humongous region is &quot;
 179          &quot;when we are allocating a single humongous region&quot;);
 180 
 181   HeapRegion* res = _hrm-&gt;allocate_free_region(type, node_index);
 182 
 183   if (res == NULL &amp;&amp; do_expand &amp;&amp; _expand_heap_after_alloc_failure) {
 184     // Currently, only attempts to allocate GC alloc regions set
 185     // do_expand to true. So, we should only reach here during a
 186     // safepoint. If this assumption changes we might have to
 187     // reconsider the use of _expand_heap_after_alloc_failure.
 188     assert(SafepointSynchronize::is_at_safepoint(), &quot;invariant&quot;);
 189 
 190     log_debug(gc, ergo, heap)(&quot;Attempt heap expansion (region allocation request failed). Allocation request: &quot; SIZE_FORMAT &quot;B&quot;,
 191                               word_size * HeapWordSize);
 192 
 193     assert(word_size * HeapWordSize &lt; HeapRegion::GrainBytes,
 194            &quot;This kind of expansion should never be more than one region. Size: &quot; SIZE_FORMAT,
 195            word_size * HeapWordSize);
 196     if (expand_single_region(node_index)) {
 197       // Given that expand_single_region() succeeded in expanding the heap, and we
 198       // always expand the heap by an amount aligned to the heap
 199       // region size, the free list should in theory not be empty.
 200       // In either case allocate_free_region() will check for NULL.
 201       res = _hrm-&gt;allocate_free_region(type, node_index);
 202     } else {
 203       _expand_heap_after_alloc_failure = false;
 204     }
 205   }
 206   return res;
 207 }
 208 
 209 HeapWord*
 210 G1CollectedHeap::humongous_obj_allocate_initialize_regions(uint first,
 211                                                            uint num_regions,
 212                                                            size_t word_size) {
 213   assert(first != G1_NO_HRM_INDEX, &quot;pre-condition&quot;);
 214   assert(is_humongous(word_size), &quot;word_size should be humongous&quot;);
 215   assert(num_regions * HeapRegion::GrainWords &gt;= word_size, &quot;pre-condition&quot;);
 216 
 217   // Index of last region in the series.
 218   uint last = first + num_regions - 1;
 219 
 220   // We need to initialize the region(s) we just discovered. This is
 221   // a bit tricky given that it can happen concurrently with
 222   // refinement threads refining cards on these regions and
 223   // potentially wanting to refine the BOT as they are scanning
 224   // those cards (this can happen shortly after a cleanup; see CR
 225   // 6991377). So we have to set up the region(s) carefully and in
 226   // a specific order.
 227 
 228   // The word size sum of all the regions we will allocate.
 229   size_t word_size_sum = (size_t) num_regions * HeapRegion::GrainWords;
 230   assert(word_size &lt;= word_size_sum, &quot;sanity&quot;);
 231 
 232   // This will be the &quot;starts humongous&quot; region.
 233   HeapRegion* first_hr = region_at(first);
 234   // The header of the new object will be placed at the bottom of
 235   // the first region.
 236   HeapWord* new_obj = first_hr-&gt;bottom();
 237   // This will be the new top of the new object.
 238   HeapWord* obj_top = new_obj + word_size;
 239 
 240   // First, we need to zero the header of the space that we will be
 241   // allocating. When we update top further down, some refinement
 242   // threads might try to scan the region. By zeroing the header we
 243   // ensure that any thread that will try to scan the region will
 244   // come across the zero klass word and bail out.
 245   //
 246   // NOTE: It would not have been correct to have used
 247   // CollectedHeap::fill_with_object() and make the space look like
 248   // an int array. The thread that is doing the allocation will
 249   // later update the object header to a potentially different array
 250   // type and, for a very short period of time, the klass and length
 251   // fields will be inconsistent. This could cause a refinement
 252   // thread to calculate the object size incorrectly.
 253   Copy::fill_to_words(new_obj, oopDesc::header_size(), 0);
 254 
 255   // Next, pad out the unused tail of the last region with filler
 256   // objects, for improved usage accounting.
 257   // How many words we use for filler objects.
 258   size_t word_fill_size = word_size_sum - word_size;
 259 
 260   // How many words memory we &quot;waste&quot; which cannot hold a filler object.
 261   size_t words_not_fillable = 0;
 262 
 263   if (word_fill_size &gt;= min_fill_size()) {
 264     fill_with_objects(obj_top, word_fill_size);
 265   } else if (word_fill_size &gt; 0) {
 266     // We have space to fill, but we cannot fit an object there.
 267     words_not_fillable = word_fill_size;
 268     word_fill_size = 0;
 269   }
 270 
 271   // We will set up the first region as &quot;starts humongous&quot;. This
 272   // will also update the BOT covering all the regions to reflect
 273   // that there is a single object that starts at the bottom of the
 274   // first region.
 275   first_hr-&gt;set_starts_humongous(obj_top, word_fill_size);
 276   _policy-&gt;remset_tracker()-&gt;update_at_allocate(first_hr);
 277   // Then, if there are any, we will set up the &quot;continues
 278   // humongous&quot; regions.
 279   HeapRegion* hr = NULL;
 280   for (uint i = first + 1; i &lt;= last; ++i) {
 281     hr = region_at(i);
 282     hr-&gt;set_continues_humongous(first_hr);
 283     _policy-&gt;remset_tracker()-&gt;update_at_allocate(hr);
 284   }
 285 
 286   // Up to this point no concurrent thread would have been able to
 287   // do any scanning on any region in this series. All the top
 288   // fields still point to bottom, so the intersection between
 289   // [bottom,top] and [card_start,card_end] will be empty. Before we
 290   // update the top fields, we&#39;ll do a storestore to make sure that
 291   // no thread sees the update to top before the zeroing of the
 292   // object header and the BOT initialization.
 293   OrderAccess::storestore();
 294 
 295   // Now, we will update the top fields of the &quot;continues humongous&quot;
 296   // regions except the last one.
 297   for (uint i = first; i &lt; last; ++i) {
 298     hr = region_at(i);
 299     hr-&gt;set_top(hr-&gt;end());
 300   }
 301 
 302   hr = region_at(last);
 303   // If we cannot fit a filler object, we must set top to the end
 304   // of the humongous object, otherwise we cannot iterate the heap
 305   // and the BOT will not be complete.
 306   hr-&gt;set_top(hr-&gt;end() - words_not_fillable);
 307 
 308   assert(hr-&gt;bottom() &lt; obj_top &amp;&amp; obj_top &lt;= hr-&gt;end(),
 309          &quot;obj_top should be in last region&quot;);
 310 
 311   _verifier-&gt;check_bitmaps(&quot;Humongous Region Allocation&quot;, first_hr);
 312 
 313   assert(words_not_fillable == 0 ||
 314          first_hr-&gt;bottom() + word_size_sum - words_not_fillable == hr-&gt;top(),
 315          &quot;Miscalculation in humongous allocation&quot;);
 316 
 317   increase_used((word_size_sum - words_not_fillable) * HeapWordSize);
 318 
 319   for (uint i = first; i &lt;= last; ++i) {
 320     hr = region_at(i);
 321     _humongous_set.add(hr);
 322     _hr_printer.alloc(hr);
 323   }
 324 
 325   return new_obj;
 326 }
 327 
 328 size_t G1CollectedHeap::humongous_obj_size_in_regions(size_t word_size) {
 329   assert(is_humongous(word_size), &quot;Object of size &quot; SIZE_FORMAT &quot; must be humongous here&quot;, word_size);
 330   return align_up(word_size, HeapRegion::GrainWords) / HeapRegion::GrainWords;
 331 }
 332 
 333 // If could fit into free regions w/o expansion, try.
 334 // Otherwise, if can expand, do so.
 335 // Otherwise, if using ex regions might help, try with ex given back.
 336 HeapWord* G1CollectedHeap::humongous_obj_allocate(size_t word_size) {
 337   assert_heap_locked_or_at_safepoint(true /* should_be_vm_thread */);
 338 
 339   _verifier-&gt;verify_region_sets_optional();
 340 
 341   uint first = G1_NO_HRM_INDEX;
 342   uint obj_regions = (uint) humongous_obj_size_in_regions(word_size);
 343 
 344   if (obj_regions == 1) {
 345     // Only one region to allocate, try to use a fast path by directly allocating
 346     // from the free lists. Do not try to expand here, we will potentially do that
 347     // later.
 348     HeapRegion* hr = new_region(word_size, HeapRegionType::Humongous, false /* do_expand */);
 349     if (hr != NULL) {
 350       first = hr-&gt;hrm_index();
 351     }
 352   } else {
 353     // Policy: Try only empty regions (i.e. already committed first). Maybe we
 354     // are lucky enough to find some.
 355     first = _hrm-&gt;find_contiguous_only_empty(obj_regions);
 356     if (first != G1_NO_HRM_INDEX) {
 357       _hrm-&gt;allocate_free_regions_starting_at(first, obj_regions);
 358     }
 359   }
 360 
 361   if (first == G1_NO_HRM_INDEX) {
 362     // Policy: We could not find enough regions for the humongous object in the
 363     // free list. Look through the heap to find a mix of free and uncommitted regions.
 364     // If so, try expansion.
 365     first = _hrm-&gt;find_contiguous_empty_or_unavailable(obj_regions);
 366     if (first != G1_NO_HRM_INDEX) {
 367       // We found something. Make sure these regions are committed, i.e. expand
 368       // the heap. Alternatively we could do a defragmentation GC.
 369       log_debug(gc, ergo, heap)(&quot;Attempt heap expansion (humongous allocation request failed). Allocation request: &quot; SIZE_FORMAT &quot;B&quot;,
 370                                     word_size * HeapWordSize);
 371 
 372       _hrm-&gt;expand_at(first, obj_regions, workers());
 373       policy()-&gt;record_new_heap_size(num_regions());
 374 
 375 #ifdef ASSERT
 376       for (uint i = first; i &lt; first + obj_regions; ++i) {
 377         HeapRegion* hr = region_at(i);
 378         assert(hr-&gt;is_free(), &quot;sanity&quot;);
 379         assert(hr-&gt;is_empty(), &quot;sanity&quot;);
 380         assert(is_on_master_free_list(hr), &quot;sanity&quot;);
 381       }
 382 #endif
 383       _hrm-&gt;allocate_free_regions_starting_at(first, obj_regions);
 384     } else {
 385       // Policy: Potentially trigger a defragmentation GC.
 386     }
 387   }
 388 
 389   HeapWord* result = NULL;
 390   if (first != G1_NO_HRM_INDEX) {
 391     result = humongous_obj_allocate_initialize_regions(first, obj_regions, word_size);
 392     assert(result != NULL, &quot;it should always return a valid result&quot;);
 393 
 394     // A successful humongous object allocation changes the used space
 395     // information of the old generation so we need to recalculate the
 396     // sizes and update the jstat counters here.
 397     g1mm()-&gt;update_sizes();
 398   }
 399 
 400   _verifier-&gt;verify_region_sets_optional();
 401 
 402   return result;
 403 }
 404 
 405 HeapWord* G1CollectedHeap::allocate_new_tlab(size_t min_size,
 406                                              size_t requested_size,
 407                                              size_t* actual_size) {
 408   assert_heap_not_locked_and_not_at_safepoint();
 409   assert(!is_humongous(requested_size), &quot;we do not allow humongous TLABs&quot;);
 410 
 411   return attempt_allocation(min_size, requested_size, actual_size);
 412 }
 413 
 414 HeapWord*
 415 G1CollectedHeap::mem_allocate(size_t word_size,
 416                               bool*  gc_overhead_limit_was_exceeded) {
 417   assert_heap_not_locked_and_not_at_safepoint();
 418 
 419   if (is_humongous(word_size)) {
 420     return attempt_allocation_humongous(word_size);
 421   }
 422   size_t dummy = 0;
 423   return attempt_allocation(word_size, word_size, &amp;dummy);
 424 }
 425 
 426 HeapWord* G1CollectedHeap::attempt_allocation_slow(size_t word_size) {
 427   ResourceMark rm; // For retrieving the thread names in log messages.
 428 
 429   // Make sure you read the note in attempt_allocation_humongous().
 430 
 431   assert_heap_not_locked_and_not_at_safepoint();
 432   assert(!is_humongous(word_size), &quot;attempt_allocation_slow() should not &quot;
 433          &quot;be called for humongous allocation requests&quot;);
 434 
 435   // We should only get here after the first-level allocation attempt
 436   // (attempt_allocation()) failed to allocate.
 437 
 438   // We will loop until a) we manage to successfully perform the
 439   // allocation or b) we successfully schedule a collection which
 440   // fails to perform the allocation. b) is the only case when we&#39;ll
 441   // return NULL.
 442   HeapWord* result = NULL;
 443   for (uint try_count = 1, gclocker_retry_count = 0; /* we&#39;ll return */; try_count += 1) {
 444     bool should_try_gc;
 445     uint gc_count_before;
 446 
 447     {
 448       MutexLocker x(Heap_lock);
 449       result = _allocator-&gt;attempt_allocation_locked(word_size);
 450       if (result != NULL) {
 451         return result;
 452       }
 453 
 454       // If the GCLocker is active and we are bound for a GC, try expanding young gen.
 455       // This is different to when only GCLocker::needs_gc() is set: try to avoid
 456       // waiting because the GCLocker is active to not wait too long.
 457       if (GCLocker::is_active_and_needs_gc() &amp;&amp; policy()-&gt;can_expand_young_list()) {
 458         // No need for an ergo message here, can_expand_young_list() does this when
 459         // it returns true.
 460         result = _allocator-&gt;attempt_allocation_force(word_size);
 461         if (result != NULL) {
 462           return result;
 463         }
 464       }
 465       // Only try a GC if the GCLocker does not signal the need for a GC. Wait until
 466       // the GCLocker initiated GC has been performed and then retry. This includes
 467       // the case when the GC Locker is not active but has not been performed.
 468       should_try_gc = !GCLocker::needs_gc();
 469       // Read the GC count while still holding the Heap_lock.
 470       gc_count_before = total_collections();
 471     }
 472 
 473     if (should_try_gc) {
 474       bool succeeded;
 475       result = do_collection_pause(word_size, gc_count_before, &amp;succeeded,
 476                                    GCCause::_g1_inc_collection_pause);
 477       if (result != NULL) {
 478         assert(succeeded, &quot;only way to get back a non-NULL result&quot;);
 479         log_trace(gc, alloc)(&quot;%s: Successfully scheduled collection returning &quot; PTR_FORMAT,
 480                              Thread::current()-&gt;name(), p2i(result));
 481         return result;
 482       }
 483 
 484       if (succeeded) {
 485         // We successfully scheduled a collection which failed to allocate. No
 486         // point in trying to allocate further. We&#39;ll just return NULL.
 487         log_trace(gc, alloc)(&quot;%s: Successfully scheduled collection failing to allocate &quot;
 488                              SIZE_FORMAT &quot; words&quot;, Thread::current()-&gt;name(), word_size);
 489         return NULL;
 490       }
 491       log_trace(gc, alloc)(&quot;%s: Unsuccessfully scheduled collection allocating &quot; SIZE_FORMAT &quot; words&quot;,
 492                            Thread::current()-&gt;name(), word_size);
 493     } else {
 494       // Failed to schedule a collection.
 495       if (gclocker_retry_count &gt; GCLockerRetryAllocationCount) {
 496         log_warning(gc, alloc)(&quot;%s: Retried waiting for GCLocker too often allocating &quot;
 497                                SIZE_FORMAT &quot; words&quot;, Thread::current()-&gt;name(), word_size);
 498         return NULL;
 499       }
 500       log_trace(gc, alloc)(&quot;%s: Stall until clear&quot;, Thread::current()-&gt;name());
 501       // The GCLocker is either active or the GCLocker initiated
 502       // GC has not yet been performed. Stall until it is and
 503       // then retry the allocation.
 504       GCLocker::stall_until_clear();
 505       gclocker_retry_count += 1;
 506     }
 507 
 508     // We can reach here if we were unsuccessful in scheduling a
 509     // collection (because another thread beat us to it) or if we were
 510     // stalled due to the GC locker. In either can we should retry the
 511     // allocation attempt in case another thread successfully
 512     // performed a collection and reclaimed enough space. We do the
 513     // first attempt (without holding the Heap_lock) here and the
 514     // follow-on attempt will be at the start of the next loop
 515     // iteration (after taking the Heap_lock).
 516     size_t dummy = 0;
 517     result = _allocator-&gt;attempt_allocation(word_size, word_size, &amp;dummy);
 518     if (result != NULL) {
 519       return result;
 520     }
 521 
 522     // Give a warning if we seem to be looping forever.
 523     if ((QueuedAllocationWarningCount &gt; 0) &amp;&amp;
 524         (try_count % QueuedAllocationWarningCount == 0)) {
 525       log_warning(gc, alloc)(&quot;%s:  Retried allocation %u times for &quot; SIZE_FORMAT &quot; words&quot;,
 526                              Thread::current()-&gt;name(), try_count, word_size);
 527     }
 528   }
 529 
 530   ShouldNotReachHere();
 531   return NULL;
 532 }
 533 
 534 void G1CollectedHeap::begin_archive_alloc_range(bool open) {
 535   assert_at_safepoint_on_vm_thread();
 536   if (_archive_allocator == NULL) {
 537     _archive_allocator = G1ArchiveAllocator::create_allocator(this, open);
 538   }
 539 }
 540 
 541 bool G1CollectedHeap::is_archive_alloc_too_large(size_t word_size) {
 542   // Allocations in archive regions cannot be of a size that would be considered
 543   // humongous even for a minimum-sized region, because G1 region sizes/boundaries
 544   // may be different at archive-restore time.
 545   return word_size &gt;= humongous_threshold_for(HeapRegion::min_region_size_in_words());
 546 }
 547 
 548 HeapWord* G1CollectedHeap::archive_mem_allocate(size_t word_size) {
 549   assert_at_safepoint_on_vm_thread();
 550   assert(_archive_allocator != NULL, &quot;_archive_allocator not initialized&quot;);
 551   if (is_archive_alloc_too_large(word_size)) {
 552     return NULL;
 553   }
 554   return _archive_allocator-&gt;archive_mem_allocate(word_size);
 555 }
 556 
 557 void G1CollectedHeap::end_archive_alloc_range(GrowableArray&lt;MemRegion&gt;* ranges,
 558                                               size_t end_alignment_in_bytes) {
 559   assert_at_safepoint_on_vm_thread();
 560   assert(_archive_allocator != NULL, &quot;_archive_allocator not initialized&quot;);
 561 
 562   // Call complete_archive to do the real work, filling in the MemRegion
 563   // array with the archive regions.
 564   _archive_allocator-&gt;complete_archive(ranges, end_alignment_in_bytes);
 565   delete _archive_allocator;
 566   _archive_allocator = NULL;
 567 }
 568 
 569 bool G1CollectedHeap::check_archive_addresses(MemRegion* ranges, size_t count) {
 570   assert(ranges != NULL, &quot;MemRegion array NULL&quot;);
 571   assert(count != 0, &quot;No MemRegions provided&quot;);
 572   MemRegion reserved = _hrm-&gt;reserved();
 573   for (size_t i = 0; i &lt; count; i++) {
 574     if (!reserved.contains(ranges[i].start()) || !reserved.contains(ranges[i].last())) {
 575       return false;
 576     }
 577   }
 578   return true;
 579 }
 580 
 581 bool G1CollectedHeap::alloc_archive_regions(MemRegion* ranges,
 582                                             size_t count,
 583                                             bool open) {
 584   assert(!is_init_completed(), &quot;Expect to be called at JVM init time&quot;);
 585   assert(ranges != NULL, &quot;MemRegion array NULL&quot;);
 586   assert(count != 0, &quot;No MemRegions provided&quot;);
 587   MutexLocker x(Heap_lock);
 588 
 589   MemRegion reserved = _hrm-&gt;reserved();
 590   HeapWord* prev_last_addr = NULL;
 591   HeapRegion* prev_last_region = NULL;
 592 
 593   // Temporarily disable pretouching of heap pages. This interface is used
 594   // when mmap&#39;ing archived heap data in, so pre-touching is wasted.
 595   FlagSetting fs(AlwaysPreTouch, false);
 596 
 597   // Enable archive object checking used by G1MarkSweep. We have to let it know
 598   // about each archive range, so that objects in those ranges aren&#39;t marked.
 599   G1ArchiveAllocator::enable_archive_object_check();
 600 
 601   // For each specified MemRegion range, allocate the corresponding G1
 602   // regions and mark them as archive regions. We expect the ranges
 603   // in ascending starting address order, without overlap.
 604   for (size_t i = 0; i &lt; count; i++) {
 605     MemRegion curr_range = ranges[i];
 606     HeapWord* start_address = curr_range.start();
 607     size_t word_size = curr_range.word_size();
 608     HeapWord* last_address = curr_range.last();
 609     size_t commits = 0;
 610 
 611     guarantee(reserved.contains(start_address) &amp;&amp; reserved.contains(last_address),
 612               &quot;MemRegion outside of heap [&quot; PTR_FORMAT &quot;, &quot; PTR_FORMAT &quot;]&quot;,
 613               p2i(start_address), p2i(last_address));
 614     guarantee(start_address &gt; prev_last_addr,
 615               &quot;Ranges not in ascending order: &quot; PTR_FORMAT &quot; &lt;= &quot; PTR_FORMAT ,
 616               p2i(start_address), p2i(prev_last_addr));
 617     prev_last_addr = last_address;
 618 
 619     // Check for ranges that start in the same G1 region in which the previous
 620     // range ended, and adjust the start address so we don&#39;t try to allocate
 621     // the same region again. If the current range is entirely within that
 622     // region, skip it, just adjusting the recorded top.
 623     HeapRegion* start_region = _hrm-&gt;addr_to_region(start_address);
 624     if ((prev_last_region != NULL) &amp;&amp; (start_region == prev_last_region)) {
 625       start_address = start_region-&gt;end();
 626       if (start_address &gt; last_address) {
 627         increase_used(word_size * HeapWordSize);
 628         start_region-&gt;set_top(last_address + 1);
 629         continue;
 630       }
 631       start_region-&gt;set_top(start_address);
 632       curr_range = MemRegion(start_address, last_address + 1);
 633       start_region = _hrm-&gt;addr_to_region(start_address);
 634     }
 635 
 636     // Perform the actual region allocation, exiting if it fails.
 637     // Then note how much new space we have allocated.
 638     if (!_hrm-&gt;allocate_containing_regions(curr_range, &amp;commits, workers())) {
 639       return false;
 640     }
 641     increase_used(word_size * HeapWordSize);
 642     if (commits != 0) {
 643       log_debug(gc, ergo, heap)(&quot;Attempt heap expansion (allocate archive regions). Total size: &quot; SIZE_FORMAT &quot;B&quot;,
 644                                 HeapRegion::GrainWords * HeapWordSize * commits);
 645 
 646     }
 647 
 648     // Mark each G1 region touched by the range as archive, add it to
 649     // the old set, and set top.
 650     HeapRegion* curr_region = _hrm-&gt;addr_to_region(start_address);
 651     HeapRegion* last_region = _hrm-&gt;addr_to_region(last_address);
 652     prev_last_region = last_region;
 653 
 654     while (curr_region != NULL) {
 655       assert(curr_region-&gt;is_empty() &amp;&amp; !curr_region-&gt;is_pinned(),
 656              &quot;Region already in use (index %u)&quot;, curr_region-&gt;hrm_index());
 657       if (open) {
 658         curr_region-&gt;set_open_archive();
 659       } else {
 660         curr_region-&gt;set_closed_archive();
 661       }
 662       _hr_printer.alloc(curr_region);
 663       _archive_set.add(curr_region);
 664       HeapWord* top;
 665       HeapRegion* next_region;
 666       if (curr_region != last_region) {
 667         top = curr_region-&gt;end();
 668         next_region = _hrm-&gt;next_region_in_heap(curr_region);
 669       } else {
 670         top = last_address + 1;
 671         next_region = NULL;
 672       }
 673       curr_region-&gt;set_top(top);
 674       curr_region = next_region;
 675     }
 676 
 677     // Notify mark-sweep of the archive
 678     G1ArchiveAllocator::set_range_archive(curr_range, open);
 679   }
 680   return true;
 681 }
 682 
 683 void G1CollectedHeap::fill_archive_regions(MemRegion* ranges, size_t count) {
 684   assert(!is_init_completed(), &quot;Expect to be called at JVM init time&quot;);
 685   assert(ranges != NULL, &quot;MemRegion array NULL&quot;);
 686   assert(count != 0, &quot;No MemRegions provided&quot;);
 687   MemRegion reserved = _hrm-&gt;reserved();
 688   HeapWord *prev_last_addr = NULL;
 689   HeapRegion* prev_last_region = NULL;
 690 
 691   // For each MemRegion, create filler objects, if needed, in the G1 regions
 692   // that contain the address range. The address range actually within the
 693   // MemRegion will not be modified. That is assumed to have been initialized
 694   // elsewhere, probably via an mmap of archived heap data.
 695   MutexLocker x(Heap_lock);
 696   for (size_t i = 0; i &lt; count; i++) {
 697     HeapWord* start_address = ranges[i].start();
 698     HeapWord* last_address = ranges[i].last();
 699 
 700     assert(reserved.contains(start_address) &amp;&amp; reserved.contains(last_address),
 701            &quot;MemRegion outside of heap [&quot; PTR_FORMAT &quot;, &quot; PTR_FORMAT &quot;]&quot;,
 702            p2i(start_address), p2i(last_address));
 703     assert(start_address &gt; prev_last_addr,
 704            &quot;Ranges not in ascending order: &quot; PTR_FORMAT &quot; &lt;= &quot; PTR_FORMAT ,
 705            p2i(start_address), p2i(prev_last_addr));
 706 
 707     HeapRegion* start_region = _hrm-&gt;addr_to_region(start_address);
 708     HeapRegion* last_region = _hrm-&gt;addr_to_region(last_address);
 709     HeapWord* bottom_address = start_region-&gt;bottom();
 710 
 711     // Check for a range beginning in the same region in which the
 712     // previous one ended.
 713     if (start_region == prev_last_region) {
 714       bottom_address = prev_last_addr + 1;
 715     }
 716 
 717     // Verify that the regions were all marked as archive regions by
 718     // alloc_archive_regions.
 719     HeapRegion* curr_region = start_region;
 720     while (curr_region != NULL) {
 721       guarantee(curr_region-&gt;is_archive(),
 722                 &quot;Expected archive region at index %u&quot;, curr_region-&gt;hrm_index());
 723       if (curr_region != last_region) {
 724         curr_region = _hrm-&gt;next_region_in_heap(curr_region);
 725       } else {
 726         curr_region = NULL;
 727       }
 728     }
 729 
 730     prev_last_addr = last_address;
 731     prev_last_region = last_region;
 732 
 733     // Fill the memory below the allocated range with dummy object(s),
 734     // if the region bottom does not match the range start, or if the previous
 735     // range ended within the same G1 region, and there is a gap.
 736     if (start_address != bottom_address) {
 737       size_t fill_size = pointer_delta(start_address, bottom_address);
 738       G1CollectedHeap::fill_with_objects(bottom_address, fill_size);
 739       increase_used(fill_size * HeapWordSize);
 740     }
 741   }
 742 }
 743 
 744 inline HeapWord* G1CollectedHeap::attempt_allocation(size_t min_word_size,
 745                                                      size_t desired_word_size,
 746                                                      size_t* actual_word_size) {
 747   assert_heap_not_locked_and_not_at_safepoint();
 748   assert(!is_humongous(desired_word_size), &quot;attempt_allocation() should not &quot;
 749          &quot;be called for humongous allocation requests&quot;);
 750 
 751   HeapWord* result = _allocator-&gt;attempt_allocation(min_word_size, desired_word_size, actual_word_size);
 752 
 753   if (result == NULL) {
 754     *actual_word_size = desired_word_size;
 755     result = attempt_allocation_slow(desired_word_size);
 756   }
 757 
 758   assert_heap_not_locked();
 759   if (result != NULL) {
 760     assert(*actual_word_size != 0, &quot;Actual size must have been set here&quot;);
 761     dirty_young_block(result, *actual_word_size);
 762   } else {
 763     *actual_word_size = 0;
 764   }
 765 
 766   return result;
 767 }
 768 
 769 void G1CollectedHeap::dealloc_archive_regions(MemRegion* ranges, size_t count) {
 770   assert(!is_init_completed(), &quot;Expect to be called at JVM init time&quot;);
 771   assert(ranges != NULL, &quot;MemRegion array NULL&quot;);
 772   assert(count != 0, &quot;No MemRegions provided&quot;);
 773   MemRegion reserved = _hrm-&gt;reserved();
 774   HeapWord* prev_last_addr = NULL;
 775   HeapRegion* prev_last_region = NULL;
 776   size_t size_used = 0;
 777   size_t uncommitted_regions = 0;
 778 
 779   // For each Memregion, free the G1 regions that constitute it, and
 780   // notify mark-sweep that the range is no longer to be considered &#39;archive.&#39;
 781   MutexLocker x(Heap_lock);
 782   for (size_t i = 0; i &lt; count; i++) {
 783     HeapWord* start_address = ranges[i].start();
 784     HeapWord* last_address = ranges[i].last();
 785 
 786     assert(reserved.contains(start_address) &amp;&amp; reserved.contains(last_address),
 787            &quot;MemRegion outside of heap [&quot; PTR_FORMAT &quot;, &quot; PTR_FORMAT &quot;]&quot;,
 788            p2i(start_address), p2i(last_address));
 789     assert(start_address &gt; prev_last_addr,
 790            &quot;Ranges not in ascending order: &quot; PTR_FORMAT &quot; &lt;= &quot; PTR_FORMAT ,
 791            p2i(start_address), p2i(prev_last_addr));
 792     size_used += ranges[i].byte_size();
 793     prev_last_addr = last_address;
 794 
 795     HeapRegion* start_region = _hrm-&gt;addr_to_region(start_address);
 796     HeapRegion* last_region = _hrm-&gt;addr_to_region(last_address);
 797 
 798     // Check for ranges that start in the same G1 region in which the previous
 799     // range ended, and adjust the start address so we don&#39;t try to free
 800     // the same region again. If the current range is entirely within that
 801     // region, skip it.
 802     if (start_region == prev_last_region) {
 803       start_address = start_region-&gt;end();
 804       if (start_address &gt; last_address) {
 805         continue;
 806       }
 807       start_region = _hrm-&gt;addr_to_region(start_address);
 808     }
 809     prev_last_region = last_region;
 810 
 811     // After verifying that each region was marked as an archive region by
 812     // alloc_archive_regions, set it free and empty and uncommit it.
 813     HeapRegion* curr_region = start_region;
 814     while (curr_region != NULL) {
 815       guarantee(curr_region-&gt;is_archive(),
 816                 &quot;Expected archive region at index %u&quot;, curr_region-&gt;hrm_index());
 817       uint curr_index = curr_region-&gt;hrm_index();
 818       _archive_set.remove(curr_region);
 819       curr_region-&gt;set_free();
 820       curr_region-&gt;set_top(curr_region-&gt;bottom());
 821       if (curr_region != last_region) {
 822         curr_region = _hrm-&gt;next_region_in_heap(curr_region);
 823       } else {
 824         curr_region = NULL;
 825       }
 826       _hrm-&gt;shrink_at(curr_index, 1);
 827       uncommitted_regions++;
 828     }
 829 
 830     // Notify mark-sweep that this is no longer an archive range.
 831     G1ArchiveAllocator::clear_range_archive(ranges[i]);
 832   }
 833 
 834   if (uncommitted_regions != 0) {
 835     log_debug(gc, ergo, heap)(&quot;Attempt heap shrinking (uncommitted archive regions). Total size: &quot; SIZE_FORMAT &quot;B&quot;,
 836                               HeapRegion::GrainWords * HeapWordSize * uncommitted_regions);
 837   }
 838   decrease_used(size_used);
 839 }
 840 
 841 oop G1CollectedHeap::materialize_archived_object(oop obj) {
 842   assert(obj != NULL, &quot;archived obj is NULL&quot;);
 843   assert(G1ArchiveAllocator::is_archived_object(obj), &quot;must be archived object&quot;);
 844 
 845   // Loading an archived object makes it strongly reachable. If it is
 846   // loaded during concurrent marking, it must be enqueued to the SATB
 847   // queue, shading the previously white object gray.
 848   G1BarrierSet::enqueue(obj);
 849 
 850   return obj;
 851 }
 852 
 853 HeapWord* G1CollectedHeap::attempt_allocation_humongous(size_t word_size) {
 854   ResourceMark rm; // For retrieving the thread names in log messages.
 855 
 856   // The structure of this method has a lot of similarities to
 857   // attempt_allocation_slow(). The reason these two were not merged
 858   // into a single one is that such a method would require several &quot;if
 859   // allocation is not humongous do this, otherwise do that&quot;
 860   // conditional paths which would obscure its flow. In fact, an early
 861   // version of this code did use a unified method which was harder to
 862   // follow and, as a result, it had subtle bugs that were hard to
 863   // track down. So keeping these two methods separate allows each to
 864   // be more readable. It will be good to keep these two in sync as
 865   // much as possible.
 866 
 867   assert_heap_not_locked_and_not_at_safepoint();
 868   assert(is_humongous(word_size), &quot;attempt_allocation_humongous() &quot;
 869          &quot;should only be called for humongous allocations&quot;);
 870 
 871   // Humongous objects can exhaust the heap quickly, so we should check if we
 872   // need to start a marking cycle at each humongous object allocation. We do
 873   // the check before we do the actual allocation. The reason for doing it
 874   // before the allocation is that we avoid having to keep track of the newly
 875   // allocated memory while we do a GC.
 876   if (policy()-&gt;need_to_start_conc_mark(&quot;concurrent humongous allocation&quot;,
 877                                            word_size)) {
 878     collect(GCCause::_g1_humongous_allocation);
 879   }
 880 
 881   // We will loop until a) we manage to successfully perform the
 882   // allocation or b) we successfully schedule a collection which
 883   // fails to perform the allocation. b) is the only case when we&#39;ll
 884   // return NULL.
 885   HeapWord* result = NULL;
 886   for (uint try_count = 1, gclocker_retry_count = 0; /* we&#39;ll return */; try_count += 1) {
 887     bool should_try_gc;
 888     uint gc_count_before;
 889 
 890 
 891     {
 892       MutexLocker x(Heap_lock);
 893 
 894       // Given that humongous objects are not allocated in young
 895       // regions, we&#39;ll first try to do the allocation without doing a
 896       // collection hoping that there&#39;s enough space in the heap.
 897       result = humongous_obj_allocate(word_size);
 898       if (result != NULL) {
 899         size_t size_in_regions = humongous_obj_size_in_regions(word_size);
 900         policy()-&gt;add_bytes_allocated_in_old_since_last_gc(size_in_regions * HeapRegion::GrainBytes);
 901         return result;
 902       }
 903 
 904       // Only try a GC if the GCLocker does not signal the need for a GC. Wait until
 905       // the GCLocker initiated GC has been performed and then retry. This includes
 906       // the case when the GC Locker is not active but has not been performed.
 907       should_try_gc = !GCLocker::needs_gc();
 908       // Read the GC count while still holding the Heap_lock.
 909       gc_count_before = total_collections();
 910     }
 911 
 912     if (should_try_gc) {
 913       bool succeeded;
 914       result = do_collection_pause(word_size, gc_count_before, &amp;succeeded,
 915                                    GCCause::_g1_humongous_allocation);
 916       if (result != NULL) {
 917         assert(succeeded, &quot;only way to get back a non-NULL result&quot;);
 918         log_trace(gc, alloc)(&quot;%s: Successfully scheduled collection returning &quot; PTR_FORMAT,
 919                              Thread::current()-&gt;name(), p2i(result));
 920         return result;
 921       }
 922 
 923       if (succeeded) {
 924         // We successfully scheduled a collection which failed to allocate. No
 925         // point in trying to allocate further. We&#39;ll just return NULL.
 926         log_trace(gc, alloc)(&quot;%s: Successfully scheduled collection failing to allocate &quot;
 927                              SIZE_FORMAT &quot; words&quot;, Thread::current()-&gt;name(), word_size);
 928         return NULL;
 929       }
 930       log_trace(gc, alloc)(&quot;%s: Unsuccessfully scheduled collection allocating &quot; SIZE_FORMAT &quot;&quot;,
 931                            Thread::current()-&gt;name(), word_size);
 932     } else {
 933       // Failed to schedule a collection.
 934       if (gclocker_retry_count &gt; GCLockerRetryAllocationCount) {
 935         log_warning(gc, alloc)(&quot;%s: Retried waiting for GCLocker too often allocating &quot;
 936                                SIZE_FORMAT &quot; words&quot;, Thread::current()-&gt;name(), word_size);
 937         return NULL;
 938       }
 939       log_trace(gc, alloc)(&quot;%s: Stall until clear&quot;, Thread::current()-&gt;name());
 940       // The GCLocker is either active or the GCLocker initiated
 941       // GC has not yet been performed. Stall until it is and
 942       // then retry the allocation.
 943       GCLocker::stall_until_clear();
 944       gclocker_retry_count += 1;
 945     }
 946 
 947 
 948     // We can reach here if we were unsuccessful in scheduling a
 949     // collection (because another thread beat us to it) or if we were
 950     // stalled due to the GC locker. In either can we should retry the
 951     // allocation attempt in case another thread successfully
 952     // performed a collection and reclaimed enough space.
 953     // Humongous object allocation always needs a lock, so we wait for the retry
 954     // in the next iteration of the loop, unlike for the regular iteration case.
 955     // Give a warning if we seem to be looping forever.
 956 
 957     if ((QueuedAllocationWarningCount &gt; 0) &amp;&amp;
 958         (try_count % QueuedAllocationWarningCount == 0)) {
 959       log_warning(gc, alloc)(&quot;%s: Retried allocation %u times for &quot; SIZE_FORMAT &quot; words&quot;,
 960                              Thread::current()-&gt;name(), try_count, word_size);
 961     }
 962   }
 963 
 964   ShouldNotReachHere();
 965   return NULL;
 966 }
 967 
 968 HeapWord* G1CollectedHeap::attempt_allocation_at_safepoint(size_t word_size,
 969                                                            bool expect_null_mutator_alloc_region) {
 970   assert_at_safepoint_on_vm_thread();
 971   assert(!_allocator-&gt;has_mutator_alloc_region() || !expect_null_mutator_alloc_region,
 972          &quot;the current alloc region was unexpectedly found to be non-NULL&quot;);
 973 
 974   if (!is_humongous(word_size)) {
 975     return _allocator-&gt;attempt_allocation_locked(word_size);
 976   } else {
 977     HeapWord* result = humongous_obj_allocate(word_size);
 978     if (result != NULL &amp;&amp; policy()-&gt;need_to_start_conc_mark(&quot;STW humongous allocation&quot;)) {
 979       collector_state()-&gt;set_initiate_conc_mark_if_possible(true);
 980     }
 981     return result;
 982   }
 983 
 984   ShouldNotReachHere();
 985 }
 986 
 987 class PostCompactionPrinterClosure: public HeapRegionClosure {
 988 private:
 989   G1HRPrinter* _hr_printer;
 990 public:
 991   bool do_heap_region(HeapRegion* hr) {
 992     assert(!hr-&gt;is_young(), &quot;not expecting to find young regions&quot;);
 993     _hr_printer-&gt;post_compaction(hr);
 994     return false;
 995   }
 996 
 997   PostCompactionPrinterClosure(G1HRPrinter* hr_printer)
 998     : _hr_printer(hr_printer) { }
 999 };
1000 
1001 void G1CollectedHeap::print_hrm_post_compaction() {
1002   if (_hr_printer.is_active()) {
1003     PostCompactionPrinterClosure cl(hr_printer());
1004     heap_region_iterate(&amp;cl);
1005   }
1006 }
1007 
1008 void G1CollectedHeap::abort_concurrent_cycle() {
1009   // If we start the compaction before the CM threads finish
1010   // scanning the root regions we might trip them over as we&#39;ll
1011   // be moving objects / updating references. So let&#39;s wait until
1012   // they are done. By telling them to abort, they should complete
1013   // early.
1014   _cm-&gt;root_regions()-&gt;abort();
1015   _cm-&gt;root_regions()-&gt;wait_until_scan_finished();
1016 
1017   // Disable discovery and empty the discovered lists
1018   // for the CM ref processor.
1019   _ref_processor_cm-&gt;disable_discovery();
1020   _ref_processor_cm-&gt;abandon_partial_discovery();
1021   _ref_processor_cm-&gt;verify_no_references_recorded();
1022 
1023   // Abandon current iterations of concurrent marking and concurrent
1024   // refinement, if any are in progress.
1025   concurrent_mark()-&gt;concurrent_cycle_abort();
1026 }
1027 
1028 void G1CollectedHeap::prepare_heap_for_full_collection() {
1029   // Make sure we&#39;ll choose a new allocation region afterwards.
1030   _allocator-&gt;release_mutator_alloc_regions();
1031   _allocator-&gt;abandon_gc_alloc_regions();
1032 
1033   // We may have added regions to the current incremental collection
1034   // set between the last GC or pause and now. We need to clear the
1035   // incremental collection set and then start rebuilding it afresh
1036   // after this full GC.
1037   abandon_collection_set(collection_set());
1038 
1039   tear_down_region_sets(false /* free_list_only */);
1040 
1041   hrm()-&gt;prepare_for_full_collection_start();
1042 }
1043 
1044 void G1CollectedHeap::verify_before_full_collection(bool explicit_gc) {
1045   assert(!GCCause::is_user_requested_gc(gc_cause()) || explicit_gc, &quot;invariant&quot;);
1046   assert_used_and_recalculate_used_equal(this);
1047   _verifier-&gt;verify_region_sets_optional();
1048   _verifier-&gt;verify_before_gc(G1HeapVerifier::G1VerifyFull);
1049   _verifier-&gt;check_bitmaps(&quot;Full GC Start&quot;);
1050 }
1051 
1052 void G1CollectedHeap::prepare_heap_for_mutators() {
1053   hrm()-&gt;prepare_for_full_collection_end();
1054 
1055   // Delete metaspaces for unloaded class loaders and clean up loader_data graph
1056   ClassLoaderDataGraph::purge();
1057   MetaspaceUtils::verify_metrics();
1058 
1059   // Prepare heap for normal collections.
1060   assert(num_free_regions() == 0, &quot;we should not have added any free regions&quot;);
1061   rebuild_region_sets(false /* free_list_only */);
1062   abort_refinement();
1063   resize_heap_if_necessary();
1064 
1065   // Rebuild the strong code root lists for each region
1066   rebuild_strong_code_roots();
1067 
1068   // Purge code root memory
1069   purge_code_root_memory();
1070 
1071   // Start a new incremental collection set for the next pause
1072   start_new_collection_set();
1073 
1074   _allocator-&gt;init_mutator_alloc_regions();
1075 
1076   // Post collection state updates.
1077   MetaspaceGC::compute_new_size();
1078 }
1079 
1080 void G1CollectedHeap::abort_refinement() {
1081   if (_hot_card_cache-&gt;use_cache()) {
1082     _hot_card_cache-&gt;reset_hot_cache();
1083   }
1084 
1085   // Discard all remembered set updates.
1086   G1BarrierSet::dirty_card_queue_set().abandon_logs();
1087   assert(G1BarrierSet::dirty_card_queue_set().num_cards() == 0,
1088          &quot;DCQS should be empty&quot;);
1089 }
1090 
1091 void G1CollectedHeap::verify_after_full_collection() {
1092   _hrm-&gt;verify_optional();
1093   _verifier-&gt;verify_region_sets_optional();
1094   _verifier-&gt;verify_after_gc(G1HeapVerifier::G1VerifyFull);
1095   // Clear the previous marking bitmap, if needed for bitmap verification.
1096   // Note we cannot do this when we clear the next marking bitmap in
1097   // G1ConcurrentMark::abort() above since VerifyDuringGC verifies the
1098   // objects marked during a full GC against the previous bitmap.
1099   // But we need to clear it before calling check_bitmaps below since
1100   // the full GC has compacted objects and updated TAMS but not updated
1101   // the prev bitmap.
1102   if (G1VerifyBitmaps) {
1103     GCTraceTime(Debug, gc) tm(&quot;Clear Prev Bitmap for Verification&quot;);
1104     _cm-&gt;clear_prev_bitmap(workers());
1105   }
1106   // This call implicitly verifies that the next bitmap is clear after Full GC.
1107   _verifier-&gt;check_bitmaps(&quot;Full GC End&quot;);
1108 
1109   // At this point there should be no regions in the
1110   // entire heap tagged as young.
1111   assert(check_young_list_empty(), &quot;young list should be empty at this point&quot;);
1112 
1113   // Note: since we&#39;ve just done a full GC, concurrent
1114   // marking is no longer active. Therefore we need not
1115   // re-enable reference discovery for the CM ref processor.
1116   // That will be done at the start of the next marking cycle.
1117   // We also know that the STW processor should no longer
1118   // discover any new references.
1119   assert(!_ref_processor_stw-&gt;discovery_enabled(), &quot;Postcondition&quot;);
1120   assert(!_ref_processor_cm-&gt;discovery_enabled(), &quot;Postcondition&quot;);
1121   _ref_processor_stw-&gt;verify_no_references_recorded();
1122   _ref_processor_cm-&gt;verify_no_references_recorded();
1123 }
1124 
1125 void G1CollectedHeap::print_heap_after_full_collection(G1HeapTransition* heap_transition) {
1126   // Post collection logging.
1127   // We should do this after we potentially resize the heap so
1128   // that all the COMMIT / UNCOMMIT events are generated before
1129   // the compaction events.
1130   print_hrm_post_compaction();
1131   heap_transition-&gt;print();
1132   print_heap_after_gc();
1133   print_heap_regions();
<a name="2" id="anc2"></a><span class="line-removed">1134 #ifdef TRACESPINNING</span>
<span class="line-removed">1135   ParallelTaskTerminator::print_termination_counts();</span>
<span class="line-removed">1136 #endif</span>
1137 }
1138 
1139 bool G1CollectedHeap::do_full_collection(bool explicit_gc,
1140                                          bool clear_all_soft_refs) {
1141   assert_at_safepoint_on_vm_thread();
1142 
1143   if (GCLocker::check_active_before_gc()) {
1144     // Full GC was not completed.
1145     return false;
1146   }
1147 
1148   const bool do_clear_all_soft_refs = clear_all_soft_refs ||
1149       soft_ref_policy()-&gt;should_clear_all_soft_refs();
1150 
1151   G1FullCollector collector(this, explicit_gc, do_clear_all_soft_refs);
1152   GCTraceTime(Info, gc) tm(&quot;Pause Full&quot;, NULL, gc_cause(), true);
1153 
1154   collector.prepare_collection();
1155   collector.collect();
1156   collector.complete_collection();
1157 
1158   // Full collection was successfully completed.
1159   return true;
1160 }
1161 
1162 void G1CollectedHeap::do_full_collection(bool clear_all_soft_refs) {
1163   // Currently, there is no facility in the do_full_collection(bool) API to notify
1164   // the caller that the collection did not succeed (e.g., because it was locked
1165   // out by the GC locker). So, right now, we&#39;ll ignore the return value.
1166   bool dummy = do_full_collection(true,                /* explicit_gc */
1167                                   clear_all_soft_refs);
1168 }
1169 
1170 void G1CollectedHeap::resize_heap_if_necessary() {
1171   assert_at_safepoint_on_vm_thread();
1172 
1173   // Capacity, free and used after the GC counted as full regions to
1174   // include the waste in the following calculations.
1175   const size_t capacity_after_gc = capacity();
1176   const size_t used_after_gc = capacity_after_gc - unused_committed_regions_in_bytes();
1177 
1178   // This is enforced in arguments.cpp.
1179   assert(MinHeapFreeRatio &lt;= MaxHeapFreeRatio,
1180          &quot;otherwise the code below doesn&#39;t make sense&quot;);
1181 
1182   // We don&#39;t have floating point command-line arguments
1183   const double minimum_free_percentage = (double) MinHeapFreeRatio / 100.0;
1184   const double maximum_used_percentage = 1.0 - minimum_free_percentage;
1185   const double maximum_free_percentage = (double) MaxHeapFreeRatio / 100.0;
1186   const double minimum_used_percentage = 1.0 - maximum_free_percentage;
1187 
1188   // We have to be careful here as these two calculations can overflow
1189   // 32-bit size_t&#39;s.
1190   double used_after_gc_d = (double) used_after_gc;
1191   double minimum_desired_capacity_d = used_after_gc_d / maximum_used_percentage;
1192   double maximum_desired_capacity_d = used_after_gc_d / minimum_used_percentage;
1193 
1194   // Let&#39;s make sure that they are both under the max heap size, which
1195   // by default will make them fit into a size_t.
1196   double desired_capacity_upper_bound = (double) MaxHeapSize;
1197   minimum_desired_capacity_d = MIN2(minimum_desired_capacity_d,
1198                                     desired_capacity_upper_bound);
1199   maximum_desired_capacity_d = MIN2(maximum_desired_capacity_d,
1200                                     desired_capacity_upper_bound);
1201 
1202   // We can now safely turn them into size_t&#39;s.
1203   size_t minimum_desired_capacity = (size_t) minimum_desired_capacity_d;
1204   size_t maximum_desired_capacity = (size_t) maximum_desired_capacity_d;
1205 
1206   // This assert only makes sense here, before we adjust them
1207   // with respect to the min and max heap size.
1208   assert(minimum_desired_capacity &lt;= maximum_desired_capacity,
1209          &quot;minimum_desired_capacity = &quot; SIZE_FORMAT &quot;, &quot;
1210          &quot;maximum_desired_capacity = &quot; SIZE_FORMAT,
1211          minimum_desired_capacity, maximum_desired_capacity);
1212 
1213   // Should not be greater than the heap max size. No need to adjust
1214   // it with respect to the heap min size as it&#39;s a lower bound (i.e.,
1215   // we&#39;ll try to make the capacity larger than it, not smaller).
1216   minimum_desired_capacity = MIN2(minimum_desired_capacity, MaxHeapSize);
1217   // Should not be less than the heap min size. No need to adjust it
1218   // with respect to the heap max size as it&#39;s an upper bound (i.e.,
1219   // we&#39;ll try to make the capacity smaller than it, not greater).
1220   maximum_desired_capacity =  MAX2(maximum_desired_capacity, MinHeapSize);
1221 
1222   if (capacity_after_gc &lt; minimum_desired_capacity) {
1223     // Don&#39;t expand unless it&#39;s significant
1224     size_t expand_bytes = minimum_desired_capacity - capacity_after_gc;
1225 
1226     log_debug(gc, ergo, heap)(&quot;Attempt heap expansion (capacity lower than min desired capacity). &quot;
1227                               &quot;Capacity: &quot; SIZE_FORMAT &quot;B occupancy: &quot; SIZE_FORMAT &quot;B live: &quot; SIZE_FORMAT &quot;B &quot;
1228                               &quot;min_desired_capacity: &quot; SIZE_FORMAT &quot;B (&quot; UINTX_FORMAT &quot; %%)&quot;,
1229                               capacity_after_gc, used_after_gc, used(), minimum_desired_capacity, MinHeapFreeRatio);
1230 
1231     expand(expand_bytes, _workers);
1232 
1233     // No expansion, now see if we want to shrink
1234   } else if (capacity_after_gc &gt; maximum_desired_capacity) {
1235     // Capacity too large, compute shrinking size
1236     size_t shrink_bytes = capacity_after_gc - maximum_desired_capacity;
1237 
1238     log_debug(gc, ergo, heap)(&quot;Attempt heap shrinking (capacity higher than max desired capacity). &quot;
1239                               &quot;Capacity: &quot; SIZE_FORMAT &quot;B occupancy: &quot; SIZE_FORMAT &quot;B live: &quot; SIZE_FORMAT &quot;B &quot;
1240                               &quot;maximum_desired_capacity: &quot; SIZE_FORMAT &quot;B (&quot; UINTX_FORMAT &quot; %%)&quot;,
1241                               capacity_after_gc, used_after_gc, used(), maximum_desired_capacity, MaxHeapFreeRatio);
1242 
1243     shrink(shrink_bytes);
1244   }
1245 }
1246 
1247 HeapWord* G1CollectedHeap::satisfy_failed_allocation_helper(size_t word_size,
1248                                                             bool do_gc,
1249                                                             bool clear_all_soft_refs,
1250                                                             bool expect_null_mutator_alloc_region,
1251                                                             bool* gc_succeeded) {
1252   *gc_succeeded = true;
1253   // Let&#39;s attempt the allocation first.
1254   HeapWord* result =
1255     attempt_allocation_at_safepoint(word_size,
1256                                     expect_null_mutator_alloc_region);
1257   if (result != NULL) {
1258     return result;
1259   }
1260 
1261   // In a G1 heap, we&#39;re supposed to keep allocation from failing by
1262   // incremental pauses.  Therefore, at least for now, we&#39;ll favor
1263   // expansion over collection.  (This might change in the future if we can
1264   // do something smarter than full collection to satisfy a failed alloc.)
1265   result = expand_and_allocate(word_size);
1266   if (result != NULL) {
1267     return result;
1268   }
1269 
1270   if (do_gc) {
1271     // Expansion didn&#39;t work, we&#39;ll try to do a Full GC.
1272     *gc_succeeded = do_full_collection(false, /* explicit_gc */
1273                                        clear_all_soft_refs);
1274   }
1275 
1276   return NULL;
1277 }
1278 
1279 HeapWord* G1CollectedHeap::satisfy_failed_allocation(size_t word_size,
1280                                                      bool* succeeded) {
1281   assert_at_safepoint_on_vm_thread();
1282 
1283   // Attempts to allocate followed by Full GC.
1284   HeapWord* result =
1285     satisfy_failed_allocation_helper(word_size,
1286                                      true,  /* do_gc */
1287                                      false, /* clear_all_soft_refs */
1288                                      false, /* expect_null_mutator_alloc_region */
1289                                      succeeded);
1290 
1291   if (result != NULL || !*succeeded) {
1292     return result;
1293   }
1294 
1295   // Attempts to allocate followed by Full GC that will collect all soft references.
1296   result = satisfy_failed_allocation_helper(word_size,
1297                                             true, /* do_gc */
1298                                             true, /* clear_all_soft_refs */
1299                                             true, /* expect_null_mutator_alloc_region */
1300                                             succeeded);
1301 
1302   if (result != NULL || !*succeeded) {
1303     return result;
1304   }
1305 
1306   // Attempts to allocate, no GC
1307   result = satisfy_failed_allocation_helper(word_size,
1308                                             false, /* do_gc */
1309                                             false, /* clear_all_soft_refs */
1310                                             true,  /* expect_null_mutator_alloc_region */
1311                                             succeeded);
1312 
1313   if (result != NULL) {
1314     return result;
1315   }
1316 
1317   assert(!soft_ref_policy()-&gt;should_clear_all_soft_refs(),
1318          &quot;Flag should have been handled and cleared prior to this point&quot;);
1319 
1320   // What else?  We might try synchronous finalization later.  If the total
1321   // space available is large enough for the allocation, then a more
1322   // complete compaction phase than we&#39;ve tried so far might be
1323   // appropriate.
1324   return NULL;
1325 }
1326 
1327 // Attempting to expand the heap sufficiently
1328 // to support an allocation of the given &quot;word_size&quot;.  If
1329 // successful, perform the allocation and return the address of the
1330 // allocated block, or else &quot;NULL&quot;.
1331 
1332 HeapWord* G1CollectedHeap::expand_and_allocate(size_t word_size) {
1333   assert_at_safepoint_on_vm_thread();
1334 
1335   _verifier-&gt;verify_region_sets_optional();
1336 
1337   size_t expand_bytes = MAX2(word_size * HeapWordSize, MinHeapDeltaBytes);
1338   log_debug(gc, ergo, heap)(&quot;Attempt heap expansion (allocation request failed). Allocation request: &quot; SIZE_FORMAT &quot;B&quot;,
1339                             word_size * HeapWordSize);
1340 
1341 
1342   if (expand(expand_bytes, _workers)) {
1343     _hrm-&gt;verify_optional();
1344     _verifier-&gt;verify_region_sets_optional();
1345     return attempt_allocation_at_safepoint(word_size,
1346                                            false /* expect_null_mutator_alloc_region */);
1347   }
1348   return NULL;
1349 }
1350 
1351 bool G1CollectedHeap::expand(size_t expand_bytes, WorkGang* pretouch_workers, double* expand_time_ms) {
1352   size_t aligned_expand_bytes = ReservedSpace::page_align_size_up(expand_bytes);
1353   aligned_expand_bytes = align_up(aligned_expand_bytes,
1354                                        HeapRegion::GrainBytes);
1355 
1356   log_debug(gc, ergo, heap)(&quot;Expand the heap. requested expansion amount: &quot; SIZE_FORMAT &quot;B expansion amount: &quot; SIZE_FORMAT &quot;B&quot;,
1357                             expand_bytes, aligned_expand_bytes);
1358 
1359   if (is_maximal_no_gc()) {
1360     log_debug(gc, ergo, heap)(&quot;Did not expand the heap (heap already fully expanded)&quot;);
1361     return false;
1362   }
1363 
1364   double expand_heap_start_time_sec = os::elapsedTime();
1365   uint regions_to_expand = (uint)(aligned_expand_bytes / HeapRegion::GrainBytes);
1366   assert(regions_to_expand &gt; 0, &quot;Must expand by at least one region&quot;);
1367 
1368   uint expanded_by = _hrm-&gt;expand_by(regions_to_expand, pretouch_workers);
1369   if (expand_time_ms != NULL) {
1370     *expand_time_ms = (os::elapsedTime() - expand_heap_start_time_sec) * MILLIUNITS;
1371   }
1372 
1373   if (expanded_by &gt; 0) {
1374     size_t actual_expand_bytes = expanded_by * HeapRegion::GrainBytes;
1375     assert(actual_expand_bytes &lt;= aligned_expand_bytes, &quot;post-condition&quot;);
1376     policy()-&gt;record_new_heap_size(num_regions());
1377   } else {
1378     log_debug(gc, ergo, heap)(&quot;Did not expand the heap (heap expansion operation failed)&quot;);
1379 
1380     // The expansion of the virtual storage space was unsuccessful.
1381     // Let&#39;s see if it was because we ran out of swap.
1382     if (G1ExitOnExpansionFailure &amp;&amp;
1383         _hrm-&gt;available() &gt;= regions_to_expand) {
1384       // We had head room...
1385       vm_exit_out_of_memory(aligned_expand_bytes, OOM_MMAP_ERROR, &quot;G1 heap expansion&quot;);
1386     }
1387   }
1388   return regions_to_expand &gt; 0;
1389 }
1390 
1391 bool G1CollectedHeap::expand_single_region(uint node_index) {
1392   uint expanded_by = _hrm-&gt;expand_on_preferred_node(node_index);
1393 
1394   if (expanded_by == 0) {
1395     assert(is_maximal_no_gc(), &quot;Should be no regions left, available: %u&quot;, _hrm-&gt;available());
1396     log_debug(gc, ergo, heap)(&quot;Did not expand the heap (heap already fully expanded)&quot;);
1397     return false;
1398   }
1399 
1400   policy()-&gt;record_new_heap_size(num_regions());
1401   return true;
1402 }
1403 
1404 void G1CollectedHeap::shrink_helper(size_t shrink_bytes) {
1405   size_t aligned_shrink_bytes =
1406     ReservedSpace::page_align_size_down(shrink_bytes);
1407   aligned_shrink_bytes = align_down(aligned_shrink_bytes,
1408                                          HeapRegion::GrainBytes);
1409   uint num_regions_to_remove = (uint)(shrink_bytes / HeapRegion::GrainBytes);
1410 
1411   uint num_regions_removed = _hrm-&gt;shrink_by(num_regions_to_remove);
1412   size_t shrunk_bytes = num_regions_removed * HeapRegion::GrainBytes;
1413 
1414   log_debug(gc, ergo, heap)(&quot;Shrink the heap. requested shrinking amount: &quot; SIZE_FORMAT &quot;B aligned shrinking amount: &quot; SIZE_FORMAT &quot;B attempted shrinking amount: &quot; SIZE_FORMAT &quot;B&quot;,
1415                             shrink_bytes, aligned_shrink_bytes, shrunk_bytes);
1416   if (num_regions_removed &gt; 0) {
1417     policy()-&gt;record_new_heap_size(num_regions());
1418   } else {
1419     log_debug(gc, ergo, heap)(&quot;Did not expand the heap (heap shrinking operation failed)&quot;);
1420   }
1421 }
1422 
1423 void G1CollectedHeap::shrink(size_t shrink_bytes) {
1424   _verifier-&gt;verify_region_sets_optional();
1425 
1426   // We should only reach here at the end of a Full GC or during Remark which
1427   // means we should not not be holding to any GC alloc regions. The method
1428   // below will make sure of that and do any remaining clean up.
1429   _allocator-&gt;abandon_gc_alloc_regions();
1430 
1431   // Instead of tearing down / rebuilding the free lists here, we
1432   // could instead use the remove_all_pending() method on free_list to
1433   // remove only the ones that we need to remove.
1434   tear_down_region_sets(true /* free_list_only */);
1435   shrink_helper(shrink_bytes);
1436   rebuild_region_sets(true /* free_list_only */);
1437 
1438   _hrm-&gt;verify_optional();
1439   _verifier-&gt;verify_region_sets_optional();
1440 }
1441 
1442 class OldRegionSetChecker : public HeapRegionSetChecker {
1443 public:
1444   void check_mt_safety() {
1445     // Master Old Set MT safety protocol:
1446     // (a) If we&#39;re at a safepoint, operations on the master old set
1447     // should be invoked:
1448     // - by the VM thread (which will serialize them), or
1449     // - by the GC workers while holding the FreeList_lock, if we&#39;re
1450     //   at a safepoint for an evacuation pause (this lock is taken
1451     //   anyway when an GC alloc region is retired so that a new one
1452     //   is allocated from the free list), or
1453     // - by the GC workers while holding the OldSets_lock, if we&#39;re at a
1454     //   safepoint for a cleanup pause.
1455     // (b) If we&#39;re not at a safepoint, operations on the master old set
1456     // should be invoked while holding the Heap_lock.
1457 
1458     if (SafepointSynchronize::is_at_safepoint()) {
1459       guarantee(Thread::current()-&gt;is_VM_thread() ||
1460                 FreeList_lock-&gt;owned_by_self() || OldSets_lock-&gt;owned_by_self(),
1461                 &quot;master old set MT safety protocol at a safepoint&quot;);
1462     } else {
1463       guarantee(Heap_lock-&gt;owned_by_self(), &quot;master old set MT safety protocol outside a safepoint&quot;);
1464     }
1465   }
1466   bool is_correct_type(HeapRegion* hr) { return hr-&gt;is_old(); }
1467   const char* get_description() { return &quot;Old Regions&quot;; }
1468 };
1469 
1470 class ArchiveRegionSetChecker : public HeapRegionSetChecker {
1471 public:
1472   void check_mt_safety() {
1473     guarantee(!Universe::is_fully_initialized() || SafepointSynchronize::is_at_safepoint(),
1474               &quot;May only change archive regions during initialization or safepoint.&quot;);
1475   }
1476   bool is_correct_type(HeapRegion* hr) { return hr-&gt;is_archive(); }
1477   const char* get_description() { return &quot;Archive Regions&quot;; }
1478 };
1479 
1480 class HumongousRegionSetChecker : public HeapRegionSetChecker {
1481 public:
1482   void check_mt_safety() {
1483     // Humongous Set MT safety protocol:
1484     // (a) If we&#39;re at a safepoint, operations on the master humongous
1485     // set should be invoked by either the VM thread (which will
1486     // serialize them) or by the GC workers while holding the
1487     // OldSets_lock.
1488     // (b) If we&#39;re not at a safepoint, operations on the master
1489     // humongous set should be invoked while holding the Heap_lock.
1490 
1491     if (SafepointSynchronize::is_at_safepoint()) {
1492       guarantee(Thread::current()-&gt;is_VM_thread() ||
1493                 OldSets_lock-&gt;owned_by_self(),
1494                 &quot;master humongous set MT safety protocol at a safepoint&quot;);
1495     } else {
1496       guarantee(Heap_lock-&gt;owned_by_self(),
1497                 &quot;master humongous set MT safety protocol outside a safepoint&quot;);
1498     }
1499   }
1500   bool is_correct_type(HeapRegion* hr) { return hr-&gt;is_humongous(); }
1501   const char* get_description() { return &quot;Humongous Regions&quot;; }
1502 };
1503 
1504 G1CollectedHeap::G1CollectedHeap() :
1505   CollectedHeap(),
1506   _young_gen_sampling_thread(NULL),
1507   _workers(NULL),
1508   _card_table(NULL),
1509   _soft_ref_policy(),
1510   _old_set(&quot;Old Region Set&quot;, new OldRegionSetChecker()),
1511   _archive_set(&quot;Archive Region Set&quot;, new ArchiveRegionSetChecker()),
1512   _humongous_set(&quot;Humongous Region Set&quot;, new HumongousRegionSetChecker()),
1513   _bot(NULL),
1514   _listener(),
1515   _numa(G1NUMA::create()),
1516   _hrm(NULL),
1517   _allocator(NULL),
1518   _verifier(NULL),
1519   _summary_bytes_used(0),
1520   _bytes_used_during_gc(0),
1521   _archive_allocator(NULL),
1522   _survivor_evac_stats(&quot;Young&quot;, YoungPLABSize, PLABWeight),
1523   _old_evac_stats(&quot;Old&quot;, OldPLABSize, PLABWeight),
1524   _expand_heap_after_alloc_failure(true),
1525   _g1mm(NULL),
1526   _humongous_reclaim_candidates(),
1527   _has_humongous_reclaim_candidates(false),
1528   _hr_printer(),
1529   _collector_state(),
1530   _old_marking_cycles_started(0),
1531   _old_marking_cycles_completed(0),
1532   _eden(),
1533   _survivor(),
1534   _gc_timer_stw(new (ResourceObj::C_HEAP, mtGC) STWGCTimer()),
1535   _gc_tracer_stw(new (ResourceObj::C_HEAP, mtGC) G1NewTracer()),
1536   _policy(G1Policy::create_policy(_gc_timer_stw)),
1537   _heap_sizing_policy(NULL),
1538   _collection_set(this, _policy),
1539   _hot_card_cache(NULL),
1540   _rem_set(NULL),
1541   _cm(NULL),
1542   _cm_thread(NULL),
1543   _cr(NULL),
1544   _task_queues(NULL),
1545   _evacuation_failed(false),
1546   _evacuation_failed_info_array(NULL),
1547   _preserved_marks_set(true /* in_c_heap */),
1548 #ifndef PRODUCT
1549   _evacuation_failure_alot_for_current_gc(false),
1550   _evacuation_failure_alot_gc_number(0),
1551   _evacuation_failure_alot_count(0),
1552 #endif
1553   _ref_processor_stw(NULL),
1554   _is_alive_closure_stw(this),
1555   _is_subject_to_discovery_stw(this),
1556   _ref_processor_cm(NULL),
1557   _is_alive_closure_cm(this),
1558   _is_subject_to_discovery_cm(this),
1559   _region_attr() {
1560 
1561   _verifier = new G1HeapVerifier(this);
1562 
1563   _allocator = new G1Allocator(this);
1564 
1565   _heap_sizing_policy = G1HeapSizingPolicy::create(this, _policy-&gt;analytics());
1566 
1567   _humongous_object_threshold_in_words = humongous_threshold_for(HeapRegion::GrainWords);
1568 
1569   // Override the default _filler_array_max_size so that no humongous filler
1570   // objects are created.
1571   _filler_array_max_size = _humongous_object_threshold_in_words;
1572 
1573   uint n_queues = ParallelGCThreads;
1574   _task_queues = new RefToScanQueueSet(n_queues);
1575 
1576   _evacuation_failed_info_array = NEW_C_HEAP_ARRAY(EvacuationFailedInfo, n_queues, mtGC);
1577 
1578   for (uint i = 0; i &lt; n_queues; i++) {
1579     RefToScanQueue* q = new RefToScanQueue();
1580     q-&gt;initialize();
1581     _task_queues-&gt;register_queue(i, q);
1582     ::new (&amp;_evacuation_failed_info_array[i]) EvacuationFailedInfo();
1583   }
1584 
1585   // Initialize the G1EvacuationFailureALot counters and flags.
1586   NOT_PRODUCT(reset_evacuation_should_fail();)
1587   _gc_tracer_stw-&gt;initialize();
1588 
1589   guarantee(_task_queues != NULL, &quot;task_queues allocation failure.&quot;);
1590 }
1591 
1592 static size_t actual_reserved_page_size(ReservedSpace rs) {
1593   size_t page_size = os::vm_page_size();
1594   if (UseLargePages) {
1595     // There are two ways to manage large page memory.
1596     // 1. OS supports committing large page memory.
1597     // 2. OS doesn&#39;t support committing large page memory so ReservedSpace manages it.
1598     //    And ReservedSpace calls it &#39;special&#39;. If we failed to set &#39;special&#39;,
1599     //    we reserved memory without large page.
1600     if (os::can_commit_large_page_memory() || rs.special()) {
1601       // An alignment at ReservedSpace comes from preferred page size or
1602       // heap alignment, and if the alignment came from heap alignment, it could be
1603       // larger than large pages size. So need to cap with the large page size.
1604       page_size = MIN2(rs.alignment(), os::large_page_size());
1605     }
1606   }
1607 
1608   return page_size;
1609 }
1610 
1611 G1RegionToSpaceMapper* G1CollectedHeap::create_aux_memory_mapper(const char* description,
1612                                                                  size_t size,
1613                                                                  size_t translation_factor) {
1614   size_t preferred_page_size = os::page_size_for_region_unaligned(size, 1);
1615   // Allocate a new reserved space, preferring to use large pages.
1616   ReservedSpace rs(size, preferred_page_size);
1617   size_t page_size = actual_reserved_page_size(rs);
1618   G1RegionToSpaceMapper* result  =
1619     G1RegionToSpaceMapper::create_mapper(rs,
1620                                          size,
1621                                          page_size,
1622                                          HeapRegion::GrainBytes,
1623                                          translation_factor,
1624                                          mtGC);
1625 
1626   os::trace_page_sizes_for_requested_size(description,
1627                                           size,
1628                                           preferred_page_size,
1629                                           page_size,
1630                                           rs.base(),
1631                                           rs.size());
1632 
1633   return result;
1634 }
1635 
1636 jint G1CollectedHeap::initialize_concurrent_refinement() {
1637   jint ecode = JNI_OK;
1638   _cr = G1ConcurrentRefine::create(&amp;ecode);
1639   return ecode;
1640 }
1641 
1642 jint G1CollectedHeap::initialize_young_gen_sampling_thread() {
1643   _young_gen_sampling_thread = new G1YoungRemSetSamplingThread();
1644   if (_young_gen_sampling_thread-&gt;osthread() == NULL) {
1645     vm_shutdown_during_initialization(&quot;Could not create G1YoungRemSetSamplingThread&quot;);
1646     return JNI_ENOMEM;
1647   }
1648   return JNI_OK;
1649 }
1650 
1651 jint G1CollectedHeap::initialize() {
1652 
1653   // Necessary to satisfy locking discipline assertions.
1654 
1655   MutexLocker x(Heap_lock);
1656 
1657   // While there are no constraints in the GC code that HeapWordSize
1658   // be any particular value, there are multiple other areas in the
1659   // system which believe this to be true (e.g. oop-&gt;object_size in some
1660   // cases incorrectly returns the size in wordSize units rather than
1661   // HeapWordSize).
1662   guarantee(HeapWordSize == wordSize, &quot;HeapWordSize must equal wordSize&quot;);
1663 
1664   size_t init_byte_size = InitialHeapSize;
1665   size_t reserved_byte_size = G1Arguments::heap_reserved_size_bytes();
1666 
1667   // Ensure that the sizes are properly aligned.
1668   Universe::check_alignment(init_byte_size, HeapRegion::GrainBytes, &quot;g1 heap&quot;);
1669   Universe::check_alignment(reserved_byte_size, HeapRegion::GrainBytes, &quot;g1 heap&quot;);
1670   Universe::check_alignment(reserved_byte_size, HeapAlignment, &quot;g1 heap&quot;);
1671 
1672   // Reserve the maximum.
1673 
1674   // When compressed oops are enabled, the preferred heap base
1675   // is calculated by subtracting the requested size from the
1676   // 32Gb boundary and using the result as the base address for
1677   // heap reservation. If the requested size is not aligned to
1678   // HeapRegion::GrainBytes (i.e. the alignment that is passed
1679   // into the ReservedHeapSpace constructor) then the actual
1680   // base of the reserved heap may end up differing from the
1681   // address that was requested (i.e. the preferred heap base).
1682   // If this happens then we could end up using a non-optimal
1683   // compressed oops mode.
1684 
1685   ReservedHeapSpace heap_rs = Universe::reserve_heap(reserved_byte_size,
1686                                                      HeapAlignment);
1687 
1688   initialize_reserved_region(heap_rs);
1689 
1690   // Create the barrier set for the entire reserved region.
1691   G1CardTable* ct = new G1CardTable(heap_rs.region());
1692   ct-&gt;initialize();
1693   G1BarrierSet* bs = new G1BarrierSet(ct);
1694   bs-&gt;initialize();
1695   assert(bs-&gt;is_a(BarrierSet::G1BarrierSet), &quot;sanity&quot;);
1696   BarrierSet::set_barrier_set(bs);
1697   _card_table = ct;
1698 
1699   {
1700     G1SATBMarkQueueSet&amp; satbqs = bs-&gt;satb_mark_queue_set();
1701     satbqs.set_process_completed_buffers_threshold(G1SATBProcessCompletedThreshold);
1702     satbqs.set_buffer_enqueue_threshold_percentage(G1SATBBufferEnqueueingThresholdPercent);
1703   }
1704 
1705   // Create the hot card cache.
1706   _hot_card_cache = new G1HotCardCache(this);
1707 
1708   // Carve out the G1 part of the heap.
1709   ReservedSpace g1_rs = heap_rs.first_part(reserved_byte_size);
1710   size_t page_size = actual_reserved_page_size(heap_rs);
1711   G1RegionToSpaceMapper* heap_storage =
1712     G1RegionToSpaceMapper::create_heap_mapper(g1_rs,
1713                                               g1_rs.size(),
1714                                               page_size,
1715                                               HeapRegion::GrainBytes,
1716                                               1,
1717                                               mtJavaHeap);
1718   if(heap_storage == NULL) {
1719     vm_shutdown_during_initialization(&quot;Could not initialize G1 heap&quot;);
1720     return JNI_ERR;
1721   }
1722 
1723   os::trace_page_sizes(&quot;Heap&quot;,
1724                        MinHeapSize,
1725                        reserved_byte_size,
1726                        page_size,
1727                        heap_rs.base(),
1728                        heap_rs.size());
1729   heap_storage-&gt;set_mapping_changed_listener(&amp;_listener);
1730 
1731   // Create storage for the BOT, card table, card counts table (hot card cache) and the bitmaps.
1732   G1RegionToSpaceMapper* bot_storage =
1733     create_aux_memory_mapper(&quot;Block Offset Table&quot;,
1734                              G1BlockOffsetTable::compute_size(g1_rs.size() / HeapWordSize),
1735                              G1BlockOffsetTable::heap_map_factor());
1736 
1737   G1RegionToSpaceMapper* cardtable_storage =
1738     create_aux_memory_mapper(&quot;Card Table&quot;,
1739                              G1CardTable::compute_size(g1_rs.size() / HeapWordSize),
1740                              G1CardTable::heap_map_factor());
1741 
1742   G1RegionToSpaceMapper* card_counts_storage =
1743     create_aux_memory_mapper(&quot;Card Counts Table&quot;,
1744                              G1CardCounts::compute_size(g1_rs.size() / HeapWordSize),
1745                              G1CardCounts::heap_map_factor());
1746 
1747   size_t bitmap_size = G1CMBitMap::compute_size(g1_rs.size());
1748   G1RegionToSpaceMapper* prev_bitmap_storage =
1749     create_aux_memory_mapper(&quot;Prev Bitmap&quot;, bitmap_size, G1CMBitMap::heap_map_factor());
1750   G1RegionToSpaceMapper* next_bitmap_storage =
1751     create_aux_memory_mapper(&quot;Next Bitmap&quot;, bitmap_size, G1CMBitMap::heap_map_factor());
1752 
1753   _hrm = HeapRegionManager::create_manager(this);
1754 
1755   _hrm-&gt;initialize(heap_storage, prev_bitmap_storage, next_bitmap_storage, bot_storage, cardtable_storage, card_counts_storage);
1756   _card_table-&gt;initialize(cardtable_storage);
1757 
1758   // Do later initialization work for concurrent refinement.
1759   _hot_card_cache-&gt;initialize(card_counts_storage);
1760 
1761   // 6843694 - ensure that the maximum region index can fit
1762   // in the remembered set structures.
1763   const uint max_region_idx = (1U &lt;&lt; (sizeof(RegionIdx_t)*BitsPerByte-1)) - 1;
1764   guarantee((max_regions() - 1) &lt;= max_region_idx, &quot;too many regions&quot;);
1765 
1766   // The G1FromCardCache reserves card with value 0 as &quot;invalid&quot;, so the heap must not
1767   // start within the first card.
1768   guarantee(g1_rs.base() &gt;= (char*)G1CardTable::card_size, &quot;Java heap must not start within the first card.&quot;);
1769   // Also create a G1 rem set.
1770   _rem_set = new G1RemSet(this, _card_table, _hot_card_cache);
1771   _rem_set-&gt;initialize(max_reserved_capacity(), max_regions());
1772 
1773   size_t max_cards_per_region = ((size_t)1 &lt;&lt; (sizeof(CardIdx_t)*BitsPerByte-1)) - 1;
1774   guarantee(HeapRegion::CardsPerRegion &gt; 0, &quot;make sure it&#39;s initialized&quot;);
1775   guarantee(HeapRegion::CardsPerRegion &lt; max_cards_per_region,
1776             &quot;too many cards per region&quot;);
1777 
1778   FreeRegionList::set_unrealistically_long_length(max_expandable_regions() + 1);
1779 
1780   _bot = new G1BlockOffsetTable(reserved_region(), bot_storage);
1781 
1782   {
1783     HeapWord* start = _hrm-&gt;reserved().start();
1784     HeapWord* end = _hrm-&gt;reserved().end();
1785     size_t granularity = HeapRegion::GrainBytes;
1786 
1787     _region_attr.initialize(start, end, granularity);
1788     _humongous_reclaim_candidates.initialize(start, end, granularity);
1789   }
1790 
1791   _workers = new WorkGang(&quot;GC Thread&quot;, ParallelGCThreads,
1792                           true /* are_GC_task_threads */,
1793                           false /* are_ConcurrentGC_threads */);
1794   if (_workers == NULL) {
1795     return JNI_ENOMEM;
1796   }
1797   _workers-&gt;initialize_workers();
1798 
1799   _numa-&gt;set_region_info(HeapRegion::GrainBytes, page_size);
1800 
1801   // Create the G1ConcurrentMark data structure and thread.
1802   // (Must do this late, so that &quot;max_regions&quot; is defined.)
1803   _cm = new G1ConcurrentMark(this, prev_bitmap_storage, next_bitmap_storage);
1804   if (_cm == NULL || !_cm-&gt;completed_initialization()) {
1805     vm_shutdown_during_initialization(&quot;Could not create/initialize G1ConcurrentMark&quot;);
1806     return JNI_ENOMEM;
1807   }
1808   _cm_thread = _cm-&gt;cm_thread();
1809 
1810   // Now expand into the initial heap size.
1811   if (!expand(init_byte_size, _workers)) {
1812     vm_shutdown_during_initialization(&quot;Failed to allocate initial heap.&quot;);
1813     return JNI_ENOMEM;
1814   }
1815 
1816   // Perform any initialization actions delegated to the policy.
1817   policy()-&gt;init(this, &amp;_collection_set);
1818 
1819   jint ecode = initialize_concurrent_refinement();
1820   if (ecode != JNI_OK) {
1821     return ecode;
1822   }
1823 
1824   ecode = initialize_young_gen_sampling_thread();
1825   if (ecode != JNI_OK) {
1826     return ecode;
1827   }
1828 
1829   {
1830     G1DirtyCardQueueSet&amp; dcqs = G1BarrierSet::dirty_card_queue_set();
1831     dcqs.set_process_cards_threshold(concurrent_refine()-&gt;yellow_zone());
1832     dcqs.set_max_cards(concurrent_refine()-&gt;red_zone());
1833   }
1834 
1835   // Here we allocate the dummy HeapRegion that is required by the
1836   // G1AllocRegion class.
1837   HeapRegion* dummy_region = _hrm-&gt;get_dummy_region();
1838 
1839   // We&#39;ll re-use the same region whether the alloc region will
1840   // require BOT updates or not and, if it doesn&#39;t, then a non-young
1841   // region will complain that it cannot support allocations without
1842   // BOT updates. So we&#39;ll tag the dummy region as eden to avoid that.
1843   dummy_region-&gt;set_eden();
1844   // Make sure it&#39;s full.
1845   dummy_region-&gt;set_top(dummy_region-&gt;end());
1846   G1AllocRegion::setup(this, dummy_region);
1847 
1848   _allocator-&gt;init_mutator_alloc_regions();
1849 
1850   // Do create of the monitoring and management support so that
1851   // values in the heap have been properly initialized.
1852   _g1mm = new G1MonitoringSupport(this);
1853 
1854   G1StringDedup::initialize();
1855 
1856   _preserved_marks_set.init(ParallelGCThreads);
1857 
1858   _collection_set.initialize(max_regions());
1859 
1860   return JNI_OK;
1861 }
1862 
1863 void G1CollectedHeap::stop() {
1864   // Stop all concurrent threads. We do this to make sure these threads
1865   // do not continue to execute and access resources (e.g. logging)
1866   // that are destroyed during shutdown.
1867   _cr-&gt;stop();
1868   _young_gen_sampling_thread-&gt;stop();
1869   _cm_thread-&gt;stop();
1870   if (G1StringDedup::is_enabled()) {
1871     G1StringDedup::stop();
1872   }
1873 }
1874 
1875 void G1CollectedHeap::safepoint_synchronize_begin() {
1876   SuspendibleThreadSet::synchronize();
1877 }
1878 
1879 void G1CollectedHeap::safepoint_synchronize_end() {
1880   SuspendibleThreadSet::desynchronize();
1881 }
1882 
1883 void G1CollectedHeap::post_initialize() {
1884   CollectedHeap::post_initialize();
1885   ref_processing_init();
1886 }
1887 
1888 void G1CollectedHeap::ref_processing_init() {
1889   // Reference processing in G1 currently works as follows:
1890   //
1891   // * There are two reference processor instances. One is
1892   //   used to record and process discovered references
1893   //   during concurrent marking; the other is used to
1894   //   record and process references during STW pauses
1895   //   (both full and incremental).
1896   // * Both ref processors need to &#39;span&#39; the entire heap as
1897   //   the regions in the collection set may be dotted around.
1898   //
1899   // * For the concurrent marking ref processor:
1900   //   * Reference discovery is enabled at initial marking.
1901   //   * Reference discovery is disabled and the discovered
1902   //     references processed etc during remarking.
1903   //   * Reference discovery is MT (see below).
1904   //   * Reference discovery requires a barrier (see below).
1905   //   * Reference processing may or may not be MT
1906   //     (depending on the value of ParallelRefProcEnabled
1907   //     and ParallelGCThreads).
1908   //   * A full GC disables reference discovery by the CM
1909   //     ref processor and abandons any entries on it&#39;s
1910   //     discovered lists.
1911   //
1912   // * For the STW processor:
1913   //   * Non MT discovery is enabled at the start of a full GC.
1914   //   * Processing and enqueueing during a full GC is non-MT.
1915   //   * During a full GC, references are processed after marking.
1916   //
1917   //   * Discovery (may or may not be MT) is enabled at the start
1918   //     of an incremental evacuation pause.
1919   //   * References are processed near the end of a STW evacuation pause.
1920   //   * For both types of GC:
1921   //     * Discovery is atomic - i.e. not concurrent.
1922   //     * Reference discovery will not need a barrier.
1923 
1924   bool mt_processing = ParallelRefProcEnabled &amp;&amp; (ParallelGCThreads &gt; 1);
1925 
1926   // Concurrent Mark ref processor
1927   _ref_processor_cm =
1928     new ReferenceProcessor(&amp;_is_subject_to_discovery_cm,
1929                            mt_processing,                                  // mt processing
1930                            ParallelGCThreads,                              // degree of mt processing
1931                            (ParallelGCThreads &gt; 1) || (ConcGCThreads &gt; 1), // mt discovery
1932                            MAX2(ParallelGCThreads, ConcGCThreads),         // degree of mt discovery
1933                            false,                                          // Reference discovery is not atomic
1934                            &amp;_is_alive_closure_cm,                          // is alive closure
1935                            true);                                          // allow changes to number of processing threads
1936 
1937   // STW ref processor
1938   _ref_processor_stw =
1939     new ReferenceProcessor(&amp;_is_subject_to_discovery_stw,
1940                            mt_processing,                        // mt processing
1941                            ParallelGCThreads,                    // degree of mt processing
1942                            (ParallelGCThreads &gt; 1),              // mt discovery
1943                            ParallelGCThreads,                    // degree of mt discovery
1944                            true,                                 // Reference discovery is atomic
1945                            &amp;_is_alive_closure_stw,               // is alive closure
1946                            true);                                // allow changes to number of processing threads
1947 }
1948 
1949 SoftRefPolicy* G1CollectedHeap::soft_ref_policy() {
1950   return &amp;_soft_ref_policy;
1951 }
1952 
1953 size_t G1CollectedHeap::capacity() const {
1954   return _hrm-&gt;length() * HeapRegion::GrainBytes;
1955 }
1956 
1957 size_t G1CollectedHeap::unused_committed_regions_in_bytes() const {
1958   return _hrm-&gt;total_free_bytes();
1959 }
1960 
1961 void G1CollectedHeap::iterate_hcc_closure(G1CardTableEntryClosure* cl, uint worker_id) {
1962   _hot_card_cache-&gt;drain(cl, worker_id);
1963 }
1964 
1965 // Computes the sum of the storage used by the various regions.
1966 size_t G1CollectedHeap::used() const {
1967   size_t result = _summary_bytes_used + _allocator-&gt;used_in_alloc_regions();
1968   if (_archive_allocator != NULL) {
1969     result += _archive_allocator-&gt;used();
1970   }
1971   return result;
1972 }
1973 
1974 size_t G1CollectedHeap::used_unlocked() const {
1975   return _summary_bytes_used;
1976 }
1977 
1978 class SumUsedClosure: public HeapRegionClosure {
1979   size_t _used;
1980 public:
1981   SumUsedClosure() : _used(0) {}
1982   bool do_heap_region(HeapRegion* r) {
1983     _used += r-&gt;used();
1984     return false;
1985   }
1986   size_t result() { return _used; }
1987 };
1988 
1989 size_t G1CollectedHeap::recalculate_used() const {
1990   SumUsedClosure blk;
1991   heap_region_iterate(&amp;blk);
1992   return blk.result();
1993 }
1994 
1995 bool  G1CollectedHeap::is_user_requested_concurrent_full_gc(GCCause::Cause cause) {
1996   switch (cause) {
1997     case GCCause::_java_lang_system_gc:                 return ExplicitGCInvokesConcurrent;
1998     case GCCause::_dcmd_gc_run:                         return ExplicitGCInvokesConcurrent;
1999     case GCCause::_wb_conc_mark:                        return true;
2000     default :                                           return false;
2001   }
2002 }
2003 
2004 bool G1CollectedHeap::should_do_concurrent_full_gc(GCCause::Cause cause) {
2005   switch (cause) {
2006     case GCCause::_g1_humongous_allocation: return true;
2007     case GCCause::_g1_periodic_collection:  return G1PeriodicGCInvokesConcurrent;
2008     default:                                return is_user_requested_concurrent_full_gc(cause);
2009   }
2010 }
2011 
2012 bool G1CollectedHeap::should_upgrade_to_full_gc(GCCause::Cause cause) {
2013   if (policy()-&gt;force_upgrade_to_full()) {
2014     return true;
2015   } else if (should_do_concurrent_full_gc(_gc_cause)) {
2016     return false;
2017   } else if (has_regions_left_for_allocation()) {
2018     return false;
2019   } else {
2020     return true;
2021   }
2022 }
2023 
2024 #ifndef PRODUCT
2025 void G1CollectedHeap::allocate_dummy_regions() {
2026   // Let&#39;s fill up most of the region
2027   size_t word_size = HeapRegion::GrainWords - 1024;
2028   // And as a result the region we&#39;ll allocate will be humongous.
2029   guarantee(is_humongous(word_size), &quot;sanity&quot;);
2030 
2031   // _filler_array_max_size is set to humongous object threshold
2032   // but temporarily change it to use CollectedHeap::fill_with_object().
2033   SizeTFlagSetting fs(_filler_array_max_size, word_size);
2034 
2035   for (uintx i = 0; i &lt; G1DummyRegionsPerGC; ++i) {
2036     // Let&#39;s use the existing mechanism for the allocation
2037     HeapWord* dummy_obj = humongous_obj_allocate(word_size);
2038     if (dummy_obj != NULL) {
2039       MemRegion mr(dummy_obj, word_size);
2040       CollectedHeap::fill_with_object(mr);
2041     } else {
2042       // If we can&#39;t allocate once, we probably cannot allocate
2043       // again. Let&#39;s get out of the loop.
2044       break;
2045     }
2046   }
2047 }
2048 #endif // !PRODUCT
2049 
2050 void G1CollectedHeap::increment_old_marking_cycles_started() {
2051   assert(_old_marking_cycles_started == _old_marking_cycles_completed ||
2052          _old_marking_cycles_started == _old_marking_cycles_completed + 1,
2053          &quot;Wrong marking cycle count (started: %d, completed: %d)&quot;,
2054          _old_marking_cycles_started, _old_marking_cycles_completed);
2055 
2056   _old_marking_cycles_started++;
2057 }
2058 
2059 void G1CollectedHeap::increment_old_marking_cycles_completed(bool concurrent) {
2060   MonitorLocker ml(G1OldGCCount_lock, Mutex::_no_safepoint_check_flag);
2061 
2062   // We assume that if concurrent == true, then the caller is a
2063   // concurrent thread that was joined the Suspendible Thread
2064   // Set. If there&#39;s ever a cheap way to check this, we should add an
2065   // assert here.
2066 
2067   // Given that this method is called at the end of a Full GC or of a
2068   // concurrent cycle, and those can be nested (i.e., a Full GC can
2069   // interrupt a concurrent cycle), the number of full collections
2070   // completed should be either one (in the case where there was no
2071   // nesting) or two (when a Full GC interrupted a concurrent cycle)
2072   // behind the number of full collections started.
2073 
2074   // This is the case for the inner caller, i.e. a Full GC.
2075   assert(concurrent ||
2076          (_old_marking_cycles_started == _old_marking_cycles_completed + 1) ||
2077          (_old_marking_cycles_started == _old_marking_cycles_completed + 2),
2078          &quot;for inner caller (Full GC): _old_marking_cycles_started = %u &quot;
2079          &quot;is inconsistent with _old_marking_cycles_completed = %u&quot;,
2080          _old_marking_cycles_started, _old_marking_cycles_completed);
2081 
2082   // This is the case for the outer caller, i.e. the concurrent cycle.
2083   assert(!concurrent ||
2084          (_old_marking_cycles_started == _old_marking_cycles_completed + 1),
2085          &quot;for outer caller (concurrent cycle): &quot;
2086          &quot;_old_marking_cycles_started = %u &quot;
2087          &quot;is inconsistent with _old_marking_cycles_completed = %u&quot;,
2088          _old_marking_cycles_started, _old_marking_cycles_completed);
2089 
2090   _old_marking_cycles_completed += 1;
2091 
2092   // We need to clear the &quot;in_progress&quot; flag in the CM thread before
2093   // we wake up any waiters (especially when ExplicitInvokesConcurrent
2094   // is set) so that if a waiter requests another System.gc() it doesn&#39;t
2095   // incorrectly see that a marking cycle is still in progress.
2096   if (concurrent) {
2097     _cm_thread-&gt;set_idle();
2098   }
2099 
2100   // Notify threads waiting in System.gc() (with ExplicitGCInvokesConcurrent)
2101   // for a full GC to finish that their wait is over.
2102   ml.notify_all();
2103 }
2104 
2105 void G1CollectedHeap::collect(GCCause::Cause cause) {
2106   try_collect(cause);
2107 }
2108 
2109 // Return true if (x &lt; y) with allowance for wraparound.
2110 static bool gc_counter_less_than(uint x, uint y) {
2111   return (x - y) &gt; (UINT_MAX/2);
2112 }
2113 
2114 // LOG_COLLECT_CONCURRENTLY(cause, msg, args...)
2115 // Macro so msg printing is format-checked.
2116 #define LOG_COLLECT_CONCURRENTLY(cause, ...)                            \
2117   do {                                                                  \
2118     LogTarget(Trace, gc) LOG_COLLECT_CONCURRENTLY_lt;                   \
2119     if (LOG_COLLECT_CONCURRENTLY_lt.is_enabled()) {                     \
2120       ResourceMark rm; /* For thread name. */                           \
2121       LogStream LOG_COLLECT_CONCURRENTLY_s(&amp;LOG_COLLECT_CONCURRENTLY_lt); \
2122       LOG_COLLECT_CONCURRENTLY_s.print(&quot;%s: Try Collect Concurrently (%s): &quot;, \
2123                                        Thread::current()-&gt;name(),       \
2124                                        GCCause::to_string(cause));      \
2125       LOG_COLLECT_CONCURRENTLY_s.print(__VA_ARGS__);                    \
2126     }                                                                   \
2127   } while (0)
2128 
2129 #define LOG_COLLECT_CONCURRENTLY_COMPLETE(cause, result) \
2130   LOG_COLLECT_CONCURRENTLY(cause, &quot;complete %s&quot;, BOOL_TO_STR(result))
2131 
2132 bool G1CollectedHeap::try_collect_concurrently(GCCause::Cause cause,
2133                                                uint gc_counter,
2134                                                uint old_marking_started_before) {
2135   assert_heap_not_locked();
2136   assert(should_do_concurrent_full_gc(cause),
2137          &quot;Non-concurrent cause %s&quot;, GCCause::to_string(cause));
2138 
2139   for (uint i = 1; true; ++i) {
2140     // Try to schedule an initial-mark evacuation pause that will
2141     // start a concurrent cycle.
2142     LOG_COLLECT_CONCURRENTLY(cause, &quot;attempt %u&quot;, i);
2143     VM_G1TryInitiateConcMark op(gc_counter,
2144                                 cause,
2145                                 policy()-&gt;max_pause_time_ms());
2146     VMThread::execute(&amp;op);
2147 
2148     // Request is trivially finished.
2149     if (cause == GCCause::_g1_periodic_collection) {
2150       LOG_COLLECT_CONCURRENTLY_COMPLETE(cause, op.gc_succeeded());
2151       return op.gc_succeeded();
2152     }
2153 
2154     // If VMOp skipped initiating concurrent marking cycle because
2155     // we&#39;re terminating, then we&#39;re done.
2156     if (op.terminating()) {
2157       LOG_COLLECT_CONCURRENTLY(cause, &quot;skipped: terminating&quot;);
2158       return false;
2159     }
2160 
2161     // Lock to get consistent set of values.
2162     uint old_marking_started_after;
2163     uint old_marking_completed_after;
2164     {
2165       MutexLocker ml(Heap_lock);
2166       // Update gc_counter for retrying VMOp if needed. Captured here to be
2167       // consistent with the values we use below for termination tests.  If
2168       // a retry is needed after a possible wait, and another collection
2169       // occurs in the meantime, it will cause our retry to be skipped and
2170       // we&#39;ll recheck for termination with updated conditions from that
2171       // more recent collection.  That&#39;s what we want, rather than having
2172       // our retry possibly perform an unnecessary collection.
2173       gc_counter = total_collections();
2174       old_marking_started_after = _old_marking_cycles_started;
2175       old_marking_completed_after = _old_marking_cycles_completed;
2176     }
2177 
2178     if (!GCCause::is_user_requested_gc(cause)) {
2179       // For an &quot;automatic&quot; (not user-requested) collection, we just need to
2180       // ensure that progress is made.
2181       //
2182       // Request is finished if any of
2183       // (1) the VMOp successfully performed a GC,
2184       // (2) a concurrent cycle was already in progress,
2185       // (3) a new cycle was started (by this thread or some other), or
2186       // (4) a Full GC was performed.
2187       // Cases (3) and (4) are detected together by a change to
2188       // _old_marking_cycles_started.
2189       //
2190       // Note that (1) does not imply (3).  If we&#39;re still in the mixed
2191       // phase of an earlier concurrent collection, the request to make the
2192       // collection an initial-mark won&#39;t be honored.  If we don&#39;t check for
2193       // both conditions we&#39;ll spin doing back-to-back collections.
2194       if (op.gc_succeeded() ||
2195           op.cycle_already_in_progress() ||
2196           (old_marking_started_before != old_marking_started_after)) {
2197         LOG_COLLECT_CONCURRENTLY_COMPLETE(cause, true);
2198         return true;
2199       }
2200     } else {                    // User-requested GC.
2201       // For a user-requested collection, we want to ensure that a complete
2202       // full collection has been performed before returning, but without
2203       // waiting for more than needed.
2204 
2205       // For user-requested GCs (unlike non-UR), a successful VMOp implies a
2206       // new cycle was started.  That&#39;s good, because it&#39;s not clear what we
2207       // should do otherwise.  Trying again just does back to back GCs.
2208       // Can&#39;t wait for someone else to start a cycle.  And returning fails
2209       // to meet the goal of ensuring a full collection was performed.
2210       assert(!op.gc_succeeded() ||
2211              (old_marking_started_before != old_marking_started_after),
2212              &quot;invariant: succeeded %s, started before %u, started after %u&quot;,
2213              BOOL_TO_STR(op.gc_succeeded()),
2214              old_marking_started_before, old_marking_started_after);
2215 
2216       // Request is finished if a full collection (concurrent or stw)
2217       // was started after this request and has completed, e.g.
2218       // started_before &lt; completed_after.
2219       if (gc_counter_less_than(old_marking_started_before,
2220                                old_marking_completed_after)) {
2221         LOG_COLLECT_CONCURRENTLY_COMPLETE(cause, true);
2222         return true;
2223       }
2224 
2225       if (old_marking_started_after != old_marking_completed_after) {
2226         // If there is an in-progress cycle (possibly started by us), then
2227         // wait for that cycle to complete, e.g.
2228         // while completed_now &lt; started_after.
2229         LOG_COLLECT_CONCURRENTLY(cause, &quot;wait&quot;);
2230         MonitorLocker ml(G1OldGCCount_lock);
2231         while (gc_counter_less_than(_old_marking_cycles_completed,
2232                                     old_marking_started_after)) {
2233           ml.wait();
2234         }
2235         // Request is finished if the collection we just waited for was
2236         // started after this request.
2237         if (old_marking_started_before != old_marking_started_after) {
2238           LOG_COLLECT_CONCURRENTLY(cause, &quot;complete after wait&quot;);
2239           return true;
2240         }
2241       }
2242 
2243       // If VMOp was successful then it started a new cycle that the above
2244       // wait &amp;etc should have recognized as finishing this request.  This
2245       // differs from a non-user-request, where gc_succeeded does not imply
2246       // a new cycle was started.
2247       assert(!op.gc_succeeded(), &quot;invariant&quot;);
2248 
2249       // If VMOp failed because a cycle was already in progress, it is now
2250       // complete.  But it didn&#39;t finish this user-requested GC, so try
2251       // again.
2252       if (op.cycle_already_in_progress()) {
2253         LOG_COLLECT_CONCURRENTLY(cause, &quot;retry after in-progress&quot;);
2254         continue;
2255       }
2256     }
2257 
2258     // Collection failed and should be retried.
2259     assert(op.transient_failure(), &quot;invariant&quot;);
2260 
2261     // If GCLocker is active, wait until clear before retrying.
2262     if (GCLocker::is_active_and_needs_gc()) {
2263       LOG_COLLECT_CONCURRENTLY(cause, &quot;gc-locker stall&quot;);
2264       GCLocker::stall_until_clear();
2265     }
2266 
2267     LOG_COLLECT_CONCURRENTLY(cause, &quot;retry&quot;);
2268   }
2269 }
2270 
2271 bool G1CollectedHeap::try_collect(GCCause::Cause cause) {
2272   assert_heap_not_locked();
2273 
2274   // Lock to get consistent set of values.
2275   uint gc_count_before;
2276   uint full_gc_count_before;
2277   uint old_marking_started_before;
2278   {
2279     MutexLocker ml(Heap_lock);
2280     gc_count_before = total_collections();
2281     full_gc_count_before = total_full_collections();
2282     old_marking_started_before = _old_marking_cycles_started;
2283   }
2284 
2285   if (should_do_concurrent_full_gc(cause)) {
2286     return try_collect_concurrently(cause,
2287                                     gc_count_before,
2288                                     old_marking_started_before);
2289   } else if (GCLocker::should_discard(cause, gc_count_before)) {
2290     // Indicate failure to be consistent with VMOp failure due to
2291     // another collection slipping in after our gc_count but before
2292     // our request is processed.
2293     return false;
2294   } else if (cause == GCCause::_gc_locker || cause == GCCause::_wb_young_gc
2295              DEBUG_ONLY(|| cause == GCCause::_scavenge_alot)) {
2296 
2297     // Schedule a standard evacuation pause. We&#39;re setting word_size
2298     // to 0 which means that we are not requesting a post-GC allocation.
2299     VM_G1CollectForAllocation op(0,     /* word_size */
2300                                  gc_count_before,
2301                                  cause,
2302                                  policy()-&gt;max_pause_time_ms());
2303     VMThread::execute(&amp;op);
2304     return op.gc_succeeded();
2305   } else {
2306     // Schedule a Full GC.
2307     VM_G1CollectFull op(gc_count_before, full_gc_count_before, cause);
2308     VMThread::execute(&amp;op);
2309     return op.gc_succeeded();
2310   }
2311 }
2312 
2313 bool G1CollectedHeap::is_in(const void* p) const {
2314   if (_hrm-&gt;reserved().contains(p)) {
2315     // Given that we know that p is in the reserved space,
2316     // heap_region_containing() should successfully
2317     // return the containing region.
2318     HeapRegion* hr = heap_region_containing(p);
2319     return hr-&gt;is_in(p);
2320   } else {
2321     return false;
2322   }
2323 }
2324 
2325 #ifdef ASSERT
2326 bool G1CollectedHeap::is_in_exact(const void* p) const {
2327   bool contains = reserved_region().contains(p);
2328   bool available = _hrm-&gt;is_available(addr_to_region((HeapWord*)p));
2329   if (contains &amp;&amp; available) {
2330     return true;
2331   } else {
2332     return false;
2333   }
2334 }
2335 #endif
2336 
2337 // Iteration functions.
2338 
2339 // Iterates an ObjectClosure over all objects within a HeapRegion.
2340 
2341 class IterateObjectClosureRegionClosure: public HeapRegionClosure {
2342   ObjectClosure* _cl;
2343 public:
2344   IterateObjectClosureRegionClosure(ObjectClosure* cl) : _cl(cl) {}
2345   bool do_heap_region(HeapRegion* r) {
2346     if (!r-&gt;is_continues_humongous()) {
2347       r-&gt;object_iterate(_cl);
2348     }
2349     return false;
2350   }
2351 };
2352 
2353 void G1CollectedHeap::object_iterate(ObjectClosure* cl) {
2354   IterateObjectClosureRegionClosure blk(cl);
2355   heap_region_iterate(&amp;blk);
2356 }
2357 
2358 void G1CollectedHeap::keep_alive(oop obj) {
2359   G1BarrierSet::enqueue(obj);
2360 }
2361 
2362 void G1CollectedHeap::heap_region_iterate(HeapRegionClosure* cl) const {
2363   _hrm-&gt;iterate(cl);
2364 }
2365 
2366 void G1CollectedHeap::heap_region_par_iterate_from_worker_offset(HeapRegionClosure* cl,
2367                                                                  HeapRegionClaimer *hrclaimer,
2368                                                                  uint worker_id) const {
2369   _hrm-&gt;par_iterate(cl, hrclaimer, hrclaimer-&gt;offset_for_worker(worker_id));
2370 }
2371 
2372 void G1CollectedHeap::heap_region_par_iterate_from_start(HeapRegionClosure* cl,
2373                                                          HeapRegionClaimer *hrclaimer) const {
2374   _hrm-&gt;par_iterate(cl, hrclaimer, 0);
2375 }
2376 
2377 void G1CollectedHeap::collection_set_iterate_all(HeapRegionClosure* cl) {
2378   _collection_set.iterate(cl);
2379 }
2380 
2381 void G1CollectedHeap::collection_set_par_iterate_all(HeapRegionClosure* cl, HeapRegionClaimer* hr_claimer, uint worker_id) {
2382   _collection_set.par_iterate(cl, hr_claimer, worker_id, workers()-&gt;active_workers());
2383 }
2384 
2385 void G1CollectedHeap::collection_set_iterate_increment_from(HeapRegionClosure *cl, HeapRegionClaimer* hr_claimer, uint worker_id) {
2386   _collection_set.iterate_incremental_part_from(cl, hr_claimer, worker_id, workers()-&gt;active_workers());
2387 }
2388 
2389 HeapWord* G1CollectedHeap::block_start(const void* addr) const {
2390   HeapRegion* hr = heap_region_containing(addr);
2391   return hr-&gt;block_start(addr);
2392 }
2393 
2394 bool G1CollectedHeap::block_is_obj(const HeapWord* addr) const {
2395   HeapRegion* hr = heap_region_containing(addr);
2396   return hr-&gt;block_is_obj(addr);
2397 }
2398 
2399 bool G1CollectedHeap::supports_tlab_allocation() const {
2400   return true;
2401 }
2402 
2403 size_t G1CollectedHeap::tlab_capacity(Thread* ignored) const {
2404   return (_policy-&gt;young_list_target_length() - _survivor.length()) * HeapRegion::GrainBytes;
2405 }
2406 
2407 size_t G1CollectedHeap::tlab_used(Thread* ignored) const {
2408   return _eden.length() * HeapRegion::GrainBytes;
2409 }
2410 
2411 // For G1 TLABs should not contain humongous objects, so the maximum TLAB size
2412 // must be equal to the humongous object limit.
2413 size_t G1CollectedHeap::max_tlab_size() const {
2414   return align_down(_humongous_object_threshold_in_words, MinObjAlignment);
2415 }
2416 
2417 size_t G1CollectedHeap::unsafe_max_tlab_alloc(Thread* ignored) const {
2418   return _allocator-&gt;unsafe_max_tlab_alloc();
2419 }
2420 
2421 size_t G1CollectedHeap::max_capacity() const {
2422   return _hrm-&gt;max_expandable_length() * HeapRegion::GrainBytes;
2423 }
2424 
2425 size_t G1CollectedHeap::max_reserved_capacity() const {
2426   return _hrm-&gt;max_length() * HeapRegion::GrainBytes;
2427 }
2428 
2429 jlong G1CollectedHeap::millis_since_last_gc() {
2430   // See the notes in GenCollectedHeap::millis_since_last_gc()
2431   // for more information about the implementation.
2432   jlong ret_val = (os::javaTimeNanos() / NANOSECS_PER_MILLISEC) -
2433                   _policy-&gt;collection_pause_end_millis();
2434   if (ret_val &lt; 0) {
2435     log_warning(gc)(&quot;millis_since_last_gc() would return : &quot; JLONG_FORMAT
2436       &quot;. returning zero instead.&quot;, ret_val);
2437     return 0;
2438   }
2439   return ret_val;
2440 }
2441 
2442 void G1CollectedHeap::deduplicate_string(oop str) {
2443   assert(java_lang_String::is_instance(str), &quot;invariant&quot;);
2444 
2445   if (G1StringDedup::is_enabled()) {
2446     G1StringDedup::deduplicate(str);
2447   }
2448 }
2449 
2450 void G1CollectedHeap::prepare_for_verify() {
2451   _verifier-&gt;prepare_for_verify();
2452 }
2453 
2454 void G1CollectedHeap::verify(VerifyOption vo) {
2455   _verifier-&gt;verify(vo);
2456 }
2457 
2458 bool G1CollectedHeap::supports_concurrent_phase_control() const {
2459   return true;
2460 }
2461 
2462 bool G1CollectedHeap::request_concurrent_phase(const char* phase) {
2463   return _cm_thread-&gt;request_concurrent_phase(phase);
2464 }
2465 
2466 bool G1CollectedHeap::is_heterogeneous_heap() const {
2467   return G1Arguments::is_heterogeneous_heap();
2468 }
2469 
2470 class PrintRegionClosure: public HeapRegionClosure {
2471   outputStream* _st;
2472 public:
2473   PrintRegionClosure(outputStream* st) : _st(st) {}
2474   bool do_heap_region(HeapRegion* r) {
2475     r-&gt;print_on(_st);
2476     return false;
2477   }
2478 };
2479 
2480 bool G1CollectedHeap::is_obj_dead_cond(const oop obj,
2481                                        const HeapRegion* hr,
2482                                        const VerifyOption vo) const {
2483   switch (vo) {
2484   case VerifyOption_G1UsePrevMarking: return is_obj_dead(obj, hr);
2485   case VerifyOption_G1UseNextMarking: return is_obj_ill(obj, hr);
2486   case VerifyOption_G1UseFullMarking: return is_obj_dead_full(obj, hr);
2487   default:                            ShouldNotReachHere();
2488   }
2489   return false; // keep some compilers happy
2490 }
2491 
2492 bool G1CollectedHeap::is_obj_dead_cond(const oop obj,
2493                                        const VerifyOption vo) const {
2494   switch (vo) {
2495   case VerifyOption_G1UsePrevMarking: return is_obj_dead(obj);
2496   case VerifyOption_G1UseNextMarking: return is_obj_ill(obj);
2497   case VerifyOption_G1UseFullMarking: return is_obj_dead_full(obj);
2498   default:                            ShouldNotReachHere();
2499   }
2500   return false; // keep some compilers happy
2501 }
2502 
2503 void G1CollectedHeap::print_heap_regions() const {
2504   LogTarget(Trace, gc, heap, region) lt;
2505   if (lt.is_enabled()) {
2506     LogStream ls(lt);
2507     print_regions_on(&amp;ls);
2508   }
2509 }
2510 
2511 void G1CollectedHeap::print_on(outputStream* st) const {
2512   st-&gt;print(&quot; %-20s&quot;, &quot;garbage-first heap&quot;);
2513   st-&gt;print(&quot; total &quot; SIZE_FORMAT &quot;K, used &quot; SIZE_FORMAT &quot;K&quot;,
2514             capacity()/K, used_unlocked()/K);
2515   st-&gt;print(&quot; [&quot; PTR_FORMAT &quot;, &quot; PTR_FORMAT &quot;)&quot;,
2516             p2i(_hrm-&gt;reserved().start()),
2517             p2i(_hrm-&gt;reserved().end()));
2518   st-&gt;cr();
2519   st-&gt;print(&quot;  region size &quot; SIZE_FORMAT &quot;K, &quot;, HeapRegion::GrainBytes / K);
2520   uint young_regions = young_regions_count();
2521   st-&gt;print(&quot;%u young (&quot; SIZE_FORMAT &quot;K), &quot;, young_regions,
2522             (size_t) young_regions * HeapRegion::GrainBytes / K);
2523   uint survivor_regions = survivor_regions_count();
2524   st-&gt;print(&quot;%u survivors (&quot; SIZE_FORMAT &quot;K)&quot;, survivor_regions,
2525             (size_t) survivor_regions * HeapRegion::GrainBytes / K);
2526   st-&gt;cr();
2527   if (_numa-&gt;is_enabled()) {
2528     uint num_nodes = _numa-&gt;num_active_nodes();
2529     st-&gt;print(&quot;  remaining free region(s) on each NUMA node: &quot;);
2530     const int* node_ids = _numa-&gt;node_ids();
2531     for (uint node_index = 0; node_index &lt; num_nodes; node_index++) {
2532       st-&gt;print(&quot;%d=%u &quot;, node_ids[node_index], _hrm-&gt;num_free_regions(node_index));
2533     }
2534     st-&gt;cr();
2535   }
2536   MetaspaceUtils::print_on(st);
2537 }
2538 
2539 void G1CollectedHeap::print_regions_on(outputStream* st) const {
2540   st-&gt;print_cr(&quot;Heap Regions: E=young(eden), S=young(survivor), O=old, &quot;
2541                &quot;HS=humongous(starts), HC=humongous(continues), &quot;
2542                &quot;CS=collection set, F=free, &quot;
2543                &quot;OA=open archive, CA=closed archive, &quot;
2544                &quot;TAMS=top-at-mark-start (previous, next)&quot;);
2545   PrintRegionClosure blk(st);
2546   heap_region_iterate(&amp;blk);
2547 }
2548 
2549 void G1CollectedHeap::print_extended_on(outputStream* st) const {
2550   print_on(st);
2551 
2552   // Print the per-region information.
2553   print_regions_on(st);
2554 }
2555 
2556 void G1CollectedHeap::print_on_error(outputStream* st) const {
2557   this-&gt;CollectedHeap::print_on_error(st);
2558 
2559   if (_cm != NULL) {
2560     st-&gt;cr();
2561     _cm-&gt;print_on_error(st);
2562   }
2563 }
2564 
2565 void G1CollectedHeap::print_gc_threads_on(outputStream* st) const {
2566   workers()-&gt;print_worker_threads_on(st);
2567   _cm_thread-&gt;print_on(st);
2568   st-&gt;cr();
2569   _cm-&gt;print_worker_threads_on(st);
2570   _cr-&gt;print_threads_on(st);
2571   _young_gen_sampling_thread-&gt;print_on(st);
2572   if (G1StringDedup::is_enabled()) {
2573     G1StringDedup::print_worker_threads_on(st);
2574   }
2575 }
2576 
2577 void G1CollectedHeap::gc_threads_do(ThreadClosure* tc) const {
2578   workers()-&gt;threads_do(tc);
2579   tc-&gt;do_thread(_cm_thread);
2580   _cm-&gt;threads_do(tc);
2581   _cr-&gt;threads_do(tc);
2582   tc-&gt;do_thread(_young_gen_sampling_thread);
2583   if (G1StringDedup::is_enabled()) {
2584     G1StringDedup::threads_do(tc);
2585   }
2586 }
2587 
2588 void G1CollectedHeap::print_tracing_info() const {
2589   rem_set()-&gt;print_summary_info();
2590   concurrent_mark()-&gt;print_summary_info();
2591 }
2592 
2593 #ifndef PRODUCT
2594 // Helpful for debugging RSet issues.
2595 
2596 class PrintRSetsClosure : public HeapRegionClosure {
2597 private:
2598   const char* _msg;
2599   size_t _occupied_sum;
2600 
2601 public:
2602   bool do_heap_region(HeapRegion* r) {
2603     HeapRegionRemSet* hrrs = r-&gt;rem_set();
2604     size_t occupied = hrrs-&gt;occupied();
2605     _occupied_sum += occupied;
2606 
2607     tty-&gt;print_cr(&quot;Printing RSet for region &quot; HR_FORMAT, HR_FORMAT_PARAMS(r));
2608     if (occupied == 0) {
2609       tty-&gt;print_cr(&quot;  RSet is empty&quot;);
2610     } else {
2611       hrrs-&gt;print();
2612     }
2613     tty-&gt;print_cr(&quot;----------&quot;);
2614     return false;
2615   }
2616 
2617   PrintRSetsClosure(const char* msg) : _msg(msg), _occupied_sum(0) {
2618     tty-&gt;cr();
2619     tty-&gt;print_cr(&quot;========================================&quot;);
2620     tty-&gt;print_cr(&quot;%s&quot;, msg);
2621     tty-&gt;cr();
2622   }
2623 
2624   ~PrintRSetsClosure() {
2625     tty-&gt;print_cr(&quot;Occupied Sum: &quot; SIZE_FORMAT, _occupied_sum);
2626     tty-&gt;print_cr(&quot;========================================&quot;);
2627     tty-&gt;cr();
2628   }
2629 };
2630 
2631 void G1CollectedHeap::print_cset_rsets() {
2632   PrintRSetsClosure cl(&quot;Printing CSet RSets&quot;);
2633   collection_set_iterate_all(&amp;cl);
2634 }
2635 
2636 void G1CollectedHeap::print_all_rsets() {
2637   PrintRSetsClosure cl(&quot;Printing All RSets&quot;);;
2638   heap_region_iterate(&amp;cl);
2639 }
2640 #endif // PRODUCT
2641 
2642 bool G1CollectedHeap::print_location(outputStream* st, void* addr) const {
2643   return BlockLocationPrinter&lt;G1CollectedHeap&gt;::print_location(st, addr);
2644 }
2645 
2646 G1HeapSummary G1CollectedHeap::create_g1_heap_summary() {
2647 
2648   size_t eden_used_bytes = _eden.used_bytes();
2649   size_t survivor_used_bytes = _survivor.used_bytes();
2650   size_t heap_used = Heap_lock-&gt;owned_by_self() ? used() : used_unlocked();
2651 
2652   size_t eden_capacity_bytes =
2653     (policy()-&gt;young_list_target_length() * HeapRegion::GrainBytes) - survivor_used_bytes;
2654 
2655   VirtualSpaceSummary heap_summary = create_heap_space_summary();
2656   return G1HeapSummary(heap_summary, heap_used, eden_used_bytes,
2657                        eden_capacity_bytes, survivor_used_bytes, num_regions());
2658 }
2659 
2660 G1EvacSummary G1CollectedHeap::create_g1_evac_summary(G1EvacStats* stats) {
2661   return G1EvacSummary(stats-&gt;allocated(), stats-&gt;wasted(), stats-&gt;undo_wasted(),
2662                        stats-&gt;unused(), stats-&gt;used(), stats-&gt;region_end_waste(),
2663                        stats-&gt;regions_filled(), stats-&gt;direct_allocated(),
2664                        stats-&gt;failure_used(), stats-&gt;failure_waste());
2665 }
2666 
2667 void G1CollectedHeap::trace_heap(GCWhen::Type when, const GCTracer* gc_tracer) {
2668   const G1HeapSummary&amp; heap_summary = create_g1_heap_summary();
2669   gc_tracer-&gt;report_gc_heap_summary(when, heap_summary);
2670 
2671   const MetaspaceSummary&amp; metaspace_summary = create_metaspace_summary();
2672   gc_tracer-&gt;report_metaspace_summary(when, metaspace_summary);
2673 }
2674 
2675 G1CollectedHeap* G1CollectedHeap::heap() {
2676   CollectedHeap* heap = Universe::heap();
2677   assert(heap != NULL, &quot;Uninitialized access to G1CollectedHeap::heap()&quot;);
2678   assert(heap-&gt;kind() == CollectedHeap::G1, &quot;Invalid name&quot;);
2679   return (G1CollectedHeap*)heap;
2680 }
2681 
2682 void G1CollectedHeap::gc_prologue(bool full) {
2683   assert(InlineCacheBuffer::is_empty(), &quot;should have cleaned up ICBuffer&quot;);
2684 
2685   // This summary needs to be printed before incrementing total collections.
2686   rem_set()-&gt;print_periodic_summary_info(&quot;Before GC RS summary&quot;, total_collections());
2687 
2688   // Update common counters.
2689   increment_total_collections(full /* full gc */);
2690   if (full || collector_state()-&gt;in_initial_mark_gc()) {
2691     increment_old_marking_cycles_started();
2692   }
2693 
2694   // Fill TLAB&#39;s and such
2695   double start = os::elapsedTime();
2696   ensure_parsability(true);
2697   phase_times()-&gt;record_prepare_tlab_time_ms((os::elapsedTime() - start) * 1000.0);
2698 }
2699 
2700 void G1CollectedHeap::gc_epilogue(bool full) {
2701   // Update common counters.
2702   if (full) {
2703     // Update the number of full collections that have been completed.
2704     increment_old_marking_cycles_completed(false /* concurrent */);
2705   }
2706 
2707   // We are at the end of the GC. Total collections has already been increased.
2708   rem_set()-&gt;print_periodic_summary_info(&quot;After GC RS summary&quot;, total_collections() - 1);
2709 
2710   // FIXME: what is this about?
2711   // I&#39;m ignoring the &quot;fill_newgen()&quot; call if &quot;alloc_event_enabled&quot;
2712   // is set.
2713 #if COMPILER2_OR_JVMCI
2714   assert(DerivedPointerTable::is_empty(), &quot;derived pointer present&quot;);
2715 #endif
2716 
2717   double start = os::elapsedTime();
2718   resize_all_tlabs();
2719   phase_times()-&gt;record_resize_tlab_time_ms((os::elapsedTime() - start) * 1000.0);
2720 
2721   MemoryService::track_memory_usage();
2722   // We have just completed a GC. Update the soft reference
2723   // policy with the new heap occupancy
2724   Universe::update_heap_info_at_gc();
2725 
2726   // Print NUMA statistics.
2727   _numa-&gt;print_statistics();
2728 }
2729 
2730 void G1CollectedHeap::verify_numa_regions(const char* desc) {
2731   LogTarget(Trace, gc, heap, verify) lt;
2732 
2733   if (lt.is_enabled()) {
2734     LogStream ls(lt);
2735     // Iterate all heap regions to print matching between preferred numa id and actual numa id.
2736     G1NodeIndexCheckClosure cl(desc, _numa, &amp;ls);
2737     heap_region_iterate(&amp;cl);
2738   }
2739 }
2740 
2741 HeapWord* G1CollectedHeap::do_collection_pause(size_t word_size,
2742                                                uint gc_count_before,
2743                                                bool* succeeded,
2744                                                GCCause::Cause gc_cause) {
2745   assert_heap_not_locked_and_not_at_safepoint();
2746   VM_G1CollectForAllocation op(word_size,
2747                                gc_count_before,
2748                                gc_cause,
2749                                policy()-&gt;max_pause_time_ms());
2750   VMThread::execute(&amp;op);
2751 
2752   HeapWord* result = op.result();
2753   bool ret_succeeded = op.prologue_succeeded() &amp;&amp; op.gc_succeeded();
2754   assert(result == NULL || ret_succeeded,
2755          &quot;the result should be NULL if the VM did not succeed&quot;);
2756   *succeeded = ret_succeeded;
2757 
2758   assert_heap_not_locked();
2759   return result;
2760 }
2761 
2762 void G1CollectedHeap::do_concurrent_mark() {
2763   MutexLocker x(CGC_lock, Mutex::_no_safepoint_check_flag);
2764   if (!_cm_thread-&gt;in_progress()) {
2765     _cm_thread-&gt;set_started();
2766     CGC_lock-&gt;notify();
2767   }
2768 }
2769 
2770 size_t G1CollectedHeap::pending_card_num() {
2771   struct CountCardsClosure : public ThreadClosure {
2772     size_t _cards;
2773     CountCardsClosure() : _cards(0) {}
2774     virtual void do_thread(Thread* t) {
2775       _cards += G1ThreadLocalData::dirty_card_queue(t).size();
2776     }
2777   } count_from_threads;
2778   Threads::threads_do(&amp;count_from_threads);
2779 
2780   G1DirtyCardQueueSet&amp; dcqs = G1BarrierSet::dirty_card_queue_set();
<a name="3" id="anc3"></a><span class="line-removed">2781   dcqs.verify_num_cards();</span>
<span class="line-removed">2782 </span>
2783   return dcqs.num_cards() + count_from_threads._cards;
2784 }
2785 
2786 bool G1CollectedHeap::is_potential_eager_reclaim_candidate(HeapRegion* r) const {
2787   // We don&#39;t nominate objects with many remembered set entries, on
2788   // the assumption that such objects are likely still live.
2789   HeapRegionRemSet* rem_set = r-&gt;rem_set();
2790 
2791   return G1EagerReclaimHumongousObjectsWithStaleRefs ?
2792          rem_set-&gt;occupancy_less_or_equal_than(G1RSetSparseRegionEntries) :
2793          G1EagerReclaimHumongousObjects &amp;&amp; rem_set-&gt;is_empty();
2794 }
2795 
2796 #ifndef PRODUCT
2797 void G1CollectedHeap::verify_region_attr_remset_update() {
2798   class VerifyRegionAttrRemSet : public HeapRegionClosure {
2799   public:
2800     virtual bool do_heap_region(HeapRegion* r) {
2801       G1CollectedHeap* g1h = G1CollectedHeap::heap();
2802       bool const needs_remset_update = g1h-&gt;region_attr(r-&gt;bottom()).needs_remset_update();
2803       assert(r-&gt;rem_set()-&gt;is_tracked() == needs_remset_update,
2804              &quot;Region %u remset tracking status (%s) different to region attribute (%s)&quot;,
2805              r-&gt;hrm_index(), BOOL_TO_STR(r-&gt;rem_set()-&gt;is_tracked()), BOOL_TO_STR(needs_remset_update));
2806       return false;
2807     }
2808   } cl;
2809   heap_region_iterate(&amp;cl);
2810 }
2811 #endif
2812 
2813 class VerifyRegionRemSetClosure : public HeapRegionClosure {
2814   public:
2815     bool do_heap_region(HeapRegion* hr) {
2816       if (!hr-&gt;is_archive() &amp;&amp; !hr-&gt;is_continues_humongous()) {
2817         hr-&gt;verify_rem_set();
2818       }
2819       return false;
2820     }
2821 };
2822 
2823 uint G1CollectedHeap::num_task_queues() const {
2824   return _task_queues-&gt;size();
2825 }
2826 
2827 #if TASKQUEUE_STATS
2828 void G1CollectedHeap::print_taskqueue_stats_hdr(outputStream* const st) {
2829   st-&gt;print_raw_cr(&quot;GC Task Stats&quot;);
2830   st-&gt;print_raw(&quot;thr &quot;); TaskQueueStats::print_header(1, st); st-&gt;cr();
2831   st-&gt;print_raw(&quot;--- &quot;); TaskQueueStats::print_header(2, st); st-&gt;cr();
2832 }
2833 
2834 void G1CollectedHeap::print_taskqueue_stats() const {
2835   if (!log_is_enabled(Trace, gc, task, stats)) {
2836     return;
2837   }
2838   Log(gc, task, stats) log;
2839   ResourceMark rm;
2840   LogStream ls(log.trace());
2841   outputStream* st = &amp;ls;
2842 
2843   print_taskqueue_stats_hdr(st);
2844 
2845   TaskQueueStats totals;
2846   const uint n = num_task_queues();
2847   for (uint i = 0; i &lt; n; ++i) {
2848     st-&gt;print(&quot;%3u &quot;, i); task_queue(i)-&gt;stats.print(st); st-&gt;cr();
2849     totals += task_queue(i)-&gt;stats;
2850   }
2851   st-&gt;print_raw(&quot;tot &quot;); totals.print(st); st-&gt;cr();
2852 
2853   DEBUG_ONLY(totals.verify());
2854 }
2855 
2856 void G1CollectedHeap::reset_taskqueue_stats() {
2857   const uint n = num_task_queues();
2858   for (uint i = 0; i &lt; n; ++i) {
2859     task_queue(i)-&gt;stats.reset();
2860   }
2861 }
2862 #endif // TASKQUEUE_STATS
2863 
2864 void G1CollectedHeap::wait_for_root_region_scanning() {
2865   double scan_wait_start = os::elapsedTime();
2866   // We have to wait until the CM threads finish scanning the
2867   // root regions as it&#39;s the only way to ensure that all the
2868   // objects on them have been correctly scanned before we start
2869   // moving them during the GC.
2870   bool waited = _cm-&gt;root_regions()-&gt;wait_until_scan_finished();
2871   double wait_time_ms = 0.0;
2872   if (waited) {
2873     double scan_wait_end = os::elapsedTime();
2874     wait_time_ms = (scan_wait_end - scan_wait_start) * 1000.0;
2875   }
2876   phase_times()-&gt;record_root_region_scan_wait_time(wait_time_ms);
2877 }
2878 
2879 class G1PrintCollectionSetClosure : public HeapRegionClosure {
2880 private:
2881   G1HRPrinter* _hr_printer;
2882 public:
2883   G1PrintCollectionSetClosure(G1HRPrinter* hr_printer) : HeapRegionClosure(), _hr_printer(hr_printer) { }
2884 
2885   virtual bool do_heap_region(HeapRegion* r) {
2886     _hr_printer-&gt;cset(r);
2887     return false;
2888   }
2889 };
2890 
2891 void G1CollectedHeap::start_new_collection_set() {
2892   double start = os::elapsedTime();
2893 
2894   collection_set()-&gt;start_incremental_building();
2895 
2896   clear_region_attr();
2897 
2898   guarantee(_eden.length() == 0, &quot;eden should have been cleared&quot;);
2899   policy()-&gt;transfer_survivors_to_cset(survivor());
2900 
2901   // We redo the verification but now wrt to the new CSet which
2902   // has just got initialized after the previous CSet was freed.
2903   _cm-&gt;verify_no_collection_set_oops();
2904 
2905   phase_times()-&gt;record_start_new_cset_time_ms((os::elapsedTime() - start) * 1000.0);
2906 }
2907 
2908 void G1CollectedHeap::calculate_collection_set(G1EvacuationInfo&amp; evacuation_info, double target_pause_time_ms) {
2909 
2910   _collection_set.finalize_initial_collection_set(target_pause_time_ms, &amp;_survivor);
2911   evacuation_info.set_collectionset_regions(collection_set()-&gt;region_length() +
2912                                             collection_set()-&gt;optional_region_length());
2913 
2914   _cm-&gt;verify_no_collection_set_oops();
2915 
2916   if (_hr_printer.is_active()) {
2917     G1PrintCollectionSetClosure cl(&amp;_hr_printer);
2918     _collection_set.iterate(&amp;cl);
2919     _collection_set.iterate_optional(&amp;cl);
2920   }
2921 }
2922 
2923 G1HeapVerifier::G1VerifyType G1CollectedHeap::young_collection_verify_type() const {
2924   if (collector_state()-&gt;in_initial_mark_gc()) {
2925     return G1HeapVerifier::G1VerifyConcurrentStart;
2926   } else if (collector_state()-&gt;in_young_only_phase()) {
2927     return G1HeapVerifier::G1VerifyYoungNormal;
2928   } else {
2929     return G1HeapVerifier::G1VerifyMixed;
2930   }
2931 }
2932 
2933 void G1CollectedHeap::verify_before_young_collection(G1HeapVerifier::G1VerifyType type) {
2934   if (VerifyRememberedSets) {
2935     log_info(gc, verify)(&quot;[Verifying RemSets before GC]&quot;);
2936     VerifyRegionRemSetClosure v_cl;
2937     heap_region_iterate(&amp;v_cl);
2938   }
2939   _verifier-&gt;verify_before_gc(type);
2940   _verifier-&gt;check_bitmaps(&quot;GC Start&quot;);
2941   verify_numa_regions(&quot;GC Start&quot;);
2942 }
2943 
2944 void G1CollectedHeap::verify_after_young_collection(G1HeapVerifier::G1VerifyType type) {
2945   if (VerifyRememberedSets) {
2946     log_info(gc, verify)(&quot;[Verifying RemSets after GC]&quot;);
2947     VerifyRegionRemSetClosure v_cl;
2948     heap_region_iterate(&amp;v_cl);
2949   }
2950   _verifier-&gt;verify_after_gc(type);
2951   _verifier-&gt;check_bitmaps(&quot;GC End&quot;);
2952   verify_numa_regions(&quot;GC End&quot;);
2953 }
2954 
2955 void G1CollectedHeap::expand_heap_after_young_collection(){
2956   size_t expand_bytes = _heap_sizing_policy-&gt;expansion_amount();
2957   if (expand_bytes &gt; 0) {
2958     // No need for an ergo logging here,
2959     // expansion_amount() does this when it returns a value &gt; 0.
2960     double expand_ms;
2961     if (!expand(expand_bytes, _workers, &amp;expand_ms)) {
2962       // We failed to expand the heap. Cannot do anything about it.
2963     }
2964     phase_times()-&gt;record_expand_heap_time(expand_ms);
2965   }
2966 }
2967 
2968 const char* G1CollectedHeap::young_gc_name() const {
2969   if (collector_state()-&gt;in_initial_mark_gc()) {
2970     return &quot;Pause Young (Concurrent Start)&quot;;
2971   } else if (collector_state()-&gt;in_young_only_phase()) {
2972     if (collector_state()-&gt;in_young_gc_before_mixed()) {
2973       return &quot;Pause Young (Prepare Mixed)&quot;;
2974     } else {
2975       return &quot;Pause Young (Normal)&quot;;
2976     }
2977   } else {
2978     return &quot;Pause Young (Mixed)&quot;;
2979   }
2980 }
2981 
2982 bool G1CollectedHeap::do_collection_pause_at_safepoint(double target_pause_time_ms) {
2983   assert_at_safepoint_on_vm_thread();
2984   guarantee(!is_gc_active(), &quot;collection is not reentrant&quot;);
2985 
2986   if (GCLocker::check_active_before_gc()) {
2987     return false;
2988   }
2989 
2990   do_collection_pause_at_safepoint_helper(target_pause_time_ms);
2991   if (should_upgrade_to_full_gc(gc_cause())) {
2992     log_info(gc, ergo)(&quot;Attempting maximally compacting collection&quot;);
2993     bool result = do_full_collection(false /* explicit gc */,
2994                                      true /* clear_all_soft_refs */);
2995     // do_full_collection only fails if blocked by GC locker, but
2996     // we&#39;ve already checked for that above.
2997     assert(result, &quot;invariant&quot;);
2998   }
2999   return true;
3000 }
3001 
3002 void G1CollectedHeap::do_collection_pause_at_safepoint_helper(double target_pause_time_ms) {
3003   GCIdMark gc_id_mark;
3004 
3005   SvcGCMarker sgcm(SvcGCMarker::MINOR);
3006   ResourceMark rm;
3007 
3008   policy()-&gt;note_gc_start();
3009 
3010   _gc_timer_stw-&gt;register_gc_start();
3011   _gc_tracer_stw-&gt;report_gc_start(gc_cause(), _gc_timer_stw-&gt;gc_start());
3012 
3013   wait_for_root_region_scanning();
3014 
3015   print_heap_before_gc();
3016   print_heap_regions();
3017   trace_heap_before_gc(_gc_tracer_stw);
3018 
3019   _verifier-&gt;verify_region_sets_optional();
3020   _verifier-&gt;verify_dirty_young_regions();
3021 
3022   // We should not be doing initial mark unless the conc mark thread is running
3023   if (!_cm_thread-&gt;should_terminate()) {
3024     // This call will decide whether this pause is an initial-mark
3025     // pause. If it is, in_initial_mark_gc() will return true
3026     // for the duration of this pause.
3027     policy()-&gt;decide_on_conc_mark_initiation();
3028   }
3029 
3030   // We do not allow initial-mark to be piggy-backed on a mixed GC.
3031   assert(!collector_state()-&gt;in_initial_mark_gc() ||
3032          collector_state()-&gt;in_young_only_phase(), &quot;sanity&quot;);
3033   // We also do not allow mixed GCs during marking.
3034   assert(!collector_state()-&gt;mark_or_rebuild_in_progress() || collector_state()-&gt;in_young_only_phase(), &quot;sanity&quot;);
3035 
3036   // Record whether this pause is an initial mark. When the current
3037   // thread has completed its logging output and it&#39;s safe to signal
3038   // the CM thread, the flag&#39;s value in the policy has been reset.
3039   bool should_start_conc_mark = collector_state()-&gt;in_initial_mark_gc();
3040   if (should_start_conc_mark) {
3041     _cm-&gt;gc_tracer_cm()-&gt;set_gc_cause(gc_cause());
3042   }
3043 
3044   // Inner scope for scope based logging, timers, and stats collection
3045   {
3046     G1EvacuationInfo evacuation_info;
3047 
3048     _gc_tracer_stw-&gt;report_yc_type(collector_state()-&gt;yc_type());
3049 
3050     GCTraceCPUTime tcpu;
3051 
3052     GCTraceTime(Info, gc) tm(young_gc_name(), NULL, gc_cause(), true);
3053 
3054     uint active_workers = WorkerPolicy::calc_active_workers(workers()-&gt;total_workers(),
3055                                                             workers()-&gt;active_workers(),
3056                                                             Threads::number_of_non_daemon_threads());
3057     active_workers = workers()-&gt;update_active_workers(active_workers);
3058     log_info(gc,task)(&quot;Using %u workers of %u for evacuation&quot;, active_workers, workers()-&gt;total_workers());
3059 
3060     G1MonitoringScope ms(g1mm(),
3061                          false /* full_gc */,
3062                          collector_state()-&gt;yc_type() == Mixed /* all_memory_pools_affected */);
3063 
3064     G1HeapTransition heap_transition(this);
3065 
3066     {
3067       IsGCActiveMark x;
3068 
3069       gc_prologue(false);
3070 
3071       G1HeapVerifier::G1VerifyType verify_type = young_collection_verify_type();
3072       verify_before_young_collection(verify_type);
3073 
3074       {
3075         // The elapsed time induced by the start time below deliberately elides
3076         // the possible verification above.
3077         double sample_start_time_sec = os::elapsedTime();
3078 
3079         // Please see comment in g1CollectedHeap.hpp and
3080         // G1CollectedHeap::ref_processing_init() to see how
3081         // reference processing currently works in G1.
3082         _ref_processor_stw-&gt;enable_discovery();
3083 
3084         // We want to temporarily turn off discovery by the
3085         // CM ref processor, if necessary, and turn it back on
3086         // on again later if we do. Using a scoped
3087         // NoRefDiscovery object will do this.
3088         NoRefDiscovery no_cm_discovery(_ref_processor_cm);
3089 
3090         policy()-&gt;record_collection_pause_start(sample_start_time_sec);
3091 
3092         // Forget the current allocation region (we might even choose it to be part
3093         // of the collection set!).
3094         _allocator-&gt;release_mutator_alloc_regions();
3095 
3096         calculate_collection_set(evacuation_info, target_pause_time_ms);
3097 
3098         G1RedirtyCardsQueueSet rdcqs(G1BarrierSet::dirty_card_queue_set().allocator());
3099         G1ParScanThreadStateSet per_thread_states(this,
3100                                                   &amp;rdcqs,
3101                                                   workers()-&gt;active_workers(),
3102                                                   collection_set()-&gt;young_region_length(),
3103                                                   collection_set()-&gt;optional_region_length());
3104         pre_evacuate_collection_set(evacuation_info, &amp;per_thread_states);
3105 
3106         // Actually do the work...
3107         evacuate_initial_collection_set(&amp;per_thread_states);
3108 
3109         if (_collection_set.optional_region_length() != 0) {
3110           evacuate_optional_collection_set(&amp;per_thread_states);
3111         }
3112         post_evacuate_collection_set(evacuation_info, &amp;rdcqs, &amp;per_thread_states);
3113 
3114         start_new_collection_set();
3115 
3116         _survivor_evac_stats.adjust_desired_plab_sz();
3117         _old_evac_stats.adjust_desired_plab_sz();
3118 
3119         if (should_start_conc_mark) {
3120           // We have to do this before we notify the CM threads that
3121           // they can start working to make sure that all the
3122           // appropriate initialization is done on the CM object.
3123           concurrent_mark()-&gt;post_initial_mark();
3124           // Note that we don&#39;t actually trigger the CM thread at
3125           // this point. We do that later when we&#39;re sure that
3126           // the current thread has completed its logging output.
3127         }
3128 
3129         allocate_dummy_regions();
3130 
3131         _allocator-&gt;init_mutator_alloc_regions();
3132 
3133         expand_heap_after_young_collection();
3134 
3135         double sample_end_time_sec = os::elapsedTime();
3136         double pause_time_ms = (sample_end_time_sec - sample_start_time_sec) * MILLIUNITS;
3137         policy()-&gt;record_collection_pause_end(pause_time_ms);
3138       }
3139 
3140       verify_after_young_collection(verify_type);
3141 
<a name="4" id="anc4"></a><span class="line-removed">3142 #ifdef TRACESPINNING</span>
<span class="line-removed">3143       ParallelTaskTerminator::print_termination_counts();</span>
<span class="line-removed">3144 #endif</span>
<span class="line-removed">3145 </span>
3146       gc_epilogue(false);
3147     }
3148 
3149     // Print the remainder of the GC log output.
3150     if (evacuation_failed()) {
3151       log_info(gc)(&quot;To-space exhausted&quot;);
3152     }
3153 
3154     policy()-&gt;print_phases();
3155     heap_transition.print();
3156 
3157     _hrm-&gt;verify_optional();
3158     _verifier-&gt;verify_region_sets_optional();
3159 
3160     TASKQUEUE_STATS_ONLY(print_taskqueue_stats());
3161     TASKQUEUE_STATS_ONLY(reset_taskqueue_stats());
3162 
3163     print_heap_after_gc();
3164     print_heap_regions();
3165     trace_heap_after_gc(_gc_tracer_stw);
3166 
3167     // We must call G1MonitoringSupport::update_sizes() in the same scoping level
3168     // as an active TraceMemoryManagerStats object (i.e. before the destructor for the
3169     // TraceMemoryManagerStats is called) so that the G1 memory pools are updated
3170     // before any GC notifications are raised.
3171     g1mm()-&gt;update_sizes();
3172 
3173     _gc_tracer_stw-&gt;report_evacuation_info(&amp;evacuation_info);
3174     _gc_tracer_stw-&gt;report_tenuring_threshold(_policy-&gt;tenuring_threshold());
3175     _gc_timer_stw-&gt;register_gc_end();
3176     _gc_tracer_stw-&gt;report_gc_end(_gc_timer_stw-&gt;gc_end(), _gc_timer_stw-&gt;time_partitions());
3177   }
3178   // It should now be safe to tell the concurrent mark thread to start
3179   // without its logging output interfering with the logging output
3180   // that came from the pause.
3181 
3182   if (should_start_conc_mark) {
3183     // CAUTION: after the doConcurrentMark() call below, the concurrent marking
3184     // thread(s) could be running concurrently with us. Make sure that anything
3185     // after this point does not assume that we are the only GC thread running.
3186     // Note: of course, the actual marking work will not start until the safepoint
3187     // itself is released in SuspendibleThreadSet::desynchronize().
3188     do_concurrent_mark();
3189   }
3190 }
3191 
3192 void G1CollectedHeap::remove_self_forwarding_pointers(G1RedirtyCardsQueueSet* rdcqs) {
3193   G1ParRemoveSelfForwardPtrsTask rsfp_task(rdcqs);
3194   workers()-&gt;run_task(&amp;rsfp_task);
3195 }
3196 
3197 void G1CollectedHeap::restore_after_evac_failure(G1RedirtyCardsQueueSet* rdcqs) {
3198   double remove_self_forwards_start = os::elapsedTime();
3199 
3200   remove_self_forwarding_pointers(rdcqs);
3201   _preserved_marks_set.restore(workers());
3202 
3203   phase_times()-&gt;record_evac_fail_remove_self_forwards((os::elapsedTime() - remove_self_forwards_start) * 1000.0);
3204 }
3205 
3206 void G1CollectedHeap::preserve_mark_during_evac_failure(uint worker_id, oop obj, markWord m) {
3207   if (!_evacuation_failed) {
3208     _evacuation_failed = true;
3209   }
3210 
3211   _evacuation_failed_info_array[worker_id].register_copy_failure(obj-&gt;size());
3212   _preserved_marks_set.get(worker_id)-&gt;push_if_necessary(obj, m);
3213 }
3214 
3215 bool G1ParEvacuateFollowersClosure::offer_termination() {
3216   EventGCPhaseParallel event;
3217   G1ParScanThreadState* const pss = par_scan_state();
3218   start_term_time();
3219   const bool res = terminator()-&gt;offer_termination();
3220   end_term_time();
3221   event.commit(GCId::current(), pss-&gt;worker_id(), G1GCPhaseTimes::phase_name(G1GCPhaseTimes::Termination));
3222   return res;
3223 }
3224 
3225 void G1ParEvacuateFollowersClosure::do_void() {
3226   EventGCPhaseParallel event;
3227   G1ParScanThreadState* const pss = par_scan_state();
3228   pss-&gt;trim_queue();
3229   event.commit(GCId::current(), pss-&gt;worker_id(), G1GCPhaseTimes::phase_name(_phase));
3230   do {
3231     EventGCPhaseParallel event;
3232     pss-&gt;steal_and_trim_queue(queues());
3233     event.commit(GCId::current(), pss-&gt;worker_id(), G1GCPhaseTimes::phase_name(_phase));
3234   } while (!offer_termination());
3235 }
3236 
3237 void G1CollectedHeap::complete_cleaning(BoolObjectClosure* is_alive,
3238                                         bool class_unloading_occurred) {
3239   uint num_workers = workers()-&gt;active_workers();
3240   G1ParallelCleaningTask unlink_task(is_alive, num_workers, class_unloading_occurred, false);
3241   workers()-&gt;run_task(&amp;unlink_task);
3242 }
3243 
3244 // Clean string dedup data structures.
3245 // Ideally we would prefer to use a StringDedupCleaningTask here, but we want to
3246 // record the durations of the phases. Hence the almost-copy.
3247 class G1StringDedupCleaningTask : public AbstractGangTask {
3248   BoolObjectClosure* _is_alive;
3249   OopClosure* _keep_alive;
3250   G1GCPhaseTimes* _phase_times;
3251 
3252 public:
3253   G1StringDedupCleaningTask(BoolObjectClosure* is_alive,
3254                             OopClosure* keep_alive,
3255                             G1GCPhaseTimes* phase_times) :
3256     AbstractGangTask(&quot;Partial Cleaning Task&quot;),
3257     _is_alive(is_alive),
3258     _keep_alive(keep_alive),
3259     _phase_times(phase_times)
3260   {
3261     assert(G1StringDedup::is_enabled(), &quot;String deduplication disabled.&quot;);
3262     StringDedup::gc_prologue(true);
3263   }
3264 
3265   ~G1StringDedupCleaningTask() {
3266     StringDedup::gc_epilogue();
3267   }
3268 
3269   void work(uint worker_id) {
3270     StringDedupUnlinkOrOopsDoClosure cl(_is_alive, _keep_alive);
3271     {
3272       G1GCParPhaseTimesTracker x(_phase_times, G1GCPhaseTimes::StringDedupQueueFixup, worker_id);
3273       StringDedupQueue::unlink_or_oops_do(&amp;cl);
3274     }
3275     {
3276       G1GCParPhaseTimesTracker x(_phase_times, G1GCPhaseTimes::StringDedupTableFixup, worker_id);
3277       StringDedupTable::unlink_or_oops_do(&amp;cl, worker_id);
3278     }
3279   }
3280 };
3281 
3282 void G1CollectedHeap::string_dedup_cleaning(BoolObjectClosure* is_alive,
3283                                             OopClosure* keep_alive,
3284                                             G1GCPhaseTimes* phase_times) {
3285   G1StringDedupCleaningTask cl(is_alive, keep_alive, phase_times);
3286   workers()-&gt;run_task(&amp;cl);
3287 }
3288 
3289 class G1RedirtyLoggedCardsTask : public AbstractGangTask {
3290  private:
3291   G1RedirtyCardsQueueSet* _qset;
3292   G1CollectedHeap* _g1h;
3293   BufferNode* volatile _nodes;
3294 
3295   void par_apply(RedirtyLoggedCardTableEntryClosure* cl, uint worker_id) {
3296     size_t buffer_size = _qset-&gt;buffer_size();
3297     BufferNode* next = Atomic::load(&amp;_nodes);
3298     while (next != NULL) {
3299       BufferNode* node = next;
3300       next = Atomic::cmpxchg(&amp;_nodes, node, node-&gt;next());
3301       if (next == node) {
3302         cl-&gt;apply_to_buffer(node, buffer_size, worker_id);
3303         next = node-&gt;next();
3304       }
3305     }
3306   }
3307 
3308  public:
3309   G1RedirtyLoggedCardsTask(G1RedirtyCardsQueueSet* qset, G1CollectedHeap* g1h) :
3310     AbstractGangTask(&quot;Redirty Cards&quot;),
3311     _qset(qset), _g1h(g1h), _nodes(qset-&gt;all_completed_buffers()) { }
3312 
3313   virtual void work(uint worker_id) {
3314     G1GCPhaseTimes* p = _g1h-&gt;phase_times();
3315     G1GCParPhaseTimesTracker x(p, G1GCPhaseTimes::RedirtyCards, worker_id);
3316 
3317     RedirtyLoggedCardTableEntryClosure cl(_g1h);
3318     par_apply(&amp;cl, worker_id);
3319 
3320     p-&gt;record_thread_work_item(G1GCPhaseTimes::RedirtyCards, worker_id, cl.num_dirtied());
3321   }
3322 };
3323 
3324 void G1CollectedHeap::redirty_logged_cards(G1RedirtyCardsQueueSet* rdcqs) {
3325   double redirty_logged_cards_start = os::elapsedTime();
3326 
3327   G1RedirtyLoggedCardsTask redirty_task(rdcqs, this);
3328   workers()-&gt;run_task(&amp;redirty_task);
3329 
3330   G1DirtyCardQueueSet&amp; dcq = G1BarrierSet::dirty_card_queue_set();
3331   dcq.merge_bufferlists(rdcqs);
3332 
3333   phase_times()-&gt;record_redirty_logged_cards_time_ms((os::elapsedTime() - redirty_logged_cards_start) * 1000.0);
3334 }
3335 
3336 // Weak Reference Processing support
3337 
3338 bool G1STWIsAliveClosure::do_object_b(oop p) {
3339   // An object is reachable if it is outside the collection set,
3340   // or is inside and copied.
3341   return !_g1h-&gt;is_in_cset(p) || p-&gt;is_forwarded();
3342 }
3343 
3344 bool G1STWSubjectToDiscoveryClosure::do_object_b(oop obj) {
3345   assert(obj != NULL, &quot;must not be NULL&quot;);
3346   assert(_g1h-&gt;is_in_reserved(obj), &quot;Trying to discover obj &quot; PTR_FORMAT &quot; not in heap&quot;, p2i(obj));
3347   // The areas the CM and STW ref processor manage must be disjoint. The is_in_cset() below
3348   // may falsely indicate that this is not the case here: however the collection set only
3349   // contains old regions when concurrent mark is not running.
3350   return _g1h-&gt;is_in_cset(obj) || _g1h-&gt;heap_region_containing(obj)-&gt;is_survivor();
3351 }
3352 
3353 // Non Copying Keep Alive closure
3354 class G1KeepAliveClosure: public OopClosure {
3355   G1CollectedHeap*_g1h;
3356 public:
3357   G1KeepAliveClosure(G1CollectedHeap* g1h) :_g1h(g1h) {}
3358   void do_oop(narrowOop* p) { guarantee(false, &quot;Not needed&quot;); }
3359   void do_oop(oop* p) {
3360     oop obj = *p;
3361     assert(obj != NULL, &quot;the caller should have filtered out NULL values&quot;);
3362 
3363     const G1HeapRegionAttr region_attr =_g1h-&gt;region_attr(obj);
3364     if (!region_attr.is_in_cset_or_humongous()) {
3365       return;
3366     }
3367     if (region_attr.is_in_cset()) {
3368       assert( obj-&gt;is_forwarded(), &quot;invariant&quot; );
3369       *p = obj-&gt;forwardee();
3370     } else {
3371       assert(!obj-&gt;is_forwarded(), &quot;invariant&quot; );
3372       assert(region_attr.is_humongous(),
3373              &quot;Only allowed G1HeapRegionAttr state is IsHumongous, but is %d&quot;, region_attr.type());
3374      _g1h-&gt;set_humongous_is_live(obj);
3375     }
3376   }
3377 };
3378 
3379 // Copying Keep Alive closure - can be called from both
3380 // serial and parallel code as long as different worker
3381 // threads utilize different G1ParScanThreadState instances
3382 // and different queues.
3383 
3384 class G1CopyingKeepAliveClosure: public OopClosure {
3385   G1CollectedHeap*         _g1h;
3386   G1ParScanThreadState*    _par_scan_state;
3387 
3388 public:
3389   G1CopyingKeepAliveClosure(G1CollectedHeap* g1h,
3390                             G1ParScanThreadState* pss):
3391     _g1h(g1h),
3392     _par_scan_state(pss)
3393   {}
3394 
3395   virtual void do_oop(narrowOop* p) { do_oop_work(p); }
3396   virtual void do_oop(      oop* p) { do_oop_work(p); }
3397 
3398   template &lt;class T&gt; void do_oop_work(T* p) {
3399     oop obj = RawAccess&lt;&gt;::oop_load(p);
3400 
3401     if (_g1h-&gt;is_in_cset_or_humongous(obj)) {
3402       // If the referent object has been forwarded (either copied
3403       // to a new location or to itself in the event of an
3404       // evacuation failure) then we need to update the reference
3405       // field and, if both reference and referent are in the G1
3406       // heap, update the RSet for the referent.
3407       //
3408       // If the referent has not been forwarded then we have to keep
3409       // it alive by policy. Therefore we have copy the referent.
3410       //
3411       // When the queue is drained (after each phase of reference processing)
3412       // the object and it&#39;s followers will be copied, the reference field set
3413       // to point to the new location, and the RSet updated.
3414       _par_scan_state-&gt;push_on_queue(p);
3415     }
3416   }
3417 };
3418 
3419 // Serial drain queue closure. Called as the &#39;complete_gc&#39;
3420 // closure for each discovered list in some of the
3421 // reference processing phases.
3422 
3423 class G1STWDrainQueueClosure: public VoidClosure {
3424 protected:
3425   G1CollectedHeap* _g1h;
3426   G1ParScanThreadState* _par_scan_state;
3427 
3428   G1ParScanThreadState*   par_scan_state() { return _par_scan_state; }
3429 
3430 public:
3431   G1STWDrainQueueClosure(G1CollectedHeap* g1h, G1ParScanThreadState* pss) :
3432     _g1h(g1h),
3433     _par_scan_state(pss)
3434   { }
3435 
3436   void do_void() {
3437     G1ParScanThreadState* const pss = par_scan_state();
3438     pss-&gt;trim_queue();
3439   }
3440 };
3441 
3442 // Parallel Reference Processing closures
3443 
3444 // Implementation of AbstractRefProcTaskExecutor for parallel reference
3445 // processing during G1 evacuation pauses.
3446 
3447 class G1STWRefProcTaskExecutor: public AbstractRefProcTaskExecutor {
3448 private:
3449   G1CollectedHeap*          _g1h;
3450   G1ParScanThreadStateSet*  _pss;
3451   RefToScanQueueSet*        _queues;
3452   WorkGang*                 _workers;
3453 
3454 public:
3455   G1STWRefProcTaskExecutor(G1CollectedHeap* g1h,
3456                            G1ParScanThreadStateSet* per_thread_states,
3457                            WorkGang* workers,
3458                            RefToScanQueueSet *task_queues) :
3459     _g1h(g1h),
3460     _pss(per_thread_states),
3461     _queues(task_queues),
3462     _workers(workers)
3463   {
3464     g1h-&gt;ref_processor_stw()-&gt;set_active_mt_degree(workers-&gt;active_workers());
3465   }
3466 
3467   // Executes the given task using concurrent marking worker threads.
3468   virtual void execute(ProcessTask&amp; task, uint ergo_workers);
3469 };
3470 
3471 // Gang task for possibly parallel reference processing
3472 
3473 class G1STWRefProcTaskProxy: public AbstractGangTask {
3474   typedef AbstractRefProcTaskExecutor::ProcessTask ProcessTask;
3475   ProcessTask&amp;     _proc_task;
3476   G1CollectedHeap* _g1h;
3477   G1ParScanThreadStateSet* _pss;
3478   RefToScanQueueSet* _task_queues;
<a name="5" id="anc5"></a><span class="line-modified">3479   ParallelTaskTerminator* _terminator;</span>
3480 
3481 public:
3482   G1STWRefProcTaskProxy(ProcessTask&amp; proc_task,
3483                         G1CollectedHeap* g1h,
3484                         G1ParScanThreadStateSet* per_thread_states,
3485                         RefToScanQueueSet *task_queues,
<a name="6" id="anc6"></a><span class="line-modified">3486                         ParallelTaskTerminator* terminator) :</span>
3487     AbstractGangTask(&quot;Process reference objects in parallel&quot;),
3488     _proc_task(proc_task),
3489     _g1h(g1h),
3490     _pss(per_thread_states),
3491     _task_queues(task_queues),
3492     _terminator(terminator)
3493   {}
3494 
3495   virtual void work(uint worker_id) {
3496     // The reference processing task executed by a single worker.
3497     ResourceMark rm;
3498     HandleMark   hm;
3499 
3500     G1STWIsAliveClosure is_alive(_g1h);
3501 
3502     G1ParScanThreadState* pss = _pss-&gt;state_for_worker(worker_id);
3503     pss-&gt;set_ref_discoverer(NULL);
3504 
3505     // Keep alive closure.
3506     G1CopyingKeepAliveClosure keep_alive(_g1h, pss);
3507 
3508     // Complete GC closure
3509     G1ParEvacuateFollowersClosure drain_queue(_g1h, pss, _task_queues, _terminator, G1GCPhaseTimes::ObjCopy);
3510 
3511     // Call the reference processing task&#39;s work routine.
3512     _proc_task.work(worker_id, is_alive, keep_alive, drain_queue);
3513 
3514     // Note we cannot assert that the refs array is empty here as not all
3515     // of the processing tasks (specifically phase2 - pp2_work) execute
3516     // the complete_gc closure (which ordinarily would drain the queue) so
3517     // the queue may not be empty.
3518   }
3519 };
3520 
3521 // Driver routine for parallel reference processing.
3522 // Creates an instance of the ref processing gang
3523 // task and has the worker threads execute it.
3524 void G1STWRefProcTaskExecutor::execute(ProcessTask&amp; proc_task, uint ergo_workers) {
3525   assert(_workers != NULL, &quot;Need parallel worker threads.&quot;);
3526 
3527   assert(_workers-&gt;active_workers() &gt;= ergo_workers,
3528          &quot;Ergonomically chosen workers (%u) should be less than or equal to active workers (%u)&quot;,
3529          ergo_workers, _workers-&gt;active_workers());
3530   TaskTerminator terminator(ergo_workers, _queues);
<a name="7" id="anc7"></a><span class="line-modified">3531   G1STWRefProcTaskProxy proc_task_proxy(proc_task, _g1h, _pss, _queues, terminator.terminator());</span>
3532 
3533   _workers-&gt;run_task(&amp;proc_task_proxy, ergo_workers);
3534 }
3535 
3536 // End of weak reference support closures
3537 
3538 void G1CollectedHeap::process_discovered_references(G1ParScanThreadStateSet* per_thread_states) {
3539   double ref_proc_start = os::elapsedTime();
3540 
3541   ReferenceProcessor* rp = _ref_processor_stw;
3542   assert(rp-&gt;discovery_enabled(), &quot;should have been enabled&quot;);
3543 
3544   // Closure to test whether a referent is alive.
3545   G1STWIsAliveClosure is_alive(this);
3546 
3547   // Even when parallel reference processing is enabled, the processing
3548   // of JNI refs is serial and performed serially by the current thread
3549   // rather than by a worker. The following PSS will be used for processing
3550   // JNI refs.
3551 
3552   // Use only a single queue for this PSS.
3553   G1ParScanThreadState*          pss = per_thread_states-&gt;state_for_worker(0);
3554   pss-&gt;set_ref_discoverer(NULL);
3555   assert(pss-&gt;queue_is_empty(), &quot;pre-condition&quot;);
3556 
3557   // Keep alive closure.
3558   G1CopyingKeepAliveClosure keep_alive(this, pss);
3559 
3560   // Serial Complete GC closure
3561   G1STWDrainQueueClosure drain_queue(this, pss);
3562 
3563   // Setup the soft refs policy...
3564   rp-&gt;setup_policy(false);
3565 
3566   ReferenceProcessorPhaseTimes* pt = phase_times()-&gt;ref_phase_times();
3567 
3568   ReferenceProcessorStats stats;
3569   if (!rp-&gt;processing_is_mt()) {
3570     // Serial reference processing...
3571     stats = rp-&gt;process_discovered_references(&amp;is_alive,
3572                                               &amp;keep_alive,
3573                                               &amp;drain_queue,
3574                                               NULL,
3575                                               pt);
3576   } else {
3577     uint no_of_gc_workers = workers()-&gt;active_workers();
3578 
3579     // Parallel reference processing
3580     assert(no_of_gc_workers &lt;= rp-&gt;max_num_queues(),
3581            &quot;Mismatch between the number of GC workers %u and the maximum number of Reference process queues %u&quot;,
3582            no_of_gc_workers,  rp-&gt;max_num_queues());
3583 
3584     G1STWRefProcTaskExecutor par_task_executor(this, per_thread_states, workers(), _task_queues);
3585     stats = rp-&gt;process_discovered_references(&amp;is_alive,
3586                                               &amp;keep_alive,
3587                                               &amp;drain_queue,
3588                                               &amp;par_task_executor,
3589                                               pt);
3590   }
3591 
3592   _gc_tracer_stw-&gt;report_gc_reference_stats(stats);
3593 
3594   // We have completed copying any necessary live referent objects.
3595   assert(pss-&gt;queue_is_empty(), &quot;both queue and overflow should be empty&quot;);
3596 
3597   make_pending_list_reachable();
3598 
3599   assert(!rp-&gt;discovery_enabled(), &quot;Postcondition&quot;);
3600   rp-&gt;verify_no_references_recorded();
3601 
3602   double ref_proc_time = os::elapsedTime() - ref_proc_start;
3603   phase_times()-&gt;record_ref_proc_time(ref_proc_time * 1000.0);
3604 }
3605 
3606 void G1CollectedHeap::make_pending_list_reachable() {
3607   if (collector_state()-&gt;in_initial_mark_gc()) {
3608     oop pll_head = Universe::reference_pending_list();
3609     if (pll_head != NULL) {
3610       // Any valid worker id is fine here as we are in the VM thread and single-threaded.
3611       _cm-&gt;mark_in_next_bitmap(0 /* worker_id */, pll_head);
3612     }
3613   }
3614 }
3615 
3616 void G1CollectedHeap::merge_per_thread_state_info(G1ParScanThreadStateSet* per_thread_states) {
3617   Ticks start = Ticks::now();
3618   per_thread_states-&gt;flush();
3619   phase_times()-&gt;record_or_add_time_secs(G1GCPhaseTimes::MergePSS, 0 /* worker_id */, (Ticks::now() - start).seconds());
3620 }
3621 
3622 class G1PrepareEvacuationTask : public AbstractGangTask {
3623   class G1PrepareRegionsClosure : public HeapRegionClosure {
3624     G1CollectedHeap* _g1h;
3625     G1PrepareEvacuationTask* _parent_task;
3626     size_t _worker_humongous_total;
3627     size_t _worker_humongous_candidates;
3628 
3629     bool humongous_region_is_candidate(HeapRegion* region) const {
3630       assert(region-&gt;is_starts_humongous(), &quot;Must start a humongous object&quot;);
3631 
3632       oop obj = oop(region-&gt;bottom());
3633 
3634       // Dead objects cannot be eager reclaim candidates. Due to class
3635       // unloading it is unsafe to query their classes so we return early.
3636       if (_g1h-&gt;is_obj_dead(obj, region)) {
3637         return false;
3638       }
3639 
3640       // If we do not have a complete remembered set for the region, then we can
3641       // not be sure that we have all references to it.
3642       if (!region-&gt;rem_set()-&gt;is_complete()) {
3643         return false;
3644       }
3645       // Candidate selection must satisfy the following constraints
3646       // while concurrent marking is in progress:
3647       //
3648       // * In order to maintain SATB invariants, an object must not be
3649       // reclaimed if it was allocated before the start of marking and
3650       // has not had its references scanned.  Such an object must have
3651       // its references (including type metadata) scanned to ensure no
3652       // live objects are missed by the marking process.  Objects
3653       // allocated after the start of concurrent marking don&#39;t need to
3654       // be scanned.
3655       //
3656       // * An object must not be reclaimed if it is on the concurrent
3657       // mark stack.  Objects allocated after the start of concurrent
3658       // marking are never pushed on the mark stack.
3659       //
3660       // Nominating only objects allocated after the start of concurrent
3661       // marking is sufficient to meet both constraints.  This may miss
3662       // some objects that satisfy the constraints, but the marking data
3663       // structures don&#39;t support efficiently performing the needed
3664       // additional tests or scrubbing of the mark stack.
3665       //
3666       // However, we presently only nominate is_typeArray() objects.
3667       // A humongous object containing references induces remembered
3668       // set entries on other regions.  In order to reclaim such an
3669       // object, those remembered sets would need to be cleaned up.
3670       //
3671       // We also treat is_typeArray() objects specially, allowing them
3672       // to be reclaimed even if allocated before the start of
3673       // concurrent mark.  For this we rely on mark stack insertion to
3674       // exclude is_typeArray() objects, preventing reclaiming an object
3675       // that is in the mark stack.  We also rely on the metadata for
3676       // such objects to be built-in and so ensured to be kept live.
3677       // Frequent allocation and drop of large binary blobs is an
3678       // important use case for eager reclaim, and this special handling
3679       // may reduce needed headroom.
3680 
3681       return obj-&gt;is_typeArray() &amp;&amp;
3682              _g1h-&gt;is_potential_eager_reclaim_candidate(region);
3683     }
3684 
3685   public:
3686     G1PrepareRegionsClosure(G1CollectedHeap* g1h, G1PrepareEvacuationTask* parent_task) :
3687       _g1h(g1h),
3688       _parent_task(parent_task),
3689       _worker_humongous_total(0),
3690       _worker_humongous_candidates(0) { }
3691 
3692     ~G1PrepareRegionsClosure() {
3693       _parent_task-&gt;add_humongous_candidates(_worker_humongous_candidates);
3694       _parent_task-&gt;add_humongous_total(_worker_humongous_total);
3695     }
3696 
3697     virtual bool do_heap_region(HeapRegion* hr) {
3698       // First prepare the region for scanning
3699       _g1h-&gt;rem_set()-&gt;prepare_region_for_scan(hr);
3700 
3701       // Now check if region is a humongous candidate
3702       if (!hr-&gt;is_starts_humongous()) {
3703         _g1h-&gt;register_region_with_region_attr(hr);
3704         return false;
3705       }
3706 
3707       uint index = hr-&gt;hrm_index();
3708       if (humongous_region_is_candidate(hr)) {
3709         _g1h-&gt;set_humongous_reclaim_candidate(index, true);
3710         _g1h-&gt;register_humongous_region_with_region_attr(index);
3711         _worker_humongous_candidates++;
3712         // We will later handle the remembered sets of these regions.
3713       } else {
3714         _g1h-&gt;set_humongous_reclaim_candidate(index, false);
3715         _g1h-&gt;register_region_with_region_attr(hr);
3716       }
3717       _worker_humongous_total++;
3718 
3719       return false;
3720     }
3721   };
3722 
3723   G1CollectedHeap* _g1h;
3724   HeapRegionClaimer _claimer;
3725   volatile size_t _humongous_total;
3726   volatile size_t _humongous_candidates;
3727 public:
3728   G1PrepareEvacuationTask(G1CollectedHeap* g1h) :
3729     AbstractGangTask(&quot;Prepare Evacuation&quot;),
3730     _g1h(g1h),
3731     _claimer(_g1h-&gt;workers()-&gt;active_workers()),
3732     _humongous_total(0),
3733     _humongous_candidates(0) { }
3734 
3735   ~G1PrepareEvacuationTask() {
3736     _g1h-&gt;set_has_humongous_reclaim_candidate(_humongous_candidates &gt; 0);
3737   }
3738 
3739   void work(uint worker_id) {
3740     G1PrepareRegionsClosure cl(_g1h, this);
3741     _g1h-&gt;heap_region_par_iterate_from_worker_offset(&amp;cl, &amp;_claimer, worker_id);
3742   }
3743 
3744   void add_humongous_candidates(size_t candidates) {
3745     Atomic::add(&amp;_humongous_candidates, candidates);
3746   }
3747 
3748   void add_humongous_total(size_t total) {
3749     Atomic::add(&amp;_humongous_total, total);
3750   }
3751 
3752   size_t humongous_candidates() {
3753     return _humongous_candidates;
3754   }
3755 
3756   size_t humongous_total() {
3757     return _humongous_total;
3758   }
3759 };
3760 
3761 void G1CollectedHeap::pre_evacuate_collection_set(G1EvacuationInfo&amp; evacuation_info, G1ParScanThreadStateSet* per_thread_states) {
3762   _bytes_used_during_gc = 0;
3763 
3764   _expand_heap_after_alloc_failure = true;
3765   _evacuation_failed = false;
3766 
3767   // Disable the hot card cache.
3768   _hot_card_cache-&gt;reset_hot_cache_claimed_index();
3769   _hot_card_cache-&gt;set_use_cache(false);
3770 
3771   // Initialize the GC alloc regions.
3772   _allocator-&gt;init_gc_alloc_regions(evacuation_info);
3773 
3774   {
3775     Ticks start = Ticks::now();
3776     rem_set()-&gt;prepare_for_scan_heap_roots();
3777     phase_times()-&gt;record_prepare_heap_roots_time_ms((Ticks::now() - start).seconds() * 1000.0);
3778   }
3779 
3780   {
3781     G1PrepareEvacuationTask g1_prep_task(this);
3782     Tickspan task_time = run_task(&amp;g1_prep_task);
3783 
3784     phase_times()-&gt;record_register_regions(task_time.seconds() * 1000.0,
3785                                            g1_prep_task.humongous_total(),
3786                                            g1_prep_task.humongous_candidates());
3787   }
3788 
3789   assert(_verifier-&gt;check_region_attr_table(), &quot;Inconsistency in the region attributes table.&quot;);
3790   _preserved_marks_set.assert_empty();
3791 
3792 #if COMPILER2_OR_JVMCI
3793   DerivedPointerTable::clear();
3794 #endif
3795 
3796   // InitialMark needs claim bits to keep track of the marked-through CLDs.
3797   if (collector_state()-&gt;in_initial_mark_gc()) {
3798     concurrent_mark()-&gt;pre_initial_mark();
3799 
3800     double start_clear_claimed_marks = os::elapsedTime();
3801 
3802     ClassLoaderDataGraph::clear_claimed_marks();
3803 
3804     double recorded_clear_claimed_marks_time_ms = (os::elapsedTime() - start_clear_claimed_marks) * 1000.0;
3805     phase_times()-&gt;record_clear_claimed_marks_time_ms(recorded_clear_claimed_marks_time_ms);
3806   }
3807 
3808   // Should G1EvacuationFailureALot be in effect for this GC?
3809   NOT_PRODUCT(set_evacuation_failure_alot_for_current_gc();)
3810 }
3811 
3812 class G1EvacuateRegionsBaseTask : public AbstractGangTask {
3813 protected:
3814   G1CollectedHeap* _g1h;
3815   G1ParScanThreadStateSet* _per_thread_states;
3816   RefToScanQueueSet* _task_queues;
3817   TaskTerminator _terminator;
3818   uint _num_workers;
3819 
3820   void evacuate_live_objects(G1ParScanThreadState* pss,
3821                              uint worker_id,
3822                              G1GCPhaseTimes::GCParPhases objcopy_phase,
3823                              G1GCPhaseTimes::GCParPhases termination_phase) {
3824     G1GCPhaseTimes* p = _g1h-&gt;phase_times();
3825 
3826     Ticks start = Ticks::now();
<a name="8" id="anc8"></a><span class="line-modified">3827     G1ParEvacuateFollowersClosure cl(_g1h, pss, _task_queues, _terminator.terminator(), objcopy_phase);</span>
3828     cl.do_void();
3829 
3830     assert(pss-&gt;queue_is_empty(), &quot;should be empty&quot;);
3831 
3832     Tickspan evac_time = (Ticks::now() - start);
3833     p-&gt;record_or_add_time_secs(objcopy_phase, worker_id, evac_time.seconds() - cl.term_time());
3834 
3835     if (termination_phase == G1GCPhaseTimes::Termination) {
3836       p-&gt;record_time_secs(termination_phase, worker_id, cl.term_time());
3837       p-&gt;record_thread_work_item(termination_phase, worker_id, cl.term_attempts());
3838     } else {
3839       p-&gt;record_or_add_time_secs(termination_phase, worker_id, cl.term_time());
3840       p-&gt;record_or_add_thread_work_item(termination_phase, worker_id, cl.term_attempts());
3841     }
3842     assert(pss-&gt;trim_ticks().seconds() == 0.0, &quot;Unexpected partial trimming during evacuation&quot;);
3843   }
3844 
3845   virtual void start_work(uint worker_id) { }
3846 
3847   virtual void end_work(uint worker_id) { }
3848 
3849   virtual void scan_roots(G1ParScanThreadState* pss, uint worker_id) = 0;
3850 
3851   virtual void evacuate_live_objects(G1ParScanThreadState* pss, uint worker_id) = 0;
3852 
3853 public:
3854   G1EvacuateRegionsBaseTask(const char* name, G1ParScanThreadStateSet* per_thread_states, RefToScanQueueSet* task_queues, uint num_workers) :
3855     AbstractGangTask(name),
3856     _g1h(G1CollectedHeap::heap()),
3857     _per_thread_states(per_thread_states),
3858     _task_queues(task_queues),
3859     _terminator(num_workers, _task_queues),
3860     _num_workers(num_workers)
3861   { }
3862 
3863   void work(uint worker_id) {
3864     start_work(worker_id);
3865 
3866     {
3867       ResourceMark rm;
3868       HandleMark   hm;
3869 
3870       G1ParScanThreadState* pss = _per_thread_states-&gt;state_for_worker(worker_id);
3871       pss-&gt;set_ref_discoverer(_g1h-&gt;ref_processor_stw());
3872 
3873       scan_roots(pss, worker_id);
3874       evacuate_live_objects(pss, worker_id);
3875     }
3876 
3877     end_work(worker_id);
3878   }
3879 };
3880 
3881 class G1EvacuateRegionsTask : public G1EvacuateRegionsBaseTask {
3882   G1RootProcessor* _root_processor;
3883 
3884   void scan_roots(G1ParScanThreadState* pss, uint worker_id) {
3885     _root_processor-&gt;evacuate_roots(pss, worker_id);
3886     _g1h-&gt;rem_set()-&gt;scan_heap_roots(pss, worker_id, G1GCPhaseTimes::ScanHR, G1GCPhaseTimes::ObjCopy);
3887     _g1h-&gt;rem_set()-&gt;scan_collection_set_regions(pss, worker_id, G1GCPhaseTimes::ScanHR, G1GCPhaseTimes::CodeRoots, G1GCPhaseTimes::ObjCopy);
3888   }
3889 
3890   void evacuate_live_objects(G1ParScanThreadState* pss, uint worker_id) {
3891     G1EvacuateRegionsBaseTask::evacuate_live_objects(pss, worker_id, G1GCPhaseTimes::ObjCopy, G1GCPhaseTimes::Termination);
3892   }
3893 
3894   void start_work(uint worker_id) {
3895     _g1h-&gt;phase_times()-&gt;record_time_secs(G1GCPhaseTimes::GCWorkerStart, worker_id, Ticks::now().seconds());
3896   }
3897 
3898   void end_work(uint worker_id) {
3899     _g1h-&gt;phase_times()-&gt;record_time_secs(G1GCPhaseTimes::GCWorkerEnd, worker_id, Ticks::now().seconds());
3900   }
3901 
3902 public:
3903   G1EvacuateRegionsTask(G1CollectedHeap* g1h,
3904                         G1ParScanThreadStateSet* per_thread_states,
3905                         RefToScanQueueSet* task_queues,
3906                         G1RootProcessor* root_processor,
3907                         uint num_workers) :
3908     G1EvacuateRegionsBaseTask(&quot;G1 Evacuate Regions&quot;, per_thread_states, task_queues, num_workers),
3909     _root_processor(root_processor)
3910   { }
3911 };
3912 
3913 void G1CollectedHeap::evacuate_initial_collection_set(G1ParScanThreadStateSet* per_thread_states) {
3914   G1GCPhaseTimes* p = phase_times();
3915 
3916   {
3917     Ticks start = Ticks::now();
3918     rem_set()-&gt;merge_heap_roots(true /* initial_evacuation */);
3919     p-&gt;record_merge_heap_roots_time((Ticks::now() - start).seconds() * 1000.0);
3920   }
3921 
3922   Tickspan task_time;
3923   const uint num_workers = workers()-&gt;active_workers();
3924 
3925   Ticks start_processing = Ticks::now();
3926   {
3927     G1RootProcessor root_processor(this, num_workers);
3928     G1EvacuateRegionsTask g1_par_task(this, per_thread_states, _task_queues, &amp;root_processor, num_workers);
3929     task_time = run_task(&amp;g1_par_task);
3930     // Closing the inner scope will execute the destructor for the G1RootProcessor object.
3931     // To extract its code root fixup time we measure total time of this scope and
3932     // subtract from the time the WorkGang task took.
3933   }
3934   Tickspan total_processing = Ticks::now() - start_processing;
3935 
3936   p-&gt;record_initial_evac_time(task_time.seconds() * 1000.0);
3937   p-&gt;record_or_add_code_root_fixup_time((total_processing - task_time).seconds() * 1000.0);
3938 }
3939 
3940 class G1EvacuateOptionalRegionsTask : public G1EvacuateRegionsBaseTask {
3941 
3942   void scan_roots(G1ParScanThreadState* pss, uint worker_id) {
3943     _g1h-&gt;rem_set()-&gt;scan_heap_roots(pss, worker_id, G1GCPhaseTimes::OptScanHR, G1GCPhaseTimes::OptObjCopy);
3944     _g1h-&gt;rem_set()-&gt;scan_collection_set_regions(pss, worker_id, G1GCPhaseTimes::OptScanHR, G1GCPhaseTimes::OptCodeRoots, G1GCPhaseTimes::OptObjCopy);
3945   }
3946 
3947   void evacuate_live_objects(G1ParScanThreadState* pss, uint worker_id) {
3948     G1EvacuateRegionsBaseTask::evacuate_live_objects(pss, worker_id, G1GCPhaseTimes::OptObjCopy, G1GCPhaseTimes::OptTermination);
3949   }
3950 
3951 public:
3952   G1EvacuateOptionalRegionsTask(G1ParScanThreadStateSet* per_thread_states,
3953                                 RefToScanQueueSet* queues,
3954                                 uint num_workers) :
3955     G1EvacuateRegionsBaseTask(&quot;G1 Evacuate Optional Regions&quot;, per_thread_states, queues, num_workers) {
3956   }
3957 };
3958 
3959 void G1CollectedHeap::evacuate_next_optional_regions(G1ParScanThreadStateSet* per_thread_states) {
3960   class G1MarkScope : public MarkScope { };
3961 
3962   Tickspan task_time;
3963 
3964   Ticks start_processing = Ticks::now();
3965   {
3966     G1MarkScope code_mark_scope;
3967     G1EvacuateOptionalRegionsTask task(per_thread_states, _task_queues, workers()-&gt;active_workers());
3968     task_time = run_task(&amp;task);
3969     // See comment in evacuate_collection_set() for the reason of the scope.
3970   }
3971   Tickspan total_processing = Ticks::now() - start_processing;
3972 
3973   G1GCPhaseTimes* p = phase_times();
3974   p-&gt;record_or_add_code_root_fixup_time((total_processing - task_time).seconds() * 1000.0);
3975 }
3976 
3977 void G1CollectedHeap::evacuate_optional_collection_set(G1ParScanThreadStateSet* per_thread_states) {
3978   const double gc_start_time_ms = phase_times()-&gt;cur_collection_start_sec() * 1000.0;
3979 
3980   while (!evacuation_failed() &amp;&amp; _collection_set.optional_region_length() &gt; 0) {
3981 
3982     double time_used_ms = os::elapsedTime() * 1000.0 - gc_start_time_ms;
3983     double time_left_ms = MaxGCPauseMillis - time_used_ms;
3984 
3985     if (time_left_ms &lt; 0 ||
3986         !_collection_set.finalize_optional_for_evacuation(time_left_ms * policy()-&gt;optional_evacuation_fraction())) {
3987       log_trace(gc, ergo, cset)(&quot;Skipping evacuation of %u optional regions, no more regions can be evacuated in %.3fms&quot;,
3988                                 _collection_set.optional_region_length(), time_left_ms);
3989       break;
3990     }
3991 
3992     {
3993       Ticks start = Ticks::now();
3994       rem_set()-&gt;merge_heap_roots(false /* initial_evacuation */);
3995       phase_times()-&gt;record_or_add_optional_merge_heap_roots_time((Ticks::now() - start).seconds() * 1000.0);
3996     }
3997 
3998     {
3999       Ticks start = Ticks::now();
4000       evacuate_next_optional_regions(per_thread_states);
4001       phase_times()-&gt;record_or_add_optional_evac_time((Ticks::now() - start).seconds() * 1000.0);
4002     }
4003   }
4004 
4005   _collection_set.abandon_optional_collection_set(per_thread_states);
4006 }
4007 
4008 void G1CollectedHeap::post_evacuate_collection_set(G1EvacuationInfo&amp; evacuation_info,
4009                                                    G1RedirtyCardsQueueSet* rdcqs,
4010                                                    G1ParScanThreadStateSet* per_thread_states) {
4011   G1GCPhaseTimes* p = phase_times();
4012 
4013   rem_set()-&gt;cleanup_after_scan_heap_roots();
4014 
4015   // Process any discovered reference objects - we have
4016   // to do this _before_ we retire the GC alloc regions
4017   // as we may have to copy some &#39;reachable&#39; referent
4018   // objects (and their reachable sub-graphs) that were
4019   // not copied during the pause.
4020   process_discovered_references(per_thread_states);
4021 
4022   G1STWIsAliveClosure is_alive(this);
4023   G1KeepAliveClosure keep_alive(this);
4024 
4025   WeakProcessor::weak_oops_do(workers(), &amp;is_alive, &amp;keep_alive, p-&gt;weak_phase_times());
4026 
4027   if (G1StringDedup::is_enabled()) {
4028     double string_dedup_time_ms = os::elapsedTime();
4029 
4030     string_dedup_cleaning(&amp;is_alive, &amp;keep_alive, p);
4031 
4032     double string_cleanup_time_ms = (os::elapsedTime() - string_dedup_time_ms) * 1000.0;
4033     p-&gt;record_string_deduplication_time(string_cleanup_time_ms);
4034   }
4035 
4036   _allocator-&gt;release_gc_alloc_regions(evacuation_info);
4037 
4038   if (evacuation_failed()) {
4039     restore_after_evac_failure(rdcqs);
4040 
4041     // Reset the G1EvacuationFailureALot counters and flags
4042     NOT_PRODUCT(reset_evacuation_should_fail();)
4043 
4044     double recalculate_used_start = os::elapsedTime();
4045     set_used(recalculate_used());
4046     p-&gt;record_evac_fail_recalc_used_time((os::elapsedTime() - recalculate_used_start) * 1000.0);
4047 
4048     if (_archive_allocator != NULL) {
4049       _archive_allocator-&gt;clear_used();
4050     }
4051     for (uint i = 0; i &lt; ParallelGCThreads; i++) {
4052       if (_evacuation_failed_info_array[i].has_failed()) {
4053         _gc_tracer_stw-&gt;report_evacuation_failed(_evacuation_failed_info_array[i]);
4054       }
4055     }
4056   } else {
4057     // The &quot;used&quot; of the the collection set have already been subtracted
4058     // when they were freed.  Add in the bytes used.
4059     increase_used(_bytes_used_during_gc);
4060   }
4061 
4062   _preserved_marks_set.assert_empty();
4063 
4064   merge_per_thread_state_info(per_thread_states);
4065 
4066   // Reset and re-enable the hot card cache.
4067   // Note the counts for the cards in the regions in the
4068   // collection set are reset when the collection set is freed.
4069   _hot_card_cache-&gt;reset_hot_cache();
4070   _hot_card_cache-&gt;set_use_cache(true);
4071 
4072   purge_code_root_memory();
4073 
4074   redirty_logged_cards(rdcqs);
4075 
4076   free_collection_set(&amp;_collection_set, evacuation_info, per_thread_states-&gt;surviving_young_words());
4077 
4078   eagerly_reclaim_humongous_regions();
4079 
4080   record_obj_copy_mem_stats();
4081 
4082   evacuation_info.set_collectionset_used_before(collection_set()-&gt;bytes_used_before());
4083   evacuation_info.set_bytes_used(_bytes_used_during_gc);
4084 
4085 #if COMPILER2_OR_JVMCI
4086   double start = os::elapsedTime();
4087   DerivedPointerTable::update_pointers();
4088   phase_times()-&gt;record_derived_pointer_table_update_time((os::elapsedTime() - start) * 1000.0);
4089 #endif
4090   policy()-&gt;print_age_table();
4091 }
4092 
4093 void G1CollectedHeap::record_obj_copy_mem_stats() {
4094   policy()-&gt;add_bytes_allocated_in_old_since_last_gc(_old_evac_stats.allocated() * HeapWordSize);
4095 
4096   _gc_tracer_stw-&gt;report_evacuation_statistics(create_g1_evac_summary(&amp;_survivor_evac_stats),
4097                                                create_g1_evac_summary(&amp;_old_evac_stats));
4098 }
4099 
4100 void G1CollectedHeap::free_region(HeapRegion* hr, FreeRegionList* free_list) {
4101   assert(!hr-&gt;is_free(), &quot;the region should not be free&quot;);
4102   assert(!hr-&gt;is_empty(), &quot;the region should not be empty&quot;);
4103   assert(_hrm-&gt;is_available(hr-&gt;hrm_index()), &quot;region should be committed&quot;);
4104 
4105   if (G1VerifyBitmaps) {
4106     MemRegion mr(hr-&gt;bottom(), hr-&gt;end());
4107     concurrent_mark()-&gt;clear_range_in_prev_bitmap(mr);
4108   }
4109 
4110   // Clear the card counts for this region.
4111   // Note: we only need to do this if the region is not young
4112   // (since we don&#39;t refine cards in young regions).
4113   if (!hr-&gt;is_young()) {
4114     _hot_card_cache-&gt;reset_card_counts(hr);
4115   }
4116 
4117   // Reset region metadata to allow reuse.
4118   hr-&gt;hr_clear(true /* clear_space */);
4119   _policy-&gt;remset_tracker()-&gt;update_at_free(hr);
4120 
4121   if (free_list != NULL) {
4122     free_list-&gt;add_ordered(hr);
4123   }
4124 }
4125 
4126 void G1CollectedHeap::free_humongous_region(HeapRegion* hr,
4127                                             FreeRegionList* free_list) {
4128   assert(hr-&gt;is_humongous(), &quot;this is only for humongous regions&quot;);
4129   assert(free_list != NULL, &quot;pre-condition&quot;);
4130   hr-&gt;clear_humongous();
4131   free_region(hr, free_list);
4132 }
4133 
4134 void G1CollectedHeap::remove_from_old_sets(const uint old_regions_removed,
4135                                            const uint humongous_regions_removed) {
4136   if (old_regions_removed &gt; 0 || humongous_regions_removed &gt; 0) {
4137     MutexLocker x(OldSets_lock, Mutex::_no_safepoint_check_flag);
4138     _old_set.bulk_remove(old_regions_removed);
4139     _humongous_set.bulk_remove(humongous_regions_removed);
4140   }
4141 
4142 }
4143 
4144 void G1CollectedHeap::prepend_to_freelist(FreeRegionList* list) {
4145   assert(list != NULL, &quot;list can&#39;t be null&quot;);
4146   if (!list-&gt;is_empty()) {
4147     MutexLocker x(FreeList_lock, Mutex::_no_safepoint_check_flag);
4148     _hrm-&gt;insert_list_into_free_list(list);
4149   }
4150 }
4151 
4152 void G1CollectedHeap::decrement_summary_bytes(size_t bytes) {
4153   decrease_used(bytes);
4154 }
4155 
4156 class G1FreeCollectionSetTask : public AbstractGangTask {
4157   // Helper class to keep statistics for the collection set freeing
4158   class FreeCSetStats {
4159     size_t _before_used_bytes;   // Usage in regions successfully evacutate
4160     size_t _after_used_bytes;    // Usage in regions failing evacuation
4161     size_t _bytes_allocated_in_old_since_last_gc; // Size of young regions turned into old
4162     size_t _failure_used_words;  // Live size in failed regions
4163     size_t _failure_waste_words; // Wasted size in failed regions
4164     size_t _rs_length;           // Remembered set size
4165     uint _regions_freed;         // Number of regions freed
4166   public:
4167     FreeCSetStats() :
4168         _before_used_bytes(0),
4169         _after_used_bytes(0),
4170         _bytes_allocated_in_old_since_last_gc(0),
4171         _failure_used_words(0),
4172         _failure_waste_words(0),
4173         _rs_length(0),
4174         _regions_freed(0) { }
4175 
4176     void merge_stats(FreeCSetStats* other) {
4177       assert(other != NULL, &quot;invariant&quot;);
4178       _before_used_bytes += other-&gt;_before_used_bytes;
4179       _after_used_bytes += other-&gt;_after_used_bytes;
4180       _bytes_allocated_in_old_since_last_gc += other-&gt;_bytes_allocated_in_old_since_last_gc;
4181       _failure_used_words += other-&gt;_failure_used_words;
4182       _failure_waste_words += other-&gt;_failure_waste_words;
4183       _rs_length += other-&gt;_rs_length;
4184       _regions_freed += other-&gt;_regions_freed;
4185     }
4186 
4187     void report(G1CollectedHeap* g1h, G1EvacuationInfo* evacuation_info) {
4188       evacuation_info-&gt;set_regions_freed(_regions_freed);
4189       evacuation_info-&gt;increment_collectionset_used_after(_after_used_bytes);
4190 
4191       g1h-&gt;decrement_summary_bytes(_before_used_bytes);
4192       g1h-&gt;alloc_buffer_stats(G1HeapRegionAttr::Old)-&gt;add_failure_used_and_waste(_failure_used_words, _failure_waste_words);
4193 
4194       G1Policy *policy = g1h-&gt;policy();
4195       policy-&gt;add_bytes_allocated_in_old_since_last_gc(_bytes_allocated_in_old_since_last_gc);
4196       policy-&gt;record_rs_length(_rs_length);
4197       policy-&gt;cset_regions_freed();
4198     }
4199 
4200     void account_failed_region(HeapRegion* r) {
4201       size_t used_words = r-&gt;marked_bytes() / HeapWordSize;
4202       _failure_used_words += used_words;
4203       _failure_waste_words += HeapRegion::GrainWords - used_words;
4204       _after_used_bytes += r-&gt;used();
4205 
4206       // When moving a young gen region to old gen, we &quot;allocate&quot; that whole
4207       // region there. This is in addition to any already evacuated objects.
4208       // Notify the policy about that. Old gen regions do not cause an
4209       // additional allocation: both the objects still in the region and the
4210       // ones already moved are accounted for elsewhere.
4211       if (r-&gt;is_young()) {
4212         _bytes_allocated_in_old_since_last_gc += HeapRegion::GrainBytes;
4213       }
4214     }
4215 
4216     void account_evacuated_region(HeapRegion* r) {
4217       _before_used_bytes += r-&gt;used();
4218       _regions_freed += 1;
4219     }
4220 
4221     void account_rs_length(HeapRegion* r) {
4222       _rs_length += r-&gt;rem_set()-&gt;occupied();
4223     }
4224   };
4225 
4226   // Closure applied to all regions in the collection set.
4227   class FreeCSetClosure : public HeapRegionClosure {
4228     // Helper to send JFR events for regions.
4229     class JFREventForRegion {
4230       EventGCPhaseParallel _event;
4231     public:
4232       JFREventForRegion(HeapRegion* region, uint worker_id) : _event() {
4233         _event.set_gcId(GCId::current());
4234         _event.set_gcWorkerId(worker_id);
4235         if (region-&gt;is_young()) {
4236           _event.set_name(G1GCPhaseTimes::phase_name(G1GCPhaseTimes::YoungFreeCSet));
4237         } else {
4238           _event.set_name(G1GCPhaseTimes::phase_name(G1GCPhaseTimes::NonYoungFreeCSet));
4239         }
4240       }
4241 
4242       ~JFREventForRegion() {
4243         _event.commit();
4244       }
4245     };
4246 
4247     // Helper to do timing for region work.
4248     class TimerForRegion {
4249       Tickspan&amp; _time;
4250       Ticks     _start_time;
4251     public:
4252       TimerForRegion(Tickspan&amp; time) : _time(time), _start_time(Ticks::now()) { }
4253       ~TimerForRegion() {
4254         _time += Ticks::now() - _start_time;
4255       }
4256     };
4257 
4258     // FreeCSetClosure members
4259     G1CollectedHeap* _g1h;
4260     const size_t*    _surviving_young_words;
4261     uint             _worker_id;
4262     Tickspan         _young_time;
4263     Tickspan         _non_young_time;
4264     FreeCSetStats*   _stats;
4265 
4266     void assert_in_cset(HeapRegion* r) {
4267       assert(r-&gt;young_index_in_cset() != 0 &amp;&amp;
4268              (uint)r-&gt;young_index_in_cset() &lt;= _g1h-&gt;collection_set()-&gt;young_region_length(),
4269              &quot;Young index %u is wrong for region %u of type %s with %u young regions&quot;,
4270              r-&gt;young_index_in_cset(), r-&gt;hrm_index(), r-&gt;get_type_str(), _g1h-&gt;collection_set()-&gt;young_region_length());
4271     }
4272 
4273     void handle_evacuated_region(HeapRegion* r) {
4274       assert(!r-&gt;is_empty(), &quot;Region %u is an empty region in the collection set.&quot;, r-&gt;hrm_index());
4275       stats()-&gt;account_evacuated_region(r);
4276 
4277       // Free the region and and its remembered set.
4278       _g1h-&gt;free_region(r, NULL);
4279     }
4280 
4281     void handle_failed_region(HeapRegion* r) {
4282       // Do some allocation statistics accounting. Regions that failed evacuation
4283       // are always made old, so there is no need to update anything in the young
4284       // gen statistics, but we need to update old gen statistics.
4285       stats()-&gt;account_failed_region(r);
4286 
4287       // Update the region state due to the failed evacuation.
4288       r-&gt;handle_evacuation_failure();
4289 
4290       // Add region to old set, need to hold lock.
4291       MutexLocker x(OldSets_lock, Mutex::_no_safepoint_check_flag);
4292       _g1h-&gt;old_set_add(r);
4293     }
4294 
4295     Tickspan&amp; timer_for_region(HeapRegion* r) {
4296       return r-&gt;is_young() ? _young_time : _non_young_time;
4297     }
4298 
4299     FreeCSetStats* stats() {
4300       return _stats;
4301     }
4302   public:
4303     FreeCSetClosure(const size_t* surviving_young_words,
4304                     uint worker_id,
4305                     FreeCSetStats* stats) :
4306         HeapRegionClosure(),
4307         _g1h(G1CollectedHeap::heap()),
4308         _surviving_young_words(surviving_young_words),
4309         _worker_id(worker_id),
4310         _young_time(),
4311         _non_young_time(),
4312         _stats(stats) { }
4313 
4314     virtual bool do_heap_region(HeapRegion* r) {
4315       assert(r-&gt;in_collection_set(), &quot;Invariant: %u missing from CSet&quot;, r-&gt;hrm_index());
4316       JFREventForRegion event(r, _worker_id);
4317       TimerForRegion timer(timer_for_region(r));
4318 
4319       _g1h-&gt;clear_region_attr(r);
4320       stats()-&gt;account_rs_length(r);
4321 
4322       if (r-&gt;is_young()) {
4323         assert_in_cset(r);
4324         r-&gt;record_surv_words_in_group(_surviving_young_words[r-&gt;young_index_in_cset()]);
4325       }
4326 
4327       if (r-&gt;evacuation_failed()) {
4328         handle_failed_region(r);
4329       } else {
4330         handle_evacuated_region(r);
4331       }
4332       assert(!_g1h-&gt;is_on_master_free_list(r), &quot;sanity&quot;);
4333 
4334       return false;
4335     }
4336 
4337     void report_timing(Tickspan parallel_time) {
4338       G1GCPhaseTimes* pt = _g1h-&gt;phase_times();
4339       pt-&gt;record_time_secs(G1GCPhaseTimes::ParFreeCSet, _worker_id, parallel_time.seconds());
4340       if (_young_time.value() &gt; 0) {
4341         pt-&gt;record_time_secs(G1GCPhaseTimes::YoungFreeCSet, _worker_id, _young_time.seconds());
4342       }
4343       if (_non_young_time.value() &gt; 0) {
4344         pt-&gt;record_time_secs(G1GCPhaseTimes::NonYoungFreeCSet, _worker_id, _non_young_time.seconds());
4345       }
4346     }
4347   };
4348 
4349   // G1FreeCollectionSetTask members
4350   G1CollectedHeap*  _g1h;
4351   G1EvacuationInfo* _evacuation_info;
4352   FreeCSetStats*    _worker_stats;
4353   HeapRegionClaimer _claimer;
4354   const size_t*     _surviving_young_words;
4355   uint              _active_workers;
4356 
4357   FreeCSetStats* worker_stats(uint worker) {
4358     return &amp;_worker_stats[worker];
4359   }
4360 
4361   void report_statistics() {
4362     // Merge the accounting
4363     FreeCSetStats total_stats;
4364     for (uint worker = 0; worker &lt; _active_workers; worker++) {
4365       total_stats.merge_stats(worker_stats(worker));
4366     }
4367     total_stats.report(_g1h, _evacuation_info);
4368   }
4369 
4370 public:
4371   G1FreeCollectionSetTask(G1EvacuationInfo* evacuation_info, const size_t* surviving_young_words, uint active_workers) :
4372       AbstractGangTask(&quot;G1 Free Collection Set&quot;),
4373       _g1h(G1CollectedHeap::heap()),
4374       _evacuation_info(evacuation_info),
4375       _worker_stats(NEW_C_HEAP_ARRAY(FreeCSetStats, active_workers, mtGC)),
4376       _claimer(active_workers),
4377       _surviving_young_words(surviving_young_words),
4378       _active_workers(active_workers) {
4379     for (uint worker = 0; worker &lt; active_workers; worker++) {
4380       ::new (&amp;_worker_stats[worker]) FreeCSetStats();
4381     }
4382   }
4383 
4384   ~G1FreeCollectionSetTask() {
4385     Ticks serial_time = Ticks::now();
4386     report_statistics();
4387     for (uint worker = 0; worker &lt; _active_workers; worker++) {
4388       _worker_stats[worker].~FreeCSetStats();
4389     }
4390     FREE_C_HEAP_ARRAY(FreeCSetStats, _worker_stats);
4391     _g1h-&gt;phase_times()-&gt;record_serial_free_cset_time_ms((Ticks::now() - serial_time).seconds() * 1000.0);
4392   }
4393 
4394   virtual void work(uint worker_id) {
4395     EventGCPhaseParallel event;
4396     Ticks start = Ticks::now();
4397     FreeCSetClosure cl(_surviving_young_words, worker_id, worker_stats(worker_id));
4398     _g1h-&gt;collection_set_par_iterate_all(&amp;cl, &amp;_claimer, worker_id);
4399 
4400     // Report the total parallel time along with some more detailed metrics.
4401     cl.report_timing(Ticks::now() - start);
4402     event.commit(GCId::current(), worker_id, G1GCPhaseTimes::phase_name(G1GCPhaseTimes::ParFreeCSet));
4403   }
4404 };
4405 
4406 void G1CollectedHeap::free_collection_set(G1CollectionSet* collection_set, G1EvacuationInfo&amp; evacuation_info, const size_t* surviving_young_words) {
4407   _eden.clear();
4408 
4409   // The free collections set is split up in two tasks, the first
4410   // frees the collection set and records what regions are free,
4411   // and the second one rebuilds the free list. This proved to be
4412   // more efficient than adding a sorted list to another.
4413 
4414   Ticks free_cset_start_time = Ticks::now();
4415   {
4416     uint const num_cs_regions = _collection_set.region_length();
4417     uint const num_workers = clamp(num_cs_regions, 1u, workers()-&gt;active_workers());
4418     G1FreeCollectionSetTask cl(&amp;evacuation_info, surviving_young_words, num_workers);
4419 
4420     log_debug(gc, ergo)(&quot;Running %s using %u workers for collection set length %u (%u)&quot;,
4421                         cl.name(), num_workers, num_cs_regions, num_regions());
4422     workers()-&gt;run_task(&amp;cl, num_workers);
4423   }
4424 
4425   Ticks free_cset_end_time = Ticks::now();
4426   phase_times()-&gt;record_total_free_cset_time_ms((free_cset_end_time - free_cset_start_time).seconds() * 1000.0);
4427 
4428   // Now rebuild the free region list.
4429   hrm()-&gt;rebuild_free_list(workers());
4430   phase_times()-&gt;record_total_rebuild_freelist_time_ms((Ticks::now() - free_cset_end_time).seconds() * 1000.0);
4431 
4432   collection_set-&gt;clear();
4433 }
4434 
4435 class G1FreeHumongousRegionClosure : public HeapRegionClosure {
4436  private:
4437   FreeRegionList* _free_region_list;
4438   HeapRegionSet* _proxy_set;
4439   uint _humongous_objects_reclaimed;
4440   uint _humongous_regions_reclaimed;
4441   size_t _freed_bytes;
4442  public:
4443 
4444   G1FreeHumongousRegionClosure(FreeRegionList* free_region_list) :
4445     _free_region_list(free_region_list), _proxy_set(NULL), _humongous_objects_reclaimed(0), _humongous_regions_reclaimed(0), _freed_bytes(0) {
4446   }
4447 
4448   virtual bool do_heap_region(HeapRegion* r) {
4449     if (!r-&gt;is_starts_humongous()) {
4450       return false;
4451     }
4452 
4453     G1CollectedHeap* g1h = G1CollectedHeap::heap();
4454 
4455     oop obj = (oop)r-&gt;bottom();
4456     G1CMBitMap* next_bitmap = g1h-&gt;concurrent_mark()-&gt;next_mark_bitmap();
4457 
4458     // The following checks whether the humongous object is live are sufficient.
4459     // The main additional check (in addition to having a reference from the roots
4460     // or the young gen) is whether the humongous object has a remembered set entry.
4461     //
4462     // A humongous object cannot be live if there is no remembered set for it
4463     // because:
4464     // - there can be no references from within humongous starts regions referencing
4465     // the object because we never allocate other objects into them.
4466     // (I.e. there are no intra-region references that may be missed by the
4467     // remembered set)
4468     // - as soon there is a remembered set entry to the humongous starts region
4469     // (i.e. it has &quot;escaped&quot; to an old object) this remembered set entry will stay
4470     // until the end of a concurrent mark.
4471     //
4472     // It is not required to check whether the object has been found dead by marking
4473     // or not, in fact it would prevent reclamation within a concurrent cycle, as
4474     // all objects allocated during that time are considered live.
4475     // SATB marking is even more conservative than the remembered set.
4476     // So if at this point in the collection there is no remembered set entry,
4477     // nobody has a reference to it.
4478     // At the start of collection we flush all refinement logs, and remembered sets
4479     // are completely up-to-date wrt to references to the humongous object.
4480     //
4481     // Other implementation considerations:
4482     // - never consider object arrays at this time because they would pose
4483     // considerable effort for cleaning up the the remembered sets. This is
4484     // required because stale remembered sets might reference locations that
4485     // are currently allocated into.
4486     uint region_idx = r-&gt;hrm_index();
4487     if (!g1h-&gt;is_humongous_reclaim_candidate(region_idx) ||
4488         !r-&gt;rem_set()-&gt;is_empty()) {
4489       log_debug(gc, humongous)(&quot;Live humongous region %u object size &quot; SIZE_FORMAT &quot; start &quot; PTR_FORMAT &quot;  with remset &quot; SIZE_FORMAT &quot; code roots &quot; SIZE_FORMAT &quot; is marked %d reclaim candidate %d type array %d&quot;,
4490                                region_idx,
4491                                (size_t)obj-&gt;size() * HeapWordSize,
4492                                p2i(r-&gt;bottom()),
4493                                r-&gt;rem_set()-&gt;occupied(),
4494                                r-&gt;rem_set()-&gt;strong_code_roots_list_length(),
4495                                next_bitmap-&gt;is_marked(r-&gt;bottom()),
4496                                g1h-&gt;is_humongous_reclaim_candidate(region_idx),
4497                                obj-&gt;is_typeArray()
4498                               );
4499       return false;
4500     }
4501 
4502     guarantee(obj-&gt;is_typeArray(),
4503               &quot;Only eagerly reclaiming type arrays is supported, but the object &quot;
4504               PTR_FORMAT &quot; is not.&quot;, p2i(r-&gt;bottom()));
4505 
4506     log_debug(gc, humongous)(&quot;Dead humongous region %u object size &quot; SIZE_FORMAT &quot; start &quot; PTR_FORMAT &quot; with remset &quot; SIZE_FORMAT &quot; code roots &quot; SIZE_FORMAT &quot; is marked %d reclaim candidate %d type array %d&quot;,
4507                              region_idx,
4508                              (size_t)obj-&gt;size() * HeapWordSize,
4509                              p2i(r-&gt;bottom()),
4510                              r-&gt;rem_set()-&gt;occupied(),
4511                              r-&gt;rem_set()-&gt;strong_code_roots_list_length(),
4512                              next_bitmap-&gt;is_marked(r-&gt;bottom()),
4513                              g1h-&gt;is_humongous_reclaim_candidate(region_idx),
4514                              obj-&gt;is_typeArray()
4515                             );
4516 
4517     G1ConcurrentMark* const cm = g1h-&gt;concurrent_mark();
4518     cm-&gt;humongous_object_eagerly_reclaimed(r);
4519     assert(!cm-&gt;is_marked_in_prev_bitmap(obj) &amp;&amp; !cm-&gt;is_marked_in_next_bitmap(obj),
4520            &quot;Eagerly reclaimed humongous region %u should not be marked at all but is in prev %s next %s&quot;,
4521            region_idx,
4522            BOOL_TO_STR(cm-&gt;is_marked_in_prev_bitmap(obj)),
4523            BOOL_TO_STR(cm-&gt;is_marked_in_next_bitmap(obj)));
4524     _humongous_objects_reclaimed++;
4525     do {
4526       HeapRegion* next = g1h-&gt;next_region_in_humongous(r);
4527       _freed_bytes += r-&gt;used();
4528       r-&gt;set_containing_set(NULL);
4529       _humongous_regions_reclaimed++;
4530       g1h-&gt;free_humongous_region(r, _free_region_list);
4531       r = next;
4532     } while (r != NULL);
4533 
4534     return false;
4535   }
4536 
4537   uint humongous_objects_reclaimed() {
4538     return _humongous_objects_reclaimed;
4539   }
4540 
4541   uint humongous_regions_reclaimed() {
4542     return _humongous_regions_reclaimed;
4543   }
4544 
4545   size_t bytes_freed() const {
4546     return _freed_bytes;
4547   }
4548 };
4549 
4550 void G1CollectedHeap::eagerly_reclaim_humongous_regions() {
4551   assert_at_safepoint_on_vm_thread();
4552 
4553   if (!G1EagerReclaimHumongousObjects ||
4554       (!_has_humongous_reclaim_candidates &amp;&amp; !log_is_enabled(Debug, gc, humongous))) {
4555     phase_times()-&gt;record_fast_reclaim_humongous_time_ms(0.0, 0);
4556     return;
4557   }
4558 
4559   double start_time = os::elapsedTime();
4560 
4561   FreeRegionList local_cleanup_list(&quot;Local Humongous Cleanup List&quot;);
4562 
4563   G1FreeHumongousRegionClosure cl(&amp;local_cleanup_list);
4564   heap_region_iterate(&amp;cl);
4565 
4566   remove_from_old_sets(0, cl.humongous_regions_reclaimed());
4567 
4568   G1HRPrinter* hrp = hr_printer();
4569   if (hrp-&gt;is_active()) {
4570     FreeRegionListIterator iter(&amp;local_cleanup_list);
4571     while (iter.more_available()) {
4572       HeapRegion* hr = iter.get_next();
4573       hrp-&gt;cleanup(hr);
4574     }
4575   }
4576 
4577   prepend_to_freelist(&amp;local_cleanup_list);
4578   decrement_summary_bytes(cl.bytes_freed());
4579 
4580   phase_times()-&gt;record_fast_reclaim_humongous_time_ms((os::elapsedTime() - start_time) * 1000.0,
4581                                                        cl.humongous_objects_reclaimed());
4582 }
4583 
4584 class G1AbandonCollectionSetClosure : public HeapRegionClosure {
4585 public:
4586   virtual bool do_heap_region(HeapRegion* r) {
4587     assert(r-&gt;in_collection_set(), &quot;Region %u must have been in collection set&quot;, r-&gt;hrm_index());
4588     G1CollectedHeap::heap()-&gt;clear_region_attr(r);
4589     r-&gt;clear_young_index_in_cset();
4590     return false;
4591   }
4592 };
4593 
4594 void G1CollectedHeap::abandon_collection_set(G1CollectionSet* collection_set) {
4595   G1AbandonCollectionSetClosure cl;
4596   collection_set_iterate_all(&amp;cl);
4597 
4598   collection_set-&gt;clear();
4599   collection_set-&gt;stop_incremental_building();
4600 }
4601 
4602 bool G1CollectedHeap::is_old_gc_alloc_region(HeapRegion* hr) {
4603   return _allocator-&gt;is_retained_old_region(hr);
4604 }
4605 
4606 void G1CollectedHeap::set_region_short_lived_locked(HeapRegion* hr) {
4607   _eden.add(hr);
4608   _policy-&gt;set_region_eden(hr);
4609 }
4610 
4611 #ifdef ASSERT
4612 
4613 class NoYoungRegionsClosure: public HeapRegionClosure {
4614 private:
4615   bool _success;
4616 public:
4617   NoYoungRegionsClosure() : _success(true) { }
4618   bool do_heap_region(HeapRegion* r) {
4619     if (r-&gt;is_young()) {
4620       log_error(gc, verify)(&quot;Region [&quot; PTR_FORMAT &quot;, &quot; PTR_FORMAT &quot;) tagged as young&quot;,
4621                             p2i(r-&gt;bottom()), p2i(r-&gt;end()));
4622       _success = false;
4623     }
4624     return false;
4625   }
4626   bool success() { return _success; }
4627 };
4628 
4629 bool G1CollectedHeap::check_young_list_empty() {
4630   bool ret = (young_regions_count() == 0);
4631 
4632   NoYoungRegionsClosure closure;
4633   heap_region_iterate(&amp;closure);
4634   ret = ret &amp;&amp; closure.success();
4635 
4636   return ret;
4637 }
4638 
4639 #endif // ASSERT
4640 
4641 class TearDownRegionSetsClosure : public HeapRegionClosure {
4642   HeapRegionSet *_old_set;
4643 
4644 public:
4645   TearDownRegionSetsClosure(HeapRegionSet* old_set) : _old_set(old_set) { }
4646 
4647   bool do_heap_region(HeapRegion* r) {
4648     if (r-&gt;is_old()) {
4649       _old_set-&gt;remove(r);
4650     } else if(r-&gt;is_young()) {
4651       r-&gt;uninstall_surv_rate_group();
4652     } else {
4653       // We ignore free regions, we&#39;ll empty the free list afterwards.
4654       // We ignore humongous and archive regions, we&#39;re not tearing down these
4655       // sets.
4656       assert(r-&gt;is_archive() || r-&gt;is_free() || r-&gt;is_humongous(),
4657              &quot;it cannot be another type&quot;);
4658     }
4659     return false;
4660   }
4661 
4662   ~TearDownRegionSetsClosure() {
4663     assert(_old_set-&gt;is_empty(), &quot;post-condition&quot;);
4664   }
4665 };
4666 
4667 void G1CollectedHeap::tear_down_region_sets(bool free_list_only) {
4668   assert_at_safepoint_on_vm_thread();
4669 
4670   if (!free_list_only) {
4671     TearDownRegionSetsClosure cl(&amp;_old_set);
4672     heap_region_iterate(&amp;cl);
4673 
4674     // Note that emptying the _young_list is postponed and instead done as
4675     // the first step when rebuilding the regions sets again. The reason for
4676     // this is that during a full GC string deduplication needs to know if
4677     // a collected region was young or old when the full GC was initiated.
4678   }
4679   _hrm-&gt;remove_all_free_regions();
4680 }
4681 
4682 void G1CollectedHeap::increase_used(size_t bytes) {
4683   _summary_bytes_used += bytes;
4684 }
4685 
4686 void G1CollectedHeap::decrease_used(size_t bytes) {
4687   assert(_summary_bytes_used &gt;= bytes,
4688          &quot;invariant: _summary_bytes_used: &quot; SIZE_FORMAT &quot; should be &gt;= bytes: &quot; SIZE_FORMAT,
4689          _summary_bytes_used, bytes);
4690   _summary_bytes_used -= bytes;
4691 }
4692 
4693 void G1CollectedHeap::set_used(size_t bytes) {
4694   _summary_bytes_used = bytes;
4695 }
4696 
4697 class RebuildRegionSetsClosure : public HeapRegionClosure {
4698 private:
4699   bool _free_list_only;
4700 
4701   HeapRegionSet* _old_set;
4702   HeapRegionManager* _hrm;
4703 
4704   size_t _total_used;
4705 
4706 public:
4707   RebuildRegionSetsClosure(bool free_list_only,
4708                            HeapRegionSet* old_set,
4709                            HeapRegionManager* hrm) :
4710     _free_list_only(free_list_only),
4711     _old_set(old_set), _hrm(hrm), _total_used(0) {
4712     assert(_hrm-&gt;num_free_regions() == 0, &quot;pre-condition&quot;);
4713     if (!free_list_only) {
4714       assert(_old_set-&gt;is_empty(), &quot;pre-condition&quot;);
4715     }
4716   }
4717 
4718   bool do_heap_region(HeapRegion* r) {
4719     if (r-&gt;is_empty()) {
4720       assert(r-&gt;rem_set()-&gt;is_empty(), &quot;Empty regions should have empty remembered sets.&quot;);
4721       // Add free regions to the free list
4722       r-&gt;set_free();
4723       _hrm-&gt;insert_into_free_list(r);
4724     } else if (!_free_list_only) {
4725       assert(r-&gt;rem_set()-&gt;is_empty(), &quot;At this point remembered sets must have been cleared.&quot;);
4726 
4727       if (r-&gt;is_archive() || r-&gt;is_humongous()) {
4728         // We ignore archive and humongous regions. We left these sets unchanged.
4729       } else {
4730         assert(r-&gt;is_young() || r-&gt;is_free() || r-&gt;is_old(), &quot;invariant&quot;);
4731         // We now move all (non-humongous, non-old, non-archive) regions to old gen, and register them as such.
4732         r-&gt;move_to_old();
4733         _old_set-&gt;add(r);
4734       }
4735       _total_used += r-&gt;used();
4736     }
4737 
4738     return false;
4739   }
4740 
4741   size_t total_used() {
4742     return _total_used;
4743   }
4744 };
4745 
4746 void G1CollectedHeap::rebuild_region_sets(bool free_list_only) {
4747   assert_at_safepoint_on_vm_thread();
4748 
4749   if (!free_list_only) {
4750     _eden.clear();
4751     _survivor.clear();
4752   }
4753 
4754   RebuildRegionSetsClosure cl(free_list_only, &amp;_old_set, _hrm);
4755   heap_region_iterate(&amp;cl);
4756 
4757   if (!free_list_only) {
4758     set_used(cl.total_used());
4759     if (_archive_allocator != NULL) {
4760       _archive_allocator-&gt;clear_used();
4761     }
4762   }
4763   assert_used_and_recalculate_used_equal(this);
4764 }
4765 
4766 // Methods for the mutator alloc region
4767 
4768 HeapRegion* G1CollectedHeap::new_mutator_alloc_region(size_t word_size,
4769                                                       bool force,
4770                                                       uint node_index) {
4771   assert_heap_locked_or_at_safepoint(true /* should_be_vm_thread */);
4772   bool should_allocate = policy()-&gt;should_allocate_mutator_region();
4773   if (force || should_allocate) {
4774     HeapRegion* new_alloc_region = new_region(word_size,
4775                                               HeapRegionType::Eden,
4776                                               false /* do_expand */,
4777                                               node_index);
4778     if (new_alloc_region != NULL) {
4779       set_region_short_lived_locked(new_alloc_region);
4780       _hr_printer.alloc(new_alloc_region, !should_allocate);
4781       _verifier-&gt;check_bitmaps(&quot;Mutator Region Allocation&quot;, new_alloc_region);
4782       _policy-&gt;remset_tracker()-&gt;update_at_allocate(new_alloc_region);
4783       return new_alloc_region;
4784     }
4785   }
4786   return NULL;
4787 }
4788 
4789 void G1CollectedHeap::retire_mutator_alloc_region(HeapRegion* alloc_region,
4790                                                   size_t allocated_bytes) {
4791   assert_heap_locked_or_at_safepoint(true /* should_be_vm_thread */);
4792   assert(alloc_region-&gt;is_eden(), &quot;all mutator alloc regions should be eden&quot;);
4793 
4794   collection_set()-&gt;add_eden_region(alloc_region);
4795   increase_used(allocated_bytes);
4796   _eden.add_used_bytes(allocated_bytes);
4797   _hr_printer.retire(alloc_region);
4798 
4799   // We update the eden sizes here, when the region is retired,
4800   // instead of when it&#39;s allocated, since this is the point that its
4801   // used space has been recorded in _summary_bytes_used.
4802   g1mm()-&gt;update_eden_size();
4803 }
4804 
4805 // Methods for the GC alloc regions
4806 
4807 bool G1CollectedHeap::has_more_regions(G1HeapRegionAttr dest) {
4808   if (dest.is_old()) {
4809     return true;
4810   } else {
4811     return survivor_regions_count() &lt; policy()-&gt;max_survivor_regions();
4812   }
4813 }
4814 
4815 HeapRegion* G1CollectedHeap::new_gc_alloc_region(size_t word_size, G1HeapRegionAttr dest, uint node_index) {
4816   assert(FreeList_lock-&gt;owned_by_self(), &quot;pre-condition&quot;);
4817 
4818   if (!has_more_regions(dest)) {
4819     return NULL;
4820   }
4821 
4822   HeapRegionType type;
4823   if (dest.is_young()) {
4824     type = HeapRegionType::Survivor;
4825   } else {
4826     type = HeapRegionType::Old;
4827   }
4828 
4829   HeapRegion* new_alloc_region = new_region(word_size,
4830                                             type,
4831                                             true /* do_expand */,
4832                                             node_index);
4833 
4834   if (new_alloc_region != NULL) {
4835     if (type.is_survivor()) {
4836       new_alloc_region-&gt;set_survivor();
4837       _survivor.add(new_alloc_region);
4838       _verifier-&gt;check_bitmaps(&quot;Survivor Region Allocation&quot;, new_alloc_region);
4839     } else {
4840       new_alloc_region-&gt;set_old();
4841       _verifier-&gt;check_bitmaps(&quot;Old Region Allocation&quot;, new_alloc_region);
4842     }
4843     _policy-&gt;remset_tracker()-&gt;update_at_allocate(new_alloc_region);
4844     register_region_with_region_attr(new_alloc_region);
4845     _hr_printer.alloc(new_alloc_region);
4846     return new_alloc_region;
4847   }
4848   return NULL;
4849 }
4850 
4851 void G1CollectedHeap::retire_gc_alloc_region(HeapRegion* alloc_region,
4852                                              size_t allocated_bytes,
4853                                              G1HeapRegionAttr dest) {
4854   _bytes_used_during_gc += allocated_bytes;
4855   if (dest.is_old()) {
4856     old_set_add(alloc_region);
4857   } else {
4858     assert(dest.is_young(), &quot;Retiring alloc region should be young (%d)&quot;, dest.type());
4859     _survivor.add_used_bytes(allocated_bytes);
4860   }
4861 
4862   bool const during_im = collector_state()-&gt;in_initial_mark_gc();
4863   if (during_im &amp;&amp; allocated_bytes &gt; 0) {
4864     _cm-&gt;root_regions()-&gt;add(alloc_region-&gt;next_top_at_mark_start(), alloc_region-&gt;top());
4865   }
4866   _hr_printer.retire(alloc_region);
4867 }
4868 
4869 HeapRegion* G1CollectedHeap::alloc_highest_free_region() {
4870   bool expanded = false;
4871   uint index = _hrm-&gt;find_highest_free(&amp;expanded);
4872 
4873   if (index != G1_NO_HRM_INDEX) {
4874     if (expanded) {
4875       log_debug(gc, ergo, heap)(&quot;Attempt heap expansion (requested address range outside heap bounds). region size: &quot; SIZE_FORMAT &quot;B&quot;,
4876                                 HeapRegion::GrainWords * HeapWordSize);
4877     }
4878     _hrm-&gt;allocate_free_regions_starting_at(index, 1);
4879     return region_at(index);
4880   }
4881   return NULL;
4882 }
4883 
4884 // Optimized nmethod scanning
4885 
4886 class RegisterNMethodOopClosure: public OopClosure {
4887   G1CollectedHeap* _g1h;
4888   nmethod* _nm;
4889 
4890   template &lt;class T&gt; void do_oop_work(T* p) {
4891     T heap_oop = RawAccess&lt;&gt;::oop_load(p);
4892     if (!CompressedOops::is_null(heap_oop)) {
4893       oop obj = CompressedOops::decode_not_null(heap_oop);
4894       HeapRegion* hr = _g1h-&gt;heap_region_containing(obj);
4895       assert(!hr-&gt;is_continues_humongous(),
4896              &quot;trying to add code root &quot; PTR_FORMAT &quot; in continuation of humongous region &quot; HR_FORMAT
4897              &quot; starting at &quot; HR_FORMAT,
4898              p2i(_nm), HR_FORMAT_PARAMS(hr), HR_FORMAT_PARAMS(hr-&gt;humongous_start_region()));
4899 
4900       // HeapRegion::add_strong_code_root_locked() avoids adding duplicate entries.
4901       hr-&gt;add_strong_code_root_locked(_nm);
4902     }
4903   }
4904 
4905 public:
4906   RegisterNMethodOopClosure(G1CollectedHeap* g1h, nmethod* nm) :
4907     _g1h(g1h), _nm(nm) {}
4908 
4909   void do_oop(oop* p)       { do_oop_work(p); }
4910   void do_oop(narrowOop* p) { do_oop_work(p); }
4911 };
4912 
4913 class UnregisterNMethodOopClosure: public OopClosure {
4914   G1CollectedHeap* _g1h;
4915   nmethod* _nm;
4916 
4917   template &lt;class T&gt; void do_oop_work(T* p) {
4918     T heap_oop = RawAccess&lt;&gt;::oop_load(p);
4919     if (!CompressedOops::is_null(heap_oop)) {
4920       oop obj = CompressedOops::decode_not_null(heap_oop);
4921       HeapRegion* hr = _g1h-&gt;heap_region_containing(obj);
4922       assert(!hr-&gt;is_continues_humongous(),
4923              &quot;trying to remove code root &quot; PTR_FORMAT &quot; in continuation of humongous region &quot; HR_FORMAT
4924              &quot; starting at &quot; HR_FORMAT,
4925              p2i(_nm), HR_FORMAT_PARAMS(hr), HR_FORMAT_PARAMS(hr-&gt;humongous_start_region()));
4926 
4927       hr-&gt;remove_strong_code_root(_nm);
4928     }
4929   }
4930 
4931 public:
4932   UnregisterNMethodOopClosure(G1CollectedHeap* g1h, nmethod* nm) :
4933     _g1h(g1h), _nm(nm) {}
4934 
4935   void do_oop(oop* p)       { do_oop_work(p); }
4936   void do_oop(narrowOop* p) { do_oop_work(p); }
4937 };
4938 
4939 void G1CollectedHeap::register_nmethod(nmethod* nm) {
4940   guarantee(nm != NULL, &quot;sanity&quot;);
4941   RegisterNMethodOopClosure reg_cl(this, nm);
4942   nm-&gt;oops_do(&amp;reg_cl);
4943 }
4944 
4945 void G1CollectedHeap::unregister_nmethod(nmethod* nm) {
4946   guarantee(nm != NULL, &quot;sanity&quot;);
4947   UnregisterNMethodOopClosure reg_cl(this, nm);
4948   nm-&gt;oops_do(&amp;reg_cl, true);
4949 }
4950 
4951 void G1CollectedHeap::purge_code_root_memory() {
4952   double purge_start = os::elapsedTime();
4953   G1CodeRootSet::purge();
4954   double purge_time_ms = (os::elapsedTime() - purge_start) * 1000.0;
4955   phase_times()-&gt;record_strong_code_root_purge_time(purge_time_ms);
4956 }
4957 
4958 class RebuildStrongCodeRootClosure: public CodeBlobClosure {
4959   G1CollectedHeap* _g1h;
4960 
4961 public:
4962   RebuildStrongCodeRootClosure(G1CollectedHeap* g1h) :
4963     _g1h(g1h) {}
4964 
4965   void do_code_blob(CodeBlob* cb) {
4966     nmethod* nm = (cb != NULL) ? cb-&gt;as_nmethod_or_null() : NULL;
4967     if (nm == NULL) {
4968       return;
4969     }
4970 
4971     _g1h-&gt;register_nmethod(nm);
4972   }
4973 };
4974 
4975 void G1CollectedHeap::rebuild_strong_code_roots() {
4976   RebuildStrongCodeRootClosure blob_cl(this);
4977   CodeCache::blobs_do(&amp;blob_cl);
4978 }
4979 
4980 void G1CollectedHeap::initialize_serviceability() {
4981   _g1mm-&gt;initialize_serviceability();
4982 }
4983 
4984 MemoryUsage G1CollectedHeap::memory_usage() {
4985   return _g1mm-&gt;memory_usage();
4986 }
4987 
4988 GrowableArray&lt;GCMemoryManager*&gt; G1CollectedHeap::memory_managers() {
4989   return _g1mm-&gt;memory_managers();
4990 }
4991 
4992 GrowableArray&lt;MemoryPool*&gt; G1CollectedHeap::memory_pools() {
4993   return _g1mm-&gt;memory_pools();
4994 }
<a name="9" id="anc9"></a><b style="font-size: large; color: red">--- EOF ---</b>
















































































</pre>
<input id="eof" value="9" type="hidden" />
</body>
</html>