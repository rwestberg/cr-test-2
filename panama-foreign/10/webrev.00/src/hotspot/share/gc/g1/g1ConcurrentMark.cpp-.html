<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Old src/hotspot/share/gc/g1/g1ConcurrentMark.cpp</title>
    <link rel="stylesheet" href="../../../../../style.css" />
  </head>
  <body>
    <pre>
   1 /*
   2  * Copyright (c) 2001, 2019, Oracle and/or its affiliates. All rights reserved.
   3  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
   4  *
   5  * This code is free software; you can redistribute it and/or modify it
   6  * under the terms of the GNU General Public License version 2 only, as
   7  * published by the Free Software Foundation.
   8  *
   9  * This code is distributed in the hope that it will be useful, but WITHOUT
  10  * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  11  * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
  12  * version 2 for more details (a copy is included in the LICENSE file that
  13  * accompanied this code).
  14  *
  15  * You should have received a copy of the GNU General Public License version
  16  * 2 along with this work; if not, write to the Free Software Foundation,
  17  * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
  18  *
  19  * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
  20  * or visit www.oracle.com if you need additional information or have any
  21  * questions.
  22  *
  23  */
  24 
  25 #include &quot;precompiled.hpp&quot;
  26 #include &quot;classfile/classLoaderDataGraph.hpp&quot;
  27 #include &quot;code/codeCache.hpp&quot;
  28 #include &quot;gc/g1/g1BarrierSet.hpp&quot;
  29 #include &quot;gc/g1/g1CollectedHeap.inline.hpp&quot;
  30 #include &quot;gc/g1/g1CollectorState.hpp&quot;
  31 #include &quot;gc/g1/g1ConcurrentMark.inline.hpp&quot;
  32 #include &quot;gc/g1/g1ConcurrentMarkThread.inline.hpp&quot;
  33 #include &quot;gc/g1/g1DirtyCardQueue.hpp&quot;
  34 #include &quot;gc/g1/g1HeapVerifier.hpp&quot;
  35 #include &quot;gc/g1/g1OopClosures.inline.hpp&quot;
  36 #include &quot;gc/g1/g1Policy.hpp&quot;
  37 #include &quot;gc/g1/g1RegionMarkStatsCache.inline.hpp&quot;
  38 #include &quot;gc/g1/g1StringDedup.hpp&quot;
  39 #include &quot;gc/g1/g1ThreadLocalData.hpp&quot;
  40 #include &quot;gc/g1/g1Trace.hpp&quot;
  41 #include &quot;gc/g1/heapRegion.inline.hpp&quot;
  42 #include &quot;gc/g1/heapRegionRemSet.hpp&quot;
  43 #include &quot;gc/g1/heapRegionSet.inline.hpp&quot;
  44 #include &quot;gc/shared/gcId.hpp&quot;
  45 #include &quot;gc/shared/gcTimer.hpp&quot;
  46 #include &quot;gc/shared/gcTraceTime.inline.hpp&quot;
  47 #include &quot;gc/shared/gcVMOperations.hpp&quot;
  48 #include &quot;gc/shared/genOopClosures.inline.hpp&quot;
  49 #include &quot;gc/shared/referencePolicy.hpp&quot;
  50 #include &quot;gc/shared/strongRootsScope.hpp&quot;
  51 #include &quot;gc/shared/suspendibleThreadSet.hpp&quot;
  52 #include &quot;gc/shared/taskqueue.inline.hpp&quot;
  53 #include &quot;gc/shared/weakProcessor.inline.hpp&quot;
  54 #include &quot;gc/shared/workerPolicy.hpp&quot;
  55 #include &quot;include/jvm.h&quot;
  56 #include &quot;logging/log.hpp&quot;
  57 #include &quot;memory/allocation.hpp&quot;
  58 #include &quot;memory/iterator.hpp&quot;
  59 #include &quot;memory/resourceArea.hpp&quot;
  60 #include &quot;memory/universe.hpp&quot;
  61 #include &quot;oops/access.inline.hpp&quot;
  62 #include &quot;oops/oop.inline.hpp&quot;
  63 #include &quot;runtime/atomic.hpp&quot;
  64 #include &quot;runtime/handles.inline.hpp&quot;
  65 #include &quot;runtime/java.hpp&quot;
  66 #include &quot;runtime/orderAccess.hpp&quot;
  67 #include &quot;runtime/prefetch.inline.hpp&quot;
  68 #include &quot;services/memTracker.hpp&quot;
  69 #include &quot;utilities/align.hpp&quot;
  70 #include &quot;utilities/growableArray.hpp&quot;
  71 
  72 bool G1CMBitMapClosure::do_addr(HeapWord* const addr) {
  73   assert(addr &lt; _cm-&gt;finger(), &quot;invariant&quot;);
  74   assert(addr &gt;= _task-&gt;finger(), &quot;invariant&quot;);
  75 
  76   // We move that task&#39;s local finger along.
  77   _task-&gt;move_finger_to(addr);
  78 
  79   _task-&gt;scan_task_entry(G1TaskQueueEntry::from_oop(oop(addr)));
  80   // we only partially drain the local queue and global stack
  81   _task-&gt;drain_local_queue(true);
  82   _task-&gt;drain_global_stack(true);
  83 
  84   // if the has_aborted flag has been raised, we need to bail out of
  85   // the iteration
  86   return !_task-&gt;has_aborted();
  87 }
  88 
  89 G1CMMarkStack::G1CMMarkStack() :
  90   _max_chunk_capacity(0),
  91   _base(NULL),
  92   _chunk_capacity(0) {
  93   set_empty();
  94 }
  95 
  96 bool G1CMMarkStack::resize(size_t new_capacity) {
  97   assert(is_empty(), &quot;Only resize when stack is empty.&quot;);
  98   assert(new_capacity &lt;= _max_chunk_capacity,
  99          &quot;Trying to resize stack to &quot; SIZE_FORMAT &quot; chunks when the maximum is &quot; SIZE_FORMAT, new_capacity, _max_chunk_capacity);
 100 
 101   TaskQueueEntryChunk* new_base = MmapArrayAllocator&lt;TaskQueueEntryChunk&gt;::allocate_or_null(new_capacity, mtGC);
 102 
 103   if (new_base == NULL) {
 104     log_warning(gc)(&quot;Failed to reserve memory for new overflow mark stack with &quot; SIZE_FORMAT &quot; chunks and size &quot; SIZE_FORMAT &quot;B.&quot;, new_capacity, new_capacity * sizeof(TaskQueueEntryChunk));
 105     return false;
 106   }
 107   // Release old mapping.
 108   if (_base != NULL) {
 109     MmapArrayAllocator&lt;TaskQueueEntryChunk&gt;::free(_base, _chunk_capacity);
 110   }
 111 
 112   _base = new_base;
 113   _chunk_capacity = new_capacity;
 114   set_empty();
 115 
 116   return true;
 117 }
 118 
 119 size_t G1CMMarkStack::capacity_alignment() {
 120   return (size_t)lcm(os::vm_allocation_granularity(), sizeof(TaskQueueEntryChunk)) / sizeof(G1TaskQueueEntry);
 121 }
 122 
 123 bool G1CMMarkStack::initialize(size_t initial_capacity, size_t max_capacity) {
 124   guarantee(_max_chunk_capacity == 0, &quot;G1CMMarkStack already initialized.&quot;);
 125 
 126   size_t const TaskEntryChunkSizeInVoidStar = sizeof(TaskQueueEntryChunk) / sizeof(G1TaskQueueEntry);
 127 
 128   _max_chunk_capacity = align_up(max_capacity, capacity_alignment()) / TaskEntryChunkSizeInVoidStar;
 129   size_t initial_chunk_capacity = align_up(initial_capacity, capacity_alignment()) / TaskEntryChunkSizeInVoidStar;
 130 
 131   guarantee(initial_chunk_capacity &lt;= _max_chunk_capacity,
 132             &quot;Maximum chunk capacity &quot; SIZE_FORMAT &quot; smaller than initial capacity &quot; SIZE_FORMAT,
 133             _max_chunk_capacity,
 134             initial_chunk_capacity);
 135 
 136   log_debug(gc)(&quot;Initialize mark stack with &quot; SIZE_FORMAT &quot; chunks, maximum &quot; SIZE_FORMAT,
 137                 initial_chunk_capacity, _max_chunk_capacity);
 138 
 139   return resize(initial_chunk_capacity);
 140 }
 141 
 142 void G1CMMarkStack::expand() {
 143   if (_chunk_capacity == _max_chunk_capacity) {
 144     log_debug(gc)(&quot;Can not expand overflow mark stack further, already at maximum capacity of &quot; SIZE_FORMAT &quot; chunks.&quot;, _chunk_capacity);
 145     return;
 146   }
 147   size_t old_capacity = _chunk_capacity;
 148   // Double capacity if possible
 149   size_t new_capacity = MIN2(old_capacity * 2, _max_chunk_capacity);
 150 
 151   if (resize(new_capacity)) {
 152     log_debug(gc)(&quot;Expanded mark stack capacity from &quot; SIZE_FORMAT &quot; to &quot; SIZE_FORMAT &quot; chunks&quot;,
 153                   old_capacity, new_capacity);
 154   } else {
 155     log_warning(gc)(&quot;Failed to expand mark stack capacity from &quot; SIZE_FORMAT &quot; to &quot; SIZE_FORMAT &quot; chunks&quot;,
 156                     old_capacity, new_capacity);
 157   }
 158 }
 159 
 160 G1CMMarkStack::~G1CMMarkStack() {
 161   if (_base != NULL) {
 162     MmapArrayAllocator&lt;TaskQueueEntryChunk&gt;::free(_base, _chunk_capacity);
 163   }
 164 }
 165 
 166 void G1CMMarkStack::add_chunk_to_list(TaskQueueEntryChunk* volatile* list, TaskQueueEntryChunk* elem) {
 167   elem-&gt;next = *list;
 168   *list = elem;
 169 }
 170 
 171 void G1CMMarkStack::add_chunk_to_chunk_list(TaskQueueEntryChunk* elem) {
 172   MutexLocker x(MarkStackChunkList_lock, Mutex::_no_safepoint_check_flag);
 173   add_chunk_to_list(&amp;_chunk_list, elem);
 174   _chunks_in_chunk_list++;
 175 }
 176 
 177 void G1CMMarkStack::add_chunk_to_free_list(TaskQueueEntryChunk* elem) {
 178   MutexLocker x(MarkStackFreeList_lock, Mutex::_no_safepoint_check_flag);
 179   add_chunk_to_list(&amp;_free_list, elem);
 180 }
 181 
 182 G1CMMarkStack::TaskQueueEntryChunk* G1CMMarkStack::remove_chunk_from_list(TaskQueueEntryChunk* volatile* list) {
 183   TaskQueueEntryChunk* result = *list;
 184   if (result != NULL) {
 185     *list = (*list)-&gt;next;
 186   }
 187   return result;
 188 }
 189 
 190 G1CMMarkStack::TaskQueueEntryChunk* G1CMMarkStack::remove_chunk_from_chunk_list() {
 191   MutexLocker x(MarkStackChunkList_lock, Mutex::_no_safepoint_check_flag);
 192   TaskQueueEntryChunk* result = remove_chunk_from_list(&amp;_chunk_list);
 193   if (result != NULL) {
 194     _chunks_in_chunk_list--;
 195   }
 196   return result;
 197 }
 198 
 199 G1CMMarkStack::TaskQueueEntryChunk* G1CMMarkStack::remove_chunk_from_free_list() {
 200   MutexLocker x(MarkStackFreeList_lock, Mutex::_no_safepoint_check_flag);
 201   return remove_chunk_from_list(&amp;_free_list);
 202 }
 203 
 204 G1CMMarkStack::TaskQueueEntryChunk* G1CMMarkStack::allocate_new_chunk() {
 205   // This dirty read of _hwm is okay because we only ever increase the _hwm in parallel code.
 206   // Further this limits _hwm to a value of _chunk_capacity + #threads, avoiding
 207   // wraparound of _hwm.
 208   if (_hwm &gt;= _chunk_capacity) {
 209     return NULL;
 210   }
 211 
 212   size_t cur_idx = Atomic::fetch_and_add(&amp;_hwm, 1u);
 213   if (cur_idx &gt;= _chunk_capacity) {
 214     return NULL;
 215   }
 216 
 217   TaskQueueEntryChunk* result = ::new (&amp;_base[cur_idx]) TaskQueueEntryChunk;
 218   result-&gt;next = NULL;
 219   return result;
 220 }
 221 
 222 bool G1CMMarkStack::par_push_chunk(G1TaskQueueEntry* ptr_arr) {
 223   // Get a new chunk.
 224   TaskQueueEntryChunk* new_chunk = remove_chunk_from_free_list();
 225 
 226   if (new_chunk == NULL) {
 227     // Did not get a chunk from the free list. Allocate from backing memory.
 228     new_chunk = allocate_new_chunk();
 229 
 230     if (new_chunk == NULL) {
 231       return false;
 232     }
 233   }
 234 
 235   Copy::conjoint_memory_atomic(ptr_arr, new_chunk-&gt;data, EntriesPerChunk * sizeof(G1TaskQueueEntry));
 236 
 237   add_chunk_to_chunk_list(new_chunk);
 238 
 239   return true;
 240 }
 241 
 242 bool G1CMMarkStack::par_pop_chunk(G1TaskQueueEntry* ptr_arr) {
 243   TaskQueueEntryChunk* cur = remove_chunk_from_chunk_list();
 244 
 245   if (cur == NULL) {
 246     return false;
 247   }
 248 
 249   Copy::conjoint_memory_atomic(cur-&gt;data, ptr_arr, EntriesPerChunk * sizeof(G1TaskQueueEntry));
 250 
 251   add_chunk_to_free_list(cur);
 252   return true;
 253 }
 254 
 255 void G1CMMarkStack::set_empty() {
 256   _chunks_in_chunk_list = 0;
 257   _hwm = 0;
 258   _chunk_list = NULL;
 259   _free_list = NULL;
 260 }
 261 
 262 G1CMRootMemRegions::G1CMRootMemRegions(uint const max_regions) :
 263     _root_regions(NULL),
 264     _max_regions(max_regions),
 265     _num_root_regions(0),
 266     _claimed_root_regions(0),
 267     _scan_in_progress(false),
 268     _should_abort(false) {
 269   _root_regions = new MemRegion[_max_regions];
 270   if (_root_regions == NULL) {
 271     vm_exit_during_initialization(&quot;Could not allocate root MemRegion set.&quot;);
 272   }
 273 }
 274 
 275 G1CMRootMemRegions::~G1CMRootMemRegions() {
 276   delete[] _root_regions;
 277 }
 278 
 279 void G1CMRootMemRegions::reset() {
 280   _num_root_regions = 0;
 281 }
 282 
 283 void G1CMRootMemRegions::add(HeapWord* start, HeapWord* end) {
 284   assert_at_safepoint();
 285   size_t idx = Atomic::fetch_and_add(&amp;_num_root_regions, 1u);
 286   assert(idx &lt; _max_regions, &quot;Trying to add more root MemRegions than there is space &quot; SIZE_FORMAT, _max_regions);
 287   assert(start != NULL &amp;&amp; end != NULL &amp;&amp; start &lt;= end, &quot;Start (&quot; PTR_FORMAT &quot;) should be less or equal to &quot;
 288          &quot;end (&quot; PTR_FORMAT &quot;)&quot;, p2i(start), p2i(end));
 289   _root_regions[idx].set_start(start);
 290   _root_regions[idx].set_end(end);
 291 }
 292 
 293 void G1CMRootMemRegions::prepare_for_scan() {
 294   assert(!scan_in_progress(), &quot;pre-condition&quot;);
 295 
 296   _scan_in_progress = _num_root_regions &gt; 0;
 297 
 298   _claimed_root_regions = 0;
 299   _should_abort = false;
 300 }
 301 
 302 const MemRegion* G1CMRootMemRegions::claim_next() {
 303   if (_should_abort) {
 304     // If someone has set the should_abort flag, we return NULL to
 305     // force the caller to bail out of their loop.
 306     return NULL;
 307   }
 308 
 309   if (_claimed_root_regions &gt;= _num_root_regions) {
 310     return NULL;
 311   }
 312 
 313   size_t claimed_index = Atomic::fetch_and_add(&amp;_claimed_root_regions, 1u);
 314   if (claimed_index &lt; _num_root_regions) {
 315     return &amp;_root_regions[claimed_index];
 316   }
 317   return NULL;
 318 }
 319 
 320 uint G1CMRootMemRegions::num_root_regions() const {
 321   return (uint)_num_root_regions;
 322 }
 323 
 324 void G1CMRootMemRegions::notify_scan_done() {
 325   MutexLocker x(RootRegionScan_lock, Mutex::_no_safepoint_check_flag);
 326   _scan_in_progress = false;
 327   RootRegionScan_lock-&gt;notify_all();
 328 }
 329 
 330 void G1CMRootMemRegions::cancel_scan() {
 331   notify_scan_done();
 332 }
 333 
 334 void G1CMRootMemRegions::scan_finished() {
 335   assert(scan_in_progress(), &quot;pre-condition&quot;);
 336 
 337   if (!_should_abort) {
 338     assert(_claimed_root_regions &gt;= num_root_regions(),
 339            &quot;we should have claimed all root regions, claimed &quot; SIZE_FORMAT &quot;, length = %u&quot;,
 340            _claimed_root_regions, num_root_regions());
 341   }
 342 
 343   notify_scan_done();
 344 }
 345 
 346 bool G1CMRootMemRegions::wait_until_scan_finished() {
 347   if (!scan_in_progress()) {
 348     return false;
 349   }
 350 
 351   {
 352     MonitorLocker ml(RootRegionScan_lock, Mutex::_no_safepoint_check_flag);
 353     while (scan_in_progress()) {
 354       ml.wait();
 355     }
 356   }
 357   return true;
 358 }
 359 
 360 // Returns the maximum number of workers to be used in a concurrent
 361 // phase based on the number of GC workers being used in a STW
 362 // phase.
 363 static uint scale_concurrent_worker_threads(uint num_gc_workers) {
 364   return MAX2((num_gc_workers + 2) / 4, 1U);
 365 }
 366 
 367 G1ConcurrentMark::G1ConcurrentMark(G1CollectedHeap* g1h,
 368                                    G1RegionToSpaceMapper* prev_bitmap_storage,
 369                                    G1RegionToSpaceMapper* next_bitmap_storage) :
 370   // _cm_thread set inside the constructor
 371   _g1h(g1h),
 372   _completed_initialization(false),
 373 
 374   _mark_bitmap_1(),
 375   _mark_bitmap_2(),
 376   _prev_mark_bitmap(&amp;_mark_bitmap_1),
 377   _next_mark_bitmap(&amp;_mark_bitmap_2),
 378 
 379   _heap(_g1h-&gt;reserved_region()),
 380 
 381   _root_regions(_g1h-&gt;max_regions()),
 382 
 383   _global_mark_stack(),
 384 
 385   // _finger set in set_non_marking_state
 386 
 387   _worker_id_offset(G1DirtyCardQueueSet::num_par_ids() + G1ConcRefinementThreads),
 388   _max_num_tasks(ParallelGCThreads),
 389   // _num_active_tasks set in set_non_marking_state()
 390   // _tasks set inside the constructor
 391 
 392   _task_queues(new G1CMTaskQueueSet((int) _max_num_tasks)),
 393   _terminator((int) _max_num_tasks, _task_queues),
 394 
 395   _first_overflow_barrier_sync(),
 396   _second_overflow_barrier_sync(),
 397 
 398   _has_overflown(false),
 399   _concurrent(false),
 400   _has_aborted(false),
 401   _restart_for_overflow(false),
 402   _gc_timer_cm(new (ResourceObj::C_HEAP, mtGC) ConcurrentGCTimer()),
 403   _gc_tracer_cm(new (ResourceObj::C_HEAP, mtGC) G1OldTracer()),
 404 
 405   // _verbose_level set below
 406 
 407   _init_times(),
 408   _remark_times(),
 409   _remark_mark_times(),
 410   _remark_weak_ref_times(),
 411   _cleanup_times(),
 412   _total_cleanup_time(0.0),
 413 
 414   _accum_task_vtime(NULL),
 415 
 416   _concurrent_workers(NULL),
 417   _num_concurrent_workers(0),
 418   _max_concurrent_workers(0),
 419 
 420   _region_mark_stats(NEW_C_HEAP_ARRAY(G1RegionMarkStats, _g1h-&gt;max_regions(), mtGC)),
 421   _top_at_rebuild_starts(NEW_C_HEAP_ARRAY(HeapWord*, _g1h-&gt;max_regions(), mtGC))
 422 {
 423   _mark_bitmap_1.initialize(g1h-&gt;reserved_region(), prev_bitmap_storage);
 424   _mark_bitmap_2.initialize(g1h-&gt;reserved_region(), next_bitmap_storage);
 425 
 426   // Create &amp; start ConcurrentMark thread.
 427   _cm_thread = new G1ConcurrentMarkThread(this);
 428   if (_cm_thread-&gt;osthread() == NULL) {
 429     vm_shutdown_during_initialization(&quot;Could not create ConcurrentMarkThread&quot;);
 430   }
 431 
 432   assert(CGC_lock != NULL, &quot;CGC_lock must be initialized&quot;);
 433 
 434   if (FLAG_IS_DEFAULT(ConcGCThreads) || ConcGCThreads == 0) {
 435     // Calculate the number of concurrent worker threads by scaling
 436     // the number of parallel GC threads.
 437     uint marking_thread_num = scale_concurrent_worker_threads(ParallelGCThreads);
 438     FLAG_SET_ERGO(ConcGCThreads, marking_thread_num);
 439   }
 440 
 441   assert(ConcGCThreads &gt; 0, &quot;ConcGCThreads have been set.&quot;);
 442   if (ConcGCThreads &gt; ParallelGCThreads) {
 443     log_warning(gc)(&quot;More ConcGCThreads (%u) than ParallelGCThreads (%u).&quot;,
 444                     ConcGCThreads, ParallelGCThreads);
 445     return;
 446   }
 447 
 448   log_debug(gc)(&quot;ConcGCThreads: %u offset %u&quot;, ConcGCThreads, _worker_id_offset);
 449   log_debug(gc)(&quot;ParallelGCThreads: %u&quot;, ParallelGCThreads);
 450 
 451   _num_concurrent_workers = ConcGCThreads;
 452   _max_concurrent_workers = _num_concurrent_workers;
 453 
 454   _concurrent_workers = new WorkGang(&quot;G1 Conc&quot;, _max_concurrent_workers, false, true);
 455   _concurrent_workers-&gt;initialize_workers();
 456 
 457   if (FLAG_IS_DEFAULT(MarkStackSize)) {
 458     size_t mark_stack_size =
 459       MIN2(MarkStackSizeMax,
 460           MAX2(MarkStackSize, (size_t) (_max_concurrent_workers * TASKQUEUE_SIZE)));
 461     // Verify that the calculated value for MarkStackSize is in range.
 462     // It would be nice to use the private utility routine from Arguments.
 463     if (!(mark_stack_size &gt;= 1 &amp;&amp; mark_stack_size &lt;= MarkStackSizeMax)) {
 464       log_warning(gc)(&quot;Invalid value calculated for MarkStackSize (&quot; SIZE_FORMAT &quot;): &quot;
 465                       &quot;must be between 1 and &quot; SIZE_FORMAT,
 466                       mark_stack_size, MarkStackSizeMax);
 467       return;
 468     }
 469     FLAG_SET_ERGO(MarkStackSize, mark_stack_size);
 470   } else {
 471     // Verify MarkStackSize is in range.
 472     if (FLAG_IS_CMDLINE(MarkStackSize)) {
 473       if (FLAG_IS_DEFAULT(MarkStackSizeMax)) {
 474         if (!(MarkStackSize &gt;= 1 &amp;&amp; MarkStackSize &lt;= MarkStackSizeMax)) {
 475           log_warning(gc)(&quot;Invalid value specified for MarkStackSize (&quot; SIZE_FORMAT &quot;): &quot;
 476                           &quot;must be between 1 and &quot; SIZE_FORMAT,
 477                           MarkStackSize, MarkStackSizeMax);
 478           return;
 479         }
 480       } else if (FLAG_IS_CMDLINE(MarkStackSizeMax)) {
 481         if (!(MarkStackSize &gt;= 1 &amp;&amp; MarkStackSize &lt;= MarkStackSizeMax)) {
 482           log_warning(gc)(&quot;Invalid value specified for MarkStackSize (&quot; SIZE_FORMAT &quot;)&quot;
 483                           &quot; or for MarkStackSizeMax (&quot; SIZE_FORMAT &quot;)&quot;,
 484                           MarkStackSize, MarkStackSizeMax);
 485           return;
 486         }
 487       }
 488     }
 489   }
 490 
 491   if (!_global_mark_stack.initialize(MarkStackSize, MarkStackSizeMax)) {
 492     vm_exit_during_initialization(&quot;Failed to allocate initial concurrent mark overflow mark stack.&quot;);
 493   }
 494 
 495   _tasks = NEW_C_HEAP_ARRAY(G1CMTask*, _max_num_tasks, mtGC);
 496   _accum_task_vtime = NEW_C_HEAP_ARRAY(double, _max_num_tasks, mtGC);
 497 
 498   // so that the assertion in MarkingTaskQueue::task_queue doesn&#39;t fail
 499   _num_active_tasks = _max_num_tasks;
 500 
 501   for (uint i = 0; i &lt; _max_num_tasks; ++i) {
 502     G1CMTaskQueue* task_queue = new G1CMTaskQueue();
 503     task_queue-&gt;initialize();
 504     _task_queues-&gt;register_queue(i, task_queue);
 505 
 506     _tasks[i] = new G1CMTask(i, this, task_queue, _region_mark_stats, _g1h-&gt;max_regions());
 507 
 508     _accum_task_vtime[i] = 0.0;
 509   }
 510 
 511   reset_at_marking_complete();
 512   _completed_initialization = true;
 513 }
 514 
 515 void G1ConcurrentMark::reset() {
 516   _has_aborted = false;
 517 
 518   reset_marking_for_restart();
 519 
 520   // Reset all tasks, since different phases will use different number of active
 521   // threads. So, it&#39;s easiest to have all of them ready.
 522   for (uint i = 0; i &lt; _max_num_tasks; ++i) {
 523     _tasks[i]-&gt;reset(_next_mark_bitmap);
 524   }
 525 
 526   uint max_regions = _g1h-&gt;max_regions();
 527   for (uint i = 0; i &lt; max_regions; i++) {
 528     _top_at_rebuild_starts[i] = NULL;
 529     _region_mark_stats[i].clear();
 530   }
 531 }
 532 
 533 void G1ConcurrentMark::clear_statistics_in_region(uint region_idx) {
 534   for (uint j = 0; j &lt; _max_num_tasks; ++j) {
 535     _tasks[j]-&gt;clear_mark_stats_cache(region_idx);
 536   }
 537   _top_at_rebuild_starts[region_idx] = NULL;
 538   _region_mark_stats[region_idx].clear();
 539 }
 540 
 541 void G1ConcurrentMark::clear_statistics(HeapRegion* r) {
 542   uint const region_idx = r-&gt;hrm_index();
 543   if (r-&gt;is_humongous()) {
 544     assert(r-&gt;is_starts_humongous(), &quot;Got humongous continues region here&quot;);
 545     uint const size_in_regions = (uint)_g1h-&gt;humongous_obj_size_in_regions(oop(r-&gt;humongous_start_region()-&gt;bottom())-&gt;size());
 546     for (uint j = region_idx; j &lt; (region_idx + size_in_regions); j++) {
 547       clear_statistics_in_region(j);
 548     }
 549   } else {
 550     clear_statistics_in_region(region_idx);
 551   }
 552 }
 553 
 554 static void clear_mark_if_set(G1CMBitMap* bitmap, HeapWord* addr) {
 555   if (bitmap-&gt;is_marked(addr)) {
 556     bitmap-&gt;clear(addr);
 557   }
 558 }
 559 
 560 void G1ConcurrentMark::humongous_object_eagerly_reclaimed(HeapRegion* r) {
 561   assert_at_safepoint_on_vm_thread();
 562 
 563   // Need to clear all mark bits of the humongous object.
 564   clear_mark_if_set(_prev_mark_bitmap, r-&gt;bottom());
 565   clear_mark_if_set(_next_mark_bitmap, r-&gt;bottom());
 566 
 567   if (!_g1h-&gt;collector_state()-&gt;mark_or_rebuild_in_progress()) {
 568     return;
 569   }
 570 
 571   // Clear any statistics about the region gathered so far.
 572   clear_statistics(r);
 573 }
 574 
 575 void G1ConcurrentMark::reset_marking_for_restart() {
 576   _global_mark_stack.set_empty();
 577 
 578   // Expand the marking stack, if we have to and if we can.
 579   if (has_overflown()) {
 580     _global_mark_stack.expand();
 581 
 582     uint max_regions = _g1h-&gt;max_regions();
 583     for (uint i = 0; i &lt; max_regions; i++) {
 584       _region_mark_stats[i].clear_during_overflow();
 585     }
 586   }
 587 
 588   clear_has_overflown();
 589   _finger = _heap.start();
 590 
 591   for (uint i = 0; i &lt; _max_num_tasks; ++i) {
 592     G1CMTaskQueue* queue = _task_queues-&gt;queue(i);
 593     queue-&gt;set_empty();
 594   }
 595 }
 596 
 597 void G1ConcurrentMark::set_concurrency(uint active_tasks) {
 598   assert(active_tasks &lt;= _max_num_tasks, &quot;we should not have more&quot;);
 599 
 600   _num_active_tasks = active_tasks;
 601   // Need to update the three data structures below according to the
 602   // number of active threads for this phase.
 603   _terminator.terminator()-&gt;reset_for_reuse((int) active_tasks);
 604   _first_overflow_barrier_sync.set_n_workers((int) active_tasks);
 605   _second_overflow_barrier_sync.set_n_workers((int) active_tasks);
 606 }
 607 
 608 void G1ConcurrentMark::set_concurrency_and_phase(uint active_tasks, bool concurrent) {
 609   set_concurrency(active_tasks);
 610 
 611   _concurrent = concurrent;
 612 
 613   if (!concurrent) {
 614     // At this point we should be in a STW phase, and completed marking.
 615     assert_at_safepoint_on_vm_thread();
 616     assert(out_of_regions(),
 617            &quot;only way to get here: _finger: &quot; PTR_FORMAT &quot;, _heap_end: &quot; PTR_FORMAT,
 618            p2i(_finger), p2i(_heap.end()));
 619   }
 620 }
 621 
 622 void G1ConcurrentMark::reset_at_marking_complete() {
 623   // We set the global marking state to some default values when we&#39;re
 624   // not doing marking.
 625   reset_marking_for_restart();
 626   _num_active_tasks = 0;
 627 }
 628 
 629 G1ConcurrentMark::~G1ConcurrentMark() {
 630   FREE_C_HEAP_ARRAY(HeapWord*, _top_at_rebuild_starts);
 631   FREE_C_HEAP_ARRAY(G1RegionMarkStats, _region_mark_stats);
 632   // The G1ConcurrentMark instance is never freed.
 633   ShouldNotReachHere();
 634 }
 635 
 636 class G1ClearBitMapTask : public AbstractGangTask {
 637 public:
 638   static size_t chunk_size() { return M; }
 639 
 640 private:
 641   // Heap region closure used for clearing the given mark bitmap.
 642   class G1ClearBitmapHRClosure : public HeapRegionClosure {
 643   private:
 644     G1CMBitMap* _bitmap;
 645     G1ConcurrentMark* _cm;
 646   public:
 647     G1ClearBitmapHRClosure(G1CMBitMap* bitmap, G1ConcurrentMark* cm) : HeapRegionClosure(), _bitmap(bitmap), _cm(cm) {
 648     }
 649 
 650     virtual bool do_heap_region(HeapRegion* r) {
 651       size_t const chunk_size_in_words = G1ClearBitMapTask::chunk_size() / HeapWordSize;
 652 
 653       HeapWord* cur = r-&gt;bottom();
 654       HeapWord* const end = r-&gt;end();
 655 
 656       while (cur &lt; end) {
 657         MemRegion mr(cur, MIN2(cur + chunk_size_in_words, end));
 658         _bitmap-&gt;clear_range(mr);
 659 
 660         cur += chunk_size_in_words;
 661 
 662         // Abort iteration if after yielding the marking has been aborted.
 663         if (_cm != NULL &amp;&amp; _cm-&gt;do_yield_check() &amp;&amp; _cm-&gt;has_aborted()) {
 664           return true;
 665         }
 666         // Repeat the asserts from before the start of the closure. We will do them
 667         // as asserts here to minimize their overhead on the product. However, we
 668         // will have them as guarantees at the beginning / end of the bitmap
 669         // clearing to get some checking in the product.
 670         assert(_cm == NULL || _cm-&gt;cm_thread()-&gt;during_cycle(), &quot;invariant&quot;);
 671         assert(_cm == NULL || !G1CollectedHeap::heap()-&gt;collector_state()-&gt;mark_or_rebuild_in_progress(), &quot;invariant&quot;);
 672       }
 673       assert(cur == end, &quot;Must have completed iteration over the bitmap for region %u.&quot;, r-&gt;hrm_index());
 674 
 675       return false;
 676     }
 677   };
 678 
 679   G1ClearBitmapHRClosure _cl;
 680   HeapRegionClaimer _hr_claimer;
 681   bool _suspendible; // If the task is suspendible, workers must join the STS.
 682 
 683 public:
 684   G1ClearBitMapTask(G1CMBitMap* bitmap, G1ConcurrentMark* cm, uint n_workers, bool suspendible) :
 685     AbstractGangTask(&quot;G1 Clear Bitmap&quot;),
 686     _cl(bitmap, suspendible ? cm : NULL),
 687     _hr_claimer(n_workers),
 688     _suspendible(suspendible)
 689   { }
 690 
 691   void work(uint worker_id) {
 692     SuspendibleThreadSetJoiner sts_join(_suspendible);
 693     G1CollectedHeap::heap()-&gt;heap_region_par_iterate_from_worker_offset(&amp;_cl, &amp;_hr_claimer, worker_id);
 694   }
 695 
 696   bool is_complete() {
 697     return _cl.is_complete();
 698   }
 699 };
 700 
 701 void G1ConcurrentMark::clear_bitmap(G1CMBitMap* bitmap, WorkGang* workers, bool may_yield) {
 702   assert(may_yield || SafepointSynchronize::is_at_safepoint(), &quot;Non-yielding bitmap clear only allowed at safepoint.&quot;);
 703 
 704   size_t const num_bytes_to_clear = (HeapRegion::GrainBytes * _g1h-&gt;num_regions()) / G1CMBitMap::heap_map_factor();
 705   size_t const num_chunks = align_up(num_bytes_to_clear, G1ClearBitMapTask::chunk_size()) / G1ClearBitMapTask::chunk_size();
 706 
 707   uint const num_workers = (uint)MIN2(num_chunks, (size_t)workers-&gt;active_workers());
 708 
 709   G1ClearBitMapTask cl(bitmap, this, num_workers, may_yield);
 710 
 711   log_debug(gc, ergo)(&quot;Running %s with %u workers for &quot; SIZE_FORMAT &quot; work units.&quot;, cl.name(), num_workers, num_chunks);
 712   workers-&gt;run_task(&amp;cl, num_workers);
 713   guarantee(!may_yield || cl.is_complete(), &quot;Must have completed iteration when not yielding.&quot;);
 714 }
 715 
 716 void G1ConcurrentMark::cleanup_for_next_mark() {
 717   // Make sure that the concurrent mark thread looks to still be in
 718   // the current cycle.
 719   guarantee(cm_thread()-&gt;during_cycle(), &quot;invariant&quot;);
 720 
 721   // We are finishing up the current cycle by clearing the next
 722   // marking bitmap and getting it ready for the next cycle. During
 723   // this time no other cycle can start. So, let&#39;s make sure that this
 724   // is the case.
 725   guarantee(!_g1h-&gt;collector_state()-&gt;mark_or_rebuild_in_progress(), &quot;invariant&quot;);
 726 
 727   clear_bitmap(_next_mark_bitmap, _concurrent_workers, true);
 728 
 729   // Repeat the asserts from above.
 730   guarantee(cm_thread()-&gt;during_cycle(), &quot;invariant&quot;);
 731   guarantee(!_g1h-&gt;collector_state()-&gt;mark_or_rebuild_in_progress(), &quot;invariant&quot;);
 732 }
 733 
 734 void G1ConcurrentMark::clear_prev_bitmap(WorkGang* workers) {
 735   assert_at_safepoint_on_vm_thread();
 736   clear_bitmap(_prev_mark_bitmap, workers, false);
 737 }
 738 
 739 class NoteStartOfMarkHRClosure : public HeapRegionClosure {
 740 public:
 741   bool do_heap_region(HeapRegion* r) {
 742     r-&gt;note_start_of_marking();
 743     return false;
 744   }
 745 };
 746 
 747 void G1ConcurrentMark::pre_initial_mark() {
 748   assert_at_safepoint_on_vm_thread();
 749 
 750   // Reset marking state.
 751   reset();
 752 
 753   // For each region note start of marking.
 754   NoteStartOfMarkHRClosure startcl;
 755   _g1h-&gt;heap_region_iterate(&amp;startcl);
 756 
 757   _root_regions.reset();
 758 }
 759 
 760 
 761 void G1ConcurrentMark::post_initial_mark() {
 762   // Start Concurrent Marking weak-reference discovery.
 763   ReferenceProcessor* rp = _g1h-&gt;ref_processor_cm();
 764   // enable (&quot;weak&quot;) refs discovery
 765   rp-&gt;enable_discovery();
 766   rp-&gt;setup_policy(false); // snapshot the soft ref policy to be used in this cycle
 767 
 768   SATBMarkQueueSet&amp; satb_mq_set = G1BarrierSet::satb_mark_queue_set();
 769   // This is the start of  the marking cycle, we&#39;re expected all
 770   // threads to have SATB queues with active set to false.
 771   satb_mq_set.set_active_all_threads(true, /* new active value */
 772                                      false /* expected_active */);
 773 
 774   _root_regions.prepare_for_scan();
 775 
 776   // update_g1_committed() will be called at the end of an evac pause
 777   // when marking is on. So, it&#39;s also called at the end of the
 778   // initial-mark pause to update the heap end, if the heap expands
 779   // during it. No need to call it here.
 780 }
 781 
 782 /*
 783  * Notice that in the next two methods, we actually leave the STS
 784  * during the barrier sync and join it immediately afterwards. If we
 785  * do not do this, the following deadlock can occur: one thread could
 786  * be in the barrier sync code, waiting for the other thread to also
 787  * sync up, whereas another one could be trying to yield, while also
 788  * waiting for the other threads to sync up too.
 789  *
 790  * Note, however, that this code is also used during remark and in
 791  * this case we should not attempt to leave / enter the STS, otherwise
 792  * we&#39;ll either hit an assert (debug / fastdebug) or deadlock
 793  * (product). So we should only leave / enter the STS if we are
 794  * operating concurrently.
 795  *
 796  * Because the thread that does the sync barrier has left the STS, it
 797  * is possible to be suspended for a Full GC or an evacuation pause
 798  * could occur. This is actually safe, since the entering the sync
 799  * barrier is one of the last things do_marking_step() does, and it
 800  * doesn&#39;t manipulate any data structures afterwards.
 801  */
 802 
 803 void G1ConcurrentMark::enter_first_sync_barrier(uint worker_id) {
 804   bool barrier_aborted;
 805   {
 806     SuspendibleThreadSetLeaver sts_leave(concurrent());
 807     barrier_aborted = !_first_overflow_barrier_sync.enter();
 808   }
 809 
 810   // at this point everyone should have synced up and not be doing any
 811   // more work
 812 
 813   if (barrier_aborted) {
 814     // If the barrier aborted we ignore the overflow condition and
 815     // just abort the whole marking phase as quickly as possible.
 816     return;
 817   }
 818 }
 819 
 820 void G1ConcurrentMark::enter_second_sync_barrier(uint worker_id) {
 821   SuspendibleThreadSetLeaver sts_leave(concurrent());
 822   _second_overflow_barrier_sync.enter();
 823 
 824   // at this point everything should be re-initialized and ready to go
 825 }
 826 
 827 class G1CMConcurrentMarkingTask : public AbstractGangTask {
 828   G1ConcurrentMark*     _cm;
 829 
 830 public:
 831   void work(uint worker_id) {
 832     assert(Thread::current()-&gt;is_ConcurrentGC_thread(), &quot;Not a concurrent GC thread&quot;);
 833     ResourceMark rm;
 834 
 835     double start_vtime = os::elapsedVTime();
 836 
 837     {
 838       SuspendibleThreadSetJoiner sts_join;
 839 
 840       assert(worker_id &lt; _cm-&gt;active_tasks(), &quot;invariant&quot;);
 841 
 842       G1CMTask* task = _cm-&gt;task(worker_id);
 843       task-&gt;record_start_time();
 844       if (!_cm-&gt;has_aborted()) {
 845         do {
 846           task-&gt;do_marking_step(G1ConcMarkStepDurationMillis,
 847                                 true  /* do_termination */,
 848                                 false /* is_serial*/);
 849 
 850           _cm-&gt;do_yield_check();
 851         } while (!_cm-&gt;has_aborted() &amp;&amp; task-&gt;has_aborted());
 852       }
 853       task-&gt;record_end_time();
 854       guarantee(!task-&gt;has_aborted() || _cm-&gt;has_aborted(), &quot;invariant&quot;);
 855     }
 856 
 857     double end_vtime = os::elapsedVTime();
 858     _cm-&gt;update_accum_task_vtime(worker_id, end_vtime - start_vtime);
 859   }
 860 
 861   G1CMConcurrentMarkingTask(G1ConcurrentMark* cm) :
 862       AbstractGangTask(&quot;Concurrent Mark&quot;), _cm(cm) { }
 863 
 864   ~G1CMConcurrentMarkingTask() { }
 865 };
 866 
 867 uint G1ConcurrentMark::calc_active_marking_workers() {
 868   uint result = 0;
 869   if (!UseDynamicNumberOfGCThreads ||
 870       (!FLAG_IS_DEFAULT(ConcGCThreads) &amp;&amp;
 871        !ForceDynamicNumberOfGCThreads)) {
 872     result = _max_concurrent_workers;
 873   } else {
 874     result =
 875       WorkerPolicy::calc_default_active_workers(_max_concurrent_workers,
 876                                                 1, /* Minimum workers */
 877                                                 _num_concurrent_workers,
 878                                                 Threads::number_of_non_daemon_threads());
 879     // Don&#39;t scale the result down by scale_concurrent_workers() because
 880     // that scaling has already gone into &quot;_max_concurrent_workers&quot;.
 881   }
 882   assert(result &gt; 0 &amp;&amp; result &lt;= _max_concurrent_workers,
 883          &quot;Calculated number of marking workers must be larger than zero and at most the maximum %u, but is %u&quot;,
 884          _max_concurrent_workers, result);
 885   return result;
 886 }
 887 
 888 void G1ConcurrentMark::scan_root_region(const MemRegion* region, uint worker_id) {
 889 #ifdef ASSERT
 890   HeapWord* last = region-&gt;last();
 891   HeapRegion* hr = _g1h-&gt;heap_region_containing(last);
 892   assert(hr-&gt;is_old() || hr-&gt;next_top_at_mark_start() == hr-&gt;bottom(),
 893          &quot;Root regions must be old or survivor/eden but region %u is %s&quot;, hr-&gt;hrm_index(), hr-&gt;get_type_str());
 894   assert(hr-&gt;next_top_at_mark_start() == region-&gt;start(),
 895          &quot;MemRegion start should be equal to nTAMS&quot;);
 896 #endif
 897 
 898   G1RootRegionScanClosure cl(_g1h, this, worker_id);
 899 
 900   const uintx interval = PrefetchScanIntervalInBytes;
 901   HeapWord* curr = region-&gt;start();
 902   const HeapWord* end = region-&gt;end();
 903   while (curr &lt; end) {
 904     Prefetch::read(curr, interval);
 905     oop obj = oop(curr);
 906     int size = obj-&gt;oop_iterate_size(&amp;cl);
 907     assert(size == obj-&gt;size(), &quot;sanity&quot;);
 908     curr += size;
 909   }
 910 }
 911 
 912 class G1CMRootRegionScanTask : public AbstractGangTask {
 913   G1ConcurrentMark* _cm;
 914 public:
 915   G1CMRootRegionScanTask(G1ConcurrentMark* cm) :
 916     AbstractGangTask(&quot;G1 Root Region Scan&quot;), _cm(cm) { }
 917 
 918   void work(uint worker_id) {
 919     assert(Thread::current()-&gt;is_ConcurrentGC_thread(),
 920            &quot;this should only be done by a conc GC thread&quot;);
 921 
 922     G1CMRootMemRegions* root_regions = _cm-&gt;root_regions();
 923     const MemRegion* region = root_regions-&gt;claim_next();
 924     while (region != NULL) {
 925       _cm-&gt;scan_root_region(region, worker_id);
 926       region = root_regions-&gt;claim_next();
 927     }
 928   }
 929 };
 930 
 931 void G1ConcurrentMark::scan_root_regions() {
 932   // scan_in_progress() will have been set to true only if there was
 933   // at least one root region to scan. So, if it&#39;s false, we
 934   // should not attempt to do any further work.
 935   if (root_regions()-&gt;scan_in_progress()) {
 936     assert(!has_aborted(), &quot;Aborting before root region scanning is finished not supported.&quot;);
 937 
 938     _num_concurrent_workers = MIN2(calc_active_marking_workers(),
 939                                    // We distribute work on a per-region basis, so starting
 940                                    // more threads than that is useless.
 941                                    root_regions()-&gt;num_root_regions());
 942     assert(_num_concurrent_workers &lt;= _max_concurrent_workers,
 943            &quot;Maximum number of marking threads exceeded&quot;);
 944 
 945     G1CMRootRegionScanTask task(this);
 946     log_debug(gc, ergo)(&quot;Running %s using %u workers for %u work units.&quot;,
 947                         task.name(), _num_concurrent_workers, root_regions()-&gt;num_root_regions());
 948     _concurrent_workers-&gt;run_task(&amp;task, _num_concurrent_workers);
 949 
 950     // It&#39;s possible that has_aborted() is true here without actually
 951     // aborting the survivor scan earlier. This is OK as it&#39;s
 952     // mainly used for sanity checking.
 953     root_regions()-&gt;scan_finished();
 954   }
 955 }
 956 
 957 void G1ConcurrentMark::concurrent_cycle_start() {
 958   _gc_timer_cm-&gt;register_gc_start();
 959 
 960   _gc_tracer_cm-&gt;report_gc_start(GCCause::_no_gc /* first parameter is not used */, _gc_timer_cm-&gt;gc_start());
 961 
 962   _g1h-&gt;trace_heap_before_gc(_gc_tracer_cm);
 963 }
 964 
 965 void G1ConcurrentMark::concurrent_cycle_end() {
 966   _g1h-&gt;collector_state()-&gt;set_clearing_next_bitmap(false);
 967 
 968   _g1h-&gt;trace_heap_after_gc(_gc_tracer_cm);
 969 
 970   if (has_aborted()) {
 971     log_info(gc, marking)(&quot;Concurrent Mark Abort&quot;);
 972     _gc_tracer_cm-&gt;report_concurrent_mode_failure();
 973   }
 974 
 975   _gc_timer_cm-&gt;register_gc_end();
 976 
 977   _gc_tracer_cm-&gt;report_gc_end(_gc_timer_cm-&gt;gc_end(), _gc_timer_cm-&gt;time_partitions());
 978 }
 979 
 980 void G1ConcurrentMark::mark_from_roots() {
 981   _restart_for_overflow = false;
 982 
 983   _num_concurrent_workers = calc_active_marking_workers();
 984 
 985   uint active_workers = MAX2(1U, _num_concurrent_workers);
 986 
 987   // Setting active workers is not guaranteed since fewer
 988   // worker threads may currently exist and more may not be
 989   // available.
 990   active_workers = _concurrent_workers-&gt;update_active_workers(active_workers);
 991   log_info(gc, task)(&quot;Using %u workers of %u for marking&quot;, active_workers, _concurrent_workers-&gt;total_workers());
 992 
 993   // Parallel task terminator is set in &quot;set_concurrency_and_phase()&quot;
 994   set_concurrency_and_phase(active_workers, true /* concurrent */);
 995 
 996   G1CMConcurrentMarkingTask marking_task(this);
 997   _concurrent_workers-&gt;run_task(&amp;marking_task);
 998   print_stats();
 999 }
1000 
1001 void G1ConcurrentMark::verify_during_pause(G1HeapVerifier::G1VerifyType type, VerifyOption vo, const char* caller) {
1002   G1HeapVerifier* verifier = _g1h-&gt;verifier();
1003 
1004   verifier-&gt;verify_region_sets_optional();
1005 
1006   if (VerifyDuringGC) {
1007     GCTraceTime(Debug, gc, phases) debug(caller, _gc_timer_cm);
1008 
1009     size_t const BufLen = 512;
1010     char buffer[BufLen];
1011 
1012     jio_snprintf(buffer, BufLen, &quot;During GC (%s)&quot;, caller);
1013     verifier-&gt;verify(type, vo, buffer);
1014   }
1015 
1016   verifier-&gt;check_bitmaps(caller);
1017 }
1018 
1019 class G1UpdateRemSetTrackingBeforeRebuildTask : public AbstractGangTask {
1020   G1CollectedHeap* _g1h;
1021   G1ConcurrentMark* _cm;
1022   HeapRegionClaimer _hrclaimer;
1023   uint volatile _total_selected_for_rebuild;
1024 
1025   G1PrintRegionLivenessInfoClosure _cl;
1026 
1027   class G1UpdateRemSetTrackingBeforeRebuild : public HeapRegionClosure {
1028     G1CollectedHeap* _g1h;
1029     G1ConcurrentMark* _cm;
1030 
1031     G1PrintRegionLivenessInfoClosure* _cl;
1032 
1033     uint _num_regions_selected_for_rebuild;  // The number of regions actually selected for rebuild.
1034 
1035     void update_remset_before_rebuild(HeapRegion* hr) {
1036       G1RemSetTrackingPolicy* tracking_policy = _g1h-&gt;policy()-&gt;remset_tracker();
1037 
1038       bool selected_for_rebuild;
1039       if (hr-&gt;is_humongous()) {
1040         bool const is_live = _cm-&gt;liveness(hr-&gt;humongous_start_region()-&gt;hrm_index()) &gt; 0;
1041         selected_for_rebuild = tracking_policy-&gt;update_humongous_before_rebuild(hr, is_live);
1042       } else {
1043         size_t const live_bytes = _cm-&gt;liveness(hr-&gt;hrm_index());
1044         selected_for_rebuild = tracking_policy-&gt;update_before_rebuild(hr, live_bytes);
1045       }
1046       if (selected_for_rebuild) {
1047         _num_regions_selected_for_rebuild++;
1048       }
1049       _cm-&gt;update_top_at_rebuild_start(hr);
1050     }
1051 
1052     // Distribute the given words across the humongous object starting with hr and
1053     // note end of marking.
1054     void distribute_marked_bytes(HeapRegion* hr, size_t marked_words) {
1055       uint const region_idx = hr-&gt;hrm_index();
1056       size_t const obj_size_in_words = (size_t)oop(hr-&gt;bottom())-&gt;size();
1057       uint const num_regions_in_humongous = (uint)G1CollectedHeap::humongous_obj_size_in_regions(obj_size_in_words);
1058 
1059       // &quot;Distributing&quot; zero words means that we only note end of marking for these
1060       // regions.
1061       assert(marked_words == 0 || obj_size_in_words == marked_words,
1062              &quot;Marked words should either be 0 or the same as humongous object (&quot; SIZE_FORMAT &quot;) but is &quot; SIZE_FORMAT,
1063              obj_size_in_words, marked_words);
1064 
1065       for (uint i = region_idx; i &lt; (region_idx + num_regions_in_humongous); i++) {
1066         HeapRegion* const r = _g1h-&gt;region_at(i);
1067         size_t const words_to_add = MIN2(HeapRegion::GrainWords, marked_words);
1068 
1069         log_trace(gc, marking)(&quot;Adding &quot; SIZE_FORMAT &quot; words to humongous region %u (%s)&quot;,
1070                                words_to_add, i, r-&gt;get_type_str());
1071         add_marked_bytes_and_note_end(r, words_to_add * HeapWordSize);
1072         marked_words -= words_to_add;
1073       }
1074       assert(marked_words == 0,
1075              SIZE_FORMAT &quot; words left after distributing space across %u regions&quot;,
1076              marked_words, num_regions_in_humongous);
1077     }
1078 
1079     void update_marked_bytes(HeapRegion* hr) {
1080       uint const region_idx = hr-&gt;hrm_index();
1081       size_t const marked_words = _cm-&gt;liveness(region_idx);
1082       // The marking attributes the object&#39;s size completely to the humongous starts
1083       // region. We need to distribute this value across the entire set of regions a
1084       // humongous object spans.
1085       if (hr-&gt;is_humongous()) {
1086         assert(hr-&gt;is_starts_humongous() || marked_words == 0,
1087                &quot;Should not have marked words &quot; SIZE_FORMAT &quot; in non-starts humongous region %u (%s)&quot;,
1088                marked_words, region_idx, hr-&gt;get_type_str());
1089         if (hr-&gt;is_starts_humongous()) {
1090           distribute_marked_bytes(hr, marked_words);
1091         }
1092       } else {
1093         log_trace(gc, marking)(&quot;Adding &quot; SIZE_FORMAT &quot; words to region %u (%s)&quot;, marked_words, region_idx, hr-&gt;get_type_str());
1094         add_marked_bytes_and_note_end(hr, marked_words * HeapWordSize);
1095       }
1096     }
1097 
1098     void add_marked_bytes_and_note_end(HeapRegion* hr, size_t marked_bytes) {
1099       hr-&gt;add_to_marked_bytes(marked_bytes);
1100       _cl-&gt;do_heap_region(hr);
1101       hr-&gt;note_end_of_marking();
1102     }
1103 
1104   public:
1105     G1UpdateRemSetTrackingBeforeRebuild(G1CollectedHeap* g1h, G1ConcurrentMark* cm, G1PrintRegionLivenessInfoClosure* cl) :
1106       _g1h(g1h), _cm(cm), _cl(cl), _num_regions_selected_for_rebuild(0) { }
1107 
1108     virtual bool do_heap_region(HeapRegion* r) {
1109       update_remset_before_rebuild(r);
1110       update_marked_bytes(r);
1111 
1112       return false;
1113     }
1114 
1115     uint num_selected_for_rebuild() const { return _num_regions_selected_for_rebuild; }
1116   };
1117 
1118 public:
1119   G1UpdateRemSetTrackingBeforeRebuildTask(G1CollectedHeap* g1h, G1ConcurrentMark* cm, uint num_workers) :
1120     AbstractGangTask(&quot;G1 Update RemSet Tracking Before Rebuild&quot;),
1121     _g1h(g1h), _cm(cm), _hrclaimer(num_workers), _total_selected_for_rebuild(0), _cl(&quot;Post-Marking&quot;) { }
1122 
1123   virtual void work(uint worker_id) {
1124     G1UpdateRemSetTrackingBeforeRebuild update_cl(_g1h, _cm, &amp;_cl);
1125     _g1h-&gt;heap_region_par_iterate_from_worker_offset(&amp;update_cl, &amp;_hrclaimer, worker_id);
1126     Atomic::add(&amp;_total_selected_for_rebuild, update_cl.num_selected_for_rebuild());
1127   }
1128 
1129   uint total_selected_for_rebuild() const { return _total_selected_for_rebuild; }
1130 
1131   // Number of regions for which roughly one thread should be spawned for this work.
1132   static const uint RegionsPerThread = 384;
1133 };
1134 
1135 class G1UpdateRemSetTrackingAfterRebuild : public HeapRegionClosure {
1136   G1CollectedHeap* _g1h;
1137 public:
1138   G1UpdateRemSetTrackingAfterRebuild(G1CollectedHeap* g1h) : _g1h(g1h) { }
1139 
1140   virtual bool do_heap_region(HeapRegion* r) {
1141     _g1h-&gt;policy()-&gt;remset_tracker()-&gt;update_after_rebuild(r);
1142     return false;
1143   }
1144 };
1145 
1146 void G1ConcurrentMark::remark() {
1147   assert_at_safepoint_on_vm_thread();
1148 
1149   // If a full collection has happened, we should not continue. However we might
1150   // have ended up here as the Remark VM operation has been scheduled already.
1151   if (has_aborted()) {
1152     return;
1153   }
1154 
1155   G1Policy* policy = _g1h-&gt;policy();
1156   policy-&gt;record_concurrent_mark_remark_start();
1157 
1158   double start = os::elapsedTime();
1159 
1160   verify_during_pause(G1HeapVerifier::G1VerifyRemark, VerifyOption_G1UsePrevMarking, &quot;Remark before&quot;);
1161 
1162   {
1163     GCTraceTime(Debug, gc, phases) debug(&quot;Finalize Marking&quot;, _gc_timer_cm);
1164     finalize_marking();
1165   }
1166 
1167   double mark_work_end = os::elapsedTime();
1168 
1169   bool const mark_finished = !has_overflown();
1170   if (mark_finished) {
1171     weak_refs_work(false /* clear_all_soft_refs */);
1172 
1173     SATBMarkQueueSet&amp; satb_mq_set = G1BarrierSet::satb_mark_queue_set();
1174     // We&#39;re done with marking.
1175     // This is the end of the marking cycle, we&#39;re expected all
1176     // threads to have SATB queues with active set to true.
1177     satb_mq_set.set_active_all_threads(false, /* new active value */
1178                                        true /* expected_active */);
1179 
1180     {
1181       GCTraceTime(Debug, gc, phases) debug(&quot;Flush Task Caches&quot;, _gc_timer_cm);
1182       flush_all_task_caches();
1183     }
1184 
1185     // Install newly created mark bitmap as &quot;prev&quot;.
1186     swap_mark_bitmaps();
1187     {
1188       GCTraceTime(Debug, gc, phases) debug(&quot;Update Remembered Set Tracking Before Rebuild&quot;, _gc_timer_cm);
1189 
1190       uint const workers_by_capacity = (_g1h-&gt;num_regions() + G1UpdateRemSetTrackingBeforeRebuildTask::RegionsPerThread - 1) /
1191                                        G1UpdateRemSetTrackingBeforeRebuildTask::RegionsPerThread;
1192       uint const num_workers = MIN2(_g1h-&gt;workers()-&gt;active_workers(), workers_by_capacity);
1193 
1194       G1UpdateRemSetTrackingBeforeRebuildTask cl(_g1h, this, num_workers);
1195       log_debug(gc,ergo)(&quot;Running %s using %u workers for %u regions in heap&quot;, cl.name(), num_workers, _g1h-&gt;num_regions());
1196       _g1h-&gt;workers()-&gt;run_task(&amp;cl, num_workers);
1197 
1198       log_debug(gc, remset, tracking)(&quot;Remembered Set Tracking update regions total %u, selected %u&quot;,
1199                                       _g1h-&gt;num_regions(), cl.total_selected_for_rebuild());
1200     }
1201     {
1202       GCTraceTime(Debug, gc, phases) debug(&quot;Reclaim Empty Regions&quot;, _gc_timer_cm);
1203       reclaim_empty_regions();
1204     }
1205 
1206     // Clean out dead classes
1207     if (ClassUnloadingWithConcurrentMark) {
1208       GCTraceTime(Debug, gc, phases) debug(&quot;Purge Metaspace&quot;, _gc_timer_cm);
1209       ClassLoaderDataGraph::purge();
1210     }
1211 
1212     _g1h-&gt;resize_heap_if_necessary();
1213 
1214     compute_new_sizes();
1215 
1216     verify_during_pause(G1HeapVerifier::G1VerifyRemark, VerifyOption_G1UsePrevMarking, &quot;Remark after&quot;);
1217 
1218     assert(!restart_for_overflow(), &quot;sanity&quot;);
1219     // Completely reset the marking state since marking completed
1220     reset_at_marking_complete();
1221   } else {
1222     // We overflowed.  Restart concurrent marking.
1223     _restart_for_overflow = true;
1224 
1225     verify_during_pause(G1HeapVerifier::G1VerifyRemark, VerifyOption_G1UsePrevMarking, &quot;Remark overflow&quot;);
1226 
1227     // Clear the marking state because we will be restarting
1228     // marking due to overflowing the global mark stack.
1229     reset_marking_for_restart();
1230   }
1231 
1232   {
1233     GCTraceTime(Debug, gc, phases) debug(&quot;Report Object Count&quot;, _gc_timer_cm);
1234     report_object_count(mark_finished);
1235   }
1236 
1237   // Statistics
1238   double now = os::elapsedTime();
1239   _remark_mark_times.add((mark_work_end - start) * 1000.0);
1240   _remark_weak_ref_times.add((now - mark_work_end) * 1000.0);
1241   _remark_times.add((now - start) * 1000.0);
1242 
1243   policy-&gt;record_concurrent_mark_remark_end();
1244 }
1245 
1246 class G1ReclaimEmptyRegionsTask : public AbstractGangTask {
1247   // Per-region work during the Cleanup pause.
1248   class G1ReclaimEmptyRegionsClosure : public HeapRegionClosure {
1249     G1CollectedHeap* _g1h;
1250     size_t _freed_bytes;
1251     FreeRegionList* _local_cleanup_list;
1252     uint _old_regions_removed;
1253     uint _humongous_regions_removed;
1254 
1255   public:
1256     G1ReclaimEmptyRegionsClosure(G1CollectedHeap* g1h,
1257                                  FreeRegionList* local_cleanup_list) :
1258       _g1h(g1h),
1259       _freed_bytes(0),
1260       _local_cleanup_list(local_cleanup_list),
1261       _old_regions_removed(0),
1262       _humongous_regions_removed(0) { }
1263 
1264     size_t freed_bytes() { return _freed_bytes; }
1265     const uint old_regions_removed() { return _old_regions_removed; }
1266     const uint humongous_regions_removed() { return _humongous_regions_removed; }
1267 
1268     bool do_heap_region(HeapRegion *hr) {
1269       if (hr-&gt;used() &gt; 0 &amp;&amp; hr-&gt;max_live_bytes() == 0 &amp;&amp; !hr-&gt;is_young() &amp;&amp; !hr-&gt;is_archive()) {
1270         _freed_bytes += hr-&gt;used();
1271         hr-&gt;set_containing_set(NULL);
1272         if (hr-&gt;is_humongous()) {
1273           _humongous_regions_removed++;
1274           _g1h-&gt;free_humongous_region(hr, _local_cleanup_list);
1275         } else {
1276           _old_regions_removed++;
1277           _g1h-&gt;free_region(hr, _local_cleanup_list);
1278         }
1279         hr-&gt;clear_cardtable();
1280         _g1h-&gt;concurrent_mark()-&gt;clear_statistics_in_region(hr-&gt;hrm_index());
1281         log_trace(gc)(&quot;Reclaimed empty region %u (%s) bot &quot; PTR_FORMAT, hr-&gt;hrm_index(), hr-&gt;get_short_type_str(), p2i(hr-&gt;bottom()));
1282       }
1283 
1284       return false;
1285     }
1286   };
1287 
1288   G1CollectedHeap* _g1h;
1289   FreeRegionList* _cleanup_list;
1290   HeapRegionClaimer _hrclaimer;
1291 
1292 public:
1293   G1ReclaimEmptyRegionsTask(G1CollectedHeap* g1h, FreeRegionList* cleanup_list, uint n_workers) :
1294     AbstractGangTask(&quot;G1 Cleanup&quot;),
1295     _g1h(g1h),
1296     _cleanup_list(cleanup_list),
1297     _hrclaimer(n_workers) {
1298   }
1299 
1300   void work(uint worker_id) {
1301     FreeRegionList local_cleanup_list(&quot;Local Cleanup List&quot;);
1302     G1ReclaimEmptyRegionsClosure cl(_g1h, &amp;local_cleanup_list);
1303     _g1h-&gt;heap_region_par_iterate_from_worker_offset(&amp;cl, &amp;_hrclaimer, worker_id);
1304     assert(cl.is_complete(), &quot;Shouldn&#39;t have aborted!&quot;);
1305 
1306     // Now update the old/humongous region sets
1307     _g1h-&gt;remove_from_old_sets(cl.old_regions_removed(), cl.humongous_regions_removed());
1308     {
1309       MutexLocker x(ParGCRareEvent_lock, Mutex::_no_safepoint_check_flag);
1310       _g1h-&gt;decrement_summary_bytes(cl.freed_bytes());
1311 
1312       _cleanup_list-&gt;add_ordered(&amp;local_cleanup_list);
1313       assert(local_cleanup_list.is_empty(), &quot;post-condition&quot;);
1314     }
1315   }
1316 };
1317 
1318 void G1ConcurrentMark::reclaim_empty_regions() {
1319   WorkGang* workers = _g1h-&gt;workers();
1320   FreeRegionList empty_regions_list(&quot;Empty Regions After Mark List&quot;);
1321 
1322   G1ReclaimEmptyRegionsTask cl(_g1h, &amp;empty_regions_list, workers-&gt;active_workers());
1323   workers-&gt;run_task(&amp;cl);
1324 
1325   if (!empty_regions_list.is_empty()) {
1326     log_debug(gc)(&quot;Reclaimed %u empty regions&quot;, empty_regions_list.length());
1327     // Now print the empty regions list.
1328     G1HRPrinter* hrp = _g1h-&gt;hr_printer();
1329     if (hrp-&gt;is_active()) {
1330       FreeRegionListIterator iter(&amp;empty_regions_list);
1331       while (iter.more_available()) {
1332         HeapRegion* hr = iter.get_next();
1333         hrp-&gt;cleanup(hr);
1334       }
1335     }
1336     // And actually make them available.
1337     _g1h-&gt;prepend_to_freelist(&amp;empty_regions_list);
1338   }
1339 }
1340 
1341 void G1ConcurrentMark::compute_new_sizes() {
1342   MetaspaceGC::compute_new_size();
1343 
1344   // Cleanup will have freed any regions completely full of garbage.
1345   // Update the soft reference policy with the new heap occupancy.
1346   Universe::update_heap_info_at_gc();
1347 
1348   // We reclaimed old regions so we should calculate the sizes to make
1349   // sure we update the old gen/space data.
1350   _g1h-&gt;g1mm()-&gt;update_sizes();
1351 }
1352 
1353 void G1ConcurrentMark::cleanup() {
1354   assert_at_safepoint_on_vm_thread();
1355 
1356   // If a full collection has happened, we shouldn&#39;t do this.
1357   if (has_aborted()) {
1358     return;
1359   }
1360 
1361   G1Policy* policy = _g1h-&gt;policy();
1362   policy-&gt;record_concurrent_mark_cleanup_start();
1363 
1364   double start = os::elapsedTime();
1365 
1366   verify_during_pause(G1HeapVerifier::G1VerifyCleanup, VerifyOption_G1UsePrevMarking, &quot;Cleanup before&quot;);
1367 
1368   {
1369     GCTraceTime(Debug, gc, phases) debug(&quot;Update Remembered Set Tracking After Rebuild&quot;, _gc_timer_cm);
1370     G1UpdateRemSetTrackingAfterRebuild cl(_g1h);
1371     _g1h-&gt;heap_region_iterate(&amp;cl);
1372   }
1373 
1374   if (log_is_enabled(Trace, gc, liveness)) {
1375     G1PrintRegionLivenessInfoClosure cl(&quot;Post-Cleanup&quot;);
1376     _g1h-&gt;heap_region_iterate(&amp;cl);
1377   }
1378 
1379   verify_during_pause(G1HeapVerifier::G1VerifyCleanup, VerifyOption_G1UsePrevMarking, &quot;Cleanup after&quot;);
1380 
1381   // We need to make this be a &quot;collection&quot; so any collection pause that
1382   // races with it goes around and waits for Cleanup to finish.
1383   _g1h-&gt;increment_total_collections();
1384 
1385   // Local statistics
1386   double recent_cleanup_time = (os::elapsedTime() - start);
1387   _total_cleanup_time += recent_cleanup_time;
1388   _cleanup_times.add(recent_cleanup_time);
1389 
1390   {
1391     GCTraceTime(Debug, gc, phases) debug(&quot;Finalize Concurrent Mark Cleanup&quot;, _gc_timer_cm);
1392     policy-&gt;record_concurrent_mark_cleanup_end();
1393   }
1394 }
1395 
1396 // &#39;Keep Alive&#39; oop closure used by both serial parallel reference processing.
1397 // Uses the G1CMTask associated with a worker thread (for serial reference
1398 // processing the G1CMTask for worker 0 is used) to preserve (mark) and
1399 // trace referent objects.
1400 //
1401 // Using the G1CMTask and embedded local queues avoids having the worker
1402 // threads operating on the global mark stack. This reduces the risk
1403 // of overflowing the stack - which we would rather avoid at this late
1404 // state. Also using the tasks&#39; local queues removes the potential
1405 // of the workers interfering with each other that could occur if
1406 // operating on the global stack.
1407 
1408 class G1CMKeepAliveAndDrainClosure : public OopClosure {
1409   G1ConcurrentMark* _cm;
1410   G1CMTask*         _task;
1411   uint              _ref_counter_limit;
1412   uint              _ref_counter;
1413   bool              _is_serial;
1414 public:
1415   G1CMKeepAliveAndDrainClosure(G1ConcurrentMark* cm, G1CMTask* task, bool is_serial) :
1416     _cm(cm), _task(task), _ref_counter_limit(G1RefProcDrainInterval),
1417     _ref_counter(_ref_counter_limit), _is_serial(is_serial) {
1418     assert(!_is_serial || _task-&gt;worker_id() == 0, &quot;only task 0 for serial code&quot;);
1419   }
1420 
1421   virtual void do_oop(narrowOop* p) { do_oop_work(p); }
1422   virtual void do_oop(      oop* p) { do_oop_work(p); }
1423 
1424   template &lt;class T&gt; void do_oop_work(T* p) {
1425     if (_cm-&gt;has_overflown()) {
1426       return;
1427     }
1428     if (!_task-&gt;deal_with_reference(p)) {
1429       // We did not add anything to the mark bitmap (or mark stack), so there is
1430       // no point trying to drain it.
1431       return;
1432     }
1433     _ref_counter--;
1434 
1435     if (_ref_counter == 0) {
1436       // We have dealt with _ref_counter_limit references, pushing them
1437       // and objects reachable from them on to the local stack (and
1438       // possibly the global stack). Call G1CMTask::do_marking_step() to
1439       // process these entries.
1440       //
1441       // We call G1CMTask::do_marking_step() in a loop, which we&#39;ll exit if
1442       // there&#39;s nothing more to do (i.e. we&#39;re done with the entries that
1443       // were pushed as a result of the G1CMTask::deal_with_reference() calls
1444       // above) or we overflow.
1445       //
1446       // Note: G1CMTask::do_marking_step() can set the G1CMTask::has_aborted()
1447       // flag while there may still be some work to do. (See the comment at
1448       // the beginning of G1CMTask::do_marking_step() for those conditions -
1449       // one of which is reaching the specified time target.) It is only
1450       // when G1CMTask::do_marking_step() returns without setting the
1451       // has_aborted() flag that the marking step has completed.
1452       do {
1453         double mark_step_duration_ms = G1ConcMarkStepDurationMillis;
1454         _task-&gt;do_marking_step(mark_step_duration_ms,
1455                                false      /* do_termination */,
1456                                _is_serial);
1457       } while (_task-&gt;has_aborted() &amp;&amp; !_cm-&gt;has_overflown());
1458       _ref_counter = _ref_counter_limit;
1459     }
1460   }
1461 };
1462 
1463 // &#39;Drain&#39; oop closure used by both serial and parallel reference processing.
1464 // Uses the G1CMTask associated with a given worker thread (for serial
1465 // reference processing the G1CMtask for worker 0 is used). Calls the
1466 // do_marking_step routine, with an unbelievably large timeout value,
1467 // to drain the marking data structures of the remaining entries
1468 // added by the &#39;keep alive&#39; oop closure above.
1469 
1470 class G1CMDrainMarkingStackClosure : public VoidClosure {
1471   G1ConcurrentMark* _cm;
1472   G1CMTask*         _task;
1473   bool              _is_serial;
1474  public:
1475   G1CMDrainMarkingStackClosure(G1ConcurrentMark* cm, G1CMTask* task, bool is_serial) :
1476     _cm(cm), _task(task), _is_serial(is_serial) {
1477     assert(!_is_serial || _task-&gt;worker_id() == 0, &quot;only task 0 for serial code&quot;);
1478   }
1479 
1480   void do_void() {
1481     do {
1482       // We call G1CMTask::do_marking_step() to completely drain the local
1483       // and global marking stacks of entries pushed by the &#39;keep alive&#39;
1484       // oop closure (an instance of G1CMKeepAliveAndDrainClosure above).
1485       //
1486       // G1CMTask::do_marking_step() is called in a loop, which we&#39;ll exit
1487       // if there&#39;s nothing more to do (i.e. we&#39;ve completely drained the
1488       // entries that were pushed as a a result of applying the &#39;keep alive&#39;
1489       // closure to the entries on the discovered ref lists) or we overflow
1490       // the global marking stack.
1491       //
1492       // Note: G1CMTask::do_marking_step() can set the G1CMTask::has_aborted()
1493       // flag while there may still be some work to do. (See the comment at
1494       // the beginning of G1CMTask::do_marking_step() for those conditions -
1495       // one of which is reaching the specified time target.) It is only
1496       // when G1CMTask::do_marking_step() returns without setting the
1497       // has_aborted() flag that the marking step has completed.
1498 
1499       _task-&gt;do_marking_step(1000000000.0 /* something very large */,
1500                              true         /* do_termination */,
1501                              _is_serial);
1502     } while (_task-&gt;has_aborted() &amp;&amp; !_cm-&gt;has_overflown());
1503   }
1504 };
1505 
1506 // Implementation of AbstractRefProcTaskExecutor for parallel
1507 // reference processing at the end of G1 concurrent marking
1508 
1509 class G1CMRefProcTaskExecutor : public AbstractRefProcTaskExecutor {
1510 private:
1511   G1CollectedHeap*  _g1h;
1512   G1ConcurrentMark* _cm;
1513   WorkGang*         _workers;
1514   uint              _active_workers;
1515 
1516 public:
1517   G1CMRefProcTaskExecutor(G1CollectedHeap* g1h,
1518                           G1ConcurrentMark* cm,
1519                           WorkGang* workers,
1520                           uint n_workers) :
1521     _g1h(g1h), _cm(cm),
1522     _workers(workers), _active_workers(n_workers) { }
1523 
1524   virtual void execute(ProcessTask&amp; task, uint ergo_workers);
1525 };
1526 
1527 class G1CMRefProcTaskProxy : public AbstractGangTask {
1528   typedef AbstractRefProcTaskExecutor::ProcessTask ProcessTask;
1529   ProcessTask&amp;      _proc_task;
1530   G1CollectedHeap*  _g1h;
1531   G1ConcurrentMark* _cm;
1532 
1533 public:
1534   G1CMRefProcTaskProxy(ProcessTask&amp; proc_task,
1535                        G1CollectedHeap* g1h,
1536                        G1ConcurrentMark* cm) :
1537     AbstractGangTask(&quot;Process reference objects in parallel&quot;),
1538     _proc_task(proc_task), _g1h(g1h), _cm(cm) {
1539     ReferenceProcessor* rp = _g1h-&gt;ref_processor_cm();
1540     assert(rp-&gt;processing_is_mt(), &quot;shouldn&#39;t be here otherwise&quot;);
1541   }
1542 
1543   virtual void work(uint worker_id) {
1544     ResourceMark rm;
1545     HandleMark hm;
1546     G1CMTask* task = _cm-&gt;task(worker_id);
1547     G1CMIsAliveClosure g1_is_alive(_g1h);
1548     G1CMKeepAliveAndDrainClosure g1_par_keep_alive(_cm, task, false /* is_serial */);
1549     G1CMDrainMarkingStackClosure g1_par_drain(_cm, task, false /* is_serial */);
1550 
1551     _proc_task.work(worker_id, g1_is_alive, g1_par_keep_alive, g1_par_drain);
1552   }
1553 };
1554 
1555 void G1CMRefProcTaskExecutor::execute(ProcessTask&amp; proc_task, uint ergo_workers) {
1556   assert(_workers != NULL, &quot;Need parallel worker threads.&quot;);
1557   assert(_g1h-&gt;ref_processor_cm()-&gt;processing_is_mt(), &quot;processing is not MT&quot;);
1558   assert(_workers-&gt;active_workers() &gt;= ergo_workers,
1559          &quot;Ergonomically chosen workers(%u) should be less than or equal to active workers(%u)&quot;,
1560          ergo_workers, _workers-&gt;active_workers());
1561 
1562   G1CMRefProcTaskProxy proc_task_proxy(proc_task, _g1h, _cm);
1563 
1564   // We need to reset the concurrency level before each
1565   // proxy task execution, so that the termination protocol
1566   // and overflow handling in G1CMTask::do_marking_step() knows
1567   // how many workers to wait for.
1568   _cm-&gt;set_concurrency(ergo_workers);
1569   _workers-&gt;run_task(&amp;proc_task_proxy, ergo_workers);
1570 }
1571 
1572 void G1ConcurrentMark::weak_refs_work(bool clear_all_soft_refs) {
1573   ResourceMark rm;
1574   HandleMark   hm;
1575 
1576   // Is alive closure.
1577   G1CMIsAliveClosure g1_is_alive(_g1h);
1578 
1579   // Inner scope to exclude the cleaning of the string table
1580   // from the displayed time.
1581   {
1582     GCTraceTime(Debug, gc, phases) debug(&quot;Reference Processing&quot;, _gc_timer_cm);
1583 
1584     ReferenceProcessor* rp = _g1h-&gt;ref_processor_cm();
1585 
1586     // See the comment in G1CollectedHeap::ref_processing_init()
1587     // about how reference processing currently works in G1.
1588 
1589     // Set the soft reference policy
1590     rp-&gt;setup_policy(clear_all_soft_refs);
1591     assert(_global_mark_stack.is_empty(), &quot;mark stack should be empty&quot;);
1592 
1593     // Instances of the &#39;Keep Alive&#39; and &#39;Complete GC&#39; closures used
1594     // in serial reference processing. Note these closures are also
1595     // used for serially processing (by the the current thread) the
1596     // JNI references during parallel reference processing.
1597     //
1598     // These closures do not need to synchronize with the worker
1599     // threads involved in parallel reference processing as these
1600     // instances are executed serially by the current thread (e.g.
1601     // reference processing is not multi-threaded and is thus
1602     // performed by the current thread instead of a gang worker).
1603     //
1604     // The gang tasks involved in parallel reference processing create
1605     // their own instances of these closures, which do their own
1606     // synchronization among themselves.
1607     G1CMKeepAliveAndDrainClosure g1_keep_alive(this, task(0), true /* is_serial */);
1608     G1CMDrainMarkingStackClosure g1_drain_mark_stack(this, task(0), true /* is_serial */);
1609 
1610     // We need at least one active thread. If reference processing
1611     // is not multi-threaded we use the current (VMThread) thread,
1612     // otherwise we use the work gang from the G1CollectedHeap and
1613     // we utilize all the worker threads we can.
1614     bool processing_is_mt = rp-&gt;processing_is_mt();
1615     uint active_workers = (processing_is_mt ? _g1h-&gt;workers()-&gt;active_workers() : 1U);
1616     active_workers = clamp(active_workers, 1u, _max_num_tasks);
1617 
1618     // Parallel processing task executor.
1619     G1CMRefProcTaskExecutor par_task_executor(_g1h, this,
1620                                               _g1h-&gt;workers(), active_workers);
1621     AbstractRefProcTaskExecutor* executor = (processing_is_mt ? &amp;par_task_executor : NULL);
1622 
1623     // Set the concurrency level. The phase was already set prior to
1624     // executing the remark task.
1625     set_concurrency(active_workers);
1626 
1627     // Set the degree of MT processing here.  If the discovery was done MT,
1628     // the number of threads involved during discovery could differ from
1629     // the number of active workers.  This is OK as long as the discovered
1630     // Reference lists are balanced (see balance_all_queues() and balance_queues()).
1631     rp-&gt;set_active_mt_degree(active_workers);
1632 
1633     ReferenceProcessorPhaseTimes pt(_gc_timer_cm, rp-&gt;max_num_queues());
1634 
1635     // Process the weak references.
1636     const ReferenceProcessorStats&amp; stats =
1637         rp-&gt;process_discovered_references(&amp;g1_is_alive,
1638                                           &amp;g1_keep_alive,
1639                                           &amp;g1_drain_mark_stack,
1640                                           executor,
1641                                           &amp;pt);
1642     _gc_tracer_cm-&gt;report_gc_reference_stats(stats);
1643     pt.print_all_references();
1644 
1645     // The do_oop work routines of the keep_alive and drain_marking_stack
1646     // oop closures will set the has_overflown flag if we overflow the
1647     // global marking stack.
1648 
1649     assert(has_overflown() || _global_mark_stack.is_empty(),
1650            &quot;Mark stack should be empty (unless it has overflown)&quot;);
1651 
1652     assert(rp-&gt;num_queues() == active_workers, &quot;why not&quot;);
1653 
1654     rp-&gt;verify_no_references_recorded();
1655     assert(!rp-&gt;discovery_enabled(), &quot;Post condition&quot;);
1656   }
1657 
1658   if (has_overflown()) {
1659     // We can not trust g1_is_alive and the contents of the heap if the marking stack
1660     // overflowed while processing references. Exit the VM.
1661     fatal(&quot;Overflow during reference processing, can not continue. Please &quot;
1662           &quot;increase MarkStackSizeMax (current value: &quot; SIZE_FORMAT &quot;) and &quot;
1663           &quot;restart.&quot;, MarkStackSizeMax);
1664     return;
1665   }
1666 
1667   assert(_global_mark_stack.is_empty(), &quot;Marking should have completed&quot;);
1668 
1669   {
1670     GCTraceTime(Debug, gc, phases) debug(&quot;Weak Processing&quot;, _gc_timer_cm);
1671     WeakProcessor::weak_oops_do(_g1h-&gt;workers(), &amp;g1_is_alive, &amp;do_nothing_cl, 1);
1672   }
1673 
1674   // Unload Klasses, String, Code Cache, etc.
1675   if (ClassUnloadingWithConcurrentMark) {
1676     GCTraceTime(Debug, gc, phases) debug(&quot;Class Unloading&quot;, _gc_timer_cm);
1677     bool purged_classes = SystemDictionary::do_unloading(_gc_timer_cm);
1678     _g1h-&gt;complete_cleaning(&amp;g1_is_alive, purged_classes);
1679   } else if (StringDedup::is_enabled()) {
1680     GCTraceTime(Debug, gc, phases) debug(&quot;String Deduplication&quot;, _gc_timer_cm);
1681     _g1h-&gt;string_dedup_cleaning(&amp;g1_is_alive, NULL);
1682   }
1683 }
1684 
1685 class G1PrecleanYieldClosure : public YieldClosure {
1686   G1ConcurrentMark* _cm;
1687 
1688 public:
1689   G1PrecleanYieldClosure(G1ConcurrentMark* cm) : _cm(cm) { }
1690 
1691   virtual bool should_return() {
1692     return _cm-&gt;has_aborted();
1693   }
1694 
1695   virtual bool should_return_fine_grain() {
1696     _cm-&gt;do_yield_check();
1697     return _cm-&gt;has_aborted();
1698   }
1699 };
1700 
1701 void G1ConcurrentMark::preclean() {
1702   assert(G1UseReferencePrecleaning, &quot;Precleaning must be enabled.&quot;);
1703 
1704   SuspendibleThreadSetJoiner joiner;
1705 
1706   G1CMKeepAliveAndDrainClosure keep_alive(this, task(0), true /* is_serial */);
1707   G1CMDrainMarkingStackClosure drain_mark_stack(this, task(0), true /* is_serial */);
1708 
1709   set_concurrency_and_phase(1, true);
1710 
1711   G1PrecleanYieldClosure yield_cl(this);
1712 
1713   ReferenceProcessor* rp = _g1h-&gt;ref_processor_cm();
1714   // Precleaning is single threaded. Temporarily disable MT discovery.
1715   ReferenceProcessorMTDiscoveryMutator rp_mut_discovery(rp, false);
1716   rp-&gt;preclean_discovered_references(rp-&gt;is_alive_non_header(),
1717                                      &amp;keep_alive,
1718                                      &amp;drain_mark_stack,
1719                                      &amp;yield_cl,
1720                                      _gc_timer_cm);
1721 }
1722 
1723 // When sampling object counts, we already swapped the mark bitmaps, so we need to use
1724 // the prev bitmap determining liveness.
1725 class G1ObjectCountIsAliveClosure: public BoolObjectClosure {
1726   G1CollectedHeap* _g1h;
1727 public:
1728   G1ObjectCountIsAliveClosure(G1CollectedHeap* g1h) : _g1h(g1h) { }
1729 
1730   bool do_object_b(oop obj) {
1731     return obj != NULL &amp;&amp;
1732            (!_g1h-&gt;is_in_g1_reserved(obj) || !_g1h-&gt;is_obj_dead(obj));
1733   }
1734 };
1735 
1736 void G1ConcurrentMark::report_object_count(bool mark_completed) {
1737   // Depending on the completion of the marking liveness needs to be determined
1738   // using either the next or prev bitmap.
1739   if (mark_completed) {
1740     G1ObjectCountIsAliveClosure is_alive(_g1h);
1741     _gc_tracer_cm-&gt;report_object_count_after_gc(&amp;is_alive);
1742   } else {
1743     G1CMIsAliveClosure is_alive(_g1h);
1744     _gc_tracer_cm-&gt;report_object_count_after_gc(&amp;is_alive);
1745   }
1746 }
1747 
1748 
1749 void G1ConcurrentMark::swap_mark_bitmaps() {
1750   G1CMBitMap* temp = _prev_mark_bitmap;
1751   _prev_mark_bitmap = _next_mark_bitmap;
1752   _next_mark_bitmap = temp;
1753   _g1h-&gt;collector_state()-&gt;set_clearing_next_bitmap(true);
1754 }
1755 
1756 // Closure for marking entries in SATB buffers.
1757 class G1CMSATBBufferClosure : public SATBBufferClosure {
1758 private:
1759   G1CMTask* _task;
1760   G1CollectedHeap* _g1h;
1761 
1762   // This is very similar to G1CMTask::deal_with_reference, but with
1763   // more relaxed requirements for the argument, so this must be more
1764   // circumspect about treating the argument as an object.
1765   void do_entry(void* entry) const {
1766     _task-&gt;increment_refs_reached();
1767     oop const obj = static_cast&lt;oop&gt;(entry);
1768     _task-&gt;make_reference_grey(obj);
1769   }
1770 
1771 public:
1772   G1CMSATBBufferClosure(G1CMTask* task, G1CollectedHeap* g1h)
1773     : _task(task), _g1h(g1h) { }
1774 
1775   virtual void do_buffer(void** buffer, size_t size) {
1776     for (size_t i = 0; i &lt; size; ++i) {
1777       do_entry(buffer[i]);
1778     }
1779   }
1780 };
1781 
1782 class G1RemarkThreadsClosure : public ThreadClosure {
1783   G1CMSATBBufferClosure _cm_satb_cl;
1784   G1CMOopClosure _cm_cl;
1785   MarkingCodeBlobClosure _code_cl;
1786   uintx _claim_token;
1787 
1788  public:
1789   G1RemarkThreadsClosure(G1CollectedHeap* g1h, G1CMTask* task) :
1790     _cm_satb_cl(task, g1h),
1791     _cm_cl(g1h, task),
1792     _code_cl(&amp;_cm_cl, !CodeBlobToOopClosure::FixRelocations),
1793     _claim_token(Threads::thread_claim_token()) {}
1794 
1795   void do_thread(Thread* thread) {
1796     if (thread-&gt;claim_threads_do(true, _claim_token)) {
1797       SATBMarkQueue&amp; queue = G1ThreadLocalData::satb_mark_queue(thread);
1798       queue.apply_closure_and_empty(&amp;_cm_satb_cl);
1799       if (thread-&gt;is_Java_thread()) {
1800         // In theory it should not be neccessary to explicitly walk the nmethods to find roots for concurrent marking
1801         // however the liveness of oops reachable from nmethods have very complex lifecycles:
1802         // * Alive if on the stack of an executing method
1803         // * Weakly reachable otherwise
1804         // Some objects reachable from nmethods, such as the class loader (or klass_holder) of the receiver should be
1805         // live by the SATB invariant but other oops recorded in nmethods may behave differently.
1806         JavaThread* jt = (JavaThread*)thread;
1807         jt-&gt;nmethods_do(&amp;_code_cl);
1808       }
1809     }
1810   }
1811 };
1812 
1813 class G1CMRemarkTask : public AbstractGangTask {
1814   G1ConcurrentMark* _cm;
1815 public:
1816   void work(uint worker_id) {
1817     G1CMTask* task = _cm-&gt;task(worker_id);
1818     task-&gt;record_start_time();
1819     {
1820       ResourceMark rm;
1821       HandleMark hm;
1822 
1823       G1RemarkThreadsClosure threads_f(G1CollectedHeap::heap(), task);
1824       Threads::threads_do(&amp;threads_f);
1825     }
1826 
1827     do {
1828       task-&gt;do_marking_step(1000000000.0 /* something very large */,
1829                             true         /* do_termination       */,
1830                             false        /* is_serial            */);
1831     } while (task-&gt;has_aborted() &amp;&amp; !_cm-&gt;has_overflown());
1832     // If we overflow, then we do not want to restart. We instead
1833     // want to abort remark and do concurrent marking again.
1834     task-&gt;record_end_time();
1835   }
1836 
1837   G1CMRemarkTask(G1ConcurrentMark* cm, uint active_workers) :
1838     AbstractGangTask(&quot;Par Remark&quot;), _cm(cm) {
1839     _cm-&gt;terminator()-&gt;reset_for_reuse(active_workers);
1840   }
1841 };
1842 
1843 void G1ConcurrentMark::finalize_marking() {
1844   ResourceMark rm;
1845   HandleMark   hm;
1846 
1847   _g1h-&gt;ensure_parsability(false);
1848 
1849   // this is remark, so we&#39;ll use up all active threads
1850   uint active_workers = _g1h-&gt;workers()-&gt;active_workers();
1851   set_concurrency_and_phase(active_workers, false /* concurrent */);
1852   // Leave _parallel_marking_threads at it&#39;s
1853   // value originally calculated in the G1ConcurrentMark
1854   // constructor and pass values of the active workers
1855   // through the gang in the task.
1856 
1857   {
1858     StrongRootsScope srs(active_workers);
1859 
1860     G1CMRemarkTask remarkTask(this, active_workers);
1861     // We will start all available threads, even if we decide that the
1862     // active_workers will be fewer. The extra ones will just bail out
1863     // immediately.
1864     _g1h-&gt;workers()-&gt;run_task(&amp;remarkTask);
1865   }
1866 
1867   SATBMarkQueueSet&amp; satb_mq_set = G1BarrierSet::satb_mark_queue_set();
1868   guarantee(has_overflown() ||
1869             satb_mq_set.completed_buffers_num() == 0,
1870             &quot;Invariant: has_overflown = %s, num buffers = &quot; SIZE_FORMAT,
1871             BOOL_TO_STR(has_overflown()),
1872             satb_mq_set.completed_buffers_num());
1873 
1874   print_stats();
1875 }
1876 
1877 void G1ConcurrentMark::flush_all_task_caches() {
1878   size_t hits = 0;
1879   size_t misses = 0;
1880   for (uint i = 0; i &lt; _max_num_tasks; i++) {
1881     Pair&lt;size_t, size_t&gt; stats = _tasks[i]-&gt;flush_mark_stats_cache();
1882     hits += stats.first;
1883     misses += stats.second;
1884   }
1885   size_t sum = hits + misses;
1886   log_debug(gc, stats)(&quot;Mark stats cache hits &quot; SIZE_FORMAT &quot; misses &quot; SIZE_FORMAT &quot; ratio %1.3lf&quot;,
1887                        hits, misses, percent_of(hits, sum));
1888 }
1889 
1890 void G1ConcurrentMark::clear_range_in_prev_bitmap(MemRegion mr) {
1891   _prev_mark_bitmap-&gt;clear_range(mr);
1892 }
1893 
1894 HeapRegion*
1895 G1ConcurrentMark::claim_region(uint worker_id) {
1896   // &quot;checkpoint&quot; the finger
1897   HeapWord* finger = _finger;
1898 
1899   while (finger &lt; _heap.end()) {
1900     assert(_g1h-&gt;is_in_g1_reserved(finger), &quot;invariant&quot;);
1901 
1902     HeapRegion* curr_region = _g1h-&gt;heap_region_containing(finger);
1903     // Make sure that the reads below do not float before loading curr_region.
1904     OrderAccess::loadload();
1905     // Above heap_region_containing may return NULL as we always scan claim
1906     // until the end of the heap. In this case, just jump to the next region.
1907     HeapWord* end = curr_region != NULL ? curr_region-&gt;end() : finger + HeapRegion::GrainWords;
1908 
1909     // Is the gap between reading the finger and doing the CAS too long?
1910     HeapWord* res = Atomic::cmpxchg(&amp;_finger, finger, end);
1911     if (res == finger &amp;&amp; curr_region != NULL) {
1912       // we succeeded
1913       HeapWord*   bottom        = curr_region-&gt;bottom();
1914       HeapWord*   limit         = curr_region-&gt;next_top_at_mark_start();
1915 
1916       // notice that _finger == end cannot be guaranteed here since,
1917       // someone else might have moved the finger even further
1918       assert(_finger &gt;= end, &quot;the finger should have moved forward&quot;);
1919 
1920       if (limit &gt; bottom) {
1921         return curr_region;
1922       } else {
1923         assert(limit == bottom,
1924                &quot;the region limit should be at bottom&quot;);
1925         // we return NULL and the caller should try calling
1926         // claim_region() again.
1927         return NULL;
1928       }
1929     } else {
1930       assert(_finger &gt; finger, &quot;the finger should have moved forward&quot;);
1931       // read it again
1932       finger = _finger;
1933     }
1934   }
1935 
1936   return NULL;
1937 }
1938 
1939 #ifndef PRODUCT
1940 class VerifyNoCSetOops {
1941   G1CollectedHeap* _g1h;
1942   const char* _phase;
1943   int _info;
1944 
1945 public:
1946   VerifyNoCSetOops(const char* phase, int info = -1) :
1947     _g1h(G1CollectedHeap::heap()),
1948     _phase(phase),
1949     _info(info)
1950   { }
1951 
1952   void operator()(G1TaskQueueEntry task_entry) const {
1953     if (task_entry.is_array_slice()) {
1954       guarantee(_g1h-&gt;is_in_reserved(task_entry.slice()), &quot;Slice &quot; PTR_FORMAT &quot; must be in heap.&quot;, p2i(task_entry.slice()));
1955       return;
1956     }
1957     guarantee(oopDesc::is_oop(task_entry.obj()),
1958               &quot;Non-oop &quot; PTR_FORMAT &quot;, phase: %s, info: %d&quot;,
1959               p2i(task_entry.obj()), _phase, _info);
1960     HeapRegion* r = _g1h-&gt;heap_region_containing(task_entry.obj());
1961     guarantee(!(r-&gt;in_collection_set() || r-&gt;has_index_in_opt_cset()),
1962               &quot;obj &quot; PTR_FORMAT &quot; from %s (%d) in region %u in (optional) collection set&quot;,
1963               p2i(task_entry.obj()), _phase, _info, r-&gt;hrm_index());
1964   }
1965 };
1966 
1967 void G1ConcurrentMark::verify_no_collection_set_oops() {
1968   assert(SafepointSynchronize::is_at_safepoint(), &quot;should be at a safepoint&quot;);
1969   if (!_g1h-&gt;collector_state()-&gt;mark_or_rebuild_in_progress()) {
1970     return;
1971   }
1972 
1973   // Verify entries on the global mark stack
1974   _global_mark_stack.iterate(VerifyNoCSetOops(&quot;Stack&quot;));
1975 
1976   // Verify entries on the task queues
1977   for (uint i = 0; i &lt; _max_num_tasks; ++i) {
1978     G1CMTaskQueue* queue = _task_queues-&gt;queue(i);
1979     queue-&gt;iterate(VerifyNoCSetOops(&quot;Queue&quot;, i));
1980   }
1981 
1982   // Verify the global finger
1983   HeapWord* global_finger = finger();
1984   if (global_finger != NULL &amp;&amp; global_finger &lt; _heap.end()) {
1985     // Since we always iterate over all regions, we might get a NULL HeapRegion
1986     // here.
1987     HeapRegion* global_hr = _g1h-&gt;heap_region_containing(global_finger);
1988     guarantee(global_hr == NULL || global_finger == global_hr-&gt;bottom(),
1989               &quot;global finger: &quot; PTR_FORMAT &quot; region: &quot; HR_FORMAT,
1990               p2i(global_finger), HR_FORMAT_PARAMS(global_hr));
1991   }
1992 
1993   // Verify the task fingers
1994   assert(_num_concurrent_workers &lt;= _max_num_tasks, &quot;sanity&quot;);
1995   for (uint i = 0; i &lt; _num_concurrent_workers; ++i) {
1996     G1CMTask* task = _tasks[i];
1997     HeapWord* task_finger = task-&gt;finger();
1998     if (task_finger != NULL &amp;&amp; task_finger &lt; _heap.end()) {
1999       // See above note on the global finger verification.
2000       HeapRegion* r = _g1h-&gt;heap_region_containing(task_finger);
2001       guarantee(r == NULL || task_finger == r-&gt;bottom() ||
2002                 !r-&gt;in_collection_set() || !r-&gt;has_index_in_opt_cset(),
2003                 &quot;task finger: &quot; PTR_FORMAT &quot; region: &quot; HR_FORMAT,
2004                 p2i(task_finger), HR_FORMAT_PARAMS(r));
2005     }
2006   }
2007 }
2008 #endif // PRODUCT
2009 
2010 void G1ConcurrentMark::rebuild_rem_set_concurrently() {
2011   _g1h-&gt;rem_set()-&gt;rebuild_rem_set(this, _concurrent_workers, _worker_id_offset);
2012 }
2013 
2014 void G1ConcurrentMark::print_stats() {
2015   if (!log_is_enabled(Debug, gc, stats)) {
2016     return;
2017   }
2018   log_debug(gc, stats)(&quot;---------------------------------------------------------------------&quot;);
2019   for (size_t i = 0; i &lt; _num_active_tasks; ++i) {
2020     _tasks[i]-&gt;print_stats();
2021     log_debug(gc, stats)(&quot;---------------------------------------------------------------------&quot;);
2022   }
2023 }
2024 
2025 void G1ConcurrentMark::concurrent_cycle_abort() {
2026   if (!cm_thread()-&gt;during_cycle() || _has_aborted) {
2027     // We haven&#39;t started a concurrent cycle or we have already aborted it. No need to do anything.
2028     return;
2029   }
2030 
2031   // Clear all marks in the next bitmap for the next marking cycle. This will allow us to skip the next
2032   // concurrent bitmap clearing.
2033   {
2034     GCTraceTime(Debug, gc) debug(&quot;Clear Next Bitmap&quot;);
2035     clear_bitmap(_next_mark_bitmap, _g1h-&gt;workers(), false);
2036   }
2037   // Note we cannot clear the previous marking bitmap here
2038   // since VerifyDuringGC verifies the objects marked during
2039   // a full GC against the previous bitmap.
2040 
2041   // Empty mark stack
2042   reset_marking_for_restart();
2043   for (uint i = 0; i &lt; _max_num_tasks; ++i) {
2044     _tasks[i]-&gt;clear_region_fields();
2045   }
2046   _first_overflow_barrier_sync.abort();
2047   _second_overflow_barrier_sync.abort();
2048   _has_aborted = true;
2049 
2050   SATBMarkQueueSet&amp; satb_mq_set = G1BarrierSet::satb_mark_queue_set();
2051   satb_mq_set.abandon_partial_marking();
2052   // This can be called either during or outside marking, we&#39;ll read
2053   // the expected_active value from the SATB queue set.
2054   satb_mq_set.set_active_all_threads(
2055                                  false, /* new active value */
2056                                  satb_mq_set.is_active() /* expected_active */);
2057 }
2058 
2059 static void print_ms_time_info(const char* prefix, const char* name,
2060                                NumberSeq&amp; ns) {
2061   log_trace(gc, marking)(&quot;%s%5d %12s: total time = %8.2f s (avg = %8.2f ms).&quot;,
2062                          prefix, ns.num(), name, ns.sum()/1000.0, ns.avg());
2063   if (ns.num() &gt; 0) {
2064     log_trace(gc, marking)(&quot;%s         [std. dev = %8.2f ms, max = %8.2f ms]&quot;,
2065                            prefix, ns.sd(), ns.maximum());
2066   }
2067 }
2068 
2069 void G1ConcurrentMark::print_summary_info() {
2070   Log(gc, marking) log;
2071   if (!log.is_trace()) {
2072     return;
2073   }
2074 
2075   log.trace(&quot; Concurrent marking:&quot;);
2076   print_ms_time_info(&quot;  &quot;, &quot;init marks&quot;, _init_times);
2077   print_ms_time_info(&quot;  &quot;, &quot;remarks&quot;, _remark_times);
2078   {
2079     print_ms_time_info(&quot;     &quot;, &quot;final marks&quot;, _remark_mark_times);
2080     print_ms_time_info(&quot;     &quot;, &quot;weak refs&quot;, _remark_weak_ref_times);
2081 
2082   }
2083   print_ms_time_info(&quot;  &quot;, &quot;cleanups&quot;, _cleanup_times);
2084   log.trace(&quot;    Finalize live data total time = %8.2f s (avg = %8.2f ms).&quot;,
2085             _total_cleanup_time, (_cleanup_times.num() &gt; 0 ? _total_cleanup_time * 1000.0 / (double)_cleanup_times.num() : 0.0));
2086   log.trace(&quot;  Total stop_world time = %8.2f s.&quot;,
2087             (_init_times.sum() + _remark_times.sum() + _cleanup_times.sum())/1000.0);
2088   log.trace(&quot;  Total concurrent time = %8.2f s (%8.2f s marking).&quot;,
2089             cm_thread()-&gt;vtime_accum(), cm_thread()-&gt;vtime_mark_accum());
2090 }
2091 
2092 void G1ConcurrentMark::print_worker_threads_on(outputStream* st) const {
2093   _concurrent_workers-&gt;print_worker_threads_on(st);
2094 }
2095 
2096 void G1ConcurrentMark::threads_do(ThreadClosure* tc) const {
2097   _concurrent_workers-&gt;threads_do(tc);
2098 }
2099 
2100 void G1ConcurrentMark::print_on_error(outputStream* st) const {
2101   st-&gt;print_cr(&quot;Marking Bits (Prev, Next): (CMBitMap*) &quot; PTR_FORMAT &quot;, (CMBitMap*) &quot; PTR_FORMAT,
2102                p2i(_prev_mark_bitmap), p2i(_next_mark_bitmap));
2103   _prev_mark_bitmap-&gt;print_on_error(st, &quot; Prev Bits: &quot;);
2104   _next_mark_bitmap-&gt;print_on_error(st, &quot; Next Bits: &quot;);
2105 }
2106 
2107 static ReferenceProcessor* get_cm_oop_closure_ref_processor(G1CollectedHeap* g1h) {
2108   ReferenceProcessor* result = g1h-&gt;ref_processor_cm();
2109   assert(result != NULL, &quot;CM reference processor should not be NULL&quot;);
2110   return result;
2111 }
2112 
2113 G1CMOopClosure::G1CMOopClosure(G1CollectedHeap* g1h,
2114                                G1CMTask* task)
2115   : MetadataVisitingOopIterateClosure(get_cm_oop_closure_ref_processor(g1h)),
2116     _g1h(g1h), _task(task)
2117 { }
2118 
2119 void G1CMTask::setup_for_region(HeapRegion* hr) {
2120   assert(hr != NULL,
2121         &quot;claim_region() should have filtered out NULL regions&quot;);
2122   _curr_region  = hr;
2123   _finger       = hr-&gt;bottom();
2124   update_region_limit();
2125 }
2126 
2127 void G1CMTask::update_region_limit() {
2128   HeapRegion* hr            = _curr_region;
2129   HeapWord* bottom          = hr-&gt;bottom();
2130   HeapWord* limit           = hr-&gt;next_top_at_mark_start();
2131 
2132   if (limit == bottom) {
2133     // The region was collected underneath our feet.
2134     // We set the finger to bottom to ensure that the bitmap
2135     // iteration that will follow this will not do anything.
2136     // (this is not a condition that holds when we set the region up,
2137     // as the region is not supposed to be empty in the first place)
2138     _finger = bottom;
2139   } else if (limit &gt;= _region_limit) {
2140     assert(limit &gt;= _finger, &quot;peace of mind&quot;);
2141   } else {
2142     assert(limit &lt; _region_limit, &quot;only way to get here&quot;);
2143     // This can happen under some pretty unusual circumstances.  An
2144     // evacuation pause empties the region underneath our feet (NTAMS
2145     // at bottom). We then do some allocation in the region (NTAMS
2146     // stays at bottom), followed by the region being used as a GC
2147     // alloc region (NTAMS will move to top() and the objects
2148     // originally below it will be grayed). All objects now marked in
2149     // the region are explicitly grayed, if below the global finger,
2150     // and we do not need in fact to scan anything else. So, we simply
2151     // set _finger to be limit to ensure that the bitmap iteration
2152     // doesn&#39;t do anything.
2153     _finger = limit;
2154   }
2155 
2156   _region_limit = limit;
2157 }
2158 
2159 void G1CMTask::giveup_current_region() {
2160   assert(_curr_region != NULL, &quot;invariant&quot;);
2161   clear_region_fields();
2162 }
2163 
2164 void G1CMTask::clear_region_fields() {
2165   // Values for these three fields that indicate that we&#39;re not
2166   // holding on to a region.
2167   _curr_region   = NULL;
2168   _finger        = NULL;
2169   _region_limit  = NULL;
2170 }
2171 
2172 void G1CMTask::set_cm_oop_closure(G1CMOopClosure* cm_oop_closure) {
2173   if (cm_oop_closure == NULL) {
2174     assert(_cm_oop_closure != NULL, &quot;invariant&quot;);
2175   } else {
2176     assert(_cm_oop_closure == NULL, &quot;invariant&quot;);
2177   }
2178   _cm_oop_closure = cm_oop_closure;
2179 }
2180 
2181 void G1CMTask::reset(G1CMBitMap* next_mark_bitmap) {
2182   guarantee(next_mark_bitmap != NULL, &quot;invariant&quot;);
2183   _next_mark_bitmap              = next_mark_bitmap;
2184   clear_region_fields();
2185 
2186   _calls                         = 0;
2187   _elapsed_time_ms               = 0.0;
2188   _termination_time_ms           = 0.0;
2189   _termination_start_time_ms     = 0.0;
2190 
2191   _mark_stats_cache.reset();
2192 }
2193 
2194 bool G1CMTask::should_exit_termination() {
2195   if (!regular_clock_call()) {
2196     return true;
2197   }
2198 
2199   // This is called when we are in the termination protocol. We should
2200   // quit if, for some reason, this task wants to abort or the global
2201   // stack is not empty (this means that we can get work from it).
2202   return !_cm-&gt;mark_stack_empty() || has_aborted();
2203 }
2204 
2205 void G1CMTask::reached_limit() {
2206   assert(_words_scanned &gt;= _words_scanned_limit ||
2207          _refs_reached &gt;= _refs_reached_limit ,
2208          &quot;shouldn&#39;t have been called otherwise&quot;);
2209   abort_marking_if_regular_check_fail();
2210 }
2211 
2212 bool G1CMTask::regular_clock_call() {
2213   if (has_aborted()) {
2214     return false;
2215   }
2216 
2217   // First, we need to recalculate the words scanned and refs reached
2218   // limits for the next clock call.
2219   recalculate_limits();
2220 
2221   // During the regular clock call we do the following
2222 
2223   // (1) If an overflow has been flagged, then we abort.
2224   if (_cm-&gt;has_overflown()) {
2225     return false;
2226   }
2227 
2228   // If we are not concurrent (i.e. we&#39;re doing remark) we don&#39;t need
2229   // to check anything else. The other steps are only needed during
2230   // the concurrent marking phase.
2231   if (!_cm-&gt;concurrent()) {
2232     return true;
2233   }
2234 
2235   // (2) If marking has been aborted for Full GC, then we also abort.
2236   if (_cm-&gt;has_aborted()) {
2237     return false;
2238   }
2239 
2240   double curr_time_ms = os::elapsedVTime() * 1000.0;
2241 
2242   // (4) We check whether we should yield. If we have to, then we abort.
2243   if (SuspendibleThreadSet::should_yield()) {
2244     // We should yield. To do this we abort the task. The caller is
2245     // responsible for yielding.
2246     return false;
2247   }
2248 
2249   // (5) We check whether we&#39;ve reached our time quota. If we have,
2250   // then we abort.
2251   double elapsed_time_ms = curr_time_ms - _start_time_ms;
2252   if (elapsed_time_ms &gt; _time_target_ms) {
2253     _has_timed_out = true;
2254     return false;
2255   }
2256 
2257   // (6) Finally, we check whether there are enough completed STAB
2258   // buffers available for processing. If there are, we abort.
2259   SATBMarkQueueSet&amp; satb_mq_set = G1BarrierSet::satb_mark_queue_set();
2260   if (!_draining_satb_buffers &amp;&amp; satb_mq_set.process_completed_buffers()) {
2261     // we do need to process SATB buffers, we&#39;ll abort and restart
2262     // the marking task to do so
2263     return false;
2264   }
2265   return true;
2266 }
2267 
2268 void G1CMTask::recalculate_limits() {
2269   _real_words_scanned_limit = _words_scanned + words_scanned_period;
2270   _words_scanned_limit      = _real_words_scanned_limit;
2271 
2272   _real_refs_reached_limit  = _refs_reached  + refs_reached_period;
2273   _refs_reached_limit       = _real_refs_reached_limit;
2274 }
2275 
2276 void G1CMTask::decrease_limits() {
2277   // This is called when we believe that we&#39;re going to do an infrequent
2278   // operation which will increase the per byte scanned cost (i.e. move
2279   // entries to/from the global stack). It basically tries to decrease the
2280   // scanning limit so that the clock is called earlier.
2281 
2282   _words_scanned_limit = _real_words_scanned_limit - 3 * words_scanned_period / 4;
2283   _refs_reached_limit  = _real_refs_reached_limit - 3 * refs_reached_period / 4;
2284 }
2285 
2286 void G1CMTask::move_entries_to_global_stack() {
2287   // Local array where we&#39;ll store the entries that will be popped
2288   // from the local queue.
2289   G1TaskQueueEntry buffer[G1CMMarkStack::EntriesPerChunk];
2290 
2291   size_t n = 0;
2292   G1TaskQueueEntry task_entry;
2293   while (n &lt; G1CMMarkStack::EntriesPerChunk &amp;&amp; _task_queue-&gt;pop_local(task_entry)) {
2294     buffer[n] = task_entry;
2295     ++n;
2296   }
2297   if (n &lt; G1CMMarkStack::EntriesPerChunk) {
2298     buffer[n] = G1TaskQueueEntry();
2299   }
2300 
2301   if (n &gt; 0) {
2302     if (!_cm-&gt;mark_stack_push(buffer)) {
2303       set_has_aborted();
2304     }
2305   }
2306 
2307   // This operation was quite expensive, so decrease the limits.
2308   decrease_limits();
2309 }
2310 
2311 bool G1CMTask::get_entries_from_global_stack() {
2312   // Local array where we&#39;ll store the entries that will be popped
2313   // from the global stack.
2314   G1TaskQueueEntry buffer[G1CMMarkStack::EntriesPerChunk];
2315 
2316   if (!_cm-&gt;mark_stack_pop(buffer)) {
2317     return false;
2318   }
2319 
2320   // We did actually pop at least one entry.
2321   for (size_t i = 0; i &lt; G1CMMarkStack::EntriesPerChunk; ++i) {
2322     G1TaskQueueEntry task_entry = buffer[i];
2323     if (task_entry.is_null()) {
2324       break;
2325     }
2326     assert(task_entry.is_array_slice() || oopDesc::is_oop(task_entry.obj()), &quot;Element &quot; PTR_FORMAT &quot; must be an array slice or oop&quot;, p2i(task_entry.obj()));
2327     bool success = _task_queue-&gt;push(task_entry);
2328     // We only call this when the local queue is empty or under a
2329     // given target limit. So, we do not expect this push to fail.
2330     assert(success, &quot;invariant&quot;);
2331   }
2332 
2333   // This operation was quite expensive, so decrease the limits
2334   decrease_limits();
2335   return true;
2336 }
2337 
2338 void G1CMTask::drain_local_queue(bool partially) {
2339   if (has_aborted()) {
2340     return;
2341   }
2342 
2343   // Decide what the target size is, depending whether we&#39;re going to
2344   // drain it partially (so that other tasks can steal if they run out
2345   // of things to do) or totally (at the very end).
2346   size_t target_size;
2347   if (partially) {
2348     target_size = MIN2((size_t)_task_queue-&gt;max_elems()/3, (size_t)GCDrainStackTargetSize);
2349   } else {
2350     target_size = 0;
2351   }
2352 
2353   if (_task_queue-&gt;size() &gt; target_size) {
2354     G1TaskQueueEntry entry;
2355     bool ret = _task_queue-&gt;pop_local(entry);
2356     while (ret) {
2357       scan_task_entry(entry);
2358       if (_task_queue-&gt;size() &lt;= target_size || has_aborted()) {
2359         ret = false;
2360       } else {
2361         ret = _task_queue-&gt;pop_local(entry);
2362       }
2363     }
2364   }
2365 }
2366 
2367 void G1CMTask::drain_global_stack(bool partially) {
2368   if (has_aborted()) {
2369     return;
2370   }
2371 
2372   // We have a policy to drain the local queue before we attempt to
2373   // drain the global stack.
2374   assert(partially || _task_queue-&gt;size() == 0, &quot;invariant&quot;);
2375 
2376   // Decide what the target size is, depending whether we&#39;re going to
2377   // drain it partially (so that other tasks can steal if they run out
2378   // of things to do) or totally (at the very end).
2379   // Notice that when draining the global mark stack partially, due to the racyness
2380   // of the mark stack size update we might in fact drop below the target. But,
2381   // this is not a problem.
2382   // In case of total draining, we simply process until the global mark stack is
2383   // totally empty, disregarding the size counter.
2384   if (partially) {
2385     size_t const target_size = _cm-&gt;partial_mark_stack_size_target();
2386     while (!has_aborted() &amp;&amp; _cm-&gt;mark_stack_size() &gt; target_size) {
2387       if (get_entries_from_global_stack()) {
2388         drain_local_queue(partially);
2389       }
2390     }
2391   } else {
2392     while (!has_aborted() &amp;&amp; get_entries_from_global_stack()) {
2393       drain_local_queue(partially);
2394     }
2395   }
2396 }
2397 
2398 // SATB Queue has several assumptions on whether to call the par or
2399 // non-par versions of the methods. this is why some of the code is
2400 // replicated. We should really get rid of the single-threaded version
2401 // of the code to simplify things.
2402 void G1CMTask::drain_satb_buffers() {
2403   if (has_aborted()) {
2404     return;
2405   }
2406 
2407   // We set this so that the regular clock knows that we&#39;re in the
2408   // middle of draining buffers and doesn&#39;t set the abort flag when it
2409   // notices that SATB buffers are available for draining. It&#39;d be
2410   // very counter productive if it did that. :-)
2411   _draining_satb_buffers = true;
2412 
2413   G1CMSATBBufferClosure satb_cl(this, _g1h);
2414   SATBMarkQueueSet&amp; satb_mq_set = G1BarrierSet::satb_mark_queue_set();
2415 
2416   // This keeps claiming and applying the closure to completed buffers
2417   // until we run out of buffers or we need to abort.
2418   while (!has_aborted() &amp;&amp;
2419          satb_mq_set.apply_closure_to_completed_buffer(&amp;satb_cl)) {
2420     abort_marking_if_regular_check_fail();
2421   }
2422 
2423   // Can&#39;t assert qset is empty here, even if not aborted.  If concurrent,
2424   // some other thread might be adding to the queue.  If not concurrent,
2425   // some other thread might have won the race for the last buffer, but
2426   // has not yet decremented the count.
2427 
2428   _draining_satb_buffers = false;
2429 
2430   // again, this was a potentially expensive operation, decrease the
2431   // limits to get the regular clock call early
2432   decrease_limits();
2433 }
2434 
2435 void G1CMTask::clear_mark_stats_cache(uint region_idx) {
2436   _mark_stats_cache.reset(region_idx);
2437 }
2438 
2439 Pair&lt;size_t, size_t&gt; G1CMTask::flush_mark_stats_cache() {
2440   return _mark_stats_cache.evict_all();
2441 }
2442 
2443 void G1CMTask::print_stats() {
2444   log_debug(gc, stats)(&quot;Marking Stats, task = %u, calls = %u&quot;, _worker_id, _calls);
2445   log_debug(gc, stats)(&quot;  Elapsed time = %1.2lfms, Termination time = %1.2lfms&quot;,
2446                        _elapsed_time_ms, _termination_time_ms);
2447   log_debug(gc, stats)(&quot;  Step Times (cum): num = %d, avg = %1.2lfms, sd = %1.2lfms max = %1.2lfms, total = %1.2lfms&quot;,
2448                        _step_times_ms.num(),
2449                        _step_times_ms.avg(),
2450                        _step_times_ms.sd(),
2451                        _step_times_ms.maximum(),
2452                        _step_times_ms.sum());
2453   size_t const hits = _mark_stats_cache.hits();
2454   size_t const misses = _mark_stats_cache.misses();
2455   log_debug(gc, stats)(&quot;  Mark Stats Cache: hits &quot; SIZE_FORMAT &quot; misses &quot; SIZE_FORMAT &quot; ratio %.3f&quot;,
2456                        hits, misses, percent_of(hits, hits + misses));
2457 }
2458 
2459 bool G1ConcurrentMark::try_stealing(uint worker_id, G1TaskQueueEntry&amp; task_entry) {
2460   return _task_queues-&gt;steal(worker_id, task_entry);
2461 }
2462 
2463 /*****************************************************************************
2464 
2465     The do_marking_step(time_target_ms, ...) method is the building
2466     block of the parallel marking framework. It can be called in parallel
2467     with other invocations of do_marking_step() on different tasks
2468     (but only one per task, obviously) and concurrently with the
2469     mutator threads, or during remark, hence it eliminates the need
2470     for two versions of the code. When called during remark, it will
2471     pick up from where the task left off during the concurrent marking
2472     phase. Interestingly, tasks are also claimable during evacuation
2473     pauses too, since do_marking_step() ensures that it aborts before
2474     it needs to yield.
2475 
2476     The data structures that it uses to do marking work are the
2477     following:
2478 
2479       (1) Marking Bitmap. If there are gray objects that appear only
2480       on the bitmap (this happens either when dealing with an overflow
2481       or when the initial marking phase has simply marked the roots
2482       and didn&#39;t push them on the stack), then tasks claim heap
2483       regions whose bitmap they then scan to find gray objects. A
2484       global finger indicates where the end of the last claimed region
2485       is. A local finger indicates how far into the region a task has
2486       scanned. The two fingers are used to determine how to gray an
2487       object (i.e. whether simply marking it is OK, as it will be
2488       visited by a task in the future, or whether it needs to be also
2489       pushed on a stack).
2490 
2491       (2) Local Queue. The local queue of the task which is accessed
2492       reasonably efficiently by the task. Other tasks can steal from
2493       it when they run out of work. Throughout the marking phase, a
2494       task attempts to keep its local queue short but not totally
2495       empty, so that entries are available for stealing by other
2496       tasks. Only when there is no more work, a task will totally
2497       drain its local queue.
2498 
2499       (3) Global Mark Stack. This handles local queue overflow. During
2500       marking only sets of entries are moved between it and the local
2501       queues, as access to it requires a mutex and more fine-grain
2502       interaction with it which might cause contention. If it
2503       overflows, then the marking phase should restart and iterate
2504       over the bitmap to identify gray objects. Throughout the marking
2505       phase, tasks attempt to keep the global mark stack at a small
2506       length but not totally empty, so that entries are available for
2507       popping by other tasks. Only when there is no more work, tasks
2508       will totally drain the global mark stack.
2509 
2510       (4) SATB Buffer Queue. This is where completed SATB buffers are
2511       made available. Buffers are regularly removed from this queue
2512       and scanned for roots, so that the queue doesn&#39;t get too
2513       long. During remark, all completed buffers are processed, as
2514       well as the filled in parts of any uncompleted buffers.
2515 
2516     The do_marking_step() method tries to abort when the time target
2517     has been reached. There are a few other cases when the
2518     do_marking_step() method also aborts:
2519 
2520       (1) When the marking phase has been aborted (after a Full GC).
2521 
2522       (2) When a global overflow (on the global stack) has been
2523       triggered. Before the task aborts, it will actually sync up with
2524       the other tasks to ensure that all the marking data structures
2525       (local queues, stacks, fingers etc.)  are re-initialized so that
2526       when do_marking_step() completes, the marking phase can
2527       immediately restart.
2528 
2529       (3) When enough completed SATB buffers are available. The
2530       do_marking_step() method only tries to drain SATB buffers right
2531       at the beginning. So, if enough buffers are available, the
2532       marking step aborts and the SATB buffers are processed at
2533       the beginning of the next invocation.
2534 
2535       (4) To yield. when we have to yield then we abort and yield
2536       right at the end of do_marking_step(). This saves us from a lot
2537       of hassle as, by yielding we might allow a Full GC. If this
2538       happens then objects will be compacted underneath our feet, the
2539       heap might shrink, etc. We save checking for this by just
2540       aborting and doing the yield right at the end.
2541 
2542     From the above it follows that the do_marking_step() method should
2543     be called in a loop (or, otherwise, regularly) until it completes.
2544 
2545     If a marking step completes without its has_aborted() flag being
2546     true, it means it has completed the current marking phase (and
2547     also all other marking tasks have done so and have all synced up).
2548 
2549     A method called regular_clock_call() is invoked &quot;regularly&quot; (in
2550     sub ms intervals) throughout marking. It is this clock method that
2551     checks all the abort conditions which were mentioned above and
2552     decides when the task should abort. A work-based scheme is used to
2553     trigger this clock method: when the number of object words the
2554     marking phase has scanned or the number of references the marking
2555     phase has visited reach a given limit. Additional invocations to
2556     the method clock have been planted in a few other strategic places
2557     too. The initial reason for the clock method was to avoid calling
2558     vtime too regularly, as it is quite expensive. So, once it was in
2559     place, it was natural to piggy-back all the other conditions on it
2560     too and not constantly check them throughout the code.
2561 
2562     If do_termination is true then do_marking_step will enter its
2563     termination protocol.
2564 
2565     The value of is_serial must be true when do_marking_step is being
2566     called serially (i.e. by the VMThread) and do_marking_step should
2567     skip any synchronization in the termination and overflow code.
2568     Examples include the serial remark code and the serial reference
2569     processing closures.
2570 
2571     The value of is_serial must be false when do_marking_step is
2572     being called by any of the worker threads in a work gang.
2573     Examples include the concurrent marking code (CMMarkingTask),
2574     the MT remark code, and the MT reference processing closures.
2575 
2576  *****************************************************************************/
2577 
2578 void G1CMTask::do_marking_step(double time_target_ms,
2579                                bool do_termination,
2580                                bool is_serial) {
2581   assert(time_target_ms &gt;= 1.0, &quot;minimum granularity is 1ms&quot;);
2582 
2583   _start_time_ms = os::elapsedVTime() * 1000.0;
2584 
2585   // If do_stealing is true then do_marking_step will attempt to
2586   // steal work from the other G1CMTasks. It only makes sense to
2587   // enable stealing when the termination protocol is enabled
2588   // and do_marking_step() is not being called serially.
2589   bool do_stealing = do_termination &amp;&amp; !is_serial;
2590 
2591   G1Predictions const&amp; predictor = _g1h-&gt;policy()-&gt;predictor();
2592   double diff_prediction_ms = predictor.predict_zero_bounded(&amp;_marking_step_diff_ms);
2593   _time_target_ms = time_target_ms - diff_prediction_ms;
2594 
2595   // set up the variables that are used in the work-based scheme to
2596   // call the regular clock method
2597   _words_scanned = 0;
2598   _refs_reached  = 0;
2599   recalculate_limits();
2600 
2601   // clear all flags
2602   clear_has_aborted();
2603   _has_timed_out = false;
2604   _draining_satb_buffers = false;
2605 
2606   ++_calls;
2607 
2608   // Set up the bitmap and oop closures. Anything that uses them is
2609   // eventually called from this method, so it is OK to allocate these
2610   // statically.
2611   G1CMBitMapClosure bitmap_closure(this, _cm);
2612   G1CMOopClosure cm_oop_closure(_g1h, this);
2613   set_cm_oop_closure(&amp;cm_oop_closure);
2614 
2615   if (_cm-&gt;has_overflown()) {
2616     // This can happen if the mark stack overflows during a GC pause
2617     // and this task, after a yield point, restarts. We have to abort
2618     // as we need to get into the overflow protocol which happens
2619     // right at the end of this task.
2620     set_has_aborted();
2621   }
2622 
2623   // First drain any available SATB buffers. After this, we will not
2624   // look at SATB buffers before the next invocation of this method.
2625   // If enough completed SATB buffers are queued up, the regular clock
2626   // will abort this task so that it restarts.
2627   drain_satb_buffers();
2628   // ...then partially drain the local queue and the global stack
2629   drain_local_queue(true);
2630   drain_global_stack(true);
2631 
2632   do {
2633     if (!has_aborted() &amp;&amp; _curr_region != NULL) {
2634       // This means that we&#39;re already holding on to a region.
2635       assert(_finger != NULL, &quot;if region is not NULL, then the finger &quot;
2636              &quot;should not be NULL either&quot;);
2637 
2638       // We might have restarted this task after an evacuation pause
2639       // which might have evacuated the region we&#39;re holding on to
2640       // underneath our feet. Let&#39;s read its limit again to make sure
2641       // that we do not iterate over a region of the heap that
2642       // contains garbage (update_region_limit() will also move
2643       // _finger to the start of the region if it is found empty).
2644       update_region_limit();
2645       // We will start from _finger not from the start of the region,
2646       // as we might be restarting this task after aborting half-way
2647       // through scanning this region. In this case, _finger points to
2648       // the address where we last found a marked object. If this is a
2649       // fresh region, _finger points to start().
2650       MemRegion mr = MemRegion(_finger, _region_limit);
2651 
2652       assert(!_curr_region-&gt;is_humongous() || mr.start() == _curr_region-&gt;bottom(),
2653              &quot;humongous regions should go around loop once only&quot;);
2654 
2655       // Some special cases:
2656       // If the memory region is empty, we can just give up the region.
2657       // If the current region is humongous then we only need to check
2658       // the bitmap for the bit associated with the start of the object,
2659       // scan the object if it&#39;s live, and give up the region.
2660       // Otherwise, let&#39;s iterate over the bitmap of the part of the region
2661       // that is left.
2662       // If the iteration is successful, give up the region.
2663       if (mr.is_empty()) {
2664         giveup_current_region();
2665         abort_marking_if_regular_check_fail();
2666       } else if (_curr_region-&gt;is_humongous() &amp;&amp; mr.start() == _curr_region-&gt;bottom()) {
2667         if (_next_mark_bitmap-&gt;is_marked(mr.start())) {
2668           // The object is marked - apply the closure
2669           bitmap_closure.do_addr(mr.start());
2670         }
2671         // Even if this task aborted while scanning the humongous object
2672         // we can (and should) give up the current region.
2673         giveup_current_region();
2674         abort_marking_if_regular_check_fail();
2675       } else if (_next_mark_bitmap-&gt;iterate(&amp;bitmap_closure, mr)) {
2676         giveup_current_region();
2677         abort_marking_if_regular_check_fail();
2678       } else {
2679         assert(has_aborted(), &quot;currently the only way to do so&quot;);
2680         // The only way to abort the bitmap iteration is to return
2681         // false from the do_bit() method. However, inside the
2682         // do_bit() method we move the _finger to point to the
2683         // object currently being looked at. So, if we bail out, we
2684         // have definitely set _finger to something non-null.
2685         assert(_finger != NULL, &quot;invariant&quot;);
2686 
2687         // Region iteration was actually aborted. So now _finger
2688         // points to the address of the object we last scanned. If we
2689         // leave it there, when we restart this task, we will rescan
2690         // the object. It is easy to avoid this. We move the finger by
2691         // enough to point to the next possible object header.
2692         assert(_finger &lt; _region_limit, &quot;invariant&quot;);
2693         HeapWord* const new_finger = _finger + ((oop)_finger)-&gt;size();
2694         // Check if bitmap iteration was aborted while scanning the last object
2695         if (new_finger &gt;= _region_limit) {
2696           giveup_current_region();
2697         } else {
2698           move_finger_to(new_finger);
2699         }
2700       }
2701     }
2702     // At this point we have either completed iterating over the
2703     // region we were holding on to, or we have aborted.
2704 
2705     // We then partially drain the local queue and the global stack.
2706     // (Do we really need this?)
2707     drain_local_queue(true);
2708     drain_global_stack(true);
2709 
2710     // Read the note on the claim_region() method on why it might
2711     // return NULL with potentially more regions available for
2712     // claiming and why we have to check out_of_regions() to determine
2713     // whether we&#39;re done or not.
2714     while (!has_aborted() &amp;&amp; _curr_region == NULL &amp;&amp; !_cm-&gt;out_of_regions()) {
2715       // We are going to try to claim a new region. We should have
2716       // given up on the previous one.
2717       // Separated the asserts so that we know which one fires.
2718       assert(_curr_region  == NULL, &quot;invariant&quot;);
2719       assert(_finger       == NULL, &quot;invariant&quot;);
2720       assert(_region_limit == NULL, &quot;invariant&quot;);
2721       HeapRegion* claimed_region = _cm-&gt;claim_region(_worker_id);
2722       if (claimed_region != NULL) {
2723         // Yes, we managed to claim one
2724         setup_for_region(claimed_region);
2725         assert(_curr_region == claimed_region, &quot;invariant&quot;);
2726       }
2727       // It is important to call the regular clock here. It might take
2728       // a while to claim a region if, for example, we hit a large
2729       // block of empty regions. So we need to call the regular clock
2730       // method once round the loop to make sure it&#39;s called
2731       // frequently enough.
2732       abort_marking_if_regular_check_fail();
2733     }
2734 
2735     if (!has_aborted() &amp;&amp; _curr_region == NULL) {
2736       assert(_cm-&gt;out_of_regions(),
2737              &quot;at this point we should be out of regions&quot;);
2738     }
2739   } while ( _curr_region != NULL &amp;&amp; !has_aborted());
2740 
2741   if (!has_aborted()) {
2742     // We cannot check whether the global stack is empty, since other
2743     // tasks might be pushing objects to it concurrently.
2744     assert(_cm-&gt;out_of_regions(),
2745            &quot;at this point we should be out of regions&quot;);
2746     // Try to reduce the number of available SATB buffers so that
2747     // remark has less work to do.
2748     drain_satb_buffers();
2749   }
2750 
2751   // Since we&#39;ve done everything else, we can now totally drain the
2752   // local queue and global stack.
2753   drain_local_queue(false);
2754   drain_global_stack(false);
2755 
2756   // Attempt at work stealing from other task&#39;s queues.
2757   if (do_stealing &amp;&amp; !has_aborted()) {
2758     // We have not aborted. This means that we have finished all that
2759     // we could. Let&#39;s try to do some stealing...
2760 
2761     // We cannot check whether the global stack is empty, since other
2762     // tasks might be pushing objects to it concurrently.
2763     assert(_cm-&gt;out_of_regions() &amp;&amp; _task_queue-&gt;size() == 0,
2764            &quot;only way to reach here&quot;);
2765     while (!has_aborted()) {
2766       G1TaskQueueEntry entry;
2767       if (_cm-&gt;try_stealing(_worker_id, entry)) {
2768         scan_task_entry(entry);
2769 
2770         // And since we&#39;re towards the end, let&#39;s totally drain the
2771         // local queue and global stack.
2772         drain_local_queue(false);
2773         drain_global_stack(false);
2774       } else {
2775         break;
2776       }
2777     }
2778   }
2779 
2780   // We still haven&#39;t aborted. Now, let&#39;s try to get into the
2781   // termination protocol.
2782   if (do_termination &amp;&amp; !has_aborted()) {
2783     // We cannot check whether the global stack is empty, since other
2784     // tasks might be concurrently pushing objects on it.
2785     // Separated the asserts so that we know which one fires.
2786     assert(_cm-&gt;out_of_regions(), &quot;only way to reach here&quot;);
2787     assert(_task_queue-&gt;size() == 0, &quot;only way to reach here&quot;);
2788     _termination_start_time_ms = os::elapsedVTime() * 1000.0;
2789 
2790     // The G1CMTask class also extends the TerminatorTerminator class,
2791     // hence its should_exit_termination() method will also decide
2792     // whether to exit the termination protocol or not.
2793     bool finished = (is_serial ||
2794                      _cm-&gt;terminator()-&gt;offer_termination(this));
2795     double termination_end_time_ms = os::elapsedVTime() * 1000.0;
2796     _termination_time_ms +=
2797       termination_end_time_ms - _termination_start_time_ms;
2798 
2799     if (finished) {
2800       // We&#39;re all done.
2801 
2802       // We can now guarantee that the global stack is empty, since
2803       // all other tasks have finished. We separated the guarantees so
2804       // that, if a condition is false, we can immediately find out
2805       // which one.
2806       guarantee(_cm-&gt;out_of_regions(), &quot;only way to reach here&quot;);
2807       guarantee(_cm-&gt;mark_stack_empty(), &quot;only way to reach here&quot;);
2808       guarantee(_task_queue-&gt;size() == 0, &quot;only way to reach here&quot;);
2809       guarantee(!_cm-&gt;has_overflown(), &quot;only way to reach here&quot;);
2810       guarantee(!has_aborted(), &quot;should never happen if termination has completed&quot;);
2811     } else {
2812       // Apparently there&#39;s more work to do. Let&#39;s abort this task. It
2813       // will restart it and we can hopefully find more things to do.
2814       set_has_aborted();
2815     }
2816   }
2817 
2818   // Mainly for debugging purposes to make sure that a pointer to the
2819   // closure which was statically allocated in this frame doesn&#39;t
2820   // escape it by accident.
2821   set_cm_oop_closure(NULL);
2822   double end_time_ms = os::elapsedVTime() * 1000.0;
2823   double elapsed_time_ms = end_time_ms - _start_time_ms;
2824   // Update the step history.
2825   _step_times_ms.add(elapsed_time_ms);
2826 
2827   if (has_aborted()) {
2828     // The task was aborted for some reason.
2829     if (_has_timed_out) {
2830       double diff_ms = elapsed_time_ms - _time_target_ms;
2831       // Keep statistics of how well we did with respect to hitting
2832       // our target only if we actually timed out (if we aborted for
2833       // other reasons, then the results might get skewed).
2834       _marking_step_diff_ms.add(diff_ms);
2835     }
2836 
2837     if (_cm-&gt;has_overflown()) {
2838       // This is the interesting one. We aborted because a global
2839       // overflow was raised. This means we have to restart the
2840       // marking phase and start iterating over regions. However, in
2841       // order to do this we have to make sure that all tasks stop
2842       // what they are doing and re-initialize in a safe manner. We
2843       // will achieve this with the use of two barrier sync points.
2844 
2845       if (!is_serial) {
2846         // We only need to enter the sync barrier if being called
2847         // from a parallel context
2848         _cm-&gt;enter_first_sync_barrier(_worker_id);
2849 
2850         // When we exit this sync barrier we know that all tasks have
2851         // stopped doing marking work. So, it&#39;s now safe to
2852         // re-initialize our data structures.
2853       }
2854 
2855       clear_region_fields();
2856       flush_mark_stats_cache();
2857 
2858       if (!is_serial) {
2859         // If we&#39;re executing the concurrent phase of marking, reset the marking
2860         // state; otherwise the marking state is reset after reference processing,
2861         // during the remark pause.
2862         // If we reset here as a result of an overflow during the remark we will
2863         // see assertion failures from any subsequent set_concurrency_and_phase()
2864         // calls.
2865         if (_cm-&gt;concurrent() &amp;&amp; _worker_id == 0) {
2866           // Worker 0 is responsible for clearing the global data structures because
2867           // of an overflow. During STW we should not clear the overflow flag (in
2868           // G1ConcurrentMark::reset_marking_state()) since we rely on it being true when we exit
2869           // method to abort the pause and restart concurrent marking.
2870           _cm-&gt;reset_marking_for_restart();
2871 
2872           log_info(gc, marking)(&quot;Concurrent Mark reset for overflow&quot;);
2873         }
2874 
2875         // ...and enter the second barrier.
2876         _cm-&gt;enter_second_sync_barrier(_worker_id);
2877       }
2878       // At this point, if we&#39;re during the concurrent phase of
2879       // marking, everything has been re-initialized and we&#39;re
2880       // ready to restart.
2881     }
2882   }
2883 }
2884 
2885 G1CMTask::G1CMTask(uint worker_id,
2886                    G1ConcurrentMark* cm,
2887                    G1CMTaskQueue* task_queue,
2888                    G1RegionMarkStats* mark_stats,
2889                    uint max_regions) :
2890   _objArray_processor(this),
2891   _worker_id(worker_id),
2892   _g1h(G1CollectedHeap::heap()),
2893   _cm(cm),
2894   _next_mark_bitmap(NULL),
2895   _task_queue(task_queue),
2896   _mark_stats_cache(mark_stats, max_regions, RegionMarkStatsCacheSize),
2897   _calls(0),
2898   _time_target_ms(0.0),
2899   _start_time_ms(0.0),
2900   _cm_oop_closure(NULL),
2901   _curr_region(NULL),
2902   _finger(NULL),
2903   _region_limit(NULL),
2904   _words_scanned(0),
2905   _words_scanned_limit(0),
2906   _real_words_scanned_limit(0),
2907   _refs_reached(0),
2908   _refs_reached_limit(0),
2909   _real_refs_reached_limit(0),
2910   _has_aborted(false),
2911   _has_timed_out(false),
2912   _draining_satb_buffers(false),
2913   _step_times_ms(),
2914   _elapsed_time_ms(0.0),
2915   _termination_time_ms(0.0),
2916   _termination_start_time_ms(0.0),
2917   _marking_step_diff_ms()
2918 {
2919   guarantee(task_queue != NULL, &quot;invariant&quot;);
2920 
2921   _marking_step_diff_ms.add(0.5);
2922 }
2923 
2924 // These are formatting macros that are used below to ensure
2925 // consistent formatting. The *_H_* versions are used to format the
2926 // header for a particular value and they should be kept consistent
2927 // with the corresponding macro. Also note that most of the macros add
2928 // the necessary white space (as a prefix) which makes them a bit
2929 // easier to compose.
2930 
2931 // All the output lines are prefixed with this string to be able to
2932 // identify them easily in a large log file.
2933 #define G1PPRL_LINE_PREFIX            &quot;###&quot;
2934 
2935 #define G1PPRL_ADDR_BASE_FORMAT    &quot; &quot; PTR_FORMAT &quot;-&quot; PTR_FORMAT
2936 #ifdef _LP64
2937 #define G1PPRL_ADDR_BASE_H_FORMAT  &quot; %37s&quot;
2938 #else // _LP64
2939 #define G1PPRL_ADDR_BASE_H_FORMAT  &quot; %21s&quot;
2940 #endif // _LP64
2941 
2942 // For per-region info
2943 #define G1PPRL_TYPE_FORMAT            &quot;   %-4s&quot;
2944 #define G1PPRL_TYPE_H_FORMAT          &quot;   %4s&quot;
2945 #define G1PPRL_STATE_FORMAT           &quot;   %-5s&quot;
2946 #define G1PPRL_STATE_H_FORMAT         &quot;   %5s&quot;
2947 #define G1PPRL_BYTE_FORMAT            &quot;  &quot; SIZE_FORMAT_W(9)
2948 #define G1PPRL_BYTE_H_FORMAT          &quot;  %9s&quot;
2949 #define G1PPRL_DOUBLE_FORMAT          &quot;  %14.1f&quot;
2950 #define G1PPRL_DOUBLE_H_FORMAT        &quot;  %14s&quot;
2951 
2952 // For summary info
2953 #define G1PPRL_SUM_ADDR_FORMAT(tag)    &quot;  &quot; tag &quot;:&quot; G1PPRL_ADDR_BASE_FORMAT
2954 #define G1PPRL_SUM_BYTE_FORMAT(tag)    &quot;  &quot; tag &quot;: &quot; SIZE_FORMAT
2955 #define G1PPRL_SUM_MB_FORMAT(tag)      &quot;  &quot; tag &quot;: %1.2f MB&quot;
2956 #define G1PPRL_SUM_MB_PERC_FORMAT(tag) G1PPRL_SUM_MB_FORMAT(tag) &quot; / %1.2f %%&quot;
2957 
2958 G1PrintRegionLivenessInfoClosure::G1PrintRegionLivenessInfoClosure(const char* phase_name) :
2959   _total_used_bytes(0), _total_capacity_bytes(0),
2960   _total_prev_live_bytes(0), _total_next_live_bytes(0),
2961   _total_remset_bytes(0), _total_strong_code_roots_bytes(0)
2962 {
2963   if (!log_is_enabled(Trace, gc, liveness)) {
2964     return;
2965   }
2966 
2967   G1CollectedHeap* g1h = G1CollectedHeap::heap();
2968   MemRegion g1_reserved = g1h-&gt;g1_reserved();
2969   double now = os::elapsedTime();
2970 
2971   // Print the header of the output.
2972   log_trace(gc, liveness)(G1PPRL_LINE_PREFIX&quot; PHASE %s @ %1.3f&quot;, phase_name, now);
2973   log_trace(gc, liveness)(G1PPRL_LINE_PREFIX&quot; HEAP&quot;
2974                           G1PPRL_SUM_ADDR_FORMAT(&quot;reserved&quot;)
2975                           G1PPRL_SUM_BYTE_FORMAT(&quot;region-size&quot;),
2976                           p2i(g1_reserved.start()), p2i(g1_reserved.end()),
2977                           HeapRegion::GrainBytes);
2978   log_trace(gc, liveness)(G1PPRL_LINE_PREFIX);
2979   log_trace(gc, liveness)(G1PPRL_LINE_PREFIX
2980                           G1PPRL_TYPE_H_FORMAT
2981                           G1PPRL_ADDR_BASE_H_FORMAT
2982                           G1PPRL_BYTE_H_FORMAT
2983                           G1PPRL_BYTE_H_FORMAT
2984                           G1PPRL_BYTE_H_FORMAT
2985                           G1PPRL_DOUBLE_H_FORMAT
2986                           G1PPRL_BYTE_H_FORMAT
2987                           G1PPRL_STATE_H_FORMAT
2988                           G1PPRL_BYTE_H_FORMAT,
2989                           &quot;type&quot;, &quot;address-range&quot;,
2990                           &quot;used&quot;, &quot;prev-live&quot;, &quot;next-live&quot;, &quot;gc-eff&quot;,
2991                           &quot;remset&quot;, &quot;state&quot;, &quot;code-roots&quot;);
2992   log_trace(gc, liveness)(G1PPRL_LINE_PREFIX
2993                           G1PPRL_TYPE_H_FORMAT
2994                           G1PPRL_ADDR_BASE_H_FORMAT
2995                           G1PPRL_BYTE_H_FORMAT
2996                           G1PPRL_BYTE_H_FORMAT
2997                           G1PPRL_BYTE_H_FORMAT
2998                           G1PPRL_DOUBLE_H_FORMAT
2999                           G1PPRL_BYTE_H_FORMAT
3000                           G1PPRL_STATE_H_FORMAT
3001                           G1PPRL_BYTE_H_FORMAT,
3002                           &quot;&quot;, &quot;&quot;,
3003                           &quot;(bytes)&quot;, &quot;(bytes)&quot;, &quot;(bytes)&quot;, &quot;(bytes/ms)&quot;,
3004                           &quot;(bytes)&quot;, &quot;&quot;, &quot;(bytes)&quot;);
3005 }
3006 
3007 bool G1PrintRegionLivenessInfoClosure::do_heap_region(HeapRegion* r) {
3008   if (!log_is_enabled(Trace, gc, liveness)) {
3009     return false;
3010   }
3011 
3012   const char* type       = r-&gt;get_type_str();
3013   HeapWord* bottom       = r-&gt;bottom();
3014   HeapWord* end          = r-&gt;end();
3015   size_t capacity_bytes  = r-&gt;capacity();
3016   size_t used_bytes      = r-&gt;used();
3017   size_t prev_live_bytes = r-&gt;live_bytes();
3018   size_t next_live_bytes = r-&gt;next_live_bytes();
3019   double gc_eff          = r-&gt;gc_efficiency();
3020   size_t remset_bytes    = r-&gt;rem_set()-&gt;mem_size();
3021   size_t strong_code_roots_bytes = r-&gt;rem_set()-&gt;strong_code_roots_mem_size();
3022   const char* remset_type = r-&gt;rem_set()-&gt;get_short_state_str();
3023 
3024   _total_used_bytes      += used_bytes;
3025   _total_capacity_bytes  += capacity_bytes;
3026   _total_prev_live_bytes += prev_live_bytes;
3027   _total_next_live_bytes += next_live_bytes;
3028   _total_remset_bytes    += remset_bytes;
3029   _total_strong_code_roots_bytes += strong_code_roots_bytes;
3030 
3031   // Print a line for this particular region.
3032   log_trace(gc, liveness)(G1PPRL_LINE_PREFIX
3033                           G1PPRL_TYPE_FORMAT
3034                           G1PPRL_ADDR_BASE_FORMAT
3035                           G1PPRL_BYTE_FORMAT
3036                           G1PPRL_BYTE_FORMAT
3037                           G1PPRL_BYTE_FORMAT
3038                           G1PPRL_DOUBLE_FORMAT
3039                           G1PPRL_BYTE_FORMAT
3040                           G1PPRL_STATE_FORMAT
3041                           G1PPRL_BYTE_FORMAT,
3042                           type, p2i(bottom), p2i(end),
3043                           used_bytes, prev_live_bytes, next_live_bytes, gc_eff,
3044                           remset_bytes, remset_type, strong_code_roots_bytes);
3045 
3046   return false;
3047 }
3048 
3049 G1PrintRegionLivenessInfoClosure::~G1PrintRegionLivenessInfoClosure() {
3050   if (!log_is_enabled(Trace, gc, liveness)) {
3051     return;
3052   }
3053 
3054   // add static memory usages to remembered set sizes
3055   _total_remset_bytes += HeapRegionRemSet::fl_mem_size() + HeapRegionRemSet::static_mem_size();
3056   // Print the footer of the output.
3057   log_trace(gc, liveness)(G1PPRL_LINE_PREFIX);
3058   log_trace(gc, liveness)(G1PPRL_LINE_PREFIX
3059                          &quot; SUMMARY&quot;
3060                          G1PPRL_SUM_MB_FORMAT(&quot;capacity&quot;)
3061                          G1PPRL_SUM_MB_PERC_FORMAT(&quot;used&quot;)
3062                          G1PPRL_SUM_MB_PERC_FORMAT(&quot;prev-live&quot;)
3063                          G1PPRL_SUM_MB_PERC_FORMAT(&quot;next-live&quot;)
3064                          G1PPRL_SUM_MB_FORMAT(&quot;remset&quot;)
3065                          G1PPRL_SUM_MB_FORMAT(&quot;code-roots&quot;),
3066                          bytes_to_mb(_total_capacity_bytes),
3067                          bytes_to_mb(_total_used_bytes),
3068                          percent_of(_total_used_bytes, _total_capacity_bytes),
3069                          bytes_to_mb(_total_prev_live_bytes),
3070                          percent_of(_total_prev_live_bytes, _total_capacity_bytes),
3071                          bytes_to_mb(_total_next_live_bytes),
3072                          percent_of(_total_next_live_bytes, _total_capacity_bytes),
3073                          bytes_to_mb(_total_remset_bytes),
3074                          bytes_to_mb(_total_strong_code_roots_bytes));
3075 }
    </pre>
  </body>
</html>